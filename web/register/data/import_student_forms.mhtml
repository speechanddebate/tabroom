<%args>
	$tourn
	$person
	$dbh
</%args>
<%init>

	use Text::CSV;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	# Get the upload and create the file handle.
	my $req = Apache2::Request->new($r);
	my @csv_handles = $r->upload;
	my $csv_file = $req->upload($csv_handles[0]);
	my $io = $csv_file->io;
	my @entries;

	my $csv = Text::CSV->new({ sep_char => ',' });

	my $has_codes;
	my $err;

	my $students_sth = $dbh->prepare("
		select
			student.id, student.first, student.last, school.name, school.id school_id
		from student, entry_student es, entry, school
		where 1=1
			and school.tourn = ?
			and school.id    = entry.school
			and entry.id     = es.entry
			and es.student   = student.id
		group by student.id
	");

	$students_sth->execute($tourn->id);
	my $students = $students_sth->fetchall_hash();

	my %students_by_name = map {
		$_->{first}." ".$_->{last} => $_
	} @{$students};

	my $settings_sth = $dbh->prepare("
		select
			school.id school_id, ss.value_text, ss.id existing
		from school, school_setting ss
		where 1=1
			and school.tourn = ?
			and school.id    = ss.school
			and ss.tag       = 'student_form_confirm'
	");

	$settings_sth->execute($tourn->id);
	my $settings = $settings_sth->fetchall_hash();

	my %settings_by_id = map {
		$_->{school_id} => $_
	} @{$settings};

	foreach my $sid (keys %settings_by_id) {
		$settings_by_id{$sid}{value} = JSON::decode_json($settings_by_id{$sid}{value_text});
	}

	my @not_founds;
	my $counter;

	ENTRY:
	foreach my $line (<$io>) {

		unless ($csv->parse($line)) {
			next ENTRY;
		}

		# If you think the below seems ugly you should have seen what it looked
		# like before...

		my (
			$id,
			$stime,
			$etime,
			$email,
			$name,
			$student_first,
			$student_last,
			$school_name,
			@junque
		) = $csv->fields();

		$student_first =~ s/\s+$//;  # Trailing
		$student_first =~ s/^\s+//;  # Leading only

		$student_last =~ s/\s+$//;  # Trailing
		$student_last =~ s/^\s+//;  # Leading only

		my $student = $students_by_name{$student_first." ".$student_last};

		if ($student) {
			$counter++;
			$settings_by_id{$student->{school_id}}{value}{$student->{id}} = 1;

		} else {
			push @not_founds, {
				id     => $id,
				first  => $student_first,
				last   => $student_last,
				school => $school_name
			};
		}
	}

	my $update_sth = $dbh->prepare("update school_setting set value_text = ? where id = ?");

	my $insert_sth = $dbh->prepare("insert into school_setting
		(school, tag, value, value_text)
		values (?, 'student_form_confirm', 'json', ?)
	");

	foreach my $school_id (keys %settings_by_id) {

		my $set = $settings_by_id{$school_id};

		Tab::debuglog("set is ".JSON::encode_json($set));

		if ($set->{existing}) {
			Tab::debuglog("Existing setting ".$set->{existing}." updating to ".$set->{value});
			$update_sth->execute($set->{existing}, JSON::encode_json($set->{value}));
		} else {
			Tab::debuglog("new setting for ".$school_id." being created for ".JSON::encode_json($set->{value}));
			$insert_sth->execute($school_id, JSON::encode_json($set->{value}));
		}
	}

</%init>

	<div class="main">

		<h4>Import Results</h4>

		<p><% $counter %> student records were matched successfully</p>

		<div class="flexrow full">
			<span class='twothirds bigger semibold padleft'>
				No matches found for:
			</span>

			<span class='third rightalign' id="nomatch_buttonarea">

			</span>
		</div>

		<& "/funclib/tablesorter.mas", table => "nomatch" &>

		<table id="nomatch">
			<thead>
				<tr>
					<th>
						ID
					</th>
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $no (@not_founds) {
					<tr>
						<td>
							<% $no->{id} %>
						</td>

						<td>
							<% $no->{first} %>
						</td>

						<td>
							<% $no->{last} %>
						</td>

						<td>
							<% $no->{school} %>
						</td>
					</tr>
%				}
			</tbody>
		</table>
	</div>
