<%args>
	$dbh
	$tourn
	$tourn_settings
	$person
	$person_settings
</%args>
<%init>

	my $tourn_schools_sth = $dbh->prepare("
		select
			chapter.id
		from school, chapter
		where school.tourn = ?
			and school.chapter = chapter.id
	");

	$tourn_schools_sth->execute($tourn->id);

	my $chapters;

	if ($tourn_settings->{"nsda_district"}) {

		my $circuit_chapters_sth = $dbh->prepare("
			select
				chapter.id, chapter.name, chapter.state, chapter.nsda
			from chapter, chapter_circuit cc, tourn_circuit tc

			where 1=1
				and tc.tourn = ?
				and tc.approved = 1
				and tc.circuit = cc.circuit
				and cc.chapter = chapter.id
				and chapter.district = ?
			order by chapter.name, chapter.state
		");

		$circuit_chapters_sth->execute($tourn->id, $tourn_settings->{nsda_district});

		$chapters = $circuit_chapters_sth->fetchall_hash();

	} else {

		my $circuit_chapters_sth = $dbh->prepare("
			select
				chapter.id, chapter.name, chapter.state, chapter.nsda
			from chapter, chapter_circuit cc, tourn_circuit tc

			where 1=1
				and tc.tourn = ?
				and tc.approved = 1
				and tc.circuit = cc.circuit
				and cc.chapter = chapter.id
			order by chapter.name, chapter.state
		");

		$circuit_chapters_sth->execute($tourn->id);
		$chapters = $circuit_chapters_sth->fetchall_hash();

	}

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => "add_school"
	&>

	<div class="main">

		<h2>Add school to tournament</h2>

%		if ($tourn_settings->{"nsda_nats"}) {

			<form
				action="add_school_save.mhtml"
				method="post"
			>

			<div class="row">
				<span class="third semibold padleft">
					Add district team:
				</span>

				<span class="half">
					<select name  = "district_id" >
						<& "/funclib/district_select.mas" &>
					</select>
				</span>

				<span class="sixth centeralign">
					<input
						type  = "submit"
						value = "Add"
					>
				</span>
			</div>
			</form>

%		}

		<form
			action="add_school_save.mhtml"
			method="post"
		>

		<div class="row flexrow">

			<span class="third semibold padleft">
%				if ($tourn_settings->{"nsda_district"}) {
					Add school from district
%				} else {
					Add School from Circuit
%				}
			</span>

			<span class="half">
				<select
					name             = "chapter_id"
					data-placeholder = "Select an existing institution"
				>
					<option value = "">
					</option>
%					foreach my $chapter (@{$chapters}) {
%						next unless $chapter->{name};
						<option
							value = "<% $chapter->{id} %>"
						>
							<% $chapter->{id} %>
							<% $chapter->{name} %>
							<% $chapter->{state} %>
%							if ($chapter->{nsda}) {
								(NSDA #<% $chapter->{nsda} %>)
%							}
						</option>
%	 				}
				</select>
			</span>

			<span class="sixth centeralign padright">
				<input
					type  = "submit"
					value = "Add"
				>
			</span>
		</div>
		</form>

		<h4 class="martop">Or, add a brand new school</h4>

		<form
			action = "add_school_create.mhtml"
			method = "post"
		>

		<div class="row flexrow">
			<span class="third semibold padleft">
				School/Institution Name
			</span>

			<span class="half">
				<input
					type = "text"
					name = "name"
				>
			</span>

			<span>
			</span>
		</div>

		<div class="row flexrow">
			<span class="third semibold padleft">
				Coach Email
			</span>

			<span class="half">
				<input
					type = "text"
					name = "email"
				>
			</span>

			<span>
			</span>
		</div>

%		if ($tourn_settings->{"nsda_nats"}) {
			<div class="row flexrow">
				<span class="third semibold padleft">
					District
				</span>

				<span class="half">
					<select name  = "district_id" >
						<& "/funclib/district_select.mas" &>
					</select>
				</span>

				<span>
				</span>
			</div>
%		}

		<div class="row flexrow">
			<span class="third semibold padleft">
				State
			</span>

			<span class="half">
				<select name  = "state" >
					<& "/funclib/state_select.mas", state => $tourn->state &>
				</select>
			</span>

			<span>
			</span>
		</div>

		<div class="row flexrow">
			<span class="third semibold padleft">
				Country
			</span>

			<span class="half">
				<select name  = "country" >
					<& "/funclib/country_select.mas", country => $tourn->country &>
				</select>
			</span>

			<span>
			</span>
		</div>

		<div class="liblrow rightalign padrightmore">
			<span class="sixth centeralign marvertno padvertno">
				<input
					type  = "submit"
					value = "Add"
				>
			</span>
		</div>

		</form>

%		if ($person_settings->{"nsda_admin"} || $person->site_admin) {

			<h5>Super duper secret method</h5>

			<form
				action = "add_school_id.mhtml"
				method = "post"
			>

				<div class="row flexrow">
					<span class="third semibold redtext padleft">
						Add any school by Tabroom Chapter ID
					</span>

					<span class="half">
						<span class="third">
						<input
							type = "number"
							class = "sizeme"
							name = "chapter_id"
						>
						</span>
					</span>

					<span class="sixth centeralign">
						<input
							type  = "submit"
							value = "Add"
						>
					</span>
				</div>
			</form>

			<form
				action = "add_school_id.mhtml"
				method = "post"
			>


				<div class="row flexrow">
					<span class="third semibold redtext padleft">
						Add any school by NSDA School ID
					</span>

					<span class="half">
						<span class="third">
						<input
							type = "number"
							class = "sizeme"
							name = "nsda_school_id"
						>
						</span>
					</span>

					<span class="sixth centeralign">
						<input
							type  = "submit"
							value = "Add"
						>
					</span>
				</div>
			</form>
%		}

	</div>

