<%args>
	$person
	$tourn
	$tourn_settings
	$perms
	$dbh
</%args>
<%init>

	my %events = $m->comp("/funclib/perms/events.mas",
		tourn   => $tourn,
		perms   => $perms,
		limited => 'yep'
	);

	my $sth = $dbh->prepare("
		select
			event.id, event.name, event.abbr, event.type,
			event.code_style,
			max(entry.code) as max_code,
			min(entry.code) as min_code,
			code_start.value code_start

		from (event)

			left join entry on event.id = entry.event
				and entry.active = 1

			left join event_setting code_start
				on code_start.event = event.id
				and code_start.tag = 'code_start'

			left join event_setting supp
				on supp.event = event.id
				and supp.tag = 'supp'

		where event.tourn = ?
		group by event.id
		order by code_start.value, supp.value, event.type, event.abbr
	");

	$sth->execute($tourn->id);
	my $events = $sth->fetchall_hash();

</%init>

	<script>
		$(document).ready( () => {
			fixVisual();
		});

	</script>

	<& "menu.mas",
		person         => $person,
		whoami         => "entry_recode",
		tourn          => $tourn,
		tourn_settings => $tourn_settings
	&>

	<& "/funclib/tablesorter.mas",
		table     => "codes",
		nobuttons => 'yas'
	&>

	<div class="main">

		<h4>Recode Entries</h4>

		<table id="codes">

			<thead>
				<tr class="yellowrow">
					<th>
						Event
					</th>

					<th>
						Lowest
					</th>

					<th>
						Highest
					</th>

					<th>
						Code Style
					</th>

					<th>
						Starting Code
					</th>

					<th>
						Sort by
					</th>

					<th>
					</th>
				</tr>
			</thead>

			<tbody>

%			foreach my $event (@{$events}) {

%				next unless $events{$event->{id}};

				<tr class="row">

					<td class="leftalign smallish">

						<form
							action="entry_recode_save.mhtml"
							method="post"
						>

						<input
							type  = "hidden"
							name  = "event_id"
							value = "<% $event->{id} %>"
						>

						<a
							class="white"
							href="/register/event/roster.mhtml?event_id=<% $event->{id} %>"
						>
							<% $event->{abbr} %>
						</a>
					</td>

					<td class="leftalign smallish">
						<% $event->{min_code} %>
					</td>

					<td class="leftalign smallish">
						<% $event->{max_code} %>
					</td>

					<td class="centeralign smallish">
						<select
							event_id     = "<% $event->{id} %>"
							property_name = "code_style"
							name          = "code_style"
							onChange      = "postSwitch(this, '/setup/events/setting_switch.mhtml');"
						>
							<option
								value="numbers"
								<% ($event->{code_style} eq "numbers") ? "selected" : "" %>
							>
								Number
							</option>

							<option
								value="school_number"
								<% ($event->{code_style} eq "school_number") ? "selected" : "" %>
							>
								School code &amp; number
							</option>

							<option
								value="schoolname_code"
								<% ($event->{code_style} eq "schoolname_code") ? "selected" : "" %>
							>
								School name &amp; number
							</option>

							<option
								value="initials"
								<% ($event->{code_style} eq "initials") ? "selected" : "" %>
							>
								School code &amp; initials
							</option>

							<option
								value="code_name"
								<% ($event->{code_style} eq "code_name") ? "selected" : "" %>
							>
								School code &amp; names
							</option>

							<option
								value="full_initials"
								<% ($event->{code_style} eq "full_initials") ? "selected" : "" %>
							>
								School name &amp; initials
							</option>

							<option
								value="school_names"
								<% ($event->{code_style} eq "school_names") ? "selected" : "" %>
							>
								School name &amp; Full names
							</option>

							<option
								value="school_last_names"
								<% ($event->{code_style} eq "school_last_names") ? "selected" : "" %>
							>
								School name &amp; Last names
							</option>

							<option
								value="school_first_names"
								<% ($event->{code_style} eq "school_first_names") ? "selected" : "" %>
							>
								School name &amp; First names
							</option>

							<option
								value="school_name_only"
								<% ($event->{code_style} eq "school_name_only") ? "selected" : "" %>
							>
								School name Only
							</option>

							<option
								value="names"
								<% ($event->{code_style} eq "names") ? "selected" : "" %>
							>
								Full Names
							</option>

							<option
								value="names_lastfirst"
								<% ($event->{code_style} eq "names_lastfirst") ? "selected" : "" %>
							>
								Full Names - Last name first
							</option>

							<option
								value="last_names"
								<% ($event->{code_style} eq "last_names") ? "selected" : "" %>
							>
								Last Names Only
							</option>

							<option
								value="register"
								<% ($event->{code_style} eq "register") ? "selected" : "" %>
							>
								Ask registrants to supply code
							</option>

%							if ($person->site_admin) {
								<option
									value="prepend_school"
									<% ($event->{code_style} eq "prepend_school") ? "selected" : "" %>
								>
									Prepend school to existing code
								</option>
%							}
						</select>
					</td>

					<td
						class     = "centeralign smallish"
						data-text = "<% $event->{'code_start'} %>"
					>
<%perl>
						unless ($event->{code_style} eq "full_initials"
							|| $event->{code_style} eq "initials"
							|| $event->{code_style} eq "names"
							|| $event->{code_style} eq "registrant"
							|| $event->{code_style} eq "register"
							|| $event->{code_style} eq "names_lastfirst"
							|| $event->{code_style} eq "last_names"
							|| $event->{code_style} eq "school_names"
							|| $event->{code_style} eq "school_first_names"
							|| $event->{code_style} eq "school_last_names"
							|| $event->{code_style} eq "school_name_only"
							|| $event->{code_style} eq "code_name"
						) {
</%perl>

							<input
								type  = "text"
								name  = "codestart"
								size  = "5"
								value = "<% $event->{'code_start'} %>"
							>
%						}
					</td>

					<td class="leftalign smallish">
<%perl>
						if ($event->{code_style} eq "full_initials"
							|| $event->{code_style} eq "initials"
							|| $event->{code_style} eq "names"
							|| $event->{code_style} eq "registrant"
							|| $event->{code_style} eq "register"
							|| $event->{code_style} eq "names_lastfirst"
							|| $event->{code_style} eq "last_names"
							|| $event->{code_style} eq "school_names"
							|| $event->{code_style} eq "school_first_names"
							|| $event->{code_style} eq "school_last_names"
							|| $event->{code_style} eq "school_name_only"
							|| $event->{code_style} eq "code_name"
						) {
</%perl>
							<% $event->{code_style} eq "full_initials"
								|| $event->{code_style} eq "initials"
								|| $event->{code_style} eq "registrant"
								? "Initials"
								: "Names"
							%>

							<% $event->{code_style} eq "names_lastfirst" ? " (Last name first ) " : "" %>

							<% $event->{code_style} eq "last_names" ? " (Last name only) " : "" %>

							<input
								type  = "hidden"
								name  = "sort_by"
								value = "Initials"
							>

%						} else {

							<select
								name  = "sort_by"
								style = "width: 24px;"
							>
								<option value="School">Alpha By School</option>
								<option value="Randomly">Random</option>
								<option value="RandomSchool" selected>Random By School</option>
								<option value="Registration">Registration</option>

%								if ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) {
									<option value="<% $tourn_settings->{"ncfl"} ? "Diocese" : "Region" %>">
										<% $tourn_settings->{"ncfl"} ? "Diocese" : "Region" %>
									</option>
%								}
							</select>
%						}
					</td>

					<td class="centeralign nospace padleftless padrightless">
%						unless ($event->{code_style} eq "register") {
							<input
								type  = "submit"
								class = "thin"
								value = "Go"
							>
%						}
						</form>
					</td>
				</tr>
%			}
			</tbody>
		</table>
	</div>

