<%args>
	$tourn
	$tourn_settings
	$person
	$session
</%args>
<%init>

	my $ok;
	$ok++ if $person->site_admin;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'import_xml',
		ok             => $ok
	&>

	<div class="main">

		<h4>Import External TabXML</h4>

		<p>
			Use this to upload data from "foreign" sources, such as TRPC, only.
			Do not use this screen to import data from the CAT; instead work
			directly from within the CAT.
		</p>

		<h4>Events</h4>

		<p>
			Please select the event that corresponds to the event/divisions
			within the XML import file.  If a event/division which exists in
			the XML import file is not listed below, a new event/division will
			be created on Tabroom.
		</p>

		<p>
			Warning: all your events you upload at one time must be in the same
			judge category.  Otherwise, The Strange and the Odd&#0153; will occur.
		</p>

		<table>

			<form
				name     = "trpc_xml"
				enctype  = "multipart/form-data"
				action   = "import_xml_save.mhtml"
				method   = "post"
				onsubmit = "return uploadThis()"
			>

%			foreach my $div (1 .. 4) {

				<tr class="row">

					<th>
						Division <% $div %>
					</th>

					<td>
						<select
							name        = "event_id_<% $div %>"
							class       = "fixedmed"
							placeholder = "Choose an event:"
						>

							<option value=""></option>

%							foreach my $event ($tourn->events) {
								<option value="<% $event->id %>">
									<% $event->name %>
								</option>
%							}

							<option value="new">  -Create New Event/Division- </option>
						</select>
					</td>

				</tr>

%			}

			<tr class="row">

				<td>

					Import new entries/judges/schools?

					<br />

					<span class="smaller">

						By default, only rounds and results will be imported,
						not new entries &amp;judges.

					</span>
				</td>

				<td>
					<input type="checkbox" value="1" name="add">
				</td>

			</tr>

			<tr class="liblrow">

				<td class="centeralign">

					<div class="uploader">

						<input
							type     = "file"
							name     = "trpc_xml"/
							style    = "opacity: 0;"
							onchange = "uploaderName()"
							id       = "upload"
						>

						<span
							id    = "filename"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>
				</td>


				<td class="centeralign">
					<input
						type  = "submit"
						value = "Upload Tournament"
					>
				</td>
			</tr>

		</table>

		</form>

		<h4 class="martopmore">Howto: Importing TRPC rounds/data into Tabroom</h3>

		<h4>Generating a Universal Data File from TRPC:</h4>

		<p class="bigger">
			This process works best if you use the most recent XML enabeld
			TRPC.exe executable, which is available for download on Tabroom.com
			under "The CAT" on the front page; there's a link on the right for
			"Tabroom enabled TRPC".
		</p>

		<ol>
			<li>In TRPC, Under Results, go to Main Results Printouts &rarr; Print
			Packet Results.</li>

			<li>Hit the evenrow button on the left, about halfway down, that says
			"Click Here to Create a Universal Data Structure File"</li>

			<li>In the popup window that comes up, just hit "OK" with the value set to 1</li>

			<li>A window should pop up saying Done.  Hit OK and then exit TRPC
			completely. </li>


			<li>Go to the TRPCData folder for the tournament you're in.  Under
			there, amid all the .DAT files, there's a new file called
			TourneyData.xml.  It may just simply be called TourneyData.  That's
			the file you'll be uploading you may want to copy it and paste it
			somewhere easier to find, like your desktop.</li>

			<li>Login to Tabroom.com and go to the tournament administration
			screens for your tournament. (Click on it on the right under
			Tournaments on your home page).</li>

			<li>Go to the Data Manipulation screen underneath the "Entries"
			menu.</li>

			<li>Hit "Import Universal XML" on the right sidebar.</li>

			<li>Choose on the menus which divisions in Tabroom correspond to
			the divisions in TRPC by number.  Make sure the numbers match up;
			otherwise you may import an entire division's worth of rounds and
			entries into the wrong place.</li>

			<li>If the division does not exist in Tabroom, fret not; if you
			create a new one under Settings &rarr; Events (as well as a judge category
			under Judges if necessary) and use it to import, the entries and
			judges will all be imported as well.</li>

			<li>ONLY if you have added or changed codes for entries or judges:
			check the box next to add new.  Otherwise leave it blank to prevent
			pulling a Menick; ie uploading into the wrong division and thus
			ending up with 110 PF teams in your LD division. </li>

			<li>Hit Choose File on the bottom right and point the dialog to the
			TourneyData.xml file you generated before.  Hit "Upload
			Tournament".  The process will take a couple of minutes but once it
			is done, Tabroom will now know all pairings and results that TRPC
			knew about when you generated the TourneyData file.</li>

			<li>You can now see the rounds you have uploaded under the Pairings
			menu item for your division.  Check the pairing online, then you
			can set a start time at the right, or click on Web Publish to
			publish it on your tournament website, or Send Blast to send an
			email or text to anyone who has signed up to follow that division.
			</li>

			<li>Tabroom also now knows any results from previous rounds you
			have entered.  The pulldown menu next to Results allows you to make
			a round's results public, with or without unveiling speaker
			points</li>

			<li>If a debater/team is showing up as blank on the pairing, make
			sure the debater code designation (Random High CQ, etc) is the same
			in Tabroom as it is in TRPC; TRPC generates its own codes and
			sometimes they do not match.  You can search for entries under the
			Entries : Events menu, and change their Tabroom code by clicking on
			the entry and then clicking on the Entry Code and typing in the new
			one</li>

		</ol>

	</div>

