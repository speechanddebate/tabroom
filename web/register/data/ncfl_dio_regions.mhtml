<%args>
	$tourn
	$event_id => undef
</%args>
<%init>

	use JSON;

	my @events;
	my %event_regions;

	foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 
		next if $event->type eq "speech";
		next if $event->type eq "congress";
		push @events, $event;

		if ($event->setting("ncfl_regions")) { 
			$event_regions{$event->id} = JSON::decode_json $event->setting('ncfl_regions');
		}

	}

</%init>

	<script>
		function eventSwitch(event) { 

			$('.events').addClass("hidden");
			$('.selector').removeClass("selected");

			$('.'+event).removeClass("hidden");
			$('#selector_'+event).addClass("selected");
			return true;
		}

	</script>

	<div class="main">

		<h2>Debate Regions</h2> 

%		my $notfirst;

		<ul id="tabnav" class="marbottom">

%			foreach my $event (@events) { 

%				undef $notfirst if $event_id && $event->id == $event_id;
%				$notfirst++ if $event_id && $event->id != $event_id;

				<li id="selector_<% $event->id %>" class="selector <% $notfirst++ ? "" : "selected" %>">
					<a onclick="return eventSwitch(<% $event->id %>)">
						<% $event->name %>
					</a>
				</li>
%			}

%			foreach my $event (@events) { 

				<li id="selector_<% $event->id %>_dios" class="selector <% $notfirst++ ? "" : "selected" %>">
					<a onclick="return eventSwitch('<% $event->id %>_dios')">
						<% $event->abbr %> Dioceses
					</a>
				</li>
%			}
		</ul>

%		undef $notfirst;

%		foreach my $event (@events) { 

%			undef $notfirst if $event_id && $event->id == $event_id;
%			$notfirst++ if $event_id && $event->id != $event_id;

			<div class="full nospace events <% $notfirst++ ? "hidden" : "" %> <% $event->id %>">

				<h4><% $event->abbr %> Regions</h4>

				<form action="ncfl_dio_regions_save.mhtml" method="post">
				<input type="hidden" name="event_id" value="<% $event->id %>">

%					my $switch;

%					foreach my $region (sort keys %{$event_regions{$event->id}}) { 

						<div class="nospace <% ($switch++ % 2) ? "odd" : "even" %>">

							<span class="sixth">
								Key/Code:
							</span>
							<span class="sixth">
								<input type="text" size="5" name="key_<% $region %>" 
									value="<% $region %>">
							</span>

							<span class="third">
								Name:
								<input type="text" size="15" name="name_<% $region %>"
									value="<% $event_regions{$event->id}{$region} %>">
							</span>

							<span class="third">
								Mark for Deletion:
								<input type="checkbox" name="delete_<% $region %>" value="1">

							</span>
						</div>
%					}

					<div class="row full nospace yellowrow">

						<span class="sixth">
							New Key/Code:
						</span>
						<span class="sixth">
							<input type="text" size="5" name="key_new">
						</span>

						<span class="third">
							Name: <input type="text" size="15" name="name_new">
						</span>

						<span class="third">
							<input type="submit" value="Save Changes">
						</span>
					</div>
				</form>

			</div>

%		}

	</div>
