<%args>
	$tourn
	$circuit
	$session
</%args>

<%init>

# The script I've always dreaded -- a format to save and then reload
# tournament data into.  Blech.

#	Create the data file
	my $tourn_id = $tourn->id;
	my $session_id = $session->id;

	`mkdir $Tab::file_root/tmp/tabroom-export-$tourn_id-$session_id`;
	open (DATA,">$Tab::file_root/tmp/tabroom-export-$tourn_id-$session_id/tournament-$tourn_id.tab");


	print DATA $m->comp("stringify_object.mas", obj => $tourn);
	print DATA $m->comp("stringify_object.mas", obj => $tourn->method);

	foreach my $tiebreak ($tourn->method->tiebreaks) { 
		print DATA $m->comp("stringify_object.mas", obj => $tiebreak);
	}

	foreach my $timeslot ($tourn->timeslots) { 
		print DATA $m->comp("stringify_object.mas", obj => $timeslot);

		foreach my $round ($timeslot->rounds) { 
			print DATA $m->comp("stringify_object.mas", obj => $round);
		}

	}

	foreach my $access ($tourn->accounts) { 
		print DATA $m->comp("stringify_object.mas", obj => $access);
	}

	foreach my $site ($m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) { 

		print DATA $m->comp("stringify_object.mas", obj => $site);

		foreach my $room ($site->rooms) {
			print DATA $m->comp("stringify_object.mas", obj => $room);
		}

		foreach my $tourn_site (Tab::TournSite->search(tournament => $tourn->id)) {
			print DATA $m->comp("stringify_object.mas", obj => $tourn_site);
		}
	}

	foreach my $roomblock (Tab::RoomBlock->search(tournament => $tourn->id)) { 
		print DATA $m->comp("stringify_object.mas", obj => $roomblock);
	}
	foreach my $roompool (Tab::RoomPool->search(tournament => $tourn->id)) { 
		print DATA $m->comp("stringify_object.mas", obj => $roompool);
	}

	foreach my $group ($tourn->groups) { 

		print DATA $m->comp("stringify_object.mas", obj => $group);

		foreach my $event ($group->events) { 
			print DATA $m->comp("stringify_object.mas", obj => $event);
		}

		foreach my $ea (Tab::ElimAssign->search( judge_group => $group->id)) { 
			print DATA $m->comp("stringify_object.mas", obj => $ea);
		}

	}
		
	foreach my $panel ($tourn->panels) { 
		print DATA $m->comp("stringify_object.mas", obj => $panel);
	}	

	foreach my $qual ($tourn->quals) { 
		print DATA $m->comp("stringify_object.mas", obj => $qual);
	}	

	foreach my $rating ($tourn->ratings) { 
		print DATA $m->comp("stringify_object.mas", obj => $rating);
	}	

	foreach my $judge ($tourn->judges) { 
		print DATA $m->comp("stringify_object.mas", obj => $judge);
		print DATA $m->comp("stringify_object.mas", obj => $judge->uber) if $judge->uber;
	}

	foreach my $school ($tourn->schools) { 
		print DATA $m->comp("stringify_object.mas", obj => $school);

		foreach my $fine ($school->fines) {
			print DATA $m->comp("stringify_object.mas", obj => $fine);
		}

		print DATA $m->comp("stringify_object.mas", obj => $school->chapter);
		print DATA $m->comp("stringify_object.mas", obj => $school->chapter->region($circuit)) 
				if $school->chapter->region($circuit);
		print DATA $m->comp("stringify_object.mas", obj => $school->chapter->circuit_membership($circuit))
				if $school->chapter->circuit_membership($circuit);

	}	

	
	foreach my $jh (Tab::JudgeHire->search( tournament => $tourn->id)) { 
		print DATA $m->comp("stringify_object.mas", obj => $jh);
	}
	
	foreach my $pool (Tab::Pool->search( tournament => $tourn->id)) { 
		print DATA $m->comp("stringify_object.mas", obj => $pool);

		foreach my $pj ($pool->pool_judges) { 
			print DATA $m->comp("stringify_object.mas", obj => $pj);
		}

		foreach my $pjg ($pool->pool_groups) { 
			print DATA $m->comp("stringify_object.mas", obj => $pjg);
		}	

	}


	foreach my $entry ($tourn->entries) { 
		print DATA $m->comp("stringify_object.mas", obj => $entry);

		print DATA $m->comp("stringify_object.mas", obj => $entry->student) if $entry->student;
		print DATA $m->comp("stringify_object.mas", obj => $entry->partner) if $entry->partner;
	}
	
	
	foreach my $strike ($tourn->strikes) { 
		print DATA $m->comp("stringify_object.mas", obj => $strike);
	}


	foreach my $change ($tourn->changes) { 
		print DATA $m->comp("stringify_object.mas", obj => $change);
	}

	
	foreach my $ballot ($tourn->ballots) { 
		print DATA $m->comp("stringify_object.mas", obj => $ballot);
	}

	close DATA;
	$m->redirect("$Tab::url_prefix/tmp/tabroom-export-$tourn_id-$session_id/tournament-$tourn_id.tab");

</%init>

