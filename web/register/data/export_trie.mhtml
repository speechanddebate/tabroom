<%args>
	$circuit
	$tourn
	$session
	$dome => undef
</%args>
<%init>

	my @events = Tab::Event->search( 
			tournament => $tourn->id, 
			{order_by => "name"});

if ($dome) { 

	my $tourn_id = $tourn->id;
	my $session_id = $session->id;

	`mkdir $Tab::file_root/tmp/trie-import-$tourn_id-$session_id`;
	open (TEAMS, ">$Tab::file_root/tmp/trie-import-$tourn_id-$session_id/ENTRIES.txt");

	foreach my $school (sort {$a->name cmp $b->name} $tourn->schools) { 

		my @comps = $school->comps;

		next unless @comps;

		print TEAMS "*".$school->code." 1 ".$school->name."\r\n";

		my %comps_by_student = ();
		my %partners_by_comp = ();
		my @students;

		COMP:
		foreach my $comp (sort {$a->event->team <=> $b->event->team} @comps) { 

			next COMP if $comp->dropped;
			next COMP if $comp->waitlist;

			next COMP unless $ARGS{"choose_".$comp->event->id};

			my @comp_students = $comp->members;
		
			if (scalar @comp_students > 2) { 

				print TEAMS	$comp->name.",".$comp->event->abbr."\r\n";
				next COMP;

			} else { 

				push (@students, @comp_students);
				push (@{$comps_by_student{$comp_students[0]->id}}, $comp) if @comp_students;
				shift @comp_students;
				push (@{$partners_by_comp{$comp->id}}, @comp_students) if @comp_students;

			}

		}

	    my %seen = ();
	    @students = grep { ! $seen{$_->id} ++ } @students;


		foreach my $student (@students) { 

			print TEAMS $student->first." ".$student->last;

			foreach my $comp (@{$comps_by_student{$student->id}}) { 

				print TEAMS ",".$comp->event->abbr;

				if ($partners_by_comp{$comp->id} && @{$partners_by_comp{$comp->id}}) { 

					print TEAMS " (";
	
					my $notfirst;
					foreach my $partner (@{$partners_by_comp{$comp->id}}) { 
						print TEAMS ", " if $notfirst;
						print TEAMS $comp->partner->first." ".$comp->partner->last;
						$notfirst++;
					}

					print TEAMS ") "
				}

			}

			print TEAMS " \r\n";

		}

		print TEAMS "Judges: ";

		my $first;

		foreach my $judge ($school->judges) { 
			next unless $ARGS{"chgrp_".$judge->judge_group->id};
			print TEAMS "," if $first;
			print TEAMS $judge->first." ".$judge->last;
			$first++;
		}
		print TEAMS " \r\n";

	}

	close TEAMS;

	open (ROOMS, ">$Tab::file_root/tmp/trie-import-$tourn_id-$session_id/ROOMS.txt");

	foreach my $site ($m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) { 

		print ROOMS $site->name;

		foreach my $room ($site->rooms) { 
			print ROOMS ", ".$room->name;
		}
		
		print ROOMS "\r\n";
	}

	close ROOMS;


	$m->redirect("$Tab::url_prefix/tmp/trie-import-$tourn_id-$session_id/");
}


</%init>

	<& sidebar.mas, tourn => $tourn, whoami => "export_trie" &>

	<div class="left huge">

		<h2>Export to Tab Room IE for the PC</h2>

		<form action="export_trie.mhtml" method="post">
		<input type="hidden" name="dome" value="ohyesohyesohyes">

		<h4>Select Events to Export</h4>

		<table cellpadding="3" width="100%">

			<tr class="lirdrow">

				<th>
					Event
				</th>
				
				<th>
					Export?
				</th>
				
			</tr>

%			my $switch;

%			foreach my $event (@events) {

 				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<td>
						<% $event->abbr %>
					</td>
					
					<td>
						<input type="checkbox" name="choose_<% $event->id %>" "checked">
					</td>

				</tr>
% 			}


			<tr>

				<td colspan="4">
					<h4>Select also Judge Groups</h4>
				</td>

			</tr>

			<tr class="lirdrow">

				<th>
					Judge Group
				</th>
				
				<th>
					Export?
				</th>
				
			</tr>

%   		foreach my $group ($tourn->groups) {

    		    <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
			
					<td>
						<% $group->name %>
					</td> 
					
					<td>
						<input type="checkbox" name="choose_<% $group->id %>" value="1">
					</td>

        		</tr>
%   		}


			<tr class="liblrow">
	
				<td align="right" colspan="4">
					<input  type="submit" value="Export TRIE Data File">
					</form>
				</td>
			</tr> 
			
		</table>


		<p>To export speech events into TRIE, you must first set up the TRPC
		program with all your speech events.  You must make sure that the name
		of the speech events in TRIE are the same as the <b>three-letter
		abbreviations</b> of those speech events in this system; otherwise the
		students will not import properly.</p>

		<p>You must also make sure all your schools have <b>unique, two
		letter,</b> codes programmed into this system.  They need not be
		meaningful, but they must exist</p>

		<p>Then copy the ENTRIES file this script presents to the TRIE
		computer, and go to Format:Upload Data from a Text File, and follow the
		instructions there. </p>


	</div>
