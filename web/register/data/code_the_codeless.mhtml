<%args>
	$tourn
	$tourn_settings
	$event_id
</%args>
<%init>

	Tab::Entry->columns(TEMP => "eventcode");
	Tab::Entry->columns(TEMP => "schoolname");

	my $limit;

	if ($event_id && $event_id == int($event_id)) {
		$limit = " and entry.event = ".$event_id;
	}

	Tab::Entry->set_sql(codeless => "
		select entry.*,
			event.abbr as eventcode,
		school.name as schoolname
			from entry, school, event
		where school.tourn = ?
			and school.id = entry.school
			and entry.event = event.id
			and entry.active = 1
			and (
				entry.code is null
				OR entry.code = 0
				OR entry.code = ''
			)
			$limit
		order by entry.created_at desc;
	");

	my @entries = Tab::Entry->search_codeless($tourn->id);

	$m->print("<div class='main'>");

	foreach my $entry (@entries) {
		my $code = $m->comp("/funclib/entry_code.mas", entry => $entry);
		$m->print("<p>Coding entry ".$entry->id." to $code</p>");

		$entry->code($code);
		$entry->update();
		$m->flush_buffer();
	}

	Tab::ChangeLog->create({
		tag         => "tabbing",
		tourn       => $tourn,
		event       => $event_id,
		person      => $person,
		description => "Recoded all ".scalar @entries." entries currently without codes.",
	});

	$m->print("</div>");

</%init>

