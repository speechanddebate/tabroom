<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$category_id => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;
	$category = $tourn->categories->first if (scalar $tourn->categories) == 1;
	$category_id = $category->id if $category;

</%init>

	<& "menu.mas", 
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'export_xml'
	&>

	<div class="main">

		<h2>Export Universal XML</h2>

%		if ($person->id == 1) { 

		<h4>Download Complete Tournament</h4>
	
		<form action="/api/download_data.mhtml?tourn_id=<% $tourn->id %>">

			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="libl padmore rightalign">
				Download All Tournament Results

				<span class="sixth">
					<input type="submit" value="Export">
				</span>
			</div>

		</form>

%		}

		<h4>Partial Downloads</h4>

		<table>

%			foreach my $jg ($tourn->categories) { 

				<tr class="lightrow">

					<th>
						<% $jg->name %>
					</th>

					<td>
						<% scalar $jg->events %> Events
					</td>

					<td class="centeralign">
						<a 
							class="<% $category_id == $jg->id ? "blue" : "red" %>text buttonwhite hover" 
							href="export_xml.mhtml?category_id=<% $jg->id %>">
							<% $category_id == $jg->id ? "Selected" : "Choose" %>
						</a>
					</td>

				</tr>
%			}

		</table>

%		if ($category_id) { 

			<h4>Select events/divisions</h4>

			<form action="/api/download_tourn.mhtml">

			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<input 
				type  = "hidden"
				name  = "category_id"
				value = "<% $category->id %>"
			>

%			foreach my $event ($category->events) { 

				<div class="lightrow">

					<span class="quarter">
						<% $event->name %> 
						<div class="padno smaller martop">
							<% scalar $event->entries( active => 1) %> Active Entries
						</div>
					</span>

					<span class="threequarters nospace">
						<label for="waitlist_<% $event->id %>">
							<span class="third hover centeralign padless">
								Include Waitlist 
									<input 
										type  = "checkbox"
										id    = "waitlist_<% $event->id %>"
										name  = "waitlist_<% $event->id %>"
										value = "1"
									>
							</span>
						</label>

						<label for="drops_<% $event->id %>">
							<span class="third hover centeralign">
								Include Drops 
									<input 
										type  = "checkbox"
										id    = "drops_<% $event->id %>"
										name  = "drops_<% $event->id %>"
										value = "1"
									>
							</span>
						</label>

						<label for="<% $event->id %>">
							<span class="third hover centeralign">
								Export: 
								<input
									type    = "checkbox"
									id      = "<% $event->id %>"
									checked = "checked"
									name    = "<% $event->id %>"
									value   = "1"
								>
							</span>
						</label>
					</span>

				</div>
%			}

			<div class="libl rightalign padmore">
				<input type="submit" value="Export XML">
				</form>
			</div>

%		}

%		if ($person->site_admin) { 

%#		This has been wonky and confusing for folks so needs another pass
%#		sometime before the muggles can get it -CLP 

			<h5>
			OR
			</h5>
	
		<form action="/api/export_tourn_json.mas?tourn_id=<% $tourn->id %>">

			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="libl rightalign padmore">
				<span class="leftalign">Export the whole thing as a JSON file </span>
				<input type="submit" value="Export JSON">
				</form>
			</div>

%		}

	</div>

