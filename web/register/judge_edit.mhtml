<%args> 
	$tourn
	$judge_id => undef
	$judge_code => undef
	$err => undef
	$diocese_id => undef
	$circuit 
	$debug => undef
	$from => undef
</%args>
<%init>

	my $switch;

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	my @judges = Tab::Judge->search( code => $judge_code, tournament => $tourn->id) if $judge_code;
	$judge = shift @judges if @judges;

	unless ($judge ) {
		my $err = "No judge found with code $judge_code.";
		$m->redirect("$Tab::url_prefix/register/judges.mhtml?err=$err");
	}

	$judge_id = $judge->id unless $judge_id;

#	if ($circuit->diocese_based) { 
#		$m->redirect("$Tab::url_prefix/register/diocese_judge_view.mhtml?judge_code=$judge_code&judge_id=$judge_id&from=event");
#	} 

	my $diocese = Tab::Region->retrieve($diocese_id) if $diocese_id;

	my $judge_school = $judge->school if $judge->school;

	$diocese = $judge_school->region if $circuit->diocese_based;

	my $judge_group = $judge->judge_group;
	my $judge_school_id = $judge_school->id if ($judge_school);
	my @ballots = $judge->ballots;
	my @schools = sort {$a->name cmp $b->name} $tourn->schools;

	my @dioschools;

	if ($diocese) { 
		@dioschools = sort {$a->name cmp $b->name} $diocese->schools(tournament => $tourn->id);
	}

 	my @panels = $judge->panels;
	
</%init>

    <& menubar.mas, school => $judge->school, whoami => "judges", tourn => $tourn &>

	<div class="left huge">

	<h4>Judge <% $judge->code %></h4>

		<table cellpadding="5" cellspacing="1" width="100%" border="0">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Name
				</td>

				<td>
					<a class="whiteblock" href="uber_edit.mhtml?uber_id=<% ($judge->uber) ? $judge->uber->id : "" %>&judge_id=<% $judge->id %>">
					<% $judge->first." ".$judge->last %>
					</a>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					<form action="judge_save.mas" method="post">
					<input type="hidden" name="judge_id" value="<% ($judge) ? $judge->id : "" %>">
					<input type="hidden" name="from" value="<% $from %>">
					Code
				</td>

				<td>
					<input type="text" name="code" size="10" value="<% $judge->code %>" style="margin-right: 35px;">

			</tr>

% 			if ($tourn->method->judge_cells) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
					<td>
						Cell Phone:
					</td>	
					
					<td>
						<input type="text" name="cell" size="30" value="<% $judge->cell %>">
					</td>

				</tr>
% 			}


%			if ($circuit->diocese_based) { 
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 
				
					<td>
						Diocese
					</td> 
				
					<td>
						<% $judge->region->name %> (<% $judge->region->code %>)
					</td> 

				</tr>

%			}

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					School:
				</td>
				
				<td>
					<select name="school_id">
						<option value="">Hired</option> 

%							my %school_already;

% 							if ($diocese) { 

% 								foreach my $school (@dioschools) { 

%									$school_already{$school->id}++;
										<option value="<% $school->id %>" <% ($school->id eq $judge_school_id) ? 'selected' : '' %> >
											<% substr($school->name,0,30) %> 
										</option>
%								} 
					
								<option value="">
									---Other Dioceses:---
								</option>

%							}

% 							foreach my $school (@schools) { 

%								next if $school_already{$school->id}++;

								<option value="<% $school->id %>" <% ($school->id eq $judge_school_id) ? 'selected' : '' %> >
									<% substr($school->name,0,30) %> 
								</option> 

%							} 
	
					</select>

				</td>

			</tr> 
			
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 
				
				<td>
					Judging group
				</td> 
				
				<td>
					<select name="judge_group_id">
					
% 						foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) { 

							<option value="<% $group->id %>" <% ($group->id eq $judge_group->id) ? 'selected' : '' %> >
								<% $group->name %> 
							</option>
%						} 

						<option>-----------------------------</option>

					</select> 
				</td> 

			</tr> 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 
			
				<td>
					Covers entries in
				</td> 
				
				<td>
					<select name="covers_id">
						<option value="">
							None Selected
						</option> 

%	 					foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {
    						<option value="<% $group->id %>"
   	 							<% ($judge->covers && $group->id == $judge->covers->id) ? 'selected' : '' %> 
								<% ( ($group->id == $judge->judge_group->id) &! $judge->covers) ? 'selected' : '' %> >
   								<% $group->name %> 
							</option>
%						}  

						<option>-----------------------------</option>
					</select>
				</td>

			</tr>

% 			if ($judge_group->ask_alts) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						Also judges group
					</td>
					
					<td>
						<select name="alt_group_id">

							<option value="">
								None Selected
							</option>

% 							foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%								next if $group->id == $judge_group->id;
%								next if $group->tab_room;

								<option value="<% $group->id %>" <% ($group->id eq $judge->alt_group->id) ? 'selected' : '' %> >
									<% $group->name %> 
								</option>
%							}  

						</select>

					</td>

				</tr>

%			}


% 			if ($tourn->method->track_first_year) { 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						First year out
					</td>
					
					<td>
						<input type="radio" name="first_year" value="1" <% ($judge->first_year == 1) ? 'checked' : '' %> >
						Yes
						<input type="radio" name="first_year" value="0" <% ($judge->first_year != 1) ? 'checked' : '' %> >
						No
					</td>

				</tr>
% 			} 

			<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Active
				</td> 
				
				<td>
					<input type="radio" name="active" value="1" <% ($judge->active == 1) ? 'checked' : '' %> > Yes
					<input type="radio" name="active" value="0" <% ($judge->active != 1) ? 'checked' : '' %> > No
				</td>

			</tr> 
			
			<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Neutral to own school
				</td> 
				
				<td> 
					<input type="radio" name="neutral" value="1" <% ($judge->neutral == 1) ? 'checked' : '' %> > Yes
					<input type="radio" name="neutral" value="0" <% ($judge->neutral != 1) ? 'checked' : '' %> > No
				</td>

			</tr>

			<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Tab/Special Job
				</td>
				
				<td>
					<input type="text" name="special" size="30" value="<% $judge->special %>">
				</td>

			</tr> 
			
			<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Coach's Notes
				</td>

				<td>
					<input type="text" name="notes" size="30" value="<% $judge->notes %>">
				</td>

			</tr>

% 			if ($judge_group->ask_paradigm) { 
			
				<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
					
					<td colspan="2">
						Paradigm
					</td>

				</tr>
					
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<td colspan="2">
						<textarea rows="5" name="paradigm" cols="42"><% $judge->paradigm %></textarea>
					</td>

				</tr>

% 			}


			<tr class="liblrow">

				<td colspan="2" align="right">
					<input class="blue" type="submit" value="Save Judge Information">
					</form>
				</td>

			</tr>

		</table>


% 		if ($judge_group->pools && $judge) { 
		
%			my $switch;

			<h4>Pools:</h4> 
			
				<table cellpadding="4" cellspacing="1" width="100%">

					<form action="judge_save_pools.mhtml" method="post">
					<input type="hidden" value="<% $judge->id %>" name="judge_id">

% 					foreach my $pool (sort {$a->id <=> $b->id} $judge_group->pools) { 

						<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<th>
								<% $pool->name %>
							</th>
							
							<td>
								<input type="checkbox" class="largecheck" name="<% $pool->id %>" value="1" <% ($judge->in_pool($pool)) ? "checked" : "" %>>
							</td>
							
						</tr>

%					} 

					<tr class="liblrow">
						<td colspan="2" align="right">
							<input class="blue" type="submit" value="Save Pool Changes">
							</form>
						</td>
					</tr> 
					
				</table>

% 			}

	</div>

	<div id="rightsmall">

		<table cellpadding="6" cellspacing="1" width="100%">

			<tr class="evenrow">

				<td>
					<form action="judge_edit.mhtml" method="post">
					<input type="text" name="judge_code" size="18" value="Search by judge code" onfocus="value=''">
				</td>

				<td align="right">
					<input class="blue" type="submit" value="Search">
					</form>
				</td>

			</tr>

			<td align="left">
				<form action="judge_search.mhtml" method="post">
				<input type="text" name="last_name" size="18" value="Search by last name" onfocus="value=''">
			</td> 
			
			<td align="right">
				<input class="blue" type="submit" value="Search">
				</form>
			</td>
			
		</tr> 

	</table>

	<hr>
		
	<a href="judge_print.mhtml?judge_id=<% $judge->id %>" class="blue block">
		Print Judge's Info Sheet
	</a>

	<a href="judge_print_card.mhtml?judge_id=<% $judge->id %>" class="blue block">
		Print Judge's Info Card
	</a>

	<hr>

	<a href="judge_drop.mhtml?judge_id=<% $judge->id %>&school_id=<% ($judge->school) ? $judge->school->id : "" %>" class="red block">
		Drop Judge
	</a>

	<hr>

% 	if ($judge_group->coach_ratings) { 

% 		my $switch;

		<h3>Ratings</h3>
			
		<table cellpadding="4" width="100%" cellspacing="1">  

			<form action="judge_rating_save.mhtml" method="post">
			<input type="hidden" value="<%$judge->id%>" name="judge_id">

%			if ($judge_group->qual_subsets) { 

% 				foreach my $subset ($judge_group->qual_subsets) { 

					<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td class="smaller">
							<% $subset->name %>
						</td>
						
						<td align="center">

							<select name="<% $subset->id %>_rating" onchange='this.form.submit()'>

								<option value="">Unrated Judge</option>

%								foreach my $qual (sort {$a->name cmp $b->name} $judge_group->quals(type => "qual")) { 

									<option value="<% $qual->id %>"
										<% ($judge->rating($subset) && ($qual->id == $judge->rating($subset)->qual->id)) ? "selected" : "" %>>
										<% $qual->name %> - <% substr($qual->description,0,15) %>
									</option>
%								}

							</select>
						</td>

					</tr>

%				} 

%			}  else { 

				<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $judge_group->abbr %>
					</td>
						
					<td align="center">
						<select name="rating" onchange='this.form.submit()'>

							<option value="">Unrated Judge</option>

%							foreach my $qual (sort {$a->name cmp $b->name} $judge_group->quals(type => "qual")) { 
								<option value="<% $qual->id %>" <% ($judge->rating && $judge->rating->qual && ($qual->id == $judge->rating->qual->id)) ? "selected" : "" %>>
									<% $qual->name %> - <% substr($qual->description,0,15) %>
								</option>
%							}

						</select>
					</td>

				</tr>

%			}

			<tr class="liblrow"> 
				<td colspan="2" align="right">
					<input class="skinny" type="submit" value="Save Ratings">
					</form>
				</td> 
			</tr>

		</table>

% 	} 

% 		if ($judge->panels) { 

%			my $switch;

			<h4>Assignments:</h4> 
				
%			foreach my $panel (sort {$a->round->timeslot->start <=> $b->round->timeslot->start} $judge->panels) { 

%				my $panel_start = $panel->round->timeslot->start;
%				$panel_start->set_time_zone($circuit->timezone);

				<a class="green block" href="/panel/panel_view.mhtml?panel_id=<% $panel->id %>">
					<span style="width: 35px; display: inline-block;">
						<% $panel_start->hour_12.':'.$panel_start->strftime('%M') %>
					</span>
					<span style="width: 45px; display: inline-block;">
						<% $panel->event->abbr %>
					</span>
					<span style="width: 45px; display: inline-block;">
						<% ($panel->round->label) ? $panel->round->label : "Rnd ". $panel->round->name %>
					</span>
					<% ($panel->room) ?  substr($panel->room->name,0,15) : "" %>
				</a>
				
% 			} 

% 		} 

		<h3>Strikes:</h3>

		<a class="red block" href="strikes.mhtml?judge_id=<% $judge->id %>">
			Add Strike
		</a>

		<p class="smaller">Click to delete:</p>

%  		foreach my $strike (sort {$a->type cmp $b->type} $judge->strikes) {
			<a class="red block" href="strike_rm.mhtml?from=edit&strike_id=<% $strike->id %>">
				<% $strike->name %>
			</a>
%		}

	</div> 
	
	<br style="clear:both"/>
