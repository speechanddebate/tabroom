<%args>
	$circuit
	$account
	$school_id
	$err => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $tourn = $school->tournament;
	my $now = DateTime->now;

	my @housing_requests = $school->housing_reqs;

	my %housing_by_student = ();
	my %housing_by_judge = ();

	foreach my $req (@housing_requests) { 
		push (@{$housing_by_student{$req->student->id}}, $req) if $req->student;
		push (@{$housing_by_judge{$req->judge->id}}, $req) if $req->judge;
	}


	my %housing_days = ();

	my @days = $tourn->days;
  	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

	foreach my $day (@days) {
		$housing_days{$day->ymd}++ if Tab::HousingSlots->search( night => $day->ymd, tournament => $tourn->id );
	}



</%init> 

    <& menubar.mas, school => $school, whoami => "housing", tourn => $tourn &>

	<div>

		<table cellpadding="3" width="100%"> 

			<tr>
				<td width='100%'>
					<h4>Students</h4>
				</td>

				<td>
					<form action="housing_print.mhtml" method="post">
					<input type="hidden" name="school_id" value="<% $school->id %>">
					<input type="submit" value=" Print Housing ">
					</form>
				</td>
			</tr>
		</table>

		<table cellpadding="5" cellspacing="1" width="100%"> 

			<tr class="liblrow">
			
				<th>
					Name
				</th>

				<th>
					Event
				</th>

				<th>
					Gen
				</th>


%   			foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%					next unless $housing_days{$day->ymd};
					
					<th colspan="2">
						<% $day->day_abbr." ".$day->month."/".$day->day %>:
					</th>

%				}

			</tr>

%			my $switch;

%			foreach my $student ($school->students) { 

%				my @housings = @{$housing_by_student{$student->id}} if $housing_by_student{$student->id};

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<a name="student<% $student->id %>">
						<a class="whiteblock" href="<% $Tab::url_prefix %>/register/student_edit.mhtml?student_id=<% $student->id %>">
							<% $student->first." ".$student->last %>
						</a>
					</td>

					<td align="center" class="smaller">
%						foreach my $entry ($student->entries($tourn)) { 
							<% $entry->event->abbr %>
%						}
					</td>

					<td class="center">
						<a class="whiteblock" href="sex_change.mhtml?student_id=<% $student->id %>&school_id=<% $school->id %>">
							<% $student->gender %>
						</a>
					</td>

%   				foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%						next unless $housing_days{$day->ymd};
	
%						my $housing;
%						undef $housing;

%						foreach my $req (@housings) { 
%							next unless $req->night->ymd eq $day->ymd;
%							$housing = $req;
%						}

%						if ($housing) { 

%							if ($housing->waitlist) { 

								<td class="smaller" style="font-style: italic;" align="center">
									Waitlist
								</td>

								<td class="smaller" align="center">

									[<a href="housing-unwl.mhtml?req_id=<% $housing->id %>&school_id=<% $school->id %>">Confirm</a>]
									[<a href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">Cancel</a>]

								</td>

%							} else { 

								<td align="center" class="smaller">
									YES
								</td>

								<td align="center" class="smaller">
									[<a href="housing-wl.mhtml?req_id=<% $housing->id %>&school_id=<% $school->id %>">Waitlist</a>]
									[<a href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">Cancel</a>]
								</td>
%							}

	
%						} else { 

							<td class="smaller" align="center">
								NO
							</td>

							<td class="smaller" align="center">

								<a class="whiteblock" href="housing_plz.mhtml?student_id=<% $student->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
									Request
								</a>
							</td>

%						}
	
%					}  

				</tr>
%			}

		</table>

		<h4>Judges</h4>

		<table cellpadding="5" cellspacing="1" width="100%"> 

			<tr class="liblrow">
			
				<th>
					Name
				</th>

				<th>
					Pool
				</th>

				<th>
					Gen
				</th>


%   			foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%					next unless $housing_days{$day->ymd};
					
					<th colspan="2">
						<% $day->day_abbr." ".$day->month."/".$day->day %>:
					</th>

%				}

			</tr>


%			foreach my $judge ($school->judges) {

%				my @housings = @{$housing_by_judge{$judge->id}} if $housing_by_judge{$judge->id};

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<a name="judge<% $judge->id %>">
						<a class="whiteblock" href="judge_edit.mhtml?judge_id=<% $judge->id %>">
							<% $judge->first." ".$judge->last %>
						</a>
					</td> 

					<td align="center" class="smaller"> 
						<% $judge->judge_group->abbr %>
					</td>
					
					<td align="center">
						<a class="whiteblock" href="judge_sex_change.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>">
							<% $judge->gender %>
						</a>
					</td>
				
%   				foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%						next unless $housing_days{$day->ymd};
%						my $housed;

%						foreach my $housing (@housings) { 

%							next unless $housing->night->ymd eq $day->ymd;

%							$housed++;

%							if ($housing->waitlist) { 

								<td class="smaller" style="font-style: italic;" align="center">
									Waitlist
								</td>

								<td class="smaller" align="center">
	
									[<a href="housing-unwl.mhtml?req_id=<% $housing->id %>&school_id=<% $school->id %>">Confirm</a>]
									[<a href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">Cancel</a>]
	
								</td>
	
%							} else { 

								<td align="center" class="smaller">
									YES
								</td>

								<td align="center" class="smaller">
									[<a href="housing-wl.mhtml?req_id=<% $housing->id %>&school_id=<% $school->id %>">Waitlist</a>]
									[<a href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">Cancel</a>]
								</td>
%							}

%						} 

%						unless ($housed > 0) { 

							<td class="smaller" align="center">
								NO
							</td>

							<td class="smaller" align="center">

								<a class="whiteblock" href="judge_housing_plz.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
								Request
								</a>
							</td>
%						}

%					}  

				</tr>
%			}	

		</table>

	</div>
