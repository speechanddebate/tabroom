<%args>
	$tourn
	$tourn_settings
	$sort_by => "name"
</%args>
<%init>

	Tab::School->columns(TEMP => "country");

	Tab::School->columns(TEMP => "nsda");
	Tab::School->columns(TEMP => "regionname");
	Tab::School->columns(TEMP => "regioncode");
	Tab::School->columns(TEMP => "districtname");
	Tab::School->columns(TEMP => "districtcode");
	Tab::School->columns(TEMP => "entered");

	Tab::School->set_sql(tourn => "
		select school.*, chapter.country as country, chapter.nsda as nsda,
			region.name as regionname, region.code as regioncode,
			district.name as districtname, district.code as districtcode,
			entered_on.value_date entered
		from school
		left join chapter on chapter.id = school.chapter
		left join region on school.region = region.id
		left join district on school.district = district.id
		left join school_setting entered_on
			on entered_on.school = school.id
			and entered_on.tag = 'entered_on'
		where school.tourn = ?
		order by school.name

	");

	my @schools = Tab::School->search_tourn($tourn->id);

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "school_list"
	&>

	<div class="main">

		<span class="half nospace">
			<h2><% scalar $tourn->schools %> Schools</h2>
		</span>
		<span
			class = "half nospace rightalign"
			id    = "schools_buttonarea"
		>

			<a class="buttonwhite redtext fa fa-sm fa-file-pdf-o"
				href="school_list_print.mhtml"
			></a>

			<a class="buttonwhite greentext fa fa-sm fa-file-excel-o"
				href="school_list_csv.mhtml"
			></a>

		</span>

		<& "/funclib/tablesorter.mas", table => "schools", nobuttons => 1 &>

		<table id="schools">

			<thead>

			<tr class="yellowrow">

				<th class="smaller">
					School
				</th>

				<th class="smaller">
					Locale
				</th>

%				if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {
					<th class="smaller">
						ID
					</th>

					<th class="smaller">
						SCode
					</th>

					<th class="smaller">
						DCode
					</th>

%				} elsif ($tourn_settings->{"school_codes"}) {
					<th class="smaller">
						Code
					</th>
%				}

				<th class="smaller">
					First Entered
				</th>

%				if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

%				} elsif ($tourn_settings->{"regions"} || $tourn_settings->{"ncfl"}) {

					<th class="smaller">
						Dio/Reg
					</th>

					<th class="smaller">
						Code
					</th>
%				}

				<th class="smaller">
					Onsite
				</th>

			</tr>

			</thead>

			<tbody>

<%perl>
			foreach my $school (@schools) {

				my $entered = $school->entered;

				my ($date, $time) = split (/\ /, $entered);
				my ($year, $month, $day) = split (/\-/, $date);

				$entered =~ s/[\D_]//g;
				$month =~ s/^0+//;
</%perl>

				<tr>

					<td>
						<a class="white"
							href="/register/school/edit.mhtml?school_id=<% $school->id %>"
						>
							<% $school->name %>
						</a>
					</td>

					<td>
						<% $school->country %><% ($school->state) ? "/".$school->state : ""%>
					</td>

%					if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {
						<td class="rightalign">
							<% $school->nsda %>
						</td>
						<td class="rightalign">
							<% $school->regioncode %>
						</td>
						<td class="rightalign">
							<% $school->districtcode %>
						</td>
%					} elsif ($tourn_settings->{"school_codes"}) {
						<td>
							<% $school->code %>
						</td>
%					}

					<td class="centeralign">
						<span class="hidden"><% $entered %></span>
						<% $month."/".$day %>
					</td>

%					if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {
%					} elsif ($tourn_settings->{"regions"} || $tourn_settings->{"ncfl"}) {

						<td>
							<% $school->regioncode %>
						</td>

						<td>
							<a class="white" href="/register/diocese/edit.mhtml?school_id=<% $school->id %>">
								<% $school->regionname %>
							</a>
						</td>
%					}

					<td class="centeralign">
						<span class="fa fa-lg <% $school->onsite
							? "fa-check greentext"
							: "fa-times redtext"
						%>"></span>
					</td>

				</tr>

%			}

			</tbody>

		</table>

	</div>

