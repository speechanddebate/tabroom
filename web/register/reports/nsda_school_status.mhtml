<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	Tab::School->columns( TEMP => "last_created" );
	Tab::School->columns( TEMP => "pending" );

    my $dbh = Tab::DBI->db_Main(); 

    my %school_data;

	my $unconfirmed_sth = $dbh->prepare("
		select school.id, 
			count(entry.id) as pending, 
			DATE_FORMAT(max(entry.created_at), '%c/%e') as last_created
		from school, entry
            where school.id = entry.school
            and school.tourn = ?
            and entry.unconfirmed = 1 
			and school.chapter > 0

            and not exists (
                select es.id 
                from entry_setting es
                where es.tag = 'rejected_by'
                and es.entry = entry.id
            )

            and not exists (
                select supp.id 
                from event_setting supp
                where supp.tag = 'supp'
				and supp.event = entry.event
            )

            and not exists (
                select conn.id 
                from event_setting conn
                where conn.tag = 'conn'
				and conn.event = entry.event
            )

        group by school.id
	");

	$unconfirmed_sth->execute($tourn->id);

    while (
        my ($school_id, $pending, $last_created) = $unconfirmed_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"pending"} = $pending;
		$school_data{$school_id}{"last_created"} = $last_created;
	}

	my $unrejected_sth = $dbh->prepare("
		select school.id, count(entry.id)
			from school, entry
			where school.id = entry.school
			and school.tourn = ? 
			and school.chapter > 0
			and not exists (
				select es.id
				from entry_setting es
				where es.tag = 'rejected_by'
				and es.entry = entry.id
			)
			group by school.id
	");

	$unrejected_sth->execute($tourn->id);

    while (
        my ($school_id, $entry_count) = $unrejected_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"unrejected"} = $entry_count;
	}

	my $incomplete_sth = $dbh->prepare("
		select school.id, count(entry.id)
			from school, entry
			where school.id = entry.school
			and school.tourn = ? 
			and entry.active = 1
			and school.chapter > 0
			and not exists (
				select es.id
				from entry_setting es
				where es.tag = 'status'
				and es.value = 'complete'
				and es.entry = entry.id
			)
			and not exists (
				select evset.id
				from event_setting evset
				where evset.tag = 'supp'
				and evset.event = entry.event
			)
			and not exists (
				select evset.id
				from event_setting evset
				where evset.tag = 'conn'
				and evset.event = entry.event
			)
			group by school.id
	");

	$incomplete_sth->execute($tourn->id);

    while (
        my ($school_id, $entry_count) = $incomplete_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"incomplete"} = $entry_count;
	}

	my $incom_judge_sth = $dbh->prepare("

		select school.id, count(judge.id)
			from school, judge
			where school.id = judge.school
			and school.tourn = ? 
			and school.chapter > 0
			and exists (
				select js.id
				from judge_setting js
				where js.tag = 'incomplete'
				and js.judge = judge.id
			)
			group by school.id
	");

	$incom_judge_sth->execute($tourn->id);

    while (
        my ($school_id, $judge_count) = $incom_judge_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"incom_judges"} = $judge_count;
	}

	my %school_settings = $m->comp(
		"/funclib/school_settings.mas", 
		tourn => $tourn
	);
	
	my $school_sth = $dbh->prepare('
		select school.id, school.name, school.state
		from school
		where school.tourn = ? 
		and school.chapter > 0
	');

	$school_sth->execute($tourn->id);

    while (
        my ($school_id, $school_name, $school_state, $contact_name, $contact_email) 
			= $school_sth->fetchrow_array()
    ) {

		$school_data{$school_id}{"name"} = $school_name;
		$school_data{$school_id}{"state"} = $school_state;
		$school_data{$school_id}{"short_name"} = Tab::short_name($school_name);
	}

</%init>

	<div class="blankfull">

		<span class="half nospace">
			<h4>School status</h4>
		</span>

		<span 
			class = "rightalign half nospace"
			id    = "status_buttonarea"
		>
			<a 
				class         = "buttonwhite greentext nowrap smallish"
				on_success    = "refresh"
				onClick       = "postSwitch(this, 'nsda_entries.mas');"
			>
 				<span class="fa fa-sm fa-refresh"></span>
				Sync Entry
			</a>
			<a 
				class         = "buttonwhite bluetext nowrap smallish"
				on_success    = "refresh"
				onClick       = "postSwitch(this, 'nsda_judging.mas');"
			>
 				<span class="fa fa-sm fa-refresh"></span>
				Sync Judge
			</a>
		</span>

		<& "/funclib/tablesorter.mas", table => "status" &> 

		<table id="status">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						State
					</th>

					<th class="Contact info & agreements entered">
						Contact?
					</th>

					<th title="Date of most recent entry in pending state">
						Pending
					</th>
					<th title="Date of most recent entry in pending state">
						Pending Since
					</th>

					<th title="Number of entries that are not rejected">
						Unrej
					</th>

					<th title="Number of entries marked incomplete">
						Incomp
					</th>

					<th title="Judging obligations not met">
						Judging
					</th>

					<th title="Judges marked incomplete">
						Inc Judges
					</th>

					<th title="Money still owed">
						Contact Name
					</th>

					<th title="Money still owed">
						Contact Email
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>
			foreach my $id (
				sort {$school_data{$a}{"short_name"} cmp $school_data{$b}{"short_name"}} 
				keys %school_data
			) { 
						
				next unless $school_data{$id}{"unrejected"}; 

</%perl>

				<tr>

					<td class="nospace smallish">
						<a 
							class="full padvert plain"
							target="_blank"
							href="/register/school/edit.mhtml?school_id=<% $id %>"
						><% $school_data{$id}{"short_name"} %></a>
					</td>

					<td class="nospace centeralign">
						<% $school_data{$id}{"state"} %>
					</td>

					<td class="contact centeralign">
						<% 
							$school_settings{$id}{"contact_name"} 
							&& $school_settings{$id}{"contact_number"} 
							&& $school_settings{$id}{"contact_email"} 
							? "" : "N"
						%>
					</td>

					<td class="pending centeralign smallish">
						<% $school_data{$id}{"pending"} 
							? $school_data{$id}{"pending"} 
							: ""
						%>
					</td>
					<td class="pending centeralign smallish">
						<% $school_data{$id}{"last_created"} 
							? $school_data{$id}{"last_created"} 
							: ""
						%>
					</td>

					<td class="rejected centeralign">
						<% $school_data{$id}{"unrejected"} 
							? $school_data{$id}{"unrejected"} 
							: ""
						%>
					</td>

					<td class="incomplete centeralign">
						<% $school_data{$id}{"incomplete"} 
							? $school_data{$id}{"incomplete"} 
							: ""
						%>
					</td>

					<td class="redtext centeralign">
						<% $school_settings{$id}{"judging_unmet"} ? "N" : "" %>
					</td>

					<td class="incom_judges centeralign">
						<% $school_data{$id}{"incom_judges"} 
							? $school_data{$id}{"incom_judges"} 
							: ""
						%>
					</td>

					<td class="smaller">
						<% $school_settings{$id}{"contact_name"} %>
					</td>

					<td class="smaller nospace">
						<a 
							class="plain padvert hover"
							href="mailto:<% $school_settings{$id}{"contact_email"} %>">
						<% $school_settings{$id}{"contact_email"} %>
						</a>
					</td>

				</tr>

%			}

			</tbody>

		</table>


	</div>
