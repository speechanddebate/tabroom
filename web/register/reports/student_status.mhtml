<%args>
	$tourn
	$tourn_settings
	$dbh
</%args>
<%init>

	my $students_sth = $dbh->prepare("

		select
			student.id, student.first, student.last,
			school.id school, school.name school_name,
			GROUP_CONCAT(DISTINCT(event.abbr)) events,
			COUNT(DISTINCT(active.id)) as active,
			COUNT(DISTINCT(waitlisted.id)) as waitlisted

		from (student, entry_student es, entry, school, event)

			left join entry active
				on active.school = school.id
				and active.active = 1
				and EXISTS (
					select es.id
					from entry_student es
					where es.entry = active.id
					and es.student = student.id
				)

			left join entry waitlisted
				on waitlisted.school = school.id
				and waitlisted.waitlist = 1
				and EXISTS (
					select es.id
					from entry_student es
					where es.entry = waitlisted.id
					and es.student = student.id
				)

			where 1=1
				and school.tourn = ?
				and school.id = entry.school
				and entry.id = es.entry
				and es.student = student.id
				and entry.dropped != 1
				and entry.unconfirmed != 1
				and entry.event = event.id

			GROUP BY student.id
			order by student.last, student.first
	");

	$students_sth->execute($tourn->id);
	my $students = $students_sth->fetchall_hash();

	my $school_sth = $dbh->prepare("
		select
			school.id, forms.value_text forms
		from school, school_setting forms
		where school.tourn = ?
			and school.id = forms.school
			and forms.tag = 'student_form_confirm'
	");

	$school_sth->execute($tourn->id);
	my $schools = $school_sth->fetchall_hash();

	my %schools;

	foreach my $ref (@{$schools}) {
		$schools{$ref->{id}} = eval {
			return JSON::decode_json($ref->{forms});
		};
	}

</%init>

	<div class="main">
		<div class="flexrow">
			<span class="third">
				<h5>Students Confirmed</h5>
			</span>

			<span
				class = "twothirds rightalign padright"
				id    = "student_confirmations_buttonarea"
			>
			</span>
		</div>

		<& "/funclib/tablesorter.mas",
			table => "student_confirmations"
		&>

		<table id="student_confirmations">

			<thead>
				<tr class="yellowrow">
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>

					<th>
						Events
					</th>

					<th class="centeralign">
						Active Entries
					</th>

					<th class="centeralign">
						WL Entries
					</th>

					<th>
						Confirmed?
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $student (@{$students}) {
					<tr>
						<td>
							<% $student->{first} %>
						</td>

						<td>
							<% $student->{last} %>
						</td>

						<td>
							<% $student->{school_name} %>
						</td>

						<td class="centeralign">
							<% $student->{events} %>
						</td>

						<td class="centeralign <% $student->{active} ? "" : "redtext semibold" %>">
							<% $student->{active} %>
						</td>

						<td class="centeralign <% $student->{waitlisted} ? "orangetext semibold" : "" %>">
							<% $student->{waitlisted} %>
						</td>

						<td
							data-text = "<% $schools{$student->{school}}{$student->{id}} ? "2" : "1" %>"
							class     = "centeralign nospace"
						>
							<% $schools{$student->{school}}{$student->{id}} ? "Y" : "N" %>
						</td>
					</tr>
%				}
			</tbody>

		</table>
	</div>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "student_status"
	&>
