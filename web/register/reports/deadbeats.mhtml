<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $whoami = "deadbeats";

	my %category_settings;
	my %event_settings;

	my @categories = $tourn->categories();
	my @events = $tourn->events();
	my @event_ids; 
	foreach my $ev (@events) { 
		push @event_ids, $ev->id;
	}

	foreach my $category (@categories) { 
		%{$category_settings{$category->id}} = $category->all_settings();
		$category_settings{$category->id}{"shifts"} = $category->shifts(type => "strike");
	}

	foreach my $event (@events) { 
		%{$event_settings{$event->id}} = $event->all_settings();
		$event_settings{$event->id}{"fee"} = $event->fee;
	}

	my @entries = $m->comp(
		"/funclib/tourn_entries.mas", 
			tourn => $tourn,
			all   => 1
	);

	my %schools; 

	foreach my $entry (@entries) { 
		push @{$schools{"entries"}{$entry->schoolid}}, $entry;
	}

	my @judges = $m->comp(
		"/funclib/tourn_judges.mas", 
			tourn => $tourn,
			all   => 1
	);

	foreach my $judge (@judges) { 
		push @{$schools{"judges"}{$judge->schoolid}{$judge->categoryid}}, $judge;
		push @{$schools{"judges"}{$judge->schoolid}{"all"}}, $judge;
	}

	my @fines = $m->comp(
		"/funclib/tourn_fines.mas", 
			tourn => $tourn,
			all   => 1
	);

	foreach my $fine (@fines) { 
		push @{$schools{"fines"}{$fine->schoolid}}, $fine;
	}

	my @concessions = $tourn->concessions();

	if (@concessions) { 

		%{$schools{"orders"}} = $m->comp(
			"/funclib/tourn_purchases.mas",
			tourn => $tourn
		);
	}

	my @hotels = $tourn->hotels;

	if (@hotels) { 
		%{$tourn_settings->{$tourn->id}{"hotels"}} =
			map {$_->id => $_} @hotels;

		%{$schools{"hotels"}} = $m->comp(
			"/funclib/school_settings.mas", 
			tourn => $tourn,
			tag   => "hotel"
		);

	}

	my @hires = $m->comp(
		"/funclib/tourn_hires.mas",
		tourn => $tourn 
	);

	foreach my $hire (@hires) { 
		push @{$schools{"hires"}{$hire->schoolid}{$hire->categoryid}}, $hire;
		push @{$schools{"hires"}{$hire->schoolid}{"all"}}, $hire;
	}

	my $worlds;
	my $worlds_id;
	my %invoiced; 

	Tab::EventSetting->set_sql( adjustments => "
        select adjustment.id
        from event, event_setting adjustment
        where event.tourn = ? 
        and event.id = adjustment.event 
        and adjustment.tag = 'adjust_judges_fees'
	");

	$tourn_settings->{"adjustments"}++ if Tab::EventSetting->search_adjustments($tourn->id);

	if ($tourn_settings->{"nsda_nats"}) { 

		my @worlds_events = $m->comp(
			"/funclib/nationals_events.mas",
			tourn => $tourn,
			type  => "usa_wsdc"
		);

		if (@worlds_events) { 

			$worlds = shift @worlds_events;
			$worlds_id = $worlds->id;

			my $worlds_sth = $dbh->prepare("
				select student.id, school.id as schoolid
				from student, entry_student, entry, chapter, school, event, category
				where entry.event = ? 
					and entry.id = entry_student.entry
					and entry_student.student = student.id
					and student.chapter = chapter.id
					and chapter.id = school.chapter
					and school.tourn = category.tourn
					and category.id = event.category
					and event.id = entry.event
			");

			$worlds_sth->execute($worlds_id);

			while (
				my ($student_id, $school_id) = $worlds_sth->fetchrow_array()
			) { 
				push @{$schools{"worlds"}{$school_id}}, $student_id; 
			}
		}

		my $invoiced_sth = $dbh->prepare("
			select school.id, invoice.total
				from school, invoice
				where invoice.school = school.id
				and school.tourn = ? 
		");

		$invoiced_sth->execute($tourn->id);

		while (
			my ($school_id, $amount) = $invoiced_sth->fetchrow_array()
		) { 

			$invoiced{$school_id} += $amount;
		}
	}

	my %school_by_id = map {$_->id => $_} $tourn->schools();

	my %school_data;

    my $school_sth = $dbh->prepare('
        select school.id, school.name, school.state, chapter.nsda
        from school
		left join chapter on school.chapter = chapter.id
        where school.tourn = ? 
		and school.chapter > 0
    ');

    $school_sth->execute($tourn->id);

    while (
        my ($school_id, $school_name, $school_state, $chapter_nsda) 
            = $school_sth->fetchrow_array()
    ) { 

        $school_data{$school_id}{"name"} = $school_name;
        $school_data{$school_id}{"nsda"} = $chapter_nsda;
        $school_data{$school_id}{"state"} = $school_state;
        $school_data{$school_id}{"short_name"} = Tab::short_name($school_name);
    }   


</%init>

	<script>

		function showOwed () { 

			$(".owed").removeClass('hidden');
			$(".owed").addClass('row');

			$(".owing").addClass('hidden');
			$(".owing").removeClass('row');

			$(".controls").removeClass("invert");
			$("#showOwed").addClass('invert');

			zebraRows();
		};

		function showOwing () { 

			$(".owing").removeClass('hidden');
			$(".owing").addClass('row');

			$(".owed").addClass('hidden');
			$(".owed").removeClass('row');

			$(".controls").removeClass("invert");
			$("#showOwing").addClass('invert');

			zebraRows();
		};

		function showBoth () { 
			$(".owing").removeClass('hidden');
			$(".owed").removeClass('hidden');

			$(".owing").addClass('row');
			$(".owed").addClass('row');

			$(".controls").removeClass("invert");
			$("#showBoth").addClass('invert');

			zebraRows();
		}

	</script>


	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => $whoami
	&>

	<div class="main">

		<div class="full nospace">

			<span class="twofifths">
				<h4>Non zero balances</h4>
			</span>

			<span 
				class="half nospace centeralign"
			>

%				if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) { 
					<a 
						class = "buttonwhite greentext controls smallish invert"
						href  = "/funclib/school_balances.mas?trigger_invoices=1&deadbeats=1"
					>Invoice All</a>
%				}

				<a 
					id="showOwing"
					class="buttonwhite bluetext controls hover smallish"
					onClick="showOwing();";
				>Owing</a>

				<a 
					id="showOwed"
					class="buttonwhite bluetext controls hover smallish"
					onClick="showOwed();";
				>Refunds</a>

				<a 
					id="showBoth"
					class="buttonwhite bluetext invert controls hover smallish"
					onClick="showBoth();";
				>
					Both
				</a>

			</span>
			<span class="tenth rightalign nospace"
				id="nonzero_buttonarea"
			>
			</span>

		</div>

		<& "/funclib/tablesorter.mas", 
			table     => "nonzero",
		&>

		<table id="nonzero">

			<thead>

				<tr class="smallish yellowrow">

					<th>
						School Name
					</th>
%					if ($tourn_settings->{"nsda_nats"}) { 
						<th>
							ID
						</th>
%					}

					<th>
						Entries
					</th>

					<th>
						Total
					</th>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<th>
							Invoiced
						</th>
						<th>
							Uninvoiced
						</th>
%					}

					<th>
						Paid
					</th>

					<th>
						Amount
					</th>

					<th>
					</th>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<th>
							Invoice
						</th>
%					}

				</tr>

			</thead>

			<tbody>

<%perl>

			Tab::SchoolSetting->set_sql( rm_balance => "
				delete from school_setting 
				where school = ?
				and tag = 'balance'
			");

            foreach my $school_id (
                sort {$school_data{$a}{"short_name"} cmp $school_data{$b}{"short_name"}}
                keys %school_data
            ) {

				my ($total, $feline_ref, $total_ref) = 
					$m->comp("/funclib/school_fees.mas", 
						school            => $school_by_id{$school_id},
						tourn             => $tourn,
						tourn_settings    => $tourn_settings,
						categories        => \@categories,
						category_settings => \%category_settings,
						events            => \@event_ids,
						concession_array  => \@concessions,
						event_settings    => \%event_settings,
						all               => 1,
						bulk              => 1,
						entries           => $schools{"entries"}{$school_id},
						schools           => \%schools,
						worlds_event      => $worlds_id
					);

				next if $total == -0;
				next if $total > 0 && $whoami eq "owed_only";
				next if $total < 0 && $whoami eq "owing_only";
				
				my $entry_count;

				if ($schools{"entries"}{$school_id}) { 
					$entry_count += scalar @{$schools{"entries"}{$school_id}};
				}
				
				if ($schools{"worlds"}{$school_id}) { 
					$entry_count += scalar @{$schools{"worlds"}{$school_id}};
				}

</%perl>
				<tr class="row <% $total < 0 ? "owed" : "owing" %>">
					
					<td>
						<a 
							class="white" 
							target="_blank"
							href="/register/school/edit.mhtml?school_id=<% $school_id %>"
						>
							<% $school_data{$school_id}{"name"} %>
						</a>
					</td>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<td>
							<% $school_data{$school_id}{"nsda"} %>
						</td>
%					}

					<td class="rightalign">
						<% $entry_count %>
					</td>

					<td class="rightalign code">
						<% sprintf ("%.2f", $total_ref->{"total_fees"}) %>
					</td> 
				
%					if ($tourn_settings->{"nsda_nats"}) { 
						<td class="rightalign code">
							<% sprintf ("%.2f", $invoiced{$school_id}
								?  $invoiced{$school_id} 
								: "0")
							%>
						</td> 

						<td class="rightalign code">
							<% sprintf ("%.2f", ($total_ref->{"total_fees"} - $invoiced{$school_id}) 
								?  ($total_ref->{"total_fees"} - $invoiced{$school_id})
								: "0")
							%>
						</td> 
%					}

					<td class="rightalign code">
						<% sprintf ("%.2f", $total_ref->{"payments"} )%>
					</td> 
				
					<td class="rightalign code">
						<% sprintf ("%.2f", $total ) %>
					</td>

					<td class="centeralign nospace">
						<a 
							class  = "bluetext buttonwhite fa fa-lg fa-credit-card"
							target = "_blank"
							title  = "Edit money screen"
							href   = "/register/school/invoice.mhtml?school_id=<% $school_id %>"
						>
						</a>
						<a 
							class  = "redtext buttonwhite fa fa-lg fa-file-pdf-o"
							target = "_blank"
							title  = "Printable invoice"
							href   = "/register/school/invoice_print.mhtml?school_id=<% $school_id %>"
						>
						</a>
					</td>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<td class="centeralign nospace">
%							if ($total_ref->{"total_fees"} > $invoiced{$school_id})  { 
								<span class="hidden">1</span>
								<a 
									class         = "fa fa-lg fa-money buttonwhite greentext"
									target_id     = "<% $school_id %>"
									property_name = "async"
									onClick       = "postSwitch(this, '/funclib/create_nsda_invoice.mas');"
								>
								</a>
%							} else {
								<span class="hidden">2</span>
%							} 

						</td>

<%perl>
						if ($ARGS{"save_status"} && $total > 0) { 

							Tab::SchoolSetting->create({ 
								school => $school_id,
								tag    => 'balance',
								value  => $total
							});

						} else { 
							Tab::SchoolSetting->sql_rm_balance->execute($school_id);
						}
</%perl>

%					}
					
				</tr>

%			} # end of foreach school

			</tbody>

		</table>

	</div>


