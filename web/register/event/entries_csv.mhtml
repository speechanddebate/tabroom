<%args>
	$tourn
	$account
	$session
	$event_id => 0
	$drops => undef
	$waitlist => undef
	$sort => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @events;
	my $namestring;

	if ($event_id) { 

		$events[0] = Tab::Event->retrieve($event_id);
		$namestring = $events[0]->abbr;

	} else {

		@events = sort{$a->name cmp $b->name} $tourn->events;
		$namestring = "all-events";

	}

	my $filename = "entry-".$namestring."-".$session->id;
	my $filepath = $Tab::file_root."/tmp/$filename";
	my $garbage = `rm -f $filepath.*`;

	open (CSVOUT, ">$filepath.csv");

	print CSVOUT ",";
	print CSVOUT "Code,";
	print CSVOUT "Event,";
	print CSVOUT "DioCode,"  if $tourn->setting("ncfl");
	print CSVOUT "Diocese," if $tourn->setting("ncfl");
	print CSVOUT "Region," if $tourn->setting("regions");
	print CSVOUT "Schcode,"  if $tourn->setting("school_codes") && not defined $tourn->setting("ncfl");
	print CSVOUT "School,";
	print CSVOUT "Name,";
	print CSVOUT "Registered At,";
	print CSVOUT "Dropped At,";
	print CSVOUT "\n";

	foreach my $event (@events) { 
		
		my @entries;

		if ($drops) { 
			@entries = Tab::Entry->search( event => $event->id, dropped => 1 )  if $drops;
		} elsif ($waitlist) { 
			@entries = Tab::Entry->search( event => $event->id, waitlist => 1 )  if $waitlist;
		} else { 
			@entries = Tab::Entry->search( event => $event->id );
		}

		@entries = sort {$a->code <=> $b->code} @entries;
	
		foreach my $entry (@entries) { 

			if ($entry->dropped) { 
				print CSVOUT &Tab::texify("DROP");
			} elsif ($entry->waitlist) { 
				print CSVOUT &Tab::texify("WL");
			} 

			print CSVOUT ",";

			print CSVOUT "\"".&Tab::texify($m->comp('/funclib/entry_code.mas', entry => $entry, full => 1))."\",";
			print CSVOUT &Tab::texify($event->abbr).",";

			if ($tourn->setting("ncfl")) { 
				print CSVOUT &Tab::texify($entry->school->region->code).",";
				print CSVOUT &Tab::texify($entry->school->region->name).",";
			} elsif ($tourn->setting("school_codes")) { 
				print CSVOUT &Tab::texify($entry->school->code).",";
			} 
			
			if ($tourn->setting("regions")) { 
				print CSVOUT &Tab::texify($entry->school->region->name).",";
			}

			print CSVOUT "\"".&Tab::texify($entry->school->name)."\",";
			print CSVOUT "\"".&Tab::texify($entry->name)."\",";

			print CSVOUT &Tab::csvdt($entry->reg_time->set_time_zone($tz)) if $entry->reg_time;
			print CSVOUT ",";
			print CSVOUT &Tab::csvdt($entry->drop_time->set_time_zone($tz)) if $entry->drop_time;
			print CSVOUT ",";

			foreach my $student ($entry->students) { 
				print CSVOUT "\"".&Tab::texify($student->first." ".$student->last)."\",";
			}
			print CSVOUT "\n";

		}

	}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/$filename.csv");

</%init>

