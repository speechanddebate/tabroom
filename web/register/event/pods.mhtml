<%args>
	$event_id
	$tourn
	$tourn_settings
	$dbh
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my %event_settings = $event->all_settings();

	unless ($event_settings{"round_robin"}) {
		$m->print("Pods only make sense for round robins.");
		$m->abort;
	}

	my @entries = Tab::Entry->search(
		event  => $event->id,
		active => 1
	);

	my $pods = $event_settings{"pods"};

	unless ($pods && scalar (keys %{$pods}) ) {

		my $legacy_sth = $dbh->prepare('
			select
				tag, value
			from event_setting
			where 1=1
				and event = ?
				and tag like "pod%"
		');

		$legacy_sth->execute($event_id);

		my $legacies = $legacy_sth->fetchall_hash();

		foreach my $leg (@{$legacies}) {
			my $id = $leg->{tag};
			$id =~ s/[\D_]//g;
			$pods->{$id} = $leg->{value};
		}
	}

	my $entry_sth = $dbh->prepare('
		select
			entry.id, entry.name, entry.code,
			school.id school_id, school.name school_name, pod.value pod
		from entry
			left join entry_setting pod on pod.entry = entry.id and pod.tag = "pod"
			left join school on entry.school = school.id
		where 1=1
			and entry.active = 1
			and entry.event = ?
		order by entry.code, entry.name
	');

	$entry_sth->execute($event->id);
	my $entries = $entry_sth->fetchall_hash();

	foreach my $entry (@{$entries}) {
		unless ($pods->{$entry->{pod}}) {
			$pods->{$entry->{pod}} = "IAMAPOD";
		}
	}

</%init>

	<& menu.mas,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		event          => $event,
		pods           => "yup"
	&>

	<div class="main">

		<span class="seveneighths nospace">
			<h4>Round robin pods</h4>

			<p class='semibold redtext'>
				Use numbers (1,2,3) to designate pod members.
				Then, (optionally) set labels for pods below.
			</p>
		</span>

		<span
			id    = "pods_buttonarea"
			class = "eighth rightalign">
		</span>

		<& "/funclib/tablesorter.mas", table => "pods" &>

		<form
			action = "pods_save.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

		<table id="pods">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						Entry Name
					</th>

					<th class="smaller">
						School
					</th>

					<th class="smaller">
						Pod
					</th>

				</tr>
			</thead>

			<tbody>

%				foreach my $entry (@{$entries}) {
					<tr>

						<td class="smallish">
							<a
								class="white"
								href="/register/entry/edit.mhtml?entry_id=<% $entry->{id} %>"
								tabindex=-1
							>
								<% $entry->{code} %>
							</a>
						</td>

						<td class="smallish">
							<a class     = "white"
								href     = "/register/entry/edit.mhtml?entry_id=<% $entry->{id} %>"
								tabindex = -1
							>
								<% $entry->{name} %>
							</a>
						</td>

						<td class="smallish">
							<a
								class    = "white"
								href     = "/register/school/entries.mhtml?event_id=<% $event->id %>&school_id=<% $entry->{school_id} %>"
								tabindex = -1
							>
								<% $entry->{school_name} %>
							</a>
						</td>
					</td>

					<td
						class     = "smallish"
						data-text = "<% $entry->{pod} %>"
					>
						<input
							type  = "number"
							min   = "0"
							max   = "99"
							name  = "<% $entry->{id} %>"
							value = "<% $entry->{pod} %>"
						>
					</td>
				</tr>
%			}

			</tbody>
		</table>

		<div class="libl pagefull rightalign">
			<span class="centeralign third">
				<input
					type  = "submit"
					value = "Save Pod Assignments"
				>
			</span>
		</div>

		</form>

		<h4>Pod labels</h4>

		<form
			action = "pods_names.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

%		foreach my $pod (sort keys %{$pods}) {

%			undef $pods->{$pod} if $pods->{$pod} eq "IAMAPOD";

			<div class="row flexrow">
				<span class="third padleftmuchmore semibold">
					Pod <% $pod %>
				</span>

				<span class='twothirds padleftmore padrightmuchmore'>
					<input
						type  = "text"
						name  = "<% $pod %>"
						value = "<% $pods->{$pod} %>"
					>
				</span>
			</div>
%		}

		<div class="liblrow rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Save Pod Labels"
				>
			</span>
		</div>

		</form>

	</div>

