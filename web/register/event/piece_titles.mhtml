<%args>
	$event_id
	$tourn
	$tourn_settings
	$only_category => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	$m->abort unless $event;

	my %event_settings = $event->all_settings;

	my @entries = Tab::Entry->search( 
		event  => $event->id,
		active => 1
	);

	#TITLE

	my @titles = $m->comp(
		"/funclib/event_entry_settings.mas", 
		event => $event,
		tag   => "title"
	);
		
	my %title_by_id = 
		map {$_->entry->id => $_->value} 
		@titles;

	my %title_timestamp = 
		map {$_->entry->id => $_->timestamp->set_time_zone($tourn->tz)} 
		@titles;

	#AUTHOR

	my @authors = $m->comp(
		"/funclib/event_entry_settings.mas", 
		event => $event,
		tag   => "author"
	) if $event_settings{"ask_for_authors"};

	my %author_by_id = 
		map {$_->entry->id => $_->value} 
		@authors
		if $event_settings{"ask_for_authors"};

	my %author_timestamp = 
		map {$_->entry->id => $_->timestamp->set_time_zone($tourn->tz)} 
		@authors
		if $event_settings{"ask_for_authors"};

	#ISBN

	my @isbns = $m->comp(
		"/funclib/event_entry_settings.mas", 
		event => $event,
		tag   => "isbn"
	) if $event_settings{"ask_for_isbns"};

	my %isbn_by_id = 
		map {$_->entry->id => $_->value} 
		@isbns
		if $event_settings{"ask_for_isbns"};

	my %isbn_timestamp = 
		map {$_->entry->id => $_->timestamp->set_time_zone($tourn->tz)} 
		@isbns
		if $event_settings{"ask_for_isbns"};

	my $no_codes++ if $event->setting("code_style") eq "names";

</%init>

	<& menu.mas, 
		tourn          => $tourn,
		event          => $event,
		only_category  => $only_category,
		tourn_settings => $tourn_settings,
		whoami         => "piece_titles"
	&>

	<div class="main">

		<div class="full nospace">

			<span class="threequarters">
				<h4><% $event->abbr %></h4>
			</span>

			<span class="quarter">
				<h5>Piece Titles</h5>
			</span>

		</div>

		<form 
			action = "piece_titles_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

		<& /funclib/tablesorter.mas, table => "entitled" &>

		<table id="entitled">

			<thead>

				<tr class="yellowrow smallish">

%					unless ($no_codes) { 
						<th >
							Code
						</th>
%					}

					<th >
						Entry Name
					</th>

					<th>
						Piece Title
					</th>

					<th>
						Last Change
					</th>

%					if ($event_settings{"ask_for_authors"}) { 

						<th>
							Author
						</th>

						<th>
							Last Change
						</th>
%					}

%					if ($event_settings{"ask_for_isbns"}) { 

						<th>
							ISBN/URL
						</th>

						<th>
							Last Change
						</th>
%					}

				</tr>

			</thead>

			<tbody>

%				foreach my $entry (@entries) { 

					<tr class="lightrow">

%						unless ($no_codes) { 
							<td>
								<a 
									class="white" 
									href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
								>
									<% $entry->code %>
								</a>
							</td>
%						}

						<td>
							<a 
								class = "white" 
								href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
							>
								<% $entry->name %>
							</a>
						</td>

						<td>
								
							<span class="hidden">
								<% $title_by_id{ $entry->id } %>
							</span>

							<textarea
								type  = "text"
								name  = "<% $entry->id %>_title"
								rows  = "2"
								cols  = "24"
							><% $title_by_id{ $entry->id } %></textarea>
						</td>

						<td class="centeralign smallish">
							<span class="hidden">
								<% $title_timestamp{$entry->id} 
									? $title_timestamp{$entry->id}->epoch 
									: "" 
								%>
							</span>

							<% $title_timestamp{$entry->id} ? 	
								Tab::niceshortdt($title_timestamp{$entry->id}) 
								: "" 
							%>
						</td>

%						if ($event_settings{"ask_for_authors"}) { 

							<td>

								<span class="hidden">
									<% $author_by_id{ $entry->id } %>
								</span>

								<input 
									type  = "text"
									name  = "<% $entry->id %>_author"
									size  = "24"
									value = "<% $author_by_id{ $entry->id } %>"
								>
							</td>

							<td class="centeralign smallish">
								<span class="hidden">
									<% 
										$author_timestamp{$entry->id} 
										? $author_timestamp{$entry->id}->epoch 
										: "" 
									%>
								</span>

								<% $author_timestamp{$entry->id} ? 
									Tab::niceshortdt($author_timestamp{$entry->id}) 
									: "" 
								%>
							</td>

%						}

%						if ($event_settings{"ask_for_isbns"}) { 

							<td>

								<span class="hidden">
									<% $isbn_by_id{ $entry->id } %>
								</span>

								<input 
									type  = "text"
									name  = "<% $entry->id %>_isbn"
									size  = "24"
									value = "<% $isbn_by_id{ $entry->id } %>"
								>
							</td>

							<td class="centeralign smallish">
								<span class="hidden">
									<% 
										$isbn_timestamp{$entry->id} 
										? $isbn_timestamp{$entry->id}->epoch 
										: "" 
									%>
								</span>

								<% $isbn_timestamp{$entry->id} ? 
									Tab::niceshortdt($isbn_timestamp{$entry->id}) 
									: "" 
								%>
							</td>

%						}

					</tr>
%				}

			</tbody>

			<tr class="liblrow">

				<td 
					colspan = "8"
					class   = "rightalign"
				>
					<input 
						type  = "submit"
						value = "Save Piece Titles"
					>


				</form>

				</td>

			</tr>

		</table>

	</div>

