<%args> 
	$tourn
	$diocese_id
	$account
</%args>
<%init>

	my $diocese = Tab::Region->retrieve($diocese_id);


</%init> 

	<div class="left huge">

<%perl>

	foreach my $group ($tourn->groups) { 

		my @classes = sort {$a->name cmp $b->name} $group->classes;

		my @judges = $m->comp("lib/covering_judges.mas", diocese => $diocese, group => $group);

		my @prelim_pools = $group->prelim_pools;

		my %judges_by_pool = ();

		my @poolless_judges;

		if (@prelim_pools) { 

			foreach my $judge (@judges) { 

				push (@poolless_judges, $judge) unless $judge->prelim_pool;
				next unless $judge->prelim_pool;

				push (@{$judges_by_pool{$judge->prelim_pool->id}}, $judge);

			}
	
		}

		my $pool_obligation;

		my @chapters = sort {$a->name cmp $b->name} $diocese->chapters;

		my @quals = $tourn->quals;

		my @elim_pools = $group->elim_pools;

		my $judge_burden = $m->comp("lib/judge_obligation.mas", diocese => $diocese, group => $group);

		my @events = sort {$a->name cmp $b->name} $tourn->events;

		my $switch;

</%perl>

		<h3>
			<% $group->abbr %>
		</h3>
	
		<center>
		<table cellpadding="4" cellspacing="1" width="98%">

%			if (@prelim_pools) { 

%				foreach my $pool (@prelim_pools) { 

%					my @pool_judges = @{$judges_by_pool{$pool->id}} if $judges_by_pool{$pool->id};

%					my $pool_burden = $m->comp("lib/prelim_pool_obligation.mas", diocese => $diocese, pool => $pool);

%					my $needed = $pool_burden - scalar @pool_judges;
%					$needed = 0 if $needed < 0;

%					$pool_obligation = "Short in ".$pool->name if $needed > 0; 
				
					<tr class="<% ($needed) ? "lirdrow" : "ligrnrow" %>">

						<td class="smaller" colspan="5" style="padding-top: 2px;">
							Judges in <% $pool->name %>  (<% $pool_burden %> owed) 
						</td>

						<td class="smaller" colspan="2" style="padding-top: 2px;" align="center">
							<% ($needed) ? $needed." more needed " : "Obligation met!" %>
						</td>
					</tr>

<%perl>
					foreach my $judge (@{$judges_by_pool{$pool->id}}) {

						$switch = print_judge($judge, $group,$switch);

					}

				}

				if (@poolless_judges) { 

</%perl>
					<tr class="lirdrow"> 

						<td class="smaller" colspan="5" style="padding-top: 2px;">
							Judges without prelim pools:
						</td>

						<td class="smaller" colspan="2" style="padding-top: 2px;" align="center">
						</td>
					</tr>

<%perl>

					foreach my $judge (@poolless_judges) { 

						$switch = print_judge($judge, $group,$switch);

					}

				}

			} else { 

				foreach my $judge (@judges) {

					$switch = print_judge($judge, $group,$switch);

				}

			}

</%perl>

			<tr class="<% ($judge_burden > scalar (@judges)) ? "lirdrow" : ($pool_obligation) ? "lirdrow" : "ligrnrow"%>">

				<td colspan="5" style="text-align: center;" class="smaller">
					<% $judge_burden %> total prelim judges owed,
					<% ($judge_burden - scalar (@judges) > 0) ? ($judge_burden - scalar (@judges))." more needed" 
						: ($pool_obligation) ? $pool_obligation : "Obligation met!" %>
				</td>


				<td class="smaller" align="center" colspan="7">
					<form action="/register/judge_edit.mhtml" method="post">
					<input type="hidden" name="group_id" value="<% $group->id %>">
					<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					<input type="submit" value=" Add <% ($group->tab_room) ? "Tabber" : $group->abbr." Judge" %>" >
					</form>
				</td>

			</tr>


		</table>

%		if (@elim_pools) { 

			<br />


			<table cellpadding="5" cellspacing="1" width="98%" border="0" style="margin-left: 5px;">
			

				<tr class="liblrow">

					<td>
						<form action="judge_elims_save.mhtml" method="post">
						<input type="hidden" name="group_id" value="<% $group->id %>">
						<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
						Elim Rounds:
					</td>

%					foreach my $pool (@elim_pools) { 

						<td align="center" class="smaller">
							<% substr($pool->abbr,0,1) %>
						</td>

%					}
					

				</tr>

%				foreach my $judge ($diocese->judges($tourn)) { 

%					next if $judge->elim_group && $judge->elim_group != $group->id;
%					next if $judge->judge_group->tab_room;
%					my @quals = $judge->quals;
%					next unless @quals;
%					next if $quals[0]->name eq "D";

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td class="smaller">
							<% $judge->first." ".$judge->last %>
							(<% $judge->judge_group->abbr %>)
						</td>

%						foreach my $pool (@elim_pools) { 
							<td align="center">
								<input type="checkbox" name="<% $judge->id %>_<% $pool->id %>" value="1" <% ($judge->in_pool($pool)) ? "checked" : "" %> >
							</td>
%						}

					</tr>
%				}


%				my ($total_owed, $style) = $m->comp("lib/pool_obligation.mas", diocese => $diocese, group => $group);


				<tr class="<% ($total_owed) ? "lirdrow" : "ligrnrow" %>">
				
					<td class="smaller">
						Elims Owed:
					</td>

%					if ($style eq "overall") { 
	
						<td colspan="6" align="right" class="smaller">
							<% ($total_owed) ? $total_owed." more elim round(s)" : "All set for elims!" %>
						</td>

%					} else { 

%						foreach my $pool (@elim_pools) { 

%							my ($owed, $ditch) = $m->comp("lib/pool_obligation.mas", diocese => $diocese, pool => $pool);

							<td align="center" class="smaller">
								<% ($owed) ? $owed." more " : "OK" %>
							</td>
%						}

%					}

				</tr>

				<tr class="liblrow">
					
						<td colspan="6" align="right" class="smaller">
						<input type="submit"  value="  Save Elim Assignments ">
						</form>
					</td>

				</tr>

			</table>


%		}

%	}

	</div> 

	<& sidebar.mas, tourn => $tourn, diocese => $diocese &>

%	sub print_judge { 

%		my ($judge, $group, $switch) = @_;

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td class="smaller">
					<% $switch %>.
				</td>

				<td class="smaller">
					<% $judge->first %>
				</td>

				<td class="smaller">
					<% $judge->last %>
				</td>

				<td class="smaller">
					<% $judge->school->name %>
				</td>

				<td class="smaller" align="center">
%					foreach my $qual ($judge->quals) { 
						<% $qual->name %>
%					}
				</td>

%				if ($judge && $judge->alt_group && $judge->alt_group->id == $group->id ) { 

					<td colspan="2" class="smaller" align="center">
						<a href="/user/diocese/judges_enter.mhtml?diocese_id=<% $judge->region->id %>&group_id=<% $judge->judge_group->id %>">
						From <% $judge->judge_group->name %>
						</a>
					</td>

%				} else { 

				<td class="smaller" align="center">
					<form action="/register/judge_edit.mhtml" method="post">
					<input type="hidden" name="judge_id" value="<% $judge->id %>">
					<input type="submit" value=" Edit " >
					</form>
				</td>

				<td class="smaller" align="center">
					<form action="judge_rm.mas" method="post">
					<input type="hidden" name="judge_id" value="<% $judge->id %>">
					<input type="submit" value=" Drop " class="red">
					</form>
				</td>

%			}

		</tr>

%		return $switch;

%	} 
