<%args> 
	$judge_id => undef
	$group_id => undef
	$diocese_id => undef
	$account
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	my $group = Tab::JudgeGroup->retrieve($group_id) unless $judge;
	$group = $judge->judge_group if $judge;

	my $diocese = Tab::Region->retrieve($diocese_id) unless $judge;
	$diocese = $judge->school->region if $judge;

	my @classes = sort {$a->name cmp $b->name} $group->classes;

	my @all = $diocese->judges_by_group($group);
	my $alt_count;

	foreach my $all (@all) { 

		next if $all->id == $judge_id;

		$alt_count += 1 if $all->alt_group;

	}

	my @pools = $group->prelim_pools;

	my $tourn = $group->tournament;

	my @chapters = sort {$a->name cmp $b->name} $diocese->chapters;

	my @quals = $tourn->quals;

	my $switch;

</%init>

	<div class="left huge">

		<table cellpadding="2" cellspacing="1" width="100%">
		
			<tr>
				<td width="100%">
					<h2><% ($judge) ? "Edit Judge " : "Add an ".$group->abbr." Judge " %> </h2>
				</td>

				<td>
					<form action="judges.mhtml" method="post">
					<input type="hidden" name="group_id" value="<% $group->id %>">
					<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					<input type="submit" class="grey" value=" Return to judges">
					</form>
				</td>

			</tr>

		</table>


		<table cellpadding="5" cellspacing="1" width="98%" border="0" style="margin-left: 10px;">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					First Name:
				</td>

				<td colspan="3">
					<form action="judge_save.mhtml">
					<input type="hidden" name="judge_id" value="<% $judge_id %>">
					<input type="hidden" name="group_id" value="<% $group->id %>">
					<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					<input type="text" name="first" value="<% ($judge && $judge->first) ?  $judge->first : "" %>" size="25">
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Last Name:
				</td>

				<td colspan="3">
					<input type="text" name="last" value="<% ($judge && $judge->last) ?  $judge->last : "" %>" size="25">
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Gender:
				</td>

				<td colspan="3" style="padding-left: 15px;">
					F <input type="radio" name="gender" value="F" <% ($judge && $judge->gender eq "F") ? "checked" : "" %>>
					M <input type="radio" name="gender" value="M" <% ($judge && $judge->gender eq "M") ? "checked" : "" %>>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					School:
				</td>

				<td colspan="3">
					<select name="chapter_id" style="font-size: 90%;">
%						foreach my $chapter (@chapters) { 
							<option value="<% $chapter->id %>" <% ($judge && $judge->school->chapter->id == $chapter->id) ? "selected" : "" %>>
								<% substr($chapter->name,0,30) %>
							</option>
%						}

					</select>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>	
					*Experience:
				</td>

				<td style="font-size: 80%;">

%					foreach my $class (@classes) {

%						my $set_qual = $judge->class_qual($class) if $judge;

						<% $class->name %>: <select name="<% $class->id %>" style="margin-right: 15px;"> 

%							foreach my $qual (sort {$a->name cmp $b->name} @quals) {

%								next if $qual->name eq "P" and $group->name ne "Congress"; 

								<option value="<% $qual->id %>" <% ($set_qual && $set_qual->id == $qual->id) ? "selected" : "" %>>
									<% $qual->name %>
								</option>

%  							}

						</select>

%					}

				</td>

			</tr>

%			if (@pools) { 

		        <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			        <td>
						Prelim Site:
					</td>

			        <td colspan="5">
						<select name="pool_id">

%       					foreach my $pool (@pools) { 
								<option value="<% $pool->id %>" 
									<%  ($judge) ?  ($judge->prelim_pool) ?  ($judge->prelim_pool->id == $pool->id ) ?  "selected" : "" : "" : "" %> >
									<% $pool->name %>
									<% ($pool->site) ? " at ".$pool->site->name : "" %>
								</option>
%							}

						</select>
					</td>

				</tr>

%			}

%			if ($group->ask_alts && ($alt_count < $group->alt_max || ($judge && $judge->alt_group ))) { 

				<tr class="liblrow">

					<td colspan="2" class="smaller">

						We cannot use every diocese's Congress judge to judge Congress. 
						Please designate which pool we should move this judge into if
						we are unable to use them in Congress.  You will get credit for
						one judge <b>both</b> in Congress and in the alternate pool.

					</td>

				</tr>

	        	<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>


					<td>
						Alternate Pool:
					</td>

					<td>

						<select name="alt_group">

%							foreach my $alt_group ($tourn->groups) { 

%								next if $group->id == $alt_group->id;

								<option value="<% $alt_group->id %>"   <% ($judge && $judge->alt_group->id == $alt_group->id) ? "selected" : "" %>>
									<% $alt_group->name %>
								</option>
%							}

						</select>
					</td>

				</tr>

%			}

	        <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Notes/Comments
				</td>

				<td>
					<input type="text" name="notes" value="<% ($judge && $judge->notes) ?  $judge->notes : "" %>" size="25">
				</td>

			</tr>

			<tr class="liblrow">

				<td colspan="2" align="right">
					<input type="submit" name="save" value="Save Judge" style="padding-left: 10px; padding-right: 10px;">
					</form>
				</td>

			</tr>



		    <tr>
				<td colspan="4">
					<h3>*Judge Experience Ratings:</h3>
				</td>
			</tr>

%   		foreach my $qual (sort {$a->name cmp $b->name} @quals) {

%       		next if $qual->name eq "P" and $group->name ne "Congress";

		        <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

        			<td>
						<% $qual->name %>:
					</td>
					
					<td colspan="3" style="font-size: 90%;">
						<% $qual->description %>
					</td>

				</tr>

%			}

		</table>

	</div>

	<& sidebar.mas, group => $group, tourn => $tourn, diocese => $diocese &>
