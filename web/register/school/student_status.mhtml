<%args>
	$tourn
	$tourn_settings
	$dbh
	$school
</%args>
<%init>

	my $students_sth = $dbh->prepare("

		select
			student.id, student.first, student.last,
			GROUP_CONCAT(event.abbr) events,
			COUNT(active.id) as active,
			COUNT(waitlisted.id) as waitlisted

		from (student, entry_student es, entry, school, event)

			left join entry active
				on active.school = school.id
				and active.active = 1
				and EXISTS (
					select es.id
					from entry_student es
					where es.entry = active.id
					and es.student = student.id
				)

			left join entry waitlisted
				on waitlisted.school = school.id
				and waitlisted.waitlist = 1
				and EXISTS (
					select es.id
					from entry_student es
					where es.entry = waitlisted.id
					and es.student = student.id
				)

			where 1=1
				and school.id = ?
				and school.id = entry.school
				and entry.id = es.entry
				and es.student = student.id
				and entry.dropped != 1
				and entry.unconfirmed != 1
				and entry.event = event.id

			GROUP BY student.id
			order by student.last, student.first
	");

	$students_sth->execute($school->id);
	my $students = $students_sth->fetchall_hash();

	my $school_status = $school->setting('student_form_confirm');

</%init>

	<& "/register/menubar.mas",
		school         => $school,
		whoami         => "student_status",
		tourn_settings => $tourn_settings,
		tourn          => $tourn
	&>

		<div class="flexrow">
			<span class="third">
				<h5>Students Confirmed</h5>
			</span>

			<span
				class = "twothirds rightalign padright"
				id    = "student_confirmations_buttonarea"
			>
			</span>
		</div>

		<& "/funclib/tablesorter.mas",
			table => "student_confirmations"
		&>

		<table id="student_confirmations">

			<thead>
				<tr class="yellowrow">
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Events
					</th>

					<th>
						Active Entries
					</th>

					<th>
						Waitlisted
					</th>

					<th>
						Confirmed?
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $student (@{$students}) {
					<tr>
						<td>
							<% $student->{first} %>
						</td>

						<td>
							<% $student->{last} %>
						</td>

						<td>
							<% $student->{events} %>
						</td>

						<td>
							<% $student->{active} %>
						</td>

						<td>
							<% $student->{waitlisted} %>
						</td>

						<td
							data-text="<% $school_status->{$student->{id}} ? "2" : "1" %>"
							class="centeralign nospace"
						>
							<& "/funclib/bool_switch.mas",
								tag        => "student_status",
								student_id => $student->{id},
								school_id  => $school->id,
								value      => $school_status->{$student->{id}},
								smaller    => 1,
								url        => "student_status_switch.mhtml"
							&>
						</td>
					</tr>
%				}
			</tbody>

		</table>
	</div>

	<div class="menu">
	</div>

