<%args> 
	$account
	$school_id
	$group_id => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $group = Tab::JudgeGroup->retrieve($group_id);

	$m->abort unless $school;

	my $tourn = $school->tourn;

	my @groups = $tourn->groups;

	if (scalar @groups == 1 && not defined $group) {
		$group = $groups[0];
		$group_id = $group->id;
	}
	
	my @events = $group->events if $group;

	my $switch;

	my @requests = Tab::JudgeHire->search( school => $school->id, judge_group => $group->id ) if $group_id;

	my $judge_per = $group->setting("judge_per") if $group;
	my $rounds_per = $group->setting("rounds_per") if $group;
	my $total_rounds;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<& /register/menubar.mas, school => $school, whoami => "judges", tourn => $tourn &>
    
%		if ($group) { 

%           my ($unc, $over) = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group);

%			if ($unc) { 

				<p class="dkred block smaller">

%					if ($group->setting("hired_fee") > 0) { 
					 	School still owes <% ceil ($unc / $judge_per) %> judges.
%					} elsif ($judge_per) { 
						School still has <% $unc %> entr<% ($unc == 1) ? "y" : "ies" %> uncovered.  
						Each judge covers <% $judge_per %> entries.
%					} elsif ($rounds_per) { 
						School still owes <% $unc %> round<% ($unc == 1) ? "" : "s" %>.
%					}

				</p>
%			}

%			if ($over && @requests) { 

				<p class="yellow block smaller">
%					if ($group->setting("hired_fee") > 0) { 
					 	School is over on judging by <% ceil ($over / $judge_per) %> judges.
%					} elsif ($judge_per) { 
						School is over on judging coverage by <% $over %> entr<% ($over == 1) ? "y" : "ies" %>.
%					} elsif ($rounds_per) { 
						School is over on judging by <% $over %> round<% ($over == 1) ? "" : "s" %> 
%					}

					Reduce hired judging below, or the school will still be charged for it!
				</p>
%			} 

			<h4><% $group->name %> Judges</h4>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="yellowrow">

					<% ($tourn->setting("hide_codes")|| $group->setting("no_codes")) ? "" : "<th>Code</th>" %>

					<th>
						Name
					</th>

%					if ($rounds_per) { 

						<th>
							Rounds
						</th>

%					}

%					if ($group->strike_times) { 
						<th>
							Availability 
						</th>
%					}

%					if ($group->setting("coach_ratings")) { 
						<th>
							Ratings
						</th>
%					}

					<th>
					</th>

				</tr>

%				foreach my $judge ($m->comp("/funclib/judgemath/judges_by_group.mas", school => $school, group => $group)) {

%					my $drop++ if $judge->dropped;

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<% ($tourn->setting("hide_codes")|| $group->setting("no_codes")) ? "" : $drop ? "<td>DROP</td>" : "<td>".$judge->code."</td>" %>

						<td>
							<a class="white block <% $drop ? "strike" : "" %>" 
								href="/register/judge/edit.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
								<% $judge->first." ".$judge->last%>
							</a>
						</td>

%						if ($rounds_per) { 

							<td>
								<form action="rounds_save.mhtml" method="post">
								<input type="hidden" name="judge_id" value="<% $judge->id%>">
								<input type="number" name="rounds" size="5" min="1" max="<% $group->setting("max_rounds") %>" value="<% $judge->obligation %>" onchange='this.form.submit()'>
								</form>
%								$total_rounds += $judge->obligation;
							</td>

%						}

%						if ($group->strike_times) { 

%							my $strike_timened;

							<td class="smaller">
								<a class="white block" href="judge_striketime.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">

%									foreach my $strike_time ($group->strike_times) { 
%										if ($strike_time->strike($judge)) { 
%											$strike_timened++;
											Not available <% $strike_time->name %> 
											<br />
%										}
%									}

%									unless ($strike_timened) { 
										<% $drop ? "None: Dropped" : "All rounds" %>
%									}
								
								</a>

							</td>
%						}

%						if ($group->setting("coach_ratings")) { 

							<td class="centeralign">
								<% $m->comp("/funclib/judge_rating.mas", print => 1, judge => $judge )%>
							</td>

%						}

%						my $warn = "This will delete the judge, together with any past results, ballots, or assignments. If you want to keep old records and just stop using this judge, mark the judge as inactive instead";

						<td class="centeralign">
							<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &> href="judge_drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
								DELETE
							</a>
						</td>

					</tr>

% 				} 

%				if ($rounds_per) { 
					
					<tr class="liblrow">

						<td class="padmore leftalign">
							Total Rounds
						</td>

						<td class="leftalign">
							<% $total_rounds %>
						</td>

						<td>
						</td>

					</tr>

%				}

			</table>

%			if ($group->setting("track_judge_hires") ) { 

				<br />

%				if ($group->setting("uncovered_entry_fee") > 0) { 

%					undef($switch);

					<h4>Hired Judging</h4>

					<table cellpadding="5" cellspacing="1" width="100%"> 

%						foreach my $request (@requests) { 
		            	
							<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

								<td class="smallish">
									Request made <% Tab::niceshortdt($request->request_made->set_time_zone($tz)) %>
								</td>
							
								<td class="centeralign smallish">
									<% $request->accepted ? $request->accepted : 0 %> accepted
								</td>
								
								<td class="centeralign smallish">
									<% $request->covers %> requested
								</td>

%								my $warn = "This will reduce your judging request by 1.  Are you sure?";

								<td class="centeralign smallish">
									<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &> href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
										REDUCE
									</a>
								</td>

%								$warn = "This will delete your judging request entirely. Are you sure?";

								<td class="centeralign smallish">
									<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &> href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
										DELETE
									</a>
								</td>
							
							</tr>

%						}


						<tr>
							<td colspan="10">
							</td>
						</tr>

						
						<tr class="liblrow">
							
							<td>
								<form action="hire_save.mhtml" method="post">
								<input type="hidden" name="school_id" value="<% $school->id %>">
								<input type="hidden" name="group_id" value="<% $group->id %>">
								New Request:
							</td> 

							<td class="centeralign" colspan="2">
								Cover
								<input type="text" name="hired_number" size="2" value="">
								entries
							</td>
							
							<td class="centeralign" colspan="2">
								<input class="thin" type="submit" value="   Request Hires   ">
								</form>
							</td>
							
						</tr> 


					</table>

					<p class="explain" style="padding-left: 10px;">
						This tournament hires judging by the entry, not the whole
						judge.  Enter hire requests for the number of entries who
						you do not have judging for.  Please note that a hire
						request does not mean the tournament has judges available
						for hire; Tabroom will email you when/if your request
						is accepted.
					</p>

%				}

%				if ($group->setting("hired_fee") > 0) { 

%					undef $switch;

%       			my $hires_requested;
%       			my $hires_accepted;

%					foreach my $request (@requests) { 
%	    	   			$hires_requested += $request->covers;
%   	    			$hires_accepted += $request->accepted;
%					}

%       			$hires_requested = ceil($hires_requested / $judge_per) if $judge_per;
%       			$hires_accepted = ceil($hires_accepted / $judge_per) if $judge_per;
	
					<h4>Hired judging</h4>

					<table cellpadding="4" cellspacing="1"  width="100%">

%					foreach my $request (@requests) { 
		            	
						<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

							<td class="smallish">
								Request made <% Tab::niceshortdt($request->request_made->set_time_zone($tz)) %>
							</td>
							
							<td class="centeralign smallish">
								<% $request->accepted ? ceil($request->accepted / $judge_per) : 0 %> accepted
							</td>
								
							<td class="centeralign smallish">
								<% ceil($request->covers / $judge_per ) %> requested
							</td>

%							my $warn = "This will reduce your judging request by 1.  Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>  
										href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									REDUCE
								</a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>  
									href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									DELETE
								</a>
							</td>
						
						</tr>

%					}


						<tr>
							<td colspan="10">
							</td>
						</tr>

		            	<tr class="liblrow">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="group_id" value="<% $group->id %>">
    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input type="text" name="hired_number" size="2" value=<% $hires_requested %>>
								hired judges
							</td>

                			<td class="rightalign" colspan="2">
                    			<input  type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

					</table>

%				}

%				if ($group->setting("round_hire_fee") > 0) { 

%					undef $switch;
%					my @requests = Tab::JudgeHire->search( school => $school->id, judge_group => $group->id );

%       			my $hires_requested;
%       			my $hires_accepted;

%					foreach my $request (@requests) { 
%	    	   			$hires_requested += $request->rounds;
%   	    			$hires_accepted += $request->rounds_accepted;
%						$total_rounds += $request->rounds_accepted;
%					}
	
					<h4>Hired judging</h4>

					<table cellpadding="4" cellspacing="1"  width="100%">

%					foreach my $request (@requests) { 
		            	
						<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

							<td class=" smallish">
								Request made <% Tab::niceshortdt($request->request_made->set_time_zone($tz)) %>
							</td>
							
							<td class="centeralign smallish">
								<% $request->rounds_accepted %> rounds accepted
							</td>
								
							<td class="centeralign smallish">
								<% $request->rounds %> rounds requested
							</td>

%							my $warn = "This will reduce your judging request by 1 round.  Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>  href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									REDUCE
								</a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred block" <& "/funclib/confirm.mas", warn => $warn &>  href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									DELETE
								</a>
							</td>
						
						</tr>

%					}


						<tr>
							<td colspan="10">
							</td>
						</tr>

		            	<tr class="liblrow">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="group_id" value="<% $group->id %>">
    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input type="text" name="rounds" size="2" value=""> rounds
							</td>

                			<td class="rightalign" colspan="2">
                    			<input  type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

					</table>

%				}

%			}

			<br />
			<br />

%		} else { 

			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}

%		if ($tourn->setting('judge_policy') > 0) { 
			<h4 style="margin-left: 5px;">Tournament Judging notes:</h4>
			<p style="padding: 5px;"><% $tourn->setting("judge_policy") %></p>
%		}

	</div>

	<& judge_menu.mas, tourn => $tourn, school => $school, whoami => "judges", group => $group &>

