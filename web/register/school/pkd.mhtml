<%args>
	$person
	$tourn
	$tourn_settings
	$school_id => undef
</%args>
<%init>

	use Tab::NSDA::MemberSchool;

	my $school = Tab::School->retrieve($school_id)
		if $school_id;

	unless ($school) {
		$m->redirect("/register/index.mhtml");
	}

	my $chapter = $school->chapter;

	my $now = DateTime->now();

	my @pkd_members = Tab::NSDA::MemberSchool->search(
		realm => "PKD",
	);

	@pkd_members =
		sort {$a->school_name cmp $b->school_name}
		@pkd_members;

	my %pkd_by_id = map {$_->school_id => $_} @pkd_members;

	my %student_memberships = $m->comp(
		'/funclib/school_student_settings.mas',
		school => $school,
		tag    => "nsda_paid"
	);

</%init>

	<&
		"/register/menubar.mas",
		school         => $school,
		whoami         => "pkd",
		tourn          => $tourn,
		tourn_settings => $tourn_settings
	&>

	<div class="full">
	<span class="fourfifths nospace">
		<h4 class="nospace">PKD Membership Information</h4>
	</span>

	<span class="fifth rightalign nospace bigger semibold">
		<% $pkd_by_id{$chapter->nsda} ?
			$pkd_by_id{$chapter->nsda}->school_paid_status > 0
				? "DUES PAID"
				: "DUES UNPAID"
			: "NOT A MEMBER"
		%>
	</span>

	</div>


	<form
		action = "pkd_join.mhtml"
		method = "post"
	>

		<input
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<div class="full even">

			<span class="sixth">
				PKD Chapter
			</span>

			<span class="quarter semibold redtext centeralign">
				<% $chapter->nsda
					? "Member #".$chapter->nsda
					: ""
				%>
			</span>

			<span class="fourtenths">

				<select
					name  = "pkd_id"
					class = "fixedbig"
				>
%				foreach my $pkd (@pkd_members) {
					<option
						value = "<% $pkd->id %>"
						<% $pkd->id == $chapter->nsda
							? 'selected="selected"'
						: ""
					%>><% $pkd->id %> <% $pkd->school_name %></option>
%				}

				</select>
			</span>

			<span class="sixth rightalign padno">
				<input
					type  = "submit"
					value = "Save"
					class = "smaller thin bigger"
				>
				</form>
			</span>

		</div>

			<h5>Roster of competitors:</h5>

			<div class="yellowrow smallish semibold nospace padvert">

				<span class="third nospace padleft">
					Entry
				</span>

				<span class="half nospace">
					<span class="fourfifths nospace">
						Competitor
					</span>
					<span class="fifth nospace">
						Member?
					</span>
				</span>

				<span class="sixth centeralign">
					On Waitlist?
				</span>
			</div>

%			foreach my $entry ($school->entries) {

				<div class="row">

					<span class="third nospace padleft">
						<a
							class="plain hover"
							href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
						><% $entry->code %></a>
					</span>

					<span class="half nospace">
%						foreach my $student ($entry->students) {

							<div class="full marno padless smallish">
								<span class="fourfifths nospace">
									<% $student->first." ".$student->last %>
								</span>

								<span class="fifth centeralign nospace">

%								if ($student_memberships{$student->id}) {
									<a class="fa fa-check greentext"></a>
%								} else {
									<a class="fa fa-times redtext"></a>
%								}
								</span>
							</div>
%						}
					</span>

					<span class="sixth centeralign">

%						if ($entry->dropped) {
							<span class="nospace">
								DROP
							</span>
%						} else {
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_waitlist"
									property_name = "waitlist"
									target_type   = "entry"
									target_id     = "<% $entry->id %>"
									onChange      = "postSwitch(this, '/register/entry/entry_switch.mhtml');"
									<% $entry->waitlist ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
%						}
					</span>

				</div>

%			}

	</form>

	</div>
