<%args>
	$tourn
	$person
	$person_settings
	$category
	$category_settings
	$school
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();
	use Data::Dumper;

	next unless $category_settings->{"nats_category"};

	my ($provided, $burden, $potential) = $m->comp(
		"/funclib/judgemath/nats_judging.mas",
		category => $category,
		school   => $school
	);

	my @jpools = $m->comp(
		"/funclib/category_jpools.mas",
		category => $category,
		limit	=> "registrant"
	);

	my %jpool_settings = $m->comp(
		"/funclib/jpool_settings.mas",
		category => $category
	);

	@jpools = sort {
		$jpool_settings{$a}{"hire"}
		<=> $jpool_settings{$b}{"hire"}
	} @jpools;

	my $last_hirable;

	foreach my $jpool (@jpools) {
		$last_hirable = $jpool->id
			unless $jpool_settings{$jpool->id}{"hire"};
	}

	my @judges = $m->comp(
		"/funclib/nationals_judges.mas",
		category => $category,
		school   => $school
	);

	my $judge_hire = Tab::JudgeHire->search(
		category => $category->id,
		school   => $school->id
	)->first;

</%init>

	<div class="martopmore borderbottom padbottom">

		<span class="threefifths nospace">
			<h5 class="nospace">
				Main Tournament
			</h5>
		</span>

		<span class="fifth rightalign semibold bigger">
			Rounds
		</span>

		<span
			class = "fifth rightalign"
			id	  = "obligation_<% $category->id %>_buttonarea"
		></span>

%		if ($provided->{'minimum_unmet'} &! $school->setting("no_judge_warnings")) {
			<div class="full borderredvert odd marno padless centeralign">
				<p class='redtext semibold bigger'>
					You must bring judge(s) with <% $category_settings->{"minimum_supplied"} %>
					rounds minimum.
				</p>
			</div>
%		}

		<&
			"/funclib/tablesorter.mas",
			table => "obligation_".$category->id
		&>

		<table id="obligation_<% $category->id %>">

			<thead>

				<tr class="yellowrow smallish">

					<th class="nosort">
					</th>

%					foreach my $jpool (@jpools) {
						<th
							title="<% $jpool_settings{$jpool->id}{"hire"} ? "" : "Not Hirable" %>"
							class="nosort <% $last_hirable == $jpool->id ? "borderright" :"" %>"
						>
							<% $jpool->name %><% $jpool_settings{$jpool->id}{"hire"} ? "" : "*" %>
						</th>
%					  }

					<th class="nosort">
						Total
					</th>

				</tr>

			</thead>

			<tbody>

				<tr class="bluetext semibold centeralign even">

					<td class="bluetext semibold">
						Needed
					</td>


%				   foreach my $jpool (@jpools) {
						<td
							class="<% $last_hirable == $jpool->id ? "borderright" :"" %>"
						>
							<% $burden->{$jpool->id} %>
						</td>
%				   }

					<td id="needed">
						<% $burden->{"total"} %>
					</td>

				</tr>

				<tr class="semibold centeralign even">

					<td class="bluetext semibold">
						Provided
					</td>

%				   foreach my $jpool (@jpools) {
						<td
							class="<% $last_hirable == $jpool->id ? "borderright" :"" %>"
						>
							<%
								$provided->{$jpool->id}
							%><%
								$potential->{$jpool->id}
								? '<span class="inline graytext">/'.$potential->{$jpool->id}.'</span>'
								: ""
							%>
						</td>
%				   }


					<td id="provided">
						<% $provided->{"total"} %>
					</td>

				</tr>

				<tr class="centeralign even">

					<td class="greentext semibold">
						Hired
					</td>


%				   foreach my $jpool (@jpools) {
						<td class="<% $last_hirable == $jpool->id ? "borderright" :"" %>">
						</td>
%					}

					<td
						class = "nospace"
						id	= "hire_total"
					>
						<span
							id	= "hired"
							class = "full greentext semibold replybucket marno"
						>
							<% $judge_hire ? $judge_hire->rounds_accepted() : "" %>
						</span>
					</td>

				</tr>

				<tr class="semibold centeralign even">

					<td class="redtext semibold">
						Still Owed
					</td>
<%perl>
					$provided->{"owed"}{"total"} -= $judge_hire->rounds_accepted()
						if $judge_hire;

					foreach my $jpool (@jpools) {
						my $owed = ($burden->{$jpool->id} - $provided->{$jpool->id});
						$owed = 0 if $owed < 0;

						$provided->{"owed"}{"total"} += $owed;

</%perl>

						<td class="
							<% $jpool_settings{$jpool->id}{"hire"} ? "" : "nohires"  %>
							<% $last_hirable == $jpool->id ? "borderright" :"" %>">
							<% $owed %>
						</td>
%					}

					<td
						class = "redtext"
						id    = "owed"
					>
						<% $burden->{"total"} - $provided->{"total"} %>
					</td>

				</tr>

			</tbody>

		</table>

		<div class="full bordertop odd marno martopmuchmore padless">

			<span class="half semibold">

				<div class="smallish semibold bluetext padless marno">
					Numbers in blue are rounds counted for this pool and not another.
				</div>

				<div class="smallish semibold graytext padless marno">
					Numbers in gray are potential rounds that could be judged by these judges.
				</div>
			</span>

			<span class="quarter rightalign semibold">
				<div class="full nospace">
					School can hire up to
					<span
						class = "inline"
						id    = "hire"
					><% $provided->{"hire"}{"total"} %></span>
					rounds.
				</div>
				<div class="full nospace padtopless">
					Rounds hired for:
				</div>
			</span>

			<span class="eighth centeralign">
				<input
					type  = "number"
					name  = "hires"
					id    = "hires"
					min   = 0
					value = "<% $judge_hire
						? $judge_hire->rounds_accepted
						: ""
					%>"
				>
			</span>

			<span class="eighth centeralign">
				<input
					value   = "Save Hires"
					type	= "submit"
					onClick = "postHires('<% $category->id %>', <% $provided->{'hire'}{'total'} %>);"
				>
			</span>

		</div>

		<div class="nospace martop">

			<span class="threefifths nospace">
				<h6 class="nospace">
					Main Tournament Judges
				</h6>
			</span>

			<span class="fifth rightalign semibold bigger">
			</span>

			<span
				class = "fifth rightalign"
				id	= "judges_<% $category->id %>_buttonarea"
			>
			</span>

		</div>

	<&
		"/funclib/tablesorter.mas",
		table => "judges_".$category->id
	&>

	<table id="judges_<% $category->id %>">

%		if (@judges) {

		<thead>

			<tr class="yellowrow smallish">

				<th>
					First
				</th>

				<th>
					Last
				</th>

				<th>
					Rounds
				</th>

				<th>
					Pools
				</th>

				<th>
					Status
				</th>

				<th>
					Edit
				</th>

				<th>
					Drop
				</th>

			</tr>

		</thead>

		<tbody>

%			foreach my $judge (@judges) {

				<tr>

					<td class="nospace padleft">
						<a
							class="white full padvert padleft"
							href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
						>
							<% $judge->first %>
						</a>
					</td>

					<td class="nospace padleft">
						<a
							class="white full padvert padleft"
							href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
						>
							<% $judge->last %>
						</a>
					</td>

					<td class="centeralign">
						<% $judge->obligation %>
					</td>

					<td>
						<% $judge->jpoolnames %>
					</td>

					<td class="centeralign">
						<% $judge->setting("incomplete")
							? '<span class="semibold redtext">INCOMPLETE</span>'
							: '<span class="semibold greentext">OK</span>'
						%>
					</td>

					<td class="centeralign nospace padvert">
						<a
							class="buttonwhite bluetext fa fa-edit fa-sm"
							href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
						></a>
					</td>

					<td class="centeralign nospace padvert">
						<a
							class="buttonwhite redtext fa fa-trash fa-sm"
							href="/register/judge/drop.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
						></a>
					</td>

				</tr>

%			}

			</tbody>

%		}

		<tr class="liblrow">

			<td colspan="42" class="rightalign">

				<a
					href  = "/register/judge/add.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
					class = "buttonwhite bluetext invert"
				>
					<span class="fa fa-lg fa-plus"></span>
					Add <% $category->abbr %> Judge
				</a>

			</td>

		</tr>

	</table>

	</div>

	<script>

        function totalOwed () {

            var needed = parseInt($('#needed').text()) || 0;
            var provided = parseInt($('#provided').text()) || 0;
            var hired = parseInt($('#hired').text()) || 0;

            if (hired < 0) {
                hired = 0;
            }

            var owed = parseInt(needed - provided - hired);
            var amtOwed = 0;

            $(".hirestill").each(function() {
                amtOwed += parseInt($(this).text()) || 0;
            });

            if (owed < amtOwed) {
                owed = amtOwed;
            }

            if (owed < 0) {
                owed = 0;
            }

            $("#owed").text(owed);
        }

		function countHires() {

			var maxRounds = parseInt($("#needed").text()) || 0;
			maxRounds -= parseInt($("#provided").text()) || 0;

			$(".nohires").each(function() {
				maxRounds -= parseInt($(this).text()) || 0;
			});

			if (maxRounds < 0) {
				maxRounds = 0;
			}

			$("#hire").text(maxRounds);

			return maxRounds;
		}

		$(document).ready(function() {
			countHires();
			totalOwed();
		});

		function postHires(categoryID) {

			var hireNumber = $("#hires").val();
			var maxRounds = countHires();

			if (hireNumber > maxRounds) {
//				I cannot wait until we're using node and I no longer have
//				to mix perl and javascript.

%				unless ($person->site_admin || $person_settings->{"nsda_admin"}) {
					hireNumber = maxRounds;
%				}
				alertify.notify("Warning: By rule school can only hire for "+maxRounds+" rounds", "warning");
			}

			$.ajax({

				type	: 'POST',
				url		: "judge_hires.mhtml",
				data	: {
					school_id   : "<% $school->id %>",
					category_id : categoryID,
					hires       : hireNumber,
					max         : maxRounds,
				},

				success : function(data) {

					if (data.reply) {
						$(".replybucket").text(data.reply);
						$(".replyappend").append(data.reply);
						totalOwed();
					}

					if (data.error) {

						alertify.error(data.message);

					} else if (data.message) {

						alertify.notify(data.message, "custom");

					} else {

						console.log(data);
						alertify.warning("An error condition was tripped.");
					}
				}

			});
		}

	</script>

