<%args>
	$tourn
	$person
	$person_settings
	$category
	$category_settings
	$school
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();
	use Data::Dumper;

	next unless $category_settings->{"nats_category"};

	my ($provided, $burden, $potential) = $m->comp(
		"/funclib/judgemath/nats_judging.mas",
		category => $category,
		school   => $school
	);

	my @jpools = $m->comp(
		"/funclib/category_jpools.mas",
		category => $category,
		limit	=> "registrant"
	);

	my %jpool_settings = $m->comp(
		"/funclib/jpool_settings.mas",
		category => $category
	);

	@jpools = sort {
		$jpool_settings{$a}{"hire"}
		<=> $jpool_settings{$b}{"hire"}
	} @jpools;

	my $last_hirable;

	foreach my $jpool (@jpools) {
		$last_hirable = $jpool->id
			unless $jpool_settings{$jpool->id}{"hire"};
	}

	my @judges = $m->comp(
		"/funclib/nationals_judges.mas",
		category => $category,
		school   => $school
	);

	my $judge_hire = Tab::JudgeHire->search(
		category => $category->id,
		school   => $school->id
	)->first;

</%init>

	<div class="martopmore padbottom">

		<div class="full nospace marbottom">
			<span class="quarter nospace">
				<h5 class="nospace">
					Main Tournament
				</h5>
			</span>

			<span class="threequarters rightalign explain biggish">
				Days
			</span>
		</div>


%		if ($provided->{'minimum_unmet'} &! $school->setting("no_judge_warnings")) {
			<div class="full borderredvert odd marno padless centeralign">
				<p class='redtext semibold bigger'>
					You must bring judge(s) with
					<% $category_settings->{"minimum_supplied"} %>
					days minimum.
				</p>
			</div>
%		}

		<& "/funclib/tablesorter.mas", table => "main_obligation", nobuttons => "aye" &>

		<table id="main_obligation">
			<thead>
				<tr class="yellowrow biggish">
					<th>
						Description
					</th>

					<th>
						Days
					</th>

					<th>
						Status
					</th>
				</tr>
			</thead>

%			my $counter = 1;

			<tbody>

				<tr>
					<td class="bigger semibold bluetext">
						<span class="spacer">
							<% $counter++ %>.
						</span>
						Total number of judging days school owes
					</td>

					<td class="centeralign padsetting semibold bluetext" id="needed">
						<% $burden->{"total"} %>
					</td>

					<td class="centeralign">
%						if ($burden->{"total"} - $provided->{"total"} > 0 ) {
							<span class="fa-lg fa greentext fa-check"></span>
%						} else {
							<span class="fa-lg fa redtext fa-times"></span>
%					}
					</td>
				</tr>

%				foreach my $jpool (@jpools) {
%					next if $jpool_settings{$jpool->id}{"hire"};
%					next unless $burden->{$jpool->id};

					<tr>
						<td class="bigger semibold bluetext">
							<span class="spacer">
								<% $counter++ %>.
							</span>
							Minimum days owed in <% $jpool->name %>. Not eligible for hires.
						</td>

						<td class="centeralign padsetting semibold bluetext">
							<% $burden->{$jpool->id} %>
						</td>

						<td class="centeralign">
%							if ($provided->{$jpool->id} >= $burden->{$jpool->id }) {
								<span class="fa-lg fa greentext fa-check"></span>
%							} else {
								<span class="fa-lg fa redtext fa-times"></span>
%							}
						</td>
					</tr>
%				}
			</tbody>
		</table>

		<div class="nospace martopmore padtopmore ltbordertop">

			<span class="twothirds nospace">
				<h6 class="nospace">
					School Judges
				</h6>
			</span>


			<span
				class = "third rightalign nospace"
			>
				<a
					href  = "/register/judge/add.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
					class = "buttonwhite bluetext invert"
				>
					<span class="fa fa-lg fa-plus invert"></span>
					Add Judge
				</a>
			</span>

		</div>

%		if (@judges) {

			<&
				"/funclib/tablesorter.mas",
				table     => "judges_".$category->id,
				nobuttons => 1
			&>

			<table id="judges_<% $category->id %>">

%			my $total;

			<thead>
				<tr class="yellowrow smallish">
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Days
					</th>

					<th>
						Pools
					</th>

					<th>
						Status
					</th>

					<th>
						Edit
					</th>

					<th>
						Drop
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $judge (@judges) {

					<tr>

						<td class="nospace padleft">
							<a
								class="white full padvert padleft"
								href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
							>
								<% $judge->first %>
							</a>
						</td>

						<td class="nospace padleft">
							<a
								class="white full padvert padleft"
								href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
							>
								<% $judge->last %>
							</a>
						</td>

						<td class="centeralign">
							<% $judge->obligation %>
						</td>

						<td>
							<% $judge->jpoolnames %>
						</td>

						<td class="centeralign">
							<% $judge->setting("incomplete")
								? '<span class="semibold redtext">INCOMPLETE</span>'
								: '<span class="semibold greentext">OK</span>'
							%>
						</td>

						<td class="centeralign nospace padvert">
							<a
								class="buttonwhite bluetext fa fa-edit fa-sm"
								href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
							></a>
						</td>

						<td class="centeralign nospace padvert">
							<a
								class="buttonwhite redtext fa fa-trash fa-sm"
								href="/register/judge/drop.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
							></a>
						</td>
					</tr>
%				}

				</tbody>
			</table>

			<div class="odd bluebordertop blueborderbottom padsetting">
				<span class="twothirds bigger semibold">
					Total Days provided by judges:
				</span>

				<span class="sixth centeralign bigger semibold bluetext" id="provided">
					<% $provided->{"total"} %>
				</span>
				<span class="sixth centeralign bigger semibold bluetext hidden" id="owed">
					<% $burden->{"total"} - $provided->{"total"} %>
				</span>
			</div>
%		}

		<div class="full nospace padtop martopmore">
			<span class="quarter nospace">
				<h6 class="nospace">
					Judging Buyouts
				</h6>
			</span>

			<span class="threequarters rightalign explain biggish">
				Buy-outs cannot cover CX, LD or PF. <br />
				Schools with main event entries must supply a minimum
				<% $category_settings->{"minimum_supplied"} %> days of judging.
			</span>
		</div>

		<div class="full bordertop odd marno martop padless">
			<span class="threetenths semibold biggish bluetext">
				Max days school can buy out for
			</span>
			<span class="tenth bigger semibold orangetext" id="hire">
				<% $provided->{"hire"}{"total"} %>
			</span>

			<span class="quarter rightalign semibold bigger bluetext">
				Days bought
			</span>

			<span class="sixth centeralign">
				<input
					type  = "number"
					name  = "hires"
					id    = "hires"
					min   = 0
					value = "<% $judge_hire
						? $judge_hire->rounds_accepted
						: ""
					%>"
				>
			</span>

			<span class="eighth centeralign">
				<input
					value   = "Save Buyouts"
					type	= "submit"
					onClick = "postHires('<% $category->id %>', <% $provided->{'hire'}{'total'} %>);"
				>
			</span>

			<span
				id  = "hired"
				class = "hidden"
			>
				<% $judge_hire ? $judge_hire->rounds_accepted() : "" %>
			</span>
		</div>
	</div>

	<script>

        function totalOwed () {

            var needed = parseInt($('#needed').text()) || 0;
            var provided = parseInt($('#provided').text()) || 0;
            var hired = parseInt($('#hired').text()) || 0;

            if (hired < 0) {
                hired = 0;
            }

            var owed = parseInt(needed - provided - hired);
            var amtOwed = 0;

            $(".hirestill").each(function() {
                amtOwed += parseInt($(this).text()) || 0;
            });

            if (owed < amtOwed) {
                owed = amtOwed;
            }

            if (owed < 0) {
                owed = 0;
            }

            $("#owed").text(owed);
        }

		function countHires() {

			var maxRounds = parseInt($("#needed").text()) || 0;
			maxRounds -= parseInt($("#provided").text()) || 0;

			$(".nohires").each(function() {
				maxRounds -= parseInt($(this).text()) || 0;
			});

			if (maxRounds < 0) {
				maxRounds = 0;
			}

			$("#hire").text(maxRounds);

			return maxRounds;
		}

		$(document).ready(function() {
			countHires();
			totalOwed();
		});

		function postHires(categoryID) {

			var hireNumber = $("#hires").val();
			var maxRounds = countHires();

			if (hireNumber > maxRounds) {
//				I cannot wait until we're using node and I no longer have
//				to mix perl and javascript.

%				unless ($person->site_admin || $person_settings->{"nsda_admin"}) {
					hireNumber = maxRounds;
%				}
				alertify.notify("Warning: You can only buy out for "+maxRounds+" total days", "warning");
			}

			$.ajax({

				type	: 'POST',
				url		: "judge_hires.mhtml",
				data	: {
					school_id   : "<% $school->id %>",
					category_id : categoryID,
					hires       : hireNumber,
					max         : maxRounds,
				},

				success : function(data) {

					if (data.reply) {
						$(".replybucket").text(data.reply);
						$(".replyappend").append(data.reply);
						totalOwed();
					}

					if (data.error) {

						alertify.error(data.message);

					} else if (data.message) {

						alertify.notify(data.message, "custom");

					} else {

						console.log(data);
						alertify.warning("An error condition was tripped.");
					}
				}

			});
		}

	</script>

