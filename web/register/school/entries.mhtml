<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$school_id => undef
	$event_id  => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $school = Tab::School->retrieve($school_id);
	$m->abort unless $school;

	my $now = DateTime->now();

	my %entry_settings = $m->comp(
		"/funclib/school_entry_settings.mas",
		school => $school
	);

	my @entries;
	my %supps;
	my %forms;

	if ($tourn_settings->{"nsda_nats"}) {

		@entries = $school->entries();

		my @supps = $m->comp('/funclib/nationals_events.mas',
			tourn  => $tourn,
			type   => 'supp',
			status => "all"
		);

		my @conns = $m->comp('/funclib/nationals_events.mas',
			tourn  => $tourn,
			type   => 'conn',
			status => "all"
		);

		foreach my $supp (@supps, @conns) {
			$supps{$supp->id}++;
		}

		%forms = eval {
	        return %{JSON::decode_json($school->setting("release_forms"))};
 		};

	} else {
		@entries = $school->entries(
			unconfirmed => 0
		);
	}

	push @entries, $m->comp(
		"/funclib/school_hybrids.mas",
		school => $school
	);

	my %seen;
	@entries = grep { ! $seen{$_->id} ++ } @entries;

	my %types;
	my %events;
	my %event_settings;

	my $quals;

	foreach my $entry (@entries) {

		my $event;

		$event = $events{$entry->event->id};

		unless ($event) {
			$event = $entry->event;
			$events{$event->id} = $event;
			$quals++ if $event->setting('ask_quals');
		}

		$types{$entry->event->type}++;

	}



	my $skip;

	$skip++ if $person->site_admin;

	$skip++ if $person_settings->{"nsda_admin"};

	unless ($event_id) {
		my @events = $tourn->events;
		my $event = shift @events;
		$event_id = $event->id if $event;
	}

	my @rejects;

    my %reasons;

    %reasons = $m->comp(
        "/funclib/judgemath/nats_check_judging.mas",
        school => $school
    ) if $tourn_settings->{"nsda_nats"};


</%init>

	<& "/register/menubar.mas",
		school          => $school,
		whoami          => "students",
		tourn           => $tourn,
		tourn_settings  => $tourn_settings,
		person          => $person,
		person_settings => $person_settings,
    	reasons         => \%reasons,
	&>

		<script>

			function dropSwitch(checkObject) {

				var dropStatus = $("#"+checkObject.id).prop("checked");
				var entryId = $("#"+checkObject.id).attr("target_id");

				if (dropStatus) {

					$("."+entryId+"_dropped").prop("checked", true);
					$("#delete_"+entryId).removeClass("hidden");
					$("#row_"+entryId).addClass("strike");

				} else {

					$("."+entryId+"_dropped").prop("checked", false);
					$("#delete_"+entryId).addClass("hidden");
					$("#row_"+entryId).removeClass("strike");
				}

			}

			function showType(targetType) {

				$(".type_button").removeClass("invert");
				$(".type_row").addClass("hidden");

				if (targetType === "all") {

					$("#all_button").addClass('invert');
					$(".type_row").removeClass("hidden");

				} else {

					$("#"+targetType+"_button").addClass('invert');
					$("."+targetType+"_row").removeClass("hidden");

				}

				$('table').trigger('applyWidgets');

			}

		</script>

%		if (@entries) {

			<div class="full nospace martopmore">

			<span class="third">
				<h4>Competitors</h4>
			</span>

			<span
				id	= "entries_buttonarea"
				class = "twothirds rightalign"
			>

%				if ( (scalar (keys %types)) > 1)  {

					<a
						id	  = "all_button"
						class   = "buttonwhite greentext invert smallish type_button"
						onClick = "showType('all');"
					>
						All
					</a>

%					foreach my $type (sort keys %types) {

						<a
							id	  = "<% $type %>_button"
							class   = "buttonwhite bluetext smallish hover type_button"
							onClick = "showType('<% $type %>');"
						>
							<% ucfirst($type) %>
						</a>

%					}

%				}
			</span>

		</div>

		<& "/funclib/tablesorter.mas", table => 'entries' &>

		<table id="entries">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Event
					</th>

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						Name
					</th>

%					if ($quals) {
						<th class="smaller">
							Qualifiers
						</th>
%					}

					<th class="smaller">
						Registered
					</th>

					<th class="smaller">
						Notes
					</th>

%					if ($tourn_settings->{"nsda_nats"}) {

						<th class="smaller">
							Status
						</th>

						<th class="smaller">
							Comp
						</th>

						<th class="smaller">
							Drop
						</th>

%					} else {

						<th class="smaller">
							Drop
						</th>
<%perl>
					}

					if (
						$tourn_settings->{"fine_deadline"}
						&& $tourn_settings->{"fine_deadline"} < $now
						&& $tourn_settings->{"drop_fine"}
					) {
</%perl>
						<th class="smaller">
							Drop &amp; Fine
						</th>
%					}

%					unless ($tourn_settings->{nsda_nats}) {
						<th class="smaller">
						</th>
%					}

				</tr>

			</thead>

			<tbody>

<%perl>

			my %used;

			ENTRY:
			foreach my $entry (@entries) {

				if ($tourn_settings->{"nsda_nats"}) {
					if ($entry_settings{$entry->id}{"rejected_by"}) {
						push @rejects, $entry;
						next ENTRY;
					}
				}

				my $event = $events{$entry->event->id};

				my $no_codes++ if $event->setting("code_style") eq "names";

				next if $used{$entry->id};
				$used{$entry->id}++;


</%perl>
				<tr id	= "row_<% $entry->id %>"
					class = "smallish
					<% $entry->dropped ? "strike" : "" %>
					<% $event->type %>_row type_row"
				>

					<td class="smallish">
						<% $event->abbr %>
					</td>

					<td class="smallish nospace <% $entry->dropped ? "centeralign" : "" %>">
%						unless ($no_codes) {
							<a
								class = "leftalign button white padtop padbottom"
								href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
								<% $entry->code %>
							</a>
%						}
					</td>

					<td class="<% ($entry->dropped) ? "strike" : "" %> smallish nospace" >
						<a
							class="white padtop padbottom"
							href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
						>
							<% $entry->name %>
						</a>
					</td>

%					if ($quals) {

						<td class="smallish">

%							my $notfirst;
%							foreach my $qual ($entry->qualifiers) {

								<% ($notfirst++) ? "<br />" : "" %>
								<% $qual->name %>
								<% ($qual->result) ? "(".$qual->result.")" : "" %>

%							}

%							if ($entry_settings{$entry->id}{"registered_seed"} eq "atlarge") {
								<% ($notfirst) ? "<br />" : "" %>
								*At Large Applicant*
%							}

						</td>
%					}

					<td class="smallish nospace">
%						my $created = $entry->created_at;
						<span class="hidden"><% $created ? $created->epoch : "" %></span>

						<span class="twofifths padno">
							<& "/funclib/showdate.mas",
								dt     => $created,
								length => "shortest",
								tz     => $tz
							&>
						</span>
						<span class="threefifths padno">
							<& "/funclib/showtime.mas",
								dt     => $created,
								tz     => $tz,
								length => "shorter",
							&>
						</span>

					</td>

					<td class="smallish">

%						if ($entry->othername) {
							<% $entry->othername %> Hybrid
%						}

						<% ($entry->waitlist) ? "On Waitlist" : "" %>

						<% ($entry->dq) ? "DISQUALIFIED" : "" %>

						<% $entry->dropped ? "Drop:" : "" %>

						<& "/funclib/showdate.mas",
							dt     => $entry_settings{$entry->id}{"dropped_at"},
							length => "shortest",
							tz     => $tz
						&>
						<& "/funclib/showtime.mas",
							dt => $entry_settings{$entry->id}{"dropped_at"},
							tz => $tz
						&>

%						if ($entry_settings{$entry->id}{"title"}) {
							<div class="smaller">
								<% $entry_settings{$entry->id}{"title"} %>
							</div>
%						}

%						if ($entry_settings{$entry->id}{"author"}) {
							<div class="smaller">
								<% $entry_settings{$entry->id}{"author"} %>
							</div>
%						}

					</td>

%					if ($tourn_settings->{"nsda_nats"}) {

						<td class="nospace centeralign semibold nospace">
%							if ($supps{$entry->event->id}) {
								<span class="purpletext full">
									SUPP/CONN
								</span>
%							} elsif ($entry->unconfirmed) {
								<span class="graytext full">
									PENDING
								</span>
%							} elsif ($entry->setting("rejected_by")) {
								<span class="redtext full">
									REJECTED
								</span>
%							} elsif ($entry->active) {
								<span class="greentext full">
									ACCEPTED
								</span>
%							}
						</td>

						<td class="centeralign">
%							if ($entry_settings{$entry}{"status"} eq "complete") {
								<span class="fa fa-sm greentext fa-check"></span>
%							} else {
								<span class="fa fa-sm redtext fa-times"></span>
%							}
						</td>

%					}

					<td class="nospace centeralign padless">
						<span class="hidden"><% $entry->dropped %></span>
						<label class="switch smaller">
							<input
								type          = "checkbox"
								class         = "<% $entry->id %>_dropped"
								value         = "1"
								id            = "<% $entry->id %>_dropped"
								property_name = "dropped"
								target_type   = "entry"
								target_id     = "<% $entry->id %>"
								onChange      = "postSwitch( this, 'entry_switch.mhtml'); dropSwitch(this);"

								<% $entry->dropped ? 'checked="checked"' : "" %>
							>
							<div class="onred slider"></div>
						</label>
					</td>

<%perl>
					if (
						$tourn_settings->{"fine_deadline"}
						&& $tourn_settings->{"fine_deadline"} < $now
						&& $tourn_settings->{"drop_fine"}
					) {
</%perl>
						<td class="nospace centeralign padless">

							<label class="switch smaller">
								<input
									type          = "checkbox"
									class         = "<% $entry->id %>_dropped"
									value         = "1"
									id            = "<% $entry->id %>_dropped_fine"
									property_name = "dropped"
									setting_name  = "apply_fine"
									target_type   = "entry"
									target_id     = "<% $entry->id %>"
									onChange      = "postSwitch( this, 'entry_switch.mhtml'); dropSwitch(this);"
									<% $entry->dropped ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>

						</td>
%					}

%					unless ($tourn_settings->{nsda_nats}) {
						<td class="padless centeralign">
							<span
								id="delete_<% $entry->id %>"
								class="full nospace <% $entry->dropped ? "" : "hidden" %>"
							>
%								my $warn = "This will delete all record of ".$entry->code.". Are you sure?";
								<a
									class = "buttonwhite redtext fa fa-trash fa-sm padless"
									title = "Delete Entry Entirely.  No fees or judge obligation"
									href  = "/register/entry/delete.mhtml?entry_id=<% $entry->id %>"
									 <& "/funclib/confirm.mas", warn => $warn &>
								>
								</a>
							</span>
						</td>
%					}
				</tr>
%   		}

			</tbody>

		</table>
%		}

<%perl>

		if ($tourn_settings->{"nsda_nats"}) {

			my @hybrids = $m->comp(
				"/funclib/chapter_hybrids.mas",
				school => $school
			);

			if (@hybrids) {
</%perl>

				<span class="fourfifths">
					<h5>District Wide Entries</h5>
				</span>

				<span
					class = "fifth rightalign"
					id	= "hybrids_buttonarea"
				>
				</span>

				<& "/funclib/tablesorter.mas", table => 'hybrids' &>

				<table id="hybrids">

					<thead>
						<tr class="yellowrow semibold smaller">

							<th>
								Event
							</th>

							<th>
								Entry Code
							</th>

							<th>
								Students
							</th>

							<th>
								Actions
							</th>

						</tr>
					</thead>

					<tbody>

%						foreach my $entry (@hybrids) {

							<tr>

								<td>
									<% $entry->eventabbr %>
								</td>

								<td class="nospace">
									<a
										class = "leftalign button white padtop padbottom"
										href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
										<% $entry->code %>
									</a>
								</td>

								<td>
									<% $entry->studentnames %>
								</td>

								<td class="centeralign">
									<a
										class = "buttonwhite fa fa-sm fa-edit bluetext"
										href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
									></a>
								</td>

							</tr>
%						}
					</tbody>
				</table>

%			}

%			if (@rejects) {

				<span class="fourfifths">
					<h5>Rejected Entries</h5>
				</span>

				<span
					class = "fifth rightalign"
					id	= "rejected_buttonarea"
				>
				</span>

				<& "/funclib/tablesorter.mas", table => 'rejected' &>

				<table id="rejected">

					<thead>
						<tr class="yellowrow semibold">

							<th>
								Event
							</th>

							<th>
								Entry
							</th>

							<th>
								Rejected By
							</th>

							<th>
								Rejected At
							</th>

						</tr>
					</thead>

					<tbody>

<%perl>
						foreach my $entry (@rejects) {

							my $person = Tab::Person->retrieve($entry_settings{$entry->id}{"rejected_by"});


							my $date = eval {
								return Tab::shortdate(
									DateTime::Format::MySQL->parse_datetime(
										$entry_settings{$entry->id}{"rejected_at"}
									)
								);
							};
</%perl>

							<tr>

								<td>
									<% $entry->event->abbr %>
								</td>

								<td>
									<a
										class = "leftalign button white padtop padbottom"
										href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
										<% $entry->name %>
									</a>
								</td>

								<td title="<% $person ? $person->email : "" %>">
									<% $person ? $person->first." ".$person->last : "" %>
								</td>

								<td>
									<% $date %>
								</td>

							</tr>
%						}
					</tbody>

				</table>

%			}

%		}

	</div>

	<& "menu.mas",
		tourn           => $tourn,
		tourn_settings  => $tourn_settings,
		person          => $person,
		person_settings => $person_settings,
		school          => $school,
		event_id        => $event_id,
		skip_district   => $skip
	&>

