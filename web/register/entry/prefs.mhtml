<%args> 
	$tourn
	$tourn_settings
	$entry_id => undef
	$style    => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);

	unless ($entry) { 
		$m->print("No such entry");
		$m->abort;
	}

	my $school = $entry->school if $entry;

	my $diocese = $m->comp(
		"/school_region.mas",
		school => $school
	) if $tourn_settings->{"ncfl"};

	my $category = $entry->event->category;

	my @all_judges;

	if ($category->setting("pref_jpool")) { 
		my $jpool = Tab::JPool->retrieve($category->setting("pref_jpool"));
		@all_judges = $m->comp("/funclib/jpool_judges.mas", jpool => $jpool);
	} else { 
		@all_judges = $category->judges( active => 1 );
	}

	Tab::Strike->columns(TEMP => qw/judge_id/);
	Tab::Strike->columns(TEMP => qw/event_name/);

	Tab::Strike->set_sql( strikes => "
		select judge.id as judge_id, event.name as event_name
		from judge, strike, event
		where strike.judge     = judge.id
		and strike.type      = 'event'
		and event.id         = strike.event
		and event.category   = ? 
	");

	my @strikes = Tab::Strike->search_strikes($category->id);

	my %judge_event_strike;

	foreach my $strike(@strikes) {
		$judge_event_strike{$strike->judge_id} = $strike->event_name;
	}

 	my @panels = $m->comp('/funclib/entry_panels.mas', entry => $entry);

	my %used;
	my $switch = 1;

	my $prefs = $category->setting("prefs");

	my $ndt++ if $prefs eq "ndt";
	$prefs = "ordinals" if $prefs eq "ndt" && $style ne "elims";
	$prefs = "caps" if $prefs eq "ndt" && $style eq "elims";

	my %judge_pref; 
	my %judge_percentile; 

	if ($prefs eq "ordinals") { 
	
		my @ratings = Tab::Rating->search_where({   
			entry   => $entry->id,
			ordinal => {">", "0"} 
		});

		%judge_pref = map {$_->judge->id => $_->ordinal} @ratings;

		%judge_percentile = map {$_->judge->id => $_->percentile} @ratings;

	}  elsif ($prefs eq "tiered" || $prefs eq "tiered_round" || $prefs eq "caps") { 

		my @ratings = Tab::Rating->search_where({ 
			entry => $entry->id, 
			rating_tier => {">", "0"}  
		});

		my %tier_name = ();

		foreach my $tier ($category->rating_tiers) { 
			$tier_name{$tier->id} = $tier->name;
		}

		%judge_pref = map {$_->judge->id => $tier_name{$_->rating_tier}} @ratings;

	}

	my %judge_conflict;

	foreach my $conflict ($m->comp(
		"/funclib/judge_entry_rating.mas", 
			entry => $entry,
			type  => "conflicted")) {
		$judge_conflict{$conflict->id}++;
	}

	my @school_conflicts = $m->comp(
		"/funclib/school_conflicts.mas", 
			school   => $entry->school,
			category => $category);

	my %school_conflict = map {$_->judge->id => 1} @school_conflicts;
	
</%init>

   	<& "/register/menubar.mas",
			school         => $school,
			whoami         => "students",
			tourn          => $tourn,
			tourn_settings => $tourn_settings &>

	<div>

		<span class="threefifths">
			<h4><% $entry->name %> Prefs</h4>
		</span>

		<span class="fifth">
			<h5 class="rightalign">
				<% scalar @all_judges %> judges
			</h5>
		</span>

		<span class="fifth rightalign nospace">
			<a 
				class="fa fa-lg fa-file-pdf-o buttonwhite redtext"
				href="prefs_print.mhtml?entry_id=<% $entry->id %>&style=<% $style %>"
			>
			</a>

			<a 
				class="fa fa-lg fa-file-excel-o buttonwhite greentext"
				href="prefs_export.mhtml?entry_id=<% $entry->id %>&style=<% $style %>"
			>
			</a>

		</span>

	</div>

	<p class="explain padno">
		Note: Quotas are not enforced on this screen.  You can
		feel free to blow your own foot off if you so choose.
	</p>

	<& "/funclib/tablesorter.mas", table => "sortme", nobuttons => 1 &>

		<form action="prefs_save.mhtml" method="post">
		<input 
			type    = "hidden"
			name    = "entry_id"
			value   = "<% $entry->id %>"
		>
		<input 
			type  = "hidden"
			name  = "style"
			value = "<% $style %>"
		>

		<table id="sortme">

			<thead>

				<tr class="yellowrow">

					<th>
					</th>

					<th class="smallish">
						Judge Last
					</th>

					<th class="smallish">
						Judge First
					</th>

					<th class="centeralign smallish">
						Rounds
					</th>

					<th class="centeralign smallish">
						Conflict
					</th>

					<th class="centeralign smallish">
						Rating
					</th>

%					if ($prefs eq "ordinals") { 
						<th class="centeralign smallish">
							%ile
						</th>
%					}

				</tr>

			</thead>

			<tbody>

%			foreach my $judge (@all_judges) { 

				<tr>

					<td>
						<% $switch++ %>
					</td>

					<td>
						<% $judge->last %>
					</td>

					<td>
						<% $judge->first %>
					</td>

					<td class="centeralign">
						<% $judge->obligation + $judge->hired %>
					</td>

%					if ($judge->school->id == $entry->school->id) { 

						<td class="centeralign">
							X
						</td>

						<td class="centeralign semibold redtext padvert">
							<span class="padvert">
								Own Judge
							</span>
						</td>

%						if ($prefs eq "ordinals") { 
							<td>
							</td>
%						}

%					} elsif ($school_conflict{$judge->id}) { 

						<td>
						</td>

						<td class="centeralign">
							School
						</td>

						<td class="centeralign">
							Conflict
						</td>

%					} else { 

						<td class="centeralign">
							<span class="hiddencsv"><% $judge_conflict{$judge->id} %></span>

							<input 
								type     = "checkbox"
								class    = "notfirst"
								tabindex = "-1"
								name     = "conflict_<% $judge->id %>"
								value    = "1"
								<% $judge_conflict{$judge->id} ? 'checked="checked"' : "" %> 
							>
						</td>

						<td class="centeralign">

							<span class="hiddencsv">
								<% $judge_pref{$judge->id} %>
							</span>

							<input 
								type           = "text"
								size           = "5"
								name           = "<% $judge->id %>"
								value          = "<% $judge_pref{$judge->id} %>"
								autocomplete   = "off"
								autocorrect    = "off"
								autocapitalize = "off"
								spellcheck     = "false"
							>
						</td>

%						if ($prefs eq "ordinals") { 
							<td class="centeralign">
								<% sprintf "%.2f", $judge_percentile{$judge->id} %>
							</td>
%						} 
%					} 

				</tr>

%			}

			</tbody>

			<tr class="liblrow">
				<td colspan="9" class="rightalign">
					<input type="submit" value=" Save Prefs ">
					</form>
				</tr>
			</tr>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Return</h4>
			
			<a class="yellow full" 
				href="edit.mhtml?entry_id=<% $entry_id %>">
				Return to <% $entry->code %>
			</a>

			<a class="yellow full" 
				href="/register/reports/prefs.mhtml">
				Return to Prefs Report
			</a>

			<br />


%			if ($ndt) { 
				<a 
					class="<% $style eq "elims" ? "" : "dk" %>blue full" 
					href="prefs.mhtml?entry_id=<% $entry->id %>">

					Prelim Pref Sheet
				</a>

				<a 
					class="<% $style eq "elims" ? "dk" : "" %>blue full" 
					href="prefs.mhtml?entry_id=<% $entry->id %>&style=elims"
				>
					Elim Pref Sheet
				</a>
%			}

		</div>

		<div class="sidenote">

			<h4>Your Other Prefs</h4>

<%perl>

			foreach my $other (Tab::Entry->search( 
					event  => $entry->event->id,
					school => $entry->school->id,
					active => 1
				)
			) { 
</%perl>

%				next if $other->id == $entry->id;
			
				<a 
					class="nowrap blue full" 
					href="prefs.mhtml?entry_id=<% $other->id %>"
				>
					<% $other->name %> (<% $other->code %>)
				</a>
%			}

			<h4>Clone Prefs</h4>
			
			<p>Copy <% $entry->code %>'s prefs to:</p>

			<div class="row full">

				<form action="clone.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "clone_id"
					value = "<% $entry->id %>"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $entry->school->id %>"
				>

				<span class="threequarters">

					<select 
						name  = "entry_id"
						class = "fixedsmall"
					>

<%perl>
						undef %used;

						foreach my $other ($m->comp(
							"/funclib/school_entry_by_category.mas", 
								category => $entry->event->category,
								school   => $school
							)
						) {

							next if $used{$other->id}++;
							next if $entry->id == $other->id;
							next if $entry->dropped;
</%perl>
							<option value="<% $other->id %>"><% $other->name %></option>
%					   }   

						<optgroup label="Other Schools">

%						foreach my $other ($entry->event->entries( active => 1)) { 

%							next if $used{$other->id}++;

							<option value="<% $other->id %>"><% $other->name %></option>

%						}

					</select>
				</span>

				<span class="quarter">
					<input 
						type  = "submit"
						value = "Go"
						class = "thin"
					>
				</span>

				</form>
			</div>

		</div>

	</div>


