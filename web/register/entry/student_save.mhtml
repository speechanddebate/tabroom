<%args>
	$tourn
	$account
	$first
	$last
	$chapter_id => undef
	$event_id => undef
	$phonetic => undef
	$grad_year => undef
	$student_id => undef
	$novice => 0
	$retired => 0
	$gender => undef
</%args>
<%init>

	unless ($student_id) { 
	
		my $chapter = Tab::Chapter->retrieve($chapter_id);
		my @schools = Tab::School->search( tournament => $tourn->id, chapter => $chapter_id);
		my $school = shift @schools;

		unless ($school) { 
			my $err = "That school is not entered in your tournament";
			$m->redirect("/register/index.mhtml?err=$err");
		}

		my $student = Tab::Student->create({ 
			first => $first,
			last => $last,
			phonetic => $phonetic,
			grad_year => $grad_year,
			chapter => $chapter,
			novice => $novice,
			retired => $retired,
			gender => $gender
		});

		my $msg = "Student $first $last saved in ". $school->name;

		if ($event_id) { 
			$m->redirect("/register/school/entry_add.mhtml?school_id=".$school->id."&event_id=$event_id&msg=$msg");
		} else {
			$m->redirect("/register/school/entries.mhtml?school_id=".$school->id."&msg=$msg");
		}
		
	}  else  {

		my $student = Tab::Student->retrieve($student_id); 
		my $chapter = $student->chapter;
		my @schools = Tab::School->search( tourn => $tourn->id, chapter => $chapter->id);
		my $school = shift @schools;

		if ($student->first ne $first || $student->last ne $last) { 

			my $text = $student->first." ".$student->last." name changed to $first $last.";
			
    	    my $change = Tab::TournChange->create({ 
    	        tourn => $tourn->id,
				school => $school->id,
	            type => "registration",
	            text => $text,
				account => $account->id
	        });

		}
		
		$student->first($first);
		$student->last($last);
		$student->phonetic($phonetic);
		$student->grad_year($grad_year); 
		$student->novice($novice);
		$student->retired($retired);
		$student->gender($gender);
		$student->update;


	  	foreach my $entry ($m->comp("/funclib/student_entries.mas", student => $student, tourn => $tourn)) { 

            my $name;
            my $last_names;

            my $notfirst;

            foreach my $student ($entry->students) { 
                $name = $student->first." ".$student->last;
                $last_names .= " & " if $notfirst;
                $last_names .= $student->last;
                $notfirst++;
            }

            if ($notfirst > 1) { 
                $entry->name($last_names);
            } else { 
                $entry->name($name);
            }

            $entry->update;

        }

		my $msg = "Changes saved to student $first $last.  Entries renamed in this tournament to follow suit.";
		$m->redirect("/register/entry/student_edit.mhtml?msg=$msg&student_id=$student_id");
	
	}

</%init>

