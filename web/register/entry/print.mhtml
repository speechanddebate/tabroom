<%args>
	$circuit
	$tourn
	$session
	$entry_id
	$debug => undef
</%args>

<%init>

	my $entry = Tab::Entry->retrieve($entry_id);

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);

	my $name = $entry->code."-".$entry->name;
	$name =~ s/[\W_]//g; 
	
	my $filename = "Entry-".$name."-".$session->id;
	my $filepath = $Tab::file_root."tmp/".$filename;
	`rm -f $filepath.*`;

	$m->comp("/funclib/printout.mas", filename => $filename, head => 1);

	my $now =  DateTime->now;
	$now->set_time_zone($tourn->tz);

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\begin{flushright}\n";
	print TEXOUT "\\Huge\n";
	print TEXOUT "{\\bf ".Tab::texify($m->comp("/funclib/entry_name.mas", entry => $entry))." (".$entry->code.")} \\\\ \n ";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\end{flushright}\n \\begin{center}";

	print TEXOUT "\\begin{tabular}{p{.75in}p{2.25in}p{.75in}p{2.25in}} \n  ";
	print TEXOUT "\\hline\n  ";
	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\n";
	print TEXOUT "{\\bf Event:} & ".Tab::texify($entry->event->name)." & \n ";
	print TEXOUT "{\\bf Tournament:} & ".Tab::texify($tourn->name)." \\\\ \n ";
	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\n";

	my $congress;

	print TEXOUT "{\\bf School:} & ".  $entry->school->name if $entry->school;
	print TEXOUT " (".$entry->school->code.") & " unless $tourn->setting("ncfl");
	print TEXOUT " (".$entry->school->region->code.") & " if $tourn->setting("ncfl");

	print TEXOUT "{\\bf Code:} & ".$entry->code." \\\\ \n";
	print TEXOUT "\\hline \\\\ \n  ";
	print TEXOUT "\\end{tabular} \n  ";

	my @panels = $m->comp("/funclib/entry_panels.mas", entry => $entry);

	if ($tourn->setting("ncfl")) { 

	    my $saturday_site = $panels[0]->round->site if @panels && scalar $m->comp("/funclib/tourn_sites.mas", tourn => $tourn) > 1;
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\begin{tabular}{p{2.5in}p{4in}} \n  ";
	    print TEXOUT "Prelim rounds Saturday at: & \\bf ".$saturday_site->name if $saturday_site;
		print TEXOUT "Prelim rounds Saturday at: & \\bf ".$entry->event->class->judge_group->special if not defined $saturday_site;
		print TEXOUT "\\\\ \n";
		print TEXOUT "Elim Rounds Sunday at: & \\bf ".$entry->event->class->judge_group->elim_special;
		print TEXOUT "\\end{tabular} \n  ";
		print TEXOUT "\\newline \n";
	}

	print TEXOUT "\\begin{tabular}{p{.75in}p{1.0in}p{.75in}p{1.5in}p{1.75in}} \n";
	print TEXOUT "\\multicolumn{5}{l}{\\large Speaker ".$entry->code." in ".$entry->event->name.": } \\\\ \\hline \n" if @panels;

	my $switch;

	foreach my $panel (@panels) {

		my $start = $panel->round->timeslot->start;
		$start->set_time_zone($tourn->tz); 
		 
		$congress++ if $panel->round->event->type eq "congress"; 

		if ($panel->round->type eq "prelim") {

			print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\n" unless $switch++ % 2;

		} else { 
		
			print TEXOUT "\\rowcolor[rgb]{1,.94,.94}\n";
			
		}
		 
		print TEXOUT "{\\bf ".$panel->round->realname." }";
		print TEXOUT " & ";
		print TEXOUT $start->day_abbr." "  if scalar @days > 1;
		print TEXOUT $start->hour_12.":".$start->strftime("%M")." ";
		print TEXOUT $start->strftime("%p");
		print TEXOUT " & ";
		print TEXOUT "Section: ".$panel->letter." & ";
		print TEXOUT "Room: ".Tab::texify($panel->room->name)." " if $panel->room;
		print TEXOUT " & ";
		print TEXOUT "Judges: "; 

		foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {
			 print TEXOUT Tab::texify($judge->code)." ";
		}

		print TEXOUT "\\\\ \n";
	}	

	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\end{center}\n";
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$m->comp("/funclib/printout.mas", filename => $filename, tail => 1);

</%init>

