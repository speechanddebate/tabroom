<%args>
	$tourn
	$comp_id => undef
	$err => undef
	$code => undef
	$circuit
</%args>
<%init>

	my $comp;

	if ($comp_id) { 
		$comp = Tab::Comp->retrieve($comp_id);
	}
	
	if ($code) { 
	
		my @comps = Tab::Comp->search( code => $code, tournament => $tourn->id );

		$err = "No competitors found with speaker code $code" unless @comps;
		$m->redirect("$Tab::url_prefix/register/entry/edit.mhtml?err=$err") unless @comps;

		$m->redirect("$Tab::url_prefix/register/choose_comp.mhtml?code=$code") if scalar @comps > 1;

		$comp = $comps[0];
		$comp_id = $comp->id;	
	}
	
</%init>

% 	if ($comp) {
    	
		<& menubar.mas, school => $comp->school, whoami => "students", tourn => $tourn &>

	<div class="left huge">

		<h3>Entry in <% $comp->event->name %></h3>

		<table cellpadding="3" width="100%" cellspacing="1">

%		my $switch;

%		unless ($comp->event->no_codes) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Speaker Code
				</th>

				<td>
					<a class="whiteblock">
						<% $comp->code %>
					</a>
				</a>
				</td>

			</tr>

%		}

% 		if ($comp->event->team == 1)  {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Name:
				</th>

				<td>
					<a class="whiteblock" href="/register/student_edit.mhtml?student_id=<%$comp->student->id%>&comp_id=<% $comp->id %>">
						<% $comp->student->first." ".$comp->student->last %>
					</a>
				</td>

			</tr>

%		}

% 	if ($comp->event->team == 2)  {

%		my $count = 1;
%		foreach my $student ($comp->members) { 


			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Student <%$count%>:
				</th>

				<td> 
					<a class="whiteblock" href="/register/student_edit.mhtml?student_id=<%$student->id%>&comp_id=<% $comp->id %>">
					<% $student->first." ".$student->last %>
					</a>
				</td>

			</tr>

% 			$count++;

% 		} 

%	}

% 	if ($comp->event->team == 3)  {


		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
			<th>
				Team:
			</th>
			
			<td>
				<form action="team_name.mas" method="post">
				<input type="hidden" name="comp_id" value="<% $comp->id%>">
				<input type="text" name="name" value="<% $comp->name %>">
			</td>
			
			<td>
				<input  type="submit" value="Save">
				</form>
			</td>
			
		</tr>

%		foreach my $student ($comp->members) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td></td>

				<td>
					<a href="/register/student_edit.mhtml?student_id=<% $student->id %>"><% $student->first." ".$student->last %></a>
				</td>
				
				<td>
					(<a href="/register/team_member_rm.mhtml?comp_id=<% $comp->id%>&student_id=<% $student->id %>">Remove</a>)
				</td>
			</tr> 
%		}

%	}


%	if ($comp->event->ask_for_titles) {

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Piece Title:
			</th>

			<td>
				<% $comp->title %>
			</td>

		</tr>

%	}

%	if ($tourn->method->ask_qualifying_tournament) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
			<th>
				Qualified at:
			</th>
				
			<td>
				<% $comp->qualifier %>
			</td>

		</tr>

% 	}

% 	if ($circuit->diocese_based) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Diocese:
			</th>

			<td colspan="2">
				<a class="whiteblock" href="/register/diocese/entry.mhtml?diocese_id=<% $comp->school->region->id %>">
					<% $comp->school->region->name ." (".$comp->school->region->code .")" %>
				</a>
			</td>

		</tr>

% 	}

% 		if ($comp->ada) { 
			<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%		}

			<th>
				ADA Accomodations:
			</th>

			<td>
				<a class="whiteblock" href="/register/ada_switch.mhtml?comp_id=<% $comp->id %>"><% ($comp->ada) ? "Yes" : "No" %></a>
			</td>
	
		</tr>

% 	if ($tourn->method->ask_qualifying_tournament) {

		</table>

		<h4>Qualifying Information:</h4>

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Qualifier:
				</th>

				<td colspan="2">
					<form action="qual_save.mhtml" method="post">
					<input type="hidden" name="comp_id" value="<% $comp->id %>">
					<input type="name" name="qual" value="<% $comp->qualifier %>">
				</td>
			</tr> 
			
			<tr class="liblrow">
				<td colspan="3" align="right">
					<input type="submit"  value="    Save Qualifiers    "> 
					</form> 
				</td>
			</tr>
% 	}


% 	if ($tourn->method->ask_two_quals) {

		</table>

			<h4>
				Qualifying Information:
			</h4>


			<table cellpadding="5" width="100%" cellspacing="1">
		
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th>
						1st Qual:
					</th>
					
					<td colspan="2">
						<form action="qual_save.mhtml" method="post">
						<input type="hidden" name="comp_id" value="<% $comp->id %>"> 
						<input type="name" size="30" name="qualifier" value="<% $comp->qualifier %>">
					</td>

				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						How Qualified:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qualexp" value="<% $comp->qualexp %>">
					</td>
					
				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd Qual:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2" value="<% $comp->qual2 %>">
					</td>
				</tr> 
				
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd How:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2exp" value="<% $comp->qual2exp %>">
					</td>
				</tr> 
				
				<tr class="liblrow">
					<td colspan="3" align="right">
						<input type="submit"  value="    Save Qualifiers    ">
						</form>
					</td>
				</tr>

% 	}

	</table>

<br>

%   if ($tourn->method->housing) {

<%perl>

    my $start = $tourn->start;
    my $end = $tourn->end;

    $start->set_time_zone($circuit->timezone);
    $end->set_time_zone($circuit->timezone);
    $end->truncate(to   => 'day');
    $start->truncate(to => 'day');

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

</%perl>

<h4>Housing</h4>

	<form action="housing_save.mhtml" method="post">
    <input type="hidden" name="comp_id" value="<% $comp->id %>">

	<table width="100%" cellpadding="5" cellspacing="1">
    
%	foreach my $student ($comp->members) { 

    <tr class="liblrow">

	    <td><% $student->first." ".$student->last %></td>

		<td align="center">Gender:</td>

	    <td align="center">
  	   		M
			<input 	type="radio" 
					name="gender_<%$student->id%>" 
					value="M" <% ($student->gender eq "M") ? "checked" : "" %> i
			>
		    F
			<input 	type="radio" 
					name="gender_<%$student->id%>" 
					value="F" <% ($student->gender eq "F") ? "checked" : "" %> 
			>
		</td>

	</tr>

%	foreach my $day (@days) { 

%		next unless Tab::HousingSlots->search( night => $day );

%		my $housing = $student->housing($tourn, $day);

		<tr>
			<th><% $day->day_name." ".$day->month."/".$day->day %></th>

			<td align="center">Request:
				<input 	type="checkbox" 
					name="request_<% $student->id."_".$day->ymd %>" 
					value="1" <% ($housing) ? "checked" : "" %> >
			</td>
   		
			<td align="center">Waitlisted:
				<input 	type="checkbox" 
					name="waitlist_<% $student->id."_".$day->ymd %>" 
					value="1" <% ($housing && $housing->waitlist) ? "checked" : "" %> >
			</td>
	    </tr>
%   }

%}

    <tr>
		<td colspan="4" align="right">
        	<input  type="submit" value="Save Housing Details">
    	</td>
	</tr>

    </form>
</table>

%	} # end of if housing.


%	unless ($comp->event->type eq "debate") { 

		<h3>Panel Assignments:</h3>

%  		my @rounds = sort { $a->name <=> $b->name } $comp->event->rounds;

		<table cellpadding="5" width="100%" cellspacing="1"> 

			<tr class="liblrow">
	
				<td class="smaller">
					Rnd
				</td>
		
				<td class="smaller">
					Start
				</td>
		
				<td class="smaller">
					Speaks
				</td>
		
				<td class="smaller">
					Sect/Room
				</td>
		
				<td class="smaller">
					Judges
				</td>
		
				<td class="smaller">
					Ranks
				</td>
		
				<td class="smaller">
				</td>
		
			</tr>
		
% 			foreach my $round (@rounds) { 

%				my $panel = $comp->panel_in_round($round);

%				if ($panel) {
		
%					my @ballots = Tab::Ballot->search( comp => $comp_id, panel => $panel->id); 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td>
							<% $round->name %>
						</td>


						<td class="smaller">
							<% &Tab::nicetime($panel->round->timeslot->start->set_time_zone($circuit->timezone)) %>
						</td>

						<td class="smaller">
		                    <% Lingua::EN::Numbers::Ordinate::ordinate($comp->speakerorder($panel)) %> 
						</td>
	
						<td class="smaller">
							<a class="whiteblock" href="<%$Tab::url_prefix%>/panel/panel_view.mhtml?panel_id=<% $panel->id %>"><% $panel->letter %>:
							<% ($panel->room) ? $panel->room->name : "" %>
							</a>
						</td>

						<td class="smaller">

							<a class="whiteblock" href="<%$Tab::url_prefix%>/panel/panel_view.mhtml?panel_id=<% $panel->id %>">
%		 						foreach my $judge ($panel->judges) { 	
									<% $judge->code %>
% 								}	
							</a>

						</td>

						<td class="smaller" align="center">
							<a class="whiteblock" href="/tabbing/panel_card.mhtml?panel_id=<% $panel->id %>">
% 								foreach my $ballot (@ballots) { 
%									if ($ballot->judge) { 
										<% $ballot->real_rank %>
										<% ($ballot->tv) ? " TV " : "" %>
%									}
% 								}
							</a>

						</td> 
						
						<td class="smaller" align="center">
							<a class="whiteblock" href="/panel/entry/edit.mhtml?comp_id=<% $comp->id %>&round_id=<% $round->id %>">Move</a>
						</td>

					</tr>
	
% 				} else { 
							
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td>
							<% $round->name %>
						</td>
						
						<td colspan="8">
							<a class="whiteblock" href="/panel/entry/edit.mhtml?comp_id=<% $comp->id %>&round_id=<% $round->id %>">
								Not scheduled in <% ($round->label) ? $round->label : "Round ".$round->name %>. Click to add manually.
							</a>
						</td>
					</tr>
% 				}

% 			}

		</table>

% 	}

%	$switch = 1;

	</div>

	<div class="right small">
	
		<table cellpadding="7" width="100%" cellspacing="1" border="0">

% 			if ($comp->dq == 1) { 

				<tr class="redrow">
				
					<td class="warning" colspan="3" align="center">
						DISQUALIFIED 
					</td>
						
				</tr>

%			} 

% 			if ($comp->dropped) { 

				<tr class="redrow">

					<td class="warning" colspan="4" align="center">

						DROPPED 

%						if ($comp->dropped_at) { 
							on <% &Tab::niceshortdt($comp->dropped_at->set_time_zone($circuit->timezone)) %>
%						}
					</td>

				</tr>

%			} 

% 			if ($comp->waitlist) { 

				<tr class="redrow">
					<td class="warning" colspan="4" align="center">
						WAITLISTED
					</td>
				</tr>
%			} 

		</table>

		<hr>

		<a class="blue block" href="comp_print.mhtml?comp_id=<% $comp->id %>">Print Assignment Sheet</a>
		<a class="blue block" href="comp_card_print.mhtml?comp_id=<% $comp->id %>">Print Assignment Card</a>

%		foreach my $student ($comp->members) { 

			<a class="blue block" href="student_print.mhtml?student_id=<% $student->id %>">
				Print <% $student->first." ".$student->last %> Dance Card
			</a>
%		}


		<hr>

%		if ($comp->dropped) { 

			<a class="red block" href="comp_undrop.mas?comp_id=<% $comp->id %>">Un-Drop</a>
			<a class="red block" href="comp_rm.mas?comp_id=<% $comp->id %>">Completely Delete</a>

%		} else { 

			<a class="red block" href="comp_drop.mas?comp_id=<% $comp->id %>">Drop</a>
%		}

% 		if ($comp->event->waitlist) { 

%			if ($comp->waitlist) { 
			
				<a class="red block" href="comp_unwaitlist.mas?comp_id=<% $comp->id %>">Admit off waitlist</a>
			
%			} else { 

				<a class="red block" href="comp_waitlist.mas?comp_id=<% $comp->id %>">Place on waitlist</a>

%			}

%		}

%		if ($comp->dq) { 

			<a class="red block" href="comp_undq.mas?comp_id=<% $comp->id %>">Un-Disqualify</a>
			
%		} else { 

			<a class="red block" href="comp_dq.mas?comp_id=<% $comp->id %>">DISQUALIFY</a>
			<a class="red block" href="dq_selectively.mhtml?comp_id=<% $comp->id %>">DISQUALIFY SOME ROUNDS</a>
%		}

		<hr>

			<a class="red block" href="/tabbing/comp_card.mhtml?comp_id=<% $comp->id %>">View/Change Results Card</a>

		</hr>

		<h3>Changes:</h3>

		<table cellpadding="3" cellspacing="1" width="100%">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
				<th class="smaller">
					Code
				</th>

				<td align="right">
					<form action="comp_change.mhtml" method="post">
					<input type="hidden" name="comp_id" value="<% $comp_id %>">
					<input type="hidden" name="school_id" value="<% $comp->school->id %>">
					<input type="text" size="6" name="code" value="<% $comp->code %>">
				</td>
				
			</tr> 


<%perl>
			 my @students = $m->comp("/funclib/students_evententer.mas",
			 			circuit => $circuit,
						tourn => $tourn,
						event => $comp->event,
						chapter => $comp->school->chapter
			);

			my @comp_students = $comp->members;

</%perl>

%			my $count = 1;

%			foreach my $student (@comp_students) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
					<th class="smaller">
						Entry <% $count++ %>
					</th>
			
					<td> 
				
						<select name="<% $student->id %>">

    						<option value="<%	$student->id %>">
								<% substr($student->last.", ".$student->first,0,20) %>
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @students) {

% 		  						next if $other_student->id == $comp->student->id;
% 		  						next if $comp->partner && $other_student->id == $comp->partner->id;
	
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,20) %>
								</option>

%							}

						</select> 
					</td> 
				
				</tr>

%			} 

%			if ($comp->event->team == 2 && $count < 3) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
					<th class="smaller">
						Entry <% $count++ %>:
					</th>
			
					<td> 
				
						<select name="partner">

    						<option value="">
								PLEASE CHOOSE STUDENT
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @students) {

% 		  						next if $other_student->id == $comp->student->id;
% 		  						next if $comp->partner && $other_student->id == $comp->partner->id;
	
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,40) %>
								</option>

%							}

						</select> 
					</td> 
				
				</tr>

%			}

			<tr class="liblrow">

				<td colspan="2" align="right">
					<input type="submit" value="  Save Changes  ">
					</form>
				</td>

			</tr>


%			if ($circuit->diocese_based) { 


				<tr>
					<td colspan="2">
						<h4>Change School</h4>
						<form action="comp_school.mhtml" method="post">
						<input type="hidden" name="comp_id" value="<% $comp->id %>">
					</td>
				</tr>

				<tr class="evenrow">

					<td colspan="2">
						<select name="school_id">

%						foreach my $school (sort {$a->name cmp $b->name} $comp->school->region->schools(tournament => $tourn->id) ) { 
%							next if $school->id == $comp->school->id;
							<option value="<% $school->id %>">
								<% substr($school->name,0,32) %>
							</option>
%						}

					</td>

				</tr>

				<tr class="liblrow">

					<td align="right" colspan="2">
						<input type="submit" value=" Save School ">
						</form>
					</td>

				</tr>


%			}

		</table>

% 	} # end of if $comp 

	</div>

	<br style="clear: both;" />
