<%args>
	$tourn
	$entry_id
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);
	my $event = $entry->event;
	my @students = $m->comp("/funclib/entry_students.mas", entry => $entry);

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	
</%init>

	<& /funclib/editable.mas, class => "code", dest => "code_change.mhtml" &>
	<& /funclib/editable.mas, class => "name", dest => "name_change.mhtml" &>
	
	<& /register/menubar.mas, school => $entry->school, whoami => "students", tourn => $tourn &>

	<h3>Entry in <% $event->name %></h3>

	<table cellpadding="3" width="100%" cellspacing="1">

%		my $switch;
%		my $code_setting = $event->setting("code_style");

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Name
			</th>

			<td>
				<span class="normal block edit name white" style="display: inline-block;" id="<% $entry->id %>"><% $entry->name %></span>
			</td>

		</tr>

%		unless ($event->setting("no_codes")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Code
				</th>

				<td>
					<span class="normal block white edit code" style="display: inline-block;" id="<% $entry->id %>"><% $entry->code %></span>
				</td>

			</tr>

%		}

%		my %entry_students = ();

% 		foreach my $student (@students) { 

%			my $hybrid_school;

%			if ($student->chapter && $student->chapter->id != $entry->school->chapter->id) { 
%				$hybrid_school = Tab::School->search( tourn => $tourn->id, chapter => $student->chapter->id)->first;
%			}

%			$entry_students{$student->id}++;

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Student
				</th>

				<td>
					<a class="normal white inline" href="student_edit.mhtml?student_id=<%$student->id%>&entry_id=<% $entry->id %>">
						<% $student->first." ".$student->last %>
					</a>

%					if ($hybrid_school) { 
						<a class="right white inline" href="/register/school/entries.mhtml?school_id=<%$hybrid_school->id%>&event_id=<% $event->id %>">
						(Hybrid from: <% $hybrid_school->name %>)
						</a>
%					}

				</td>

			</tr>

%		}


%		if ($event->setting("ask_for_titles")) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Piece Title
				</th>
	
				<td>
					<% $entry->title %>
				</td>

			</tr>

%		}

%		if ($tourn->setting("ask_qualifying_tournament")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
				<th>
					Qualified at:
				</th>
				
				<td>
					<% $entry->qualifier %>
				</td>

			</tr>

% 		}

% 	if ($tourn->setting("diocese_based")) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Diocese:
			</th>

			<td colspan="2">
				<a class="white normal block" href="/register/diocese/entry.mhtml?diocese_id=<% $entry->school->region->id %>">
					<% $entry->school->region->name ." (".$entry->school->region->code .")" %>
				</a>
			</td>

		</tr>

% 	}

% 		if ($entry->ada) { 
			<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%		}

			<th>
				ADA Accomodations:
			</th>

			<td>
				<a class="white normal block" href="ada_switch.mhtml?entry_id=<% $entry->id %>"><% ($entry->ada) ? "Yes" : "No" %></a>
			</td>
	
		</tr>

% 	if ($tourn->setting("ask_qualifying_tournament")) {

		</table>

		<h4>Qualifying Information:</h4>

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Qualifier:
				</th>

				<td colspan="2">
					<form action="qual_save.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry->id %>">
					<input type="name" name="qual" value="<% $entry->qualifier %>">
				</td>
			</tr> 
			
			<tr class="liblrow">
				<td colspan="3" align="right">
					<input type="submit"  value="    Save Qualifiers    "> 
					</form> 
				</td>
			</tr>
% 	}


% 	if ($tourn->setting("ask_two_quals")) {

		</table>

			<h4>
				Qualifying Information:
			</h4>


			<table cellpadding="5" width="100%" cellspacing="1">
		
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th>
						1st Qual:
					</th>
					
					<td colspan="2">
						<form action="qual_save.mhtml" method="post">
						<input type="hidden" name="entry_id" value="<% $entry->id %>"> 
						<input type="name" size="30" name="qualifier" value="<% $entry->qualifier %>">
					</td>

				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						How Qualified:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qualexp" value="<% $entry->qualexp %>">
					</td>
					
				</tr> 
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd Qual:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2" value="<% $entry->qual2 %>">
					</td>
				</tr> 
				
				
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
				
					<th>
						2nd How:
					</th>
					
					<td colspan="2">
						<input type="name" size="30" name="qual2exp" value="<% $entry->qual2exp %>">
					</td>
				</tr> 
				
				<tr class="liblrow">
					<td colspan="3" align="right">
						<input type="submit"  value="    Save Qualifiers    ">
						</form>
					</td>
				</tr>

% 	}

	</table>

%   if ($tourn->setting("housing")) {

<%perl>

		my $start = $tourn->start;
		my $end = $tourn->end;

		$start->set_time_zone($tz);
		$end->set_time_zone($tz);
		$end->truncate(to   => 'day');
		$start->truncate(to => 'day');

		my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
		my $day_before = $days[0]->clone;
		$day_before->subtract( days => 1);
		push (@days, $day_before);

</%perl>

		<h4>Housing</h4>

		<form action="housing_save.mhtml" method="post">
		<input type="hidden" name="entry_id" value="<% $entry->id %>">

%		foreach my $student (@students) { 

			<div class="half left" style="margin-left: 5px;">
		
			<table width="100%" cellpadding="3" cellspacing="1">

				<tr class="yellowrow">

					<td class="nowrap">
						<% $student->first." ".$student->last %>
					</td> 
					
					<td colspan="2" class="centeralign">
						Gender

						M <input type="radio" name="gender_<%$student->id%>" value="M" <% ($student->gender eq "M") ? "checked" : "" %> >
						F <input type="radio" name="gender_<%$student->id%>" value="F" <% ($student->gender eq "F") ? "checked" : "" %> >
					</td> 
					
				</tr>

%				undef ($switch);

%				foreach my $day (@days) { 

%					next unless Tab::HousingSlots->search( night => $day );
%					my $housing = $m->comp("/funclib/student_housing.mas", student => $student, tourn => $tourn, day=> $day);

					<tr <% ($switch++ % 2) ? "class=\"lteven\"" : "class=\"ltodd\"" %>>	

						<td class="rightalign">
							<% Tab::niceshortdayte($day) %>
						</td>

						<td align="center">

							<label for="request_<% $student->id."_".$day->ymd %>">	
								Req:
							</label>

							<input 	type="checkbox" name="request_<% $student->id."_".$day->ymd %>" 
								id="request_<% $student->id."_".$day->ymd %>" value="1" <% ($housing) ? "checked" : "" %> >

						</td>	

						<td align="center">
							<label for="waitlist_<% $student->id."_".$day->ymd %>">	
								Waitlist
							</label>

							<input 	type="checkbox" name="waitlist_<% $student->id."_".$day->ymd %>" 
								id="waitlist_<% $student->id."_".$day->ymd %>" value="1" 
								<% ($housing && $housing->waitlist) ? "checked" : "" %> >

						</td>
					</tr>

%   			}
	
			</table>

			</div>

%		} 

		<br style="clear: both;">

		<span class="blue block rightalign">
    	   	<input class="thin" type="submit" value="Save Housing Details">
   			</form>
		</span>

%	} # end of if housing.



%	my @rounds = sort { $a->name <=> $b->name } $event->rounds;

%	if (@rounds) { 

		<h4>Rounds:</h4>

		<table cellpadding="5" width="100%" cellspacing="1"> 

			<tr class="yellowrow">
	
				<th class="smaller">
					Rnd
				</td>
		
				<th class="smaller">
					Start
				</th>

%				if ($event->type eq "wudc" || $event->type eq "speech") { 
					<th class="smaller">
						Speaks
					</th>
%				}

%				if ($event->type eq "debate" || $event->type eq "policy"  || $event->type eq "ld"  || $event->type eq "pf") { 
				
					<th class="smaller">
						Vs.
					</th>

					<th class="smaller">
						S
					</th>
%				}
		
				<th class="smaller">
					Room
				</th>
		
				<th class="smaller">
					Judging
				</th>
		
				<th class="smaller">
					Result
				</th>
		
				<th class="smaller">
				</th>
		
			</tr>
		
% 			foreach my $round (@rounds) { 

%				my @panels = $m->comp("/funclib/entry_panels.mas", round => $round, entry => $entry);
%				my $panel = shift @panels;

%				if ($panel) {
		
%					my @all_ballots = Tab::Ballot->search( panel => $panel->id ); 
%					my @ballots;

%					my $opp;
%					my $side;

%					foreach my $ballot (@all_ballots) {
%						if ($ballot->entry->id == $entry->id) { 
%							push @ballots, $ballot;
%							$side = $ballot->side 
%						} else { 
%							$opp = $ballot->entry;
%						} 
%					}

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td class="smaller centeralign">
							<% $round->name %>
						</td>

						<td class="smaller">
							<% &Tab::nicetime($panel->round->timeslot->start->set_time_zone($tz)) %>
						</td>

%						if ($event->type eq "wudc" || $event->type eq "speech") { 
							<td class="smaller centeralign">
								<% Lingua::EN::Numbers::Ordinate::ordinate($m->comp("/funclib/entry_speakerorder.mas", entry => $entry, panel => $panel)) %> 
							</td>
%						}

%						if ($event->type eq "debate" || $event->type eq "policy"  || $event->type eq "ld"  || $event->type eq "pf") { 

							<td class="smaller">
								<% $opp->code %>
							</td>

							<td class="smaller centeralign">
%								if ($panel->bye) { 
									B
%								} elsif ($event->type ne "pf") { 
									<% $side == 1 ? "A" : "N" %>
%								} else { 
									<% $side == 1 ? "P" : "C" %>
%								}
	
							</td>
%						}

						<td class="smaller">
							<a class="white block" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
								<% ($panel->room) ? $panel->room->name : "No Room" %>
							</a>
						</td>

						<td class="smaller">

%		 					if ($panel->bye) { 
								<a class="hundo white block nowrap" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
									BYE
								</a>
%							} else {
%			 					foreach my $judge (sort {$a->ballotid <=> $b->ballotid} $m->comp("/funclib/panel_judges.mas", panel => $panel)) { 	
									<a class="<% $judge->chair ? "bold" : "" %> hundo white padless block nowrap" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
										<% $judge->judge_group->setting('no_codes') ? $judge->last : $judge->code." ".$judge->last %><% $judge->chair ? "*" : "" %>
										<% $judge->ballotid %>
									</a>
									<br />
% 								}	
% 							}	

						</td>

						<td class="smaller" align="center">

%							if ($event->type eq "speech") { 

% 								foreach my $ballot (sort {$a->judge->last cmp $b->judge->last} @ballots) { 

									<div class="block padless">

%									my @values = $ballot->values;

%									foreach my $value (@values) { 
%										if ($value->tag eq "rank") { 
											<% $value->value %>
%										} 
%									} 

%									foreach my $value (@values) { 
%										if ($value->tag eq "points") { 
											<% $value->value %>
%	 									} 
% 									} 

									</div>

% 								} 

% 							} else { 

% 								foreach my $ballot (@ballots) { 

									<div class="block padless">

%									my @values = $ballot->values;

%									if ($event->type eq "wudc") { 
%										foreach my $value (@values) { 
%											if ($value->tag eq "rank") { 
												<span class="microspan">
													<% Lingua::EN::Numbers::Ordinate::ordinate($value->value) %>
												</span>
%											}
%										}

%									} else { 

%										foreach my $value (@values) { 
%											if ( $value->tag eq "ballot") { 
												<span class="microspan">
													<% $value->value ? "W" : "L" %>
												</span>
%											}
%										}
%									}

%									foreach my $student (@students) { 

%										my $yo;
										<span class="schemat nowrap">


%										foreach my $value (@values) { 
%											next unless $value->student && $value->student->id == $student->id;
%											if ($value->tag eq "points") { 
												<% $value->value %>
%												$yo++;
%											} 
%										} 

%										foreach my $value (@values) { 
%											next unless $value->student && $value->student->id == $student->id;
%											if ($value->tag eq "rank") { 
												- <% $value->value %>
%												$yo++;
%											} 
%										} 
										
										<% $yo ? substr($student->first,0,1).substr($student->last,0,1) : "" %>

										</span>
% 									} 

									</div>

% 								} 
% 							} 

						</td> 
						
						<td class="smaller" align="center">
							<a class="white block" href="/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">
								Mv
							</a>
						</td>

					</tr>
	
% 				} else { 
							
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td>
							<% $round->name %>
						</td>
						
						<td colspan="4" class="smallish">
							Not scheduled in <% ($round->label) ? $round->label : "Round ".$round->name %>
						</td>

						<td class="smallish centeralign" colspan="2">
							<a class="dkgreen block" href="/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">
								Add
							</a>
						</td>
					</tr>
% 				}

% 			} 

		</table>
%	} 

%		$switch = 1;

	</div>

	<div class="right small">

		<div class="sidenote" style="padding-top: 30px;">

% 			if ($entry->dq == 1) { 

				<a class="dkred block">
					DISQUALIFIED 
				</a>
				<br />
						
%			} 

% 			if ($entry->dropped) { 

				<a class="dkred block">
					DROPPED 

%					if ($entry->drop_time) { 
						on <% &Tab::niceshortdt($entry->drop_time->set_time_zone($tz)) %>
%					}
				</a>
				<br />

%			} 


			<a class="blue block" href="/register/school/entries.mhtml?school_id=<% $entry->school->id %>&event_id=<% $event->id %>">
				School entry in <% $event->abbr %>
			</a>

			<a class="blue block" href="/register/event/roster.mhtml?event_id=<% $event->id %>&sort=school">
				<% $event->abbr %> full roster
			</a>

		<h4>Print</h4>

			<a class="blue block nowrap" href="print.mhtml?entry_id=<% $entry->id %>">
				Print <% $entry->code %> Info Sheet
			</a>

%		if ($tourn->setting("ncfl")) { 
			<a class="blue block" href="card_print.mhtml?entry_id=<% $entry->id %>">
				Print <% $entry->code %> Card
			</a>
%		}

%		foreach my $student (@students) { 

			<a class="blue block nowrap" href="student_print.mhtml?student_id=<% $student->id %>">
				Student <% $student->first." ".$student->last %> Info Sheet
			</a>
%		}

%		if ($event->judge_group->setting("prefs")) { 

			<a class="blue block" href="/register/entry/prefs.mhtml?entry_id=<% $entry->id %>&sort=school">
				<% $entry->code %> Pref Sheet
			</a>
%		}


% 		if ( $event->setting("waitlist") || $event->setting("waitlist_all") ) { 
		
			<h4>Entry Status</h4>

%			if ($entry->waitlist) { 

				<a class="dkred block">
					Waitlisted
				</a>

%				my $warnno = "This will admit the entry off the waitlist.  It will NOT notify the coaches.";
%				my $warnyep = "This will admit the entry off the waitlist.  It will notify coaches by email.";

				<a class="blue block" <& "/funclib/confirm.mas", warn => $warnno &> href="unwaitlist.mhtml?entry_id=<% $entry->id %>">Admit off waitlist</a>
				<a class="blue block" <& "/funclib/confirm.mas", warn => $warnyep &> href="unwaitlist.mhtml?notify=yessir&entry_id=<% $entry->id %>">Admit & notify coaches</a>

%			} else { 
				<a class="yellow block" href="waitlist.mhtml?entry_id=<% $entry->id %>">Place on waitlist</a>
%			}

%		}

		<h4>Wreak Havoc</h4>

%		if ($entry->dropped) { 

			<a class="dkgreen block" href="undrop.mhtml?entry_id=<% $entry->id %>">
				Un-Drop
			</a>

			<a class="dkred block" href="delete.mhtml?entry_id=<% $entry->id %>">
				Completely Delete
			</a>

%		} else { 

			<a class="yellow block" href="drop.mhtml?entry_id=<% $entry->id %>">Drop</a>
%		}

%		if ($entry->dq) { 

			<a class="dkred block" href="undq.mhtml?entry_id=<% $entry->id %>">Un-Disqualify</a>
			
%		} else { 

%			my $warn = "You are about to disqualify this entry.  In IEs, other entries in the same section as this one will be promoted one rank if they scored below this entry in all rounds.  In debate no results changes will be made.  You can undo this if you change your mind.";

			<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &>  href="dq.mas?entry_id=<% $entry->id %>">Disqualify</a>
%		}

			<a class="yellow block" href="/tabbing/entry/card.mhtml?entry_id=<% $entry->id %>">View/Change Results</a>

		</div>

		<div class="sidenote">

			<h4>Swap Students</h4>

			<table cellpadding="3" cellspacing="1" width="100%">
			
				<form action="change.mhtml" method="post">
				<input type="hidden" name="entry_id" value="<% $entry_id %>">
				<input type="hidden" name="school_id" value="<% $entry->school->id %>">

<%perl>
				 my @clean_students = $m->comp("/funclib/students_evententer.mas",
					tourn => $tourn,
					event => $event,
					school => $entry->school
				);

				my $count = 1;

</%perl>

%				foreach my $student (@students) { 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
						<th class="smaller">
							<% $count++ %>
						</th>
			
						<td> 
							<select name="<% $student->id %>" onchange='this.form.submit()'>

	    						<option value="<%	$student->id %>">
									<% substr($student->last.", ".$student->first,0,15) %>
								</option>

%								foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @clean_students) {

% 			  						next if $entry_students{$other_student->id};
	
    								<option value="<% $other_student->id %>">
										<% substr($other_student->last.", ".$other_student->first,0,15) %>
									</option>
	
%								}

							</select> 
						</td> 
					</tr>

%				} 

%				if ( scalar @students < $event->setting("max_entry") ) { 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	
			
						<th class="smaller">
							<% $count++ %>:
						</th>
			
						<td> 
							<select name="new" onchange='this.form.submit()'>
   		 						<option value="">
									Add student
								</option>

%								foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @clean_students) {

% 		  							next if $entry_students{$other_student->id};

    								<option value="<% $other_student->id %>">
										<% substr($other_student->last.", ".$other_student->first,0,15) %>
									</option>
	
%								}

							</select> 
						</td> 
					</tr>

%				}

				<tr class="yellowrow">
	
					<noscript>
						<td colspan="2" align="right">
							<input type="submit" class="thin" value="  Save Changes  ">
						</td>
					</noscript>

					</form>

				</tr>

%				if ($tourn->setting("ncfl")) { 


					<tr>
						<td colspan="2">
							<h4>Change School</h4>
							<form action="school.mhtml" method="post">
							<input type="hidden" name="entry_id" value="<% $entry->id %>">
						</td>
					</tr>

					<tr class="evenrow">

						<td colspan="2">
							<select name="school_id">

%							foreach my $school (sort {$a->name cmp $b->name} $entry->school->region->schools(tournament => $tourn->id) ) { 
%								next if $school->id == $entry->school->id;
								<option value="<% $school->id %>">
									<% substr($school->name,0,32) %>
								</option>
%							}

						</td>
	
					</tr>

					<tr class="yellowrow">

						<td align="right" colspan="2">
							<input type="submit" class="thin" value=" Save School ">
							</form>
						</td>

					</tr>


%				}

			</table>
		
		</div>

	</div>

	<br style="clear: both;" />
