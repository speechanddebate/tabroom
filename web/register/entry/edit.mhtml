<%args>
	$dbh
	$tourn
	$perms
	$tourn_settings
	$person
	$person_settings
	$entry_id	  => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$m->abort unless $entry;

	my $event	= $entry->event;
	my $category = $event->category;

	$m->abort if $category && $category->tourn != $tourn;

	my @students = $entry->students;
	my %event_settings = $event->all_settings;
	my %category_settings = $category->all_settings() if $category;

	my $aff_string = $event_settings{"aff_label"} || "Aff";
	my $neg_string = $event_settings{"neg_label"} || "Neg";

	my $event_type = $event->type;

	$event_type = "debate"
		if ($event_type eq "wsdc"
			|| $event_type eq "policy"
			|| $event_type eq "mock_trial"
			|| $event_type eq "ld"
			|| $event_type eq "pf"
			|| $event_type eq "parli");

	my $show_region++ if $event_settings{"region_avoid"};
	$show_region++ if $event_settings{"region_constrain"};
	$show_region++ if $tourn_settings->{"ncfl"};

	my $no_codes++ if $event_settings{"code_style"} eq "names";
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	Tab::Round->set_sql( flightedness => "
		select max(round.flighted) from round where event = ?
	");

	my $max_flights = Tab::Round->sql_flightedness->select_val($event->id);

	my %wins = $m->comp(
		"/funclib/entry_wins.mas",
		event  => $event
	);

	my %losses = $m->comp(
		"/funclib/entry_losses.mas",
		event => $event
	);

	my $school = $entry->school;

	unless ($school > 0) {
		$m->comp("/funclib/abort.mas",
			message => "Entry $entry_id does not have a valid school ID.   Every entry must have a valid school."
		);
	}

	my $region = $school->region if $school;
	my %entry_settings = $entry->all_settings;
	my %reasons;

	%reasons = $m->comp(
		"/funclib/judgemath/nats_check_judging.mas",
		school => $school
	) if $tourn_settings->{"nsda_nats"};

	#Check Double Entry Limits
	my %ok;

	if ($tourn_settings->{nsda_nats}) {
		my $entries_ref = $m->comp("/funclib/nsda/supp_api.mhtml",
			school => $entry->school,
			return => 1
		);

		%ok = map {$_ => 1} @{$entries_ref};
	}

</%init>

%	if ( $perms->{tourn}{$tourn} eq "limited") {

		<div class="main">
			<h4 class="nospace">
				<% $school->name %>
			</h4>

%	} else {

		<& "/register/menubar.mas",
			school         => $school,
			whoami         => "students",
			tourn          => $tourn,
   			reasons        => \%reasons,
			tourn_settings => $tourn_settings
		&>
%	}

	<script>

		function statusSwitch(targetStatus) {
			$("."+targetStatus).toggleClass('hidden');
		}

	</script>

	<form
		enctype = "multipart/form-data"
		action  = "save.mhtml"
		method  = "post"
	>

	<input
		type  = "hidden"
		name  = "entry_id"
		value = "<% $entry->id %>"
	>
		<div class="full padtopmore flexrow ltborderbottom">

			<span class="threefifths nowrap">
				<h4 class="semibold nospace padvertless marvertless">
					<% $entry->code ? $entry->code : "Entry" %> in <% $event->abbr %>
				</h4>
			</span>

			<span class="<% $event_type eq 'debate'
				? "twofifths"
				: "half"
			%> marno rightalign">

<%perl>
				if ($event_settings{"ask_for_titles"}
					|| $event_settings{"ask_for_topic"}
					|| $event_settings{"ask_for_manuscript"}
					|| $event_settings{"online_mode"} eq "async"
					|| $event_settings{"ask_for_bibliography"}
					|| $event_settings{"ask_quals"}
				) {
</%perl>
					<a
						id	  = "piecebutton"
						class   = "buttons bluetext buttonwhite <% $ARGS{'titles'} == 1 ? 'invert' : "" %>"
						onClick = "togglePieces();"
					>Piece/Quals</a>
%				}

				<span
					class="redtext buttonwhite banner dropped
					<% $entry->dropped ? "" : "hidden" %>">
					DROPPED
				</span>

				<span
					class="orangetext buttonwhite banner dq
					<% $entry_settings{"dq"} ? "" : "hidden" %>">
					DISQUALIFIED
				</span>

				<span
					class="purpletext buttonwhite banner waitlist
					<% $entry->waitlist &! $entry->dropped ? "" : "hidden" %>">
					WAITLISTED
				</span>

				<span
					class="purpletext buttonwhite banner vacate
					<% $entry_settings{"nsda_vacate"} ? "" : "hidden" %>">
					VACATED
				</span>

				<span
					class="greentext buttonwhite banner exclude_from_sweeps
					<% $entry_settings{"exclude_from_sweeps"} ? "" : "hidden" %>">
					NO SWEEPS
				</span>

				<span
					class="greytext buttonwhite banner po
					<% $entry_settings{"po"} ? "" : "hidden" %>">
					PO
				</span>

				<span
					class="orangetext buttonwhite banner no_elims
					<% $entry_settings{"no_elims"} ? "" : "hidden" %>">
					NO ELIMS
				</span>
				<span
					class="bluetext buttonwhite banner autoqual
					<% $entry_settings{"autoqual"} ? "" : "hidden" %>">
					AUTOQUAL
				</span>
			</span>

%			if ($event_type eq "debate") {
				<span class="tenth rightalign <% $entry->active ? "" : "hidden" %> padvertno">
					<h5 class="bluetext record">
						<%
							$wins{$entry->id} ? $wins{$entry->id} : "0"
								%>-<%
							$losses{$entry->id} ? $losses{$entry->id} : "0"
						%>
					</h4>
				</span>
%			}

		</div>

		<div class="nospace <% $ARGS{"titles"} ? "hidden" : "" %> notpieceinfo">

		<div class="splitpage">

%		my $code_setting = $event_settings{"code_style"};

		<span class="pagehalf flexkids">
			<div class="row flexrow">
				<span class="third padleft padleft">
					Name
				</span>

				<span class="twothirds rightalign padright">
					<input
						type  = "text"
						size  = "24"
						name  = "name"
						value = "<% $entry->name %>"
					>
				</span>
			</div>

%			if ($tourn_settings->{"nsda_nats"} > 0 && $event->type ne "wsdc") {

				<div class="row natsstatus flexrow centeralign wrap fixedheight">

%				if ($event_settings{"supp"} || $event_settings{"conn"}) {

					<span class="third padleft padleft purpletext semibold">
						SUPP/CONN
					</span>

					<span class="twothirds padvertless flexrow">
<%perl>
					if ($entry_settings{'reregistered'}) {

						my $reregistered = Tab::EntrySetting->search(
							entry => $entry,
							tag => "reregistered"
						)->first;

						my $reregistered_by = Tab::Person->retrieve($reregistered->value);
						my $reregistered_at = $reregistered->timestamp->set_time_zone($tz);
</%perl>
						<span
							class = 'half padleft greentext'
							title = "<% $reregistered_by->email %>"
						>
							by <% $reregistered_by->first." ".$reregistered_by->last %>
						</span>

						<span class='half centeralign graytext'>
							at
							<%
								$m->comp("/funclib/showdate.mas",
									length => "short",
									dt     => $reregistered_at
								)
							%> <%
								$m->comp("/funclib/showtime.mas",
									length => "short",
									dt	 => $reregistered_at
								)
							%>
						</span>

%					} elsif ($entry->active) {
						<div class="full padleft orangetext semibold">
							Activated Without Re-Reg
						</div>
%					} elsif (not defined $ok{$entry->id}) {
						<p class="full redtext semibold nospace smallish">
							Forbidden by double entry rules. Overriding
							risks the wrath of Burdt.  Yes, there's a log.
						</p>
%					} else {
						<div class="full padleft graytext semibold">
							Pending Re-Reg
						</div>
%					}
					</span>
<%perl>
				} elsif ($entry->active) {

					my $accepted_by = Tab::Person->retrieve($entry_settings{"accepted_by"});
					my $accepted_at = $entry_settings{'accepted_at'};
					$accepted_at->set_time_zone($tz) if $accepted_at;
</%perl>

					<span class="semibold greentext third padsetting padleft">
						ACCEPTED
					</span>

					<% $accepted_by
						? "<span class='bluetext semibold third nowrap'>by ".$accepted_by->first." ".$accepted_by->last."</span>"
						: ""
					%> <%
						$entry_settings{"accepted_at"}
						? "<span class='bluetext third semibold padright rightalign'>".
							Tab::niceshortdate($accepted_at)." at ".
							Tab::nicetime($accepted_at)."</span>"
						: ""
					%>
					</span>
<%perl>

				} elsif ($entry_settings{"rejected_by"}) {

					my $rejected_by = Tab::Person->retrieve($entry_settings{"rejected_by"});
					my $rejected_at = $entry_settings{'rejected_at'};
					$rejected_at->set_time_zone($tz) if $rejected_at;
</%perl>

					<span class="semibold redtext quarter padno padsetting">
						<span class="halfspacer"></span>
						REJECTED
					</span>

					<% $rejected_by
						? "<span class='threeeighths centeralign marno padless'>".$rejected_by->first." ".$rejected_by->last."</span>"
						: ""
					%>

					<% $entry_settings{"rejected_at"}
						? "<span class='threeeighths centeralign marno padless'>".
							Tab::niceshortdate($rejected_at)." ".
							Tab::nicetime($rejected_at)."</span>"
						: ""
					%>

%				} else {

%					my $created_at = $entry->created_at->set_time_zone($tz);

					<span class="semibold orangetext quarter padsetting">
						<span class="halfspacer"></span>
						PENDING
					</span>

					<span class='quarter centeralign marno'>
						Created:
					</span>

					<span class='quarter centeralign marno'>
						<% Tab::eurodate($created_at) %>
					</span>

					<span class='quarter centeralign marno'>
						<% Tab::nicetime($created_at) %>
					</span>

%				}
				</div>

				<div class="row flexrow">
					<span class="semibold third padleft">
						Change Status
					</span>

%					if ($event_settings{"supp"} || $event_settings{"conn"}) {

						<span class="twothirds padright">
							<select name="reregistered">
								<option
									<% $entry_settings{"reregistered"}
										? ""
										: 'selected="selected"'
									%>
									value="0"
								>Pending Re-reg</option>
								<option
									<% $entry_settings{"reregistered"}
										? 'selected="selected"'
										: ""
									%>
									value="1"
								>Re-registered</option>
							</select>
						</span>
<%perl>
						if ($entry->unconfirmed > 0) {
							$entry->unconfirmed(0);
							$entry->update();
						}

					} else {

						my $status;
						$status = "accepted" if $entry->active;
						$status = "dropped" if $entry->dropped;
						$status = "pending" if $entry->unconfirmed;
						$status = "rejected" if $entry_settings{"rejected_by"};
</%perl>
						<span class="twothirds padright">
							<select name = "entry_status">
								<option value="">No Change</option>
								<option
									value="accepted"
								>Accepted</option>

%								unless ($event_settings{"no_autopromotion"} || $tourn_settings->{"no_autopromotion"}) {
									<option
										value="rejected"
									>Rejected (Promote Next)</option>
%								}
								<option
									value="rejected_no_promotion"
								>Rejected (No Promotion)</option>
								<option
									value="pending"
								>Pending</option>
							</select>
						</span>
%					}
				</div>

				<div class="row flexrow">
%					if ($entry_settings{"status"} eq "complete") {
						<span class="third padleft padsettingtext greentext semibold">
%					} else {
						<span class="third padleft padsettingtext redtext semibold">
%					}
						Requirements
					</span>

%					if ($entry_settings{"status"} eq "complete") {
						<span class="twothirds greentext semibold padleft">
							COMPLETE
						</span>
%					} else {
%						$entry_settings{"incomplete_reasons"} =~ s/-/<br \/>/g;
						<span class="twothirds smallish redtext incomplete wrap padleft">
							<% $entry_settings{"incomplete_reasons"} %>
						</span>
%					}
				</div>


%			} else {

				<div class="row fixedheight">
					<span class="third padleft">
						Registered
					</span>

					<span class="twothirds smallish">

						<& "/funclib/showdt.mas",
							dt     => $entry->created_at,
							tz     => $tourn->tz,
							format => 'murica_short',
							class  => "inline nospace"
						&>

%						if ($entry->registered_by) {
							by <% $entry->registered_by->first %> <% $entry->registered_by->last %>
%						}
					</span>
				</div>
%			}

		</span>

%		my %entry_students = ();
%		my $tick = 1;

		<span class="pagehalf flexkids">

%			unless ($event_settings{"no_codes"} || $no_codes) {
				<div class="row flexrow">
					<span class="third padleft">
						Code
					</span>

					<span class="twothirds padright">
						<input
							type  = "text"
							name  = "code"
							id    = "code"
							value = "<% $entry->code %>"
<%perl>
							unless ($entry->code
								|| $event_settings{"code_style"} eq "none"
								|| $event_settings{"code_style"} eq "names"
								|| $event_settings{"code_style"} eq "full_initials"
								|| $event_settings{"code_style"} eq "initials"
							) {

								my $entry_code = $m->comp("/funclib/entry_code.mas",
									entry => $entry,
									event => $event
								);
</%perl>
								placeholder = "Next Free Code: <% $entry_code %>"
								onClick     = "fillInFree('<% $entry_code %>');"
%							}
						>
					</span>
				</div>

%			}

%			if ($event->type eq "mock_trial") {
				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Observer Count
					</span>

					<span class="third padvertless">
						<input
							type  = "number"
							class = "full"
							name  = "observers"
							min   = 0
							max   = 999
							value = "<% $entry_settings{"observers"} %>"
						>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"nsda_district"} && $event->abbr eq "HSE") {

				<div class="row flexrow">
					<span class="threequarters">
						House Chamber Bloc
					</span>

					<span class="quarter">
						<input
							type  = "number"
							name  = "nsda_house_bloc"
							min   = 1
							size  = 8
							max   = <% $event_settings{"house_chambers"} %>
							value = "<% $entry_settings{"nsda_house_bloc"} %>"
						>
					</span>
				</div>
<%perl>
			}

			if ($event_settings{"breakouts"}) {

				foreach my $breakout (1 .. $event_settings{"breakouts"}) {

					next if $event_settings{"breakout_".$breakout."_delete"};
</%perl>
					<div class="row hover flexrow">
						<label for="breakout_<% $breakout %>">
							<span class="threequarter padleft">
								<% $event_settings{"breakout_".$breakout."_label"} %> Breakout
							</span>

							<span class="quarter">
								<input
									type  = "checkbox"
									name  = "breakout_<% $breakout %>"
									id    = "breakout_<% $breakout %>"
									value = "1"
									<% $entry_settings{"breakout_".$breakout}
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</label>
					</div>
<%perl>
				}
			}

			if (
				($tourn_settings->{"nsda_nats"}
					|| $tourn_settings->{"nsda_ms_nats"}
				)
				&& (not defined $event_settings{"not_nats"} )
				&& ($event_type eq "speech" || $event_type eq "debate")
			) {

</%perl>
				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Out after Rd
					</span>

					<span class="twothirds padright">
						<input
							type        = "number"
							class       = "full"
							id          = "down_and_out"
							name        = "down"
							value       = "<% $entry_settings{"down"} %>"
							placeholder = "Round that entry dropped out"
						>
					</span>
				</div>
<%perl>
			}

			if (
				$tourn_settings->{"nsda_nats"}
				&! $event_settings{'usa_wsdc'}
			) {

				my $coaches;

				unless ($coaches) {
					$coaches = $m->comp("/funclib/nsda/coaches.mas", school => $school->id);
				}

				my %coach_by_id = map { $_->{nsda} => $_ } @{$coaches};

				if ($entry_settings{'coach_points'} && (not defined $coach_by_id{$entry_settings{'coach_points'}})) {

					my $sth = $dbh->prepare("
						select person.id, person.first, person.middle, person.last, person.nsda
						from person
						where nsda = ?
					");

					$sth->execute($entry_settings{'coach_points'});
					my $results = $sth->fetchall_hash();

					if ($results && scalar @{$results} > 0) {
						push @{$coaches}, shift @{$results};
					} else {
						$entry->setting("coach_points", 0);
					}
				}

</%perl>
				<div class="row flexrow">
					<span class="third padleft">
						Coach for Points
					</span>

					<span class="twothirds padright">
						<select name="coach_points">
							<option value=""></option>
<%perl>
							my %used;
							foreach my $coach (@{$coaches}) {
								next if $used{$coach->{nsda}}++;
</%perl>
								<option
									value="<% $coach->{nsda} %>"
									<% $coach->{nsda} == $entry_settings{'coach_points'}
										? 'selected="selected"'
										: ""
								%>><% $coach->{first}." ".$coach->{middle}." ".$coach->{last}." (ID ".$coach->{nsda}.")" %></option>
%							}
						</select>
					</span>
				</div>

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Coach NSDA ID
					</span>

					<span class="twothirds padright">
						<input
							type        = "number"
							class       = "full"
							name        = "coach_points_id"
							placeholder = "Overrides menu selections"
						>
					</span>
				</div>

%				if ($tourn_settings->{"nsda_nats"} && (not defined $event_settings{'supp'}) && $person->site_admin) {
					<div class="row flexrow">
						<span class="third padleft">
							Districts TRID
						</span>

						<span class="twothirds padright">
							<input
								type        = "text"
								name        = "source_entry"
								value       = "<% $entry_settings{"source_entry"} %>"
								placeholder = "Tabroom ID number of Districts entry"
							>
						</span>
					</div>
%				}
%			}

%	 		if ($event_settings{"apda"}) {
%				my $seed = $entry_settings{"registered_seed"};
				<div class="row flexrow">
					<span class="half padleft">
						APDA Seed
					</span>

					<span class="half padright">
						<select name="seed">
							<option value="">None</option>
							<option value="full"
								<% $seed eq "full" ? "selected" : "" %>>Full</option>
							<option value="half"
								<% $seed eq "half" ? "selected" : "" %>>Half</option>
							<option value="free"
								<% $seed eq "free" ? "selected" : "" %>>Free</option>
						</select>
					</span>
				</div>
%	 		}

%			if ($event_settings{"seed_presets"}) {
				<div class="row flexrow">
					<span class="threequarters padleft">
						Preset Seed
					</span>

					<span class="quarter padright">
						<input
							type  = "number"
							name  = "pairing_seed"
							size  = "5"
							class = "thin"
							value = "<% $entry_settings{"pairing_seed"} %>"
						>
					</span>
				</div>
%	 		}

%			if ($tourn_settings->{"backtab"}) {
				<div class="row flexrow">
					<span class="threequarters padleft">
						Backtab Points
					</span>

					<span class="quarter padright">
						<input
							type  = "number"
							name  = "backtab"
							step  = ".0001"
							size  = "5"
							class = "thin"
							value = "<% $entry_settings{"backtab"} %>"
						>
					</span>
				</div>
%	 		}

%			if ($event_settings{"round_robin"}) {
				<div class="row flexrow">
					<span class="half padleft">
						Round Robin Pod
					</span>

					<span class="half">
						<input
							type="number"
							name="pod"
							size="5"
							class="thin"
							value="<% $entry_settings{"pod"} %>"
						>
					</span>
				</div>
%	 		}
<%perl>
		if	($tourn_settings->{"nsda_nats"}
				|| $tourn_settings->{"nsda_district"}
				|| $tourn_settings->{"nsda_ms_nats"}
		) {
</%perl>
			<div class="row flexrow padvertless">
				<span class="third padleft">
					Awards coaches
				</span>
				<span class="twothirds padright">
					<textarea
						name        = "coach_script"
						rows        = 1
						placeholder = "Coach names to be read if entry places"
					><% $entry_settings{"coach_script"} %></textarea>
				</span>
			</div>
%		}

		</span>

		</div>

		<div class="libl rightalign pagefull">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Save Entry"
				>
			</span>
		</div>
		</form>

		<h6 class="semibold martopmore padbottom">
			Individual Competitors
		</h6>

		<div class="full nospace flexrow wrap top">

%		unless (@students) {

			<div class="lirdrow redtext centeralign padmore marno padbottommore grow">

				<h2 class="redtext">SOMETHING IS VERY WRONG</h2>

					You have no individual competitors linked to this entry.
					That will cause all kinds of issues!

					<br />
					Speaker points and speaker ranks cannot be entered
					until you add students.  Use the menu at right.
			</div>
<%perl>

		}

		foreach my $student (@students) {

			next unless $student > 0;

			my $hybrid_school;

			if (
				$student->chapter
				&& $school->chapter
				&& $student->chapter->id != $school->chapter->id
			) {

				$hybrid_school = Tab::School->search(
					tourn   => $tourn->id,
					chapter => $student->chapter->id
				)->first;
			}

			$entry_students{$student->id}++;

</%perl>
			<span class="bordervert half flexrow odd">
				<span class="twofifths hover padleftmore grow">
					<a
						class = "plain flexrow semibold graytext"
						title = "<% $student->fullname %>"
						href  = "student_edit.mhtml?student_id=<%$student->id%>&entry_id=<% $entry->id %>"
					>
						<span class="ninetenths">
							<% $student->fullname %>
						</span>
					</a>
				</span>

%				if ($hybrid_school) {
					<span class="threetenths smaller">
						<a
							class="white padvert"
							href="/register/school/entries.mhtml?school_id=<%$hybrid_school->id%>"
						>
							<% $hybrid_school->short_name %>
						</a>
					</span>
%				}

				<span class="threetenths smaller flexrow grow">
%					if ($student->novice) {
						<span class="third">
							<% $student->novice ? 'Novice' : "" %>
						</span>
%					}
%					if ($student->nsda) {
						<span class="twothirds">
							NSDA #<% $student->nsda %>
						</span>
%					}
				</span>
			</span>
%		}

		</div>

<%perl>

		my $round_sth = $dbh->prepare("
			select
				round.id, round.name, round.label,
				CONVERT_TZ(round.start_time, '+00:00', tourn.tz) start_time,
				CONVERT_TZ(timeslot.start, '+00:00', tourn.tz) ts_start
			from round, event, tourn, timeslot
				where event.id = ?
				and event.tourn = tourn.id
				and event.id = round.event
				and round.timeslot = timeslot.id
			order by round.name
		");

		$round_sth->execute($event->id);
		my $rounds = $round_sth->fetchall_hash();

		my $panel_sth = $dbh->prepare("
			select
				panel.id, panel.letter, panel.bye,
				room.id room_id, room.name room_name,
				ballot.id ballot_id, ballot.bye bbye, ballot.forfeit
			from (panel, ballot)
				left join room on room.id = panel.room
			where panel.round = ?
				and panel.id = ballot.panel
				and ballot.entry = ?
			group by ballot.entry
		");

		my $judges_sth = $dbh->prepare("
			select
				judge.id, judge.code, judge.first, judge.last,
				ballot.chair
			from (ballot, judge)
			where ballot.panel = ?
				and ballot.judge = judge.id
			group by judge.id
			order by ballot.id
		");

		if ($rounds && @{$rounds}) {
</%perl>

		<div class="full flexrow padtop">
			<span class="half">
				<h5>Round Assignments</h5>
			</span>

			<span
				class = "half rightalign padright"
				id    = "rounds_buttonarea"
			>
			</span>

		</div>

		<& "/funclib/tablesorter.mas", table => 'rounds' &>

		<table
			id    = "rounds"
			class = "nar"
		>

			<thead>

				<tr class="yellowrow">
					<th class="smaller">
						Round
					</td>

					<th class="smaller">
						Start
					</th>

%					if ($event_type eq "wudc" || $event_type eq "speech") {
						<th class="smaller">
							Speaks
						</th>
%					}

%					if ($event_type eq "debate") {
						<th class="smaller limit3">
							Opponent
						</th>

						<th class="smaller">
							Side
						</th>
%					}

%					unless ($event_settings{"online_mode"} eq "async") {
						<th class="smaller">
							Room
						</th>
%					}

					<th class="smaller limit2 nosort">

%						if ($event_type eq "debate") {
							<span class="third marno">
								Judge
							</span>

							<span class="third marno">
								Result
							</span>

%						} else {
							<span class="half marno">
								Judge
							</span>

							<span class="half marno">
								Result
							</span>
%						}
					</th>

					<th class="smaller nosort">
						Actions
					</th>
				</tr>

			</thead>
			<tbody>
<%perl>

			foreach my $round (@{$rounds}) {

				$panel_sth->execute($round->{id}, $entry->id);
				my $panels = $panel_sth->fetchall_hash();

				foreach my $panel (@{$panels}) {

					my @all_ballots = Tab::Ballot->search( panel => $panel->{id} );
					my @ballots;

					my $opp;
					my $side;
					my $order;

					foreach my $ballot (@all_ballots) {
						if ($ballot->entry && $entry && $ballot->entry->id == $entry->id) {
							push @ballots, $ballot;
							$side = $ballot->side;
							$order = $ballot->speakerorder
						} else {
							$opp = $ballot->entry;
						}
					}

</%perl>
					<tr class="row flexrow">

						<td class="smaller centeralign" data-text="<% $round->{name} %>">
							<% $round->{label} || "Round ".$round->{name} %>
						</td>

						<td class="smaller nowrap" data-text="<% $round->{start_time} || $round->{ts_start} %>">
							<& "/funclib/showtime.mas",
								string => $round->{start_time} || $round->{ts_start}
							&>
						</td>

%						if ($event_type eq "wudc" || $event_type eq "speech") {
							<td class="smaller centeralign">
								<% Lingua::EN::Numbers::Ordinate::ordinate($order) %>
							</td>
%						}

%						if ($event_type eq "debate") {
%							if ($panel->{bye}) {
								<td class="smaller" colspan="4">
									<div class="full">
										BYE
									</div>
								</td>
%							} else {

								<td class="smaller nospace padvertless">
									<a
										class = "white padleft"
										href  = "edit.mhtml?entry_id=<% $opp ? $opp->id : "" %>"
									><% $show_region
											&& $opp
											&& $opp->school
											&& $opp->school->region
												? $opp->school->region->code
												: ""
										%> <%
											$opp ? $opp->code
												: ""
									%></a>
								</td>

								<td class="smaller centeralign">
%									if ($panel->{bye}) {
										B
%									} else {
										<% $side == 1 ? $aff_string : $neg_string %>
%									}
								</td>

<%perl>
								if (
									$event_settings{"online_mode"}
									&& ( $event_settings{"online_mode"} ne "sync" &&  $event_settings{"online_mode"} ne "async")
								) {
</%perl>
									<td class="smaller nospace centeralign">
										<& "/funclib/online_room.mas",
											panel  => $panel->{id},
											person => $person,
											class  => "fa-sm"
										&>
									</td>
<%perl>
								} elsif ($event_settings{'online'}
									&& $event_settings{"online_mode"} eq "async"
									&& (not defined $event_settings{"online_hybrid"} )
								) {
</%perl>

%								} else {
									<td class="smaller leftalign padleft">
										<% $event_type eq "congress" ? "Ch ".$panel->{letter} : "" %>
										<% $panel->{room_name} || "No Room" %>
									</td>
%								}

								<td class="smaller nospace">

%				 					if ($panel->{bye}) {
										<span class="semibold redtext">
											BYE
										</span>
<%perl>
									} else {

										$judges_sth->execute($panel->{id});
										my $judges = $judges_sth->fetchall_hash();

					 					foreach my $judge (@{$judges}) {
</%perl>
											<div class="full hover flexrow grow">

												<span class="third padleft nowrap padvertless">
													<% $category_settings{'no_codes'}
														? $judge->{last}.", ".$judge->{first}
														: $judge->{code}." ".$judge->{last}.", ".$judge->{first}
													%><%
														$judge->{chair} ? "*" : ""
													%>
												</span>

												<span class="twothirds nowrap nospace flexrow">
<%perl>
						 							foreach my $ballot (@ballots) {

														next if $ballot->judge ne $judge->{id};
														my %values = ();

														foreach my $score ($ballot->values) {

															if ($score->student && $score->student->id) {
																$values{$score->student->id}{$score->tag} = $score->value;
																$values{"total_".$score->tag} += $score->value;

															} elsif ($score->tag eq "point") {

																$values{$score->tag} = $score->value();

															} elsif ($score->tag eq "winloss") {

																if ($score->value == 1) {
																	$values{$score->tag} = "W";
																} else {
																	$values{$score->tag} = "L";
																}

															} else {
																$values{$score->tag} = $score->value;
															}
														}
</%perl>
%														if ($event_type eq "wudc") {

															<span class="sixth padmuchless marno">
																<% $values{"rank"}
																	? Lingua::EN::Numbers::Ordinate::ordinate($values{"rank"})
																	: ""
																%>
															</span>

%														} else {

%															if ($ballot->bye) {

																<span class="sixth padmuchless marno">
																	BYE
																</span>

%															} elsif ($ballot->forfeit) {

																<span class="sixth padmuchless marno">
																	FFT
																</span>

%															} else {

																<span class="<% $event_type eq "wsdc" ? "fifth" : "sixth" %> nospace">
																	<div class="padmuchless marless centeralign semibold
																		<% $values{"winloss"} eq "W" ? "greentext" : "redtext" %>">
																		<% $values{"winloss"}  %>
																	</div>

%																	if ($event_type eq "wsdc" && ($values{"total_refute"} + $values{"total_point"}) > 0) {
																		<div class="padmuchless marless martop centeralign semibold">
																			<% $values{"total_refute"} + $values{"total_point"} %>
																		</div>
%																	}
																</span>
%															}
%														}

%														if ($values{"point"}) {
															<span class="sixth padmuchless marless centeralign semibold bluetext">
																<% $values{"point"}  %>
															</span>
															<span class="twothirds smaller nospace">
%														} else {
															<span class="fivesixths smaller nospace">
%														}

<%perl>
														foreach my $student (@students) {

															next unless $values{$student->id}{"point"}
																|| $values{$student->id}{"rank"}
																|| $values{$student->id}{"speaker"};
</%perl>
															<div class="nospace padmuchless">
																<span class="fifth nospace nowrap">
																	<%
																		$values{$student->id}{"point"}
																		? sprintf("%.1f", $values{$student->id}{"point"})
																		: ""
																	%>
																	<%
																		$values{$student->id}{"speaker"}
																		? $values{$student->id}{"speaker"}
																		: ""
																	%>
																</span>

%																if ($values{$student->id}{"rank"}) {
																	<span class="sixth">
																		<% $values{$student->id}{"rank"} %>
																	</span>
%																}

																<span class="threefifths">
																	<% $student->last.", ".$student->first %>
																</span>
															</div>
%					 									}

%														if ($event_type eq "wsdc") {

%															foreach my $student (@students) {

%																next unless $values{$student->id}{"refute"};

																<div class="nospace padmuchless padvertless ltborderbottom">
																	<span class="quarter nospace nowrap">
																		<% $values{$student->id}{"refute"} %>
																	</span>

																	<span class="sixth">
																	</span>

																	<span class="threefifths">
																		Reply: <% $student->first." ".$student->last %>
																	</span>
																</div>
%					 										}
%														}
%													}

												</span>
											</div>
%										}
%		 							}
								</td>
%							}

%						} else {

<%perl>
							if (
								$event_settings{"online_mode"}
								&& ( $event_settings{"online_mode"} ne "sync" &&  $event_settings{"online_mode"} ne "async")
							) {
</%perl>
								<td class="smaller nospace centeralign">
									<& "/funclib/online_room.mas",
										panel  => $panel->{id},
										person => $person,
										class  => "fa-sm"
									&>
								</td>

%							} elsif ($event_settings{"online_mode"} eq "async") {


%							} else {
								<td class="smaller leftalign padleft">
									<% $event_type eq "congress" ? "Ch ".$panel->{letter} : "" %>
									<% $panel->{room_name} || "No Room" %>
								</td>
%							}

							<td class="smaller nospace">
<%perl>

								$judges_sth->execute($panel->{id});
								my $judges = $judges_sth->fetchall_hash();

								foreach my $judge (@{$judges}) {
</%perl>
									<div class="full flexrow padleft">

										<span class="half smaller">
											<% $category_settings{'no_codes'}
												? $judge->{last}
												: $judge->{code}." ".$judge->{last}.", ".$judge->{first}
											%><% $judge->{chair} ? "*" : "" %>
										</span>

										<span class="half smaller flexrow nowrap">

%				 							foreach my $ballot (@ballots) {

%												next unless $ballot->judge == $judge->{id};

												<span class="third padleft">
													<% $ballot->forfeit ? "NoShow" : "" %>
													<% $ballot->bye ? "Bye" : "" %>

%													my @scores = $ballot->scores;
%													foreach my $score (@scores) {
%														if ($score->tag eq "rank") {
															<% $score->value %>
%														}
%													}
												</span>

												<span class="twothirds">
%													my $notfirst;
%													foreach my $score (sort {$a->speech <=> $b->speech} @scores) {
%														if ($score->tag eq "point") {
															<% $score->value %>
%						 								}
%														if ($score->tag eq "speech") {
															<% $notfirst++ ? ", " : "" %>
															<% $score->value %>
%						 								}
%					 								}
												</span>
%											}
										</span>
									</div>
%		 						}
							</td>
%						}

						<td class="centeralign flexrow">
							<span class="third">
								<a
									class="bluetext buttonwhite fa fa-sm fa-eye smallish"
									href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->{id} %>"
									title="View Section"
								></a>
							</span>

							<span class="third">
								<a
									class = "redtext buttonwhite fa fa-sm fa-retweet smallish"
									title = "Move manually into a different section"
									href  = "/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->{id} %>"
								></a>
							</span>

%							if ($event_type eq "speech") {
								<span class="third">
									<a
										class = "greentext buttonwhite fa fa-sm fa-plus smallish"
										title = "Move manually into a second section"
										href  = "/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->{id} %>&add=1"
									></a>
								</span>
%							}
						</td>
					</tr>
% 				}

%				unless (@{$panels}) {

					<tr class="row flexrow">
						<td
							class="smaller centeralign"
							data-text="<% $round->{name} %>"
						>
							<% $round->{label} || "Round ".$round->{name} %>
						</td>

						<td class="smaller" data-text="<% $round->{start_time} || $round->{ts_start} %>">
							<& "/funclib/showtime.mas",
								string => $round->{start_time} || $round->{ts_start}
							&>
						</td>

						<td colspan="8" class="nospace">
							<div class="full flexrow">
								<span class="half semibold redtext padleft">
									Not scheduled in
									<% $round->{label} || "Round ".$round->{name} %>
								</span>

								<span class="twofifths semibold bluetext rightalign">
									Schedule into round:
								</span>

								<span class="tenth padvertless centeralign">
									<a
										class = "bluetext buttonwhite fa fa-plus fa-sm smaller"
										href  = "/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->{id} %>"
										title = "Add Manually to <% $round->{label} || "Round ".$round->{name} %>"
									></a>
								</span>
							</span>
						</td>
					</tr>
% 				}
% 			}
			</tbody>
		</table>
%	}

	</div>

% 		if ($entry && $event_settings{"ask_quals"}) {

			<div class="pieceinfo <% $ARGS{"titles"} ? "" : "hidden" %> nospace">

				<h6 class="martop semibold">
					Qualifying Information
				</h6>

				<table class="nar">
					<tr class="ltyellow">
						<th class="smaller">

							<form
								action = "qual_save.mhtml"
								method = "post"
							>

							<input
								type  = "hidden"
								name  = "entry_id"
								value = "<% $entry->id %>"
							>
						</th>

						<th class="smaller">
							Tournament
						</th>

						<th class="smaller">
							Placement/Points
						</th>
					</tr>

%					my %qualifiers = eval { return %{$entry->setting("qualifiers")} };

%					foreach my $key (keys %qualifiers) {

						<tr class="row flexrow">
							<th>
								Qual <% $key %>.
							</th>

							<td>
								<input
									type  = "text"
									size  = "20"
									name  = "qual_<% $key %>_name"
									value = "<% $qualifiers{$key}{"name"} %>"
								>
							</td>

							<td>
								<input
									type  = "text"
									size  = "20"
									name  = "qual_<% $key %>_result"
									value = "<% $qualifiers{$key}{"result"} %>"
								>
							</td>
						</tr>
% 					}

					<tr class="row flexrow">
						<th>
							Add Qual:
						</th>

						<td>
							<input
								type = "text"
								size = "20"
								name = "qual_new_name"
							>
						</td>

						<td>
							<input
								type = "text"
								size = "20"
								name = "qual_new_result"
							>
						</td>
					</tr>

% 					if ($entry && $event_settings{"ask_quals"}) {
						<tr class="row flexrow">
							<th>
								<label for="atlarge">
									At-Large
								</label>
							</th>

							<td colspan="2" class="leftalign">
								<input
									id	= "atlarge"
									type  = "checkbox"
									name  = "atlarge"
									value = "1"
									<% $entry_settings{"atlarge"} ? 'checked="checked"' : "" %>
								>
							</td>
						</tr>
% 					}

					<tr class="libl">
						<td colspan="3" class="rightalign">
							<input
								type  = "submit"
								value = "Save Qualifiers"
							>
							</form>
						</td>
					</tr>
				</table>
			</div>
% 		}

	<script>
		function togglePieces() {
			$(".buttons").removeClass('invert');
			$(".notpieceinfo").toggleClass('hidden');
			$(".pieceinfo").toggleClass('hidden');
			$("#piecebutton").toggleClass('invert');
			fixVisual();
		}

		function fillInFree(code) {

			const already = $('#code').val();

			if (!already) {
				$('#code').val(code);
			}
		}

	</script>

<%perl>
		if (
			$event_settings{"ask_for_titles"}
			|| $event_settings{"ask_for_topic"}
			|| $event_settings{"ask_for_video"}
			|| $event_settings{"ask_for_manuscript"}
			|| $event_settings{"online_mode"} eq "async"
			|| $event_settings{"ask_for_bibliography"}
		) {

</%perl>
			<form
				action  = "title_save.mhtml"
				enctype = "multipart/form-data"
				method  = "post"
			>

			<input
				type  = "hidden"
				name  = "entry_id"
				value = "<% $entry->id %>"
			>

			<div class="pieceinfo <% $ARGS{"titles"} ? "" : "hidden" %> nospace martopmore">

%				if (
%					$event_settings{"online_mode"} eq "async"
%					|| $event_settings{"ask_for_videos"}
%				) {
					<div class="odd ltbordertop ltborderbottom">

						<span class="third semibold bluetext">
							<span class="twothirds nospace">
								Video Link
							</span>

							<span class="third centeralign nospace">
%							if ($entry_settings{"video_link"}) {
								<a  href   = "<% $entry_settings{"video_link"} %>"
									target = "_blank"
									class  = "buttonwhite bluetext fa fa-sm fa-link"
								></a>
%							}
							</span>
						</span>

						<span class="twothirds">
							<input
								type  = "text"
								size  = "64"
								name  = "video_link"
								value = "<% $entry_settings{"video_link"} %>"
							>
						</span>
					</div>
<%perl>
				}

				if ($event_settings{"ask_for_manuscript"}) {

					my $script = $entry_settings{"script_file"};
					my $history = $entry_settings{"script_history"};
</%perl>

					<h6>Script Upload History</h6>
<%perl>
					if ($history) {

					   foreach my $id (sort keys %{$history}) {

							my $uploader;

							if ($history->{$id}{"person"}) {
								$uploader = Tab::Person->retrieve($history->{$id}{"person"});
							}
</%perl>
							<div class="row flexrow padvertless">

								<span class="half">
									<span class="twenty semibold bluetext centeralign">
										#<% $id %>.
									</span>

									<span class="twenty centeralign fa fa-check greentext"></span>

									<a class = "greentext semibold link-underline marno padvertless yellowhover"
										   href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/scripts/".$entry->id."/$id/".$history->{$id}{"script"} %>"
									> <% $history->{$id}{"script"} %></a>
								</span>

%							   if ($history->{$id}{"uploaded"}) {
									<span class="half padvertless">
										<div class="full flexrow">
											<span class="half semibold">
												Uploaded at
												<% $m->comp('/funclib/showdt.mas', string => $history->{$id}{"uploaded"}) %>
											</span>
											<span class="hover half" title="<% $uploader ? $uploader->email : "" %>">
												<% $uploader ? "By ".$uploader->first." ".$uploader->last : "" %>
											</span>
										</div>
									</span>
%							   }
							</div>
%						}
%					}

%					if ($script) {
%						 my $script_dt = $entry_settings{"script_timestamp"};

						<div class="full flexrow padvert ltborder">
							<span class="quarter semibold redtext padleft">
								Latest copy
							</span>

							<span class="half">
								<a class = "greentext semibold"
								   href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/scripts/".$entry->id."/".$script %>"
								> <% $script %> </a>
							</span>

%						   if ($script_dt) {
								<span class="quarter nospace padvertless smallish">
									Uploaded at <% $m->comp('/funclib/showdt.mas', dt => $script_dt) %>
								</span>
%						   }
						</div>
%				   }

					<div class="full libl nospace padvertless flexrow marbottommore">
						<span class="quarter semibold bluetext padleft">
							Upload New Version
						</span>

						<span class="half padvert">
							<div class="uploader dynamic">
								<input
									type	 = "file"
									name	 = "<% $entry->id %>_script"
									style   = "opacity: 0;"
									onchange = "uploaderName(
										'<% $entry->id %>_script',
										'<% $entry->id %>_script_file'
									)"
									id	 = "<% $entry->id %>_script"
								>

								<span
									id  = "<% $entry->id %>_script_file"
									class = "filename"
									style = "-webkit-user-select: none;"
								>Upload File</span>

								<span
									class = "action"
									style = "-webkit-user-select: none;"
								>Choose File</span>
							</div>
						</span>

						<span class="quarter padleftmore">
							<input
								type  = "submit"
								value = "Upload"
							>
						</span>
					</div>
%				}


%				if ($event_settings{"ask_for_titles"}) {
					<div class="row flexrow">
						<span class="third padleft">
							Piece Title
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								size  = "64"
								name  = "title"
								value = "<% $entry_settings{"title"} %>"
							>
						</span>
					</div>
%				}

%				if ($event_settings{"ask_for_topic"}) {
					<div class="row flexrow">
						<span class="third padleft">
							Speech Topic
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								size  = "64"
								name  = "topic"
								value = "<% $entry_settings{"topic"} %>"
							>
						</span>
					</div>
%				}

%				if ($event_settings{"ask_for_bibliography"}) {
					<& "/funclib/editor.mas", half => 1 &>

					<div class="row flexrow">
						<span class="third padleft">
							Bibliography
						</span>

						<span class="twothirds padright">
							<textarea
								rows  = "5"
								cols  = "65"
								class = "half"
								name  = "bibliography"
							><% $entry_settings{"bibliography"} %></textarea>
						</span>
					</div>
%				}

%				if ($event_settings{"ask_for_authors"}) {
					<div class="row flexrow">
						<span class="third padleft">
							Piece Author
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								size  = "64"
								name  = "author"
								value = "<% $entry_settings{"author"} %>">
						</span>
					</div>
%				}

%				if ($event_settings{"ask_for_publication"}) {

					<div class="row flexrow">
						<span class="third padleft">
							Publisher
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								name  = "publisher"
								value = "<% $entry_settings{"publisher"} %>"
								size  = "64"
							>
						</span>
					</div>

					<div class="row flexrow">
						<span class="third padleft">
							Publication Year
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								name  = "publish_date"
								value = "<% $entry_settings{"publish_date"} %>"
								size  = "64"
							>
						</span>
					</div>

					<div class="row flexrow">
						<span class="third padleft">
							ISBN Number
						</span>

						<span class="twothirds padright">
							<input
								type  = "text"
								name  = "publish_isbn"
								value = "<% $entry_settings{"publish_isbn"} %>"
								size  = "64"
							>
						</span>
					</div>

					<div class="row flexrow">
						<span class="third padleft">
							Date the web page was printed:
						</span>

						<& /funclib/datepicker.mas, id => "publish_print_date" &>

%						my $publish_print_date = $entry_settings{"publish_print_date"};

						<span class="twothirds padright">
							 <input
								type  = "text"
								name  = "publish_print_date"
								id	= "publish_print_date"
								size  = "16"
								value = "<% Tab::pickerdate($publish_print_date) %>"
							>
						</span>
					</div>

					<div class="row flexrow">
						<span class="third padleft">
							URL (web address)
						</span>

						<span class="twothirds padright">
							<input
								type  = "url"
								name  = "publish_url"
								value = "<% $entry_settings{"publish_url"} %>"
								size  = "64"
							>
						</span>
					</div>
%				}

				<div class="libl row rightalign marno">
					<span class="third centeralign">
						<input type="submit" value="Save Piece Info">
					</span>
				</div>

				</form>
			</div>
%		}

%		if ($entry_settings{"supp_log"}) {
			<div class="full ltbordertop">
				<h5>Supp Re-Registration Log</h5>
				<p>
					<% $entry_settings{"supp_log"} %>
				</p>
			</div>
%		}

	</div>

	<div class="menu">

%		if ( $perms->{tourn}{$tourn} eq "limited") {
%			my %school_settings = $school->all_settings();
<%perl>
			my $contacts = $m->comp("/funclib/contacts.mas",
				school => $school,
				return => 'yaskween',
			);
</%perl>
			<div class="sidenote">

				<h4 class="semibold">School Contacts</h4>

%				foreach my $contact (@{$contacts}) {
%					next unless $contact->{official};
					<div class="row flexrow">
						<span class="quarter semibold <% $contact->{onsite} ? "bluetext" : "redtext" %> padleft">
							<% $contact->{onsite}
								? "Onsite"
								: "Offsite"
							%>
						</span>
						<span class="threequarters nospace">
							<div class="full padvertless ltborderbottom">
								<% $contact->{first} %>
								<% $contact->{middle} %>
								<% $contact->{last} %>
								<% $contact->{onsite} ? "" : "(Off-Site)" %>
							</div>

							<div class="full padtopless hover ltborderbottom"
								onClick = "copyToClipboard('<% $contact->{phone} %>', 'Phone');"
							>
								<% Tab::phoneme($contact->{phone}) %>
							</div>

							<div class="full nospace hover">
								<a
									href  = "mailto:<% $contact->{email_address} %>"
									class = "hover link-underline padleft plain padless marno"
								><% $contact->{email_address} %></a>
							</div>
						</span>
					</div>
%				}
			</div>
%		}

		<div class="sidenote">

%			unless ( $perms->{tourn}{$tourn} eq "limited") {

% 				if ($tourn_settings->{"ncfl"}) {
					<a
						class = "blue marno full"
						href  = "/register/region/tourn_entries.mhtml?region_id=<% $region->id %>&event_id=<% $event %>"
					>
						<% $region->name %> Entries
					</a>
%				}

				<a
					class = "blue half"
					href  = "/register/school/entries.mhtml?school_id=<% $school->id %>"
				>
					School entries
				</a>

				<a
					class = "blue half"
					href  = "/register/event/roster.mhtml?event_id=<% $event->id %>&sort=school"
				>
					Event entries
				</a>

%			} else {
				<a
					class = "blue full"
					href  = "/register/event/roster.mhtml?event_id=<% $event->id %>&sort=school"
				>
					<% $event->abbr %> entries
				</a>
%			}

			<h4 class="marbottomless martopless">Details</h4>

% 			if ( $event_settings{"usa_wsdc"} ) {

				<a
					class = "blue full nowrap"
					href  = "/register/reports/usa_debate.mhtml?district_id=<% $entry->school->district->id %>"
				>
					<span class="quarter">
						Info Sheet
					</span><span class='threequarters rightalign'>
						<% $entry->code %>
					</span>
				</a>

% 			} elsif ($tourn_settings->{"ncfl"}) {
				<a
					class = "blue full"
					href  = "/funclib/ncfl/print_entry_card.mhtml?entry_id=<% $entry->id %>"
				>
					Print <% $entry->code %> NCFL Card
				</a>

%			} else {

				<a
					class = "blue half nowrap"
					href  = "print.mhtml?entry_id=<% $entry->id %>"
				>
					Entry Dance Card
				</a>

				<a
					class = "blue half nowrap"
					href  = "student_print.mhtml?entry_id=<% $entry->id %>"
				>
					Student Dance Cards
				</a>
%			}

%			if ($tourn_settings->{"legion"}) {
				<a
					class = "martop marbottom blue full"
					href  = "/tabbing/report/legion_report.mhtml?school_id=<% $school->id %>"
				>Legion Results Sheet</a>
%			}

%			if ($category_settings{"prefs"}) {
				<a
					class = "yellow half "
					href  = "prefs.mhtml?entry_id=<% $entry->id %>&sort=school"
				>Pref Sheet</a>
%			} else {
				<a
					class = "yellow half marbottom"
					href  = "strikes.mhtml?entry_id=<% $entry->id %>"
				>Strikes &amp; Conflicts</a>
%			}

			<a
				class = "yellow half marbottom"
				href  = "log.mhtml?entry_id=<% $entry->id %>"
			>Entry Log</a>

<%perl>
			my @followers = $m->comp("/funclib/entry_follower.mas",
				entry    => $entry,
				accounts => 1
			);
</%perl>

%			if (@followers) {
				<a
					class = "yellow half marbottom"
					href  = "followers.mhtml?entry_id=<% $entry->id %>"
				>
					<% scalar @followers %> Followers
				</a>
%			}

%			if ($tourn_settings->{nsda_nats} && $event_settings{supp} && (not defined $ok{$entry->id})) {

				<div class = "row centeralign semibold padvert redtext ">
					<span class="inline fa fa-arrow-left padrightless"></span>Activate Supps using Change Status
				</div>

%			} else {

				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_dropped">
						<span class="threequarters padleft semibold biggish redtext">
							Drop &amp; Stop Scheduling
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_dropped"
									property_name = "dropped"
									entry_id     = "<% $entry->id %>"
									onChange      = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('dropped');"
									<% $entry->dropped ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}
<%perl>
			if (
				( $event_settings{"waitlist"}
					|| $event_settings{"school_cap"}
					|| $event_settings{"waitlist_all"}
				) && (not defined $event_settings{"no_waitlist"})
			) {
</%perl>
				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_waitlist">
						<span class="threequarters padleft">
							Waitlisted
							<span class="inline italic">&ndash; Notifies coaches</span>
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_waitlist"
									property_name = "waitlist"
									entry_id     = "<% $entry->id %>"
									onChange      = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('waitlist');"

									<% $entry->waitlist ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($category_settings{"prefs"}) {

				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_open_prefs">
						<span class="threequarters padleft">
							Open prefs despite deadline
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type		 = "checkbox"
									value		= "1"
									id		   = "<% $entry->id %>_open_prefs"
									setting_name = "open_prefs"
									entry_id	= "<% $entry->id %>"
									onChange	 = "postSwitch(this, 'entry_switch.mhtml'); statusSwitch('open_prefs');"
									<% $entry_settings{"open_prefs"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

<%perl>
			if (
				$event_settings{"online_hybrid"} || (1 == 1)
			) {
</%perl>
				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_ada">
						<span class="threequarters padleft">
							ADA rooms
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_ada"
									property_name = "ada"
									entry_id     = "<% $entry->id %>"
									onChange      = "postSwitch(
										this,
										'entry_switch.mhtml'); statusSwitch('ada');"
									<% $entry->ada ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</label>
				</div>

				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_online_hybrid">
						<span class="threequarters padleft">
							Online Entry (Hybrid)
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_online_hybrid"
									setting_name = "online_hybrid"
									entry_id    = "<% $entry->id %>"
									onChange     = "postSwitch(this, 'entry_switch.mhtml'); statusSwitch('online_hybrid');"
									<% $entry_settings{"online_hybrid"} ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</label>
				</div>
<%perl>
			} elsif (
				not defined ($event_settings{"online_mode"})
				|| $event_settings{"online_mode"} eq "none"
			) {
</%perl>
				<div class = "row flexrow nospace">
					<label for="<% $entry->id %>_ada">
						<span class="threequarters padleft">
							ADA rooms
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_ada"
									property_name = "ada"
									entry_id      = "<% $entry->id %>"
									onChange      = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('ada');"
									<% $entry->ada ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			my $warn = "Settings this to Y will cause this entry not to clear ";
%			$warn .= "to clear to the first elim break no matter their seed.";

				<div
					title = "<% $warn %>"
					class = "row hover flexrow nospace"
				>
					<label = "<% $entry->id %>_no_elims">
						<span class="threequarters padleft">
							Ineligible for Elims
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_no_elims"
									setting_name = "no_elims"
									entry_id    = "<% $entry->id %>"
									onChange	 = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('no_elims');"
									<% $entry_settings{"no_elims"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>

%			if ($tourn_settings->{"nsda_district"}) {

%				$warn = "Setting this will mean this entry will not qualify to ";
%				$warn .= "nationals; set this if they've qualified in a higher priority event.";

				<div
					title = "<% $warn %>"
					class = "full nospace row hover"
				>
					<label for="<% $entry->id %>_nsda_vacate">
						<span class="threequarters padleft">
							Vacate spot to Nationals
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_nsda_vacate"
									setting_name = "nsda_vacate"
									entry_id    = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('vacate');"
									<% $entry_settings{"nsda_vacate"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($tourn_settings->{"nsda_district"} == 999) {
				<div
					title = "<% $warn %>"
					class="full nospace row hover"
				>
					<label = "<% $entry->id %>_lcq_bonus">
						<span class="threequarters padleft">
							LCQ Bonus Qual
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_lcq_bonus"
									setting_name = "lcq_bonus"
									entry_id    = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml');"
									<% $entry_settings{"lcq_bonus"} ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($tourn_settings->{"nsda_nats"}) {
				<div
					title = "<% $warn %>"
					class="flexrow nospace row hover"
				>
					<label = "<% $entry->id %>_autoqual">
						<span class="threequarters padleft">
							Auto-qualifier
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_autoqual"
									setting_name = "autoqual"
									entry_id    = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('autoqual');"

									<% $entry_settings{"autoqual"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($tourn->sweep_sets) {

%				$warn = "Setting this will mean this entry will not qualify for team award points";

				<div
					title = "<% $warn %>"
					class = "nospace row hover flexrow"
				>
					<label for="<% $entry->id %>_exclude_from_sweeps">
						<span class="threequarters padleft">
							Exclude from Sweepstakes
						</span>

						<span class="quarter nospace">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_exclude_from_sweeps"
									setting_name = "exclude_from_sweeps"
									entry_id    = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('exclude_from_sweeps');"
									<% $entry_settings{"exclude_from_sweeps"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
<%perl>
			}

			if ($event_type eq "speech") {

				$warn = "You are about to disqualify this entry.  In IEs, other entries in ";
				$warn .= "the same section as this one will be promoted one rank if they scored ";
				$warn .= "below this entry in all rounds.  You can undo this if you change your mind.";
</%perl>

				<div
					title = "<% $warn %>"
					class = "nospace row hover flexrow"
				>
					<label for="<% $entry->id %>_dq">
						<span class="threequarters padleft">
							Disqualify <%
								$tourn_settings->{"nsda_district"} || $tourn_settings->{nsda_nats}
								? ""
								: "(by NCFL Rule)"
							%>
						</span>
						<span class="quarter">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_dq"
									setting_name = "dq"
									entry_id     = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('dq');"
									<% $entry_settings{"dq"} ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($event_type eq "congress") {
				<div
					title = "<% $warn %>"
					class = "nospace row hover flexrow"
				>
					<label for="<% $entry->id %>_po">
						<span class="threequarters padleft">
							Presiding Officer Nominee
						</span>

						<span class="quarter">
							<label class="switch smaller">
								<input
									type         = "checkbox"
									value        = "1"
									id           = "<% $entry->id %>_po"
									setting_name = "po"
									entry_id     = "<% $entry->id %>"
									onChange     = "postSwitch( this, 'entry_switch.mhtml'); statusSwitch('po');"
									<% $entry_settings{"po"} ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</label>
				</div>
%			}

%			if ($max_flights > 1 && $entry_id) {
					<div
						title = "Locking flights is not perfect!  If they hit another locked entry, etc, it can drift.  Please check!"
						class = "row flexrow nospace"
					>
						<span class="threequarters padleft">
							Lock to flight
						</span>

						<span class="quarter nospace padright">
							<select
								name         = "flight"
								class        = "fixedsmall"
								entry_id    = "<% $entry_id %>"
								setting_name = "preferred_flight"
								onChange     = "postSwitch(this, 'entry_switch.mhtml');"
							>
								<option value="">None</option>
%						  		foreach my $flight ( 1 .. $max_flights) {
									<option
										value="<% $flight %>"
										<% $flight == $entry_settings{"preferred_flight"} ? "selected" : "" %>
									> <% $flight %> </option>
%								}
							</select>
						</span>
					</div>
%			}
%			if ($tourn_settings->{"vaccines"} && ($perms->{"owner"} || $person->site_admin)) {

				<h5>Vaccine Status</h5>
<%perl>
				foreach my $student ($entry->students) {
					next unless $student->person;
					my $status = $student->person->setting("vaccine_".$tourn->id);
					my $exempt = $student->person->setting("exempt_".$tourn->id);
</%perl>
					<div class="row ltborderbottom">
						<span class="twenty centeralign fa fa-tiny padleftless <% $status eq "confirmed" ? "fa-check greentext" : "fa-times redtext" %>"></span>
						<span class="twofifths">
							<% $student->first." ".$student->last %>
						</span>
						<span class="twofifths nospace centeralign padvertless">
%							unless ($student->person) {
								<div class="full redtext semibold centeralign">
									No Tabroom Account
								</div>
%							} else {
								<select
									name         = "<% $student->person %>"
									class		 = "plain smallish marno padno"
									style		 = "height: 22px;"
									setting_name = "vaccine"
									person_id    = "<% $student->person %>"
									onChange     = "postSwitch(this, '/register/reports/vaccine_switch.mhtml');"
								>
									<option value="none">Not Started</option>
									<option <% $status eq "confirmed" ? "selected" : "" %> value="confirmed">Confirmed</option>
									<option <% $status eq "pending" ? "selected" : "" %> value="pending">Pending</option>
								</select>
%							}
						</span>
						<span class="tenth nospace centeralign" title="Exempt">
							<& "/funclib/bool_switch.mas",
								person_id    => $student->person,
								tag          => "exempt",
								url          => "/register/reports/vaccine_switch.mhtml",
								value        => $exempt,
								tiny         => 1,
								onred        => 1
							&>
						</span>
					</div>
%				}
%			}
			<a
				class = "flexrow blue padvert padleft martop"
				href  = "entry_ballot_notes.mhtml?entry_id=<% $entry->id %>"
			>
				Ballot Notes for ADA/Accommodations
			</a>

		</div>

		<div class="sidenote">

			<span class="fourfifths nospace">
				<h4>Swap Competitors</h4>
			</span>

			<span class="fifth rightalign">
				<a
					href  = "/register/school/student_add.mhtml?all=yep&school_id=<% $school->id %>&from_entry=<% $entry->id %>"
					class = "fa buttonwhite greentext fa-plus invert"
					title = "Add competitor not on roster"
				><a>
			</a>

			</span>

			<form
				action = "change.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "entry_id"
				value = "<% $entry_id %>"
			>

			<input
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>
<%perl>

			my %clean_students;
			my @clean_students;

			if ($event_settings{"usa_wsdc"}) {

				%clean_students = $m->comp(
					"/funclib/students_evententer.mas",
					tourn		 => $tourn,
					event		 => $event,
					school		=> $school,
				);

			} else {

				my $skip;
				$skip++ if $person->site_admin;
				$skip++ if $person_settings->{"nsda_admin"};

				@clean_students = $m->comp(
					"/funclib/students_evententer.mas",
					tourn		 => $tourn,
					event		 => $event,
					school		=> $school,
					skip_district => $skip
				);
			}

			my $count = 1;
			my $max_entry = $event_settings{"max_entry"} || 1;

			foreach my $student (@students) {
</%perl>


				<div class="row marvertno">

					<span class="sixth nospace padleft">
						<% $count++ %>
					</span>

					<span class="fivesixth nospace">

						<select
							name	 = "<% $student->id %>"
							onchange = 'this.form.submit();'
							class	= "fixedmedsmall"
						>

							<option
								value="<% $student->id %>"
							><% $student->last.", ".$student->first %></option>

							<option value="0">No Competitor/Maverick</option>

<%perl>

							if ($event_settings{"usa_wsdc"}) {

								my $last_chapter;

								foreach my $other_id (
									sort {
										$clean_students{$a}{chapter_name} cmp $clean_students{$b}{chapter_name}
										|| $clean_students{$a}{last} cmp $clean_students{$b}{last}
									} keys %clean_students
								) {

									if ($last_chapter != $clean_students{$other_id}{"chapter_id"}) {
										$m->print('</optgroup>');
										$m->print('<optgroup label="'.$clean_students{$other_id}{"chapter_name"}.'">');
										$last_chapter = $clean_students{$other_id}{"chapter_id"};
									}
</%perl>
									<option
										value="<% $other_id %>"
									><%
										 $clean_students{$other_id}{"last"}.", "
										.$clean_students{$other_id}{"first"}." "
									   	.$clean_students{$other_id}{"middle"}
									%></option>
<%perl>
								}
								$m->print('</optgroup>') if $event_settings{"usa_wsdc"};
							} else {

								foreach my $other_student (@clean_students) {
									next if $entry_students{$other_student->id};
</%perl>
									<option
										value="<% $other_student->id %>"
									> <% $other_student->last.", ".$other_student->first %> </option>
%								}
%							}
						</select>
					</span>
				</div>
%			}
%			if (scalar @students < $max_entry) {

				<div class="row flexrow">
					<span class="sixth nospace padleft">
						<% $count++ %>:
					</span>

					<span class="fivesixth nospace">
						<select
							name	 = "new"
							onchange = 'this.form.submit()'
							class	= "fixedmedsmall"
						>

							<option value="">
								Add student
							</option>

							<option value="0">No Partner/Maverick</option>
<%perl>
							if ($event_settings{"usa_wsdc"}) {

								my $last_chapter;

								foreach my $other_id (
									sort {
										$clean_students{$a}{chapter_name} cmp $clean_students{$b}{chapter_name}
										|| $clean_students{$a}{last} cmp $clean_students{$b}{last}
									} keys %clean_students
								) {

									if ($last_chapter != $clean_students{$other_id}{"chapter_id"}) {
										$m->print('</optgroup>');
										$m->print('<optgroup label="'.$clean_students{$other_id}{"chapter_name"}.'">');
										$last_chapter = $clean_students{$other_id}{"chapter_id"};
									}
</%perl>
									<option
										value="<% $other_id %>"
									><%  $clean_students{$other_id}{"first"}." "
									   .$clean_students{$other_id}{"middle"}." "
									   .$clean_students{$other_id}{"last"}
									%></option>
<%perl>
								}

								$m->print('</optgroup>') if $event_settings{"usa_wsdc"};

							} else {

								foreach my $other_student (@clean_students) {
									next if $entry_students{$other_student->id};
</%perl>
									<option
										value="<% $other_student->id %>"
									> <% $other_student->last.", ".$other_student->first %> </option>
%								}
%							}
						</select>
					</span>
				</div>
%			}

			<noscript>
				<div class="libl rightalign">
					<input
						type  = "submit"
						class = "thin"
						value = "Save Changes">
				</div>
			</noscript>

			</form>

%			unless ($perms->{tourn}{$tourn} eq "limited") {

				<h4 class="martop">Swap Entry</h4>

				<form
					action = "change_event.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "entry_id"
					value = "<% $entry_id %>"
				>

				<div class="row flexrow">
					<span class="fifth semibold bluetext padleft">
						Event
					</span>
					<span class="threefifths padleft padright">
						<select name  = "event_id">
%							foreach my $event (sort {$a->name cmp $b->name} $tourn->events) {
								<option
									value="<% $event->id %>"
									<% $event->id == $entry->event->id ? "selected" : "" %>
								> <% substr($event->name,0,32) %> </option>
%							}

						</select>
					</span>

					<span class="fifth centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Swap"
						>
					</span>
				</div>
				</form>
%			}

			<form
				action = "school.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "entry_id"
				value = "<% $entry->id %>"
			>

			<div class="flexrow row">
<%perl>
				my $limit = "and school.region = ? ";

				my $sth = $dbh->prepare("
					select school.id, school.name, school.code,
						region.id, region.name, region.code
					from (school)
					left join region on school.region = region.id
						where school.tourn =?
					order by school.name
				");

				my %schools;

				$sth->execute($tourn->id);

				while (
					my (
						$school_id, $school_name, $school_code,
						$region_id, $region_name, $region_code
					) = $sth->fetchrow_array()
				) {

					$schools{$school_id}{name} = Tab::short_name($school_name);

					unless ($school_code eq  $schools{$school_id}{"name"}) {
						$schools{$school_id}{code} = $school_code;
					}
					$schools{$school_id}{region} = $region_id;
					$schools{$school_id}{region_name} = $region_name;
					$schools{$school_id}{region_code} = $region_code;
				}

				my $dio_id = $region->id if $region;
</%perl>
				<span class="fifth semibold bluetext padleft">
					School
				</span>
				<span class="threefifths padleft padright">
					<select name="school_id" >
<%perl>
						foreach my $other_id (
							sort {$schools{$a}{name} cmp $schools{$b}{name}
							} keys %schools
						) {

							next if $tourn_settings->{ncfl}
								&& $schools{$other_id}{region} != $dio_id;
</%perl>

							<option value="<% $other_id %>"
								<% $other_id == $school->id ? "selected" : "" %>
							><% $schools{$other_id}{"name"} %></option>
%						}

					</select>
				</span>

				<span class="fifth centeralign">
					<input
						type  = "submit"
						class = "thin"
						value = "Swap"
					>
				</span>
			</div>

			</form>
<%perl>
			my $now = DateTime->now(time_zone => $tz);
			my $start = $tourn->start;
			$start->set_time_zone($tz);

			if ($start->epoch > $now->epoch || $person->site_admin) {

				my $warn = "This function will delete ANY RECORD of this entry, including results, ";
				$warn .= "history, opponent's records, and so on.  Please be sure you mean to do ";
				$warn .= "all these things before continuing.  <br /><br />It is much safer and ";
				$warn .= "more harmless to just hit Drop/Stop Scheduling above.";

</%perl>
				<div class="full centeralign padtopmore">

					<h5 class='ltborderbottom leftalign'>Potential Permanent Damage</h5>

					<a class = "buttonwhite redtext centeralign invert redbordertop"
						href = "delete.mhtml?entry_id=<% $entry->id %>"
						<& "/funclib/confirm.mas", warn => $warn &>
					>
						DELETE ENTRY COMPLETELY?!
					</a>

				</div>
%			}

		</div>
	</div>
