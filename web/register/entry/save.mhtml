<%args>
	$tourn
	$tourn_settings
	$person
	$entry_id     => undef
	$name         => undef
	$code         => undef
	$ada          => undef
	$seed         => undef
	$pairing_seed => undef
	$atlarge      => undef
	$pod          => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);
	$m->abort() unless $entry;

	my $school = $entry->school;

	my $now = DateTime->now();

	if ($name && $name ne $entry->name) {

		my @existing = Tab::Entry->search(
			name        => $name,
			tourn       => $tourn->id,
			unconfirmed => 0
		);

		foreach  (@existing) {
			next if $_->id == $entry_id;
			my $err = "An entry with name $name already exists.  Names must be unique.";
			$m->redirect("edit.mhtml?entry_id=$entry_id&err=$err");
		}

		$entry->name($name);
		$entry->update;
	}

	my $event = $entry->event;
	my %event_settings = $event->all_settings;

	my $code_setting = $event_settings{"code_style"};

	$code =~ s/[^\w\s&-\/]//g;

	if ($code ne $entry->code) {

		my @existing;

		if ($code && (not defined $tourn_settings->{"nonunique_entry_codes"}))  {

			push @existing, $m->comp(
				"/funclib/entry_by_code.mas",
				tourn => $tourn,
				code  => $code
			);

			push @existing, $m->comp(
				"/funclib/judge_by_code.mas",
				tourn => $tourn,
				code  => $code
			);

		}

		if (@existing) {

			my $err = "An entry or judge with code $code already exists.  Codes must be unique.  @existing";
			$m->redirect("edit.mhtml?entry_id=$entry_id&err=$err");

		} elsif ($code eq "Team Scorpion") {

			my $err = "That team name was retired in 2008.  Choose another";
			$m->redirect("edit.mhtml?entry_id=$entry_id&err=$err");

		} else {

			$entry->code($code);
		}

	}

	$entry->ada($ada);
	$entry->update;

	$entry->setting("registered_seed", $seed);
	$entry->setting("atlarge", $atlarge);

    if ($seed eq "full") {
        $entry->setting("pairing_seed", 1);
    } elsif ($seed eq "half") {
        $entry->setting("pairing_seed", 2);
    } elsif ($seed eq "free") {
        $entry->setting("pairing_seed", 3);
    } elsif ($event_settings{"apda"}) {
        $entry->setting("pairing_seed", 4);
    } else {
		$entry->setting("pairing_seed", $pairing_seed);
    }

	$entry->setting("pod", $pod);

	foreach my $field (
		"title",
		"topic",
		"author",
		"bibliography",
		"publisher",
		"publish_date",
		"publish_isbn",
		"publish_print_date",
		"publish_url",
	) {

		my $text = $m->comp(
			"/funclib/save_editor.mas",
			text => $ARGS{$field}
		);

		$entry->setting($field, $text);

	}

	if ($person->site_admin) {
		my $jot_id = $ARGS{"jot_id"};
		$jot_id = 0 unless $jot_id;
		$entry->setting("jot_id", $ARGS{"jot_id"});
	}

	if ($tourn_settings->{"nsda_district"}
		|| $tourn_settings->{"nsda_ms_nats"}
		|| $tourn_settings->{"nsda_nats"}
	) {

		$entry->setting("publisher", $ARGS{"publisher"});
		$entry->setting("publish_date", $ARGS{"publish_date"});
		$entry->setting("publish_isbn", $ARGS{"publish_isbn"});
		$entry->setting("publish_url", $ARGS{"publish_url"});

		$entry->setting("nsda_house_bloc", $ARGS{"nsda_house_bloc"});

		if ($ARGS{"publish_print_date"}) {
			my $tz = $tourn->tz;
			$tz = "UTC" unless $tz;
			my $time = "12:00 PM";
			my $published_dt = Tab::dtme($ARGS{"publish_print_date"}, $time, $tz);
			$entry->setting("publish_print_date", "date", $published_dt);
		} else {
			$entry->setting("publish_print_date", 0);
		}
	}

	if ($tourn_settings->{"nsda_nats"}) {

		$entry->setting("coach_points", $ARGS{"coach_points"});

		$entry->setting("coach_points", $ARGS{"coach_points_merit"})
			if $ARGS{"coach_points_merit"};
	}

	if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"} ) {
		$entry->setting("coach_script", $ARGS{"coach_script"});
	}

	if ($event_settings{"breakouts"}) {

		foreach my $breakout (1 .. $event_settings{"breakouts"}) {

			next if $event_settings{"breakout_".$breakout."_delete"};

			$entry->setting("breakout_".$breakout, $ARGS{"breakout_".$breakout})
				if $ARGS{"breakout_".$breakout};

			$entry->setting("breakout_".$breakout, 0)
				unless $ARGS{"breakout_".$breakout};
		}
	}

	my $msg = "Entry information updated";

	if ($tourn_settings->{'nsda_nats'}) {

		if ($event_settings{"supp"} || $event_settings{"conn"}) {

			$entry->setting("reregistered", $ARGS{"reregistered"});

		} else {

			if ($ARGS{"entry_status"} eq "accepted") {

				$entry->unconfirmed(0);
				$entry->update();

				$entry->setting('accepted_by', $person->id);
				$entry->setting('accepted_at', "date", $now);

				$entry->setting('rejected_by', 0);
				$entry->setting('rejected_at', 0);

				$msg .= ".  Entry marked accepted";

			} elsif ($ARGS{"entry_status"} eq "rejected") {

				$entry->unconfirmed(1);
				$entry->update();

				$entry->setting('accepted_by', 0);
				$entry->setting('accepted_at', 0);

				$entry->setting('rejected_by', $person->id);
				$entry->setting('rejected_at', "date", $now);


				$msg .= ".  Entry marked rejected and next alternate WAS promoted";

		        my $msg = $m->comp(
		            "/funclib/promote_slot.mas",
			            entry  => $entry,
			            person => $person
		        );

			} elsif ($ARGS{"entry_status"} eq "rejected_no_promotion") {

				$entry->unconfirmed(1);
				$entry->update();

				$entry->setting('accepted_by', 0);
				$entry->setting('accepted_at', 0);
				$entry->setting('rejected_by', $person->id);
				$entry->setting('rejected_at', "date", $now);

				$msg .= ".  Entry marked rejected and next alternate was NOT promoted";

			} elsif ($ARGS{"entry_status"} eq "pending") {

				$entry->unconfirmed(1);
				$entry->update();

				$entry->setting('accepted_by', 0);
				$entry->setting('accepted_at', 0);
				$entry->setting('rejected_by', 0);
				$entry->setting('rejected_at', 0);

				$msg .= ".  Entry marked pending ";
			}


			if (
				$ARGS{"entry_status"} eq "rejected_no_promotion"
				|| $ARGS{"entry_status"} eq "rejected"
			) {

				my $tz = $tourn->tz;
				$tz = "UTC" unless $tz;

				my $fifty_percent_deadline = $tourn_settings->{"fifty_percent_deadline"};
				$fifty_percent_deadline->set_time_zone($tz) if $fifty_percent_deadline;

				my $hundred_percent_deadline = $tourn_settings->{"hundred_percent_deadline"};
				$hundred_percent_deadline->set_time_zone($tz) if $hundred_percent_deadline;

				my $now = DateTime->now(
					time_zone => $tz
				);

				my $created = $entry->created_at;
				$created->add(days => 7);

				my $fee = $entry->event->fee;

				if ($tourn->hotels()) {

					my $hotel = eval {
						return Tab::Hotel->retrieve($school->setting("hotel"));
					};

					if ($hotel) {
						if ($hotel->surcharge) {
							foreach my $student ($entry->students) {
								$fee = $fee += $hotel->surcharge;
							}
						} elsif ($hotel->multiple) {
							$fee = $fee * $hotel->multiple;
						}
					}
				}

				if ($created > $now) {

					# No fee for recently promoted alternates being dropped

				} elsif ( $hundred_percent_deadline && $hundred_percent_deadline < $now) {

					my $drop_reason = "Dropped entry ".$entry->name." in ".$entry->event->abbr." after the ".$hundred_percent_deadline->month."/".$hundred_percent_deadline->day." deadline";

					my $fine = Tab::Fine->create({
						school    => $school->id,
						amount    => $fee,
						reason    => $drop_reason,
						levied_at => $now,
						levied_by => $person->id
					});

					$msg .= " and the full late drop fine was assessed ";

				} elsif ( $fifty_percent_deadline && $fifty_percent_deadline < $now) {

					my $drop_reason = "Dropped entry ".$entry->name." in ".$entry->event->abbr." after the ".$fifty_percent_deadline->month."/".$fifty_percent_deadline->day." deadline";

					my $fine = Tab::Fine->create({
						school    => $school->id,
						amount    => ($fee / 2),
						reason    => $drop_reason,
						levied_at => $now,
						levied_by => $person->id
					});

					$msg .= " and a 50% late drop fine was assessed ";

				}
			}
		}

		foreach my $student ($entry->students) {
			$m->comp("/funclib/status_check.mas",
				school  => $school,
				student => $student
			);
		}

	}

	$m->redirect("edit.mhtml?entry_id=$entry_id&msg=$msg");

</%init>
