<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$mode        => undef
	$category_id => undef
</%args>
<%init>

	my @judges;

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	if ($category) { 
		$m->abort unless $category->tourn->id == $tourn->id;
	}

	if ($category) { 
		@judges = Tab::Judge->search( category => $category->id,);
	} else { 
		@judges = $m->comp("/funclib/tourn_judges.mas", tourn => $tourn,);
	}

	my %judge_panels;

	foreach my $judge (@judges) { 
		@{$judge_panels{$judge->id}} = $m->comp(
			"/funclib/judge_panels.mas", 
			judge => $judge
		);
	}


	if ($mode eq "csv") { 

		my $name = $tourn->name;
		$name =~ s/[\W_]//g;
		my $filename = "JudgedRounds-$name.csv";

		$m->clear_buffer;
		$r->content_type('application/csv');
		$r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

		$m->print("First, Last, School, Email, Phone, ");
		$m->print("Category, Rounds Judged, Round Details \n");

		foreach my $judge (sort {$a->last cmp $b->last} @judges) {

			$m->print('"'.$judge->first.'",');
			$m->print('"'.$judge->last.'",');

			if ($judge->school) {
				$m->print('"'.$judge->school->name.'",');
			} else {
				$m->print('"hired", ');
			}

			if ($judge->person) { 
				$m->print('"'.$judge->person->email.'",');
				$m->print('"'.$judge->person->phone.'",');
			} else {
				$m->print('"'.$judge->setting("email").'",');
				$m->print('"'.$judge->setting("phone").'",');
			}

			$m->print('"'.$judge->category->abbr.'",');
			$m->print('"'.scalar @{$judge_panels{$judge->id}});
		
			foreach my $panel (@{$judge_panels{$judge->id}}) { 

				$m->print('",');

				$m->print('"'.$panel->eventname.' ');

				if ($panel->roundlabel) { 
					$m->print($panel->roundlabel.' ');
				} else { 
					$m->print("Rnd ".$panel->roundname.' ');
				}

				$m->print("Flt ".$panel->flightname) if $panel->flightname > 1;

			}

			$m->print('"');
			$m->print("\n");

		} # end of foreach school

		$m->flush_buffer();
		$m->abort();

	}

	if ($mode eq "pdf") { 

		my $name = $tourn->name;
		$name =~ s/[\W_]//g;
		my $filename = "JudgedRounds-$name-".$session->id;

	    my $filepath = $Tab::file_root."/tmp/".$filename;
	    my $garbage = `rm -f $filename.*`;

	    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1 );

	    open (TEXOUT, ">>$filepath.tex");

		print TEXOUT "\\hfill {\\bf \\huge ".$tourn->name." } \n";
		print TEXOUT "\\medskip \n\n";
		print TEXOUT "\\hfill {\\bf \\Large Judge Report }\n\n";

		print TEXOUT "\\noindent \n";

		my $tabular = "\\begin{tabular}{p{1in}p{1in}p{1.5in}p{1in}p{1in}p{.5in}}\n";
		my $end_tabular = "\\end{tabular} \n \\newline\n";

		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{1,.95,.74}\n";
		print TEXOUT "First & Last & Email & Phone & Category & Rounds \n";
		print TEXOUT $end_tabular;

		my $switch;

		foreach my $judge (sort {$a->last cmp $b->last} @judges) {

			print TEXOUT $tabular;

			print TEXOUT "\\rowcolor[rgb]{.9, .9, .9}\n" if $switch++ % 2;

			print TEXOUT $judge->first." & ";
			print TEXOUT $judge->last." & ";

			if ($judge->person) { 

				print TEXOUT $judge->person->email." & ";
				print TEXOUT $judge->person->phone." & ";

			} else {

				print TEXOUT $judge->setting("email")." & ";
				print TEXOUT $judge->setting("phone")." & ";

			}

			print TEXOUT $judge->category->abbr." & ";
			print TEXOUT scalar @{$judge_panels{$judge->id}}." \n ";
			print TEXOUT $end_tabular;

		} # end of foreach school

	    $m->comp("/funclib/printout.mas", 
			tourn    => $tourn,
			filename => $filename,
			tail     => 1
		);

	}

</%init>

	<& 
		"menu.mas", 
		tourn_settings => $tourn_settings,
		tourn          => $tourn,
		category       => $category,
		whoami         => "hired_judge_report",
	&>

<div class="main">

	<div class="full">

		<span class='threequarters nospace'>
			<h4>Have My Judges Earned Their Cheerios?</h4>
		</span>

		<span class='quarter rightalign nospace'>
			<a 
				href="hired_judge_report.mhtml?mode=csv"
				class="buttonwhite greentext fa fa-sm fa-file-excel-o"
				alt="Download Excel"
				title="Download Excel"
			></a>
			<a 
				href="hired_judge_report.mhtml?mode=pdf"
				class="buttonwhite redtext fa fa-sm fa-file-pdf-o"
				alt="Download PDF"
				title="Download PDF"
			></a>
		</span>

	<& "/funclib/tablesorter.mas", 
		table     => "sortymcsortface",
		nobuttons => 1
	&>

	<table id="sortymcsortface">

		<thead>

			<tr class="smallish yellowrow">

				<th>
					First
				</th>

				<th>
					Last
				</th>

				<th>
					School
				</th>

				<th>	
					Rounds
				</th>

				<th>	
					Details
				</th>

			<tr>

		</thead>

		<tbody>

%			foreach my $judge (@judges) { 

				<tr>

					<td>
						<% $judge->first %>
					</td>

					<td>
						<% $judge->last %>
					</td>

					<td>
						<span class="hidden">
							<% $judge->school > 0 ? $judge->school->short_name : "AAAAA" %> 
						</span>
						<% $judge->school > 0 ? $judge->school->short_name : "Hired" %> 
					</td>

					<td class="centeralign">
						<% scalar @{$judge_panels{$judge->id}} %>
					</td>

					<td>

%						foreach my $panel (@{$judge_panels{$judge->id}}) { 

							<span class="third marno nowrap">
								<a 
									class="plain"
									href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>"
								>
									<% $panel->eventname %>
									<% $panel->roundlabel ? $panel->roundlabel : $panel->roundname %>
									<% $panel->flightname > 2 ? "Flt ".$panel->flightname : "" %>
								</a>
							</span>

%						}
					</td>

				</tr>

%			}

		</tbody>

	</table>

</div>
