 <%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$perms
	$judge_id => undef
	$default  => "details"
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	unless ($judge) {
		$m->comp("/funclib/abort.mas", message => "No judge found with ID number $judge_id");
	}

	my $category = $judge->category;
	my $jperson = $judge->person;

	unless ($tourn == $category->tourn) {
		$m->comp("/funclib/abort.mas", message => "That judge does not belong to your current tournament");
	}

	my %judge_settings = $judge->all_settings;
	my $school = $judge->school;
	my $district = $school->district if $tourn_settings->{"nsda_nats"};
	my $diocese = $school->region if $tourn_settings->{"ncfl"};
	my %category_settings = $category->all_settings;

	my @dioschools;

	if ($diocese) {
		@dioschools =
			sort {$a->name cmp $b->name}
			$diocese->schools(tourn => $tourn->id);
	}

	my $hired++ unless $school && $school->id;
	my $num_sites = scalar($tourn->sites);
	my %jpools;
	my @questionnaires;

	if ($jperson && $category_settings{"required_quizzes"}) {
		eval {
			push @questionnaires, @{$category_settings{"required_quizzes"}};
		};
	}

	my $dbh = Tab::DBI->db_Main();
	my $cap_repel;
	my $usa_wsdc;

	my $sth = $dbh->prepare("
		select
			event.id, wsdc_cap_repel.value cap_repel, usa_wsdc.value wsdc
		from event

			left join event_setting wsdc_cap_repel
				on wsdc_cap_repel.event = event.id
				and wsdc_cap_repel.tag = 'wsdc_cap_repel'

			left join event_setting usa_wsdc
				on usa_wsdc.event = event.id
				and usa_wsdc.tag = 'usa_wsdc'

		where event.category = ?
	");

	$sth->execute($category->id);
	my $events = $sth->fetchall_hash();

	foreach my $ev (@{$events}) {
		$cap_repel = 1 if $ev->{"cap_repel"};
		$usa_wsdc  = 1 if $ev->{"wsdc"};
	}

	my %districtschools;

	if ($district) {
		my $sth = $dbh->prepare("
			select school.id, school.name
				from school
			where school.district = ?
				and school.tourn = ?
		");

		$sth->execute($district->id, $tourn->id);
		my $schools = $sth->fetchall_hash();
		%districtschools = map {$_->{id} => $_->{name}} @{$schools};
	}

	my $jpool_sth = $dbh->prepare("
		select
			jpool.id, jpool.name,
			rounds.value,
			round.name,
			GROUP_CONCAT(distinct(event.abbr) SEPARATOR ', '), event.id,
			jpool_judge.id,
			category.id, category.abbr,
			min(timeslot.start),
			max(timeslot.end),
			count(distinct others.judge),
			paradigm_quiz.value,
			parli.value,
			prefer.value,
			registrant.value,
			site_choices.value_text
		from (jpool, category)

		left join jpool_setting registrant
			on registrant.tag = 'registrant'
			and registrant.jpool = jpool.id

		left join jpool_setting site_choices
			on site_choices.tag = 'site_choices'
			and site_choices.jpool = jpool.id

		left join jpool_setting rounds
			on rounds.tag = 'rounds'
			and rounds.jpool = jpool.id

		left join jpool_setting prefer
			on prefer.tag = 'prefer'
			and prefer.jpool = jpool.id

		left join jpool_setting parli
			on parli.tag = 'parli'
			and parli.jpool = jpool.id

		left join jpool_setting paradigm_quiz
			on paradigm_quiz.tag = 'paradigm_quiz'
			and paradigm_quiz.jpool = jpool.id

		left join jpool_judge
			on jpool_judge.judge = ?
			and jpool_judge.jpool = jpool.id

		left join jpool_round on jpool_round.jpool = jpool.id
		left join round on jpool_round.round = round.id

		left join jpool_judge others on others.jpool = jpool.id

		left join event on round.event = event.id
		left join timeslot on round.timeslot = timeslot.id

		where jpool.category = category.id
			and category.tourn = ?

		group by jpool.id
		order by round.name, jpool.name
	");

	$jpool_sth->execute($judge->id, $tourn->id);

	my %tslot_cache;
	my $jcategory_id;
	my $jalt_category_id;
	my @site_choices;

	$jcategory_id = $category->id;

	if ($judge->alt_category) {
		$jalt_category_id = $judge->alt_category->id;
	}

	while (
		my (
			$jpool_id, $jpool_name,
			$rounds_value,
			$round_name,
			$event_abbr, $event_id,
			$jpool_judge_id,
			$category_id, $category_abbr,
			$timeslot_start, $timeslot_end,
			$count_judges,
			$paradigm_quiz,
			$parli,
			$prefer,
			$registrant,
			$site_choice
		) = $jpool_sth->fetchrow_array()
	) {

		if ($jpool_judge_id && $paradigm_quiz && (not defined $jpools{$jpool_id}{"paradigm"})) {
			$jpools{$jpool_id}{"paradigm"} = $paradigm_quiz;
			push @questionnaires, $paradigm_quiz;
		}

		if ($category_id == $jcategory_id || $category_id == $jalt_category_id) {
			if ($parli) {
				$category_settings{"ask_parli"}++;
			}
			if ($prefer) {
				$category_settings{"prefer_congress"}++;
			}
		}

		$jpools{$jpool_id}{"name"}         = $jpool_name;
		$jpools{$jpool_id}{"rounds"}       = $rounds_value;
		$jpools{$jpool_id}{"round_name"}   = $round_name;
		$jpools{$jpool_id}{"event_abbr"}   = $event_abbr;
		$jpools{$jpool_id}{"event_id"}     = $event_id;
		$jpools{$jpool_id}{"count_judges"} = $count_judges;
		$jpools{$jpool_id}{"category"}     = $category_abbr;
		$jpools{$jpool_id}{"registrant"}   = $registrant;
		$jpools{$jpool_id}{"category_id"}  = $category_id;

		if ($timeslot_start) {
			unless ($tslot_cache{$timeslot_start}) {
				$tslot_cache{$timeslot_start} = DateTime::Format::MySQL->parse_datetime($timeslot_start);
				$tslot_cache{$timeslot_start}->set_time_zone("UTC");
				$tslot_cache{$timeslot_start}->set_time_zone($tz);
			}
		}

		if ($tslot_cache{$timeslot_start}) {
			$jpools{$jpool_id}{"start"}       = $tslot_cache{$timeslot_start};
			$jpools{$jpool_id}{"start_epoch"} = $tslot_cache{$timeslot_start}->epoch;
		}

		if ($timeslot_end) {
			unless ($tslot_cache{$timeslot_end}) {
				$tslot_cache{$timeslot_end} = DateTime::Format::MySQL->parse_datetime($timeslot_end);
				$tslot_cache{$timeslot_end}->set_time_zone("UTC");
				$tslot_cache{$timeslot_end}->set_time_zone($tz);
			}
		}

		if ($tslot_cache{$timeslot_end}) {
			$jpools{$jpool_id}{"end"}       = $tslot_cache{$timeslot_end};
			$jpools{$jpool_id}{"end_epoch"} = $tslot_cache{$timeslot_end}->epoch;
		}

		if ($jpool_judge_id) {
			$jpools{$jpool_id}{"in"} = 1;
		}

		if ($jpool_judge_id && $site_choice) {
			push @site_choices, eval {
				return @{JSON::decode_json($site_choice)};
			};
		}
	}

	$jpool_sth->finish();

	my $panel_sth = $dbh->prepare('
		select
			panel.id panel_id, panel.letter, panel.flight,
			round.id round_id, round.name round_name, round.label round_label,
			round.flighted,
			CONVERT_TZ(round.start_time, "+00:00", tourn.tz) start_time,
			CONVERT_TZ(timeslot.start, "+00:00", tourn.tz) start,
			event.id event_id, event.abbr event_abbr, event.name event_name, event.type event_type,
			room.id room_id, room.name room_name,
			ballot.id ballot_id, ballot.side, ballot.speakerorder, ballot.bye, ballot.forfeit, ballot.audit,
			entry.id entry_id, entry.code entry_code, entry.name entry_name,
			flight_offset.value flight_offset

		from (panel, round, event, tourn, ballot, entry, timeslot)

			left join room on panel.room = room.id
			left join event_setting flight_offset
				on flight_offset.event = event.id
				and flight_offset.tag = "flight_offset"

		where ballot.judge = ?
			and ballot.entry = entry.id
			and ballot.panel =  panel.id
			and panel.round = round.id
			and round.event = event.id
			and event.tourn = tourn.id
			and round.timeslot = timeslot.id
		order by round.name, panel.flight
	');

	$panel_sth->execute($judge->id);
	my $panels = $panel_sth->fetchall_hash();

	my %panel_entries;
	my $length;

	foreach my $panel (@{$panels}) {
		$panel_entries{$panel->{panel_id}}{$panel->{entry_id}} = ({
			code         => $panel->{entry_code}   ,
			side         => $panel->{side}         ,
			speakerorder => $panel->{speakerorder} ,
			bye          => $panel->{bye}          ,
			audit        => $panel->{audit}        ,
			forfeit      => $panel->{forfeit}      ,
			name         => $panel->{entry_name}   ,
		});

		$length = length($panel->{entry_code}) if length($panel->{entry_code}) > $length;
	}

	my $jpool_quiz_sth = $dbh->prepare("
		select jpool.id,
			required_quizzes.value_text rq

		from (jpool, jpool_judge jpj, judge)

		left join jpool_setting required_quizzes
			on required_quizzes.tag = 'required_quizzes'
			and required_quizzes.jpool = jpool.id

		where judge.id = ?
			and judge.id = jpj.judge
			and jpj.jpool = jpool.id
	");

	$jpool_quiz_sth->execute($judge->id);
	my $results = $jpool_quiz_sth->fetchall_hash();

	my @quizzes;

	foreach my $ref (@{$results}) {

		Tab::debuglog($ref->{rq});

		my $jq = eval {
			return JSON::decode_json($ref->{rq});
		};

		foreach my $q (@{$jq}) {
			push @quizzes, $q;
		}
	}

	my @tabs;
	push @tabs, "details";
	push @tabs, "quizzes" if scalar @quizzes;
	push @tabs, "pools" if (keys %jpools);
	push @tabs, "noms" if $tourn_settings->{"nsda_nats"};
	push @tabs, "TabRoom" if $category_settings{"tab_room"};
	push @tabs, "questions" if $category_settings{"reg_questions"};
	push @tabs, "rounds" if scalar @{$panels};
	push @tabs, "paradigm" if ($category_settings{"ask_paradigm"} && $jperson);

	my %links;
	$links{"strikes"} = "judge_strikes.mhtml?judge_id=".$judge->id;

	my %reasons;

	%reasons = $m->comp(
		"/funclib/judgemath/nats_check_judging.mas",
		school => $school
	) if $tourn_settings->{"nsda_nats"};


</%init>

	<script>

		function statusSwitch(targetStatus) {
			$("."+targetStatus).toggleClass('hidden');
			$(".judge"+targetStatus).toggleClass('redtext');
		}

		function submitLink() {

			var accountEmail = $("#accountEmail").val();
			var judgeId      = $("#accountEmail").attr("judge");
			var replyUrl     = 'link.mhtml';

			$.ajax({
				type    : 'POST',
				url     : replyUrl,
				data    : {
					judge_id : judgeId,
					email    : accountEmail
				},
				success : function(data) {

					if (data.error) {

						alertify.error(data.message);

					} else {

						if (data.reply) {

							var replyContent = '<a href="mailto: '+data.reply+'"';
							replyContent += 'class = "white bluetext">';
							replyContent += data.reply+'</a>';

							$(".replybucket").html(replyContent);

							$("#identityBox").removeClass("hidden");
							$("#linkBox").addClass("hidden");
							$("#linkBox").removeClass("row flexrow fixedheight");
							$("#identityBox").addClass("row flexrow fixedheight");
						}

						if (data.message) {

							alertify.notify(data.message, "custom");

						}

						zebraRows();
					}
				}
			});
		};

		$(document).ready(function() {
			$('.noEnterSubmit').keypress(function(e){
				if ( e.which == 13 ) {
					e.preventDefault();
					submitLink();
				}
			});
		});

	</script>

	<& "/funclib/editor.mas", height => 256 &>

%	if ($hired || $perms->{"details"}) {
		<div class="main">

		<% $school ? '<h2>'.$school->name.'</h2>' : "" %>

%	} else {
    	<&
			"/register/menubar.mas",
			school         => $school,
			whoami         => "judges",
			reasons        => \%reasons,
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>
%	}

	<span class="half marno padless padvert judgeactive <% $judge->active ? "" : "redtext" %>">
		<h4 class="nospace inline">
			<% $category_settings{"no_codes"} ? "" : $judge->code %>
			<% $judge ? $judge->first." ".$judge->last : "Add Judge" %>
			<h6 class="active semibold redtext inline <% $judge->active ? "hidden" : "" %>">
				&ndash; INACTIVE
			</h6>
		</h4>
	</span>

	<span class="half nospace rightalign">

		<&
			"/funclib/tabs.mas",
				tabs    => \@tabs,
				links   => \%links,
				default => $default,
				right   => "true",
				buttons => "true",
				large   => "true"
		&>

	</span>

	<div id ="quizzes"
		class = "quizzes screens hidden"
	>
		<h5>Required Quizzes &amp; Certifications</h5>

%		foreach my $quiz_id (@quizzes) {

%			my $quiz = Tab::Quiz->retrieve($quiz_id);
%			my $pq = Tab::PersonQuiz->search( quiz => $quiz_id, person => $judge->person)->first;

			<div class="row flexrow fixedheight">
				<span class="threefifths padleft semibold">
					<% $quiz->label %>
				</span>
				<span class="fifth centeralign">
					<& "/funclib/bool_switch.mas",
						target         => $judge->id,
						quiz_id        => $quiz->id,
						judge_id       => $judge->id,
						person_id      => int($judge->person),
						tag            => $quiz->id,
						property_value => 1,
						value          => ($pq->approved_by > 0 ? 1 : 0),
						url            => "judge_quiz.mhtml"
					&>
				</span>
				<span class="fifth centeralign">
					<% $pq->completed %>
				</span>
			</div>
%		}

	</div>

	<div
		id    = "details"
		class = "details screens hidden"
	>

	<form
		action = "save.mhtml"
		method = "post"
	>

	<input
		type  = "hidden"
		name  = "judge_id"
		value = "<% ($judge) ? $judge->id : "" %>"
	>

	<div class="splitpage">

	<span class="pagehalf padtop">
		<div class="row flexrow fixedheight">
			<span class="third padleft">
				First
			</span>
			<span class="twothirds padright">
				<input
					type        = "text"
					name        = "first"
					class       = "starthere"
					size        = "24"
					value       = "<% $judge->first %>"
					placeholder = "First Name"
				>
			</span>
		</div>

		<div class="row flexrow fixedheight">
			<span class="third padleft">
				Middle
			</span>
			<span class="twothirds padright">
				<input
					type        = "text"
					name        = "middle"
					size        = "24"
					value       = "<% $judge->middle %>"
				>
			</span>
		</div>

		<div class="row flexrow fixedheight">
			<span class="third padleft">
				Last
			</span>

			<span class="twothirds padright">
				<input
					type        = "text"
					name        = "last"
					size        = "24"
					value       = "<% $judge->last %>"
					placeholder = "Last Name"
				>

			</span>
		</div>

%			unless ($category_settings{"no_codes"}) {

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Code
					</span>

					<span class="threefifths">
						<input
							type  = "text"
							name  = "code"
							size  = "24"
							value = "<% $judge->code %>"
						>
					</span>
				</div>
%			}

			<div class="row flexrow fixedheight">

				<span class="third padleft">
					Judge category
				</span>

				<span class="twothirds padright">
					<select name="category_id" class="fixedsmall">
<%perl>
 						foreach my $tcategory (
							sort {$a->name cmp $b->name}
							$tourn->categories
						) {
</%perl>
							<option value="<% $tcategory->id %>"
								<% ($category && $category->id == $tcategory->id)
									? 'selected'
									: ''
								%>
							><% $tcategory->name %></option>
%						}
						<option>-----------------------------</option>
					</select>
				</span>
			</div>

% 			if ($category_settings{"ask_alts"}) {

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Also judges
					</span>

					<span class="twothirds padright">
						<select
							name  = "alt_category"
							class = "fixedsmall"
						>
							<option value="">
								None Selected
							</option>
<%perl>
	 						foreach my $tcategory (
								sort {$a->name cmp $b->name}
								$tourn->categories
							) {

								next if $tcategory->id == $category->id;
</%perl>
								<option value="<% $tcategory->id %>"
									<% ($judge->alt_category
										&& $tcategory->id == $judge->alt_category->id)
										? 'selected'
									: ''
								%>><% $tcategory->name %></option>
%							}

						</select>
					</span>
				</div>
%			}

			<div class="row flexrow fixedheight">
				<span class="third padleft">
					Covers entries in
				</span>

				<span class="twothirds padright">
					<select name="covers">

						<option value="">
							None Selected
						</option>

%	 					foreach my $tcategory (sort {$a->name cmp $b->name} $tourn->categories) {
							<option value="<% $tcategory->id %>"
								<% ($judge->covers && $tcategory->id == $judge->covers->id)
									? 'selected' : '' %>

								<% ($category && $category->id == $tcategory->id) &! $judge->covers
									? 'selected' : '' %>
							><% $tcategory->name %></option>
%						}
						<option>-----------------------------</option>
					</select>
				</span>
			</div>

<%perl>
			if ($category_settings{"rounds_per"}
				|| $category_settings{"nats_category"}
			) {

			  	my $max_rounds = $category_settings{"max_rounds"};
				$max_rounds = 99 if $tourn_settings->{"nsda_nats"};
</%perl>

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						<% $category_settings{"nats_category"} ? "Days" : "Rounds" %> Obligated
					</span>

					<span class="threefifths">
						<input
							type  = "number"
							name  = "obligation"
							min   = "0"
							max   = "<% $max_rounds %>"
							value = "<% $judge->obligation %>"
							size  = "16"
							class = "larger"
						>
					</span>
				</div>

%				if ($tourn_settings->{"nsda_nats"} && @site_choices) {
					<div class="row flexrow fixedheight">
						<span class="third padleft">
							Preferred Site
						</span>

						<span class="threefifths">
							<select name  = "site_preference">
								<option value="">No Preference</option>
%								foreach my $choice (@site_choices) {
									<option
										value="<% $choice->{id} %>"
										<% $choice->{id} eq $judge_settings{"site_preference"}
											? "selected"
											: ""
										%>
									><% $choice->{"name"} %></option>
%								}
							</select>
						</span>
					</div>

%				} else {

					<div class="row flexrow fixedheight">
						<span class="third padleft">
							Rounds Hired
						</span>

						<span class="threefifths">
							<input
								type  = "number"
								name  = "hired"
								min   = "0"
								max   = "<% $max_rounds %>"
								size  = "16"
								class = "larger"
								value = "<% $judge->hired %>">
						</span>
					</div>
%				}

%				if ($category_settings{"exchange"}) {

					<div class="row flexrow fixedheight">
						<span class="third padleft">
							Hired Rounds Available
						</span>

						<span class="threefifths">
							<input
								type  = "number"
								name  = "hire_offer"
								min   = "0"
								max   = "<% $max_rounds %>"
								size  = "16"
								class = "larger"
								value = "<%
								$judge_settings{'hire_offer'} %>">
						</span>
					</div>
%				}
%			}

%			if ($category_settings{"tab_ratings"}) {

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Tab Rating
					</span>

					<span class="quarter">
						<input
							type  = "number"
							name  = "tab_rating"
							min   = "0"
							max   = "999"
							value = "<% $judge_settings{"tab_rating"} %>"
						>
					</span>
				</div>
%			}

<%perl>
			if ($usa_wsdc) {

				my $original_school =
					Tab::School->retrieve($judge_settings{"original_school"})
					if $judge_settings{"original_school"};

</%perl>
				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Real School
					</span>

					<span class="threefifths">
%						unless ($district > 0) {
							<span class="semibold redtext centeralign full nospace padvert">
								No district assigned to team
							</span>
%						} else {
							<select name="original_school">
								<option value=""></option>
%								foreach my $school ($district->schools(tourn => $tourn)) {
									<option
										value="<% $school->id %>"
										<% $school->id == $judge_settings{"original_school"}
											? 'selected'
											: ""
										%>
									><% $school->short_name %></option>
%								}
							</select>
%						}
					</span>
				</div>
%			}

%			if ($tourn_settings->{"ncfl"}) {

				<div class="row settings nospace">
					<span class="nospace twofifths semibold bluetext">
						<span class="fixedflex">
							<span class="spacer"></span>
							Diocese
						</span>
					</span>

					<span class="threefifths nospace">

						<span class="fixedflex">
							<span class="threequarters">
								<% $school
									&& $school->region
									? $school->region->name
									: ""
								%>
							</span>

							<span class="quarter">
								<% $school
									&& $school->region
									? $school->region->code
									: ""
								%>
							</span>
						</span>
					</span>
				</div>
%			}
		</span>

		<span class="pagehalf padtop">

%			if ($judge && $judge->person_request > 0) {
%				unless ($jperson > 0) {
%					my $request = $judge->person_request;

					<div class="row flexrow fixedheight">
						<span class="third semibold redtext">
							Access Request
							<% $request->first." ".$request->last %>
						</span>

						<span class="third">
							<a class="white" href="mailto:<% $request->email %>">
								<% $request->email %>
							</a>
						</span>

						<span class="sixth centeralign">
							<a
								class="greentext buttonwhite fa fa-check"
								href="permit.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
							>
							</a>
						</span>

						<span class="sixth centeralign">
							<a
								class="redtext buttonwhite fa fa-times"
								href="deny.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
							>
							</a>
						</span>
					</div>
%				}
%			}

			<div
				id    = "identityBox"
				class = "<% ($jperson > 0) ? "row fixedheight" : "hidden" %> flexrow"
			>
				<span class="third padleft">
					Linked
				</span>

				<span class="replybucket half semibold smallish wrap">
%					if ($jperson > 0) {
						<a
							href  = "mailto:<% $jperson->email %>"
							class = "white bluetext"
							title = "<% $jperson->email %>"
						>
							<% $jperson->email %>
						</a>
%					}
				</span>

				<span class="sixth rightalign padright">
%					my $warn = "This will render this person unable to access online ballots. You sure, now?";
					<a
						class = "buttonwhite redtext invert fa fa-chain-broken fa-sm"
						title = "<% $warn %>"
						href  = "unlink.mhtml?judge_id=<% $judge->id %>"
						<& "/funclib/confirm.mas", warn => $warn &>
					>
					</a>
				</span>
			</div>

%			unless ($jperson > 0) {
				<div
					id="linkBox"
					class = "row flexrow fixedheight"
					title = "Link this user to an online Tabroom account"
				>
					<span class="quarter padleft">
						Link To
					</span>

					<span class="threefifths padleft padright">
						<input
							id          = "accountEmail"
							judge       = "<% $judge->id %>"
							type        = "email"
							name        = "username"
							class       = "noEnterSubmit"
							size        = "24"
							placeholder = "Tabroom login/email"
							onBlur      = "submitLink();"
						>
					</span>

					<span class="tenth rightalign">
						<input
							type    = "button"
							class   = "thin button"
							value   = "Link"
							onClick = "submitLink();"
						>
					</span>
				</div>
%			}

			<div class="row flexrow fixedheight">
				<span class="third padleft">
					School
				</span>

				<span class="twothirds padright">
					<select
						name  = "school"
					>
						<option value="">Hired</option>
<%perl>
						my %school_already;

						if ($district) {
							foreach my $dschool_id (sort {
								$districtschools{$a} cmp $districtschools{$b}
								} keys %districtschools
							) {
								$school_already{$dschool_id}++;
</%perl>
								<option value="<% $dschool_id %>"
									<% ($dschool_id eq $school->id) ? 'selected' : '' %>
								> <% $districtschools{$dschool_id} %> </option>
%							}
							<option value="">
								---Other Districts:---
							</option>
<%perl>
						}

						if ($diocese) {

							foreach my $dschool (@dioschools) {
								$school_already{$dschool->id}++;
</%perl>
									<option value="<% $dschool->id %>"
										<% ($dschool->id eq $school->id) ? 'selected' : '' %>
									> <% $dschool->short_name %> </option>
%							}
							<option value="">
								---Other Dioceses:---
							</option>
<%perl>
						}

						$sth = $dbh->prepare("
							select school.id, school.name
							from school
							where school.tourn = ?
						");

						$sth->execute($tourn->id);
						my $school_id = $school->id;

						while (
							my ($oschool_id, $oschool_name) = $sth->fetchrow_array()
						) {

							next if $school_already{$oschool_id}++;
</%perl>
							<option value="<% $oschool_id %>"
								<% ($oschool_id eq $school_id) ? 'selected' : '' %>
							> <% $oschool_name %> </option>
%						}
					</select>
				</span>
			</div>

%			if ($tourn_settings->{"nsda_nats"}) {
%				if ($school && $district) {
					<div class="row fixedheight flexrow">
						<span class="third padleft">
							District
						</span>

						<span class="half bluetext semibold padleft">
							<% $district ? $district->code." ".$district->name : "" %>
						</span>

						<span class="sixth bluetext semibold padleft">
							<% $school && $school->region ? $school->region->code : "" %>
						</span>
					</div>
%				}
%			}

			<div class="row flexrow fixedheight">
				<span class="third padleft">
					Phone
				</span>
%				if ($jperson > 0) {
					<span
						class   = "twothirds padleft padright hover"
						id      = "phone_<% $jperson->id %>"
						onClick = "copyToClipboard('phone_<% $jperson->id %>', 'Phone');"
						class   = "hover padvert padleft"
					>
						<% Tab::phoneme($jperson->phone) %>
					<span>
%				} else {
					<span class = "twothirds padleft padright">
						<input
							type  = "tel"
							name  = "phone"
							size  = "24"
							value = "<% Tab::phoneme($judge_settings{"phone"}) %> "
						>
					</span>
%				}
			</div>

			<div class="row fixedheight flexrow">
				<span class="third padleft">
					Email
				</span>

%				if ($jperson > 0) {
					<span
						class = "twothirds padright padleft"
						href  = "mailto:<% $jperson->email %>"
						class = 'full plain padvert padleft'
					>
						<a
							class="hover plain"
							href="mailto:<% $jperson->email %>"
						><% $jperson->email %></a>
					</span>
%				} else {
					<span class = "twothirds padright padleft">
						<input
							type  = "email"
							name  = "email"
							value = "<% $judge_settings{"email"} %> "
						>
					</span>
%				}
			</div>

			<div class="row flexrow fixedheight">
				<span class="third padleft">
					Special assignment
				</span>

				<span class="twothirds padright">
					<input
						type  = "text"
						name  = "special_job"
						size  = "24"
						value = "<% $judge_settings{'special_job'} %>"
					>
				</span>
			</div>

			<div class="row flexrow fixedheight">
				<span class="third padleft">
					Registration Notes
				</span>

				<span class="twothirds padright">
					<input
						type  = "text"
						name  = "notes"
						size  = "24"
						value = "<% $judge_settings{'notes'} %>"
					>
				</span>
			</div>

%			if ($tourn_settings->{"nsda_nats"} && $jperson > 0) {
%				my $membership = $m->comp("/funclib/nsda/membership.mas", person => $jperson);
%				my $diamonds = $jperson->setting("diamonds");

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						NSDA ID
					</span>

					<span class="third padleft">
						<input
							type  = "number"
							name  = "nsda"
							size  = "16"
							class = "larger"
							value = "<% $jperson->nsda %>"
						>
					</span>

%					if ($diamonds) {
						<span class="third bigger orangetext semibold">
							<span class="half nospace">
								<h6 class="semibold nospace rightalign">
									<% $diamonds %>
								</h6>
							</span>
							<span class="fa fa-lg fa-diamond twofifths"></span>
						</span>
%					}
				</div>

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Badge Diamonds
					</span>

					<span class="third leftalign padleft">
						<input
							type  = "number"
							name  = "diamonds_override"
							size  = "16"
							class = "larger"
							value = "<% $judge_settings{'diamonds_override'} %>"
						>
					</span>
				</div>

				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Badge Schoolname
					</span>

					<span class="threefifths padleft">
						<input
							type  = "text"
							name  = "school_name_override"
							size  = "36"
							value = "<% $judge_settings{'school_name_override'} %>"
						>
					</span>
				</div>
				<div class="row flexrow fixedheight">
					<span class="third padleft">
						Badge State
					</span>

					<span class="threefifths padleft">
						<input
							type  = "text"
							name  = "state_override"
							size  = "36"
							value = "<% $judge_settings{'state_override'} %>"
						>
					</span>
				</div>
%			}
		</span>

% 		if ($category_settings{"judge_quals"}) {

			</div>
			<div class="odd marvert pagefull">
				<span class="padvert semibold bluetext bigger">
					Qualifications
				</span>

				<span class="full centeralign padless marno">
					<textarea
						name="qual_history"
					><% $judge_settings{"qual_history"} %></textarea>
				</span>
%		}
		</div>

		<div class="libl pagefull rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Save Judge Information"
				>
			</span>
		</div>

		</form>
<%perl>

		if ($judge && $jperson) {

			my %required_certs;
			my @certs = $jperson->answers(pending => 0);

			if ($category_settings{"required_quizzes"}) {
				%required_certs = map {$_ => 1} @{$category_settings{"required_quizzes"}};
			}

			foreach my $cert (@certs) {

				unless ($cert->quiz->sitewide) {
					next unless $required_certs{$cert->id};
				}
</%perl>
				<span class="quarter centeralign">
					<div class="full">
						<& "/funclib/badge.mas", quiz => $cert->quiz, size => "small" &>
					</div>
					<div class="full padvertless semibold bluetext">
						<% $cert->quiz->label %>
					</div>
					<div class="full graytext smallish italic">
						Last updated <& "/funclib/showdt.mas", dt => $cert->updated_at &>
					</div>
				</span>
%			}
%		}
	</div>

%	if ($category_settings{"tab_room"}) {

%		my @tab_jobs = $m->comp('/funclib/ncfl/tab_choices.mas');

		<div
			id    = "TabRoom"
			class = "TabRoom screens"
		>
			<h5>
				Tab Preferences
			</h5>

			<form
				action="ncfl_tab_save.mhtml"
				method="post"
			>

			<input
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge_id %>"
			>

%			foreach my $choice ("first", "second", "third") {

				<div class="row flexrow">
					<span class="semibold third padleft">
						<% ucfirst($choice) %> Choice
					</span>

					<span class="twothirds padvert">
						<select name  = "cfl_tab_<% $choice %>">
							<option value=""></option>

%							foreach my $job (@tab_jobs) {
								<option
									value="<% $job %>"
									<% ($judge && $judge_settings{"cfl_tab_".$choice} eq $job)
										? "selected"
										: ""
									%>
								> <% $job %> </option>
%							}
						</select>
					</span>
				</div>
%			}

			<div class="liblrow full rightalign">
				<span class="third centeralign">
					<input
						type="submit"
						value="Save Choices"
					>
				</span>
			</div>
			</form>
		</div>
%	}

%	if (@{$panels}) {

		<div
			id    = "rounds"
			class = "rounds hidden screens"
		>

			<span class="half">
				<h6>Round Assignments</h6>
			</span>

			<span
				id    = "assignments_buttonarea"
				class = "half rightalign"
			>

				<a
					href  = "print_sheet.mhtml?judge_id=<% $judge->id %>"
					class = "buttonwhite bluetext fa fa-sm fa-list"
					title = "Info Sheet/Dance Card"
				>
				</a>

%				if ($tourn_settings->{"ncfl"}) {
					<a
						class = "buttonwhite orangetext fa fa-sm fa-address-card"
						title = "NCFL Judge Card"
						href  = "/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>"
					>
					</a>
%				}
			</span>

			<& "/funclib/tablesorter.mas", table => "assignments" &>

			<table id="assignments">
				<thead>
					<tr class="yellowrow smallish">
						<th>
							Event
						</th>

						<th>
							Round
						</th>

						<th>
							Start
						</th>

						<th>
							Room
						</th>

						<th>
							Entries
						</th>

						<th>
						</th>
					</tr>

				</thead>

				<tbody>
<%perl>
					my %done;
					foreach my $panel (@{$panels}) {

						next if $done{$panel->{panel_id}}++;

						my $start = $m->comp("/funclib/dtme.mas",
							string => $panel->{start_time},
						);
</%perl>
						<tr class="smallish">

							<td class='centeralign'>
								<% $panel->{event_abbr} %>
							</td>

							<td
								data-text = "<% $panel->{round_name} %>-<% $panel->{flight} %>"
								class     = "nowrap <% $panel->{flighted} > 1 ? 'smallish' : "" %>"
							>
								<% $panel->{round_label} || "Rnd ".$panel->{round_name} %>
								<% $panel->{flighted} > 1 ? "Fl ".$panel->{flight} : "" %>
							</td>

							<td class='nowrap' data-text="<% $start->{epoch} %>">
<%perl>
								if ($start->{dt}) {
									if ($panel->{flighted} > 1 && $panel->{flight_offset}) {

										my $dt = $start->{dt}->clone();
										$dt->add(minutes => ($panel->{flight_offset} * ($panel->{flight} -1)));
</%perl>
										<& "/funclib/showtime.mas", dt => $dt &>
%									} else {
										<& "/funclib/showtime.mas", dt => $start->{dt} &>
%									}
%								} else {
									No listed start time
%								}
							</td>

							<td>
								<% $panel->{room_name} %>
							</td>

							<td>
<%perl>
								if ($panel->{event_type} ne "congress") {
									foreach my $entry_id (sort {
											$panel_entries{$a}{"side"} <=> $panel_entries{$b}{"side"}
											|| $panel_entries{$a}{"speakerorder"} <=> $panel_entries{$b}{"speakerorder"}
										} keys %{$panel_entries{$panel->{panel_id}}}
									) {

										my $entry = $panel_entries{$panel->{panel_id}}{$entry_id};
</%perl>
										<span
											class="padvertless marno hover <%
												$entry->{bye} || $entry->{forfeit} ? "italic" : ""
											%>"
											style="width: <% $length + 5 %>ex;"
											title="<% $entry->{name} %>"
										>
											<% $entry->{code} %>
											<% $entry->{bye} ? "(BYE)" : "" %>
											<% $entry->{forfeit} ? "(FFT)" : "" %>
										</span>
%									}
%								}
							</td>

							<td class="centeralign padless">
								<a
									class = "buttonwhite bluetext fa fa-lg fa-eye"
									target= "_blank"
									href  = "/panel/schemat/panel_view.mhtml?panel_id=<% $panel->{panel_id} %>"
								>
								</a>
							</td>
						</tr>
%		 			}
				</tbody>
			</table>
		</div>
<%perl>
 	}

 	if (keys %jpools) {

		my %used;
</%perl>
		<div id="pools" class="screens pools hidden">

			<div class="nospace full ltbordertop"></div>

%			if ($tourn_settings->{"ncfl"}) {
				<span class="third">
					<a
						class = "buttonwhite orangetext fa fa-sm fa-address-card"
						title = "NCFL Judge Card"
						href  = "/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>"
					>
					</a>
				</span>
				<span class="twothirds rightalign nospace explain semibold bluetext">
					Click a pool to move the judge in/out of it
				</span>

%			} elsif ($category_settings{"nats_category"}) {
                <h5 class="padtop nospace bluetext">
                    Registration Pools
                </h5>
%           } else {
				<span class="full rightalign nospace explain semibold bluetext">
					Click a pool to move the judge in/out of it
				</span>
%           }

<%perl>

			my %prelim_jpools;

			if ($tourn_settings->{"ncfl"}) {
				my @prelim_jpools = $m->comp(
					"/funclib/category_jpools.mas",
						category => $category,
						limit => "ncfl_prelims"
					);

				%prelim_jpools = map { $_->id => $_ } @prelim_jpools;
			}
</%perl>

			<span class="pagehalf">

				<h6 class="Yep">In</h6>

				<&
					"/funclib/tablesorter.mas",
					table     => "insort",
					nobuttons => 1
				&>

				<table id="insort">
					<thead>
						<tr class="yellowrow smallish">
							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ( (not defined $tourn_settings->{"nsda_nats"}) && $num_sites > 1) {
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>
					</thead>

					<tbody id="in">
<%perl>
						foreach my $id (sort keys %jpools) {

							next unless $jpools{$id}{"in"};

							if (
								$category_settings{"nats_category"}
								&& (not defined $jpools{$id}{"registrant"})
							) {
								next;
							}

							$used{$id}++;
</%perl>
							<tr
								class    = "judge smallish hover"
								pool_id  = "<% $id %>"
								judge_id = "<% $judge->id %>"
								id       = "<% $id %>"
								onClick  = "togglePool(this);"
							>

								<td>
									<% $jpools{$id}{"name"} %>
%									if ($judge_settings{"prelim_jpool"} eq $id ) {
										<span class="half rightalign greentext">
											Prelim Pool
										</span>
%									}
								</td>

								<td class="centeralign">
									<% $jpools{$id}{"category"} %>
								</td>

%								if ( (not defined $tourn_settings->{"nsda_nats"}) && $num_sites > 1) {
									<td class="cellmax nowrap">
										<% $jpools{$id}{"site"} %>
									</td>
%								}

								<td class="nowrap rightalign">
									<% $jpools{$id}{"count_judges"} %>
								</td>

							</tr>
%						}

					</tbody>
				</table>
			</span>

			<span class="pagehalf">

				<h6 title="Nope">Not In</h6>

				<& "/funclib/tablesorter.mas",
					table     => "outsort",
					nobuttons => 1
				&>

				<table id="outsort">

					<thead>
						<tr class="yellowrow smallish">
							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ( (not defined $tourn_settings->{"nsda_nats"}) && $num_sites > 1) {
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>
					</thead>

					<tbody id="out">
<%perl>
					foreach my $id (sort keys %jpools) {

						next if $used{$id}++;

						if (
							$category_settings{"nats_category"}
							&& (not defined $jpools{$id}{"registrant"})
						) {
							next;
						} elsif (
							$jpools{$id}{"category_id"} != $jcategory_id
							&& $jpools{$id}{"category_id"} != $jalt_category_id
						) {
							next;
						}
</%perl>

						<tr
							class    = "judge smallish hover"
							pool_id  = "<% $id %>"
							judge_id = "<% $judge->id %>"
							id       = "<% $id %>"
							onClick  = "togglePool(this);"
						>

							<td>
								<% $jpools{$id}{"name"} %>

								<% $prelim_jpools{$id}
									? " - (Prelim Pool)"
									: ""
								%>
							</td>

							<td class="centeralign">
								<% $jpools{$id}{"category"} %>
							</td>

%							if ( (not defined $tourn_settings->{"nsda_nats"}) && $num_sites > 1) {
								<td class="cellmax nowrap">
									<% $jpools{$id}{"site"} %>
								</td>
%							}

							<td class="nowrap rightalign">
								<% $jpools{$id}{"count_judges"} %>
							</td>
						</tr>
%					}

					</tbody>
				</table>
			</span>

		<script type="text/javascript">

			function togglePool(judgeSpan) {

				var parentID = $(judgeSpan).closest("tbody").attr("id");
				var judgeID  = $(judgeSpan).attr("judge_id");
				var poolID   = $(judgeSpan).attr("pool_id");

				var postValue, newParent;

				if (parentID === "in") {
					postValue = 0;
					newParent = "out";
				} else {
					postValue = 1;
					newParent = "in";
				}

				$.ajax({
					url: 'jpool_judge_switch.mhtml',
					type: 'POST',
					data: {
						judge_id : judgeID,
						value    : postValue,
						jpool_id : poolID,
					}, success: function(data) {

						if (data.error) {

							alertify.error(data.message);

						} else {

							alertify.set('notifier','delay', 2);
							alertify.notify(data.message, "custom");
							alertify.set('notifier','delay', 5);
							$("#"+poolID).prependTo("#"+newParent)

						}
						$("table").trigger("applyWidgets");
					}
				});
			}

		</script>

%		if ($category_settings{"track_diversity"} || $category_settings{"nats_category"}) {

			<& "/funclib/tablesorter.mas",
				table     => "nats_inpools"
			&>

			<div class="full martopmore nospace">
				<span class="half nospace">
					<h5 class="bluetext">
						Competition Pools
					</h5>
				</span>

				<span
					class = "half nospace rightalign"
					id    = "nats_inpools_buttonarea"
				>
				</span>
			</div>

			<table id="nats_inpools">

				<thead>
					<tr class="yellowrow smallish">
						<th>
							Pool
						</th>

						<th>
							Event
						</th>

						<th>
							Round
						</th>

						<th>
							Start
						</th>

						<th>
							End
						</th>
						<th>
							Judge Count
						</th>

						<th>
						</th>
					</tr>
				</thead>

				<tbody id="competitives">

<%perl>
					foreach my $jpool_id (
						sort {
							$jpools{$b}{"in"} <=> $jpools{$a}{"in"}
							|| $jpools{$a}{"start_epoch"} <=> $jpools{$b}{"start_epoch"}
						} keys %jpools
					) {

						if ($jpools{$jpool_id}{"registrant"}) {
							next;
						}

						unless ($jpools{$jpool_id}{"in"}) {
							last;
							next;
						}
</%perl>

						<tr id="<% $jpool_id %>">
							<td>
								<% $jpools{$jpool_id}{"name"} %>
							</td>

							<td class="centeralign">
								<% $jpools{$jpool_id}{"event_abbr"} %>
							</td>

							<td class="centeralign">
								<% $jpools{$jpool_id}{"round_name"} %>
							</td>

							<td class="rightalign">
								<& "/funclib/showdt.mas",
									dt     => $jpools{$jpool_id}{"start"},
									length => "casual"
								&>
							</td>

							<td class="rightalign">
								<& "/funclib/showdt.mas",
									dt     => $jpools{$jpool_id}{"end"},
									length => "casual"
								&>
							</td>

							<td class="rightalign">
								<% $jpools{$jpool_id}{"count_judges"} %>
							</td>

							<td class="centeralign nospace padvertless">
								<a
									value         = "1"
									id            = "<% $jpool_id %>"
									target_id     = "<% $jpool_id %>"
									property_name = "<% $judge->id %>"
									on_success    = "destroy"
									onClick       = "postSwitch( this, 'jpool_judge_rm.mhtml');"
									class         = "buttonwhite fa fa-sm fa-trash redtext"
									title         = "Remove from This Pool"
								></a>
							</td>
						</tr>
%					}
				</tbody>
			</table>

			<div class="liblrow">

				<span class="fifth semibold bluetext bigger">
					Add to pool
				</span>

				<span class="threefifths">
					<select
						id    = "jpool_id"
						name  = "jpool_id"
						class = "fixedmost"
					>
<%perl>
					foreach my $jpool_id (
						sort {
							$jpools{$a}{"in"} <=> $jpools{$b}{"in"}
							|| $jpools{$a}{"event_abbr"} cmp $jpools{$b}{"event_abbr"}
							|| $jpools{$a}{"start_epoch"} <=> $jpools{$b}{"start_epoch"}
						} keys %jpools
					) {

</%perl>
						<option
							value="<% $jpool_id %>"
						><%
								$jpools{$jpool_id}{"name"}
							%> - <& "/funclib/showdt.mas",
									dt     => $jpools{$jpool_id}{"start"},
									tz     => $tz,
									length => "casual"
							&> - <%
								$jpools{$jpool_id}{"count_judges"}
						%></option>
%					}
					</select>
				</span>

				<span class="fifth centeralign">
					<button
						class        = "buttonwhite bluetext invert full"
						target_id    = "<% $judge->id %>"
						other_value  = "jpool_id"
						reply_append = "competitives"
						onClick      = "postSwitch(this, 'jpool_judge_add.mhtml');"
					>Add Pool</button>
				</span>

			</div>
% 		}
		</div>
% 	}

%	if ($category_settings{"ask_paradigm"} && $jperson) {

		<div
			id    = "paradigm"
			class = "screens paradigm hidden"
		>
			<h4>Paradigm</h4>

			<div class="even full">
				<% $jperson->setting("paradigm") %>
			</div>

		</div>
%	 }

<%perl>

	if ($judge_settings{"nomination"} || $tourn_settings->{"nsda_nats"}) {

		my %nom = eval{
			return %{JSON::decode_json($judge_settings{"nomination"})};
		};

</%perl>

		<div
			id    = "noms"
			class = "screens noms hidden"
		>
			<h6>Late Elim Nomination</h6>

			<div class="row padvert">
				<span class="third semibold">
					Self Nominated:
				</span>

				<span class="sixth centeralign semibold bluetext centeralign">
					<% $nom{"self_nominated"} ? "Y" : "" %>
				</span>

				<span class="third semibold bluetext">
					Chair Nominated:
				</span>
				<span class="sixth centeralign semibold bluetext centeralign">
					<% $nom{"chair_nominated"} ? "Y" : "" %>
				</span>
			</div>

			<div class="row padvert">
				<span class="third semibold">
					Diversity:
				</span>
				<span class="sixth centeralign semibold bluetext centeralign">
					<% $judge_settings{"diverse"} ? "Y" : "" %>
				</span>

				<span class="sixth semibold">
					Phonetic
				</span>
				<span class="third">
					<% $nom{'phonetic'} %>
				</span>
			</div>

			<div class="row padvert">
				<span class="third semibold">
					Types of Event:
				</span>
				<span class="twothirds">
<%perl>
					my $notfirst;
					foreach my $type (keys %{$nom{"type"}}) {
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"chair"}}) {
						next if $type eq "middle";
						next if $type eq "speech";
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"speech_types"}}) {
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"middle_types"}}) {
						$m->print(", ") if $notfirst++;
						$m->print("MS ") if $notfirst++;
						$m->print(ucfirst($type));
					}
</%perl>
				</span>
			</div>

			<div class="row padvert">
				<span class="quarter semibold bluetext">
					Supporting Info
				</span>
				<span class="threequarters">
					<% $nom{'text'} %>
				</span>
			</div>

			<div class="liblrow rightalign padvert">
				<a
					class="buttonwhite bluetext invert marrightmore"
					href="nom_edit.mhtml?judge_id=<% $judge->id %>"
				><span class="inline fa fa-edit fa-lg"></span> Edit Nomination</a>
			</div>
		</div>
%	}

%	if ($category_settings{"reg_questions"}) {

		<div class="screens questions">

			<form
				action="questions_save.mhtml"
				method="post"
			>
				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>

				<input
					type  = "hidden"
					name  = "judge_id"
					value = "<% $judge_id %>"
				>

				<div class="pagefull marno">
					<&
						"/funclib/judge_reg_questions.mas",
							answers       => $judge_settings{'reg_answers'},
							reg_questions => $category_settings{"reg_questions"},
					&>
				</div>

				<div class="libl marno pagefull rightalign">
					<span class="third centeralign">
						<input type="submit" value="Save Answers">
					</span>
				</div>

			</form>

		</div>

%	}

	</div>

	<div class="menu">

		<div class="sidenote">

%			if ($judge_settings{"incomplete"}) {

% 				$judge_settings{'incomplete'} =~ s/<br \/>/<br \/>&ndash; /g;

				<h4 class="redborderbottom padbottom">
					Judge Problems
				</h4>

				<p class="redtext bordertopred taller padmore smaller" style="line-height: 14pt;">
					&ndash; <% $judge_settings{"incomplete"} %>
				</p>
%			}

			<h4>Rosters</h4>

			<div class="full flexrow nospace wrap">

%			if ($perms->{"details"}) {

%			} elsif ($hired) {

				<a
					class = "blue full"
					href  = "/register/judge/roster.mhtml?category_id=<% $category->id %>&hires=1"
				>Hired Judges</a>
<%perl>
			} elsif ($school && $category) {

				if ($tourn_settings->{"ncfl"} && $school > 0) {

					my $region = $school->region;
					if ($region > 0) {
</%perl>
						<a
							class="blue half nowrap"
							href="/register/region/tourn_judges.mhtml?region_id=<% $region->id %>&category_id=<% $category->id %>">
							<% $region->name %> <% $category->abbr %> js
						</a>
%					}
%				}

				<a
					class = "blue half flexrow"
					href  = "/register/school/judges.mhtml?school_id=<% $school->id %>&category=<% $category->id %>">
					<span class="twothirds nowrap nospace"> <% $school->short_name %></span>
					<span class="third nowrap nospace"><% $category->abbr %> js</span>
				</a>
%			}

%			if ($category) {
				<a
					class="blue half"
					href="/register/judge/roster.mhtml?category_id=<% $category->id %>">
					All <% $category->abbr %> js
				</a>
%			}

%			if ($tourn_settings->{"nsda_nats"}) {
				<a
					class = "blue full flexrow"
					href  = "/register/reports/judge_dance.mhtml?judge_id=<% $judge->id %>"
				>
					Print Judge Dance Card
				</a>
%			}

			</div>

			<div class="row flexrow nospace">
				<span class="threequarters padleft semibold">
					Active
				</span>

				<span class="quarter centeralign">
					<label class="switch smaller noflex">
						<input
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_active"
							property_name = "active"
							target_type   = "judge"
							target_id     = "<% $judge->id %>"
							onChange      = "postSwitch( this, 'judge_switch.mhtml');
											 statusSwitch('active');"
							<% $judge->active ? 'checked="checked"' : "" %>
						>
						<div class="slider offred"></div>
					</label>
				</span>
			</div>

			<div class="row flexrow nospace">
				<span class="threequarters padleft">
					ADA rooms needed
				</span>

				<span class="quarter centeralign">
					<label class="switch smaller noflex">
						<input
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_ada"
							property_name = "ada"
							target_type   = "judge"
							target_id     = "<% $judge->id %>"
							onChange      = "postSwitch( this, 'judge_switch.mhtml');"
							<% $judge->ada ? 'checked="checked"' : "" %>
						>
						<div class="slider"></div>
					</label>
				</span>
			</div>
<%perl>

			my $hybrid_sth = $dbh->prepare("
				select event.id
				from event
				where event.category = ?
				and exists (
					select es.id
					from event_setting es
					where es.event = event.id
					and es.tag = 'online_hybrid'
				)
			");

			$hybrid_sth->execute($category->id);
			my ($hybrid) = $hybrid_sth->fetchrow_array();

			if ($hybrid) {
</%perl>
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Online Hybrid Judge
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_online_hybrid"
								setting_name = "online_hybrid"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"online_hybrid"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

%			if ($cap_repel) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Chief Adjudicator's Panelist
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_chief_adjudicator"
								setting_name = "chief_adjudicator"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"
								<% $judge_settings{"chief_adjudicator"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

% 			if ($category_settings{"neutrals"}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Neutral: May judge own school
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_neutral"
								setting_name = "neutral"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"neutral"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
% 			}

% 			if ($category_settings{"track_diversity"} || $category_settings{"nats_category"}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Diversity enhancing
					</span>
					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_diverse"
								setting_name = "diverse"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"diverse"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
% 			}

% 			if ($tourn_settings->{"nsda_nats"}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Tab Room Staff
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_tab_room"
								setting_name = "tab_room"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"tab_room"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>

				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Exempt from Warnings
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_exempt_warnings"
								setting_name = "exempt_warnings"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"exempt_warnings"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
% 			}

% 			if ($category_settings{"prefer_congress"}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Prefers Congress at Nats?
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_prefers_congress"
								setting_name = "prefers_congress"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"prefers_congress"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

% 			if ($category_settings{"ask_parli"} || $tourn_settings->{"mock_trial_registration"}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
% 						if ($category_settings{"ask_parli"}) {
							Qualified Parliamentarian
%						} elsif ($tourn_settings->{'mock_trial_registration'}) {
							Qualified to Preside
%						}
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_parli"
								setting_name = "parli"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"parli"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
% 			}

% 			if ($category_settings{"exchange"} && $judge_settings{'hire_offer'}) {
				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Approved for Exchange Hire
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_hire_approved"
								setting_name = "hire_approved"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"hire_approved"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

% 			if ($category_settings{"first_year_outs"}) {

				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						First Year Out
%	 					if ($category_settings{"fyo_free_strikes"}) {
							(Free strike)
%						}
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_first_year"
								setting_name = "first_year"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"first_year"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>

				</div>

% 			}

% 			if ($category_settings{"prefs"} || $category_settings{"free_strikes_dont_count"}) {

				<div class="row flexrow nospace">
					<span class="threequarters padleft">
						Free Strike
% 						if ($category_settings{"free_strikes_dont_count"}) {
							(Does not meet obligation)
% 						}
					</span>

					<span class="quarter centeralign">
						<label class="switch smaller noflex">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_free_strike"
								setting_name = "free_strike"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"free_strike"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
% 			}

			<div class="row flexrow nospace"
				title="Judge will NOT be auto-placed but WILL appear as an available manual substitution"
			>
				<span class="threequarters padleft">
					Substitute Only
				</span>

				<span class="quarter centeralign">
					<label class="switch smaller noflex">
						<input
							type         = "checkbox"
							value        = "1"
							id           = "<% $judge->id %>_sub_only"
							setting_name = "sub_only"
							target_type  = "judge"
							target_id    = "<% $judge->id %>"
							onChange     = "postSwitch( this, 'judge_switch.mhtml');"

							<% $judge_settings{"sub_only"} ? 'checked="checked"' : "" %>
						>
						<div class="slider"></div>

					</label>
				</span>
			</div>

%           if ($tourn_settings->{"vaccines"} && ($perms->{"owner"} || $person->site_admin)) {

                <h5>Vaccine Status</h5>

%				if ($jperson) {

%                   my $status = $jperson->setting("vaccine_".$tourn->id);
%                   my $exempt = $jperson->setting("exempt_".$tourn->id);

                    <div class="row ltborderbottom">

                        <span class="twenty centeralign fa fa-tiny <% $status eq "confirmed" ? "fa-check greentext" : "fa-times redtext" %>"></span>

                        <span class="twofifths">
                            <% $jperson->first." ".$jperson->last %>
                        </span>

                        <span class="twofifths nospace centeralign">
							<select
								name         = "<% $jperson->id %>"
								class        = "fixedmost marno padno "
								setting_name = "vaccine_<% $tourn->id %>"
								person_id    = "<% $jperson->id %>"
								onChange     = "postSwitch(this, '/register/reports/vaccine_switch.mhtml');"
							>
								<option value="none">Not Started</option>
								<option <% $status eq "confirmed" ? "selected" : "" %> value="confirmed">Confirmed</option>
								<option <% $status eq "pending" ? "selected" : "" %> value="in_progress">In Progress</option>
							</select>
						</span>

						<span class="tenth nospace centeralign" title="Exempt">
							<& "/funclib/bool_switch.mas",
								person_id    => $jperson,
								tag          => "exempt",
								url          => "/register/reports/vaccine_switch.mhtml",
								value        => $exempt,
								tiny         => 1,
								onred        => 1
							&>
						</span>

                	</div>
%				}
%			}

		</div>

		<div class="sidenote">

%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

				<h4>
					Missed Round
				</h4>

				<form
					action = "bond_revoke.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<div class="full even">
					<span class="threequarters">
						<input
							class       = "notfirst"
							type        = "text"
							name        = "reason"
							size        = "30"
							placeholder = "Reason"
							tabindex    = -1
						>
					</span>
					<span class="quarter centeralign">
						<input
							type  = "submit"
							class = "notfirst"
							value = "Save"
						>
					</span>

				</div>

				</form>

%			}

			<h4>Strikes &amp; Prefs</h4>

%			foreach my $ocategory ($tourn->categories) {

% 				next unless $ocategory->setting("prefs");

				<a class="blue half"
					href="prefs.mhtml?judge_id=<% $judge->id %>&category_id=<% $ocategory->id %>"
				>
					Pref Sheet in <% $ocategory->abbr %>
				</a>

%			}

			<a class="blue full"
				href="conflict_sheet.mhtml?judge_id=<% $judge->id %>">
				Print Conflict Sheet
			</a>

		</div>

%		if (@questionnaires) {

			<div class="sidenote">

				<h4>Questionnaires</h4>

%					if ($category_settings{'nats_category'}) {
						<a
							class="full blue flexrow"
							href="nom_edit.mhtml?judge_id=<% $judge->id %>"
						>Late Elim Nomination</a>
%					}
<%perl>
					foreach my $tag (@questionnaires) {

						my $status = "INCOMPLETE";
						$status = "COMPLETE" if $judge_settings{"form_complete_".$tag};

						my $quiz = Tab::Quiz->retrieve($tag);
						next unless $quiz;

						my $answers = Tab::PersonQuiz->search(
							person => $jperson->id,
							quiz   => $quiz->id
						)->first;

</%perl>
						<a
							class="full blue flexrow"
							href="questionnaire.mhtml?judge_id=<% $judge->id %>&quiz_id=<% $tag %>"
						>
							<span class='threequarters'>
								<% $quiz->label %>
							</span>
							<span class='quarter rightalign semibold padright'>
								<% $answers ? $answers->completed ? "COMPLETE" : "INCOMPLETE":  "UNSTARTED" %>
							</span>
						</a>
%				}

			</div>
%		}

%       if ($category->shifts) {

			<div class="sidenote">

			<h5>Shifts Blocked</h5>
<%perl>
	   		foreach my $shift (
				sort {$a->start->epoch <=> $b->start->epoch}
				$category->shifts
			) {

				my $start = $shift->start->set_time_zone($tz);
				my $end = $shift->end->set_time_zone($tz);

				my $day_string = $start->day_abbr;

				my $start_string = $start->hour_12.":".$start->strftime('%M')." ".substr($start->strftime('%p'), 0, 1);
				my $end_string = $end->hour_12.":".$end->strftime('%M')." ".substr($end->strftime('%p'), 0, 1);

				my $alert;

				unless ($shift->start < $tourn->end  && $shift->end > $tourn->start) {
					$alert++;
				}

</%perl>
				<label for="shift_<% $shift->id %>">

					<div class="row hover smallish">

%						if ($alert) {
							<span class="redtext semibold explain centeralign ltborderbottom">
								Warning: This shift block does not cover any part of your tournament.
								It will have no effect.
							</span>
%						}

						<span class="third padleft semibold redtext smallish nowrap">
							<% $shift->name %>
						</span>

						<span class="twenty marno padless smallish <% $alert ? "orangetext semibold" : "" %>">
							<% $alert ? $start->month.'/'.$start->day : $day_string %>
						</span>
						<span class="fifth marno padless rightalign smallish">
							<% $start_string %>
						</span>-<span class="fifth marno padless smallish">
							<% $end_string %>
						</span>

						<span class="eighth marno hover rightalign">
							<label class="switch smaller noflex">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "shift_<% $shift->id %>"
									target_id     = "<% $judge->id %>"
									setting_name  = "<% $shift->id %>"
									property_name = "shift"
									onChange      = "postSwitch(this, 'strike_switch.mhtml');"
									<% $shift->strike($judge) ? 'checked="checked"' : "" %>
								>
								<div class="slider onred smallish"></div>
							</label>
						</span>
					</div>
				</label>
				</form>
%			}

			</div>
%      	}

%		if ($category_settings{'exchange'}) {

			<div class="sidenote">

				<h4>Rounds Hired</h4>

				<p>Tap a request to cancel</p>

<%perl>

				foreach my $hire ($judge->hires) {

					my $warn = "This action will break a judge hire arrangement
					between that school and that judge.  Are you sure?";

</%perl>
					<a
						class="nowrap blue full"
						href="hire_cancel.mhtml?hire_id=<% $hire->id %>&back=judge"
					>
						<% $hire->rounds_requested %> rounds to <% $hire->school->short_name %>
					</a>
%				}

			</div>

%		}

% 		if ($category_settings{"coach_ratings"} || $category_settings{'self_ratings'}) {

			<div class="sidenote">

			<h4>Ratings</h4>

			<form
				action = "rating_save.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				value = "<%$judge->id%>"
				name  = "judge_id"
			>
<%perl>
			if ($category->rating_subsets) {

				foreach my $subset ($category->rating_subsets) {

					my $rating = $m->comp(
						"/funclib/judge_rating.mas",
						judge  => $judge,
						subset => $subset
					);
</%perl>
					<div class="row flexrow nospace">
						<span class="quarter nowrap">
							<span class='quarterspacer'></span>
							<% $subset->name %>
						</span>

						<span class="threequarters centeralign">

							<select
								class    = "fixedsmall plain"
								name     = "<% $subset->id %>_rating"
								onchange = 'this.form.submit()'
							>

								<option value="">Unrated Judge</option>

%								foreach my $tier (
%									sort {$a->name cmp $b->name}
%									$category->rating_tiers(type => "coach")
%								) {

									<option value="<% $tier->id %>"
										<% ($rating
												&& $rating->rating_tier
												&& $tier->id == $rating->rating_tier->id)
											? "selected"
											: ""
										%>
									>
										<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}

							</select>

						</span>

					</div>

%				}

%			}  else {

%				my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge);

				<div class="row flexrow nospace">
					<span class="quarter nowrap">
						<span class='quarterspacer'></span>
						<% $category->abbr %>
					</span>

					<span class="threequarters nospace centeralign">

						<select
							name     = "rating"
							onChange = 'this.form.submit()'
							class    = "fixedsmall"
						>

							<option value="">
								Unrated
							</option>

<%perl>
							foreach my $tier (
								sort {$a->name cmp $b->name}
								$category->rating_tiers(type => "coach")
							) {
</%perl>
								<option value="<% $tier->id %>"
									<% $rating
											&& $rating->rating_tier
											&& ($tier->id == $rating->rating_tier->id)
										? "selected"
										: ""
									%>
								>
									<% $tier ? $tier->name : "" %> -
									<% $tier ? substr($tier->description,0,15) : "" %>
								</option>
%							}

						</select>
					</span>

				</div>

%			}

			<noscript>
				<div class="libl full rightalign">
					<input
						class = "thin"
						type  = "submit"
						value = "Save Ratings"
					>
				</div>
			</noscript>

			</form>
		</div>

% 		}

		<div class="sidenote">
			<h4>Wreak Havoc</h4>

<%perl>
			if ($school && $school->chapter > 0) {

				my $jcj_id = eval {
					return $judge->chapter_judge->id;
				};

				my $judge_sth = $dbh->prepare("
					select cj.id, cj.first, cj.middle, cj.last, person.email
					from (chapter_judge cj, school)
						left join person on person.id = cj.person
					where school.id = ?
						and cj.chapter = school.chapter
						and cj.retired = 0
					order by cj.last, person.id DESC
				");

</%perl>
				<h5>Swap w/School Judge</h5>

				<form
					action = "judge_swap.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "judge_id"
					value = "<% $judge->id %>"
				>

				<div class="row">

					<span class="centeralign fourfifths">
						<select name = "chapter_judge_id" class="notfirst">
							<option value="">Not On Roster</option>
<%perl>
							$judge_sth->execute($school->id);

							while (
								my (
									$cj_id, $cj_first, $cj_middle, $cj_last, $cj_email
								) = $judge_sth->fetchrow_array()
							) {
</%perl>
								<option value="<% $cj_id %>"
									<% ($cj_id eq $jcj_id) ? 'selected' : '' %>
									> <%
										$cj_last.", ".$cj_first." ".$cj_middle." "
									%> <%
										$cj_email ? "(".$cj_email.")" : ""
									%>
								</option>
%							}
						</select>
					</span>

					<span class="fifth centeralign">
						<input
							type  = "submit"
							class = "thin notfirst notfirst"
							value = "Swap"
						>
						</form>
					</span>
				</div>
%			}


%				if ($person->site_admin) {
					<a
						href="/register/data/export_judge.mhtml?judge_id=<% $judge->id %>"
						class="yellow full"
					>
						Backup Judge Data
					</a>
%				}

				<a
					href="drop.mhtml?judge_id=<% $judge->id %>"
					class="martopmore dkred full"
				>
					Delete Judge Altogether
				</a>

		</div>

	</div>

