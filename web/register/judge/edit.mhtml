 <%args> 
	$tourn
	$tourn_settings
	$person
	$perms
	$judge_id      => undef
	$only_category => undef
	$default       => "edit"
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	$m->abort unless $judge;

	my %judge_settings = $judge->all_settings;

	my $school = $judge->school;

	my $district = $school->district 
		if $tourn_settings->{"nsda_nats"};

	my $diocese = $school->region 
		if $tourn_settings->{"ncfl"};

	my $category = $judge->category;
	my %category_settings = $category->all_settings;

	my $cap_repel;
	my $usa_wsdc;

	foreach my $event ($category->events) { 
		$cap_repel++ if $event->setting("wsdc_cap_repel");
		$usa_wsdc++ if $event->setting("usa_wsdc");
	}

	my @schools = sort {$a->name cmp $b->name} $tourn->schools;

	my @districtschools;

	if ($district) { 
		@districtschools = 
			sort {$a->name cmp $b->name} 
			$district->schools(tourn => $tourn->id);
	}

	my @dioschools;

	if ($diocese) { 
		@dioschools = 
			sort {$a->name cmp $b->name} 
			$diocese->schools(tourn => $tourn->id);
	}

 	my @panels = $m->comp(
		'/funclib/judge_panels.mas', 
		judge => $judge
	);

	my @online = $m->comp(
		"/funclib/category_online.mas", 
		category => $category
	);

	my $hired++ unless $school && $school->id;

	my $num_sites = scalar($tourn->sites);

	my @this_jpools;
	my @other_jpools;

	my @questionnaires;
	my $ask_parli;
	my $prefer_congress;

	my %in_jpool = map {$_->id => $_} $judge->jpools();

	my @sub_pools;

	if ($tourn_settings->{"nsda_nats"}) { 

		push @questionnaires, "NSDADiversity";

		push @this_jpools, $m->comp(
			"/funclib/category_jpools.mas",
			category => $category,
			limit   => "registrant"
		);

		foreach my $jpool (@this_jpools) { 
			next unless $in_jpool{$jpool->id};
			push @sub_pools, $jpool->children();

			push @questionnaires, $jpool->setting("paradigm_form") 
				if $jpool->setting("paradigm_form");

			$ask_parli++ if $jpool->setting("parli");
			$prefer_congress++ if $jpool->setting("prefer");
		}

	} else { 

		push @this_jpools, $judge->category->jpools();

		push @this_jpools, $judge->alt_category->jpools 
			if $judge->alt_category > 0;

		foreach my $category (sort {$a->abbr cmp $b->abbr} $tourn->categories) { 
			next if $category == $judge->category;
			next if $category == $judge->alt_category;

			push @other_jpools, sort {$a->name cmp $b->name} $category->jpools;
		}
	}
   		
	push @questionnaires, $category_settings{"paradigm_form"}
		if $category_settings{"paradigm_form"};

	@this_jpools = sort {$a->name cmp $b->name} @this_jpools;

	my %seen = (); 
	@this_jpools = grep { ! $seen{$_->id} ++ } @this_jpools;
	@other_jpools = grep { ! $seen{$_->id} ++ } @other_jpools;

	my @tabs;
	push @tabs, "edit";
	push @tabs, "pools" if @this_jpools || @other_jpools;
	push @tabs, "noms" if $judge_settings{"nomination"};

	push @tabs, "rounds" if @panels;
	push @tabs, "paradigm" if ($category_settings{"ask_paradigm"} && $judge->person);

	my %links;
	$links{"strikes"} = "judge_strikes.mhtml?judge_id=".$judge->id;
	
	my %reasons;

	%reasons = $m->comp(
		"/funclib/judgemath/nats_check_judging.mas", 
		school => $school
	) if $tourn_settings->{"nsda_nats"};
</%init>

	<script>
	
		function statusSwitch(targetStatus) { 
			$("."+targetStatus).toggleClass('hidden');
			$(".judge"+targetStatus).toggleClass('redtext');
		}

		function submitLink() { 

			var accountEmail = $("#accountEmail").val();
			var judgeId      = $("#accountEmail").attr("judge");
			var replyUrl     = 'link.mhtml';

			console.log("Submitting to "+replyUrl);

			$.ajax({ 
				type    : 'POST',
				url     : replyUrl,
				data    : { 
					judge_id : judgeId,
					email    : accountEmail
				},
				success : function(data) {

					if (data.error) { 

						alertify.error(data.message);

					} else {

						if (data.reply) { 

							var replyContent = '<a href="mailto: '+data.reply+'"';
							replyContent += 'class = "white bluetext">';
							replyContent += data.reply+'</a>';

							$(".replybucket").html(replyContent);

							$("#identityBox").removeClass("hidden");
							$("#linkBox").addClass("hidden");
							$("#linkBox").removeClass("row");
							$("#identityBox").addClass("row");
						}

						if (data.message) { 

							alertify.notify(data.message, "custom");

						}

						zebraRows();
					}
				}
			});
		};

		$(document).ready(function() {
			$('.noEnterSubmit').keypress(function(e){
				if ( e.which == 13 ) { 
					e.preventDefault();
					submitLink();
				}
			});
		});

	</script>

	<& "/funclib/editor.mas" &>

%	if ($only_category || $hired || $perms->{"details"}) { 
		<div class="main">

		<% $school ? '<h2>'.$school->name.'</h2>' : "" %>

%	} else {
    	<& 
			"/register/menubar.mas", 
			school         => $school,
			whoami         => "judges",
			reasons        => \%reasons,
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>
%	}

	<span class="half marno padless padvert judgeactive <% $judge->active ? "" : "redtext" %>">
		<h5 class="inline">
			<% $category_settings{"no_codes"} ? "" : $judge->code %>
			<% $judge ? $judge->first." ".$judge->last : "Add Judge" %>
			<h6 class="active semibold redtext inline <% $judge->active ? "hidden" : "" %>">
				&ndash; INACTIVE
			</h6>
		</h5>

	</span>

	<span class="half nospace rightalign">

		<&
			"/funclib/tabs.mas",
				tabs    => \@tabs,
				links   => \%links,
				default => $default,
				right   => "true",
				buttons => "true",
				large   => "true"
		&>

	</span>

	<div 
		id    = "edit"
		class = "edit screens hidden"
	>

	<form 
		action = "save.mhtml"
		method = "post"
	>

	<input 
		type  = "hidden"
		name  = "judge_id"
		value = "<% ($judge) ? $judge->id : "" %>"
	>

	<span class="pagehalf padtop">

		<div class="row">

			<span class="twofifths padleft">
				First
			</span>

			<span class="threefifths">
				<input 
					type        = "text"
					name        = "first"
					class       = "starthere"
					size        = "24"
					value       = "<% $judge->first %>"
					placeholder = "First Name"
				>
			</span>
		</div>

		<div class="row">

			<span class="twofifths padleft">
				Middle
			</span>

			<span class="threefifths">
				<input 
					type        = "text"
					name        = "middle"
					size        = "24"
					value       = "<% $judge->middle %>"
				>
			</span>
		</div>

		<div class="row">

			<span class="twofifths padleft">
				Last
			</span>

			<span class="threefifths">
				<input 
					type        = "text"
					name        = "last"
					size        = "24"
					value       = "<% $judge->last %>"
					placeholder = "Last Name"
				>

			</span>
		</div>

%			unless ($category_settings{"no_codes"}) { 

				<div class="row">

					<span class="twofifths padleft">
						Code
					</span>

					<span class="threefifths">
						<input
							type  = "text"
							name  = "code"
							size  = "24"
							value = "<% $judge->code %>"
						>
					</span>
	
				</div>

<%perl>
			if ($tourn_settings->{"nsda_nats"}) { 

				unless ($judge->code) { 

					my $judge_code = $m->comp(
						"/funclib/judge_code.mas", 
						judge => $judge
					);
</%perl>

					<div class="row">

						<span class="third marno centeralign semibold bluetext padsetting">
							Next Free Code:
						</span>

						<span class="twothirds padsetting rightalign">
							<% $judge_code %> 
						</span>

					</div>

%				}
%			}
%		}


		<div class="row">

			<span class="twofifths padleft">
				School
			</span>

			<span class="threefifths">
				<select 
					name  = "school"
					class = "fixedmed"
				>
					<option value="">Hired</option> 
<%perl>
					my %school_already;

					if ($district) { 

 						foreach my $dschool (@districtschools) { 
							$school_already{$dschool->id}++;
</%perl>
								<option value="<% $dschool->id %>" 
									<% ($dschool->id eq $school->id) ? 'selected' : '' %> 
								> <% $dschool->short_name %> </option>
%						} 

						<option value="">
							---Other Districts:---
						</option>

<%perl>
					}

 					if ($diocese) { 

 						foreach my $dschool (@dioschools) { 

							$school_already{$dschool->id}++;
</%perl>

								<option value="<% $dschool->id %>" 
									<% ($dschool->id eq $school->id) ? 'selected' : '' %> 
								> <% $dschool->short_name %> </option>
%						} 
						<option value="">
							---Other Dioceses:---
						</option>
<%perl>
					}

					foreach my $oschool (@schools) { 

						next if $school_already{$oschool->id}++;
</%perl>

						<option value="<% $oschool->id %>" 
							<% ($oschool->id eq $school->id) ? 'selected' : '' %> 
						> <% $oschool->name%> </option> 
%					} 
	
				</select>

			</span>

		</div>

%		if ($school && $school->chapter > 0) { 
			<div class="row">

				<span class="twofifths padleft">
					Roster Judge:
				</span>

				<span class="threefifths">
					<select 
						name  = "chapter_judge"
						class = "fixedmed"
					>
					<option value=""></option>
%					foreach my $cj ($school->chapter->chapter_judges(retired => 0)) { 
						<option value="<% $cj->id %>" 
							<% ($cj->id eq $judge->chapter_judge) ? 'selected' : '' %> 
							> <% $cj->first." ".$cj->last %> </option>
%					} 
					</select>
				</span>
			</div>
%		} 

%		if ($tourn_settings->{"nsda_nats"}) { 

%			if ($school && $district) { 

				<div class="row">

					<span class="twofifths padleft">
						District
					</span>
						
					<span class="half marno padsetting bluetext semibold">
						<% $district ? $district->code." ".$district->name : "" %>
					</span>

					<span class="tenth padsetting centeralign bluetext semibold">
						<% $school ? $school->state : "" %>
					</span>
				</div>
<%perl>

			} 

		}

			if ($category_settings{"rounds_per"} 
				|| $category_settings{"nats_category"}
			) { 

			  	my $max_rounds = $category_settings{"max_rounds"};
				$max_rounds = 99 if $tourn_settings->{"nsda_nats"};

</%perl>

				<div class="row">

					<span class="twofifths padleft">
						Round Obligation
					</span>

					<span class="threefifths">
						<input
							type  = "number"
							name  = "obligation"
							min   = "0"
							max   = "<% $max_rounds %>"
							value = "<% $judge->obligation %>"
							size  = "16"
							class = "larger"
						>
					</span>
	
				</div>

%				unless ($tourn_settings->{"nsda_nats"}) { 
					<div class="row">
						<span class="twofifths padleft">
							Hired Rounds
						</span>

						<span class="threefifths">
							<input
								type  = "number"
								name  = "hired"
								min   = "0"
								max   = "<% $max_rounds %>"
								size  = "16"
								class = "larger"
								value = "<% $judge->hired %>">
						</span>
		
					</div>
%				}

%				if ($category_settings{"exchange"}) { 

					<div class="row">

						<span class="threequarters">
							Hired Rds On Offer
						</span>

						<span class="quarter">
							<input
								type  = "number"
								name  = "hire_offer"
								min   = "0"
								max   = "<% $max_rounds - $judge->obligation %>"
								size  = "10"
								value = "<%
								$judge_settings{'hire_offer'} %>">
						</span>
		
					</div>
%				}

%			}
			
%			if ($category_settings{"tab_ratings"}) { 

				<div class="row">

					<span class="threequarters">
						Tab Rating:
					</span>

					<span class="quarter">
						<input 
							type  = "number"
							name  = "tab_rating"
							min   = "0"
							max   = "999"
							value = "<% $judge_settings{"tab_rating"} %>"
						>
					</span>
		
				</div>

%			}

%			if ($tourn_settings->{"nsda_nats"}) { 

				<div class="row">

					<span class="twofifths padleft">
						Merit #
					</span>

					<span class="threefifths">
						<input
							type  = "number"
							name  = "ualt_id"
							size  = "16"
							class = "larger"
							value = "<% $judge_settings{"ualt_id"} %>"
						>
%						if ($judge_settings{"diamonds"}) { 

							<span class="third bigger orangetext semibold">
								<span class="half nospace">
									<h6 class="semibold nospace rightalign">
										<% $judge_settings{"diamonds"} %>
									</h6>
								</span>
								<span class="fa fa-lg fa-diamond fourtenths"></span>
							</span>
%						}
					</span>
		
				</div>

<%perl>
			}

			if ($usa_wsdc) { 

				my $original_school = 
					Tab::School->retrieve($judge_settings{"original_school"}) 
					if $judge_settings{"original_school"};

</%perl>
				<div class="row">
		
					<span class="third padleft">
						Real School:
					</span>	
					
					<span class="twothirds rightalign">
						<select name="original_school">
							<option value=""></option>
%							foreach my $school ($district->schools) { 
								<option 
									value="<% $school->id %>"
									<% $school->id == $judge_settings{"original_school"} 
										? 'selected'
										: ""
									%>
								><% $school->short_name %></option>

%							}
						</select>
					</span>

				</div>
%			}

%			if ($tourn_settings->{"ncfl"}) { 

				<div class="row padmore">
				
					<span class="third padleft">
						Diocese
					</span> 
				
					<span class="twothird">
						<span class="threequarters">
							<% $school 
								&& $school->region 
								? $school->region->name 
								: ""
							%>
						</span>

						<span class="quarter">
							<% $school 
								&& $school->region 
								? $school->region->code 
								: ""
							%>
						</span>
					</span> 

				</div>

%			}

		</span>

		<span class="pagehalf padtop">

%			if ($judge && $judge->person_request > 0) { 
%				unless ($judge->person > 0) { 

%				my $request = $judge->person_request;

				<div class="row">

					<span class="third semibold redtext">
						Access Request:
						<% $request->first." ".$request->last %>
					</span>

					<span class="third">
						<a class="white" href="mailto:<% $request->email %>">
							<% $request->email %>
						</a>
					</span>

					<span class="sixth centeralign">
						<a 
							class="greentext buttonwhite fa fa-check"
							href="permit.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
						>
						</a>
					</span>

					<span class="sixth centeralign">
						<a 
							class="redtext buttonwhite fa fa-times"
							href="deny.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
						>
						</a>
					</span>

				</div>

%			} }

				<div 
					id="identityBox"
					class="<% ($judge->person > 0) ? "row" : "hidden" %>"
				>

					<span class="fifth centeralign">
						Linked:
					</span>

					<span class="replybucket fiveeighths semibold pademail centeralign">
%						if ($judge->person > 0) { 
							<a 
								href  = "mailto:<% $judge->person->email %>"
								class = "white bluetext"
								title = "<% $judge->person->email %>"
							>
								<% $judge->person->email %>
							</a>
%						}
					</span>

					<span class="eighth rightalign">

%						my $warn = "This will render this person unable to access online ballots. You sure, now?";
				
						<a 
							class = "buttonwhite redtext fa fa-chain-broken fa-sm"
							title = "<% $warn %>"
							href="unlink.mhtml?judge_id=<% $judge->id %>" 
							<& "/funclib/confirm.mas", warn => $warn &> 
						>
						</a>
					</span>
				</div>

%			unless ($judge->person > 0) { 

				<div 
					id="linkBox"
					class = "row"
					title = "Link this user to an online Tabroom account"
				>

					<span class="fifth marno padleft">
						Link To:
					</span>

					<span class="threefifths centeralign">
						<input 
							id          = "accountEmail"
							judge       = "<% $judge->id %>"
							type        = "email"
							name        = "username"
							class       = "noEnterSubmit"
							size        = "24"
							placeholder = "Tabroom login/email"
							onBlur      = "submitLink();"
						>
					</span>

					<span class="eighth rightalign">
						<input 
							type    = "button"
							class   = "thin button"
							value   = "Link"
							onClick = "submitLink();"
						>
					</span>

				</div>

%			}

			<div class="row">

				<span class="twofifths padleft">
					Judge category
				</span> 
			
				<span class="threefifths">

					<select name="category" class="fixedsmall">
<%perl>
 						foreach my $tcategory (
							sort {$a->name cmp $b->name} 
							$tourn->categories
						) { 
</%perl>
							<option value="<% $tcategory->id %>" 
								<% ($category && $category->id == $tcategory->id) 
									? 'selected' 
									: ''
								%>
							><% $tcategory->name %></option>
%						} 

						<option>-----------------------------</option>

					</select> 
				</span> 

			</div> 

			<div class="row">
		
				<span class="twofifths padleft">
					Covers entries in
				</span> 
				
				<span class="threefifths">
					<select name="covers" class="fixedsmall ">

						<option value="">
							None Selected
						</option> 

%	 					foreach my $tcategory (sort {$a->name cmp $b->name} $tourn->categories) {
							<option value="<% $tcategory->id %>"
								<% ($judge->covers && $tcategory->id == $judge->covers->id) 
									? 'selected' : '' %> 

								<% ($category && $category->id == $tcategory->id) &! $judge->covers 
									? 'selected' : '' %>
							>

								<% $tcategory->name %> 
							</option>
%						}  

						<option>-----------------------------</option>
					</select>
				</span>

			</div>

			<div class="row">
	
				<span class="twofifths padleft">
					Phone
				</span>	
				
				<span class="threefifths">

					<input 
						type  = "tel"
						name  = "phone"
						size  = "24"
						value = "<% $judge->person > 0 
							? Tab::phoneme($judge->person->phone)
							: Tab::phoneme($judge_settings{"phone"})
						%>">
				</span>

			</div>

			<div class="row">
	
				<span class="twofifths padleft">
					Email
				</span>	
				
				<span class="threefifths">
					<input 
						type  = "email"
						name  = "email"
						size  = "24"
						value = "<% $judge->person > 0
									? $judge->person->email 
									: $judge_settings{"email"} 
								%>">
				</span>

			</div>

			<div class="row">

				<span class="twofifths padleft">
					Special Job
				</span>
				
				<span class="threefifths">
					<input
						type  = "text"
						name  = "special"
						size  = "24"
						value = "<% $judge_settings{'special_job'} %>"
					>
				</span>

			</div> 
			
			<div class="row">

				<span class="twofifths padleft">
					Coach Notes
				</span>

				<span class="threefifths">
					<input 
						type  = "text"
						name  = "notes"
						size  = "24"
						value = "<% $judge_settings{'notes'} %>"
					>
				</span>

			</div>

% 			if ($category_settings{"ask_alts"}) {

				<div class="row">

					<span class="twofifths">
						Also judges
					</span>
				
					<span class="threefifths">
						<select 
							name  = "alt_category"
							class = "fixedsmall"
						>

							<option value="">
								None Selected
							</option>

<%perl>
	 						foreach my $tcategory (
								sort {$a->name cmp $b->name} 
								$tourn->categories
							) {

								next if $tcategory->id == $category->id;
</%perl>
	
								<option value="<% $tcategory->id %>"
									<% ($judge->alt_category 
										&& $tcategory->id == $judge->alt_category->id) 
										? 'selected' 
									: '' 
								%>><% $tcategory->name %></option>
%							}  

						</select>

					</span>

				</div>

%			}

%			if ($person->site_admin) { 

%				unless ($tourn_settings->{"nsda_nats"}) { 

					<div class="row">

						<span class="twofifth">
							CAT import ID
						</span>

						<span class="threefifths">
							<input
								type  = "number"
								name  = "cat_id"
								size  = "16"
								class = "larger"
								value = "<% $judge_settings{"cat_id"} %>"
							>
						</span>

					</div>

					<div class="row">

						<span class="twofifth">
							JOT import ID
						</span>

						<span class="threefifths">
							<input 
								type  = "number"
								name  = "jot_id"
								size  = "16"
								class = "larger"
								value = "<% $judge_settings{"jot_id"} %>"
							>
						</span>

					</div>

%				}
%			}

		</span>

% 		if ($category_settings{"judge_quals"}) {
			
			<div class="row marno">

				<span class="full padless">
					Qualifications:
				</span>

				<span class="full centeralign padless marno">
					<textarea 
						name="qual_history" 
						rows="5" 
						cols="45"
					><% $judge_settings{"qual_history"} %></textarea>
				</span>

			</div>
%		}

		<div class="libl full rightalign martopno">
			<input  
				type  = "submit"
				value = "Save Judge Information"
			>
			</form>
		</div>

	</div>

%	if (@panels) { 

		<div 
			id    = "rounds"
			class = "rounds hidden screens"
		>

			<span class="half">
				<h5>Round Assignments:</h5> 
			</span>

			<span 
				id    = "assignments_buttonarea"
				class = "half rightalign"
			>

				<a 
					href  = "print_sheet.mhtml?judge_id=<% $judge->id %>"
					class = "buttonwhite bluetext fa fa-sm fa-list"
					title = "Info Sheet/Dance Card"
				>
				</a> 
		
%				if ($tourn_settings->{"ncfl"}) { 
					<a 
						class = "buttonwhite orangetext fa fa-sm fa-address-card"
						title = "NCFL Judge Card"
						href  = "/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>" 
					>
					</a>
%				}
			</span>

			<& "/funclib/tablesorter.mas", table => "assignments" &>

			<table id="assignments">

				<thead>

					<tr class="yellowrow smallish">

						<th>
							Event
						</th>

						<th>
							Round
						</th>

						<th>
							Start
						</th>

						<th>
							Room
						</th>

						<th>	
							Entries
						</th>

						<th>
							
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>
				
			foreach my $panel (
				sort {$a->round->timeslot->start <=> $b->round->timeslot->start} 
				$m->comp("/funclib/judge_panels.mas", judge => $judge)
			) { 

				my $round = $panel->round;

				my $start_time = $round->start_time;
				$start_time = $round->timeslot->start unless $start_time;

				my $tz = $tourn->tz;
				$tz = "UTC" unless $tz;

				$start_time->set_time_zone($tz);

</%perl>

				<tr>

					<td>
						<% $panel->eventname %>
					</td>

					<td>
						<span class="hidden"><% $round->name %>-<% $panel->flight %></span>
						<% $round->realname %>
						<% $panel->flight > 1 ? "Flt ".$panel->flight : "" %>
					</td>

					<td>
						<span class="hidden"><% $start_time->epoch %></span>
						<% Tab::niceshortdayt($start_time) %>
					</td>

					<td>
						<% $panel->roomname %>
					</td>

					<td>
%						foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) { 
							<span class="padless">
								<% $entry->code %>
							</span>
%						}
					</td>

					<td class="centeralign padless">
						<a 
							class = "buttonwhite bluetext fa fa-lg fa-eye"
							target= "_blank"
							href  = "/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>"
						>
						</a>
					</td>

				</tr>
				
% 			} 

			</tbody>

			</table>

		</div>

<%perl>
 	} 

 	if (@this_jpools || @other_jpools) { 
		my %used;

</%perl>
		<div id="pools" 
			class="screens pools hiddden"
		>
%			if ($tourn_settings->{"ncfl"}) { 
				<span class="third">
					<a 
						class = "buttonwhite orangetext fa fa-sm fa-address-card"
						title = "NCFL Judge Card"
						href  = "/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>" 
					>
					</a>
				</span>
%			}
			<span class="twothirds rightalign">
				<p class="explain nospace semibold bluetext">
					Click a pool to move the judge in/out of it
				</p>
			</span>

			<span class="pagehalf">

				<h5>In <span class="incount"></span>:</h5>

				<& 
					"/funclib/tablesorter.mas", 
					table     => "insort",
					nobuttons => 1
				&>

				<table id="insort">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ($num_sites > 1) { 
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>

					</thead>

					<tbody id="in">
<%perl>
					foreach my $pool (@this_jpools, @other_jpools) { 

						next unless $in_jpool{$pool->id};

						$used{$pool->id}++;
</%perl>

						<tr
							class    = "judge smallish hover"
							pool_id  = "<% $pool->id %>"
							judge_id = "<% $judge->id %>"
							id       = "<% $pool->id %>"
							onClick  = "togglePool(this);"
						>

							<td>
								<% $pool->name %>
							</td>

							<td>
								<% $pool->category->abbr %>
							</td>

%							if ($num_sites > 1) { 
								<td class="cellmax nowrap">
									<% $pool->site->name %>
								</td>
%							}

							<td class="nowrap rightalign">
								<% scalar $pool->judges %>
							</td>

						</tr>
%					}

					</tbody>

				</table>

			</span>

			<span class="pagehalf">

				<h5>Not in <span class="outcount"></span>:</h5>

				<& "/funclib/tablesorter.mas", 
					table     => "outsort",
					nobuttons => 1
				&>

				<table id="outsort">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ($num_sites > 1) { 
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>

					</thead>

					<tbody id="out">
<%perl>
					foreach my $pool (@this_jpools, @other_jpools) { 

						next if $used{$pool->id}++;
</%perl>

						<tr
							class    = "judge smallish hover"
							pool_id  = "<% $pool->id %>"
							judge_id = "<% $judge->id %>"
							id       = "<% $pool->id %>"
							onClick  = "togglePool(this);"
						>

							<td>
								<% $pool->name %>
							</td>

							<td>
								<% $pool->category->abbr %>
							</td>

%							if ($num_sites > 1) { 
								<td class="cellmax nowrap">
									<% $pool->site->name %>
								</td>
%							}

							<td class="nowrap rightalign">
								<% scalar $pool->judges %>
							</td>

						</tr>
%					}

					</tbody>

				</table>

			</span>

		<script type="text/javascript">

			$(document).ready( function(){
				countPools();
			});

			function countPools() { 

				var countIn = $("#in .judge:visible").length;
				var countOut = $("#out .judge:visible").length;

				$("#outcount").text(countOut);
				$("#incount").text(countIn);

				$("#insort").trigger("applyWidgets");
				$("#insort").trigger("update");
				$("#insort").trigger('resort');

				$("#outsort").trigger("applyWidgets");
				$("#outsort").trigger("update");
				$("#outsort").trigger('resort');

			}

			function togglePool(judgeSpan) { 

				var parentID = $(judgeSpan).closest("tbody").attr("id");
				var judgeID  = $(judgeSpan).attr("judge_id");
				var poolID   = $(judgeSpan).attr("pool_id");

				var postValue, newParent;

				console.log("Parent is "+parentID);

				if (parentID === "in") { 

					postValue = 0;
					newParent = "out";

				} else { 

					postValue = 1;
					newParent = "in";

				}

				$.ajax({
					url: '/panel/judge/jpool_judge_switch.mhtml',
					type: 'POST',
					data: { 
						judge_id : judgeID,
						value    : postValue,
						jpool_id : poolID,

					}, success: function(data) { 

						if (data.error) { 
							
							alertify.error(data.message);

						} else { 

							alertify.set('notifier','delay', 2);
							alertify.notify(data.message, "custom");
							alertify.set('notifier','delay', 5);

							$("#"+poolID).prependTo("#"+newParent)

						}

						countPools();
					}

				});
			}

		</script>

		</div>

% 	}

%	if ($category_settings{"ask_paradigm"} && $judge->person) { 

		<div 
			id    = "paradigm"
			class = "screens paradigm hidden"
		>
			<h4>Paradigm</h4>
				
			<div class="even full">
				<% $judge->person->setting("paradigm") %>
			</div>

		</div>
%	 }

%	if ($judge_settings{"nomination"}) { 

%		my %nom = %{JSON::decode_json($judge_settings{"nomination"})};

		<div 
			id    = "noms"
			class = "screens noms hidden"
		>

			<h6>Late Elim Nomination</h6>

			<div class="row padvert">

				<span class="third semibold">
					Self Nominated:
				</span>
				<span class="sixth centeralign semibold bluetext centeralign">
					<% $nom{"self_nominated"} ? "Y" : "" %>
				</span>

				<span class="third semibold bluetext">
					Chair Nominated:
				</span>
				<span class="sixth centeralign semibold bluetext centeralign">
					<% $nom{"chair_nominated"} ? "Y" : "" %>
				</span>

			</div>

			<div class="row padvert">

				<span class="third semibold">
					Diversity:
				</span>
				<span class="sixth centeralign semibold bluetext centeralign">
					<% $judge_settings{"diverse"} ? "Y" : "" %>
				</span>

				<span class="sixth semibold">
					Phonetic
				</span>
				<span class="third">
					<% $nom{'phonetic'} %>
				</span>

			</div>
			
			<div class="row padvert">

				<span class="third semibold">
					Types of Event:
				</span>
				<span class="twothirds">
<%perl>
					my $notfirst;
					foreach my $type (keys %{$nom{"type"}}) { 
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"chair"}}) { 
						next if $type eq "middle";
						next if $type eq "speech";
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"speech_types"}}) { 
						$m->print(", ") if $notfirst++;
						$m->print(ucfirst($type));
					}

					foreach my $type (keys %{$nom{"middle_types"}}) { 
						$m->print(", ") if $notfirst++;
						$m->print("MS ") if $notfirst++;
						$m->print(ucfirst($type));
					}

</%perl>
				</span>
			</div>

			<div class="row padvert">
				<span class="quarter semibold bluetext">
					Supporting Info:
				</span>
				<span class="threequarters"> 
					<% $nom{'text'} %>
				</span>
			</div>

			<div class="row libl rightalign padvert">
				<a 
					class="buttonwhite bluetext fa fa-lg fa-edit invert marrightmore"
					href="nom_edit.mhtml?judge_id=<% $judge->id %>"
				> Edit Nomination</a>
			</div>
				
		</div>
%	 }

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Information</h4>

%			if ($only_category || $perms->{"details"}) { 

%			} elsif ($hired) { 

				<a 
					class = "blue full" 
					href  = "/register/judge/roster.mhtml?category_id=<% $category->id %>&hires=1"
				>
					Hired Judges
				</a>

%			} elsif ($school && $category) { 

				<a 
					class = "blue full" 
					href  = "/register/school/judges.mhtml?school_id=<% $school->id %>&category=<% $category->id %>">
					<% $school->short_name %> <% $category->abbr %> Judges
				</a>

%			}

%			if ($category) { 
				<a 
					class="blue full" 
					href="/register/judge/roster.mhtml?category_id=<% $category->id %>">
					All <% $category->abbr %> judges
				</a>
%			}
			
			<div class="row martopmore padno">

				<span class="seventenths marleftmore semibold">
					Active
				</span>

				<span class="quarter nospace">

					<span class="hidden"><% $judge->active %></span>

					<label class="switch">
						<input 
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_active"
							property_name = "active"
							target_type   = "judge"
							target_id     = "<% $judge->id %>" 
							onChange      = "postSwitch( this, 'judge_switch.mhtml');
											 statusSwitch('active');"
							<% $judge->active ? 'checked="checked"' : "" %>
						>
						<div class="slider offred"></div>
					</label>

				</span>

			</div> 


			<div class="row">

				<span class="seventenths marleftmore">
					ADA rooms needed
				</span>

				<span class="quarter nospace">

					<span class="hidden"><% $judge->ada %></span>

					<label class="switch">
						<input 
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_ada"
							property_name = "ada"
							target_type   = "judge"
							target_id     = "<% $judge->id %>" 
							onChange      = "postSwitch( this, 'judge_switch.mhtml');"
							<% $judge->ada ? 'checked="checked"' : "" %>
						>
						<div class="slider"></div>
					</label>

				</span>

			</div>

%			if ($cap_repel) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Chief Adjudicator's Panelist
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"chief_adjudicator"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_chief_adjudicator"
								setting_name = "chief_adjudicator"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"
								<% $judge_settings{"chief_adjudicator"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

%			}

% 			if ($category_settings{"neutrals"}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Neutral: May judge own school's entries
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"neutral"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_neutral"
								setting_name = "neutral"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"neutral"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"track_diversity"} || $category_settings{"nats_category"}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Diversity enhancing judge
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"diverse"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_diverse"
								setting_name = "diverse"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"diverse"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($tourn_settings->{"nsda_nats"}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Tab Room Staff
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"tab_room"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_tab_room"
								setting_name = "tab_room"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"tab_room"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>

				<div class="row">

					<span class="seventenths marleftmore">
						Exempt from Warnings
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"exempt_warnings"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_exempt_warnings"
								setting_name = "exempt_warnings"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"exempt_warnings"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>
% 			}

% 			if ($prefer_congress) { 
				<div class="row">

					<span class="seventenths marleftmore">
						Prefers Congress at Nats?
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"prefers_congress"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_prefers_congress"
								setting_name = "prefers_congress"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"prefers_congress"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>

%			}

% 			if ($category_settings{"ask_parli"} || $ask_parli) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Qualified Parliamentarian
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"parli"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_parli"
								setting_name = "parli"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"parli"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"exchange"} && $judge_settings{'hire_offer'}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Approved for Exchange Hire
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"hire_approved"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_hire_approved"
								setting_name = "hire_approved"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"hire_approved"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>


%			}

% 			if ($category_settings{"first_year_outs"}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						First Year Out
%	 					if ($category_settings{"fyo_free_strikes"}) { 
							(Free strike)
%						}
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"first_year"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_first_year"
								setting_name = "first_year"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"first_year"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"prefs"} || $category_settings{"free_strikes_dont_count"}) { 

				<div class="row">

					<span class="seventenths marleftmore">
						Free Strike
% 						if ($category_settings{"free_strikes_dont_count"}) { 
							(Does not meet obligation)
% 						}
					</span>

					<span class="quarter nospace">

						<span class="hidden"><% $judge_settings{"free_strike"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_free_strike"
								setting_name = "free_strike"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"free_strike"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

		</div>

		<div class="sidenote">

%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) { 

				<h4>
					Missed Round
				</h4>
	
				<form 
					action = "bond_revoke.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<div class="full even">
					<span class="threequarters">
						<input 
							class       = "notfirst"
							type        = "text"
							name        = "reason"
							size        = "20"
							placeholder = "Reason"
							tabindex    = -1
						>
					</span>
					<span class="quarter centeralign">
						<input 
							type  = "submit"
							class = "notfirst"
							value = "Save"
						>
					</span>

				</div>

				</form>

%			}

			<h4>Strikes &amp; Prefs</h4>

% 			if ($category_settings{"prefs"}) { 

				<a class="blue full" 
					href="prefs.mhtml?judge_id=<% $judge->id %>">
					Pref Sheets
				</a>

%			}

			<a class="blue full" 
				href="conflict_sheet.mhtml?judge_id=<% $judge->id %>">
				Print Conflict Sheet
			</a>

		</div> 

%		if (@questionnaires) { 

			<div class="sidenote">

				<h4>Questionnaires</h4>
%					if ($category_settings{'nats_category'}) { 
						<a 
							class="full blue"
							href="nom_edit.mhtml?judge_id=<% $judge->id %>"
						>Late Elim Nomination</a>
%					}

<%perl>
				foreach my $tag (@questionnaires) { 

					my $status = "INCOMPLETE";

					$status = "COMPLETE" 
						if $judge_settings{"form_complete_".$tag};

</%perl>
					<a 
						class="full blue"
						href="questionnaire.mhtml?judge_id=<% $judge->id %>&tag=<% $tag %>"
					>	
						<span class='half'>
							<% $tag %>
						</span>
						<span class='half rightalign semibold'>
							<% $status %>
						</span>
					</a>
%				}

			</div>
%		}


%       if ($judge->category->shifts) { 

			<div class="sidenote">
    
	            <h4>Times unavailable</h4>

				<p class="explain centeralign smaller nospace">
					Will charge if below obligation in a shift
				</p>
    
				<form action="strike_save.mhtml" method="post">

				<input 
					type  = "hidden"
					value = "shift"
					name  = "type"
				>

				<input 
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<input 
					type  = "hidden"
					name  = "from"
					value = "1"
				>

<%perl>

				foreach my $shift ( 
					sort {$a->start->epoch <=> $b->start->epoch} 
					$judge->category->shifts) {
</%perl>

                    <div class="smallish row hover"> 
					<label for="shift_<% $shift->id %>">

                        <span class="threequarter marno">
                            <% $shift->name %>
						</span>

                        <span class="quarter marno">
                            <input 
								type  = "checkbox"
								class = "notfirst"
								id    = "shift_<% $shift->id %>"
								name  = "shift_<% $shift->id %>"
								value = "1"
								<% ($judge) ? ($shift->strike($judge) ) ? "checked" : "" : "" %>> 
                        </span>

					</label>
                    </div>
%               }

                <div class="libl rightalign pagefull">
					<input 
						type  = "submit"
						class = "thin notfirst"
						value = "Save"
					>
                </div>

				</form>

			</div>
%      	}

%		if ($category_settings{'exchange'}) { 

			<div class="sidenote">

				<h4>Hired Rounds</h4>

				<p>Tap a request to cancel</p>

<%perl>

				foreach my $hire ($judge->hires) { 

					my $warn = "This action will break a judge hire arrangement
					between that school and that judge.  Are you sure?";

</%perl>
					<a 
						class="nowrap blue full" 
						href="hire_cancel.mhtml?hire_id=<% $hire->id %>&back=judge"
					>
						<% $hire->rounds_requested %> rounds to <% $hire->school->short_name %>
					</a>
%				}

			</div>

%		}

% 		if ($category_settings{"coach_ratings"}) { 

			<div class="sidenote">

			<h4>Ratings</h4>
			
			<form 
				action = "rating_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				value = "<%$judge->id%>"
				name  = "judge_id"
			>

<%perl>

			if ($category->rating_subsets) { 

				foreach my $subset ($category->rating_subsets) { 

					my $rating = $m->comp(
						"/funclib/judge_rating.mas", 
						judge  => $judge,
						subset => $subset
					);

</%perl>

					<div class="row">

						<span class="quarter">
							<% $subset->name %>
						</span>
						
						<span class="threequarters centeralign">

							<select 
								class    = "fixedsmall plain"
								name     = "<% $subset->id %>_rating"
								onchange = 'this.form.submit()'
							>

								<option value="">Unrated Judge</option>

%								foreach my $tier (
%									sort {$a->name cmp $b->name} 
%									$category->rating_tiers(type => "coach")
%								) { 

									<option value="<% $tier->id %>"
										<% ($rating 
												&& $rating->rating_tier 
												&& $tier->id == $rating->rating_tier->id) 
											? "selected" 
											: "" 
										%>
									>
										<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}

							</select>

						</span>

					</div>

%				} 

%			}  else { 

%				my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge);

				<div class="row">

					<span class="quarter">
						<% $category->abbr %>
					</span>
						
					<span class="threequarters nospace centeralign">

						<select 
							name     = "rating"
							onChange = 'this.form.submit()'
							class    = "fixedsmall"
						>

							<option value="">
								Unrated
							</option>

<%perl>
							foreach my $tier (
								sort {$a->name cmp $b->name} 
								$category->rating_tiers(type => "coach")
							) { 
</%perl>
								<option value="<% $tier->id %>" 
									<% $rating 
											&& $rating->rating_tier 
											&& ($tier->id == $rating->rating_tier->id) 
										? "selected" 
										: "" 
									%>
								>
									<% $tier ? $tier->name : "" %> -
									<% $tier ? substr($tier->description,0,15) : "" %>
								</option>
%							}

						</select>
					</span>

				</div>

%			}

			<noscript>
				<div class="libl full rightalign"> 
					<input 
						class = "thin"
						type  = "submit"
						value = "Save Ratings"
					>
				</div>
			</noscript>

			</form>
		</div>

% 		} 

		<div class="sidenote">
			<h4>Wreak Havoc</h4>

%			if ($person->site_admin) { 
				<a 
					href="/register/data/export_judge.mhtml?judge_id=<% $judge->id %>" 
					class="yellow full"
				>
					Backup Judge Data
				</a>
%			}

				<a 
					href="drop.mhtml?judge_id=<% $judge->id %>" 
					class="martopmore dkred full"
				>
					Delete Judge Altogether
				</a>


		</div>



	</div> 
