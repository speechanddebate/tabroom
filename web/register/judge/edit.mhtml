<%args> 
	$tourn
	$judge_id => undef
	$account
</%args>
<%init>

	my $switch;

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	$m->abort unless $judge;

	my $school = $judge->school;

	my $diocese = $school->region if $tourn->setting("ncfl");

	my $group = $judge->judge_group;

	my @schools = sort {$a->name cmp $b->name} $tourn->schools;
	my @dioschools;
	if ($diocese) { 
		@dioschools = sort {$a->name cmp $b->name} $diocese->schools(tourn => $tourn->id);
	}

 	my @panels = $m->comp('/funclib/judge_panels.mas', judge => $judge);

	my $hired++ unless $judge->school && $judge->school->id;
	
</%init>

	<& /funclib/editor.mas &>

%	if ($hired) { 
		<div class="main">
%	} else {
    	<& "/register/menubar.mas", school => $school, whoami => "judges", tourn => $tourn &>
%	}

	<br />

%	if ($judge && $judge->acct_request > 0) { 

%		my $request = $judge->acct_request;

		<h4>An account requests access to this judge</h4>

		<p>This will text or email the user with pairings.  It will also permit
		the user to enter online ballots for this judge.  Be sure that the
		account actually belongs to the judge in question</p>

		<div class="yellowrow">

			<span class="third martop">
				<% $request->first." ".$request->last %>
			</span>

			<span class="third martop">
				<a class="white" href="mailto:<% $request->email %>">
				<% $request->email %>
				</a>
			</span>

			<span class="sixth centeralign">
				<a class="dkblue block" href="permit.mhtml?judge_id=<% $judge->id %>&account_id=<% $request->id %>">
					PERMIT
				</a>
			</span>

			<span class="sixth centeralign">
				<a class="dkred block" href="deny.mhtml?judge_id=<% $judge->id %>&account_id=<% $request->id %>">
					DENY
				</a>
			</span>

		</div>

		<br />

%	}

%	if ($judge->account && $judge->account->id) { 

		<div class="yellowrow">
			<span class="quarter nospace">
				<h5>
					Linked to:
				</h5>
			</span>

			<span class="threequarter nospace">
				<a href="mailto:<% $judge->account->email %>" class="white">
					<h5>
						<% $judge->account->first." ".$judge->account->last %> 
						(<% $judge->account->email %>)
					</h5>
				</a>
			</span>
	
		</div>

%	}  else { 

		<form action="link.mhtml" method="post">
		<input type="hidden" name="judge_id" value="<% $judge->id %>">

		<div class="ltyellow">
			<span class="quarter martop nospace">
				<h5>
					Link Account:
				</h5>
			</span>

			<span class="half nospace">
				<input type="email" name="email" size="30" placeholder="Login email...">
			</span>

			<span class="quarter martop nospace">
				<input type="submit" value="Link">
			</span>
		</div>

		</form>
%	}  
		
	<form action="save.mhtml" method="post">
	<input type="hidden" name="judge_id" value="<% ($judge) ? $judge->id : "" %>">

	<div class="even">

		<span class="quarter martop">
			<h5>
				Judge Name:
			</h5>
		</span>

		<span class="third martop">
			<input type="text" name="first" size="16" value="<% $judge->first %>" placeholder="First Name">
		</span>

		<span class="third martop">
			<input type="text" name="last" size="16" value="<% $judge->last %>" placeholder="Last Name">
		</span>

	</div>


	<h4>Judge Details</h4>

		<div class="half">

			<div class="visible optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="quarter martop">
					School
				</span>
				
				<span class="threequarter nospace top nospace top">

					<select name="school" class="fixedmed chosen">

						<option value="">Hired</option> 

%						my %school_already;

% 						if ($diocese) { 
% 							foreach my $school (@dioschools) { 
%								$school_already{$school->id}++;
									<option value="<% $school->id %>" <% ($school->id eq $judge->school->id) ? 'selected' : '' %> > <% $school->short_name %> </option>
%							} 
							<option value="">
								---Other Dioceses:---
							</option>
%						}

% 						foreach my $school (@schools) { 

%							next if $school_already{$school->id}++;

							<option value="<% $school->id %>" <% ($school->id eq $judge->school->id) ? 'selected' : '' %> > <% $school->name%> </option> 

%						} 
	
					</select>
				</span>

			</div>

			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="quarter martop">
					Active
				</span> 
				
				<span class="threequarter nospace top nowrap">
					
					<label for="Y">
					<span class="half hover martop">
						<input type="radio" name="active" id="Y" value="1" <% ($judge->active == 1) ? 'checked' : '' %> > 
						Yes
					</span>
					</label>

					<label for="N">
					<span class="half hover martop">
						<input type="radio" name="active" id="N" value="0" <% ($judge->active != 1) ? 'checked' : '' %> >
						No
					</span>
					</label>

				</span>

			</div> 
			


%			if ($group->setting("tab_ratings")) { 

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<span class="third martop">
						<label for="tab_rating">
							Tab Rating:
						</label>
					</span>

					<span class="twothird">
						<input type="number" name="tab_rating" min="0" max="999" value="<% $judge ? $judge->tab_rating : "" %>">
					</span>
		
				</div>

%			}

			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">
	
				<span class="third martop">
					Phone
				</span>	
				
				<span class="twothird">
					<input type="tel" name="phone" size="20" value="<% ($judge->account && $judge->account->id) ? $judge->account->phone : $judge->setting("phone") %>">
				</span>

			</div>

			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">
	
				<span class="third martop">
					Email
				</span>	
				
				<span class="twothird">
					<input type="tel" name="email" size="20" value="<% ($judge->account && $judge->account->id) ? $judge->account->email : $judge->setting("email") %>">
				</span>

			</div>

%			if ($tourn->setting("ncfl")) { 

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">
				
					<span class="third martop">
						Diocese
					</span> 
				
					<span class="twothird">
						<% $judge->school && $judge->school->region ? $judge->school->region->name ."(".$judge->school->region->code.")" : "" %>
					</span> 

				</div>

%			}

			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="third smallish martop">
					Special Job
				</span>
				
				<span class="twothird">
					<input type="text" name="special" size="20" value="<% $judge->special %>">
				</span>

			</div> 
			
			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="third smallish martop">
					Coach Notes
				</span>

				<span class="twothird">
					<input type="text" name="notes" size="20" value="<% $judge->notes %>">
				</span>

			</div>

			<label for="ada">
			<div class="hover optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="third martop">
					ADA
				</span>

				<span class="twothird nospace top">
					<span class="quarter nospace">
						<input type="checkbox" id="ada" class="largecheck" name="ada" value="1" <% $judge && $judge->ada ? 'checked="checked"' : "" %>>
					</span>
					<span class="threequarter martop smaller">
						(Requires accessible rooms)
					</span>
				</span>
	
			</div>
			</label>

% 			if ($group->setting("neutrals")) { 

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<span class="third martop">
						<label for="neutral">
							Neutral
						</label>
					</span> 

					<span class="twothird">

						<span class="quarter martop">
							<input type="checkbox" id="neutral" class="largecheck" name="neutral" value="1" <% $judge && $judge->setting("neutral") ? 'checked="checked"' : "" %>>
						</span>

						<span class="threequarter nospace top explain">
							May judge own school's entries
						</span>
					</span>

				</div>
% 			}

% 			if ($group->setting("track_diversity")) { 

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<span class="third martop">
						<label for="diverse">
							Diverse:
						</label>
					</span> 

					<span class="twothird">

						<span class="quarter martop">
							<input type="checkbox" id="diverse" class="largecheck" name="diverse" value="1" <% $judge && $judge->diverse ? 'checked="checked"' : "" %>>
						</span>

						<span class="threequarter nospace top explain">
							Diversity enhancing judge
						</span>
					</span>

				</div>
% 			}

% 			if ($group->setting("first_year_outs")) { 

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<label for="first_year">
					<span class="third martop">
						First Year Out
					</span> 
					</label>

					<span class="twothird">

						<span class="quarter martop">
							<input type="checkbox" id="first_year" class="largecheck" name="first_year" value="1" <% $judge && $judge->setting("first_year") ? 'checked="checked"' : "" %>>
						</span>

% 						if ($group->setting("fyo_free_strikes")) { 
							<span class="threequarter nospace top explain">
								Automatically a free strike
							</span>
%						}

					</span>

				</div>
% 			}

% 			if ($group->setting("prefs")) { 

				<label for="free_strike">
				<div class="hover optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<span class="third  martop">
						Free Strike
					</span> 

					<span class="twothird nospace top">

						<span class="quarter martop">
							<input type="checkbox" id="free_strike" class="largecheck" name="free_strike" value="1" <% $judge && $judge->setting("free_strike") ? 'checked="checked"' : "" %>>
						</span>

% 						if ($group->setting("free_strikes_dont_count")) { 
							<span class="threequarter nospace top explain">
								(Does not count towards obligation)
							</span>
% 						}
					</span>

				</div>
				</label>
% 			}

		</div>

%	undef $switch;

		<div class="half">

%			unless ($group->setting("no_codes")) { 

					<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

						<span class="quarter martop">
							Code
						</span>

						<td class="padtext leftalign">
							<input type="text" name="code" size="10" value="<% $judge->code %>">
						</span>
		
					</div>

%			}

			<div class="optionblock visible <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="third smallish martop">
					Judge group
				</span> 
			
				<span class="twothird nospace top">
					<select name="judge_group" class="fixedsmall chosen">
% 						foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) { 
							<option value="<% $tgroup->id %>" 
								<% ($group && $group->id == $tgroup->id) ? 'selected' : '' %> >
								<% $tgroup->name %> 
							</option>
%						} 

						<option>-----------------------------</option>

					</select> 
				</span> 

			</div> 

			<div class="optionblock visible <% ($switch++ % 2) ? "odd" : "even" %>">
		
				<span class="third smallish martop">
					Covers entries
				</span> 
				
				<span class="twothird nospace top">
					<select name="covers" class="fixedsmall chosen">

						<option value="">
							None Selected
						</option> 

%	 					foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) {
							<option value="<% $tgroup->id %>"
								<% ($judge->covers && $tgroup->id == $judge->covers->id) ? 'selected' : '' %> 
								<% ( ($group && $group->id == $tgroup->id) &! $judge->covers) ? 'selected' : '' %> >
								<% $tgroup->name %> 
							</option>
%						}  

						<option>-----------------------------</option>
					</select>
				</span>

			</div>

% 			if ($group->setting("ask_alts")) {

				<div class="optionblock visible <% ($switch++ % 2) ? "odd" : "even" %>">

					<span class="third smallish">
						Also judges
					</span>
				
					<span class="twothird">
						<select name="alt_group" class="fixedsmall chosen">

							<option value="">
								None Selected
							</option>

%	 						foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) {

%								next if $tgroup->id == $group->id;
	
								<option value="<% $tgroup->id %>" <% ($judge->alt_group && $tgroup->id == $judge->alt_group->id) ? 'selected' : '' %> >
									<% $tgroup->name %> 
								</option>
%							}  

						</select>

					</span>

				</div>

%			}

%			if ($group->setting("rounds_per")) { 

%			  	my $max_rounds = $group->setting("max_rounds");

					<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

						<span class="half martop">
							Round Obligation
						</span>

						<span class="half">
							<input type="number" name="obligation" min="0" max="<% $max_rounds %>" size="10" value="<% $judge->obligation %>" style="margin-right: 35px;">
						</span>
		
					</div>

					<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

						<span class="half martop">
							Hired Rounds
						</span>

						<span class="half">
							<input type="number" name="hired" min="0" max="<% $max_rounds - $judge->obligation %>" size="10" value="<% $judge->hired %>" style="margin-right: 35px;">
						</span>
		
					</div>

%				if ($group->setting("exchange")) { 
						<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

							<span class="half">
								Hired Rds On Offer
							</span>

							<span class="half">
								<input type="number" name="hire_offer" min="0" max="<% $max_rounds - $judge->obligation %>" size="10" value="<% $judge->hire_offer %>" style="margin-right: 35px;">
							</span>
			
						</div>
%				}

%				if ($account->site_admin) { 
					<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

						<span class="half martop">
							Import ID
						</span>

						<span class="half">
							<input type="number" name="cat_id" size="10" value="<% $judge->cat_id %>">
						</span>

					</div>
%				}


%			}

			</table>

		</div>

		<div class="liblrow rightalign">
			<input  type="submit" value="Save Judge Information">
			</form>
		</div>

%	my @pool_groups;

%	if ($judge->pools) { 
%		foreach my $pool ($judge->pools) { 
%			Tab::debuglog("I am in pool ".$pool->name);
%			push @pool_groups, $pool->judge_group;
%		}
%	}


% 		if (($group->pools && $judge) || @pool_groups) { 
		
%			my $switch;
%			my $double;

			<h4>Pools:</h4> 
			
				<form action="judge_save_pools.mhtml" method="post">
				<input type="hidden" value="<% $judge->id %>" name="judge_id">

%				push @pool_groups, $judge->judge_group;
%				my %seen = (); 
%				@pool_groups = grep { ! $seen{$_->id} ++ } @pool_groups;

% 				foreach my $group (sort {$a->id <=> $b->id} @pool_groups) { 

%					foreach my $pool ($group->pools) { 

						<label for="pool_<% $pool->id %>">
							<span class="hover optionblock <% ($double % 2) ? "odd" : "even" %> third">

								<span class="half">
									<% $pool->name %>
								</span>
								<span class="quarter martop">
									<% $pool->judge_group->abbr %>
								</span>

								<span class="quarter rightalign">
									<input type="checkbox" class="largecheck" name="<% $pool->id %>" value="1" id="pool_<% $pool->id %>"
										<% Tab::PoolJudge->search( judge => $judge->id, pool => $pool->id) ? 'checked="checked"' : "" %>>
								</span>

							</span>
						</label>

%						$switch++;
%						$double++ unless $switch % 3;

%					} 
%				} 

				<div class="liblrow rightalign">
					<input  class="thin"class="thin"  type="submit" value="Save Pool Changes">
					</form>
				</div> 
				
% 			}

%		if ($group->setting("ask_paradigm") && $judge->account) { 

			<h4> Paradigm </h4>
				
			<div class="even">
				<textarea rows="5" name="paradigm" cols="42"><% $judge->account->setting("paradigm") %></textarea>
			</div>
%	 	}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Information</h4>

%			if ($hired) { 

				<a class="blue block" href="/register/judge/roster.mhtml?group_id=<% $group->id %>&hires=1">
					Hired Judges
				</a>

%			} elsif ($judge->school && $group) { 

				<a class="blue block" href="/register/school/judges.mhtml?school_id=<% $judge->school->id %>&judge_group=<% $group->id %>">
					<% $judge->school->short_name %> Judges
				</a>

%			}

%			if ($group) { 
				<a class="blue block" href="/register/judge/roster.mhtml?group_id=<% $group->id %>">
					<% $group->name %> judges roster
				</a>
%			}
			
			<a href="print_sheet.mhtml?judge_id=<% $judge->id %>" class="blue martop block">
				Print <% $judge->first %>'s info sheet
			</a> 
		
%			if ($tourn->setting("ncfl")) { 
				<a href="/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>" class="blue block">
					Print Judge's Info Card 
				</a>
%			}

			<h4>Wreak Havoc</h4>

				<a href="drop.mhtml?judge_id=<% $judge->id %>&school_id=<% ($judge->school) ? $judge->school->id : "" %>" class="yellow block">
					Drop Judge
				</a>

%				if ($judge->account > 0) { 

%					my $warn = "This will render this account unable to post online ballots or get email/text pairings.  You sure?";
				
					<a href="unlink.mhtml?judge_id=<% $judge->id %>" <& "/funclib/confirm.mas", warn => $warn &> class="yellow block nowrap">
						Unlink from <% $judge->account->email %>
					</a>

%				} else { 

%				}

		</div>

		<div class="sidenote">

			<h4>Strikes & Prefs</h4>

			<a class="blue block" href="prefs.mhtml?judge_id=<% $judge->id %>">
				Pref Sheets
			</a>

			<a class="yellow block" href="judge_strikes.mhtml?judge_id=<% $judge->id %>">
				Add Strike
			</a>

%			if ($judge->strikes) { 
				<p class="smaller">Click to delete strike:</p>
%			}

%  			foreach my $strike (sort {$a->type cmp $b->type} $judge->strikes) {
				<a class="blue block nowrap" href="strike_rm.mhtml?from=edit&strike_id=<% $strike->id %>">
					<% $strike->name ? $strike->name : ""%>
				</a>
%			}

		</div> 

%       if ($judge->judge_group->strike_times) { 

			<div class="sidenote">
    
	            <h4>Time blocks</h4>
    
				<form action="strike_save.mhtml" method="post">
				<input type="hidden" value="strike_time" name="type"> 
				<input type="hidden" value="<% $judge->id %>" name="judge_id">
				<input type="hidden" value="1" name="from">

%               foreach my $strike_time ( sort {$a->start->epoch <=> $b->start->epoch} $judge->judge_group->strike_times) {

					<label for="strike_time_<% $strike_time->id %>">
                    <div class="smallish <% ($switch++ % 2) ? "odd" : "even" %> hover" > 

                        <span class="threequarter">
                            <% $strike_time->name %>
						</span>

                        <span class="quarter">
                            <input type="checkbox" id="strike_time_<% $strike_time->id %>" name="strike_time_<% $strike_time->id %>" value="1" 
								<% ($judge) ? ($strike_time->strike($judge) ) ? "checked" : "" : "" %>> 
                        </span>

                    </div>
					</label>
%               }

                <div class="liblrow rightalign">
					<input type="submit" class="thin" value=" Save ">
                </div>

				</form>

			</div>
%      	}

%		if ($group->setting('exchange')) { 

			<div class="sidenote">

				<h4>Hired Rounds</h4>

				<p>Tap a request to cancel</p>

%				foreach my $hire ($judge->hires) { 
%					my $warn = "This action will break a judge hire arrangement between that school and that judge.  Are you sure?";
					<a class="nowrap blue block" href="hire_cancel.mhtml?hire_id=<% $hire->id %>&back=judge">
						<% $hire->rounds %> rounds to <% $hire->school->short_name %>
					</a>
%				}

			</div>

%		}

% 		if ($group->setting("coach_ratings")) { 

			<div class="sidenote">

% 			my $switch;

			<h4>Ratings</h4>
			
			<form action="rating_save.mhtml" method="post">
			<input type="hidden" value="<%$judge->id%>" name="judge_id">

%			if ($group->rating_subsets) { 

% 				foreach my $subset ($group->rating_subsets) { 

%					my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge, subset => $subset);

					<div class="visible <% ($switch++ % 2) ? "odd" : "even" %>">

						<span class="half">
							<% $subset->name %>
						</span>
						
						<span class="half centeralign">

							<select class="chosen fixedtiny" name="<% $subset->id %>_rating" onchange='this.form.submit()'>

								<option value="">Unrated Judge</option>
%								foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) { 

									<option value="<% $tier->id %>"
										<% ($rating && $rating->rating_tier && $tier->id == $rating->rating_tier->id) ? "selected" : "" %>>
											<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}
							</select>

						</span>

					</div>

%				} 

%			}  else { 

%				my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge);

				<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

					<td class="smaller">
						<% $group->abbr %>
					</span>
						
					<td align="center">

						<select name="rating" onchange='this.form.submit()' class="fixedsmall">

							<option value="">
								Unrated
							</option>

%							foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) { 
								<option value="<% $tier->id %>" 
									<% ($rating && $rating->rating_tier && ($tier->id == $rating->rating_tier->id)) ? "selected" : "" %>>
									<% $tier ? $tier->name : "" %> - <% $tier ? substr($tier->description,0,15) : "" %>
								</option>
%							}

						</select>
					</span>

				</div>

%			}

			<noscript>

			<div class="optionblock liblrow"> 
				<td colspan="2" align="right">
					<input class="skinny" type="submit" value="Save Ratings">
				</span> 
			</div>
			</noscript>

			</form>
		</div>

% 		} 

% 		if (@panels) { 

			<div class="sidenote">

%			my $switch;

			<h4>Assignments:</h4> 
				
%			foreach my $panel (sort {$a->round->timeslot->start <=> $b->round->timeslot->start} $m->comp("/funclib/judge_panels.mas", judge => $judge)) { 

%				my $panel_start = $panel->round->timeslot->start;
%				$panel_start->set_time_zone($tourn->tz);

				<a class="green block" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">

					<span class="nospace sixth">
						<% $panel->round->event->abbr %>
					</span>

					<span class="nospace sixth">
						<% $panel->round->name %><% $panel->round->flighted > 1 ? "-".$panel->flight : ""%>
					</span>
					<span class="nospace third">
						<% $panel_start->hour_12.':'.$panel_start->strftime('%M')." ".$panel_start->strftime('%p') %>
					</span>

					<span class="nospace third">
						<% ($panel->room) ?  substr($panel->room->name,0,15) : "" %>
					</span>
				</a>
				
% 			} 

			</div>

% 		} 

	</div> 
	
	<br style="clear:both"/>
