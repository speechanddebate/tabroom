<%args>
	$tourn
	$event_id => undef
	$round_id => undef
	$type => undef
</%args>
<%init>

	use POSIX;

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	my @rounds = $m->comp("/funclib/event_rounds.mas", event => $event, done => "yes")  if $event;

	if ($event && not defined $round) { 
		$round = shift @rounds;
		push @rounds, $round;
	} 

	my $novice = $tourn->setting("novices");
	my %is_novice = (); 

	if ($novice && $event) { 
		foreach my $novice ($m->comp("/funclib/event_novii.mas", event => $event)) { 
			$is_novice{$novice->id}++;
		}   
	}   

	my %entry_ballots = ();

	if ($round) { 

		my @values = $m->comp("/funclib/event_values.mas", event => $event, round => $round);

		my %round_bye = ();

		foreach my $value (@values) { 
			
			next if $round_bye{$value->ballot->id};

			$entry_ballots{$value->entryid} .= '</span>' if $entry_ballots{$value->entryid} && $value->tag eq "rank" && ($type eq "speech" || $type eq "wudc" || $type eq "congress");
			$entry_ballots{$value->entryid} .= '</span>' if $entry_ballots{$value->entryid} && $value->tag eq "ballot" && $type ne "speech" && $type ne "wudc" && $type ne "congress";

			$entry_ballots{$value->entryid} .= '<span class="smallspan">' if $value->tag eq "rank" && ($type eq "speech" || $type eq "wudc" || $type eq "congress");
			$entry_ballots{$value->entryid} .= '<span class="eighty">' if $value->tag eq "ballot" && $type ne "speech" && $type ne "wudc" && $type ne "congress";

			$entry_ballots{$value->entryid} .= "/" if $value->tag eq "points";
			$entry_ballots{$value->entryid} .= " " unless $value->tag eq "points";

			if ($value->bye) { 
				$entry_ballots{$value->entryid} .= "BYE";
				$round_bye{$value->ballot->id}++;
			} elsif ($value->tag eq "ballot") { 
				$entry_ballots{$value->entryid} .= "W" if $value->value > 0;
				$entry_ballots{$value->entryid} .= "L" if $value->value < 1;
			} else { 
				$entry_ballots{$value->entryid} .= $value->value;
			}
		}
	}

</%init>

	<div class="right small">

%		if ($event && @rounds) { 

			<div class="sidenote">

				<h4>As of round</h4>

				<span class="block padless bluenohover">

					<form action="index.mhtml" method="post">
					<input type="hidden" name="event_id" value="<% $event->id %>">

					<select name="round_id" onchange='this.form.submit()' class="fixedsmall">
						<option value="" <% $type eq "Speakers" ? "selected" : "" %>></option>
%						foreach my $oround (sort {$b->name <=> $a->name} @rounds) {
%							next unless $oround && $oround->id;
%							next unless $round && $round->id;
							<option value="<% $oround->id %>" <% $round && $oround->id == $round->id ? "selected" : "" %>>
								<% $oround->realname %>
							</option>
%						}

					</select>
					</form>
				</span>
			</div>
%		}

%		if ($event && $event->type ne "speech" && $event->type ne "congress") { 

			<div class="sidenote">

				<h4>Speakers</h4>

				<span class="block padless bluenohover">
					<form action="index.mhtml" method="post">
					<input type="hidden" name="event_id" value="<% $event->id %>">
					<input type="hidden" name="type" value="Speakers">
					<select name="round_id" onchange='this.form.submit()' class="fixedsmall">
						<option value="" <% $type ne "Speakers" ? "selected" : "" %>></option>
%						foreach my $oround (sort {$b->name <=> $a->name} @rounds) {
%							next unless $oround && $oround->id;
							<option value="<% $oround->id %>" <% $round && $oround->id == $round_id ? "selected" : "" %>>
								<% $oround->realname %>
							</option>
%						}
					</select>
					</form>
				</span>

			</div>
%		}

		<div class="sidenote">
			<h4>Events:</h4>
%			my $last_type;
%			my @events = sort {$a->name cmp $b->name} $tourn->events;
%			foreach my $oevent (sort {$a->type cmp $b->type} @events) { 
%				$last_type = $oevent->type unless $last_type;
%				my $class = "martop" if $oevent->type ne $last_type;
%				$last_type = $oevent->type;

				<a class="<% $event && $oevent->id == $event->id? "dk" : ""%>blue nowrap <% $class %> block" href="index.mhtml?event_id=<% $oevent->id %>">
					<% $oevent->name %>
				</a>
%			}
		</div>

	</div>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortme" &>

%		if ($round) { 

%			my ($entries_ref, $tbs_ref, $desc_ref, $noshow_ref) = $m->comp("speech/order_entries.mas", round => $round) if $event->type eq "speech";

%			($entries_ref, $tbs_ref, $desc_ref, $noshow_ref) = $m->comp("wudc/order_entries.mas", round => $round) if $event->type eq "wudc" && $type ne "Speakers";

%			($entries_ref, $tbs_ref, $desc_ref, $noshow_ref) = $m->comp("debate/order_entries.mas", round => $round) 
%					if $event->type ne "wudc" && $event->type ne "speech" && $event->type ne "congress" && $type ne "Speakers";

%			my $students_ref;
%			($students_ref, $tbs_ref, $desc_ref) = $m->comp("wudc/order_speakers.mas", round => $round) if $event->type eq "wudc" && $type eq "Speakers";
%			($students_ref, $tbs_ref, $desc_ref) = $m->comp("debate/order_speakers.mas", round => $round) if $event->type ne "wudc" && $type eq "Speakers";

			<h2><% $type eq "Speakers" ? "Speakers" : "Results" %> as of <% $round->realname %> of <% $event->abbr %></h2>

			<table cellpadding="4" cellspacing="1" id="sortme">

				<thead>
					<tr class="yellowrow">

						<th class="smallish">
						</th>

						<th class="smaller">
							Code
						</th>

						<th class="smallish">
							Name
						</th>

						<th class="smallish">
							School
						</th>

%						foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) { 
							<th class="smaller" style="line-height: 10px;">
								<% ${$desc_ref}{$key} %>
							</th>
%						}

						<th class="nosort smallish">
							Ballots
						</th>

					</tr>

				</thead>

				<tbody>

%					my $count = 1;

%					if ($entries_ref) { 

%						my $last_tied;

%						foreach my $key (sort {$a <=> $b} keys %{$entries_ref}) { 

%							my $tie++ if scalar @{${$entries_ref}{$key}} > 1;

%							foreach my $entry (@{${$entries_ref}{$key}}) { 

								<tr class="<% $tie ? "lirdrow " : "" %> <% $tie && $last_tied ? "libordertop" : "" %>">

%									undef $last_tied;

									<td class="centeralign smallish nowrap padno" style="width: 25px;">
										<% $key %>
									</td>

									<td>
										<span class="smallish smallspan wrap">
											<% $entry->code %>
										</span>
									</td>

									<td class="smallish">
										<% $entry->name %> 
										<% $is_novice{$entry->id} ? " (N) " : "" %>
									</td>

									<td class="nowrap smallish">
										<% substr($entry->school->short_name,0,10) %>
									</td>

%									foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) { 

%										my $value = ${$tbs_ref}{$entry->id."-".$key};
%										$value = sprintf("%.2f", $value);
%										$value =~ s/\.(?:|.*[^0]\K)0*\z//;

										<td class="smallish nowrap">
											<% $value %>
										</td>
%									}

									<td class="smaller">
										<div class="<% $event->type eq "policy" ? "halfspan" : "" %> wrap">
										<% $entry_ballots{$entry->id} %> <% ${$noshow_ref}{$entry->id} ? "NS" : "" %> 
										</span>
										</div>
									</td>

								</tr>

%							}

%							$last_tied++ if $tie;

%						} 

%					} elsif ($students_ref) { 

%						foreach my $key (sort {$a <=> $b} keys %{$students_ref}) { 

%						my $tie++ if scalar @{${$students_ref}{$key}} > 1;

%						foreach my $student (@{${$students_ref}{$key}}) { 

							<tr <% $tie ? 'class="lirdrow"' : "" %>>

								<td class="centeralign smallish nowrap" style="width: 25px;">
									<% $key %><% $tie ? "-T" : "" %>
								</td>

								<td class="smallish nowrap" style="width: 50px;">
									<% $student->code %>
								</td>

								<td class="smallish nowrap" style="width: 100px;">
									<% $student->first." ".$student->last %>
								</td>

								<td class="smallish nowrap">
									<% substr($student->school,0,8) %>
								</td>

%								foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) { 
									<td class="smallish nowrap">
										<% ${$tbs_ref}{$student->id."-".$key} %>
									</td>
%								}

								<td class="centeralign smallish nowrap" style="width: 25px;">
									<% $count++ %>
								</td>

							</tr>

%						}
%					}
%				}

				</tbody>

			</table>

%			if ($novice) { 
				<p class="explain">(N) desginates all-novice teams</p>
%			} 

%		}
	
	</div>


