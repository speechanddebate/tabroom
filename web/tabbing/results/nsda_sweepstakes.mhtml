<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
</%args>
<%init>

	use Tab::NSDA::MemberSchool;

	my @all_schools = $tourn->schools;
	my @events = $tourn->events;

	my %schools = ();
	my %events = ();

	foreach my $event (@events) {
		$events{$event->id}{"type"} = $event->type;
	}

    Tab::NSDA::MemberSchool->set_sql( get_past_trophy_points => "
        select prior
        from nfl.DISTRICT_TROPHY_POINTS
        where year = ?
        and school_id = ?
    ");

    Tab::NSDA::MemberSchool->set_sql( get_past_trophy_points_also => "
        select curr
        from nfl.DISTRICT_TROPHY_POINTS
        where year = ?
        and school_id = ?
    ");

    Tab::NSDA::MemberSchool->set_sql( winner_school => "
        select school_id
        from nfl.DISTRICT_TROPHY_WINNERS
        where year = ?
		and district_id = ?
    ");

    Tab::NSDA::MemberSchool->set_sql( winner_points => "
        select points
        from nfl.DISTRICT_TROPHY_WINNERS
        where year = ?
		and district_id = ?
    ");

    Tab::NSDA::MemberSchool->set_sql( eligible => "
        select points
        from nfl.DISTRICT_TROPHY_WINNERS
        where year > ?
		and school_id = ?
    ");

    my $year = $tourn->start->year;
    $year++ if $tourn->start->month > 7;
    my $last_year = $year - 1;

	my $winner_school  = Tab::NSDA::MemberSchool->sql_winner_school->select_val(
		$last_year,
		$tourn_settings->{"nsda_district"}
	);

	my $winner_points  = Tab::NSDA::MemberSchool->sql_winner_points->select_val(
		$last_year,
		$tourn_settings->{"nsda_district"}
	);

	my $eligible_year = $last_year - 3;

	foreach my $school (@all_schools) {

		my $member =
			Tab::NSDA::MemberSchool->retrieve($school->chapter->nsda);

		if ($member) {

			my $past_points =
				Tab::NSDA::MemberSchool->sql_get_past_trophy_points->select_val(
					$last_year, $member->school_id
				);

			my $past_points_also =
				Tab::NSDA::MemberSchool->sql_get_past_trophy_points_also->select_val(
					$last_year, $member->school_id
				);

			$past_points += $past_points_also;

			if ($winner_school == $member->school_id) {
				$past_points -= $winner_points;
			}

			$schools{$school->id}{"past_cumulative_points"}  = $past_points;

			$schools{$school->id}{"ineligible"}
				= Tab::NSDA::MemberSchool->sql_eligible->select_val($eligible_year, $member->school_id);

		}

		$schools{$school->id}{"nsda_trophy_points"}
			= $school->setting("nsda_trophy_points");

		$schools{$school->id}{"object"} = $school;

		foreach my $entry ($school->entries) {
			$schools{$school->id}{$events{$entry->event->id}{"type"}}++;
		}

	}

	my $cumulative_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name  => "Cumulative Award"
	)->first;

	if ($cumulative_set) {

	    my ($points_ref, $count_ref, $countstring_ref) =
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas",
	            sweep_set => $cumulative_set
	        );

		foreach my $school_id (keys %schools) {

			$schools{$school_id}{"cumulative"}
				= ${$points_ref}{$school_id};

			$schools{$school_id}{"cumulative_count"}
				= ${$count_ref}{$school_id};

			$schools{$school_id}{"cumulative_string"}
				= ${$countstring_ref}{$school_id};

		}

	}

	my $yearly_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name => "Yearly Sweeps"
	)->first;

	my $speech_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name => "Speech"
	)->first;

	my $debate_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name => "Debate"
	)->first;

	my $congress_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name => "Congress"
	)->first;

	if ($yearly_set) {

	    my ($yearly_ref, $yearly_count_ref, $yearly_countstring_ref) =
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas",
	            sweep_set => $yearly_set
	        );

		foreach my $school_id (keys %schools) {
			$schools{$school_id}{"yearly_points"}
				= ${$yearly_ref}{$school_id};

			$schools{$school_id}{"yearly_count"}
				= ${$yearly_count_ref}{$school_id};

			$schools{$school_id}{"yearly_string"}
				= ${$yearly_countstring_ref}{$school_id};
		}

	    my ($speech_ref, $speech_count_ref, $speech_countstring_ref) =
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas",
	            sweep_set => $speech_set
	        );

		foreach my $school_id (keys %schools) {

			$schools{$school_id}{"speech_points"} = ${$speech_ref}{$school_id}
				if $speech_ref;

			$schools{$school_id}{"speech_count"} = ${$speech_count_ref}{$school_id}
				if $speech_count_ref;

			$schools{$school_id}{"speech_string"} = ${$speech_countstring_ref}{$school_id}
				if $speech_countstring_ref;
		}

	    my ($debate_ref, $debate_count_ref, $debate_countstring_ref) =
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas",
	            sweep_set => $debate_set
	        );

		foreach my $school_id (keys %schools) {
			$schools{$school_id}{"debate_points"} = ${$debate_ref}{$school_id};
			$schools{$school_id}{"debate_string"} = ${$debate_countstring_ref}{$school_id};
			$schools{$school_id}{"debate_count"} = ${$debate_count_ref}{$school_id};
		}

	    my ($congress_ref, $congress_count_ref, $congress_countstring_ref) =
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas",
	            sweep_set => $congress_set
	        );

		foreach my $school_id (keys %schools) {
			$schools{$school_id}{"congress_points"} = ${$congress_ref}{$school_id};
			$schools{$school_id}{"congress_string"} = ${$congress_countstring_ref}{$school_id};
			$schools{$school_id}{"congress_count"}  = ${$congress_count_ref}{$school_id};
		}

	}

</%init>

	<div class="blankfull">

		<span class="half nospace">
			<h4>Cumulative Sweepstakes</h4>
		</span>

		<span
			class="nospace half rightalign"
			id    = "sweepssort_buttonarea"
		>
			<a
				class = "fa fa-sm fa-arrow-up buttonwhite orangetext"
				href  = "post_nsda_sweepstakes.mhtml"
				title = "Upload debate results"
			></a>
		</span>

		<& "/funclib/tablesorter.mas", table => "sweepssort" &>

		<table id="sweepssort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Past Trophy Points
					</th>

					<th>
						Trophy Points
					</th>

					<th>
						Entries Counted
					</th>

					<th>
						Non-Tabroom <br /> Trophy Points
					</th>

					<th>
						Total Trophy Points
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

				foreach my $school_id (keys %schools) {

					$schools{$school_id}{"total_cume"} =
						(
							$schools{$school_id}{"past_cumulative_points"} +
							$schools{$school_id}{"nsda_trophy_points"} +
						    $schools{$school_id}{"cumulative"}
						);

				}

				foreach my $school_id (
					sort
						{	$schools{$b}{"total_cume"}
								<=>
							$schools{$a}{"total_cume"}
						}
					keys %schools
				) {

					my $school = $schools{$school_id}{"object"};

</%perl>

					<tr>

						<td
							title = "<% $schools{$school_id}{"cumulative_string"}  %>"
						>
							<% $school->name %>
						</td>


						<td class="rightalign">
							<% int($schools{$school_id}{"past_cumulative_points"}) %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"cumulative"} %>
						</td>

						<td
							class="rightalign"
							title="<% $schools{$school_id}{"cumulative_string"} %>"
						>
							<% $schools{$school_id}{"cumulative_count"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"nsda_trophy_points"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"total_cume"} %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

		<span class="half nospace">
			<h4>Annual Sweepstakes: Overall</h4>
		</span>

		<span
			class = "half rightalign"
			id    = "yearlysort_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas", table => "yearlysort" &>

		<table id="yearlysort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Debate
						Entries
					</th>

					<th>
						Speech
						Entries
					</th>

					<th>
						Counted
						Entries
					</th>

					<th>
						Total
						Points
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

				foreach my $school_id (
					sort {
						$schools{$b}{"yearly_points"}
						<=>
						$schools{$a}{"yearly_points"}
					} keys %schools
				) {

					next unless $schools{$school_id}{"debate"} >= 3;
					next unless $schools{$school_id}{"speech"} >= 3;
					my $school = $schools{$school_id}{"object"};

</%perl>
					<tr>

						<td>
							<% $school->name %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"speech"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"debate"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"yearly_count"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"yearly_points"} %>
						</td>

					</tr>

%				}


			</tbody>

		</table>

		<span class="half nospace">
			<h4>Annual Sweepstakes: Debate</h4>
		</span>

		<span
			class = "half rightalign"
			id    = "debatesort_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas", table => "debatesort" &>

		<table id="debatesort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Debate
						Entries
					</th>

					<th>
						Counted
						Entries
					</th>

					<th>
						Total
						Points
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $school_id (
					sort {
						$schools{$b}{"debate_points"}
						<=>
						$schools{$a}{"debate_points"}
					} keys %schools
				) {

					next unless $schools{$school_id}{"debate"} >= 1;
					my $school = $schools{$school_id}{"object"};
</%perl>

					<tr>

						<td
							title = "<% $schools{$school_id}{"debate_string"}  %>"
						>
							<% $school->name %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"debate"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"debate_count"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"debate_points"} %>
						</td>

					</tr>

%				}


			</tbody>

		</table>

		<span class="half nospace">
			<h4>Annual Sweepstakes: Speech</h4>
		</span>

		<span
			class = "half rightalign"
			id    = "speechsort_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas", table => "speechsort" &>

		<table id="speechsort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Speech
						Entries
					</th>

					<th>
						Counted
						Entries
					</th>

					<th>
						Total
						Points
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $school_id (
					sort {
						$schools{$b}{"speech_points"}
						<=>
						$schools{$a}{"speech_points"}
					} keys %schools
				) {

					next unless $schools{$school_id}{"speech"} >= 1;
					my $school = $schools{$school_id}{"object"};
</%perl>

					<tr>

						<td>
							<% $school->name %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"speech"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"speech_count"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"speech_points"} %>
						</td>

					</tr>

%				}


			</tbody>

		</table>

		<span class="half nospace">
			<h4>Annual Sweepstakes: Congress</h4>
		</span>

		<span
			class = "half rightalign"
			id    = "congresssort_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table => "congresssort"
		&>

		<table id="congresssort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Congress Entries
					</th>

					<th>
						Counted Entries
					</th>

					<th>
						Total Points
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $school_id (
					sort {
						$schools{$b}{"congress_points"}
						<=>
						$schools{$a}{"congress_points"}
					} keys %schools
				) {

					next unless $schools{$school_id}{"congress"} >= 1;
					my $school = $schools{$school_id}{"object"};
</%perl>

					<tr>

						<td
							title = "<% $schools{$school_id}{"congress_string"}  %>"
						>
							<% $school->name %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"congress"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"congress_count"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"congress_points"} %>
						</td>

					</tr>
%				}

			</tbody>
		</table>
	</div>
