<%args>
	$tourn
	$entry_id => undef
	$code => undef
	$last => undef
</%args>
<%init>

	my $entry;
	my @entries;

	if ($entry_id) { 
		$entry = Tab::Entry->retrieve($entry_id);
	}

	if ($code) { 

		@entries = Tab::Entry->search( tourn => $tourn, code => $code);

		unless (@entries) {  
			my $err = "No competitors found with speaker code $code";
			$m->redirect("card.mhtml?err=$err");
		}

		$entry = shift @entries if scalar @entries == 1;
	}

	if ($last) { 
		@entries = $m->comp("/funclib/tourn_entries.mas", tourn => $tourn, last => $last);

		unless (@entries) {  
			my $err = "No competitors found with last name $last";
			$m->redirect("card.mhtml?err=$err");
		}
		$entry = shift @entries if scalar @entries == 1;
	}

	
</%init>

	<div class="right small">
	
		<div class="sidenote">

			<h4>Search for entry</h4>

			<span class="evenrow block">
				<form action="card.mhtml" method="post">
				<input type="text" name="code" size="10" placeholder="Code" style="margin-right: 45px;">
				<input class="thin" style="right" type="submit" value="Go">
				</form>
			</span> 

			<span class="evenrow block">
				<form action="card.mhtml" method="post">
				<input type="text" name="last" size="15" placeholder="Last Name" style="margin-right: 15px;">
				<input class="thin" type="submit" value="Go">
				</form>
			</span> 

		</div>

% 		if ($entry) {
		
			<div class="sidenote">
		
				<a href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>" class="yellow block" style="margin-bottom: 10px;">
					View/Edit Entry <% $entry->code %>
				</a>

%				foreach my $panel ($m->comp("/funclib/entry_panels.mas", entry => $entry)) { 
					<a class="blue block" href="panel_card.mhtml?panel_id=<% $panel->id %>">	
						<% $panel->round->realname." Section ".$panel->letter %>
					</a>
%				}

			</div>

%		}

	</div>

	<div class="left huge">

% 		if (@entries && not defined $entry) {

%			foreach my $entry (@entries) { 

				<a class="halfpage blue block noline smallish" href="card.mhtml?entry_id=<% $entry->id %>">
					<% $entry->code %> <% $entry->name %> in <% $entry->event->abbr %>
				</a>
%			}

%		}

% 		if ($entry) {
		
			<h2><% $entry->code %> <% $entry->name %> edit </h2>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						<% $entry->code %>
					</th>

					<th>
						<% $entry->event->abbr %>
					</th>

					<th>
						<% $entry->name %>
					</th>

					<th>
						<% $entry->school->short_name %>
					</th>

				</tr>

			</table> 

			<hr>

			<table cellpadding="4" cellspacing="1" width="100%">

%				my $switch;

%               foreach my $panel ($m->comp("/funclib/entry_panels.mas", entry => $entry)) {

					<tr>
						<td colspan="5">
	
							<h4>
								<% $panel->round->realname %> Section <% $panel->letter %>
								<% ($panel->room) ? "Room ".$panel->room->name : "" %>
							</h4>

							<form action="card_save.mhtml" method="post">
							<input type="hidden" name="entry_id" value="<% $entry->id %>">
							<input type="hidden" name="panel_id" value="<% $panel->id %>">
						</td>

					</tr>
					
					<tr class="yellowrow">
						
						<th>
							Judge
						</th>

						<th>
							Rank
						</th>

						<th>
							Points
						</th>

%                  		if ($tourn->setting("mfl_time_violation")) {
							<th>
								Overtime
							</th>
%						}

%						if ($tourn->setting("noshows_never_break")) {
							<th>
								Noshow
							</th>
%						}

					</tr>

%					foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%						my $ballot = Tab::Ballot->search( judge => $judge->id, panel => $panel->id, entry => $entry->id )->first;
%						next unless $ballot;

%						my $rank;
%						my $points;

%						foreach my $value ($ballot->ballot_values) { 
%							$rank = $value->value if $value->tag eq "rank";
%							$points = $value->value if $value->tag eq "points";
%						}

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td style="padding-left: 15px;">
								<a class="plain block" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
									<% $judge->code %> <% $judge->last %>
								</a>
							</td>

							<td>
								<input type="number" name="rank_<% $ballot->id %>" size="5" value="<% $rank %>">
							</td>

							<td>
								<input type="number" name="points_<% $ballot->id %>" size="5" value="<% $points %>">
							</td>

%                   		if ($tourn->setting("mfl_time_violation")) {
								<td>
									<input type="checkbox" name="tv_<% $ballot->id %>" value="1" <% ($ballot->tv) ? "checked" : "" %>>
								</td>

%							}

%							if ($tourn->setting("noshows_never_break")) {

								<td align="center">
									<input type="checkbox" name="noshow_<% $ballot->id %>" value="1" <% ($ballot->noshow) ? "checked" : "" %>>
								</td>

%							}

						</tr>


%					}

					<tr class="liblrow">
						<td colspan="4" align="right">
							<input type="submit" class="thin" value="  Save Changes  " >
							</form>
						</td>
					</tr>
%				}	

			</table>

%		} #end of if entry

	</div> 
