<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$panel_id => undef
	$judge_id => undef
	%perms    => undef
	$default  => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	unless ($person->site_admin || $person_settings->{'nsda_admin'}) {
		if ( $perms{"checker"} ) {
			$m->print("<p>You do not have access to that function</p>");
			$m->abort();
		}
	}

	my $panel;
	my $bye;

	if ($panel_id) {
		$panel = Tab::Panel->retrieve($panel_id);
	}

	$m->abort() unless $panel;
	my $round = $panel->round;
	my $event = $round->event;

	my $protocol = $round->protocol;

	unless ($protocol) {
		my $msg = "You do not have tiebreakers set for that round; you cannot enter results until you do so";
		$m->redirect("/panel/schemat/panel_view.mhtml?panel_id=$panel_id&msg=$msg");
	}

	my $type = $event->type;
	my $studpoints++ if $event->type ne "congress" &&  $event->type ne "speech";

	my %event_settings = $event->all_settings();
	undef $studpoints if $event_settings{"team_points"};
	undef $studpoints if $event_settings{"ballot_rubric"};

	my $ballot_entry_title = $event->category->setting("ballot_entry_titles");
	my $ballot_time = $event->category->setting("ballot_times");

	my $pts = $event_settings{'point_increments'} if $panel;
	my $step = 1 if $pts eq "whole";
	$step = .5 if $pts eq "half";
	$step = .1 if $pts eq "tenths";
	$step = .25 if $pts eq "fourths";
	$step = .001 if $tourn_settings->{backtab};

	my $min = 0;
	my $max = 999;

	my %tb_types = $m->comp("/funclib/tiebreak_types.mas", round => $round);

    my $aff_string = $event_settings{"aff_label"};
    my $neg_string = $event_settings{"neg_label"};

    $aff_string = "Aff" unless $aff_string;
    $neg_string = "Neg" unless $neg_string;

	my @blanks;

    my $subscores = $event_settings{"wsdc_subtotal_ballot"};
    my %max_categories = ();
    my %min_categories = ();

    my @scores = ("Content", "Style", "Strategy", "POI");

    foreach my $key (@scores) {
        $min_categories{$key} = $event_settings{"min_".lc($key)."_points"};
        $max_categories{$key} = $event_settings{"max_".lc($key)."_points"};
        $min_categories{$key} = 0 unless $min_categories{$key};
        $min_categories{"total"} += $min_categories{$key} unless $key eq "POI";
        $max_categories{"total"} += $max_categories{$key} unless $key eq "POI";
    }

    my $trash = pop @scores unless $max_categories{"POI"};

</%init>

	<& "/funclib/editor.mas", half => 1 &>

	<div class="menu">

		<div class="sidenote">

			<h4>Other functions</h4>

			<a
				href="/panel/schemat/show.mhtml?round_id=<% $round->id %>"
				class = "blue block"
			>
				View <% $round->realname %> Schematic
			</a>

			<hr>

			<a href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				View/Edit Panel <% $panel->letter %>
			</a>

			<a href="/tabbing/entry/index.mhtml?timeslot_id=<% $round->timeslot->id %>" class="yellow block">
				Ballot Entry Screen
			</a>

		</div>

		<div class="sidenote bigger">

			<h4>Panel Bye</h4>
			<a
				href="bye_switch.mhtml?panel_id=<% $panel->id %>"
				class="<% $panel->bye ? "dkblue" : "yellow" %> block"
			>
				<% $panel->bye ? "Disable debate-wide bye" : "Enable debate-wide bye" %>
			</a>

			<h4 class="martop">On byes &amp; forfeits</h4>

			<p>
				If a debate-wide bye is enabled above in prelims, no judges
				will be scheduled, all debaters in the debate will get a win
				and averaged points.  In elims, a debate-wide bye indicates a
				coach/walkover round between teammates; the win should be
				awarded there to the advancing team.  Disable it by clicking
				above to hold an actual debate.
			</p>

			<p>
				Do not enter a win/loss when also entering a forfeit or a bye.
			</p>

			<p>
				For missed scheduled debates, award byes and forfeits on their
				ballots.  A bye given to one or both debaters will count as a
				won debate.  A forfeit/forfeit will count as a loss in the case
				of debate.  If speaker points are entered, <span class="inline
				strong"> even a zero,</span> those points will count;
				otherwise, the average of the entry's other points will be
				added in for this round
			</p>

			<p>
%				if ($protocol->setting("forfeits_never_break")) {
					The "Noshows never advance" protocol_setting is
					enabled for the tiebreaker set used in this round.  Entries
					earning a forfeit will be excluded from clearing to elims
%				}

%				if ($protocol->setting("forfeits_rank_last")) {
					The "Noshows rank last" protocol_setting is
					enabled for the tiebreaker set used in this round.  Entries
					earning a forfeit will be given the last rank in the round.
					This rank DOES count and CAN be altered below.
%				}
			</p>
		</div>
	</div>

	<div class="main">

		<div class="full nospace flexrow">
			<span class="third nospace">
				<h3>Force Edit</h3>
			</span>

			<span class="twothirds nospace rightalign">
				<h6 class='semibold bluetext nospace'>
					<% $event->abbr %>
					<% $round->realname %>
					<% $panel->letter %> |
					Room <% ($panel->room > 0 ) ? $panel->room->name : "NO ROOM" %>
%					if ($round->flighted > 1) {
						Flight <% $panel->flight %>
%					}
				</h6>
			</span>
		</div>
<%perl>

		my $no_codes++ if $event->category->setting('no_codes');

		my @judges = $m->comp('/funclib/panel_judges.mas', panel => $panel);

		my @tabs;
		my %judge_mark;

		my $chair_mark = "*";
		$chair_mark = "Par: " if $event->type eq "congress";

		my %po_contest;

		if ($event->type eq "congress") {

			my $sth = $dbh->prepare("

				select
					event.id, event.name, event.abbr,
					round.id, round.name,
					panel.id, panel.letter

				from event, event_setting es, round, panel

					where event.tourn = ?
					and event.id = es.event
					and es.tag = 'po_contest'
					and es.value = ?
					and event.id = round.event
					and round.name = ?
					and round.id = panel.round
					and panel.letter = ?
			");

			$sth->execute($tourn->id, $event->id, $round->name, $panel->letter);

			while (
				my (
					$event_id, $event_name, $event_abbr,
					$round_id, $round_name,
					$panel_id, $panel_letter
				) = $sth->fetchrow_array()
			) {

				$po_contest{"event_id"} = $event_id;
				$po_contest{"event_name"} = $event_name;
				$po_contest{"event_abbr"} = $event_abbr;

				$po_contest{"round_id"} = $round_id;
				$po_contest{"round_name"} = $round_name;

				$po_contest{"panel_id"} = $panel_id;
				$po_contest{"panel_letter"} = $panel_letter;
			}
		}

		if (scalar @judges > 1 || $po_contest{"event_id"}) {

			foreach my $judge (@judges) {
				my $tab;
				$tab = $chair_mark if $judge->chair;
				$tab .= $judge->code." ".$judge->last;
				$judge_mark{$judge->id} = $tab;

				push @tabs, $judge->id;
			}

			$default = $judge_id unless $default;
			$default = $judges[0] unless $default;

			if ($po_contest{"event_id"}) {
				push @tabs, "entries";
			}

</%perl>
			<& "/funclib/tabs.mas",
				tabs      => \@tabs,
				default   => $default,
				tag_names => \%judge_mark,
				right     => 1
			&>
<%perl>

		}

		my $switch;
		my $notfirst;

		@judges = (0) unless @judges;

		foreach my $judge (sort {$a->code <=> $b->code} @judges) {
			unless ($judge) {
</%perl>
				<div class = "flexrow full nospace">
					<span class="threequarters nospace">
						<h4><% $panel->bye ? "Bye Round" : "No judge assigned" %></h4>
					</span>
<%perl>
			} else {

				next if $type eq "wudc" &! $judge->chair;
				undef $notfirst if $judge_id == $judge->id;
</%perl>
				<div
					class = "<% $judge->id %> screens <% @tabs ? "hidden" : "" %>"
				>

					<div class = "flexrow full nospace">
						<span class="half nospace">
							<h4>
								<% $type eq "wudc"
									? "Chair"
									: ""
								%> Judge <% $judge->code ." ".$judge->first." ".$judge->last %>
							</h4>
						</span>

						<span class="quarter centeralign semibold bluetext">
							<% $event->type eq "congress"
								&& $judge->chair
								? "Parliamentarian"
								: ""
							%>
						</span>
%			}

			<script>
				function confirmBallots(status, targetClass) {
					$("."+targetClass).prop("checked", status);
				}
			</script>

				<span
					id = "<% $panel."-".$judge %>_buttonarea"
					class="quarter rightalign flexrow"
				>
					<span class="foursevenths semibold bluetext">
						Bulk Confirm:
					</span>

					<span class="threesevenths flexrow">

						<span class="half centeralign">
							<a
								class = "buttonwhite fa fa-sm fa-check greentext"
								title = "Confirm all ballots <% $judge ? "for ".$judge->last : ""%>"
								onclick = "confirmBallots(true, 'audit_<% $judge %>');"
							></a>
						</span>

						<span class="half centeralign">
							<a
								class = "buttonwhite fa fa-sm fa-times redtext"
								title = "Un-confirm all ballots <% $judge ? "for ".$judge->last : ""%>"
								onclick = "confirmBallots(false, 'audit_<% $judge %>');"
							></a>
						</span>
					</span>
				</span>
			</div>

			<& "/funclib/tablesorter.mas",
				table     => $panel."-".$judge,
				nobuttons => 1
			&>

			<form
				action = "panel_save.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<input
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge ? $judge->id : "" %>"
			>

			<input
				type  = "hidden"
				name  = "panel_bye"
				value = "<% $panel->bye %>"
			>

			<table id="<% $panel."-".$judge %>">

				<thead>

				<tr class="yellowrow">

					<th class="smaller centeralign hover nosort nospace">
						<label for="judgeswitch_<% $judge %>">
							<span class='full padless'>
								Confirmed
							</span>
						</label>
					</th>

%					if ($type eq "wudc") {
						<th class="smallish">
							Pos
						</th>
%					} elsif ($studpoints) {
						<th class="smallish">
							S
						</th>
%					} elsif ($event->type eq "speech") {
						<th class="smallish">
							Order
						</th>
%					}

					<th class="smallish">
						Code
					</th>

					<th class="smallish">
						Name
					</th>

%					if ($tb_types{"winloss"}) {
						<th class="smallish">
							W
						</th>
%					}

%					if ($tb_types{"rank"}) {
						<th class="smallish">
							<span class="<% $type eq "wsdc" ? "quarter" : "half" %> centeralign">
								Rank
							</span>
						</th>
%					}

%					if ($tb_types{"point"}) {

						<th class="smallish nosort">

%							if ($studpoints) {
								<span class="<% $type eq "wsdc" ? "quarter" : "twofifths" %> smallish">
									Speaker
								</span>

								<span class="<% $type eq "wsdc" ? "quarter" : "threefifths rightalign" %> nospace">
									Points
								</span>
%							} else {
								Points
%							}

%							if ($type eq "wsdc") {
								<span class="quarter centeralign">
									Speech #
								</span>

								<span class="quarter centeralign">
									Reply Pts
								</span>
%							}
						</th>
%					}

%					if ($judge && $judge->chair && $tb_types{"best_po"}) {
						<th class="smallish">
							Best PO
						</th>
%					}

%					if ($ballot_time) {
						<th class="smallish">
							Time
						</th>
%					}

%              		if ($tb_types{"tv"}) {
						<th class="smallish">
							Violation
						</th>
%					}

%					if ($event->type ne "congress" &&  $event->type ne "speech") {
						<th class="smallish centeralign">
							Bye
						</th>

						<th class="smallish centeralign">
							FFT
						</th>
%					} elsif ($protocol->setting("forfeits_never_break")
%						|| $protocol->setting("forfeits_rank_last")
%					) {
						<th class="smallish centeralign">
							Forfeit
						</th>
%					}

				</tr>

				</thead>
<%perl>

				my $rfd;
				my %student_categories;
				my %entry_students;
				my @category_students;

				my %student_ranks = ();
				my %student_points = ();
				my %student_position = ();

				my %comment;
				my %subpoint;
				my %rubric;
				my %entry_title;
				my %entry_time;
				my %entry_ballots;

				my @all_ballots;

				my @entries = $m->comp('/funclib/panel_entries.mas', panel => $panel);

				@entries = sort {$a->side cmp $b->side} @entries;

				Tab::Ballot->columns(TEMP => "entrycode");
				Tab::Ballot->columns(TEMP => "entryname");

				$m->print('</tbody>');

				foreach my $entry (@entries) {

					my @ballots = Tab::Ballot->search(
						judge => $judge->id,
						entry => $entry->id,
						panel => $panel->id
					) if $judge;

					@ballots = Tab::Ballot->search(
						entry => $entry->id,
						panel => $panel->id
					) unless $judge;

					next unless @ballots;

					push @all_ballots, @ballots;
					my $ballot = shift @ballots;

					$ballot->entrycode($entry->code);
					$ballot->entryname($entry->name);

					my $win;
					my $rank;
					my $points;
					my $best_po;

					VALUE:
					foreach my $score ($ballot->scores) {

						if ($score->tag eq "rfd") {

							$rfd = $score;

						} elsif ($score->tag eq "best_po") {

							$best_po = $score;

						} elsif ($score->tag eq "rubric") {

							$rubric{$ballot->id} = eval {
								return JSON::decode_json($score->content);
							};

						} elsif ($score->tag eq "categories") {

							if ($score->student > 0)  {

								$student_categories{$score->student->id}{"name"}
									= $score->student->first." ".$score->student->last;

								$student_categories{$score->student->id}{"entry"}
									= $score->ballot->entry->code;

								$student_categories{$score->student->id}{"scores"} = $score->text;
							}

						} elsif ($score->tag eq "time") {

							$entry_time{$entry->id} = $score;

						} elsif ($score->tag eq "title") {

							$entry_title{$entry->id} = $score;

						} elsif ($score->tag eq "comments") {
							$comment{$ballot->id} = $score;

						} elsif ($score->tag eq "categories") {

							$subpoint{$ballot->id} = $score;

						} elsif ($score->tag eq "winloss") {

							$win = $score->value;

						} elsif ($score->tag eq "rank") {

							$rank = $score->value;
							$student_ranks{$score->student->id} = $score->value
								if $score->student;

						} elsif ($score->tag eq "point") {

							$points = $score->value;

							$student_points{$score->student->id}{"points"} = $score->value
								if $score->student;

							$student_position{$score->student->id} = $score->position if $type eq "wsdc";

						} elsif ($score->tag eq "refute") {

							$points = $score->value;

							$student_points{$score->student->id}{"rebuttal"} = $score->value
								if $score->student;

						} elsif ($score->tag eq "categories") {

							$student_points{$score->student->id}{"categories"}{$score->text}
								= $score->content;

						} elsif ($score->tag eq "subpoints") {

							if ($score->student > 0) {
								#this works for WSDC now
								$student_points{$score->student->id}{"subpoints"} = eval {
									return JSON::decode_json($score->content);
								}

							} else {
								#but not yet for anyone else
								$subpoint{$ballot->id} = $score->content();
							}

						} else {

							push @blanks, $score unless $score->tag;

						}
					}

					@{$entry_students{$entry->id}} = $entry->students;

					Tab::Student->set_sql(by_panel => "
						select distinct student.*
							from student, score, ballot
						where ballot.panel = ?
							and ballot.id = score.ballot
							and score.student = student.id
							and ballot.entry = ?
					");

					push @{$entry_students{$entry->id}},
						Tab::Student->search_by_panel($panel->id, $entry->id);

					my %seen = ();
					@{$entry_students{$entry->id}} =
						grep { ! $seen{$_->id} ++ }
						@{$entry_students{$entry->id}};

</%perl>

					<tr class="row">

						<td class="centeralign nospace">

							<label for="audit_<% $ballot->id %>">
								<div class="padless full hover">
									<input
										type  = "checkbox"
										class = "audit_<% $judge %>"
										id    = "audit_<% $ballot->id %>"
										name  = "audit_<% $ballot->id %>"
										value = "1"
										<% $ballot->audit ? 'checked="checked"' : "" %>
									>
								</div>
							</label>
						</td>

%						if ($type eq "wudc") {
							<td class="smallish centeralign">
                                <% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
                                <% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
                                <% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
                                <% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>
							</td>
%						} elsif ($studpoints) {
							<td class="smallish centeralign">
								<% $ballot->side == 1 ? $aff_string : "" %>
								<% $ballot->side == 2 ? $neg_string : "" %>
							</td>
%						} elsif ($event->type eq "speech") {
							<td class="smallish centeralign">
								<% $ballot->speakerorder %>
							</td>
%						}

						<td title="<% $entry->code %>">
							<a
								href     = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
								class    = "white"
								tabindex = "-1"
							>
								<% $entry->code %>
							</a>
						</td>

						<td>
%							my $name = $entry->name;
							<span class="hidden"><% $entry->lastname %></span>
							<a
								href     = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
								class    = "white"
								tabindex = "-1"
							>
								<% $entry->name %>
							</a>
						</td>

%						if ($tb_types{"winloss"} && $type eq "wudc") {

							<td class="centeralign">
								<input
									type  = "checkbox"
									name  = "<% $entry->id %>_winloss"
									value = "1"
									<% $win ? "checked" : "" %>
								>
							</td>

%						} elsif ($tb_types{"winloss"}) {

							<td class="centeralign padno">

								<label for="winner_<% $ballot->id %>_<% $entry->id %>">
%									if ($person->site_admin && $tourn_settings->{"nsda_nats"}) {
										<div class="padmuchmore full hover">
											<input
												type  = "checkbox"
												id    = "winner_<% $ballot->id %>_<% $entry->id %>"
												name  = "<% $entry->id %>_winloss"
												value = 1
												<% $win ? 'checked="checked"' : "" %>
											>
										</div>
%									} else {
										<div class="padmuchmore full hover">
											<input
												type  = "radio"
												id    = "winner_<% $ballot->id %>_<% $entry->id %>"
												name  = "winloss"
												value = "<% $entry->id %>"
												<% $win ? 'checked="checked"' : "" %>
											>
										</div>
%									}
								</label>
							</td>
%						}

%						if ($tb_types{"rank"} && $studpoints && $type ne "wudc") {

							<td class="nowrap nospace">

%								foreach my $student (@{$entry_students{$entry->id}}) {

									<div class="flexrow">
										<span class="half smallish">
											<% substr($student->first,0,1)%> <% $student->last %>
										</span>

										<span class="half">
											<input
												type  = "number"
												class = "smaller"
												name  = "ranks_<% $student->id %>"
												step  = "<% $step %>"
												value = "<% $student_ranks{$student->id} %>"
												min   = "<% $min %>"
												max   = "<% $max %>"
											>
										</span>
									</div>
%								}
							</td>

%						} elsif ($tb_types{"rank"})  {

							<td class="nowrap centeralign nospace">

								<span class="hidden"><% $rank %></span>

								<input
									type  = "number"
									class = "smaller padvertless"
									name  = "rank_<% $ballot->id %>"
									size  = "4"
									step  = "<% $step %>"
									value = "<% $rank %>"
									min   = "<% $min %>"
									max   = "<% $max %>"
								>
							</td>
%						}

%						if ($tb_types{"point"}) {

							<td class="nowrap centeralign nospace">

%								if ($studpoints) {

%									foreach my $student (@{$entry_students{$entry->id}}) {

										<div class="nospace">

											<span class="<% $type eq "wsdc" ? "quarter" : "twofifths" %> smallish">
												<% substr($student->first,0,1)%> <% $student->last %>
											</span>

											<span class="<% $type eq "wsdc" ? "quarter" : "threefifths rightalign" %>">
												<input
													type  = "number"
													class = "thin"
													name  = "points_<% $student->id %>"
													value = "<% $student_points{$student->id}{"points"} %>"
													step  = "<% $step %>"
													min   = "<% $min %>"
													max   = "<% $max %>"
												>
											</span>

%											if ($type eq "wsdc") {
												<span class="quarter">
													<input
														type  = "number"
														class = "smaller"
														name  = "position_<% $student->id %>"
														size  = "4"
														value = "<% $student_position{$student->id} %>"
														step  = "1"
														max   = "3"
													>
												</span>

												<span class="quarter">
													<input
														type  = "number"
														class = "smaller"
														name  = "refute_<% $student->id %>"
														size  = "4"
														step  = "<% $step %>"
														value = "<% $student_points{$student->id}{"rebuttal"} %>"
														min   = "<% $min %>"
														max   = "<% $max %>"
													>
												</span>
%											}

										</div>
%									}
%								} else {

									<span class="hidden"><% $points %></span>
									<input
										type  = "number"
										class = "smaller"
										name  = "points_<% $ballot->id %>"
										size  = "4"
										step  = "<% $step %>"
										value = "<% $points %>"
										min   = "<% $min %>"
										max   = "<% $max %>"
									>
%								}
							</td>
%						}

%						if ($ballot->chair && $tb_types{"best_po"}) {
							<td class="centeralign nospace">
								<label for="best_po_<% $ballot->id %>">
									<span class="full padvertless marno hover">
										<input
											type  = "checkbox"
											name  = "best_po_<% $ballot->id %>"
											id    = "best_po_<% $ballot->id %>"
											value = "1"
											<% ($best_po) ? "checked" : "" %>
										>
									</span>
								</label>
							</td>
%						}

%						if ($ballot_time) {
							<td class="centeralign">
								<input
									type  = "text"
									size="16"
									name  = "time_<% $ballot->id %>"
									value = "<% $entry_time{$entry->id} ? $entry_time{$entry->id}->content :"" %>"
								>
							</td>
%						}

%                  		if ($tb_types{"tv"}) {

							<td class="centeralign">
								<input
									type  = "checkbox"
									name  = "tv_<% $ballot->id %>"
									value = "1"
									<% ($ballot->tv) ? "checked" : "" %>
								>
							</td>
%						}

%						if ($event->type ne "congress" &&  $event->type ne "speech") {

							<td class="centeralign nospace">
								<label for="bye_<% $ballot->id %>">
									<div class="full hover">
										<input
											type  = "checkbox"
											name  = "bye_<% $ballot->id %>"
											id    = "bye_<% $ballot->id %>"
											value = "1"
											<% ($ballot->bye > 0) ? 'checked="checked"' : "" %>
										>
									</div>
								</label>
							</td>

							<td class="centeralign nospace">
								<label for="forfeit_<% $ballot->id %>">
									<div class="full hover">

										<input
											type  = "checkbox"
											name  = "forfeit_<% $ballot->id %>"
											id    = "forfeit_<% $ballot->id %>"
											value = "1"
											<% ($ballot->forfeit > 0) ? "checked" : "" %>
										>

									</div>
								</label>
							</td>

%						} elsif ($protocol->setting("forfeits_never_break")
%							|| $protocol->setting("forfeits_rank_last")
%						) {
							<td class="centeralign">
								<input
									type  = "checkbox"
									name  = "forfeit_<% $ballot->id %>"
									value = "1"
									<% ($ballot->forfeit) ? "checked" : "" %>
								>
							</td>
%						}
					</tr>
%				}
				</tbody>
			</table>

%			if ($event_settings{"ballot_rubric"}) {

				<h5 class="nospace padvert martopmore">
					Rubric Scores
				</h5>

				<script>

					function totalPoints(ballotId) {
						let total = 0;

						$(`.${ ballotId }_scores`).each( (index, item) => {
							const points = parseInt($(item).val());

							if (points > 1) {
								total += points;
								console.log(`Points are ${points} total is now ${total}`);
							}

						});

						$(`#${ ballotId }_total`).text(total);
					}

					$(document).ready( () => {
%						foreach my $ballot (@all_ballots) {
							totalPoints(<% $ballot->id %>);
%						}
					});

				</script>

%				foreach my $ballot (@all_ballots) {

					<span class="pagehalf">

						<h6><% $ballot->entry->code %></h6>

%						foreach my $order (sort {$a <=> $b} keys %{$event_settings{"ballot_rubric"}{$ballot->side}}) {

%							my $row = $event_settings{"ballot_rubric"}{$ballot->side}{$order};

							<div class="row flexrow">

%								if ($row->{'speaker'}) {
									<span class="twofifths padleft">
										<% $row->{"label"} %>
									</span>

									<span class="twofifths">
										<select
											name = "<% $ballot->id %>_<% $order %>_speaker"
										>
											<option value=""></option>
%											foreach my $student (@{$entry_students{$ballot->entry->id}}) {
												<option
													value="<% $student->id %>"
													<% $rubric{$ballot->id} && $student->id == $rubric{$ballot->id}{$order}{"speaker"}
														? "selected"
														: ""
													%>
												><% $student->first." ".$student->last %></option>
%										}
										</select>
									</span>

%								} else {
									<span class="fourfifths padleft padright">
										<% $row->{"label"} %>
									</span>
%								}

								<span class="fifth padright centeralign">
									<input
										type     = "number"
										class    = "<% $ballot->id %>_scores"
										name     = "<% $ballot->id %>_<% $order %>"
										onChange = "totalPoints(<% $ballot->id %>);"
										value    = "<% $rubric{$ballot->id}
											? $rubric{$ballot->id}{$order}{'points'}
											: "" %>"
									>
								</span>
							</div>
%						}

						<div class="full flexrow ltblue">
							<span class="fivesixths padvert padleft semibold">
								Calculated Total
							</span>

							<span class="semibold sixth centeralign" id="<% $ballot->id %>_total">
								0
							</span>
						</div>
					</span>
<%perl>
				}
			}

			if ($event_settings{"speakers_rubric"}) {

				my %outstanding;
				my %points;

				foreach my $order (sort {$a <=> $b} keys %{$event_settings{"speakers_rubric"}}) {
					my $row = $event_settings{"speakers_rubric"}{$order};
					$points{$row->{"points"}} = $row->{"order"};
				}

				foreach my $ballot (@all_ballots) {
					foreach my $score ($ballot->scores( tag => "speaker")) {
						$outstanding{$score->speech} = $score->student->id;
					}
				}
</%perl>
				<h5 class="nospace padvert martopmore">
					Best Speakers
				</h5>

				<span class="pagehalf">
<%perl>
					foreach my $order (sort {$a <=> $b} keys %{$event_settings{"speakers_rubric"}}) {
						my $row = $event_settings{"speakers_rubric"}{$order};
</%perl>
						<div class="row">

							<span class="twofifths">
								<span class="quarterspacer"></span>
								<% $row->{label} %>
							</span>

						 	<span class="tenth rightalign">
								<% $row->{points} %>
								<span class="quarterspacer"></span>
							</span>

							<span class="half">
								<select
									name="speaker_<% $order %>"
								>
									<option value=""></option>
%									foreach my $entry (@entries) {
%										foreach my $student (@{$entry_students{$entry->id}}) {
											<option
												value="<% $student->id %>"
												<% $outstanding{$order} == $student ? "selected" : "" %>
											><% $student->first." ".$student->last %></option>
%										}
%									}
								</select>
							</span>
						</div>
%					}
				</span>
%			}

<%perl>
			if ($event_settings{"roles_rubric"}) {

				my %outstanding;
				my %points;

				foreach my $order (sort {$a <=> $b} keys %{$event_settings{"roles_rubric"}}) {
					my $row = $event_settings{"roles_rubric"}{$order};
					$points{$row->{"points"}} = $row->{"order"};
				}

				foreach my $ballot (@all_ballots) {
					foreach my $score ($ballot->scores( tag => "speaker")) {
						$outstanding{$score->position} = $score;
					}
				}
</%perl>
				<h5 class="nospace padvert martopmore">
					Best Role Speakers
				</h5>
<%perl>
				foreach my $order (sort {$a <=> $b} keys %{$event_settings{"roles_rubric"}}) {
					my $row = $event_settings{"roles_rubric"}{$order};
</%perl>
					<div class="row flexrow">

						<span class="twofifths padleft">
							<% $row->{label} %>
						</span>

					 	<span class="tenth rightalign padright">
							<% $row->{max_points} %>
						</span>

						<span class="half">
							<select name="role_<% $order %>">
								<option value=""></option>
%								foreach my $entry (@entries) {
%									foreach my $student (@{$entry_students{$entry->id}}) {
										<option
											value="<% $student->id %>"
											<% $outstanding{$order} && $outstanding{$order}->student == $student ? "selected" : "" %>
										><% $student->first." ".$student->last %></option>
%									}
%								}
							</select>
						</span>

					 	<span class="tenth rightalign padright">
							Pts:
						</span>
					 	<span class="tenth rightalign padright">
							<input
								type  = "number"
								name  = "role_<% $order %>_points"
								value = "<% $outstanding{$order} ? $outstanding{$order}->value : "" %>"
							>
						</span>
					</div>
%				}
%			}

%			if ($subscores || keys %student_categories) {
				<h5 class="nospace padvert martopmore">
					Category subscores
				</h5>
<%perl>

				if ($subscores) {

					my %entry_reply;
					my $width = "quarter";
					$width = "third" unless $max_categories{"POI"};

					foreach my $entry (@entries) {

</%perl>
						<span class="pagehalf">

						<h6 class="nowrap"><% $entry->code %></h6>

%						foreach my $student (@{$entry_students{$entry->id}}) {

							<div class="row">
								<div class="quarter semibold smallish">
									<% substr($student->first, 0, 1)." ".$student->last %>
								</div>

								<div class="threequarters nospace">
%									foreach my $subscore (@scores) {
										<span class="<% $width %> nospace padvertless">
											<span class="half smallish nospace">
												<% ucfirst($subscore) %>
											</span>
											<span class="half smallish nospace">
												<input
													type  = "text"
													size  = "4"
													class = "most"
													name  = "<% $student->id %>_<% lc($subscore) %>"
													value = "<% $student_points{$student->id}{"subpoints"}{"speech"}{lc($subscore)} %>"
												>
											</span>
										</span>
%									}
								</div>

							</div>

%							$entry_reply{$entry} = $student if $student_points{$student->id}{"subpoints"}{"reply"};
%						}

						</span>
%					}

					<p class="semibold bluetext">Replies</p>

%					foreach my $entry (@entries) {

						<span class="pagehalf">
							<div class="padmore row">
								<span class="quarter nospace">
									<select name="<% $entry->id %>_reply_student">
										<option value=""></option>
%										foreach my $student (@{$entry_students{$entry->id}}) {
											<option value="<% $student->id %>"
												<% $student == $entry_reply{$entry} ? "selected" : "" %>
											><% $student->first." ".$student->last %></option>
%										}
									</select>
								</span>

								<span class="threequarters nospace">
%									foreach my $subscore (@scores) {
										<span class="<% $width %> nospace">
											<span class="half smallish nospace">
												<% ucfirst($subscore) %>
											</span>
											<span class="half smallish nospace">
												<input
													type  = "text"
													size  = "4"
													class = "most"
													name  = "<% $entry->id %>_reply_<% lc($subscore) %>"
													value = "<% $entry_reply{$entry}
														? $student_points{$entry_reply{$entry}->id}{"subpoints"}{"reply"}{lc($subscore)}
														: ""
													%>"
												>
											</span>
										</span>
%									}
								</span>
							</div>
						</span>
<%perl>
					}

				} else {

					foreach my $entry (@entries) {
</%perl>
						<span class="pagehalf">
							<h6><% $entry->code %></h6>

%							foreach my $student (@{$entry_students{$entry->id}}) {

								<div class="padmore row">

									<div class="marno padless">
										<% $student->first." ".$student->last %>
									</div>

									<div class="marno padless">
										<textarea
											name  = "subscores_<% $student->id %>"
											rows  = "1"
											cols  = "56"
											class = "short"
										><% $student_categories{$student->id}{"scores"} %></textarea>
									</div>
								</div>
%							}
						</span>
%					}

					<div class="libl row rightalign padvert marright marleft">
						<span class="third centeralign">
							<input
								type  = "submit"
								value = "Save Details"
							>
						</span>
					</div>
%				}
%			}

			<div class="libl full rightalign">
				<span class="third centeralign padvert">
					<input
						type  = "submit"
						value = "Save Changes"
					>
					</form>
				</span>
			</div>

			<form
				action = "panel_extras_save.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<input
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge ? $judge->id : "" %>"
			>

%			if ($tourn_settings->{'legion'}) {

%				foreach my $ballot (@all_ballots) {

					<h5>Subpoints for <% $ballot->entry->code %> <% $ballot->entry->name %></h5>

					<div class="padmore row centeralign">
						<textarea
							name  = "categories_<% $ballot->id %>"
							rows  = "10"
							cols  = "84"
							class = "short"
						><% $subpoint{$ballot->id} ? $subpoint{$ballot->id} : ""
						%></textarea>
					</div>
%				}

%			} elsif ($type eq 'congress') {

				<script>
					function showCongress(selector) {
						$(".speeches").addClass("hidden");
						var chosenOne = $(selector).val();

						if (chosenOne) {
							$("."+chosenOne).removeClass("hidden");
						}
					}

					function defaultCongress() {
						$(".speeches").addClass("hidden");
						var chosenOne = $("#<% $judge %>_congress_entry_id").val();
						if (chosenOne) {
							$("."+chosenOne).removeClass("hidden");
						}
					}

					$(document).ready(function() {
						defaultCongress();
					});

				</script>

				<div class="centeralign padvert martopmore bluebordertop">

					<span class="third centeralign semibold bigger redtext">
						Show feedback &amp; speeches for:
					</span>

					<span class="twothirds leftalign">
						<select
							id       = "<% $judge %>_congress_entry_id"
							name     = "<% $judge %>_congress_entry_id"
							class    = "fixedmost congress_select"
							onChange = "showCongress(this);"
						>
							<option value=""></option>
%							foreach my $ballot (@all_ballots) {
								<option
									value="<% $ballot->entry %>_<% $judge %>"
									<% $ARGS{"entry_id"} == $ballot->entry ? 'selected' : "" %>
								><% $ballot->entrycode %> <% $ballot->entrycode ne $ballot->entryname ? $ballot->entryname : "" %></option>
%							}
						</select>
					</span>
				</div>

%			} else {

				<h5>RFD</h5>

				<div class="padmore row centeralign">

					<textarea
						name  = "rfd"
						rows  = "8"
						cols  = "84"
						class = "short"
					><% $rfd ? $rfd->text : "" %></textarea>
				</div>
%			}

<%perl>

			Tab::Score->set_sql( entry_po => "
				select score.*
					from score, ballot
				where ballot.entry = ?
					and ballot.panel   = ?
					and ballot.id = score.ballot
					and score.tag = 'po'
			");

			my $feedback;

			foreach my $ballot (@all_ballots) {

				my $entry = $ballot->entry;
				next unless $entry > 0;

				my $notfirst;

				if ($type ne 'congress') {

					$feedback++;
</%perl>
					<span class="threequarters nospace">
						<h5>Comments for <% $entry->code %></h5>
					</span>

					<span class="quarter rightalign nospace">
						<p><% $entry->name %></p>
					</span>

					<div class="padmore row centeralign">
						<textarea
							name  = "comments_<% $ballot->id %>"
							rows  = "10"
							cols  = "84"
							class = "short"
						><% $comment{$ballot->id}
							? $comment{$ballot->id}->text
							: ""
						%></textarea>
					</div>

%				} else {

					<div class="full speeches nospace <% $ARGS{"entry_id"} == $entry->id ? "" : "hidden" %>
						<% $entry->id %>_<% $ballot->judge ? $ballot->judge->id : "0" %>"
					>
<%perl>
						my $comments = $ballot->scores( tag => "comments")->first;

						if ($comments) {

							$feedback++;
</%perl>
							<h5>General Feedback</h5>

							<div class="full nospace ltbordertop">
								<div class="padmore row centeralign">
									<textarea
										name  = "comments_<% $ballot->id %>"
										rows  = "16"
										cols  = "84"
										class = "short"
									><% $comments->text %></textarea>
								</div>
							</div>
%						}

<%perl>
						my $po = Tab::Score->search_entry_po($entry->id, $panel->id)->first;

						my @speeches = $ballot->scores(tag => "speech");

						if (@speeches) {
							$m->print('<h5>Speeches for '.$entry->code.'</h5>');
						}

						foreach my $score (@speeches) {

							$feedback++;
</%perl>
							<div class="full nospace ltbordertop">

								<span class="semibold bluetext rightalign fifth">
									Speech <% $score->speech %>
								</span>

								<span class="semibold bluetext rightalign fifth">
									Points
									<input
										type  = "number"
										name  = "points_<% $score->id %>"
										value = "<% $score->value %>"
									>
								</span>

								<span class="semibold bluetext rightalign fifth">
									PO
									<input
										type  = "checkbox"
										name  = "po_<% $score->id %>"
										value = "1"
										<% $po ? "checked" : ""  %>
									>
								</span>

								<span class="semibold bluetext rightalign twofifths">
									Topic
									<input
										type  = "text"
										name  = "topic_<% $score->id %>"
										size  = "32"
										value = "<% $score->topic %>"
									>
								</span>

								<div class="padmore row centeralign">
									<textarea
										name  = "speech_<% $score->id %>"
										rows  = "16"
										cols  = "84"
										class = "short"
									><% $score->text %></textarea>
								</div>
							</div>
%						}
					</div>
%				}
%			}

%			if ($feedback) {
				<div class="libl rightalign marno">
					<span class="third centeralign">
						<input
							type  = "submit"
							value = "Save Ballot Edits"
						>
					</span>
				</div>
%			}

			</form>

			</div>
%		}


<%perl>
		if ($po_contest{"event_id"}) {

			my %voters;
			my %pos;

			my $entry_sth = $dbh->prepare("
				select
					entry.id, entry.code, entry.name, entry.active
				from entry, ballot
				where ballot.panel = ?
					and ballot.entry = entry.id
			");

			$entry_sth->execute($panel->id);

			my $all_pos = $entry_sth->fetchall_hash();

			foreach my $ap (@{$all_pos}) {
				$pos{$ap->{id}}{"code"} = $ap->{code};
				$pos{$ap->{id}}{"name"} = $ap->{name};
			}

			my $sth = $dbh->prepare("

				select
					entry.id, entry.code, entry.name, entry.active,
					sv.tag, sv.value, sv.panel, sv.entry,
					CONVERT_TZ(sv.entered_at, '+00:00', tourn.tz),
					po.id, po.code, po.name

				from (ballot, entry, event, tourn)

					left join student_vote sv on sv.panel = ? and sv.voter = entry.id
					left join entry po on sv.entry = po.id

				where ballot.panel = ?
					and ballot.entry = entry.id
					and entry.event = event.id
					and event.tourn = tourn.id
			");

			$sth->execute($panel->id, $po_contest{"panel_id"});

			while (
				my (
					$entry_id, $entry_code, $entry_name, $entry_active,
					$sv_tag, $sv_value, $sv_panel, $sv_entry, $sv_timestamp,
					$po_id, $po_code, $po_name
				) = $sth->fetchrow_array()
			) {

				unless ($pos{$po_id}) {
					$pos{$po_id}{"code"} = $po_code;
					$pos{$po_id}{"name"} = $po_name;
				}

				$voters{$entry_id}{"code"} = $entry_code;
				$voters{$entry_id}{"name"} = $entry_name;
				$voters{$entry_id}{"active"} = $entry_active;

				$voters{$entry_id}{"votes"}{$po_id}{$sv_tag} = $sv_value;
				$voters{$entry_id}{timestamp} = $sv_timestamp;
			}
</%perl>

			<div class="screens hidden entries">

				<span class="twothirds nospace">
					<h5>
						PO Contest votes from <% $po_contest{"event_abbr"} %>
						Chamber <% $po_contest{"panel_letter"} %>
						Session <% $po_contest{"round_name"} %>
					</h5>
				</span>
				<span class="third rightalign nospace">
					<p class="semibold bluetext">
						Target Section <% $po_contest{"panel_id"} %>
					</p>
				</span>

				<& "/funclib/tablesorter.mas",
					table     => "entry_vote",
					nobuttons => 1
				&>

				<form
					action = "po_vote_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel->id %>"
				>
				<input
					type  = "hidden"
					name  = "target_id"
					value = "<% $po_contest{"panel_id"} %>"
				>

				<table id="entry_vote">

					<thead>
						<tr class="yellowrow">
							<th>
								Voter Code
							</th>
							<th>
								Voter Name
							</th>
							<th>
								Timestamp
							</th>

%							foreach my $po (sort keys %pos) {
%								next unless $po > 0;
								<th title='<% $pos{$po}{"name"} %>'>
									<% $pos{$po}{"code"} %>
								</th>
%							}
							<th>
								No Vote
							</th>
						</tr>
					</thead>

					<tbody>

%						foreach my $voter_id (sort {$voters{$a}{"code"} cmp $voters{$b}{"code"}} keys %voters) {

							<tr>

								<td>
									<% $voters{$voter_id}{"active"} ? "" : "DROP" %>
									<% $voters{$voter_id}{"code"} %>
								</td>

								<td>
									<% $voters{$voter_id}{"name"} %>
								</td>
								<td>
									<% $voters{$voter_id}{"timestamp"} %>
								</td>

%								my $done;
%								foreach my $po (sort keys %pos) {
%									next unless $po > 0;
%									$done++ if $voters{$voter_id}{"votes"}{$po}{"winloss"} > 0;
									<td class="centeralign nospace">
										<label for="<% $voter_id %>_<% $po %>">
											<span class="full padvertless hover">
												<input
													type  = "radio"
													name  = "vote_<% $voter_id %>"
													id    = "<% $voter_id %>_<% $po %>"
													value = "<% $po %>"
													<% $voters{$voter_id}{"votes"}{$po}{"winloss"}
														? "checked"
														: ""
													%>
												>
											</span>
										</label>
									</td>
%								}
								<td class="centeralign nospace">
									<label for="<% $voter_id %>_NULL">
										<span class="full padvertless yellowhover">
											<input
												type  = "radio"
												name  = "vote_<% $voter_id %>"
												id    = "<% $voter_id %>_NULL"
												value = "NULL"
												<% $done
													? ""
													: "checked"
												%>
											>
										</span>
									</label>
								</td>
							</tr>
%						}
					</tbody>
				</table>

				<div class="libl row rightalign">
					<span class="third centeralign">
						<input type="submit" value="Save Entry Votes">
					</span>
				</div>

				</form>
			</div>
%		}

%		if (@blanks) {

			<h3>Warning: Blank Scores Detected</h3>

			<form action="blanks_correct.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<p>
				There's an ongoing issue with ballots where scores will not be
				saved with their type.  It'll look like a ballot was entered
				without any results.  It's annoying me to no end and I can't
				figure out where it's happening.  So in the interim I give you
				a way to fix it after the fact.  Enter the score type
				below:
			</p>

%			foreach my $score (@blanks) {

				<div class="row full marno padless">

					<span class="twofifth smallish">

						<div class="full padno">
							<% $score->ballot->entry->code %>
							<% $score->student->id ? "/".$score->student->last : "" %>
						</div>

						<div class="full nospace">
							<% $score->ballot->judge->last %>
						</div>

					</span>

					<span class="fifth">
						Score: 	<% $score->value %>
					</span>
<%perl>
					my $default = "rank";

					$default = "winloss"
						if $tb_types{"winloss"}
						&& ($score->value < 2)
						&! $score->student;

					$default = "points"
						if $tb_types{"point"}
						&& $score->value > 10
						&& $score->student;
</%perl>

					<span class="twofifth nospace">

						<label for="winloss_<% $score->id %>">
							<span class="third hover">
								<input
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "winloss_<% $score->id %>"
									value = "winloss"
									<% $default eq "winloss" ? 'checked="checked"' : "" %>
								>Win/Loss
							</span>
						</label>

						<label for="rank_<% $score->id %>">
							<span class="third hover">
								<input
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "rank_<% $score->id %>"
									value = "rank"
									<% $default eq "rank" ? 'checked="checked"' : "" %>
								>Rank
							</span>
						</label>

						<label for="points_<% $score->id %>">
							<span class="third hover">
								<input
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "points_<% $score->id %>"
									value = "points"
									<% $default eq "points" ? 'checked="checked"' : "" %>
								>Points
							</span>
						</label>
					</span>

				</div>

%			}

			<div class="libl rightalign full">
				<input
					type  = "submit"
					value = "Save Score Labels"
				>
				</form>
			</div>

%		}

%		if ($type eq "wudc") {

			<h5>Panelists:
%			foreach my $judge (sort {$a->code <=> $b->code} @judges) {
%				next if $judge->chair;
				<% $judge->first." ".$judge->last %>
%			}
			</h5>
%		}

	</div>
