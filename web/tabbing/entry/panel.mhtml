<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$panel_id => undef
	$judge_id => undef
	%perms    => undef
	$default  => undef
</%args>
<%init>

	unless ($person->site_admin || $person_settings->{'nsda_admin'}) { 
		if ( $perms{"entry_only"} ) { 
			$m->print("<p>You do not have access to that function</p>");
			$m->abort();
		}
	}

	my $panel;
	my $bye;

	if ($panel_id) { 
		$panel = Tab::Panel->retrieve($panel_id);
	}

	$m->abort unless $panel;

	my $round = $panel->round;
	my $event = $round->event;

	unless ($round->tiebreak_set) { 

		my $msg = "You do not have tiebreakers set for that round; you cannot enter results until you do so";
		$m->redirect("/panel/schemat/panel_view.mhtml?panel_id=$panel_id&msg=$msg");
	}

	my $wudc++ if $event->type eq "wudc";
	my $wsdc++ if $event->type eq "wsdc";


	my $studpoints++ if $event->type ne "congress" &&  $event->type ne "speech";

	my %event_settings = $event->all_settings();

	undef $studpoints if $event_settings{"team_points"};

	my $ballot_entry_title = $event->category->setting("ballot_entry_titles");

	my $pts = $event_settings{'point_increments'} if $panel;
	my $step = 1 if $pts eq "whole";

	$step = .5 if $pts eq "half";
	$step = .1 if $pts eq "tenths";
	$step = .25 if $pts eq "fourths";

	my $min = 0;
	my $max = 999;

	my %tb_types = $m->comp("/funclib/tiebreak_types.mas", tiebreak_set => $round->tiebreak_set);

    my $aff_string = $event_settings{"aff_label"};
    my $neg_string = $event_settings{"neg_label"};

    $aff_string = "Aff" unless $aff_string;
    $neg_string = "Neg" unless $neg_string;

	TIEBREAK:

    foreach my $tb ($round->tiebreak_set->tiebreaks) { 

        $tb_types{"ranks"}++ if (
			$tb->name eq "ranks" 
			|| $tb->name eq "reciprocals"
			|| $tb->name eq "opp_ranks"
			|| $tb->name eq "chair_ranks"
			|| $tb->name eq "downs"
		);

        $tb_types{"winloss"}++ if (
			$tb->name eq "opp_wins" 
			|| $tb->name eq "winloss" 
			|| $tb->name eq "ballots"
			|| $tb->name eq "losses"
			|| $tb->name eq "headtohead"
		);

        $tb_types{"points"}++ if (
			$tb->name eq "points" 
			|| $tb->name eq "opp_points"
			|| $tb->name eq "three_way_points"
		);

		if ($tb->child) { 

			if ( $tb->count eq "all" || $tb->count eq "previous") { 

			} else { 

				next TIEBREAK 
					if $tb->count eq "final" 
					&& $round->type ne "final";

				next TIEBREAK 
					if $tb->count eq "elim" 
					&& $round->type ne "elim";

				next TIEBREAK 
					if $tb->count eq "prelim" 
					&& (
						$round->type ne "prelim" 
						&& $round->type ne "highlow"
						&& $round->type ne "highhigh"
					);

			}

			foreach my $tb ($tb->child->tiebreaks) { 

				$tb_types{"ranks"}++ if (
					$tb->name eq "ranks" 
					|| $tb->name eq "reciprocals"
				);

				$tb_types{"winloss"}++ if (
					$tb->name eq "opp_wins" 
					|| $tb->name eq "winloss" 
					|| $tb->name eq "ballots"
					|| $tb->name eq "losses"
				);

				$tb_types{"points"}++ if (
					$tb->name eq "points" 
					|| $tb->name eq "competition" 
					|| $tb->name eq "opp_points"
				);
				

			}

		}

    }

	my @blanks;

    my $subscores = $event_settings{"wsdc_categories"};

    my %max_subpoints = ();  
    my %min_subpoints = ();  

    my @scores = ("Style", "Content", "Strategy", "POI"); 
    
    foreach my $key (@scores) { 

        $min_subpoints{$key} = $event_settings{"min_".lc($key)."_points"};
        $max_subpoints{$key} = $event_settings{"max_".lc($key)."_points"}; 

        $min_subpoints{$key} = 0 unless $min_subpoints{$key};

        $min_subpoints{"total"} += $min_subpoints{$key} unless $key eq "POI";
        $max_subpoints{"total"} += $max_subpoints{$key} unless $key eq "POI";

    }    

    my $trash = pop @scores unless $max_subpoints{"POI"};

	
</%init>

	<div class="menu">
	
		<div class="sidenote">

			<h4>Other functions</h4>

			<a href="/panel/schemat/show.mhtml?round_id=<% $round->id %>" class="blue block">
				View <% $round->realname %> Schematic 
			</a>
		
			<hr>
	
			<a href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				View/Edit Panel <% $panel->letter %>
			</a>

			<a href="/tabbing/entry/index.mhtml?timeslot_id=<% $round->timeslot->id %>" class="yellow block">
				Ballot Entry Screen
			</a>

		</div>

		<div class="sidenote bigger">

			<h4>Panel Bye</h4>
			<a 
				href="bye_switch.mhtml?panel_id=<% $panel->id %>" 
				class="<% $panel->bye ? "dkblue" : "yellow" %> block"
			>
				<% $panel->bye ? "Disable debate-wide bye" : "Enable debate-wide bye" %>
			</a>

			<h4 class="martop">On byes &amp; forfeits</h4>

			<p>
				If a debate-wide bye is enabled above in prelims, no judges
				will be scheduled, all debaters in the debate will get a win
				and averaged points.  In elims, a debate-wide bye indicates a
				coach/walkover round between teammates; the win should be
				awarded there to the advancing team.  Disable it by clicking
				above to hold an actual debate.
			</p>

			<p>
				Do not enter a win/loss when also entering a forfeit or a bye.
			</p>

			<p>
				For missed scheduled debates, award byes and forfeits on their
				ballots.  A bye given to one or both debaters will count as a
				won debate.  A forfeit/forfeit will count as a loss in the case
				of debate.  If speaker points are entered, <span class="inline
				strong"> even a zero,</span> those points will count;
				otherwise, the average of the entry's other points will be
				added in for this round
			</p>

			<p>
%				if ($round->tiebreak_set->setting("forfeits_never_break")) { 
					The "Noshows never advance" tiebreak_set_setting is
					enabled for the tiebreaker set used in this round.  Entries
					earning a forfeit will be excluded from clearing to elims
%				}
			</p>

		</div>

	</div>

	<div class="main">

		<div class="full nospace">

			<span class="quarter nospace">
				<h3>Force Edit</h3>
			</span>

			<span class="quarter nospace top rightalign">
				<h6 class='semibold bluetext'>
				<% $event->name %>
				</h6>
			</span>

			<span class="quarter top nospace rightalign">
				<h6 class='semibold'>
				<% $round->realname %>
				</h6>
			</span>

			<span class="quarter top nospace rightalign">
				<h6 class='semibold'>
				<span class="bluetext inline">
					Room:
				</span> 
				
				<% ($panel->room > 0 ) ? $panel->room->name : "NO ROOM" %>

%				if ($round->flighted > 1) { 
					Flight <% $panel->flight %>
%				}
				</h6>
			</span>
		</div>

<%perl>

		my $no_codes++ if $event->category->setting('no_codes');

		my @judges = $m->comp('/funclib/panel_judges.mas', panel => $panel);

		my @tabs;
		my %judge_mark;

		my $chair_mark = "*";
		$chair_mark = "Par: " if $event->type eq "congress";

		if (scalar @judges > 1) { 

			foreach my $judge (@judges) { 
				my $tab;
				$tab = $chair_mark if $judge->chair;
				$tab .= $judge->code." ".$judge->last;
				$judge_mark{$judge->id} = $tab;

				push @tabs, $judge->id;

				$default = $judge->id unless $default;
			}

</%perl>

			<& "/funclib/tabs.mas", 
				tabs      => \@tabs,
				default   => $default,
				tag_names => \%judge_mark,
				right     => 1
			&>

<%perl>

		}

		my $switch;
		my $notfirst;

		@judges = (0) unless @judges;

		foreach my $judge (sort {$a->code <=> $b->code} @judges) { 

</%perl>

%			unless ($judge) { 

				<h4><% $panel->bye ? "Bye Round" : "No judge assigned" %></h4>
				<div>

%			} else { 

%				next if $wudc &! $judge->chair;
%				undef $notfirst if $judge_id == $judge->id;

				<div 
					class = "<% $judge->id %> screens <% @tabs ? "hidden" : "" %> "
				>

				<span class="threequarters nospace">
					<h4>
						<% $wudc 
							? "Chair" 
							: ""
						%> Judge <% $judge->code ." ".$judge->first." ".$judge->last %>
						<% $event->type eq "congress"
							&& $judge->chair 
							? "(Parliamentarian)"
							: ""
						%>
					</h4>
				</span>
				<span 
					id = "<% $panel."-".$judge %>_buttonarea"
					class="quarter nospace rightalign"
				>
				</span>
%			}

			<& "/funclib/tablesorter.mas", 
				table     => $panel."-".$judge,
				nobuttons => 1
			&>

			<form 
				action = "panel_save.mhtml"
				method = "post"
			>

			<input 
				type="hidden" 
				name="panel_id" 
				value="<% $panel->id %>"
			>

			<input 
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge ? $judge->id : "" %>"
			>

			<input 
				type  = "hidden"
				name  = "panel_bye"
				value = "<% $panel->bye %>"
			>

			<table id="<% $panel."-".$judge %>">

				<thead>

				<tr class="yellowrow">

					<th class="smaller centeralign">
						Confirmed
						<input 
							id      = "judgeswitch_<% $judge %>"
							type    = "checkbox"
							value   = "1"
							onclick = "confirmAll(this, 'audit_<% $judge %>');"
						>
					</th>

%					if ($wudc) { 
						<th class="smallish">
							Pos
						</th>
%					} elsif ($studpoints) { 
						<th class="smallish">
							S
						</th>
%					} elsif ($event->type eq "speech") {
						<th class="smallish">
							Order
						</th>
%					} 

					<th class="smallish">
						Code
					</th>
					<th class="smallish">
						Name
					</th>


%					if ($tb_types{"winloss"}) { 
						<th class="smallish">
							W	
						</th>
%					}

%					if ($tb_types{"ranks"}) { 
						<th class="smallish">
							<span class="<% $wsdc ? "quarter" : "half" %> centeralign">
							</span>

							<span class="<% $wsdc ? "quarter" : "half" %> centeralign">
								Rank
							</span>

						</th>
%					}

%					if ($tb_types{"points"}) { 

						<th class="smallish nosort">

							<span class="<% $wsdc ? "quarter" : "half" %> centeralign">
							</span>

							<span class="<% $wsdc ? "quarter" : "half" %> centeralign">
								Points
							</span>

%							if ($wsdc) { 
								<span class="quarter centeralign">
									Speech
								</span>

								<span class="quarter centeralign">
									Reply
								</span>
%							}
						</th>
%					}

%              		if ($round->tiebreak_set->setting("mfl_time_violation") > 0) {
						<th class="smallish">
							Overtime
						</th>
%					}


%					if ($event->type ne "congress" &&  $event->type ne "speech") { 
						<th class="smallish centeralign">
							Bye (W)
						</th>

						<th class="smallish centeralign">
							FFT (L)
						</th>
%					} elsif ($round->tiebreak_set->setting("forfeits_never_break") > 0) {
						<th class="smallish centeralign">
							Noshow
						</th>
%					}

				</tr>

				</thead>

<%perl>

				my $rfd;
				my %student_categories;
				my %entry_students;
				my @category_students;

				my %student_ranks = ();
				my %student_points = ();
				my %student_position = ();

				my %comment;
				my %subpoint;
				my %entry_title;

				my @all_ballots;
				
				my @entries = $m->comp('/funclib/panel_entries.mas', panel => $panel);

				@entries = sort {$a->side cmp $b->side} @entries;

				$m->print('</tbody>');

				foreach my $entry (@entries) { 

					my @ballots = Tab::Ballot->search( 
						judge => $judge->id,
						entry => $entry->id,
						panel => $panel->id
					) if $judge;

					@ballots = Tab::Ballot->search( 
						entry => $entry->id, 
						panel => $panel->id 
					) unless $judge;

					next unless @ballots;

					push @all_ballots, @ballots;

					my $ballot = shift @ballots;

					my $win;
					my $rank;
					my $points;

					foreach my $score ($ballot->scores) {

						if ($score->tag eq "") { 

							$score->tag("points") if $score->tiebreak == 3;
							$score->tag("ballot") if $score->tiebreak == 2;
							$score->tag("rank") if $score->tiebreak == 1;

							my $return;

							eval{ $score->update; };

							my $id = $score->id;
							undef $score;

							$score = Tab::Score->retrieve($id);
							$score->delete if $score->tag eq "";

						}
					}

					VALUE:
					foreach my $score ($ballot->scores) {

						if ($score->tag eq "rfd") { 

							$rfd = $score;

						} elsif ($score->tag eq "categories") { 

							if ($score->student > 0)  { 

								$student_categories{$score->student->id}{"name"} 
									= $score->student->first." ".$score->student->last;

								$student_categories{$score->student->id}{"entry"} 
									= $score->ballot->entry->code;

								my $content = $score->content;

								$content =~ s/, ,/,/g;
								$content =~ s/,$//;

								$content =~ s/,\n/\n/g;
								$content =~ s/\n /\n/g;
								$content =~ s/\n\n/\n/g;
								$content =~ s/\r\r/\n/g;

								$student_categories{$score->student->id}{"scores"} 
									= $content;
							}

						} elsif ($score->tag eq "title") { 

							$entry_title{$entry->id} = $score;

						} elsif ($score->tag eq "comments") { 
							$comment{$ballot->id} = $score;

						} elsif ($score->tag eq "subpoints") { 
							$subpoint{$ballot->id} = $score;
					
						} elsif ($score->tag eq "ballot") { 

							$win = $score->value;

						} elsif ($score->tag eq "rank") { 

							$rank = $score->value;
							$student_ranks{$score->student->id} = $score->value 
								if $score->student;

						} elsif ($score->tag eq "points") { 

							$points = $score->value;

							$student_points{$score->student->id}{"points"} = $score->value 
								if $score->student;

							$student_position{$score->student->id} = $score->position if $wsdc;

						} elsif ($score->tag eq "rebuttal_points") { 

							$points = $score->value;

							$student_points{$score->student->id}{"rebuttal"} = $score->value 
								if $score->student;

						} elsif (substr($score->tag,0,9) eq "subpoints") { 

							$student_points{$score->student->id}{"subpoints"}{$score->content} 
								= $score->value if $score->student;

						} else { 

							push @blanks, $score unless $score->tag;

						}
					}

					@{$entry_students{$entry->id}} = $entry->students;

					Tab::Student->set_sql(by_panel => "
						select distinct student.*
						from student, score, ballot
						where ballot.panel = ?
						and ballot.id = score.ballot
						and score.student = student.id
						and ballot.entry = ? 
					");

					push @{$entry_students{$entry->id}}, 
						Tab::Student->search_by_panel($panel->id, $entry->id);

					my %seen = (); 
					@{$entry_students{$entry->id}} = 
						grep { ! $seen{$_->id} ++ } 
						@{$entry_students{$entry->id}};

</%perl>
                    	
					<tr class="row">

						<td class="centeralign nospace">

							<label for="audit_<% $ballot->id %>">
								<div class="padmuchmore full hover">
									<input 
										type  = "checkbox"
										class = "audit_<% $judge %>"
										id    = "audit_<% $ballot->id %>"
										name  = "audit_<% $ballot->id %>"
										value = "1"
										<% $ballot->audit ? 'checked="checked"' : "" %>
									>
								</div>
							</label>
						</td>

%						if ($wudc) { 
							<td class="smallish centeralign">
                                <% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
                                <% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
                                <% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
                                <% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>
							</td>
%						} elsif ($studpoints) { 
							<td class="smallish centeralign">
								<% $ballot->side == 1 ? $aff_string : "" %>
								<% $ballot->side == 2 ? $neg_string : "" %>
							</td>
%						} elsif ($event->type eq "speech") {
							<td class="smallish centeralign">
								<% $ballot->speakerorder %>
							</td>
%						} 

						<td>
							<a 
								href     = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
								class    = "white"
								tabindex = "-1"
							>
								<% $entry->code %>
							</a>
						</td>

						<td>
							<span class="hidden"><% $entry->lastname %></span>
							<a 
								href     = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
								class    = "white"
								tabindex = "-1"
							>
								<% $entry->name %>
							</a>
						</td>

%						if ($tb_types{"winloss"} && $wudc) { 

							<td class="centeralign">
								<input 
									type  = "checkbox"
									name  = "<% $entry->id %>_winloss"
									value = "1"
									<% $win ? "checked" : "" %>
								>
							</td>

%						} elsif ($tb_types{"winloss"}) { 

							<td class="centeralign padno">

								<label for="winner_<% $entry->id %>">
									<div class="padmuchmore full hover">
										<input 
											type  = "radio"
											id    = "winner_<% $entry->id %>"
											name  = "winloss"
											value = "<% $entry->id %>"
											<% $win ? 'checked="checked"' : "" %>
										>
									</div>
								</label>

							</td>

%						}

%						if ($tb_types{"ranks"} && $studpoints && not defined $wudc) { 

							<td class="nowrap nospace">

%								foreach my $student (@{$entry_students{$entry->id}}) { 

									<div>

										<span class="half smallish">
											<% substr($student->first,0,1)%> <% $student->last %>
										</span> 

										<span class="half nospace">
											<input 
												type  = "number"
												class = "smaller"
												name  = "ranks_<% $student->id %>"
												step  = "<% $step %>"
												size  = "6"
												value = "<% $student_ranks{$student->id} %>"
												min   = "<% $min %>"
												max   = "<% $max %>"
											>
										</span>

									</div>

%								}

							</td>

%						} elsif ($tb_types{"ranks"})  { 

							<td class="nowrap centeralign nospace">

								<span class="hidden"><% $rank %></span>

								<input 
									type  = "number"
									class = "smaller"
									name  = "rank_<% $ballot->id %>"
									size  = "4"
									step  = "<% $step %>"
									value = "<% $rank %>"
									min   = "<% $min %>"
									max   = "<% $max %>"
								>
							</td>
%						} 

%						if ($tb_types{"points"}) { 

							<td class="nowrap centeralign nospace">

%								if ($studpoints) { 

%									foreach my $student (@{$entry_students{$entry->id}}) { 

										<div class="nospace">

											<span class="<% $wsdc ? "quarter" : "twofifths" %> smallish">
												<% substr($student->first,0,1)%> <% $student->last %>
											</span>

											<span class="<% $wsdc ? "quarter" : "threefifths rightalign" %> nospace">
												<input 
													type  = "number"
													class = "thin"
													name  = "points_<% $student->id %>"
													size  = "4"
													value = "<% $student_points{$student->id}{"points"} %>"
													step  = "<% $step %>"
													min   = "<% $min %>"
													max   = "<% $max %>"
												>
											</span>

%											if ($wsdc) {

												<span class="quarter">
													<input 
														type  = "number"
														class = "smaller"
														name  = "position_<% $student->id %>"
														size  = "4"
														value = "<% $student_position{$student->id} %>"
														step  = "1"
														max   = "3"
													>
												</span>

												<span class="quarter">
													<input 
														type  = "number"
														class = "smaller"
														name  = "rebuttal_points_<% $student->id %>"
														size  = "4"
														step  = "<% $step %>"
														value = "<% $student_points{$student->id}{"rebuttal"} %>"
														min   = "<% $min %>"
														max   = "<% $max %>"
													>
												</span>
%											}

										</div>
%									}
%								} else { 

									<span class="hidden"><% $points %></span>

									<input 
										type  = "number"
										class = "smaller"
										name  = "points_<% $ballot->id %>"
										size  = "4"
										step  = "<% $step %>"
										value = "<% $points %>"
										min   = "<% $min %>"
										max   = "<% $max %>"
									>
%								} 
							</td>
%						} 

%                  		if ($round->tiebreak_set->setting("mfl_time_violation") > 0) {

							<td class="centeralign">
								<input 
									type  = "checkbox"
									name  = "tv_<% $ballot->id %>"
									value = "1"
									<% ($ballot->tv) ? "checked" : "" %>
								>
							</td>
%						}

%						if ($event->type ne "congress" &&  $event->type ne "speech") { 

							<td class="centeralign nospace">

								<label for="bye_<% $ballot->id %>">
									<div class="full hover">
										<input 
											type  = "checkbox"
											name  = "bye_<% $ballot->id %>"
											id    = "bye_<% $ballot->id %>"
											value = "1"
											<% ($ballot->bye > 0) ? 'checked="checked"' : "" %>
										>
									</div>
								</label>

							</td>

							<td class="centeralign nospace">

								<label for="forfeit_<% $ballot->id %>">

									<div class="full hover">

										<input 
											type  = "checkbox"
											name  = "forfeit_<% $ballot->id %>"
											id    = "forfeit_<% $ballot->id %>"
											value = "1"
											<% ($ballot->forfeit > 0) ? "checked" : "" %>
										>

									</div>

								</label>

							</td>

%						} elsif ($round->tiebreak_set->setting("forfeits_never_break") > 0) {

							<td class="centeralign">

								<input 
									type  = "checkbox"
									name  = "forfeit_<% $ballot->id %>"
									value = "1"
									<% ($ballot->forfeit) ? "checked" : "" %>
								>
							</td>
%						}

					</tr>

%				}

				</tbody>

				<tr class="liblrow">
					<td
						colspan = "10"
						class   = "rightalign"
					>
						<input 
							type  = "submit"
							value = "Save Changes"
						>
						</form>
					</td>
				</tr>

			</table>


			<form 
				action = "panel_extras_save.mhtml"
				method = "post"
			>

			<input 
				type="hidden" 
				name="panel_id" 
				value="<% $panel->id %>"
			>

			<input 
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge ? $judge->id : "" %>"
			>

%			if ($subscores || keys %student_categories) { 
				<h5>Category subscores</h5>

%			if ($subscores) { 

%				foreach my $entry (@entries) { 

					<h6><% $entry->code %> <% $entry->name %></h6>

%					foreach my $student (@{$entry_students{$entry->id}}) { 

						<div class="padmore row">

							<div class="quarter">
								<% $student->first." ".$student->last %>
							</div>

							<div class="threequarters">
%							foreach my $subscore (@scores) { 

								<div class="quarter border">
									<% ucfirst($subscore) %>:
									<% $student_points{$student->id}{"subpoints"}{lc($subscore)} %>
								</div>
%							} 

							</div>

						</div>

%					}

%				}

%			} else { 


%				foreach my $entry (@entries) { 

					<span class="pagehalf">
						<h6><% $entry->code %></h6>

%						foreach my $student (@{$entry_students{$entry->id}}) { 

							<div class="padmore row">

								<div class="marno padless">
									<% $student->first." ".$student->last %>
								</div>

								<div class="marno padless">
									<textarea
										name  = "subscores_<% $student->id %>"
										rows  = "1"
										cols  = "56"
									><% $student_categories{$student->id}{"scores"} %></textarea>
								</div>
							</div>

%						}

					</span>

%				}

				<div class="libl row rightalign padvert marright marleft">
					<input type="submit" value="Save Details">
				</div>
%			}
%			} 


			<& "/funclib/editor.mas", half => 1 &>

%			if ($tourn_settings->{'legion'}) { 

%				foreach my $ballot (@all_ballots) { 
				
					<h5>Subpoints for <% $ballot->entry->code %> <% $ballot->entry->name %></h5>

					<div class="padmore row centeralign">

						<textarea
							name  = "subpoints_<% $ballot->id %>"
							rows  = "10"
							cols  = "84"
							class = "nyah"
						><% $subpoint{$ballot->id} 	
							? $subpoint{$ballot->id}->content 
							: ""
						%></textarea>

					</div>

%				}

%			} else { 

				<h5>RFD</h5>

				<div class="padmore row centeralign">

					<textarea
						name  = "rfd"
						rows  = "10"
						cols  = "84"
						class = "full"

					><% $rfd ? $rfd->content : "" %></textarea>
				</div>
%			} 

%			foreach my $ballot (@all_ballots) { 

				<h5>Comments for <% $ballot->entry->code %> <% $ballot->entry->name %></h5>

				<div class="padmore row centeralign">

					<textarea
						name  = "comments_<% $ballot->id %>"
						rows  = "10"
						cols  = "84"
						class = "full"
					><% $comment{$ballot->id} 	
						? $comment{$ballot->id}->content 
						: ""
					%></textarea>

				</div>
%			}

			<div class="libl row full rightalign">
				<input 
					type  = "submit"
					value = "Save Ballot Edits"
				>
				</form>
			</div>

			</div>

%		}	

%		if (@blanks) { 

			<h3>Warning: Blank Scores Detected</h3>

			<form action="blanks_correct.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<p>
				There's an ongoing issue with ballots where scores will not be
				saved with their type.  It'll look like a ballot was entered
				without any results.  It's annoying me to no end and I can't
				figure out where it's happening.  So in the interim I give you
				a way to fix it after the fact.  Enter the score type
				below:
			</p>

%			foreach my $score (@blanks) { 

				<div class="row full marno padless">

					<span class="twofifth smallish">

						<div class="full padno">
							<% $score->ballot->entry->code %>
							<% $score->student->id ? "/".$score->student->last : "" %>
						</div>

						<div class="full nospace">
							<% $score->ballot->judge->last %>
						</div>

					</span>

					<span class="fifth">
						Score: 	<% $score->value %>
					</span>
<%perl>
					my $default = "rank";

					$default = "winloss" 
						if $tb_types{"winloss"} 
						&& ($score->value < 2) 
						&! $score->student;

					$default = "points" 
						if $tb_types{"points"} 
						&& $score->value > 10 
						&& $score->student;
</%perl>

					<span class="twofifth nospace">

						<label for="ballot_<% $score->id %>">
							<span class="third hover padtop padbottom">
								<input 
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "ballot_<% $score->id %>"
									value = "ballot"
									<% $default eq "winloss" ? 'checked="checked"' : "" %> 
								>Win/Loss
							</span>
						</label>

						<label for="rank_<% $score->id %>">
							<span class="third hover padtop padbottom">
								<input 
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "rank_<% $score->id %>"
									value = "rank"
									<% $default eq "rank" ? 'checked="checked"' : "" %> 
								>Rank
							</span>
						</label>

						<label for="points_<% $score->id %>">
							<span class="third hover padtop padbottom">
								<input 
									type  = "radio"
									name  = "<% $score->id %>"
									id    = "points_<% $score->id %>"
									value = "points"
									<% $default eq "points" ? 'checked="checked"' : "" %> 
								>Points
							</span>
						</label>
					</span>

				</div>

%			}

			<div class="libl rightalign full">
				<input 
					type  = "submit"
					value = "Save Score Labels"
				>
				</form>
			</div>

%		}

%		if ($wudc) { 
	
			<h5>Panelists:
%			foreach my $judge (sort {$a->code <=> $b->code} @judges) { 
%				next if $judge->chair;
				<% $judge->first." ".$judge->last %>
%			}	
			</h5>
%		}

	</div> 

