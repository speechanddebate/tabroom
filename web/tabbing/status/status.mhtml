<%args>
	$tourn
	$perms
	$session
	$person
	$timeslot_id   => undef
	$check_all     => undef
	$category_id   => undef
	$entry_only    => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	$timeslot = $tourn->timeslots->first unless $timeslot;

	$m->abort unless $timeslot;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas",
		tourn => $tourn,
		perms => $perms
	);

	my @events = @{$eventref};
	my @categories = @{$catref};

	if ($category_id) {
		$session->category($category_id);
		$session->update;
	}

	my $session_category = $session->category;

    if ($session_category && $session_category->tourn != $tourn) {
        $session->category("");
        $session->update;
        undef $session_category;
    }

    unless ($session_category) {
      	$session_category = $categories[0];
        $session->category($session_category->id) if $session_category;
        $session->update;
    }

	unless ($session_category) {
		$m->print("Your tournament has no judging groups, and cannot run like this.  Please start from the Setup menu to proceed");
		$m->abort;
	}

</%init>

	<div class="menu">

		<div class="sidenote">

%			if ($entry_only) {
				<a href="/tabbing/entry/index.mhtml" class="yellow full">Return to Ballot Entry</a>
				<br />
%			}

%			unless ($only_category) {

			<span
				class = "bluenohover full centeralign"
				style = "margin-bottom: 2px;"
			>

				<form action="status.mhtml" method="post">

				<select
					name     = "category_id"
					onchange = 'this.form.submit()'
					class    = "chosen fixedmed notfirst"
				>

					<option value="">Choose judge category:</option>

%					foreach my $other_category (@categories) {
						<option
							value="<% $other_category->id %>"
								<% ($session_category
									&& $other_category->id == $session_category->id)
									? "selected"
									: ""
							%>><% $other_category->name %> </option>
%					}
				</select>
				</form>
			</span>
%			}

			<h4>Timeslots:</h4>
<%perl>

				my @timeslots = $m->comp(
					"/funclib/category_timeslots.mas",
					category => $session_category,
					events   => \@events
				);

				foreach my $ts (@timeslots) {

					my @undone = $m->comp(
						'/funclib/timeslot_judges.mas',
						timeslot => $ts,
						status => "full"
					);

					push @undone, $m->comp(
						'/funclib/timeslot_judges.mas',
						timeslot => $ts,
						status   => "half"
					);

					$timeslot = $ts if @undone && not defined $timeslot;
					$timeslot_id = $timeslot->id if $timeslot;

</%perl>

					<a
						href="status.mhtml?timeslot_id=<% $ts->id %>"
						class="<%
							$ts->id == $timeslot_id ? "dk" : ""
							%><%
								@undone ? "yellow" : "green"
							%> full martop"
						>

						<span class="half ">
							<% $ts->name %>
						</span>

						<span class="quarter  rightalign">
							<% scalar @undone %>
						</span>

						<span class="quarter  padleft">
							left
						</span>

					</a>

%				}

%			$timeslot = $timeslots[0] unless $timeslot;
%			$timeslot_id = $timeslot->id if $timeslot;

		</div>

	</div>

<%perl>

	my $max_flight;
	if ($timeslot) {
		foreach my $round ($timeslot->rounds) {
			$max_flight = $round->flighted if $max_flight < $round->flighted;
		}
	}

	my @panels = $m->comp(
		'/funclib/timeslot_panels.mas',
		timeslot => $timeslot
	) if $timeslot;

	my %panels_by_id =();

	foreach my $panel (@panels) {
		$panels_by_id{$panel->id} = $panel;
	}

</%perl>

	<div class="main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas",
			whoami => 'status',
			tourn  => $tourn
		&>

		<span class="half nospace">
			<h4>Results Entry Status</h4>
		</span>

		<span class="half rightalign nospace">
			<h4><% $timeslot->name %></h4>
		</span>

%		foreach my $flight (1 .. $max_flight) {

			<div class="half top">

<%perl>

				my @unranked = $m->comp(
					'/funclib/timeslot_judges.mas',
					timeslot => $timeslot,
					status   => "full",
					flight   => $flight
				);

				my @unaudited = $m->comp(
					'/funclib/timeslot_judges.mas',
					timeslot => $timeslot,
					status   => "half",
					flight   => $flight
				);

</%perl>

				<h5 class="bluetext centeralign">
					<% scalar @unranked %> Unentered
					<% $max_flight > 1 ? "Flt $flight" : "" %>
				</h5>

% 				foreach my $judge (@unranked) {

                    <div class="nospace">
                        <a class="smallish full yellow"
							href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>">
                            <span class="third nowrap marno">
								<% $panels_by_id{$judge->panelid}
									&& $panels_by_id{$judge->panelid}->room
									?  $panels_by_id{$judge->panelid}->room->name
									: "" %>
                            </span>

                            <span class="third padleft nowrap marno">
								<% $judge->last %>, <% $judge->first %>
                            </span>
                            <span class="third padleft nowrap marno">
								<% $max_flight > 1
									&& $panels_by_id{$judge->panelid}
									? "Flt ".$panels_by_id{$judge->panelid}->flight
									: ""
								%>
								<% $panels_by_id{$judge->panelid}
									? $panels_by_id{$judge->panelid}->round->event->abbr
									: ""
								%>
                            </span>
                        </a>
                    </div>

%				}
			</div>

			<div class="half top">

				<h5 class="bluetext centeralign">
					<% scalar @unaudited %> Unconfirmed <% $max_flight > 1 ? "Flt $flight" : "" %>
				</h5>

% 				foreach my $judge (@unaudited) {

                    <div class="nospace">

                        <a
							class="smallish full yellow"
							href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>"
						>

                            <span class="third padleft marno nowrap">
								<% $panels_by_id{$judge->panelid}
									&& $panels_by_id{$judge->panelid}->room
									?  $panels_by_id{$judge->panelid}->room->name
									: ""
								%>
                            </span>

                            <span class="third padleft nowrap marno">
								<% $judge->last %>, <% $judge->first %>
                            </span>

                            <span class="third nowrap rightalign marno">
								<% $max_flight > 1 && $panels_by_id{$judge->panelid}
									? "Flt ".$panels_by_id{$judge->panelid}->flight
									: ""
								%>
								<% $panels_by_id{$judge->panelid}
									? $panels_by_id{$judge->panelid}->round->event->abbr
									: ""
								%>
                            </span>
                        </a>
                    </div>

%				}

			</div>

%		}
	</div>

