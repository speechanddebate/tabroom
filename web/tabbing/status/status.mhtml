<%args>
	$tourn
	$tourn_settings
	$perms
	$session
	$person
	$defaults      => undef
	$timeslot_id   => undef
	$check_all     => undef
	$category_id   => undef
	$entry_only    => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	$timeslot = $tourn->timeslots->first unless $timeslot;

	$m->abort unless $timeslot;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas",
		tourn => $tourn,
		perms => $perms
	);

	my %cats = map {$_->id => $_} @{$catref};
	my %evs = map {$_->id => $_} @{$eventref};

	my $event;
	my $category;

	if ($ARGS{event_id} && $evs{$ARGS{"event_id"}}) {
		$event = $evs{$ARGS{"event_id"}};
	} elsif ($defaults->{event} && $evs{$defaults->{event}}) {
		$event = $evs{$defaults->{event}};
	} elsif (scalar @{$eventref} == 1) {
		$defaults->{event} = int(${$eventref}[0]);
		$event = ${$eventref}[0];
	}

	if ($ARGS{category_id} && $cats{$ARGS{"category_id"}}) {
		$category = $cats{$ARGS{"category_id"}};
		$defaults->{category} = $ARGS{"category_id"};
	} elsif ($defaults->{category} && $cats{$defaults->{category}}) {
		$category = $cats{$defaults->{category}};
	} elsif (scalar @{$catref} == 1) {
		$category = ${$catref}[0];
	}

	if ($category && (not defined $event) && scalar ($category->events) == 1) {
		$event = $category->events->first;
		$defaults->{event} = $event->id;
	}

	$session->default($defaults);

</%init>

	<div class="menu">

		<div class="sidenote">

%			if ($entry_only) {
				<a href="/tabbing/entry/index.mhtml" class="yellow full">Return to Ballot Entry</a>
				<br />
%			}

%			unless ($only_category) {
				<span
					class = "bluenohover full centeralign"
					style = "margin-bottom: 2px;"
				>

					<form action="status.mhtml" method="post">

					<select
						name     = "category_id"
						onchange = 'this.form.submit()'
						class    = "chosen fixedmed notfirst"
					>

						<option value="">Choose judge category:</option>

%						foreach my $other_category (@{$catref}) {
							<option
								value="<% $other_category->id %>"
									<% ($category
										&& $other_category->id == $category->id)
										? "selected"
										: ""
								%>><% $other_category->name %> </option>
%						}
					</select>
					</form>
				</span>
%			}

			<h4>Timeslots</h4>
<%perl>

				my @timeslots = $m->comp(
					"/funclib/category_timeslots.mas",
					category => $category,
					events   => $eventref
				);

				foreach my $ts (@timeslots) {

					my @undone = $m->comp(
						'/funclib/timeslot_judges.mas',
						timeslot => $ts,
						events   => $eventref,
						status   => "full"
					);

					push @undone, $m->comp(
						'/funclib/timeslot_judges.mas',
						timeslot => $ts,
						events   => $eventref,
						status   => "half"
					);

					$timeslot = $ts if @undone && not defined $timeslot;
					$timeslot_id = $timeslot->id if $timeslot;
</%perl>
					<a
						href="status.mhtml?timeslot_id=<% $ts->id %>&category_id=<% $category_id %>"
						class="<%
							$ts->id == $timeslot_id ? "dk" : ""
							%><%
								@undone ? "yellow" : "green"
							%> full martop"
						>

						<span class="half ">
							<% $ts->name %>
						</span>

						<span class="quarter  rightalign">
							<% scalar @undone %>
						</span>

						<span class="quarter  padleft">
							left
						</span>

					</a>

%				}

%			$timeslot = $timeslots[0] unless $timeslot;
%			$timeslot_id = $timeslot->id if $timeslot;

		</div>

	</div>

<%perl>

	my $max_flight;
	if ($timeslot) {
		foreach my $round ($timeslot->rounds) {
			$max_flight = $round->flighted if $max_flight < $round->flighted;
		}
	}

	my @panels = $m->comp(
		'/funclib/timeslot_panels.mas',
		timeslot => $timeslot
	) if $timeslot;

	my %panels_by_id =();

	foreach my $panel (@panels) {
		$panels_by_id{$panel->id} = $panel;
	}

</%perl>

	<div class="main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas",
			whoami         => 'status',
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>

		<span class="half nospace">
			<h4>Results Entry Status</h4>
		</span>

		<span class="half rightalign nospace">
			<h4><% $timeslot->name %></h4>
		</span>

%		foreach my $flight (1 .. $max_flight) {

			<div class="half top">

<%perl>

				my @unranked = $m->comp(
					'/funclib/timeslot_judges.mas',
					timeslot => $timeslot,
					status   => "full",
					events   => $eventref,
					flight   => $flight
				);

				my @unaudited = $m->comp(
					'/funclib/timeslot_judges.mas',
					timeslot => $timeslot,
					status   => "half",
					events   => $eventref,
					flight   => $flight
				);

</%perl>

%				if (@unranked) {
					<h5 class="bluetext centeralign">
						<% scalar @unranked %> Unentered
						<% $max_flight > 1 ? "Flt $flight" : "" %>
					</h5>
%				}

% 				foreach my $judge (@unranked) {

%					next unless $evs{$judge->eventid};

                    <div class="row nospace">
                        <a class="smallish full marno hover white padvert"
							href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>&flight=<% $flight %>">
                            <span class="third nowrap marno">
								<% $judge->panelletter %>
								<% $judge->roomname %>
                            </span>

                            <span class="third padleft nowrap marno">
								<% $judge->last %>, <% $judge->first %>
                            </span>
                            <span class="third padleft nowrap marno">
								<% $max_flight > 1
									&& $panels_by_id{$judge->panelid}
									? "Flt ".$panels_by_id{$judge->panelid}->flight
									: ""
								%>
								<% $judge->eventabbr %>
                            </span>
                        </a>
                    </div>

%				}
			</div>

			<div class="half top">

%				if (@unaudited) {
					<h5 class="bluetext centeralign">
						<% scalar @unaudited %> Unconfirmed <% $max_flight > 1 ? "Flt $flight" : "" %>
					</h5>
%				}

% 				foreach my $judge (@unaudited) {

%					next unless $evs{$judge->eventid};

                    <div class="nospace">

                        <a
							class="smallish full yellow"
							href="/tabbing/entry/index.mhtml?timeslot_id=<% $timeslot_id %>&judge_id=<% $judge->id %>&flight=<% $flight %>"
						>

                            <span class="third padleft marno nowrap">
								<% $judge->panelletter %>
								<% $judge->roomname %>
                            </span>

                            <span class="third padleft nowrap marno">
								<% $judge->last %>, <% $judge->first %>
                            </span>

                            <span class="third nowrap rightalign marno">
								<% $max_flight > 1 && $panels_by_id{$judge->panelid}
									? "Flt ".$panels_by_id{$judge->panelid}->flight
									: ""
								%>
								<% $judge->eventabbr %>
                            </span>
                        </a>
                    </div>

%				}

			</div>

%		}
	</div>

