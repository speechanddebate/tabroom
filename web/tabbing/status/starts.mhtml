<%args>
	$tourn
	$tourn_settings
	$perms
	$person
	$session
	$defaults      => undef
	$timeslot_id   => undef
	$category_id   => undef
	$entry_only    => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas",
		tourn => $tourn,
		perms => $perms
	);

	my %cats = map {$_->id => $_} @{$catref};
	my %evs = map {$_->id => $_} @{$eventref};
	my $category;

	if ($ARGS{category_id} && $cats{$ARGS{"category_id"}}) {
		$category = $cats{$ARGS{"category_id"}};
		$defaults->{category} = $ARGS{"category_id"};
	} elsif ($defaults->{category} && $cats{$defaults->{category}}) {
		$category = $cats{$defaults->{category}};
	} elsif (scalar @{$catref} == 1) {
		$category = ${$catref}[0];
	}

	unless (
		$defaults->{event}
		&& $evs{$defaults->{event}}
		&& ($evs{$defaults->{event}}->category == $category)
	) {
		delete $defaults->{event};
	}

	$session->default($defaults);

	if ($category && not defined $timeslot) {

		my $eventlimit;

		if ($eventref) {
			$eventlimit = " and event.id in (";
			my $notfirst;
			foreach my $eid (@{$eventref}) {
				if ($notfirst++) {
					$eventlimit .= ",";
				}
				$eventlimit .= $eid->id;
			}
			$eventlimit .= ")";
		}


		Tab::Timeslot->set_sql( earliest_unstarted => "

			select timeslot.*
			from timeslot, round, panel, ballot, event
			where event.category = ?
				and event.id = round.event
				and round.timeslot = timeslot.id
				and round.id = panel.round
				and panel.id = ballot.panel
				and (
					ballot.judge_started = '0000-00-00 00:00:00'
					or ballot.judge_started is NULL
				)
				and ballot.bye != 1
				and ballot.forfeit != 1
				and panel.bye != 1

				$eventlimit
			order by timeslot.start
			limit 1
		");

		$timeslot = Tab::Timeslot->search_earliest_unstarted($category->id)->first;

	}

</%init>

	<script>

		function statusCounter() {
			var unstarted = $("#unstarted_body").children().length;
			var started = $("#started_body").children().length;
			$("#unstarted_count").text(unstarted);
			$("#started_count").text(started);
		};

		$(document).ready(function() {
			statusCounter();
		});

	</script>

	<div class="menu">

		<div class="sidenote">

%			if ($entry_only) {
				<a
					href  = "/tabbing/entry/index.mhtml"
					class = "yellow full"
				>Return to Ballot Entry</a>
				<br />
%			}

%			unless ($only_category) {

				<span class="evenrow full marbottom centeralign">

					<form action="starts.mhtml" method="post">
					<input
						type  = "hidden"
						name  = "timeslot"
						value = "<% $timeslot ? $timeslot->id : "" %>"
					>

					<select
						name     = "category_id"
						onchange = 'this.form.submit()'
						class    = "chosen fixedmed notfirst"
					>
						<optgroup label="Choose judge category">

%						foreach my $other_category (sort {$a->name cmp $b->name} @{$catref}) {
							<option
								value="<% $other_category->id %>"
								<% ($category && $other_category->id == $category->id)
									? "selected"
									: ""
								%>><% $other_category->name %></option>
%						}


					</select>
					</form>
				</span>
%			}

			<h4>Timeslots:</h4>

<%perl>
				my @timeslots = $m->comp(
					"/funclib/category_timeslots.mas",
			  		category => $category,
					events   => $eventref
				);

				foreach my $ts (@timeslots) {

					my $unstarted_count = $m->comp(
						'/funclib/timeslot_ballots.mas',
						timeslot => $ts,
						style    => "unstarted",
						return   => "count",
						events   => $eventref,
						category => $category
					);

					my $started_count = $m->comp(
						'/funclib/timeslot_ballots.mas',
						timeslot => $ts,
						style    => "started",
						events   => $eventref,
						return   => "count",
						category => $category
					);

</%perl>

					<a href="starts.mhtml?timeslot_id=<% $ts->id %>&category_id=<% $category_id %>"
						class="<%
							$ts->id == $timeslot ? "dk" : ""
						%><%
							$unstarted_count ? "yellow" : "green"
						%> full martop"
					>

						<span class="half ">
							<% $ts->name %>
						</span>

						<span class="quarter  padleft">
							<% scalar $started_count %> OK
						</span>

						<span class="quarter  rightalign">
							<% $unstarted_count %> NOT
						</span>

					</a>

%				}
		</div>
	</div>

	<div class="main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas",
			whoami         => 'starts',
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>

%		if ($timeslot) {

			<h4 class="centeralign">
				Ballots started in timeslot <% $timeslot->name %>
			</h4>

			<p class="italic semibold redtext centeralign">
				Click a judge to move their round to the other column
			</p>
<%perl>

			my @unstarted = $m->comp(
				'/funclib/timeslot_ballots.mas',
				timeslot => $timeslot,
				style    => "unstarted",
				events   => $eventref,
				category => $category
			);

			my @started = $m->comp(
				'/funclib/timeslot_ballots.mas',
				timeslot => $timeslot,
				style    => "started",
				events   => $eventref,
				category => $category
			);

			my $max_flight;
			
			foreach my $ballot (@unstarted) {
				if ($max_flight < $ballot->flighted) {
					$max_flight = $ballot->flighted;
				}
			}

</%perl>
			<span class="pagehalf">

				<div class="full nospace semibold bigger">
					<span
						class="quarter"
						id="unstarted_count"
					></span>

					<span class="half">
						Ballots Not Started
					</span>

					<span class="quarter rightalign smallish"
						id="unstarted_buttonarea"
					> </span>

				</div>

				<& "/funclib/tablesorter.mas", table => "unstarted" &>

				<table id="unstarted">

					<thead>
						<tr class="yellowrow smallish">

%							if ($max_flight > 1) { 
								<th>
								</th>
%							}

							<th>
								Room
							</th>

%							if ($tourn_settings->{ncfl})  {
								<th>
									Code
								</th>
%							}

							<th>
								Judge
							</th>

							<th>
								Event
							</th>
						</tr>
					</thead>

					<tbody id="unstarted_body">

<%perl>
					my $last_flight = 1;

					foreach my $ballot (@unstarted) {

						next unless $evs{$ballot->eventid};

						my $flightswitch;

						if ($last_flight != $ballot->flight) {
							$last_flight = $ballot->flight;
							$flightswitch = "bordertop";
						}
</%perl>

						<tr
							class         = "hover countme <% $flightswitch %>"
							id            = "<% $ballot->id %>"
							target_id     = "<% $ballot->id %>"
							reply_target  = "<% $ballot->id %>_status"
%							unless ($ballot->online_mode && $ballot->online_mode ne "async") {
								onClick       = 'postSwitch(this, "start_switch.mhtml", statusCounter);'
%							}
						>

%							if ($max_flight > 1) { 
								<td
%									if ($ballot->online_mode && $ballot->online_mode ne "async") {
										onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%									}
								>
									<% $ballot->flighted > 1 ? "Fl".$ballot->flight : ""%>
								</td>
%							}

%							if ($ballot->online_mode && $ballot->online_mode eq "sync") {
								<td class="padverthalfless centeralign">

									<div class="half centeralign smallish nospace">
										<% $ballot->roomname %>
									</div>

									<div class="fourtenths centeralign smallish nospace">
										<& "/funclib/online_room.mas",
											panel => $ballot->panelid,
											person => $person,
											class => "fa-tiny full"
										&>
									</div>
								</td>
%							} elsif ($ballot->online_mode && $ballot->online_mode ne "async") {
								<td class="padverthalfless centeralign">
									<& "/funclib/online_room.mas",
										panel => $ballot->panelid,
										person => $person,
										class => "fa-tiny full"
									&>
								</td>

%							} else {
								<td class="padverthalfless centeralign">
									<% $ballot->roomname %>
								</td>
%							}

%							if ($tourn_settings->{ncfl})  {
								<td
%									if ($ballot->online_mode && $ballot->online_mode ne "async") {
										onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%									}
								>
									<% $ballot->code %>
								</td>
%							}
							<td
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
								class="smallish"
							>
								<% $ballot->lastname.", ".$ballot->firstname %>
							</td>

							<td
								class = "centeralign smallish"
								id    = "<% $ballot->id %>_status"
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
							>
								<% $ballot->eventabbr %>
							</td>

						</tr>

%					}

					</tbody>
				</table>
			</span>

			<span class="pagehalf">
				<div class="full nospace semibold bigger">

					<span
						class="quarter"
						id="started_count"
					></span>

					<span class="half">
						Ballots Started
					</span>

					<span class="quarter rightalign smallish"
						id="started_buttonarea"
					>
					</span>
				</div>

				<& "/funclib/tablesorter.mas",
					table => "started"
				&>

				<table id="started">

					<thead>
						<tr class="yellowrow smallish">

%							if ($max_flight > 1) { 
								<th>
								</th>
%							}

							<th>
								Room
							</th>

%							if ($tourn_settings->{ncfl})  {
								<th>
									Code
								</th>
%							}

							<th>
								Judge
							</th>

							<th>
								Started
							</th>

							<th>
								By
							</th>
						</tr>
					</thead>

					<tbody id="started_body">
<%perl>

					foreach my $ballot ( sort {$b->flight <=> $a->flight} @started) {

						next unless $evs{$ballot->eventid};

						my $flightswitch;

						if ($last_flight != $ballot->flight) {
							$last_flight = $ballot->flight;
							$flightswitch = "bordertop";
						}
</%perl>

						<tr
							class         = "hover countme <% $flightswitch %>"
							id            = "<% $ballot->id %>"
							target_id     = "<% $ballot->id %>"
							reply_target  = "<% $ballot->id %>_status"
%							unless ($ballot->online_mode && $ballot->online_mode ne "async") {
								onClick       = 'postSwitch(this, "start_switch.mhtml", statusCounter);'
%							}
						>

%							if ($max_flight > 1) { 
								<td
%									if ($ballot->online_mode && $ballot->online_mode ne "async") {
										onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%									}
								>
									<% $ballot->flighted > 1 ? "F".$ballot->flight : ""%>
								</td>
%							}

%							if ($ballot->online_mode && $ballot->online_mode eq "sync") {
								<td class="padverthalfless centeralign">
									<div class="half centeralign smallish nospace">
										<% $ballot->roomname %>
									</div>

									<div class="fourtenths centeralign smallish nospace">
										<& "/funclib/online_room.mas",
											panel => $ballot->panelid,
											person => $person,
											class => "fa-tiny full"
										&>
									</div>
								</td>
%							} elsif ($ballot->online_mode && $ballot->online_mode ne "async") {
								<td class="padverthalfless centeralign">
									<& "/funclib/online_room.mas",
										panel => $ballot->panelid,
										person => $person,
										class => "fa-tiny full"
									&>
								</td>
%							} else {
								<td class="padverthalfless centeralign">
									<% $ballot->roomname %>
								</td>
%							}

%							if ($tourn_settings->{ncfl})  {
								<td
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
								>
									<% $ballot->code %>
								</td>
%							}
							<td
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
								class="smallish"
							>
								<% $ballot->lastname.", ".$ballot->firstname %>
							</td>

							<td
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
								id="<% $ballot->id %>_status"
								class="smallish rightalign"
							>
								<% 	Tab::nicetime(
										Tab::DBI::date_inflate($ballot->starttime)->set_time_zone($tz)
									)
								%>
							</td>

							<td
								class="centeralign smallish nospace"
%								if ($ballot->online_mode && $ballot->online_mode ne "async") {
									onClick = 'postSwitch($(this).parent(), "start_switch.mhtml", statusCounter);'
%								}
							>
								<span class="nospace full centeralign yellowhover padvert" title="<% $ballot->started_by %>">
									<% substr($ballot->started_byf, 0, 1).substr($ballot->started_byl, 0, 1) %>
								</span>
							</td>

						</tr>

%					}

					</tbody>

				</table>

			</span>

%		}

	</div>

