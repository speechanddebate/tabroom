<%args>
	$import_file => undef
	$tourn
	$event_id => undef
	$err => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	if ($event && $import_file) { 

		unless ($event->tournament->id == $tourn->id) { 
			$m->print("<p class=\"err\">That event is not part of your tournament.  Fail.</p>");
			$m->abort();
		}

		my $req = Apache2::Request->new($r);
		my $upload = $req->upload("import_file");
		my $upload_fh = $upload->fh;
		my %results_by_compcode = ();
		my %wins_by_compcode = ();
		my %losses_by_compcode = ();

		my $total_wins;
		my $total_losses;

		# Fix line breaks
		while (<$upload_fh>) {
			s/\015\012?|\r\n?|\012|\n|\015/\n/g;
			s/\n\s?\n\s?\n\s?/\n/g;

			my ($code, $wins, $losses) = split (/,/, $_);
			my $points = ($wins * 5) + ($losses * 2);
			$results_by_compcode{$code} = $points;
			$wins_by_compcode{$code} = $wins;
			$losses_by_compcode{$code} = $losses;

			$total_wins += $wins;
			$total_losses += $losses;

			$err .= "<p class=\"err\">ERROR: $code has more than 26 ballots. $wins/$losses. FAIL.</p>\n" 
				if ($losses + $wins) > 26;
		}

		my @comps = sort {$results_by_compcode{$b->code} <=> $results_by_compcode{$a->code}} 
												$event->comps(dropped => 0, waitlist => 0);

		my $total_points;

		foreach my $comp (@comps) { 
			$comp->sweeps_points($results_by_compcode{$comp->code});
			$comp->wins($wins_by_compcode{$comp->code});
			$comp->losses($losses_by_compcode{$comp->code});
			$total_points += $results_by_compcode{$comp->code};
			$comp->update if $total_points;
		}

</%init>

%	unless ($total_points) { 
		<p class="err">No points were recorded.  Did you upload into the wrong event perhaps?</p>
%	}


	<table cellpadding="1" cellspacing="1" width="100%">

	<tr>
	<td width="100%">
	<h3><% $event->name %> Sweepstakes Results:</h3>
	</td>

	<td>
		<form action="upload_debate_sweeps.mhtml" method="post">
		<input type="submit" value="Upload Another Event">
		</form>
	</td>
	</table>

	<center>

	<% $err %>

	<table cellpadding="5" cellspacing="1" width="75%">

		<tr class="lirdrow">
			<td colspan="2" align="center">Total Wins: <% $total_wins %></td>
			<td colspan="2" align="center">Total Losses: <% $total_losses %></td>
		</tr>
	
		<tr class="liblrow">
			<th>Code</th>
			<th>School</th>
			<th>Name</th>
			<th>Points</th>
		</tr>

%		my $switch;

%		foreach my $comp (@comps) { 

%			if ($comp->sweeps_points > 130) { 
				<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>
%			} else { 
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%			}
				<td><% $comp->code %></td>
				<td><% $comp->school->name %></td>
				<td><% ($event->team == 2) 
						? $comp->student->last." & ".$comp->partner->last 
						: $comp->student->first." ".$comp->student->last %>
				</td>
				<td><% $comp->sweeps_points %></td>
			</tr>
%		}

	</table>
	</center>

%	} else { 

		
	<div class="left huge">

		<h2>Upload Joy-based debate records</h2>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="oddrow">

				<th>
					<form enctype="multipart/form-data" onsubmit="return uploadThis()" 
					name="import_file" action="upload_debate_sweeps.mhtml" method="post">
					Event:
				</th>

				<td align="left">
					<select name="event_id">
%						foreach my $event (sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn)( type => "debate") ) { 
							<option value="<% $event->id %>"><% $event->name %></option>
%						}
					</select>
				</td>

			</tr>

			<tr class="evenrow">

				<th>
					File:
				</th>

				<td align="left">
				    <input name="import_file" type="file">
				</td>

			</tr>

			<tr class="liblrow">

				<td colspan="2" align="right">
					<input type="submit" value="Upload Debate Results">
					</form>
				</td>

			</tr>
	
		</table>

	</div>
	
	<div class="right small">

		<a class="blue block" href="/tabbing/congress_sweeps.mhtml">Return to Manual Sweeps Entry</a>

		<hr>

		<h3>Instructions:</h3>
	
		<p>
			* The format of this file should be Speaker Code,# Wins,# Losses, linebreak.
			No quotes please.
		</p>

		<p>
			* This upload will OVERWRITE, not ADD TO, previously entered point
			totals.  Uploaded results must include ALL speakers in the event.  Any
			speakers not included in the file will get zero team points.
		</p>

		<p>
			* You may manually fix or check uploaded edge cases in the Tab -> Other
			Sweeps screen for this event
		</p>

	</div>

%	}



