<%args>
	$tourn
	$perms
	$tourn_settings
	$only_category => undef
</%args>
<%init>

	my $year = $tourn->start->year;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare(" 
		select
			student.id,
			student.first, student.last, student.grad_year, student.nsda,
			chapter.name, chapter.nsda,
			result.rank,
			event.abbr, event.name, nsda_event_category.value

		from (student, chapter, entry_student, entry, event, result_set, result)

		left join event_setting nsda_event_category 
			on nsda_event_category.tag = 'nsda_event_category'
			and nsda_event_category.event = event.id

		where event.tourn = ? 
			and event.id = entry.event
			and entry.id = entry_student.entry
			and entry.id = result.entry
			and result.result_set = result_set.id
			and result_set.label = 'Final Places'
			and result.rank < 15
			and entry_student.student = student.id
			and student.chapter = chapter.id
			and student.grad_year > ? 

			and not exists ( 
				select supp.id from event_setting supp 
				where supp.tag = 'supp'
				and supp.event = event.id
			)

			and not exists ( 
				select conn.id from event_setting conn 
				where conn.tag = 'conn'
				and conn.event = event.id
			)

			and not exists ( 
				select stefan.id from event_setting stefan 
				where stefan.tag = 'stefan'
				and stefan.event = event.id
			)
			and not exists ( 
				select usa_wsdc.id from event_setting usa_wsdc 
				where usa_wsdc.tag = 'usa_wsdc'
				and usa_wsdc.event = event.id
			)
	");

	$sth->execute($tourn->id, $year);

	my %autoquals;

	while (
		my (
			$student_id,
			$student_first, $student_last, $student_grad_year, $student_nsda, 
			$chapter_name, $chapter_nsda, 
			$result_rank,
			$event_abbr, $event_name, $event_code
		) = $sth->fetchrow_array
	) {

		$autoquals{$student_id}{'first'}        = $student_first;
		$autoquals{$student_id}{'last'}         = $student_last;
		$autoquals{$student_id}{'grad'}         = $student_grad_year;
		$autoquals{$student_id}{'nsda'}         = $student_nsda;
		$autoquals{$student_id}{'chapter_name'} = $chapter_name;
		$autoquals{$student_id}{'chapter_nsda'} = $chapter_nsda;
		$autoquals{$student_id}{'result'}       = $result_rank;
		$autoquals{$student_id}{'event_abbr'}   = $event_abbr;
		$autoquals{$student_id}{'event_name'}   = $event_name;
		$autoquals{$student_id}{'event_code'}   = $event_code;

	}

</%init>

	<& menu.mas, 
		perms          => $perms,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		only_category  => $only_category,
		whoami         => "autoquals"
	&> 

	<& "/funclib/tablesorter.mas", table => "autoquals" &>

	<div class="main">

		<span class="twothirds">
			<h4>Auto qualifiers for <% ($year + 1) %></h4>
		</span>
		<span 
			id="autoquals_buttonarea"
			class="third rightalign"
		></span>

		<div class="centeralign semibold redtext padvert">
			Remember: these results are pulled from the Final Results reports,
			so if those don't exist, autoquals will not be complete.
		</div>


		<table id = "autoquals">

			<thead>
				<tr class="yellowrow">
					
					<th>
						Event
					</th>

					<th>
						First
					</th>
					
					<th>
						Last
					</th>
					
					<th>
						ID
					</th>
					
					<th>
						Grad
					</th>

					<th>
						School
					</th>

					<th>
						Event Code
					</th>

					<th>
						Place
					</th>
				</tr>
			</thead>

			<tbody>

<%perl>
				foreach my $student_id (
					sort {$autoquals{$a}{"event_abbr"} cmp $autoquals{$b}{"event_abbr"}}
					keys %autoquals
				) { 
</%perl>

					<tr>
						<td>
							<% $autoquals{$student_id}{"event_abbr"} %>
						</td>

						<td>
							<% $autoquals{$student_id}{"first"} %>
						</td>

						<td>
							<% $autoquals{$student_id}{"last"} %>
						</td>

						<td>
							<% $autoquals{$student_id}{"nsda"} %>
						</td>

						<td>
							<% $autoquals{$student_id}{"grad"} %>
						</td>

						<td>
							<% $autoquals{$student_id}{"chapter_name"} %>
						</td>

						<td class="centeralign">
							<% $autoquals{$student_id}{"event_code"} %>
						</td>

						<td class="centeralign">
							<% $autoquals{$student_id}{"result"} %>
						</td>

					</tr>
%				}

			</tbody>

		</table>

	</div>


