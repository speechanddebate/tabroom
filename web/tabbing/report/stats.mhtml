<%args>
	$event_id
	$print => undef
	$tourn
</%args>
<%init>

	my @events;

	if ($event_id eq "all") { 
		foreach my $event ($tourn->events) { 
			next if $event->type eq "speech";
			next if $event->type eq "debate";
			push @events, $event;
		}
	} else { 
		push @events, Tab::Event->retrieve($event_id);
	}

	Tab::Round->set_sql( side_wins => 	"
		select count(distinct panel.id)
        from round, panel
		where round.id = ?
		and panel.round = round.id
		and panel.bye = 0

        and (select count(distinct winner.id) as winner
            from ballot as winner, ballot_value
            where winner.panel = panel.id
			and winner.bye = 0
			and winner.noshow = 0
			and winner.side = ?
            and ballot_value.ballot = winner.id
            and ballot_value.tag = \"ballot\"
            and ballot_value.value = 1 ) 
        >
         (select count(distinct loser.id) as loser
            from ballot as loser, ballot_value
            where loser.panel = panel.id
			and loser.side = ?
			and loser.noshow = 0
			and loser.bye = 0
            and ballot_value.ballot = loser.id
            and ballot_value.tag = \"ballot\"
            and ballot_value.value = 0 ) 

        order by panel.letter
	");

	Tab::Round->set_sql( side_ballots => 	"
		select count(distinct panel.id) as wins
        from round, panel, ballot, ballot_value
		where round.id = ?
		and panel.round = round.id
        and panel.id = ballot.panel
		and panel.bye = 0
		and ballot.side = ?
		and ballot.bye = 0
		and ballot.noshow = 0
        and ballot_value.ballot = ballot.id
        and ballot_value.tag = \"ballot\"
        and ballot_value.value = 1 
	");

	if ($print) {   

	    my $name = $tourn->name;
	    $name = $events[0]->name if scalar @events == 1
    	$name =~ s/[\W_]//g;

	    my $filename = "SideReport-$name-".$session->id;
    	my $filepath = $Tab::file_root."tmp/".$filename;
    	`rm -f $filepath.*`; 

		$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1 );

		open (TEXOUT, ">>$filepath.tex");

		my @rounds = $event->rounds;

		my $tabular = "\\begin{tabular}{";
		foreach (@rounds) { 
			$tabular .= "|p.25in|";
		}
		$tabular .= "|}\n";

		print TEXOUT $tabular;
		print TEXOUT "\\hline\n";

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n"  if ($switch++ % 2);

		print TEXOUT $entry->code." & ";
		
		if ($tourn->setting("ncfl")) { 
			print TEXOUT $entry->school->region->code
		} else { 
			print TEXOUT $entry->school->code
		}

		print TEXOUT "\\\\ \n";

	}

	print TEXOUT "\\hline\n";
	print TEXOUT "\\end{tabular}\n";

	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );


</%init>

		foreach my $event (sort {$a->name cmp $b->name} @events) { 

			foreach my $round ($event->rounds) { 
				$round->realname;
			}


		} 

	} else { 

</%init>

	<& menu.mas &>

	<div class="left huge">

		<h2>Side Reports</h2>

%		foreach my $event (sort {$a->name cmp $b->name} @events) { 
			
			<h4><% $event->name %></h4>

			<table>

				<tr class="yellowrow">

					<td>
					</td>

%					foreach my $round ($event->rounds) { 
						<th class="smallish">
							<% $round->realname %>
						</th>
%					}

				</tr>

				<tr>

					<td>
						Aff Wins:
					</td>

%					foreach my $round ($event->rounds) { 
%						my $aff_wins = Tab::Round->sql_side_wins->select_val( $round->id, 1, 1);
%						my $neg_wins = Tab::Round->sql_side_wins->select_val( $round->id, 2, 2);
%						my $percent = ($aff_wins / ($aff_wins + $neg_wins)) * 100 if $aff_wins || $neg_wins;
%						$percent = sprintf "%.1f", $percent;
						<td class="smallish">
							<% $percent %>% <br /><% $aff_wins %>/<% $aff_wins + $neg_wins %>
						</td>
%					}

				</tr>

				<tr class="evenrow">

					<td>
						Aff Ballots:
					</td>

%					foreach my $round ($event->rounds) { 
%						my $aff_ballots = Tab::Round->sql_side_ballots->select_val( $round->id, 1);
%						my $neg_ballots = Tab::Round->sql_side_ballots->select_val( $round->id, 2);
%						my $percent = ($aff_ballots / ($aff_ballots + $neg_ballots)) * 100 if $aff_ballots || $neg_ballots;
%						$percent = sprintf "%.1f", $percent;

						<td class="smallish">
							<% $percent %>% <br /><% $aff_ballots %>/<% $aff_ballots + $neg_ballots %>
						</td>
%					}

				</tr>

				</tr>
			</table>

%		}

	</div>

%}
