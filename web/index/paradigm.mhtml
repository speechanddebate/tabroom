<%args>
	$person          => undef
	$judge_person_id => undef
	$search_first    => undef
	$search_last     => undef
</%args>
<%init>

	use POSIX qw/strftime/;
	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

    my $key = $judge_person_id."-".$search_first."-".$search_last;

	return if $m->cache_self(
		key        => $key,
		expires_in => '5m'
	);

	my %results;

	unless ($judge_person_id) {

		$search_first =~ s/[\W_]//g;
		$search_last =~ s/[\W_]//g;

		my $limit;

		if ($search_first) {
			$limit .= " and person.first like '".$search_first."%'";
		}

		if ($search_last) {
			$limit .= " and person.last like '".$search_last."%'";
		}

		if ($limit) {

			my $dbh = Tab::DBI->db_Main();

			my $sth = $dbh->prepare("
				select
					person.id, person.first, person.last,
					GROUP_CONCAT(chapter.name SEPARATOR ', ')
				from (person, person_setting paradigm)
					left join chapter_judge on chapter_judge.person = person.id
					left join chapter on chapter.id = chapter_judge.chapter

				where person.id > 0
					$limit

					and person.id = paradigm.person
					and paradigm.tag = 'paradigm'

				group by person.id
			");

			$sth->execute();

			while (
				my (
					$id, $first, $last, $chapters
				) = $sth->fetchrow_array()
			) {
				$results{$id}{"first"}    = $first;
				$results{$id}{"last"}     = $last;
				$results{$id}{"chapters"} = $chapters;
			}
		}
	}

</%init>

	<div class="main">

%		if ($judge_person_id) {

			<& "paradigm.mas",
				judge_person => $judge_person_id
			&>

%		} elsif (keys %results) {

			<span class="fourfifths nospace">
				<h4>Paradigm search results <% $search_first %> <% $search_last %></h4>
			</span>

			<span id="paradigm_search_buttonarea" class="fifth rightalign nospace">
			</span>

			<& "/funclib/tablesorter.mas", table => "paradigm_search" &>

			<table id="paradigm_search">

				<thead>

					<tr class="yellowrow">

						<th>
							First
						</th>

						<th>
							Last
						</th>

						<th>
							Has Judged For
						</th>

						<th>
							Paradigm
						</th>
					</tr>

				</thead>
				<tbody>

%				foreach my $id (sort keys %results) {

%					$results{$id}{"chapters"} =~ s/, /<br \/>/g;

					<tr>

						<td>
							<% $results{$id}{"first"} %>
						</td>

						<td>
							<% $results{$id}{"last"} %>
						</td>

						<td class="smallish" style="line-height: 16px;">
							<% $results{$id}{"chapters"} %>
						</td>

						<td class="centeralign nospace padvert">
							<a
								href="paradigm.mhtml?judge_person_id=<% $id %>"
								class="fa fa-sm fa-file-text-o bluetext buttonwhite"
							></a>
						</td>

					</tr>

%				}

				</tbody>

			</table>

%		} else {

			<h2>Judge Paradigms</h2>

			<p>Search for a judge at right to read paradigms</p>

%			if ($search_first || $search_last) {
				<p class="explain centeralign">
					Your search for <% $search_first %> <% $search_last %>
					returned no judges with paradigms.  Please
					try again.
				</p>
%			}
%		}

	</div>

	<div class="menu">

%		if ($person && $judge_person_id) {

			<div class="sidenote">
				<a
					href  = "/user/tourn/show_past_prefs.mhtml?judge_person_id=<% $judge_person_id %>"
					class = "blue full"
				>
					View Past Ratings
				</a>

				<a href="#judging" class="blue full">
					View Judging Record
				</a>
			</div>

%		}

		<div class="sidenote">

			<h4>Search Judges:</h4>

			<form
				action = "paradigm.mhtml"
				method = "post"
			>

				<div class="row centeralign padvert marvertno">
					<input
						type        = "text"
						name        = "search_first"
						placeholder = "First name"
						size        = "24"
					>
				</div>

				<div class="row centeralign padvert marvertno">
					<input
						type        = "text"
						name        = "search_last"
						placeholder = "Last name"
						size        = "24"
					>
				</div>

				<div class="liblrow rightalign">
					<input
						type  = "submit"
						value = "Search"
					>
				</div>

			</form>

		</div>
	</div>

