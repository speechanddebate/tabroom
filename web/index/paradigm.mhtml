<%args>
	$judge_id => undef
	$account_id => undef
	$search_first => undef
	$search_last => undef
</%args>
<%init>

	use DateTime;
	
	$judge_id=$account_id unless $judge_id;
	my $account = Tab::Account->retrieve($judge_id) if $judge_id;

	my @searches;

	my $num_results;

	if ($search_first || $search_last) { 
	
		if ($search_first && $search_last) { 

			Tab::Account->set_sql( both => "
				select distinct *
				from account
				where first like ? 
				and last like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_both($search_first."%", $search_last."%");

		} elsif ($search_first) {

			Tab::Account->set_sql( first => "
				select distinct *
				from account
				where first like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_first($search_first."%");

		} elsif ($search_last) {

			Tab::Account->set_sql( last => "
				select distinct *
				from account
				where last like ? 
				and paradigm is not null
			");

			@searches = Tab::Account->search_last($search_last."%");

		}

		$account = $searches[0] if scalar @searches == 1;
		$num_results = scalar @searches;

	}

</%init>


	<div class="left huge">

		<br />

%		if ($account) { 

			<h2><% $account->first." ".$account->last %> Paradigm</h2>

			<div class="paradigm">
				<% $account->paradigm %>
			</div>

			<h4>Full Judging Record</h4>
			
			<table cellpadding="0" cellspacing="1" width="100%" id="sortme"> 

			<thead>
		
			<tr class="yellowrow">

				<th class="smallish">Tourney</th>
				<th class="smallish">Date</th>
				<th class="smallish">Event</th>
				<th class="smallish">Round</th>
				<th class="smallish">Aff</th>
				<th class="smallish">Neg</th>
				<th class="smallish">Decision</th>																
			</tr>
			
			</thead>
			
			</tbody>

<%perl>

			Tab::Ballot->columns(TEMP => qw/win/);
			Tab::Ballot->set_sql( ballots_by_judge => "
				select ballot.*, ballot_value.value as win
				from ballot, judge, ballot_value, panel, round
				where ballot.judge=judge.id
				and judge.account=$account
				and ballot_value.ballot=ballot.id
				and ballot_value.tag='ballot'
				and panel.id=ballot.panel
				and round.id=panel.round
				and round.published>0
				and round.post_results>0
				order by ballot.panel asc
			");

			my @ballots = Tab::Ballot->search_ballots_by_judge();
			my $aff; my $neg; my $panel=0; my $decision;
			my $switch; my $winner; my $winside;

			foreach my $ballot (@ballots) {

				if ( $ballot->panel != $panel and $panel > 0 ) {

					my $round = $ballot->panel->round;

</%perl>
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<td><% $round->event->tourn->name %></td>
					<td><% $round->event->tourn->end->month_abbr %> <% $round->event->tourn->end->year %></td>
					<td><% $ballot && $ballot->panel && $round ? $round->event->name : ""%></td>
%					if ( $round->label )  {
						<td><% $round->label %></td>
%					} else {
						<td><% $round->name %></td>
%					}						
					<td><% $aff %></td>
					<td><% $neg %></td>
					<td><% $decision %>
%					if ($round->type eq "elim" or $round->type eq "final" ) {					
						(<% $winner ? $winner->code." wins" : "No winner recorded" %> wins)
%					}					
					</td>
				</tr>

<%perl>
					$aff=""; $neg=""; $decision="";
				}
				if ( $ballot->side == 1 ) { $aff=$ballot->entry->code; }
				if ( $ballot->side == 2 ) { $neg=$ballot->entry->code; }				
				if ( $ballot->side == 1 and $ballot->win ==1 ) { $decision="AFF-".$ballot->entry->code; }
				if ( $ballot->side == 2 and $ballot->win ==1 ) { $decision="NEG-".$ballot->entry->code;; }
				($winner, $winside) = $m->comp('/funclib/panel_winner.mas', panel => $ballot->panel);
				$panel=$ballot->panel;				
			}		
</%perl>
			</tbody>
				
			</table>
			
%		} elsif (@searches) { 

			<h2>Pick one</h2>

			<p>Your search for <% $search_first %> <% $search_last %> returned <% $num_results %> results:</p>

%			foreach my $search (@searches) { 
				
				<a class="blue quarterspan nowrap smallish" href="paradigm.mhtml?judge_id=<% $search->id %>">
					<% $search->first." ".$search->last %>
				</a>

%			}

%		} else { 

			<h2>Judge Paradigms</h2>

			<p>Search for a judge at right to read paradigms</p>

%			unless (@searches) { 
%				if ($search_first || $search_last) {
					<p class="explain centeralign">
						Your search for <% $search_first %> <% $search_last %> returned no judges with paradigms.  Please
						try again.   
					</p>
%				}
%			}

%		}

	</div>

	<div class="right small">


%		if ($account) { 

			<div class="sidenote">

				<h4>Past ratings you've given to <% $account->last %></h4>

				<a href="/user/tourn/show_past_prefs.mhtml?judge_id=<% $account->id %>" class="blue block">
					View Past Ratings
				</a>

<!-- no longer necessary; included on main page
				<h4><% $account->last %> History</h4>

				<a href="/jbruschke/JudgeRecord.php?judgeid=<% $account->id %>" class="blue block">
					View Past Results
				</a>
-->	

			</div>

%		}

	
		<div class="sidenote">

			<h4>Search Judges:</h4>

			<form action="paradigm.mhtml">

			<div class="oddrow block smallish">
				<input type="text" name="search_first" placeholder="First name" size="25">
			</div>

			<div class="oddrow block smallish">
				<input type="text" name="search_last" placeholder="Last name" size="25">
			</div>

			<div class="liblrow rightalign">
				<input type="submit" value=" Go ">
				</form>
			</div>

		</div>

	</div>



