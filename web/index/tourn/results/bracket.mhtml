<%args>
	$result_id => undef
	$tourn_id => undef
</%args>
<%init>

	use POSIX;

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	my $result_set = Tab::ResultSet->retrieve($result_id);

	my @results = $result_set->results;
	my $event = $result_set->event;

	my @rounds = Tab::Round->search( event => $event->id, type => "elim", published => 1);
	push @rounds, Tab::Round->search( event => $event->id, type => "final", published => 1);

	Tab::ResultValue->set_sql(by_seeds => "
		select distinct result_value.*
		from result_value, result
		where result_value.tag = \"Seed\"
		and result_value.result = result.id
		and result.result_set = ?
		order by result_value.value
	");

	my %seeds_by_round = ();
	foreach my $seed (Tab::ResultValue->search_by_seeds($result_id)) { 
		$seeds_by_round{$seed->result->round->id."-".$seed->value} = $seed->result->entry;
	}

	my %results_by_round = ();
	my %entries_by_round = ();

	foreach my $result (@results) { 
		next unless $result->round;
		push @{$results_by_round{$result->round->id}}, $result;
		push @{$entries_by_round{$result->round->id}}, $result->entry;
	}

	my %power_by_round = ();
	my %order_by_round = ();

	foreach my $round (@rounds) {

		next unless $results_by_round{$round->id};

		my $number = scalar @{$results_by_round{$round->id}};
		my $power = 1;

		while ($power < $number) { 
			$power = $power * 2;
		}

		$power_by_round{$round->id} = $power;

		my @bracket_order = (1);

		my $step_power = 1;
		my $step_result;

		while ($step_result < $power) { 
		
			$step_result = 2 ** $step_power;
			my $step_target = $step_result + 1;
			$step_power++;

			my $step = 1;

			my @new_order;

			foreach my $order (@bracket_order) {

				if ($step++ % 2) {
					push @new_order, $order;
					push @new_order, $step_target - $order;
				} else { 
					push @new_order, $step_target - $order;
					push @new_order, $order;
				}

			}

			@bracket_order = @new_order;
		}

		@{$order_by_round{$round->id}} = @bracket_order;

	}

</%init>

	<div class="blankfull">

		<span class="hugespan" style="width: 705px;">
			<h2><% $result_set->label %> for <% $event->abbr %></h2>
		</span><span class="medbiggerspan centeralign">
			<a class="dkgreen padmore block" href="index.mhtml?tourn_id=<% $tourn_id %>&event_id=<% $event->id %>">
				Return to results listing
			</a>
		</span>

		<table cellpadding="2" style="border-spacing: 0px 0px;">

			<tr class="yellowrow">

%				foreach my $round (@rounds) { 
					<th class="smaller" colspan="2" style="border-bottom: 10px solid #fcfcfc;">
						<% $round->realname %> (<% $power_by_round{$round->id} %>)
					</th>
%				}

			</tr>


%			my $first_round = shift @rounds;
%			my $count;
	
%			my %round_count = ();

%			foreach my $order (@{$order_by_round{$first_round->id}}) { 

				<tr>

					<td class="smallish" style="<% $count ? "" : "border-top: 1px solid black;" %> <% $count % 2 ? "border-bottom: 1px solid black;" : "border-bottom: 1px dotted #ccc;" %> border-right: 1px solid #eaeaea;">
						<span class="microspan"><% $order %>.</span><% $seeds_by_round{$first_round->id."-".$order} ? $seeds_by_round{$first_round->id."-".$order}->code : "" %>
					</td>

%					if ($count % 2) { 
						<td style="vertical-align: top; padding: 0; width: 20px;">
							<div style="border-bottom: 20px solid transparent; border-left: 20px solid #eaeaea; line-height: 0%; width: 0px; padding: 0; margin: 0;"></div>
						</td>
%					} else { 
						<td style="vertical-align: bottom; padding: 0;">
							<div style="border-top: 20px solid transparent; border-left: 20px solid #eaeaea; line-height: 0%; width: 0px; padding: 0; margin: 0;"></div>
						</td>
%					} 

%					my $factor = 1;
	
%					foreach my $round (@rounds) { 

%						$factor = $factor * 2;
%						next unless $order_by_round{$round->id};

%						Tab::debuglog("Count is $count and factor is $factor for round ".$round->realname) unless $count;

%						unless ($count % $factor) { 

%							$round_count{$round->id}++;

%							my $round_order = shift @{$order_by_round{$round->id}};

							<td rowspan="<% $factor %>" style="<% $count ? "" : "border-top: 1px solid black;" %> <% $round_count{$round->id} % 2 ? "border-bottom: 1px dotted #ccc;" : "border-bottom: 1px solid black;" %> border-right: 1px solid #eaeaea;" >
								<% $factor %> <% $count %> <% $seeds_by_round{$round->id."-".$round_order} ? $seeds_by_round{$round->id."-".$round_order}->code : "" %>
							</td>

%							if ($round_count{$round->id} % 2) { 
								<td rowspan="<% $factor %>" style="vertical-align: bottom; padding: 0;">
									<div style="border-top: 20px solid transparent ; border-left: 20px solid #eaeaea; line-height: 0%; width: 0px; padding: 0; margin: 0;"></div>
								</td>
%							} else { 
								<td rowspan="<% $factor %>" style="vertical-align: top; padding: 0;">
									<div style="border-bottom: 20px solid transparent ; border-left: 20px solid #eaeaea; line-height: 0%; width: 0px; padding: 0; margin: 0;"></div> 
								</td>
%							} 
%						}
%					}	
%					$count++;

				</tr>
%			}



		</table>


	</div>
