<%args>
	$event_id => undef
</%args>
<%init>

    my $key = $event_id;
    return if $m->cache_self( key => $key, expires_in => '5m' );

	my $event = Tab::Event->retrieve($event_id) if $event_id;  
	my $tourn = $event->tourn if $event;

	$m->abort() unless $event;

	my $switch;

	use POSIX;

	my @entries = sort {	
		$a->school->name cmp $b->school->name
	} $event->entries ( active => 1); 

	my @scores = $m->comp(
		"/funclib/event_scores.mas", 
			event  => $event,
			public => 1,
			prelim => 1
		);

	my %ballots_by_entry = ();
	my %ballots_by_panel = ();
	my %ballots_by_entry_panel = ();

	my %rankscore_by_entry = ();

	my %wins_by_entry = $m->comp(
		"/funclib/entry_wins.mas", 
			event  => $event,
			public => 1
	);

	my %panels_by_entry = ();
	
	my $different;

	if ($event->type eq "wudc") { 

		foreach my $score (@scores) {
			$rankscore_by_entry{$score->entryid} += (4 - $score->value) 
				if $score->tag eq "rank";
		}

	} elsif ($event->type eq "speech") { 

		foreach my $score (@scores) {
			$rankscore_by_entry{$score->entryid} += $score->value 
				if $score->tag eq "rank";
		}

	} else { 

		foreach my $score (@scores) {

			$ballots_by_entry{$score->entryid}++ 
				if $score->value == 1 
				and $score->tag eq "ballot";

			$ballots_by_panel{$score->panelid}++ 
				if $score->value == 1 
				and $score->tag eq "ballot";

			$ballots_by_entry_panel{$score->entryid."-".$score->panelid}++ 
				if $score->value == 1 
				and $score->tag eq "ballot";

			push @{$panels_by_entry{$score->entryid}}, $score->panelid;
		}

		foreach my $entry (@entries) { 

			my %done = ();

			$different++ 
				if $ballots_by_entry{$entry->id} != 0 
				&& $wins_by_entry{$entry->id} < $ballots_by_entry{$entry->id};
		}
	}

	if ($event->type eq "wudc") { 

		@entries = 
			sort { $rankscore_by_entry{$b->id} <=> $rankscore_by_entry{$a->id} } 
			@entries;

	} elsif ($event->type eq "speech") { 

		@entries = 
			sort { $rankscore_by_entry{$a->id} <=> $rankscore_by_entry{$b->id} } 
			@entries;

	} else { 
		@entries = 
			sort { $ballots_by_entry{$b->id} <=> $ballots_by_entry{$a->id} } 
			@entries if $different;

		@entries = 
			sort { $wins_by_entry{$b->id} <=> $wins_by_entry{$a->id} } 
			@entries;
	}

</%init>

	<& "menu.mas",
		tourn_id => $tourn->id,
		event_id => $event_id,
		whoami   => "records"
	&>

	<& "/funclib/tablesorter.mas", 
		table => "ranked_list"
	&>

	<div class="main">
		
		<& "/index/tourn/title.mas", tourn => $tourn &>

        <& "/index/tourn/tabbar.mas", tourn => $tourn &>

		<div class="threequarters">
			<h4><% $event->abbr %> Entries by Prelim Record</h4>
		</div>

		<div 
			class = "quarters"
			id    = "ranked_list_buttonarea"
		>
		</div>

			<table id="ranked_list">

				<thead>

				<tr class="yellowrow">
					
					<th class="smaller">
						<% $event->type eq "wudc" 
							?  "Rank Points" 
							: $event->type eq "speech" 
								? "Ranks" 
								: "Wins"
						%>
					</th>

%					if ($different) {
						<th class="smaller">
							Ballots
						</th>
%					}

					<th class="smaller">
						Name
					</th>

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						School
					</th>
				</tr>

				</thead>

				<tbody>

%				foreach my $entry (@entries) {

					<tr>

						<td class="smallish centeralign">
%							if ($event->type eq "wudc" || $event->type eq "speech") { 
								<% $rankscore_by_entry{$entry->id} ? $rankscore_by_entry{$entry->id} : "0" %>
%							} else { 
								<% $wins_by_entry{$entry->id} ? $wins_by_entry{$entry->id} : "0" %>
%							}
						</td>

%						if ($different) {
							<td class="smallish centeralign">
								<% $ballots_by_entry{$entry->id} ? $ballots_by_entry{$entry->id} : "0" %>
							</td>
%						}

						<td class="smallish">
							<a class="white" 
								href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>">
								<% $entry->name %>
							</a>
						</td>

						<td class="smallish">
							<a class="white" 
								href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>">
								<% $entry->code %>
							</a>
						</td>

						<td class="smallish">
							<% $entry->school->short_name %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>


