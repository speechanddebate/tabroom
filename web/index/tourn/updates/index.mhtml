<%args>
	$tourn_id    => undef
	$person      => undef
	$event_id    => undef
	$category_id => undef
</%args>
<%init>

	use POSIX;

	if ($tourn_id && ($tourn_id ne int($tourn_id))
		$m->comp("/funclib/abort.mas", message => $tourn_id." is not a valid tournament ID.");
	}

	my $tourn =  Tab::Tourn->retrieve($tourn_id);
	my $event = Tab::Event->retrieve($event_id) if $event_id;
	$tourn = $event->tourn if $event && (not defined $tourn);

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	my $anonymous_public++ if $event && $event->setting("anonymous_public");

	my $ncfl = $tourn->setting("ncfl") if $tourn;

	my @followers = Tab::Follower->search(
		follower => $person->id,
		tourn    => $tourn->id
	) if $person && $tourn;

</%init>

	<& menu.mas,
		tourn => $tourn,
		event => $event,
		category => $category
	&>

	<div class="main">

		<& /index/tourn/title.mas, tourn => $tourn &>

		<& /index/tourn/tabbar.mas, tourn => $tourn, person => $person &>

%		my %already;

%		if ($person && @followers) {

			<div>
				<span class="pagehalf">
					<h4>You are following:</h4>
				</span>

				<span class="pagehalf rightalign">
					<p>Tap to remove</p>
				</span>
			</div>

%			foreach my $follower (@followers) {

				<span class="pagehalf">

					<a
						class="full marless border liblrow plain hover smallish padleft"
						href="update_remove.mhtml?tourn_id=<% $tourn_id %>&follower_id=<% $follower->id %>&email=<% $follower->email %>&cell=<% $follower->cell %>&indexme=1&event_id=<% $event_id %>&category_id=<% $category_id %>"
					>

<%perl>
						if ($follower->type eq "entry") {

							next unless $follower->entry;
							next unless $follower->entry->event;
							$already{$follower->entry}++;

							my $anon++ if $follower->entry->event->setting("anonymous_public");

</%perl>
							<span class="third nowrap">
								<% $follower->entry->code %>
							</span>

							<span class="twothird">
%								unless ($anon) {
									<% $follower->entry->name %>
%								}
							</span>

%						} elsif ($follower->type eq "judge" && $follower->judge) {

%							$already{$follower->judge}++;

							<span class="twothird">
								<% $follower->judge->code %>
%								unless ($anonymous_public) {
									<% $follower->judge->first." ".$follower->judge->last %>
%								}
							</span>

							<span class="third">
								<% $follower->judge
									&& $follower->judge->category
									? $follower->judge->category->name
									: ""
								%>
							</span>

<%perl>

						} elsif (
							$follower->type eq "school"
							&& not defined $ncfl
							&& not defined $anonymous_public
						) {

</%perl>

							<span class="quarter">
								All from
							</span>
							<span class="threequarters">
								<% $follower->school->code." ".$follower->school->name %>
							</span>

%						}

					</a>
				</span>
%			}
%		}

%		if ($event) {

			<div>
				<span class="pagehalf">
					<h4><% $event->name %> entries:</h4>
				</span>

				<span class="pagehalf rightalign">
					<p>Click on an entry to follow their live updates</p>
				</span>
			</div>

<%perl>

			my @entries =
				sort {$a->school->name cmp $b->school->name}
				$event->entries( active => 1, tba => 0);

			my $total = scalar @entries;
			my $count;

</%perl>
			<span class="pagehalf">

%			foreach my $entry (@entries) {

%				next if $already{$entry};

%				if ($count == ceil($total /2)) {
					</span>
					<span class="pagehalf">
%				}

%				$count++;

				<a
					class="smallish row hover plain full marno"
					title="<% $entry->code %>"
					href="entry.mhtml?entry_id=<% $entry->id %>&tourn_id=<% $tourn_id %>"
				>
					<span class="half nowrap padmore">
						<% $entry->code %>
					</span>
%					unless ($anonymous_public) {
						<span class="half">
							<% $entry->name %>
						</span>
%					}
				</a>

%			}

			</span>
%		}

%		if ($category) {

			<div>
				<span class="pagehalf">
					<h4><% $category->name %> judges</h4>
				</span>

				<span class="pagehalf rightalign">
					<p>Click on a judge to follow their live updates</p>
				</span>
			</div>

<%perl>

				my @judges =
					sort {$a->last cmp $b->last}
					$category->judges( active => 1);

				@judges =
					sort {$a->schoolname cmp $b->schoolname}
					@judges;

				@judges =
					sort {$a->code <=> $b->code}
					@judges if $ncfl;

				my $total = scalar @judges;

				my $count;

</%perl>
				<span class="pagehalf">

%				foreach my $judge (@judges) {

%					if ($count == ceil($total /2)) {
						</span>
						<span class="pagehalf">
%					}

%					$count++;

					<a
						class="smallish hover row plain full marno"
						href="judge.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn_id %>"
					>

						<span class="twofifth nowrap">
							<% $ncfl ? $judge->code : "" %>
							<% $judge->first." ".$judge->last %>
						</span>

						<span class="half nowrap">
%							unless ($anonymous_public) {
								<% $judge->school && $judge->school->id
									? $judge->school->short_name
									: "Hired"
								%>
%							}
						</span>
					</a>

%				}

				</span>


%		}

	</div>


