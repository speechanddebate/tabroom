<%args>
	$account => undef
	$tourn_id
	$round_id => undef
	$event_id => undef
</%args>
<%init>

	my $tourn =  Tab::Tourn->retrieve($tourn_id);

	my $tz =  $account->tz if $account;
	$tz = $tourn->tz unless $tz;

	my @rounds = $m->comp('/funclib/published_rounds.mas', tourn => $tourn);
	push (@rounds, $m->comp('/funclib/listed_rounds.mas', tourn => $tourn));

    #uniq 
	my %seen = ();
    @rounds = grep { ! $seen{$_->id} ++ } @rounds;

	my %events_with_rounds = ();

	foreach my $round (@rounds) { 
		push (@{$events_with_rounds{$round->event->id}}, $round);
	}

    my $webpage = Tab::Webpage->search( tourn => $tourn_id, special => "postings")->first;

	my $switch;

</%init>

	<div class="left huge">

        <h2>
            <% $tourn->name %>: <% $tourn->location %>  
        </h2>

        <& ../tourn_header.mas, tourn => $tourn &>


%		my $round = Tab::Round->retrieve($round_id) if $round_id;

%		if ($round) { 

<%perl>
			my $event = $round->event;
			$event_id = $event->id;

			unless ($round->published) { 

				$m->print("<p class=\"err\">This round has not been published.  Quit trying to mess around</p>");
				$m->abort;
		
			}
</%perl>

			<h4><% $round->event->name %> <% ($round->label) ? $round->label : "Round ".$round->name %>
				(<% Tab::niceshortdt($round->timeslot->start->set_time_zone($tz)) %>)
			</h4>
			
			<table cellpadding="5" cellspacing="1" width="100%"> 
			
				<tr>
					<th>
						Room
					</th>
					
					<th style="border-right: 1px solid brown;">
						Judge(s)
					</th>
					
					<th colspan="7">
						Entries
					</th> 
					
				</tr> 

%				my $switch;

% 				foreach my $panel (sort {$a->letter cmp $b->letter} $round->panels) { 

				    <tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>> 
					
						<td class="smaller">
							<% ($panel->room) ? $panel->room->name : "" %>
						</td>	
						
						<td class="smaller" style="border-right: 1px solid brown;"> 
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<% ($judge->school->id ) ? ($judge->school->code) ? $judge->school->code : "" : "" %>
								<% $judge->code %>
% 							}
						</td>

% 						my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);
%						my $count;

% 						foreach my $entry (@entries) { 

%							if ( ($event->type eq "speech" && $count == 7) 
%									|| ($event->type eq "congress" && $count == 4)
%	  								|| ($tourn->setting("schemat_display") eq "full_names" && $count == 4)
%	 	 							|| ($tourn->setting("schemat_display") eq "last_names" && $count == 5)) {
								
						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
									
							<td class="smaller" style="border-right: 1px solid brown;" colspan="3">
								<br />
							</td>

%								$count = 0;
%							}

							<td class="smaller">
%								if ($event->type eq "speech") { 
		
%									if ($tourn->setting("schemat_school_code")) { 
										<% $entry->school->code %>
%									}

%									if ($tourn->setting("schemat_display") eq "last_names") { 

										<% $entry->student->last %>

%										if ($event->team == 2) { 
											& <% $entry->partner->last %>
%										}
%									}

%									if ($tourn->setting("schemat_display") eq "full_names") { 

										<% $entry->student->first." ".$entry->student->last %>

%										if ($event->team == 2) { 
											<% $entry->partner->first." ".$entry->partner->last %>
%										}
%									}

%									if ($tourn->setting("schemat_display") eq "codes") { 
										<% $entry->code %>
%									}

%								}

%								if ($event->type eq "congress") { 
									<% $entry->student->first." ".$entry->student->last."<br /> ".$entry->school->name %> 
%								}
	
								</td>
%								$count++;

%							} # end of foreach entry

%							foreach my $count ($count .. 6) {
								<td></td>
%							}

						</tr>

%					} #end of foreach panel  

			</table>

%		} elsif ($webpage) { 

			<p>
				<% $webpage->content %>
			</p>

%		} else { 

%		}

	</div>

	<& sidebar.mas, tourn_id => $tourn_id, event_id => $event_id, round_id => $round_id &>

