<%args>
	$event_id => undef
	$round_id => undef
	$person   => undef
</%args>
<%init>

	unless ( (not defined $round_id) || ($round_id eq int($round_id))) {
		$m->comp("/funclib/abort.mas", message => "Invalid or multiple round IDs sent");
	}

	unless ( (not defined $event_id) || ($event_id eq int($event_id))) {
		$m->comp("/funclib/abort.mas", message => "Invalid or multiple event IDs sent");
	}

	my $key = $round_id."-".$event_id;

	if ($r->hostname eq "www.tabroom.com.") {

		if ($ARGS{"invalidate_silent"}) {
			$m->cache_self(
				key        => $key,
				expire_if  => sub { return 1 }
			);

			$m->clear_buffer();
			$m->print("Cache cleared for $key");
			$m->abort();

		} else {
			return if $m->cache_self(
				key        => $key,
				expires_in => '5m',
				expire_if  => sub { return 1 if defined $ARGS{"invalidate"} }
			);
		}
	}

	my $event = eval {
		return Tab::Event->retrieve($event_id);
	};

	my $round = eval {
		return Tab::Round->retrieve($round_id);
	};

	unless ($round) {
		$m->comp("/funclib/abort.mas",
			message => "Round $round_id not found"
		);
		$m->abort();
	}

	$event = $round->event unless $event;

	unless ($event) {
		$m->comp("/funclib/abort.mas",
			message => "Round $event_id not found"
		);
		$m->abort();
	}
	my $tourn = $event->tourn;

	unless ($round->published && $round->published > 0) {
		$m->print("<div class='blankfull centeralign'>");
		$m->print("<h5>That round is not yet published</h5>");
		$m->print("<p>Please come back soon.</p>");
		$m->print("</div>");
		$m->abort;
	}

</%init>

	<& "menu.mas",
		tourn_id => $tourn->id,
		event_id => $event->id,
		round_id => $round->id
	&>

	<div class="main" title="<% $event->type %> <% $event->id %>">

		<& "/index/tourn/title.mas",
			tourn => $tourn
		&>

        <& "/index/tourn/tabbar.mas",
			tourn  => $tourn,
			person => $person
		&>

<%perl>
		if ($event) {

			if ($round) {

				my $notes = $round->setting("notes");

				if ($notes) {
</%perl>
					<p class="semibold redtext bigger centeralign padbottom martopmore marbottomless borderbottom">
						<% $notes %>
					</p>
<%perl>
				}

				my $motion = $round->setting("motion");

				if ($motion) {
					if ($round->setting("motion_publish")) {
</%perl>
						<p class="centeralign bigger padtopmore semibold bluetext">
							Motion: <% $motion %>
						</p>
%					}
%				}

%	 			if ( $event->type eq "speech" ) {
					<& show_speech.mas,
						round => $round,
						tourn => $tourn,
						event => $event
					&>
%				}

%	 			if ( $event->type eq "congress" ) {
					<& show_congress.mas, round => $round &>
%				}

%	 			if ( $event->type eq "wudc" ) {
					<& show_wudc.mas, round => $round &>
%				}

% 				if ( $event->type eq "mock_trial") {
					<& show_debate.mas,
						person    => $person,
						round     => $round,
						no_judges => 1
					&>
%				}

% 				if ( $event->type eq "debate" || $event->type eq "wsdc") {
					<& show_debate.mas,
						round  => $round,
						person => $person,
					&>
%				}
%			}
%		}

%		my $protocol = $round->protocol;

%		if ($protocol) {

			<div class = "martopmore padtopmore bluebordertop full">
				<p class="centeralign">
%					if ($round->type eq "prelim") {
%						if ($event->setting('seed_presets')) {
							<% $round->type eq "prelim" ? "This round is a preset matched based on rankings" : "" %>
%						} else {
							<% $round->type eq "prelim" ? "This round is randomly matched" : "" %>
%						}
%					} elsif ($round->type eq "elim") {
						This round is an elimination round
%					} elsif ($round->type eq "snaked_prelim") {
						This round is a prelim sectioned with power-protection
%					} elsif ($round->type eq "final") {
						This round is the final round
%					} elsif ($round->type eq "highhigh") {
						This round was powermatched high-high within brackets
							<% $event->setting("powermatch") eq "sop" ? " by S+OP " : " by seed" %>
%					} elsif ($round->type eq "highlow") {
						This round was powermatched high-low within brackets
							<% $event->setting("powermatch") eq "sop" ? " by S+OP " : " by seed" %>
%					} elsif ($round->type eq "runoff") {
						This round is a runoff
%					}
				</p>

				<p
					class = "biggish semibold centeralign"
					title = "the Nethmin Liyanage Experience"
				>
					Tiebreak Protocol for this round
				</p>

%				my $last_priority;
%				foreach my $tiebreak (sort {$a->priority <=> $b->priority} $protocol->tiebreaks) {
					<div class="full odd ltbordertop flexrow smallish">
						<span class="eighth semibold padleft">
							<% $tiebreak->priority eq $last_priority ? "&nbsp; +" : $tiebreak->priority %>
						</span>
						<span class="fourfifths padvert">
							<& "/funclib/tiebreak_name.mas", tiebreak => $tiebreak &>
						</span>
					</div>
%					$last_priority = $tiebreak->priority;
%				}
			</div>
%		}

	</div>

