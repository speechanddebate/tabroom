<%args>
	$entry_id
	$account => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);
	$m->abort() unless $entry;

	my $event = $entry->event;
	my $tourn = $event->tourn;

	my $switch; 

	my @circuits = $tourn->circuits;

	my $ndt;

	foreach my $circuit (@circuits) {
		$ndt++ if $circuit->id == 43;
	}

</%init>

	<& sidebar.mas, tourn_id => $tourn->id, event_id => $event->id &>

	<div class="left huge">

        <h2>
			<% $entry->name %> Record
        </h2>

        <& ../tourn_header.mas, tourn => $tourn, account => $account &>

		<span class="biggishspan">
			<h4>
				<% $entry->name %> 
			</h4>
		</span>

		<span class="medspan">
			<h4>
				(<% $entry->code %>)
			</h4>
		</span>

		<span class="medspan">
			<h4>
				<% $entry->school->short_name %>
			</h4>
		</span>

		<div class="evenrow centeralign padmore">

			<span class="thirdspan centeralign padless">
				<a class="dkgreen block" href="/index/tourn/updates/entry_follow.mhtml?entry_id=<% $entry->id %>&tourn_id=<% $tourn->id %>">
					Live Updates
				</a>
			</span>

%			if ($ndt) {

%				my @students = $entry->students;

%				if (scalar @students == 2 ) { 

					<span class="thirdspan centeralign padless">
						<a class="dkgreen block" href="/jbruschke/TeamBidSheet.php?id1=<% $students[0]->id %>&id2=<% $students[1]->id %>">
							NDT Points Sheet
						</a>
					</span>

%				}

%				if ($entry->school && $entry->school->chapter) { 
					<span class="thirdspan centeralign padless">
						<a class="dkgreen block" href="http://opencaselist.paperlessdebate.com/xwiki/wiki/opencaselist/Admin/Redirect?<% $entry->school->chapter->id %>">
							Casewiki
						</a>
					</span>
%				}

%			}

		</div>


%		my @panels = $m->comp('/funclib/entry_panels.mas', entry => $entry, published => 1);

%		if (@panels) { 

			<hr />

			<h4>Pairings</h4>

			<table cellpadding="4" cellspacing="1">

%		}

%		my %seen = (); 
%		@panels = grep { ! $seen{$_->id} ++ } @panels;

%		foreach my $panel (@panels) {

%			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);
%			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;
%			my $side = "Aff" if $panel->side == 1;
%			$side = "Neg" if $panel->side == 2;
%			$side = "Bye" if $panel->bye;

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td class="smallish">
					<% $panel->round->realname %>
				</td>

%				if ($panel->round->flighted > 1) { 
					<td class="smallish">
						Flight <% $panel->flight %> 
					</td>

%				}
				
				<td class="smallish">
					<% ($panel->room) ? $panel->room->name : "" %>
				</td>

				<td class="smallish">
					<% $side %>
				</td>

				<td class="smallish">
					<a class="white block" href="entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $opp->id %>">
						vs <% $opp->code %>
					</a>
				</td>

				<td class="smallish">
%					foreach my $judge (@judges) { 
						<a class="white block" href="judge.mhtml?tourn_id=<% $tourn->id %>&judge_id=<% $judge->id %>">
							<% ucfirst $judge->first." ". ucfirst $judge->last %>
						</a>
%					}
				</td>

			</tr>

%		}

%		if (@panels) { 
			</table>
%		}

%		my @results = $m->comp('/funclib/entry_panels.mas', entry => $entry, post_results => 1);
%		my %rseen = (); 
%		@results = grep { ! $rseen{$_->id} ++ } @results;

%		if (@results) { 

			<hr />

			<h4>Results</h4>

			<table cellpadding="4" cellspacing="1">
%		}

%		foreach my $panel (@results) { 

%			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

%			if (scalar @judges > 1) {

				<tr class="yellowrow">
					<td colspan="10">
					</td>
				</tr>

%			}

%			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;

%			my $side = "Aff" if $panel->side == 1;
%			$side = "Neg" if $panel->side == 2;
%			$side = "Bye" if $panel->bye;

			<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">

				<td rowspan="<% scalar @judges %>">
					<% $panel->round->realname %>
				</td>

				<td rowspan="<% scalar @judges %>">
					<% $side %>
				</td>

				<td rowspan="<% scalar @judges %>">
					<a class="white block" href="entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $opp->id %>">
						vs <% $opp->code %>
					</a>
				</td>

%				my $notfirst;
%				foreach my $judge (@judges) { 
		
%					if ($notfirst++)  {
						<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">
%					}

%					my @scores = $m->comp('/funclib/panel_scores.mas', panel => $panel, judge => $judge, entry => $entry);
%           		my %scores_by_recipient =();

%           		foreach my $score (@scores) {   
%						push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; 
%           		}

					<td class="fixed nowrap">
						<a class="white block" href="judge.mhtml?tourn_id=<% $tourn->id %>&judge_id=<% $judge->id %>">
						<% ucfirst $judge->last %>, <% ucfirst $judge->first %>
						</a>
					</td>

					<td>
%						foreach my $score (@scores) { 
							<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
%						}
					</td>

%					my @students = $entry->students;
%					foreach my $student (@students) { 

%						if ($side eq "Bye" || $panel->round->post_results == 1) {
		
							<td colspan="<% 2 * scalar $entry->students %>"></td>

%						} else {

%							if (scalar @students > 1) {
								<td>
									<% $student->last %>
								</td>
%							} 

%							foreach my $score (@{$scores_by_recipient{$student->id}}) { 
	
								<td>	
									<% $score->value %>
								</td>	

%							}

%						}

%					}

					</tr>
%					$switch++;
%				}


%		}

%		if (@results) { 
			</table>
%		}


	</div>

