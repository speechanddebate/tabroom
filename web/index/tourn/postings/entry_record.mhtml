<%args>
	$entry_id => undef
	$person   => undef
</%args>
<%init>

	use Lingua::EN::Numbers::Ordinate 'ordinate';

	unless ($person) {
		$m->redirect('/user/login/login.mhtml?msg="Please login to view results data"');
	}

	unless ((not defined $entry_id) || ($entry_id eq int($entry_id))) {
		$m->comp("/funclib/abort.mas", message => "Invalid or multiple event IDs sent");
	}

	my $key = $entry_id;

#	return if $m->cache_self(
#		key        => $key,
#		expires_in => '15m'
#	);

	my $dbh = Tab::DBI->db_Main();
	my $sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name,

			student.id student_id, student.first student_first, student.last student_last, student.middle student_middle,
			hybrid.id hybrid_id, hybrid.name hybrid_name,

			school.id school_id, school.name school_name, school.code school_code,
			school.chapter chapter_id,

			event.id event_id, event.name event_name, event.abbr event_abbr, event.type event_type,
			event.tourn tourn_id, tourn.name tourn_name,
			tourn.start tourn_start, tourn.city tourn_city,
			tourn.state tourn_state,
			tourn.country tourn_country,
			anonymous_public.value anonymous_public,
			live_updates.value live_updates,
			aff_label.value aff_label,
			neg_label.value neg_label,
			tc.id ndt

		from (entry, entry_student es, student, event, tourn)

			left join tourn_circuit tc
				on tc.circuit = 43
				and tc.tourn = event.tourn

			left join school on entry.school = school.id

			left join chapter hybrid
				on hybrid.id = student.chapter
				and hybrid.id != school.chapter

			left join event_setting anonymous_public
				on anonymous_public.event = event.id
				and anonymous_public.tag ='anonymous_public'

			left join event_setting live_updates
				on live_updates.event = event.id
				and live_updates.tag ='live_updates'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag ='aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag ='neg_label'

		where 1=1
			and entry.id = ?
			and entry.id = es.entry
			and es.student = student.id
			and entry.event = event.id
			and event.tourn = tourn.id
		group by student.id
	");

	$sth->execute($entry_id);

	my $entries = $sth->fetchall_hash();
	my $entry;
	my @students;

	foreach my $ref (@{$entries}) {

		if ($ref->{anonymous_public}) {
			$m->comp("/funclib/abort.mas",
				message => "This tournament is set for anonymized public postings.  Hit back to continue"
			);
		}

		unless ($entry) {
			$ref->{spaceless} = $ref->{code};
			$ref->{spaceless} =~ s/\s+//g;
			$entry = $ref;
		}

		unless ($entry->{students}{$ref->{student_id}}) {
			$entry->{students}{$ref->{student_id}} = {
				id     => $ref->{student_id},
				first  => $ref->{student_first},
				last   => $ref->{student_last},
				middle => $ref->{student_middle},
			};

			push @students, $entry->{students}{$ref->{student_id}};
		}
	}

	$entry->{short_name} = $m->comp("/funclib/short_name.mas", name => $entry->{school_name});

</%init>

	<& "menu.mas",
		tourn_id => $entry->{tourn_id},
		event_id => $entry->{event_id}
	&>

	<div class="main">

		<h2 class="centeralign marno">
			<% $entry->{tourn_name} %>
		</h2>

		<h5 class="full centeralign marno">
			<% substr($entry->{tourn_start}, 0, 4) %>
			&mdash;
			<% $entry->{tourn_city} %>
			<% $entry->{tourn_state} || $entry->{tourn_country}  %>
		</h5>

        <& ../tabbar.mas,
			tourn_id => $entry->{tourn_id},
			person   => $person
		&>

		<div class="full martopmore flexrow borderbottom padbottom">

			<span class="twothirds padvertless">
				<h4 class="nospace semibold">
%					my $notfirst;
%					foreach my $student (@students) {
%						$m->print("&amp;") if $notfirst++;
						<% $student->{first} %>
						<% $student->{middle} %>
						<% $student->{last} %>
%					}
				</h4>

				<h6 class="full martop semibold bluetext padleft">
%					if (index($entry->{code}, $entry->{short_name}) == -1) {
						<% $entry->{school_name} %>
%					}
					<% $entry->{code} %>
%					if ($entry->{hybrid_id}) {
						(Hybrid with <% $entry->{hybrid_name} %>
%					}
				</h6>
			</span>

			<span class="third rightalign marno">

				<h6 class="nospace padbottommore semibold">
					<% $entry->{event_name} %>
				</h6>

%				if ($entry->{live_updates}) {
					<a
						class="buttonwhite thin bluetext invert"
						href="/index/tourn/updates/entry_follow.mhtml?entry_id=<% $entry->{id} %>&tourn_id=<% $entry->{tourn_id} %>"
					>Live Updates</a>
%				}

%				if ($entry->{ndt}) {
%					if (scalar @students == 2 ) {
						<a
							class="buttonwhite thin greentext"
							href="/index/results/team_results.mhtml?id1=<% $students[0]->{id} %>&id2=<% $students[1]->{id} %>"
						>Team Results</a>
%					}
%					if ($entry->{chapter_id}) {
						<a
							class="buttonwhite redtext thin"
							href="http://opencaselist.paperlessdebate.com/Caselist/Redirect?<% $entry->{chapter_id} %>"
						>Casewiki</a>
%					}
%				}

			</span>
		</div>

		<& "/funclib/tablesorter.mas", table => $entry->{spaceless} &>

<%perl>

		my $results_sth = $dbh->prepare("

			select
				round.id, round.name, round.label, round.type,

				round.published,
					round.post_primary,
					round.post_secondary,

				panel.id panel_id, panel.letter panel_letter, panel.bye panel_bye,
				ballot.id ballot_id, ballot.side side, ballot.speakerorder speakerorder,
				ballot.bye bye, ballot.forfeit forfeit,
				ballot.entry entry_id,

				judge.id judge_id, judge.first judge_first, judge.last judge_last,

				winloss.id winloss_id,
				winloss.value winloss,
				rank.value rank, rank.student rank_student,
				point.value point, point.value point_student,

				opp_entry.id opp_id,
				opp_entry.code opp_code

			from (round, panel, ballot)

				left join judge on ballot.judge = judge.id

				left join ballot opp_ballot
					on opp_ballot.panel = panel.id
					and opp_ballot.judge = judge.id
					and opp_ballot.id != ballot.id
					and opp_ballot.entry != ballot.entry

				left join entry opp_entry
					on opp_entry.id = opp_ballot.entry

				left join score winloss
					on winloss.ballot = ballot.id
					and winloss.tag   = 'winloss'
					and winloss.value = 1

				left join score rank
					on rank.ballot = ballot.id
					and rank.tag   = 'rank'

				left join score point
					on point.ballot = ballot.id
					and point.tag   = 'point'

			where 1=1

				and ballot.entry    = ?
				and ballot.panel    = panel.id
				and panel.round     = round.id
				and round.published = 1

			group by ballot.id
			order by round.name DESC

		");

		$results_sth->execute($entry->{id});
		my $results = $results_sth->fetchall_hash();

		my %panels;

		foreach my $ref (@{$results}) {

			my $panel;
			my $ballot;

			if ($panels{$ref->{panel_id}}) {
				$panel = $panels{$ref->{panel_id}}
			} else {
				my %new_ref = %{$ref};
				$panel = \%new_ref;
				$panels{$new_ref{panel_id}} = $panel;
			}

			if ($panel->{ballots}{$ref->{judge_id}}) {
				$ballot = $panel->{ballots}{$ref->{judge_id}};
				Tab::debuglog("Existing ballot");
			} else {
				$ballot = $ref;
				Tab::debuglog("New ballot");
			}

			if (
				$entry->{event_type} eq "speech" || $entry->{event_type} eq "congress"
			) {

				if ($ref->{post_primary} == 3) {
					$panel->{rank}++;
				} else {
					delete($ref->{rank});
				}

				delete($ref->{point}) if ($ref->{post_secondary} != 3);

			} else {

				if ($ref->{post_primary} == 3) {
					Tab::debuglog("Post primary is on for round ".$ref->{name});
					$panel->{winloss} = 1;
				} else {
					delete($ballot->{winloss});
					delete($ref->{winloss});
					delete $panel->{winloss};
				}

				delete($ref->{rank}) if ($ref->{post_secondary} != 3);
				delete($ref->{point}) if ($ref->{post_secondary} != 3);

				if ($ref->{rank} && $ref->{rank_student}) {
					$panel->{scores}++;
					$ballot->{student_ranks}{$ref->{rank_student}} = $ref->{rank};
					$ballot->{total_ranks} += $ref->{rank};
					$ballot->{rank_count}++;
				}

				if ($ref->{point} && $ref->{point_student}) {
					$panel->{scores}++;
					$ballot->{student_points}{$ref->{point_student}} = $ref->{point};
					$ballot->{total_points} += $ref->{point};
					$ballot->{point_count}++;
				}
			}

			$panel->{ballots}{$ref->{judge_id}} = $ballot;
		}

		if ($entry->{event_type} eq "speech" || $entry->{event_type} eq "congress") {

			if (scalar (keys %panels)) {
</%perl>
				<div class='full flexrow'>
					<span class='threequarters'>
						<h5>Round Results</h5>
					</span>
					<span class='quarter rightalign' id="<% $entry->{spaceless} %>_buttonarea">
					</span>
				</div>

				<table id="<% $entry->{spaceless} %>">

					<thead>
						<tr>
							<th>
								Round
							</th>

							<th>
								Spoke
							</th>

							<th>
								Judging
							</th>

							<th>
								Result
							</th>

							<th>
								Scores
							</th>
						</tr>
					</thead>
					<tbody>
%			}

<%perl>
			foreach my $panel_id (
				sort {
					$panels{$b}{name} <=> $panels{$a}{name}
				} keys %panels
			) {

				my $panel = $panels{$panel_id};

				my @ballots = sort {$a <=> $b} keys %{$panels{$panel_id}{ballots}};
</%perl>
				<tr id="<% $panel_id %>">
					<td class="smallish" data-text="<% $panel->{name} %>">
						<% $panel->{label} || 'Round '.$panel->{name}  %>
					</td>

					<td class="centeralign smallish" data-text="<% $panel->{side} %>">
						<% ordinate($panel->{speakerorder}) %>
					</td>

					<td class="smallish nospace">
%						foreach my $judge_id (@ballots) {
%							my $judge = $panels{$panel_id}{ballots}{$judge_id};
							<div class='judgeheight full padleft'>
								<% $judge->{judge_last} %>, <% $judge->{judge_first} %>
							</div>
%						}
					</td>

					<td class="smallish centeralign nospace">
%						if ($panel->{rank}) {
%							foreach my $judge_id (@ballots) {
%								my $judge = $panels{$panel_id}{ballots}{$judge_id};
								<div class='judgeheight full padleft'>
									<% $judge->{rank} %>
								</div>
%							}
%						}
					</td>

					<td class="smallish centeralign nospace">
%						if ($panel->{scores}) {
%							foreach my $judge_id (@ballots) {
%								my $judge = $panels{$panel_id}{ballots}{$judge_id};
%								next unless $judge->{total_points};

								<div class='judgeheight full padleft'>
									<% $judge->{total_points} %>
								</div>
%							}
%						}
					</td>

				</tr>
%			}
%			if (keys %panels) {
				</table>
%			}

%		} else {
%			if (scalar (keys %panels)) {
				<div class='full flexrow'>
					<span class='threequarters'>
						<h5>Round Results</h5>
					</span>
					<span class='quarter rightalign' id="<% $entry->{spaceless} %>_buttonarea">
					</span>
				</div>

				<table id="<% $entry->{spaceless} %>">

					<thead>
						<tr>
							<th>
								Round
							</th>

							<th class="centeralign">
								Side/Order
							</th>

							<th>
								Opp
							</th>

							<th>
								Judging
							</th>

							<th>
								Result
							</th>

							<th>
								Scores
							</th>
						</tr>
					</thead>
					<tbody>
%			}

<%perl>
			foreach my $panel_id (
				sort {
					$panels{$b}{name} <=> $panels{$a}{name}
				} keys %panels
			) {

				my $panel = $panels{$panel_id};
				my $skip;

				my @ballots = sort {$a <=> $b} keys %{$panels{$panel_id}{ballots}};
</%perl>
				<tr id="<% $panel_id %>">

					<td class="smallish" data-text="<% $panel->{name} %>">
						<% $panel->{label} || 'Round '.$panel->{name}  %>
					</td>

					<td class="centeralign smallish" data-text="<% $panel->{side} %>">
						<div class='flexrow nospace'>
%						if ($panel->{panel_bye} || $panel->{bye}) {
%							$skip++;
							<span class='full padvert'>
								BYE
							</span>
%						} elsif ($panel->{forfeit}) {
%							$skip++;
							<span class='full padvert'>
								FORFEIT
							</span>
%						} else {
							<span class="half grow nospace">
								<% $panel->{side} == 1 ? $entry->{aff_label} || "Aff" : "" %>
								<% $panel->{side} == 2 ? $entry->{neg_label} || "Neg" : "" %>
							</span>
							<% $panel->{speakerorder}
								? '<span class="half nospace">'.ordinate($panel->{speakerorder}).'</span>'
								: ""
							%>
%						}
						</div>
					</td>

					<td class="smallish nospace padleft">
%						unless ($skip) {
						<a
							class = "plain padvertless hover padleft"
							href  = "/index/tourn/postings/entry_record.mhtml?entry_id=<% $panel->{opp_id} %>&tourn_id=<% $entry->{tourn_id} %>"
						>vs <% $panel->{opp_code} %></a>
%						}
					</td>

					<td class="smallish nospace">
%						unless ($skip) {
%							foreach my $judge_id (@ballots) {
%								my $judge = $panels{$panel_id}{ballots}{$judge_id};
								<div class='judgeheight full padleft'>
									<% $judge->{judge_last} %>, <% $judge->{judge_first} %>
								</div>
%							}
%						}
					</td>

					<td class="smallish centeralign nospace">
%						if ($panel->{winloss} > 0 && (not defined $skip)) {
%							foreach my $judge_id (@ballots) {
%								my $judge = $panels{$panel_id}{ballots}{$judge_id};
								<div class='judgeheight full padleft'>
									<% $judge->{winloss} > 0 ? "W" : "L" %>
								</div>
%							}
%						}
					</td>

					<td class="smallish centeralign nospace">
%						if ($panel->{scores}) {
%							foreach my $judge_id (@ballots) {
%								my $judge = $panels{$panel_id}{ballots}{$judge_id};
%								next unless $judge->{total_points} || $judge->{total_ranks};

								<div class='judgeheight full padleft'>
%									if ($judge->{point_count} < 2) {
										<% $judge->{total_points} %>
%									} else {
%										foreach my $student_id (sort {$a <=> $b} keys %{$judge->{student_points}}) {
											<% $entry->{students}{$student_id}{last}.", ".substr($entry->{students}{$student_id}{first}, 0, 1) %>
											<% $judge->{student_points}{$student_id} %>
%										}
%									}
%									if ($judge->{rank_count} < 2) {
										<% $judge->{total_ranks} %>
%									} else {
%										foreach my $student_id (sort {$a <=> $b} keys %{$judge->{student_ranks}}) {
											<% $entry->{students}{$student_id}{last}.", ".substr($entry->{students}{$student_id}{first}, 0, 1) %>
											<% $judge->{student_ranks}{$student_id} %>
%										}
%									}
								</div>
%							}
%						}
					</td>

				</tr>
%			}
%			if (keys %panels) {
				</table>
%			}
%		}

	</div>

