<%args>
	$tourn    => undef
	$category => undef
	$whoami   => undef
</%args>
<%init>

	return unless $tourn;

	# This should be doable as a single query but the left join isn't working
	# for some insane reason

	Tab::Category->set_sql( paradigms => "
		select category.*
		from category, category_setting
		where category.tourn = ?
		and category_setting.category = category.id
		and category_setting.tag = 'publish_paradigms'
		order by category.name
	");

	Tab::Category->set_sql( field_report => "
		select category.*
		from category, category_setting
		where category.tourn = ?
		and category_setting.category = category.id
		and category_setting.tag = 'field_report'
		order by category.name
	");

	my @paradigms = Tab::Category->search_paradigms($tourn->id);
	my @field_reports = Tab::Category->search_field_report($tourn->id);

</%init>

	<div class="menu">
	
		<div class="sidenote">

			<h4>Judges</h4>

<%perl>

			my %used;

			foreach my $ocategory (@paradigms) { 

				next if $used{$ocategory->id}++;

				Tab::JPool->columns(TEMP => "form");

				Tab::JPool->set_sql(paradigms => "
					select jpool.*, jpool_setting.value as form
					from jpool, jpool_setting
					where jpool.category = ? 
					and jpool.id = jpool_setting.jpool
					and jpool_setting.tag = 'paradigm_form'
				");

				foreach my $jpool (Tab::JPool->search_paradigms($ocategory->id)) { 
</%perl>

					<h6 class="bigger bordertop martop centeralign"><% $jpool->name %></h6>

					<a class=" <% $jpool == $ARGS{"jpool"} ? "dk" : "" %>blue full centeralign" 
						href="/index/tourn/jpool.mhtml?tourn_id=<% $tourn->id %>&jpool_id=<% $jpool->id %>">
						List &amp; Paradigms
					</a>

%					}

%				} 

%				foreach my $ocategory (@field_reports) { 

%					next if $used{$ocategory->id}++;

					<h6 class="bigger bordertop martop centeralign"><% $ocategory->name %></h6>

					<a class="<% ($ocategory->id == $category && $whoami ne "paradigm" )
						? "dk" 
						: "" %>blue half centeralign" 
						href="/index/tourn/judges.mhtml?tourn_id=<% $tourn->id %>&category_id=<% $ocategory->id %>">
						Judge List
					</a>

					<a class="<% ($ocategory->id == $category && $whoami eq "paradigm" )
						? "dk" 
						: "" %>blue half centeralign" 
						href="/index/tourn/paradigms.mhtml?tourn_id=<% $tourn->id %>&category_id=<% $ocategory->id %>">
						All Paradigms
					</a>
					

%				}
	
		</div>

	</div>

