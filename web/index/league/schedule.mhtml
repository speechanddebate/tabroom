<%args>	
	$circuit_id => undef
	$year => undef
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id) if $circuit_id;

	$m->redirect("$Tab::url_prefix") unless $circuit;

	my $now = DateTime->now;

	if ($circuit->timezone) { 
		$now->set_time_zone($circuit->timezone);
	} 

	$year = $now->year unless $year;

	my $start_year;
	my $end_year;

	if ($now->month < 7)  {
		$start_year = $year - 1;
		$end_year = $year;
	} else { 

		$start_year = $year;
		$end_year = $year + 1;

	}

	my $begin = DateTime->new( 
		year => $start_year,
		month => 7,
		day  => 01 );

	my $stop = DateTime->new(
		year => $end_year,
		month => 6,
		day => 30 );

	my @all_tournaments = Tab::Tournament->search( circuit => $circuit->id, approved => 1 );

	my @tournaments;

	foreach my $at (@all_tournaments) { 
		push (@tournaments, $at) if ($at->start > $begin && $at->end < $stop) && ($at->hidden < 1 );
	}

	@tournaments = sort {$a->start <=> $b->start } @tournaments;

	my @all_schedules = Tab::Schedule->search( circuit => $circuit->id );
	my @schedules;
	
	foreach my $as (@all_schedules) { 
		push (@schedules, $as) if ($as->start > $begin && $as->end < $stop);
	}

	@schedules = sort {$a->start <=> $b->start } @schedules;

</%init>

	<h3><% $circuit->short_name %> Schedule for <% $start_year."-".$end_year %></h3>

	<table cellpadding="5" cellspacing="1" width="100%" style="font-size: 90%">

		<tr class="redrow">

			<th>
				Name
			</th>

			<th>
				Date(s)
			</td>

			<th class="smaller">
				Reg Opens
			</th>

		</tr>

%		my $switch;

% 		foreach my $tournament (@tournaments) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<td style="font-size: 115%;">
					<a href="/index/tourn/index.mhtml?tourn_id=<%$tournament->id%>&circuit_id=<% $circuit->id %>"><% $tournament->name %></a>

%					if ($tournament->sites) { 
						<br><font size="-3">at
%						foreach my $site ($tournament->sites) { 
							<% $site->name %>
%						}
%					}
				</td>

				<td>
					<% Tab::niceshortdate($tournament->start->set_time_zone($circuit->timezone)) %> 
					<% ($tournament->start->mdy ne $tournament->end->mdy) ? " - ". Tab::niceshortdate($tournament->end->set_time_zone($circuit->timezone)) : "" %> 
				</td>

%				if ($tournament->reg_start) { 

					<td>
						<% Tab::nicedt($tournament->reg_start->set_time_zone($circuit->timezone)) %> 
					</td>

%				} else {
					<td>
					</td>
%				}

			</tr>

% 		} 

	</table>

	<table cellpadding="6" cellspacing="0" width="100%">

		<tr>
			<td colspan="5">
				<h3>Other events of interest</h3>
			</td>
		</tr>

% 		foreach my $schedule (@schedules) {

%			my $s_start = $schedule->start;
%			my $s_end = $schedule->end;
% 			$s_start->set_time_zone($circuit->timezone);
% 			$s_end->set_time_zone($circuit->timezone);

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >

				<td>
					<a href="other.mhtml?schedule_id=<% $schedule->id %>">
						<% $schedule->name %>
					</a>
				</td>

				<td>
					<% $schedule->location %>
				</td>

				<td>
					<% $s_start->mdy('/') %> <% ($s_start->mdy ne $s_end->mdy) ? " - ".$s_end->mdy('/') : "" %>
				</td>

			</tr>

% 		}

	</table>
