<%args>
	$league
	$account
	$text
	$subject
	$everybody => undef
	$members   => undef
</%args>
<%init>

	my $now = DateTime->now;
	$now->set_time_zone($league->timezone);

	my @account_ids;
	my @sendto_accounts;

    use Text::Wrap
    $Text::Wrap::columns = 72;

	$subject = "[".$league->short_name."] ".$subject;

	my $email = Tab::Email->create({ 	
		league => $league,
		subject => $subject,
		senton => $now,
		sender => $account->id });

	my $email_id = $email->id;

	my $sent_to;

	if ($everybody) { 

		$sent_to = $sent_to." Everybody ";

    	my %school_account_ids = ();

   		foreach my $chapter ($league->chapters) {
   	    	foreach my $coach ($chapter->coaches) {
      	      $school_account_ids{$coach->id}++;
      		  }
    	}

	    foreach my $list ($league->lists) {
    	    foreach my $member ($list->members) {
       	    	 $school_account_ids{$member->id}++;
       		 }
    	}

   		 foreach my $key (keys %school_account_ids) {

 		       push (@account_ids,$key);
	
   		 }

		@account_ids = keys %school_account_ids;

	} 

	if ($members) { 

		$sent_to = $sent_to." League Members";

    	my %school_account_ids = ();

   		foreach my $chapter ($league->members) {
   	    	foreach my $coach ($chapter->coaches) {
      	      $school_account_ids{$coach->id}++;
      		  }
    	}

   		 foreach my $key (keys %school_account_ids) {

 		       push (@account_ids,$key);
	
   		 }

		@account_ids = keys %school_account_ids;

	}

	unless ($everybody || $members) { 
 
		my $nowkey = DateTime::Format::MySQL->format_date($now);

		my @tournaments = $league->tournaments;

		my %send_keys = ();

		foreach my $tournament (@tournaments) { 
			my $tournament_key = "tournament_".$tournament->id;
			next unless $ARGS{$tournament_key};
			
			$sent_to = $sent_to." ".$tournament->name." entrants";
			my @schools = $tournament->schools;
			foreach my $school (@schools) {
				my @coaches = $school->chapter->coaches if $school->chapter;

				foreach my $coach (@coaches) { 
					$send_keys{$coach->id}++;
				}
			}

		}

		@account_ids = keys %send_keys;
	}

	foreach my $account_id (@account_ids) { 
		my $sendto_account = Tab::Account->retrieve($account_id);
		$m->comp( "/funclib/send_email.mas", from => $account, to => $sendto_account, subject => $subject, body => $text );
	}

	my $err = "Email has been sent";

	$m->redirect("$Tab::url_prefix/league/email_view.mhtml?email_id=$email_id&err=$err");

</%init>

