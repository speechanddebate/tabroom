<%args>
	$account
	$circuit
	$name
	$start_month
	$start_year
	$start_day
	$end_month
	$end_year
	$end_day
	$description => undef
	$location => undef
	$info => undef
	$schedule_id => undef
</%args>
<%init>

	my $err;
	my $schedule = Tab::Schedule->retrieve($schedule_id) if $schedule_id;
	my $start_date;
	my $end_date;

	eval{

		$start_date = DateTime->new(
			year => $start_year,
			month => $start_month,
			day => $start_day,
			time_zone => $circuit->timezone
		);

		$end_date = DateTime->new(
			year => $end_year,
			month => $end_month,
			day => $end_day,
			hour => "23",
			minute => "59",
			time_zone => $circuit->timezone
		);

	};

	unless ($start_date) { 
		$err = "Start date is incorrect or impossible";
	}

	unless ($end_date) { 
		$err = "End date is incorrect or impossible";
	}

	unless ( $start_date->epoch < $end_date->epoch ) { 
		$err = "Your event start date is after your end date.  Try again";
	}

	if ($err) { 
		$m->print("<h3>Error encountered:</h4><p><b>$err</b></p><p>Please hit \"back\" and try again.\n");
		$m->abort;
	}

	if ($schedule)  { 
	
		$schedule->name($name);
		$schedule->start($start_date);
		$schedule->end($end_date);
		$schedule->circuit($circuit->id);
		$schedule->location($location);
		$schedule->description($description);
		$schedule->update;
	
		$err = "Changes to ". $name ." saved";

		if ($info) { 
    	    my $req = Apache2::Request->new($r);
    	    my $upload = $req->upload("info");
   		    my $filename  = $upload->filename;
			$filename =~ s/.*[\/\\](.*)/$1/;
			$filename =~ s/\ //g;
			$filename =~ s/\'//g;  # '  stupid vim
 			my $filepath = "$Tab::file_root/files/".$circuit->id."/schedule/".$schedule->id."/$filename";
			my $command = "mkdir -p $Tab::file_root/files/".$circuit->id."/schedule/".$schedule->id;
			my $garbage = `$command`;
			my $filetemp = $upload->tempname;
			`cp $filetemp $filepath`;
			$schedule->file($filename);
			$schedule->update;
		}

		$m->redirect("$Tab::url_prefix/circuit/schedule_edit.mhtml?err=$err&schedule_id=".$schedule->id);

	} else {  

		$schedule = Tab::Schedule->create( { 
			name => $name,
			circuit => $circuit->id,
			location => $location,
			description => $description,
			start => $start_date,
			end => $end_date
		});

		$schedule_id = $schedule->id;

		if ($info) { 
    	    my $req = Apache2::Request->new($r);
    	    my $upload = $req->upload("info");
   	   		my $filename  = $upload->filename;
			$filename =~ s/.*[\/\\](.*)/$1/;
			$filename =~ s/\ //g;
			$filename =~ s/\'//g;  # ' BAH!
	 		my $filepath = "$Tab::file_root/files/".$circuit->id."/schedule/".$schedule->id."/$filename";
			my $command = "mkdir -p $Tab::file_root/files/".$circuit->id."/schedule/".$schedule->id;
			my $garbage = `$command`;
			my $filetemp = $upload->tempname;
			`cp $filetemp $filepath`;
			$schedule->file($filename);
			$schedule->update;
		}

		$err =  $name ." created";

	}

	$m->redirect("$Tab::url_prefix/circuit/schedule_edit.mhtml?schedule_id=".$schedule->id."&err=$err");

</%init>
