<%args>
	$circuit
	$account
</%args>
<%init>

	my @chapters = $circuit->chapters;

	foreach my $chapter (@chapters)  {

		my $chapter_id = $chapter->id;

		my $namekey = "name_".$chapter->id;
		my $statekey = "state_".$chapter->id;
		my $codekey = "code_".$chapter->id;
		my $activekey = "active_".$chapter->id;

		next unless $ARGS{$namekey};

		my @memberships = Tab::ChapterCircuit->search( chapter => $chapter->id, circuit => $circuit->id);

		my $membership = shift @memberships;
		
		$membership->code($ARGS{$codekey});
		$membership->active($ARGS{$activekey});
		$membership->update;

		foreach my $mem (@memberships) { 
		
			$mem->delete;
		}

		$chapter->name($ARGS{$namekey}) if $ARGS{$namekey};
		$chapter->state($ARGS{$statekey}) if $ARGS{$statekey};
		$chapter->update;

	}

	$m->redirect("$Tab::url_prefix/circuit/chapter_search.mhtml?search_field=all");

</%init>
