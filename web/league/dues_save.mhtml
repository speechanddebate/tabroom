<%args>
	$circuit
</%args>
<%init>

	my $now = DateTime->now;

	foreach my $membership ($circuit->memberships) {
		
		my @cms = $membership->chapter_memberships(full_member => 1);

		foreach my $cm (@cms) { 

			my $paid = $ARGS{$cm->id."_dues"};

		    my $school_year = &Tab::school_year;

		    my @dues = Tab::Dues->search_where(
		                chapter => $cm->chapter->id,
		                circuit => $circuit->id,
		                paid_on => {">=", $school_year}
			);
		
			my $total = 0;
		    foreach (@dues) { $total += $_->amount; }

			my $diff = $paid - $total;

			if ($diff) { 

				Tab::Dues->create({
					chapter => $cm->chapter->id,
					circuit => $circuit->id,
					amount => $diff,
					paid_on => $now
				});

			}

			$cm->paid($ARGS{$cm->id."_paid"}); 
			$cm->update;

		}

	}

	my $msg = " Due payments saved ";

	$m->redirect("/circuit/dues_record.mhtml?msg=$msg");


</%init>
