<%args>
	$tourn
	$person
	$tiebreak_set_id => undef
</%args>
<%init>

	my $tiebreak_set = Tab::TiebreakSet->retrieve($tiebreak_set_id) 
		if $tiebreak_set_id;

	my %tb_setting = $tiebreak_set->all_settings if $tiebreak_set;

</%init> 

	<script>

		function showSpecificRound() { 

			$(".countSelector").each(function() { 

				var tbsetID = $(this).attr("tb_set");
				var count = $(this).find(":selected").val();

				if (count === "specific") {
					$(".specificbox_"+tbsetID).removeClass("hidden");
				} else {
					$(".specificbox_"+tbsetID).addClass("hidden");
				}

			}); 
		};

		function showComposites() { 

			$(".tbSelector").each(function() { 

		        var tiebreaker = $(this).find(":selected").val();
				var tbsetID = $(this).attr("tb_set");

				if (   tiebreaker === "ranks" 
					|| tiebreaker === "reciprocals"
					|| tiebreaker === "downs"
				) {

					$(".ranksbox_"+tbsetID).removeClass("hidden");
				} else {
					$(".ranksbox_"+tbsetID).addClass("hidden");
				}

			}); 
		};

		function showCompositeTbs() { 

			$(".compositeSelector").each(function() { 
		        var checked = $(this).prop("checked");
				var tbsetID = $(this).attr("tb_set");

				console.log("Set "+tbsetID+" is checked value: "+checked);

				if (checked) { 
					$(".compositebox_"+tbsetID).removeClass("hidden");
				} else {
					$(".compositebox_"+tbsetID).addClass("hidden");
				}
			});
		};

		$(document).ready(function(){
			showSpecificRound();
			showComposites();
			showCompositeTbs();
			$(".compositebox").addClass('hidden');
		});

	</script>

	<div class="main">
			
		<h4><% $tourn->name %></h4>

		<& tabbar.mas, 
			tourn => $tourn, 
			whoami => "tiebreaks" 
		&>

		<div class='pagefull nospace'>

			<span class="twothirds nospace semibold">

				<h4><% $tiebreak_set ? $tiebreak_set->name : "Create Tiebreak Set:" %></h4>

			</span>

			<span class="third rightalign">

%				if ($tiebreak_set) { 

%					my $warn = "You are about to delete this tiebreaker set.  That may cause terrible, terrible damage.  Are you sure?";

						<a 
							class = "redtext buttonwhite centeralign nowrap hover"
							href  = "tiebreak_set_rm.mhtml?set_id=<% $tiebreak_set->id %>"
							title = "Delete <% $tiebreak_set->name %> tiebreakers"

							<& "/funclib/confirm.mas", warn => $warn &>  
						>
							<span class="inline fa fa-trash"></span>
						</a>
%					}
			</span>

		</div>

			<form 
				action = "tb_set_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "tiebreak_set_id"
				value = "<% $tiebreak_set_id %>"
			>

			<div class="liblrow pagefull marno rightalign">

				<span class="third padleft semibold bluetext">
					Name of Tiebreaker Set
				</span>

				<span class="twothirds centeralign">
					<input 
						type        = "text"
						size        = "48"
						name        = "name"
						value       = "<% $tiebreak_set ? $tiebreak_set->name : "" %>"
						placeholder = "Tiebreak set name"
					>
				</span>

			</div>

		<span class="pagehalf">

			<label for="truncate_to_smallest">

				<div class="row hover">

					<span class="seveneighth padleft">
						Truncate all IE ranks to size of smallest section
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "truncate_to_smallest"
							name  = "truncate_to_smallest"
							value = "1"
							<% $tb_setting{"truncate_to_smallest"} ? 'checked="checked"' : "" %>
						>
					</span>
				</div>
			</label>

			<div class="row hover">

				<label for="truncate_ranks_to">
					<span class="fivesixth padleft">
						Truncate all IE ranks/recips to 
					</span>
					<span class="sixth">
						<input 
							type  = "number"
							id    = "truncate_ranks_to"
							name  = "truncate_ranks_to"
							size  = "3"
							min   = "0"
							max   = "99"
							class = "smaller"
							value = "<% $tiebreak_set ? $tb_setting{"truncate_ranks_to"} : "" %>"
						>
					</span>
				</label>
			</div>

			<div class="row">
				<span class="twofifth padleft">
					Truncate all IE ranks/recips in:
				</span>

				<span class="threefifth nowrap">	

					<label for="truncate_prelims">
						<span class="third hover smallish nowrap nospace">
							<input 
								type  = "checkbox"
								id    = "truncate_prelims"
								name  = "truncate_prelims"
								value = "1"
								<% $tb_setting{"truncate_prelims"} ? 'checked="checked"' : "" %> 
							> Prelim
						</span>
					</label>

					<label for="truncate_elims">
						<span class="third hover smallish nowrap nospace">

							<input 
								type  = "checkbox"
								id    = "truncate_elims"
								name  = "truncate_elims"
								value = "1"
								<% $tb_setting{"truncate_elims"} ? 'checked="checked"' : "" %>
							> Elim
						</span>

					</label>

					<label for="truncate_finals">
						<span class="third hover smallish nowrap nospace">
							<input 
								type  = "checkbox"
								id    = "truncate_finals"
								name  = "truncate_finals"
								value = "1"
								<% $tb_setting{"truncate_finals"} ? 'checked="checked"' : "" %> 
							> Final
						</span>
					</label>
				</span>
			</div>
		</span>

		<span class="pagehalf">

			<div class="row hover">

				<label for="equal_elims">

					<span class="seveneighth padleft">

						Advance equal entries from each section

						<p class="smallish explain marno padless">
							Use only in IE Elims &amp; Congress
						</p>
					</span>

					<span class="eighth smallish">
						<input 
							type  = "checkbox"
							id    = "equal_elims"
							name  = "equal_elims"
							value = "1"
							<% $tb_setting{"equal_elims"} 
								? 'checked="checked"' 
								: ""
							%>
						>
					</span>

				</label>
			</div>

			<div class="row hover">
				<label for="forfeits_never_break">

					<span class="seveneighth padleft">
						No shows/forfeits place last
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "forfeits_never_break"
							name  = "forfeits_never_break"
							value = "1"
							<% $tb_setting{"forfeits_never_break"} 
								? 'checked="checked"' 
								: ""
							%> 
						>
					</span>
				</label>
			</div>

			<div class="row hover">

				<label for="mfl_time_violation">

					<span class="seveneighth padleft">
						IE Time Violation penalty (+1 rank)
					</span>
					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "mfl_time_violation"
							name  = "mfl_time_violation"
							value = "1"
							<% $tb_setting{"mfl_time_violation"} 
								? 'checked="checked"' 
								: ""
							%>
						>
					</span>
				</label>
			</div>

			<div class="row hover">

				<label for="tie_middle_rank">

					<span class="seveneighth padleft">
						3x Composite Ties get Middle Rank (CA)
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "tie_middle_rank"
							name  = "tie_middle_rank"
							value = "1"
							<% $tb_setting{"tie_middle_rank"} 
								? 'checked="checked"' 
								: ""
							%>
						>
					</span>
				</label>
			</div>



		</span>

		<div class="liblrow pagefull marno rightalign">
			<input 
				type  = "submit"
				value = "<% $tiebreak_set ? "Save Settings" : "Create Tiebreak Set" %>"
			>
			</form>
		</div>


%		if ($tiebreak_set) { 
			
			<h4 class="martopmore">Tiebreaks in order</h4>


<%perl>
			
			my $prime;

	   		foreach my $tiebreak (
				sort {$a->priority <=> $b->priority} 
					Tab::Tiebreak->search(tiebreak_set => $tiebreak_set->id)
			) {

				$prime = $tiebreak->priority if $tiebreak->priority > $prime;

				my $highlow;

				my $highlow_count = $tiebreak->highlow_count;

				$highlow_count = 1 unless $highlow_count;

				$highlow = ", except the ".$highlow_count." best &amp; worst" 
					if $tiebreak->highlow == 1;

				$highlow = ", except the ".$highlow_count." best" 
					if $tiebreak->highlow == 3;

				$highlow = ", except the ".$highlow_count." worst" 
					if $tiebreak->highlow == 4;

				my $name = $tiebreak->name;
				
				if ($name eq "nsda_points") { 

					$name = "NSDA Points";

				} elsif ($name eq "seed") { 

					$name = "Prelim Seed";

				} else { 
					$name =~ s/_/ /g;
					$name = ucfirst($name);
				}

</%perl>
				<div class="pagefull row ltborder">

					<span class="threequarters">
						 <% $tiebreak->priority %>. 
%						if ($name eq "Rounds") { 
							Last round competed in
%						} elsif ($name eq "NSDA Points") { 
							<% $name %>
%						} elsif ($name eq "Prelim Seed") { 
							<% $name %>
%						} else { 
							<% $name %>
%							if ($tiebreak->count eq 'specific') { 
								 score from Round #<% $tiebreak->count_round %>
%							} else { 
								 score from <% $tiebreak->count %> round(s)
%							}
							 <% $tiebreak->truncate 
							 	? " truncated to ".$tiebreak->truncate 
								: ""
							%> <%
								$highlow
							%> <% 
								($tiebreak->multiplier > 1) 
							 		? ", multiplied by ".$tiebreak->multiplier 
									: ""
							%> <% 
								$tiebreak->child > 0 
								 	? ", composite on ".$tiebreak->child->name 
									: "" 
							%>
%						}
					</span>

					<span class="eighth rightalign">
            	    	<a 
							class="bluetext button hover buttonwhite fa fa-sm fa-edit"
							onClick="$('.<% $tiebreak->id %>').toggleClass('hidden');"
						></a>
					</span>

					<span class="eighth rightalign">
            	    	<a 
							class="redtext button hover buttonwhite fa fa-sm fa-trash"
							href="tiebreak_rm.mhtml?tiebreak_id=<% $tiebreak->id %>"
						></a>
					</span>

				</div>

				<div class="centeralign padleft ltborder pagefull hidden <% $tiebreak->id %>">

					<h5 class="leftalign">Edit tiebreak <% $tiebreak->name %>:</h5>

					<& "tiebreak_edit.mas", 
						tiebreak     => $tiebreak,
						tiebreak_set => $tiebreak_set
					&>
				</div>

%			}

%			$prime++;

			<div class="martopmore pagefull">

				<h5 class="martopmore">Add new tiebreaker:</h5>

				<& "tiebreak_edit.mas", 
					tiebreak_set => $tiebreak_set,
					prime        => $prime
				&>
			</div>

%		}
	</div>

	<div class="menu">

<%perl>

		my @sets = 
			sort {$a->name cmp $b->name} 
			Tab::TiebreakSet->search(tourn => $tourn->id);

</%perl>

		<div class="sidenote">

			<h4>Tiebreak sets</h4>

				<a 
					class = "yellow full marbottom"
					href  = "tiebreaks.mhtml"
				>
					Add a new set
				</a>

%				foreach my $tiebreak_set (@sets) { 
					<a 	
						class = "<% $tiebreak_set_id == $tiebreak_set->id ? "dk" : "" %>blue full" 
						href  = "tiebreaks.mhtml?tiebreak_set_id=<% $tiebreak_set->id %>"
					>
						<% $tiebreak_set->name %>
					</a>
%				}

			<br />

			<h4 class="martop">Explain, Please</h4>

				<p>

					Create a tiebreak set for each type of advancement you wish
					to have; for example, one set for Debate Prelims, one for
					Debate Elims, one for IE Prelims, one for IE Elims, and one
					for Debate Top Speakers.

				</p>

				<a 
					href  = "tiebreaks_explain.mhtml"
					class = "yellow full"
				>
					Guide to Tiebreakers
				</a>

		</div>

	</div>
