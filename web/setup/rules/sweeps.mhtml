<%args>
	$tourn
	$set_id => undef
</%args>
<%init>

	my $switch;
	my (%cume_settings) = $m->comp("/funclib/tourn_cume_sweeps.mas", tourn => $tourn);
	my (%place_settings) = $m->comp("/funclib/tourn_place_sweeps.mas", tourn => $tourn);
    my $numero = keys %cume_settings;

</%init>

	<& sidebar.mas, tourn => $tourn, chosen => "sweeps", set_id => $set_id &>

	<div class="left huge">

		<h2>Team Awards/Sweepstakes </h2>

%		if ($set_id) { 

%			my $set = Tab::SweepSet->retrieve($set_id);


			<span class="oddrow block greynohover">

				<form action="sweep_set_save.mhtml" method="post">

				<span class="inline">
					<h5>Name of sweepstakes ruleset:</h5>
				</span>

				<span class="inline">
					<input type="text" name="name" value="<% $set->name %>" size="25">
				</span>

				<span class="smaller inline" style="margin-top: 1px; margin-left: 15px;">
					<input type="hidden" name="set_id" value="<% $set->id %>">
					<input type="submit" class="thin" value="Save">
				</span>

				</form>

			</span>

			<div class="left third">

				<h4>Limits</h4>

					<form action="sweep_limits.mhtml" method="post">
					<input type="hidden" name="set_id" value="<% $set->id %>">

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block nohover ">

						<span class="smallish huntwofive wrap">
							Entries counted across all events
						</span>

						<input type="text" min="0" max="999" size="4" name="entries" value="<% $set->rule("entries") %>" class="thin">

					</span>

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block nohover ">

						<span class="smallish huntwofive wrap">
							Entries counted per event
						</span>

						<input type="text" min="0" max="999" class="thin" size="4" name="event_entries" value="<% $set->rule("event_entries") %>" >

					</span>

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block nohover ">

						<span class="smallish huntwofive wrap">
							Events to count
						</span>

						<input type="text" min="0" max="999" size="4" class="thin" name="events" value="<% $set->rule("events") %>" >

					</span>

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block nohover">

						<span class="smallish huntwofive wrap">
							Wildcards (entries
							counted beyond limits)
						</span>

						<input type="text" min="0" max="999" class="thin" size="4" name="wildcards" value="<% $set->rule("wildcards") %>" >

					</span>

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block greynohover ">

						<span class="smallish huntwofive wrap">
							<label for="novice_only">
							Novices only
							</label>
						</span>

						<input type="checkbox" id="novice_only" class="largecheck" name="novice_only" value="1" <% $set->rule("novice_only") ? 'checked="checked"' : "" %>>

					</span>

					<div class="liblrow rightalign clear padmore">
						<input type="submit" class="thin" value=" Save Limits ">
						</form>
					</div>

			</div>

			<div class="left third">

				<h4>Events in ruleset</h4>

%				my %used = ();

%				foreach my $event (sort {$a->name cmp $b->name} $set->events) { 

%					$used{$event->id} = $event;

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block smallish padless">
						<span class="huntwofive">
							<% $event->name %>
						</span>
						<span class="smallerspan centeralign">
							<a class="dkred padless block" href="sweep_event_rm.mhtml?event_id=<% $event->id %>&set_id=<% $set->id %>">
								Del
							</a>
						</span>
					</span>
%				}

				<span class="oddrow block liblrow smallish">

					<form action="sweep_event_add.mhtml" method="post">
					<input type="hidden" name="set_id" value="<% $set->id %>">

					<span class="evensmallerspan">
						Add:
					</span>

					<select name="event_id" onchange='this.form.submit()' class="fixedsmall">
						<option value="">Select to add</option>
						<option value="all">All events</option>
						 
%							foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 
%								next if $used{$event->id};
							<option value="<% $event->id %>">
								<% $event->name %>
							</option>
%							}
					</select>

					<noscript>
					<span class="smallspan">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="submit" class="thin" value="Save">
					</span>
					</noscript>
					</form>

				</span>
				
			</div>

			<div class="left third">

%				my %round_used = ();

				<h4>Rounds excluded</h4>

%				foreach my $rule (sort {$a->tag cmp $b->tag} $set->rules( tag => "ignore_round")) { 

%					my $round = Tab::Round->retrieve($rule->value);
%					next unless $round;
%					$round_used{$round->id}++;

					<span class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block smallish padless">
						<span class="huntwofive">
							<% $round->event->abbr %> <% $round->realname %>
						</span>
						<span class="smallerspan centeralign">
							<a class="dkred padless block" href="sweep_round_rm.mhtml?round_id=<% $round->id %>&set_id=<% $set->id %>">
								Del
							</a>
						</span>
					</span>
%				}

				<span class="oddrow block liblrow smallish">

					<form action="sweep_round_add.mhtml" method="post">
					<input type="hidden" name="set_id" value="<% $set->id %>">

					<span class="evensmallerspan">
						Add:
					</span>

					<select name="round_id" onchange='this.form.submit()' class="fixedsmall">
						<option value="">Select</option>
%							foreach my $event_id (sort keys %used) { 
%								my $event = $used{$event_id};
								<optgroup label="<% $event->name %>">
%								foreach my $round ($event->rounds) {
%									next if $round_used{$round->id};
									<option value="<% $round->id %>">
										<% $round->realname %>
									</option>
%								}
%							}
					</select>

					<noscript>
					<span class="smallspan">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="submit" class="thin" value="Save">
					</span>
					</noscript>
					</form>

				</span>
				

			</div>

			<br style="clear: both;" />
		
%			if ($set->rules) { 
				<h4>Rules in set</h4>
%			}

%			undef $switch;

			<table cellpadding="4" cellspacing="1" width="100%">

%				foreach my $rule (sort {$a->tag cmp $b->tag} $set->rules) { 

%					my $tag = $rule->tag;

%					next if $tag eq "novice_only";
%					next if $tag eq "events";
%					next if $tag eq "entries";
%					next if $tag eq "event_entries";
%					next if $tag eq "wildcards";
%					next if $tag eq "ignore_round";
%					my $index = index($tag, 'rev_');

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							<% $switch %>.
						</td>

						<td class="smallish">
%							if ($rule->value && $index != 0 ) { 
								<% $rule->value %> point<% $rule->value == 1 ? "" : "s" %> for
%							}
						</td>

						<td class="smallish">
							<% $tag eq "points_per_prelim" ? "Prelim round appearance" : "" %>
							<% $tag eq "points_per_elim" ? "Elim round appearance" : "" %>
							<% $tag eq "points_per_final" ? "Final round appearance" : "" %>
							<% $tag eq "rev_per_elim_rank" ? "6 minus each rank in elim rounds" : "" %>
							<% $tag eq "rev_per_final_rank" ? "6 minus each rank in the final round" : "" %>
							<% $tag eq "rev_per_prelim_rank" ? "6 minus each rank in prelim rounds" : "" %>
							<% $tag eq "rev_per_prelim_rank_sansworst" ? "6 minus each rank in prelim rounds, dropping the worst" : "" %>
							<% $tag eq "rev_per_elim_place" ? "6 minus placement in elim rounds" : "" %>
							<% $tag eq "rev_per_final_place" ? "6 minus placement in the final round" : "" %>
							<% $tag eq "rev_per_overall_place" ? "6 minus placement overall" : "" %>
							<% $tag eq "debate_win" ? "Prelim win (debate)" : "" %>
							<% $tag eq "place" ? Lingua::EN::Numbers::Ordinate::ordinate($rule->place)." place overall" : "" %>
							<% $tag eq "cume" ? "Prelim cumulative ranks of ".$rule->place : "" %>
							<% $tag eq "manual" ? "Count manually-entered sweeps points (under Tabulation)" : "" %>
						</td>

						<td class="centeralign">
							<a class="dkred block" href="sweep_rule_rm.mhtml?rule_id=<% $rule->id %>">
								DELETE
							</a>
						</td>

					</tr>
%				}

			</table>

			<br style="clear: both;" />

			<h4>
				Add new rule:
			</h4>
			
			<table cellpadding="3" cellspacing="1" width="100%">

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						Points Per Round Participated In
					</td>

					<td class="smallish">
						Type:
						<select name="tag">
							<option value="points_per_prelim">Prelim Round</option>
							<option value="points_per_elim">Elim Round</option>
							<option value="points_per_final">Final Round</option>
						</select>
					</td>

					<td class="smallish">
						Points: <input type="number" name="points" size="5" min="1" max="3">
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="points" value="1">
						Count reverse points (6-rank) for
					</td>

					<td colspan="2">
						<select name="tag" class="fixed">
							<option value="rev_per_prelim_rank">Each Rank in Prelim Rounds</option>
							<option value="rev_per_prelim_rank_sansworst">Each Rank in Prelim Rounds, Dropping the Worst</option>
							<option value="rev_per_elim_rank">Each Rank in Elim Rounds</option>
							<option value="rev_per_final_rank">Each Rank in the Final Round</option>
							<option value="rev_per_elim_place">Placement in each Elim Round</option>
							<option value="rev_per_final_place">Placement in the Final Round</option>
							<option value="rev_per_overall_place">Placement Overall</option>
						</select>
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						Give points for a debate win
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="debate_win">
					</td>

					<td>
					</td>

					<td class="smallish">
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						Give points for prelim cumulative score
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="cume">
					</td>

					<td class="smallish">
						Score:
						<input type="number" name="place" max="99" min="1" size="5">
					</td>

					<td class="smallish">
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						Give points for final overall placement
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="place">
					</td>

					<td class="smallish">
						Place:
						<input type="number" name="place" max="99" min="1" size="5">
					</td>

					<td class="smallish">
						Points:
						<input type="number" name="points" max="99" min="1" size="5">
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td colspan="3" class="smallish">
						Manually entered points (under Tab -> Sweeps)
						<form action="sweep_rule_save.mhtml">
						<input type="hidden" name="set_id" value="<% $set->id %>">
						<input type="hidden" name="tag" value="manual">
					</td>

					<td>
						<input type="submit" class="thin" value="Add">
						</form>
					</td>

				</tr>

			</table>


%		} else { 

			<h4>Choose a set at right</h4>

%		}

	</div>

