<%args>
	$person
	$target_id 		=> undef
	$property_name  => undef
</%args>
<%init>

	my $category = $target_id;
	my $event_id = $property_name;

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($event_id) {
		$m->print('{ "error": true, "message": "No event ID sent"}');
		$m->abort();
	}

	my $event = Tab::Event->retrieve($event_id);

	unless ($category) {
		$m->print('{ "error": true, "message": "No category to change sent"}');
		$m->abort();
	}

	my %event_settings = $event->all_settings;

	my %bill_categories = eval {
		return %{ JSON::decode_json($event_settings{"bill_categories"})};
	};

	unless (exists $bill_categories{$category}) {
		$m->print('{ "error": true, "message": "Category '.$category.' not found!"}');
		$m->abort();
	}

	delete($bill_categories{$category});

	my $json = eval {
		return JSON::encode_json(\%bill_categories);
	};

	if ($json) {
		$event->setting("bill_categories", "text", $json);
	} else {
		$event->setting("bill_categories", 0);
	}

	my $msg = "Category ".$category." deleted";
	my $err = "";

	$m->print('{ "error": false, "message": "Category '.$category.' deleted"}');
	$m->abort();

</%init>
