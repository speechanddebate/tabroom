<%args>
	$tourn
	$person
</%args>
<%init>

	my $disagreements;

	my @categories = $tourn->categories;

	my %weekends_by_id = map {$_->id => $_} $tourn->weekends();

	my %category_weekend =
		map {$_->id => $weekends_by_id{$_->setting("weekend")}}
		@categories;

	my %event_weekend = ();

	my @check_events;

	foreach my $event ($tourn->events) {

		next unless $ARGS{$event->id};

		$event_weekend{$event->id} = $weekends_by_id{$event->setting("weekend")};

		if ($event_weekend{$event->id} ne $ARGS{$event->id} ) {

			my $description;

			unless ($ARGS{$event->id} eq "nope") {
				my $weekend = Tab::Weekend->retrieve($ARGS{$event->id});
				$description = "Weekend for ".$event->abbr." changed to ".$weekend->name;
			} else {

				$description = $event->abbr." changed to not held";
			}

			unless ($ARGS{$event->id} eq "nope") {
				if ($ARGS{$event->id."_category"}
					&& $category_weekend{$ARGS{$event->id."_category"}}
						== $ARGS{$event->id}
				) {

					$event->category($ARGS{$event->id."_category"});
					$event->update();

				}
			}

			$event_weekend{$event->id} = $weekends_by_id{$ARGS{$event->id}};

			if (
				($ARGS{$event->id} == $category_weekend{$event->category->id})
				|| ($ARGS{$event->id} eq "nope")
			) {

				$m->comp("/funclib/log.mas",
					type        => 'districts',
					tourn       => $tourn->id,
					person      => $person->id,
					description => $description
				);

				$event->setting("weekend", $ARGS{$event->id});

			} else {

				push @check_events, $event;

			}

		}

	}

	unless (@check_events) {

		my $msg = "Event date set assignments saved";
		$m->redirect("district_dates.mhtml?msg=$msg");

	}

</%init>

	<div class="menu">

		<div class="sidenote">

%			my $msg = "Your changes of weekend were not saved.";

			<h4>Return without saving</h4>

			<a
				class="blue full"
				href="district_dates.mhtml?msg=<% $msg %>"
			>Return without saving changes</a>
		</div>
	</div>

	<div class="main">

		<h4>Category/dates disagreement</h4>

		<p>

			All the events of a single judge category must be held on the same
			district weekend.  If you split your debate events across two
			weekend/dates, they have to have separate judge categories (or else
			the same judge will be unable to judge on both weekends).
		</p>

		<p>
			Before you can change the dates of the following events, they must
			also have a judge category that is assigned to that weekend.
		</p>

		<form
			action = "district_weekend_events.mhtml"
			method = "post"
		>

		<div class="full row marno yellowrow smallish strong">

			<span class="quarter">
				Event
			</span>

			<span class="quarter">
				New Weekend
			</span>

			<span class="quarter">
				Present Judge Category
			</span>

			<span class="quarter">
				New Judge Category
			</span>

		</div>

%		foreach my $event (@check_events) {

			<input
				type  = "hidden"
				name  = "<% $event->id %>"
				value = "<% $event_weekend{$event->id} %>"
			>

			<div class="full row marno">

				<span class="quarter semibold">
					<% $event->name %>
				</span>

				<span class="quarter">
					<% $event_weekend{$event->id}
					   ? $event_weekend{$event->id}->name
					   : ""
					%>
				</span>

				<span class="quarter">
					<% $event->category->name %>
				</span>

				<span class="quarter">

					<select
						name  = "<% $event->id %>_category"
						class = 'fixedmed'
					>

<%perl>
						my $ok;

						foreach my $category ($tourn->categories) {

							next unless $event_weekend{$event->id};
							next unless $category_weekend{$category->id} == $event_weekend{$event->id}->id;
							$ok++;
</%perl>
							<option
								value="<% $category->id %>"
							><% $category->name %></option>

%						}

					</select>
				</span>


			</div>

%		}

		<div class="liblrow rightalign">

			<input
				type="submit"
				value="Save changes"
			>
			</form>

		</div>

	</div>
