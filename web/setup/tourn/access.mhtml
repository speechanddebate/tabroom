<%args>
	$person
	$tourn
	$tourn_settings
	$perms
</%args>
<%init>

	$m->abort if $perms->{"details"} || $perms->{"entry_only"};

	my @admins;

	my %admin_perms = ();

	foreach my $perm (
		Tab::Permission->search( tourn => $tourn->id )
	) { 
		next if $perm->tag eq "detailed";
		$admin_perms{$perm->person->id}{$perm->tag} = $perm;
		push @admins, $perm->person;
	}
	
	my %seen = (); 
	@admins = grep { ! $seen{$_->id} ++ } @admins;

	@admins = 
		sort {
			$admin_perms{$b->id}{"entry_only"}
			<=> $admin_perms{$a->id}{"entry_only"}
		} @admins;

	@admins = 
		sort {
			$admin_perms{$b->id}{"limited"}
			<=> $admin_perms{$a->id}{"limited"}
		} @admins;

	@admins = 
		sort {
			$admin_perms{$b->id}{"full_admin"}
			<=> $admin_perms{$a->id}{"full_admin"}
		} @admins;

	@admins = 
		sort {
			$admin_perms{$b->id}{"contact"}
			<=> $admin_perms{$a->id}{"contact"}
		} @admins;

	@admins = 
		sort {
			$admin_perms{$b->id}{"owner"}
			<=> $admin_perms{$a->id}{"owner"}
		} @admins;

    my %links = (
		"overall" => "access.mhtml",
		"by_event" => "event_access.mhtml"
	);


</%init>

	<script type="text/javascript">

		function concealGreens (id, type) { 
			$(".leveler_"+id).removeClass('green', "fold");
			$("#"+id+"_"+type+"box").addClass('green');
		}

        function showLimits (it, radio, type) { 
			if (radio.checked) { 
				$("#"+it).show("fold");
			} else { 
				$("#"+it).hide("fold");
			}

			concealGreens(it, type);
        } 

        function hideLimits (it, radio, type) { 
			if (radio.checked) { 
				$("#"+it).hide("fold");
			}

			concealGreens(it, type);
		}
    </script>

	<div class="main">
	
		<h3><% $tourn->name %></h3>

		<& "tabbar.mas", 
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "access"
		&>

		<span class="half">
			<h4>Administrator Access</h4>
		</span>

		<span class="third centeralign">
            <&
                "/funclib/tabs.mas",
                    links   => \%links,
                    default => "overall",
                    center  => "yes",
                    buttons => "yes"
            &>
		</span>

		<span 
			id    = "access_buttonarea"
			class = "sixth rightalign marno"
		></span>

		<& 
			"/funclib/tablesorter.mas", 
			table => "access"
		&>

		<form 
			action = "access_save.mhtml"
			method = "post"
		>

		<table id="access">

%			if (@admins) { 
	
				<thead>

				<tr class="yellowrow">
				
					<th class="smallish">	
						Person
					</th>

					<th 
						title = "Accounts marked as contact will have their email on the tourn website"
						class = "smallish"
					>Contact</th>

					<th class="smallish">
						Access Level
					</th>

					<th class="smaller">
					</th>
				
				</tr>

				</thead>

				<tbody>

% 				foreach my $admin (@admins) { 

					<tr>
	
						<td
							title = "<% $admin->email %>"
							class = "limit smallish hover"
						>
							<% $admin->first." ".$admin->last %>
						</td>

						<label for="<% $admin->id %>_contact">

							<td class="centeralign nospace">

								<span class="hidden">
									<% $admin_perms{$admin->id}{"contact"} ? '1' : "" %>
								</span>

								<label for="<% $admin->id %>_contact">
									<span class="padvertless full marno hover">
										<input 
											type  = "checkbox"
											name  = "<% $admin->id %>_contact"
											value = "1"
											id    = "<% $admin->id %>_contact"
											<% $person->site_admin 
												|| $admin_perms{$person->id}{"owner"} 
												|| $admin_perms{$person->id}{"contact"} 
												? "" : 'disabled'
											%>
											<% $admin_perms{$admin->id}{"contact"} 
												? 'checked="checked"' 
												: ""
											%>
										>
									</span>
								</label>
							</td>
						</label>

						<td class="centeralign padno smallish">

							<span class="hidden">  <!-- for sorting -->
								<% $admin_perms{$admin->id}{"owner"} ? '1' : "" %>
								<% $admin_perms{$admin->id}{"full_admin"} ? '2' : "" %>
								<% $admin_perms{$admin->id}{"limited"} ? '3' : "" %>
								<% $admin_perms{$admin->id}{"entry_only"} ? '4' : "" %>
							</span>

%							if ($admin_perms{$person->id}{"owner"} || $person->site_admin) { 

								<label for="<% $admin->id %>_owner">
								<span 
									id    = "<% $admin->id %>_ownerbox"
									class = "quarter padless marno hover leveler_<% $admin->id %> 
											 <% $admin_perms{$admin->id}{"owner"} ? 'green' : "" %>"
								>
									Owner 
										<input 
											type    = "radio"
											id      = "<% $admin->id %>_owner"
											name    = "<% $admin->id %>_level"
											value   = "owner"
											onclick = "hideLimits(<% $admin->id %>, this, 'owner')"
											<% $admin_perms{$admin->id}{"owner"} ? 'checked="checked"' : "" %>
										>

								</span>

								</label>

%							} elsif ($admin_perms{$admin->id}{"owner"}) {
								Tournament Owner
%							} 

<%perl>
							unless ($admin_perms{$admin->id}{"owner"} 
								&! ($admin_perms{$person->id}{"owner"} 
								|| $person->site_admin)
							) { 
</%perl>

								<label for="<% $admin->id %>_full_admin">
									<span 
										id    = "<% $admin->id %>_full_adminbox"
										class = "quarter padless marno hover leveler_<% $admin->id %> 
										<% $admin_perms{$admin->id}{"full_admin"} ? 'green' : "" %>"
									>

										Admin 
										<input 
											type    = "radio"
											id      = "<% $admin->id %>_full_admin"
											name    = "<% $admin->id %>_level"
											value   = "full_admin"
											onclick = "hideLimits(<% $admin->id %>, this, 'full_admin')"
											<% $admin_perms{$admin->id}{"full_admin"} ? 'checked="checked"' : "" %>
										>

									</span>
								</label>

								<label for="<% $admin->id %>_limited">
									<span 
										id    = "<% $admin->id %>_limitedbox"
										class = "quarter padless marno hover leveler_<% $admin->id %>
											<% $admin_perms{$admin->id}{"limited"} ? 'green' : "" %>"
									>
									Limited <input 
										type    = "radio"
										id      = "<% $admin->id %>_limited"
										name    = "<% $admin->id %>_level"
										value   = "limited"
										onclick = "showLimits(<% $admin->id %>, this, 'limited')"
										<% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %>
									>
									</span>
								</label>

								<label for="<% $admin->id %>_entry_only">
									<span 
										id    = "<% $admin->id %>_entry_onlybox"
										class = "quarter padless marno hover leveler_<% $admin->id %> nowrap
										<% $admin_perms{$admin->id}{"entry_only"} ? 'green' : "" %>"
									>
										Entry Only 
											<input 
											type    = "radio"
											id      = "<% $admin->id %>_entry_only"
											name    = "<% $admin->id %>_level"
											value   = "entry_only"
											onclick = "hideLimits(<% $admin->id %>, this, 'entry_only')"
											<% $admin_perms{$admin->id}{"entry_only"} ? 'checked="checked"' : "" %>
										>
									</span>
								</label>
%							} 

							<div 
								class="bordertop nospace" 
								id="<% $admin->id %>" 
								style="<% $admin_perms{$admin->id}{"limited"} ? "" : 'display: none;' %>"
							>

								<span class="sixth padless marno hover nowrap">
									Limit To:
								</span>

								<label for="<% $admin->id %>_registration">
									<span class="threetenths padless marno hover nowrap">
										Registration 
											<input 
												type="checkbox" 
												name="<% $admin->id %>_registration" 
												value="1" 
												id="<% $admin->id %>_registration" 
												<% $admin_perms{$admin->id}{"registration"} ? 'checked="checked"' : "" %>
											>
									</span>
								</label>

								<label for="<% $admin->id %>_tabbing">
									<span class="quarter padless marno hover nowrap">
										Tabbing 
											<input 
											type  = "checkbox"
											name  = "<% $admin->id %>_tabbing"
											value = "1"
											id    = "<% $admin->id %>_tabbing"
											<% $admin_perms{$admin->id}{"tabbing"} ? 'checked="checked"' : "" %>
										> 
									</span>
								</label>

								<label for="<% $admin->id %>_category_tab">

									<span class="threetenths padless marno hover nowrap">

										Category
											<input 
												type    = "checkbox"
												name    = "<% $admin->id %>_category_tab"
												value   = "1"
												id      = "<% $admin->id %>_category_tab"
												onclick = "showLimits('<% $admin->id."_categories" %>', this)"
												<% $admin_perms{$admin->id}{"category_tab"} ? 'checked="checked"' : "" %> >
									</span>
								</label>

							</div>

							<div 
								id    = "<% $admin->id %>_categories"
								class = "bordertop nospace"
								style = "<% $admin_perms{$admin->id}{"category_tab"} ? "" : 'display: none;' %>"
							>

								<span class="half">
									Tab Only Events in:
								</span>

								<span class="half centeralign">

									<select 
										name  = "<% $admin->id %>_category"
										class = "fixedmed plain"
									>

										<option value=""></option>

%										foreach my $category ($tourn->categories) { 

											<option value="<% $category->id %>" 
												<% $admin_perms{$admin->id}{"category_tab"} 
													&& $category->id == $admin_perms{$admin->id}{"category_tab"}->category->id 
													? 'selected="selected"': ""
												%>
											>

												<% $category->name %>
											</option>
%										}

									</select>
								</span>

							</div>

						</td>

						<td class="centeralign nospace smallish">
<%perl>
							unless ($admin_perms{$admin->id}{"owner"} 
								&! ($admin_perms{$person->id}{"owner"} 
								|| $person->site_admin)
							) { 
</%perl>
								<a 
									class="redtext button buttonwhite fa fa-lg fa-trash" 
									href="access_rm.mhtml?admin_id=<% $admin->id %>"
								></a>
%							}
						</td>

					</tr>
%				}

				<tbody>

				<tr class="libl">
					<td class="rightalign" colspan="10">
						<input type="submit" value="Save Permissions">
						</form>
					</td>
				</tr>


%			}

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Add New Staff:</h4>

			<form 
				action = "access_add.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn %>"
			>

			<div class="row centeralign padmuchmore">
				<input 
					type        = "text"
					name        = "email"
					size        = "28"
					placeholder = "Email address"
				>
			</div>

			<div class="libl marno padmore rightalign">
				<input  type="submit" value="  Grant Access  ">
				</form>
			</div>

		</div>

	</div>

