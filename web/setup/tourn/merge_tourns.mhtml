<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$merge_target_id => undef
	$restore_id      => undef
	$prefix          => undef
</%args>
<%init>

	my $err;
	my $msg;

	Tab::Entry->set_sql(update_tourn => "
		update entry, event
		set entry.tourn = ? 
		where entry.event = event.id
		and event.category = ? 
	");

	Tab::Fine->set_sql(update_tourn => "
		update fine
		set tourn = ? 
		where school = ? 
	");

	Tab::Event->set_sql(update_tourn => "
		update event
		set event.tourn = ? 
		where event.category = ? 
	");

	Tab::ChangeLog->set_sql(update_tourn => "
		update change_log, event
		set change_log.tourn = ? 
		where change_log.event = event.id
		and event.category = ? 
	");

	Tab::JudgeHire->set_sql(update_tourn => "
		update judge_hire, category
		set judge_hire.tourn = ? 
		where judge_hire.category = ? 
	");

	Tab::Rating->set_sql(update_tourn => "
		update rating, event, entry
		set rating.tourn = ? 
		where rating.entry = entry.id
		and entry.event = event.id
		and event.category = ? 
	");

	Tab::ResultSet->set_sql(update_tourn => "
		update result_set, event
		set result_set.tourn = ? 
		where result_set.event = event.id
		and event.category = ? 
	");

	Tab::Strike->set_sql(update_tourn_entry => "
		update strike, entry, event
		set strike.tourn = ? 
		where strike.entry = entry.id
		and entry.event = event.id
		and event.category = ? 
	");

	Tab::Strike->set_sql(update_tourn => "
		update strike, judge
		set strike.tourn = ? 
		where strike.judge = judge.id
		and judge.category = ? 
	");

	Tab::Round->set_sql(update_tbsets => "
		update round, tiebreak_set tb1, tiebreak_set tb2, event
			set round.tiebreak_set = tb1.id
			where round.tiebreak_set = tb2.id
			and tb1.tourn = ? 
			and tb2.tourn = ? 
			and tb1.name = tb2.name 
			and round.event = event.id
			and event.tourn = tb1.tourn
	");

	if ($restore_id) { 

		my $restore = Tab::Tourn->retrieve($restore_id);

		if ($restore) { 

			foreach my $category ($tourn->categories) { 

				if ($category->setting("original_tourn") == $restore->id) { 

					Tab::Strike->sql_update_tourn->execute($restore->id, $category->id);
					Tab::Strike->sql_update_tourn_entry->execute($restore->id, $category->id);
					Tab::ResultSet->sql_update_tourn->execute($restore->id, $category->id);
					Tab::Rating->sql_update_tourn->execute($restore->id, $category->id);
					Tab::ChangeLog->sql_update_tourn->execute($restore->id, $category->id);
					Tab::JudgeHire->sql_update_tourn->execute($restore->id, $category->id);
					Tab::Entry->sql_update_tourn->execute($restore->id, $category->id);
					Tab::Event->sql_update_tourn->execute($restore->id, $category->id);

					$category->tourn($restore->id);
					$category->update();
					$category->setting("original_tourn", 0);

					my $remove_prefix = $category->setting("original_prefix");

					if ($remove_prefix) { 

						unprefix($category, $remove_prefix);

						foreach my $event ($category->events) { 
							unprefix($event, $remove_prefix);
						}
					}
				}
			}

			foreach my $school ($tourn->schools) { 

				if ($school->setting("original_tourn") == $restore->id) { 

					Tab::Fine->sql_update_tourn->execute($restore->id, $school->id);
					$school->tourn($restore->id);
					$school->update();
					$school->setting("original_tourn", 0);
				}
			}

			Tab::Round->sql_update_tbsets->execute( $restore->id, $tourn->id );

			$msg = "The entries, events and schools from ".$restore->name." are now restored to it.";

		} else { 

			$err = "No such tournament for ID $restore_id";

		}

	} elsif ($merge_target_id) { 

		my $merge_target = Tab::Tourn->retrieve($merge_target_id);

		if ($merge_target) { 

			my $permission = Tab::Permission->search(
				tourn => $merge_target->id,
				person => $person->id
			)->first;

			if (
				$permission && 
					($permission->tag ne "owner" || $permission->tag ne "full_admin") 
				|| $person->site_admin
				|| $person_settings->{"nsda_admin"}
			) { 

				foreach my $category ($tourn->categories) { 

					Tab::Strike->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::Strike->sql_update_tourn_entry->execute($merge_target->id, $category->id);
					Tab::ResultSet->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::Rating->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::ChangeLog->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::JudgeHire->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::Entry->sql_update_tourn->execute($merge_target->id, $category->id);
					Tab::Event->sql_update_tourn->execute($merge_target->id, $category->id);

					$category->tourn($merge_target->id);
					$category->update();
					$category->setting("original_tourn", $tourn->id);

					if ($prefix) { 

						prefix($category, $prefix);

						foreach my $event ($category->events() ) {
							prefix($event, $prefix);
						}

						$category->setting('original_prefix', $prefix);

					}
				}

				foreach my $school ($tourn->schools) { 

					Tab::Fine->sql_update_tourn->execute($merge_target->id, $school->id);
					$school->tourn($merge_target->id);
					$school->update();
					$school->setting("original_tourn", $tourn->id);
				}

				Tab::Round->sql_update_tbsets($merge_target->id, $tourn->id);
				$msg = "Tournament entries, schools and events are now part of ".$merge_target->id;

			} else { 

				$err = "You do not have full admin or ownership rights on target tournament ".$merge_target->name." so no merge is possible.  Contact the tournament admins to increase your access level.";
				
			}

		} else { 

			$err = "No such tournament for ID $restore_id";
		}
	}

	my @access_tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person => $person,
		all    => 1
	);

	Tab::Tourn->set_sql(restores => "
		select distinct tourn.*
		from tourn
		where tourn.id in (
			select distinct category_setting.value
			from category_setting, category
			where category_setting.tag = 'original_tourn'
			and category_setting.category = category.id
			and category.tourn = ?
		)
	");

	my @restores = Tab::Tourn->search_restores($tourn->id);

	sub unprefix {

		my ($object, $prefix) = @_;

		my $name = $object->name;
		$name =~ s/^$prefix//g;
		$name =~ s/^\s+//;
		$object->name($name);

		my $abbr = $object->abbr;
		$abbr =~ s/^$prefix//g;
		$abbr =~ s/^\s+//;
		$object->abbr($abbr);

		$object->update();
		return $object;
	}

	sub prefix {
		my ($object, $prefix) = @_;

		my $name = $object->name;
		$name =~ s/^\s+//;
		$name = $prefix." ".$name;
		$object->name($name);

		my $abbr = $object->abbr;
		$abbr =~ s/^\s+//;
		$abbr = $prefix." ".$abbr;
		$object->abbr($abbr);

		$object->update();
		return $object;
	}

</%init>


	<div class="main">

		<h3><% $tourn->name %></h3>

		<& "tabbar.mas", 
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "merge"
		&>

%		if ($msg) { 
			<div class="full padvertmore centeralign libl borderlight bluetext semibold">
				<% $msg %>
			</div>
%		} 

%		if ($err) { 
			<div class="full padvertmore centeralign lird borderlight redtext semibold">
				<% $err %>
			</div>
%		}

		<h4>Merge tournaments for tabbing</h4>

		<p>
			Use this function to merge your entries, rounds, judges, etc into
			another tournament for the purposes of sharing rooms, judges, and
			resources with another tournament, such as a District qualifier.
		</p>

		<p class="semibold redtext">
			You must have admin level access to BOTH
			tournaments to merge them.
		</p>

		<p>
			It will not merge judging categories automatically; that would make
			it impossible to re-separate the tournaments afterwards.  However,
			you can go to Paneling - Judges, and create Judge Pools for use in
			your divisions, and populate it with judges from both New
			Tournament and Old Tournament categories.  Then assign your rounds
			to pull from that judge pool and it will pull from both sets of
			judging. 
		</p>

		<p>
			Rooms will work in the normal way; you can create pools or not as 
			you will.
		</p>

		<form 
			action = "merge_tourns.mhtml"
			method = "post"
		>

			<div class="row padvert">

				<span class="half semibold bluetext">
					Merge target tournament:
				</span>

				<span class="half centeralign">
					<select name="merge_target_id" class="fixedbig">
						<option value=""></option>
%						foreach my $other (@access_tourns) { 
%							next if $other->id == $tourn->id;
							<option 
								value="<% $other->id %>"
							><% $other->name %></option>
%						}
					</select>
				</span>

			</div>

			<div class="row padvert">

				<span class="threequarters semibold bluetext">
					Pre-pend a short prefix/code to distinguish your events
					from the other tournaments?
				</span>

				<span class="quarter centeralign">
					<input 
						type = "text"
						name = "prefix"
						size = "4"
					>
				</span>
			</div>

			<div class="libl row padvert rightalign padrightmore">

				<input 
					type="submit"
					value="Merge Tournaments"
				>
			</div>

		</form>

%		if (@restores) { 

			<h4 class="martopmore">Split merged tournaments</h4>

			<p>
				Restore events/rounds/categories to the following tournaments: 
			</p>

%			foreach my $restore (@restores) { 

				<form 
					action="merge_tourns.mhtml" 
					method="post"
				>
					<input 
						type  = "hidden"
						name  = "restore_id"
						value = "<% $restore->id %>"
					>

					<div class="row">

						<span class="twothirds">
							<% $restore->start->year %> <% $restore->name %>
						</span>

						<span class="third rightalign">
							<input 
								type  = "submit"
								value = "Un-Merge"
							>
						</span>

					</div>

				</form>
%			}

%		}

	</div>

