<%args>
	$dbh
	$tourn
	$person
	$person_settings
	$tourn_settings
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "America/New_York" unless $tz;

</%init>

	<div class=" main">
		<div class="full flexrow">
			<span class="ninetenths nospace">
				<h3>
					<% $tourn->name %>
				</h3>
			</span>
			<span
				class="tenth rightalign bluetext semibold"
				title="Tournament Tabroom ID number"
			>
				ID <% $tourn->id %>
			</span>
		</div>

		<& "tabbar.mas",
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "main"
		&>

		<h5>Name & Location</h5>

		<form
			action="main_save.mhtml"
			method="post"
		>

			<div class="row flexrow">
				<span class="third padleft">
					Full Name
				</span>
				<span class="twothirds padright">
					<input
						type        = "text"
						name        = "name"
						size        = "64"
						value       = "<% $tourn->name %>"
						placeholder = "Do not include the year; it will already be included where relevant"
					>
				</span>
			</div>

			<div class="row flexrow">

				<span class="third padleft">
					Public URL
				</span>

				<span class="twothirds padright">
%					if ($tourn_settings->{"nsda_district"}) {

						<a
							class  = "full hover bluetext link-underline bigger padleftless"
							target = "_blank"
							href   = "http://<% $tourn->webname %>.tabroom.com"
						>
							http://<% $tourn->webname %>.tabroom.com
						</a>

%					} else {
						<div class="full flexrow wrap">
							<span class="twofifths nospace padtopless">
								<input
									type  = "text"
									name  = "webname"
									class = "<% $tourn->webname ? "" : "borderred" %>"
									value = "<%  $tourn->webname  %>"
								>
							</span>
%							if ($tourn->webname) {
								<span class="threefifths wrap smallfull">
									<a  href   = "http://<% $tourn->webname %>.tabroom.com"
										class  = "bluelink semibold bigger hover full padleft"
										target = "_blank"
									>
										http://<% $tourn->webname %>.tabroom.com
									</a>
								</span>

%							} else {

								<span class="threefifths semibold redtext nospace padleft">
									MISSING WEBNAME!
								</span>

								<div class="orangetext semibold nospace">
									You MUST set a webname to send email through Tabroom.
								</div>
%							}

						</div>

						<p class="full padtopless smallish italic flexrow">
							The webname will link to your tournament Tabroom site,
							and will be the sender of your Tabroom emails.
							Keep it short &amp; memorable, and re-use it from
							one year to the next.
						</p>
%					}

				</span>
			</div>

%			unless ($tourn_settings->{"nsda_district"}) {

				<div class="row flexrow">
					<span class="third padleft">
						City/Location:
					</span>

					<span class="twothirds padright">
						<input
							type  = "text"
							name  = "city"
							size  = "32"
							value = "<% $tourn->city %>"
						>
					</span>
				</div>
%			}

			<div class="row flexrow">
				<span class="third padleft">
					State/Country (if applicable)
				</span>

				<span class="third">
					<select name  = "state" >
						<&
							"/funclib/state_select.mas",
							state => $tourn->state
						&>
					</select>
				</span>

				<span class="third padleft padright">
					<select name  = "country" >
						<&
							"/funclib/country_select.mas",
							country => $tourn->country
						&>
					</select>
				</span>
			</div>

			<div class="row flexrow leftalign">
				<span class="third padleft">
					Time Zone
				</span>

				<span class="twothirds padright">
					<select name="timezone">
						<& "/funclib/timezones.mas", tz => $tz &>
					</select>
				</span>

			</div>

			<div class="liblrow rightalign">
				<span class="third centeralign">
					<input
						type="submit"
						value="Save"
					>
				</span>
			</div>
			</form>

			<div class="full martop flexrow">
				<span class="third">
					<h5>Tournament Logo</h5>
				</span>
				<span class="twothirds rightalign semibold explain">
					only .png or .jpg image files are accepted.
				</span>
			</div>

			<form
				enctype  = "multipart/form-data"
				name	 = "logo_image"
				action   = "logo_upload.mhtml"
				method   = "post"
				class    = "nospace"
			>

			<div class="row leftalign flexrow">

				<span class="fifth semibold flexrow padleft">
					Upload
				</span>

				<span class="twofifths">
					<div class="uploader dynamic">
						<input
							type     = "file"
							name     = "logo_image"
							style    = "opacity: 0;"
							onChange = "uploaderName('logo_image', 'logo_image_file')"
							id       = "logo_image"
						>

						<span
							id	= "logo_image_file"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>
				</span>

				<span class="tenth padleft">
					<input
						id    = "logo-submit"
						type  = "submit"
						class = "thin"
						value = "Save"
						disabled
					>
					</form>
				</span>

%				if ($tourn_settings->{"logo"}) {
					<span class="fifth rightalign">
						<a
							class  = "plain greentext semibold"
							href   = "<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_settings->{"logo"} %>"
							target = "_blank"
						>View Logo Image</a>
					</span>

					<span class="tenth rightalign padright">
						<a
							class = "fa fa-trash redtext buttonwhite fa-sm"
							href  = "logo_delete.mhtml"
						>
						</a>
					</span>
%				}
			</div>

			<script>
				(function() {
					//This is ugly and bad -  a FileReader() and transmutation may be more appropriate
					$('#logo_image').change(() => {
						getImageType($('#logo_image')[0]);
					});

					function getImageType(i) {
						if (i.files && i.files[0]) {
							var e = i.files[0].name.split('.').pop().toLowerCase();

							//ADD FILETYPES HERE
							var s = ['png', 'jpg', 'jpeg'].indexOf(e) > -1;

							if (s) {
								uploaderName('logo_image', 'logo_image_file');
								unlockUpload();
							} else {
								alertify.warning("Tournament images must be in JPG or PNG format");
							}
						}
					}

					function unlockUpload() {
						$('#logo-submit').removeAttr('disabled');
					}
				})();
			</script>

%		if ($tourn_settings->{"nsda_district"}) {

<%perl>
			my $district = Tab::District->retrieve($tourn_settings->{"nsda_district"});

			if ($district) {
			my @softwares = ("Tabroom", "Speechwire", "Approved Pilot");
</%perl>

			<div class="pagefull flexrow martopmuchmore">
				<span class="half">
					<h5 class="nospace">
						District Tournament Settings
					</h5>
				</span>

				<span class="half semibold redtext rightalign padtop">
					#<% $district->code %> <% $district->name %> District
					<% $district->location ? "(".$district->location.")" : "" %>
				</span>
			</div>

%			if ($person->site_admin || $person_settings->{"nsda_admin"}) {

				<form
					action = "switch_nsda_method.mhtml"
					method = "post"
				>

				<div class="pagefull row flexrow marno">
					<span class="half flexrow">
						<span class="quarter semibold padleft">
							Software
						</span>

						<span class="threequarters rightalign">
							<select
								name  = "software"
							>
								<option value="">None Selected</option>
%								foreach my $software (@softwares) {
									<option
										value="<% lc($software) %>"
										<% lc $software eq $tourn_settings->{"nsda_district_questions"}{"nsda_tabbing_software"}
											? 'selected="selected"'
											: ""
										%>
									> <% $software %></option>
%								}
							</select>
						</span>
					</span>

					<label for="nsda_strikes" class="flexrow half marno hover">
						<span class="threequarters padleftmore">
							Allow Use of Strikes
						</span>

						<span class="quarter centeralign">
							<input
								type  = "checkbox"
								name  = "nsda_strikes"
								id    = "nsda_strikes"
								value = "1"
								<% $tourn_settings->{"nsda_strikes"} ? "checked" : "" %>
							>
						</span>
					</label>
				</div>

				<div class="libl full rightalign marno">
					<span class="third centeralign">
						<input
							type  = "submit"
							value = "Save Districts Rules"
						>
					</span>
				</div>

				</form>
%				}

%			} else {

%			}

%		} else {

			<div class="flexrow">
				<span class="quarter nospace martopmore">
					<h5>Circuits</h5>
				</span>
				<span class="threequarters rightalign italic">
					You may list your tournament with up to 5 circuits.
				</span>
			</div>
<%perl>

			my $circuit_sth = $dbh->prepare("
				select
					circuit.id, circuit.name, circuit.abbr,
					tc.approved
				from circuit, tourn_circuit tc
				where 1=1
					and tc.tourn = ?
					and tc.circuit = circuit.id
				group by circuit.id
				order by tc.approved DESC, circuit.abbr
			");

			$circuit_sth->execute($tourn->id);
			my $circuits = $circuit_sth->fetchall_hash();

			my $counter;

			my $circuit_rm = $dbh->prepare("
				delete tc.*
					from tourn_circuit tc
				where tc.tourn = ?
				and tc.circuit = ?
			");

			foreach my $circuit (@{$circuits}) {

				if ($counter++ > 4) {
					$circuit_rm->execute($tourn->id, $circuit->{id});
					next;
				}
</%perl>
				<div
					class = "row flexrow padvertless"
					id    = "<% $circuit->{id} %>"
				>
					<span class="threefifths semibold bluetext padleft">
						<% $circuit->{name} %>
					</span>

					<span class="tenth semibold bluetext padleft">
						<% $circuit->{abbr} %>
					</span>

					<span class="eighth centeralign nospace">
%						if ($circuit->{approved}) {
							<i title="Approved" class="greentext fa fa-lg fa-check"></i>
%						} else {
							<i title="Pending" class="orangetext fa fa-lg fa-clock-o"></i>
%						}
					</span>

					<span class="eighth centeralign nospace padright">
						<a
							class        = "redtext button buttonwhite fa fa-trash fa-sm"
							circuit_id   = "<% $circuit->{id} %>"
							circuit_name = "<% $circuit->{name} %>"
							onClick      = "postSwitch(this, 'circuit_rm.mhtml');"
						></a>
					</span>
				</div>
%			}

<%perl>
			unless ( (scalar @{$circuits} > 4) ) {

				my $limiter;

				unless ($person->site_admin) {
					$limiter = '
						AND
							( NOT EXISTS (
								select cs.id
								from circuit_setting cs
								where cs.circuit = circuit.id
								and cs.tag = "tourns_no_add"
							) OR EXISTS (
								select permission.id
								from permission
								where permission.person = '.$person->id.'
								and permission.circuit = circuit.id
								and permission.tag = "circuit"

							)
						)
					';
				}

				my $non_circuit_sth = $dbh->prepare("

					select
						circuit.id, circuit.abbr, circuit.name
					from circuit
					where 1=1

						and circuit.active = 1

						and NOT EXISTS (
							select tc.id
								from tourn_circuit tc
							where tc.tourn = ?
							and tc.circuit = circuit.id
						)

						$limiter

					order by circuit.name, circuit.abbr
				");

				$non_circuit_sth->execute($tourn->id);
				my $non_circuits = $non_circuit_sth->fetchall_hash();
</%perl>

				<form
					action = "circuit_add.mhtml"
					method = "post"
				>

				<div class="libl full marno centeralign flexrow">

					<span class="threequarters">
						<select name="circuit_id">
%							foreach my $circuit (@{$non_circuits}) {
								<option
									value="<% $circuit->{id} %>"
								> <% $circuit->{abbr} %> <% $circuit->{name} %> </option>
%							}
						</select>
					</span>

					<span class="qarter centeralign padvert padleft">
						<input
							type  = "submit"
							value = "Add Circuit"
						>
					</span>
				</div>
				</form>

%			} else {

				<h5>You have reached your limit of circuits</h5>
				<p>
					A tournament may only list itself with 5 circuits.
					To add another circuit, you must first remove some above.
				</p>
%			}
%		}
	</div>

	<div class="menu">
% 		if ( $tourn_settings->{"logo"} ) {
			<div class=" sidenote">
%				if ($tourn_settings->{"logo"}) {
%					my $logo_file = $tourn_settings->{"logo"};
					<h4>Logo</h4>

					<div class=" centeralign">
						<img
							src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$logo_file %>"
							alt   = "<% $logo_file %>"
							style = "max-width: 220px;"/
						>
					</div>
%				}
			</div>
% 		}

		<div class="sidenote">
			<h4>
				NSDA Services
			</h4>

			<div class="full bigger">
				Interested in saving time &amp; hassle by purchasing
%			unless ($tourn_settings->{"mock_trial_registration"}) {
				<a
					class  = "padno marno semibold redtext"
					href   = "https://www.speechanddebate.org/tournament-services/#h2-2"
					target = "_blank"
				>Extemp Questions</a>

				or
%			}
					<a
						class  = "padno marno semibold redtext"
						href   = "http://www.speechanddebate.org/trophyshop"
						target = "_blank"
					>Trophies</a>?
				The National Speech &amp; Debate Association has
				affordably priced trophies
%				unless ($tourn_settings->{"mock_trial_registration"}) {
					and extemp questions
%				}
				available to purchase for your tournament.
			</div>

		</div>

		<div class="sidenote bigger">

			<h4>Notes</h4>

			<p class="bigger">
				Your webname must be unique to your tournament, and in all
				lowercase letters or numbers, no punctuation.  Don't include
				the year; web names can be re-used by the same tournament
				each year.
			</p>

			<p>
				Don't make your tournament name too long; long names will be
				truncated on many online listings.  Also, don't include
				the year of the tournament; archives and results pages will
				include the year automatically.
			</p>

			<p>
				Your tournament invitations and the bill packets will
				immediately appear on your public website as download
				links.  Please make sure the files are in a common format, such
				as DOC or PDF, and it's best if the file names did not include
				characters besides numbers and letters
			</p>


		</div>

	</div>
