<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$person_settings
	$event_id        => undef
	$round_highlight => undef
</%args> 
<%init> 

	my $event = Tab::Event->retrieve($event_id);

	unless ($event) { 
		my @tourn_events = $tourn->events();
		@tourn_events = $m->comp(
			"/funclib/event_perms.mas", 
			perms  => $perms,
			type   => "admin",
			events => \@tourn_events
		);

		$event = $tourn_events[0] if @tourn_events;
	}

	$m->abort unless $event;
	$m->abort unless $event->category;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $weekend_id = $event->setting('weekend');

	my $not_held++ if $weekend_id eq "nope";
	my $weekend = Tab::Weekend->retrieve($weekend_id) 
		if $weekend_id
		&& $weekend_id == int($weekend_id);

	my $weekend_start;
	my $weekend_end;

	if ($weekend) { 
		$weekend_start = $weekend->start->epoch;
		$weekend_end = $weekend->end->epoch;
	}

	my $now = DateTime->now();

    my @days = $m->comp(
		"/funclib/tourn_days.mas", 
		tourn   => $tourn,
	);

	my @sites = $m->comp(
		"/funclib/tourn_sites.mas", 
		tourn => $tourn
	);

	my $default_site = $sites[0]->id 
		if @sites 
		&& scalar @sites < 2;

	my $type = $event->type;

	$type = "debate" 
		if $type ne "speech" 
		&& $type ne "congress";

	my $district++ if $tourn_settings->{"nsda_district"};

	my @rounds = $event->rounds;

	my %round_by_timeslot;
	
	my $empty;

	foreach my $round (@rounds) { 
		next unless $round->timeslot;
		$empty = "hidden" if $round->type eq "final";
		push @{$round_by_timeslot{$round->timeslot->id}}, $round;
	}

	my @tiebreak_sets = $tourn->tiebreak_sets;

</%init>

	<script type="text/javascript"> 

		function showMe (timeslotID) { 
			$("."+timeslotID).toggleClass("hidden");
		} 

		function toggleEmpties () { 

			if ($("#toggle").val()  == "Hide Empty Slots") { 
				$("#toggle").val("Show Empty Slots");
				$(".empty").addClass("hidden");
                $(".main").find(".row").removeClass("even");
                $(".main").find(".row").removeClass("odd");
                $(".main").find(".row:visible:even").addClass("even");
				$(".main").find(".row:visible:odd").addClass("odd");

			} else { 
				$(".empty").removeClass("hidden");
				$("#toggle").val("Hide Empty Slots");
                $(".main").find(".row").removeClass("even");
                $(".main").find(".row").removeClass("odd");
                $(".main").find(".row:even").addClass("even");
				$(".main").find(".row:odd").addClass("odd");
			}
		}

	</script>

%	my $current_day;

	<& menu.mas, 
		tourn => $tourn,
		perms => $perms,
		event => $event,
		days  => \@days
	&>

	<div class="main">
		
		<span class="half">
			<h4><% $event->name %> schedule</h4>
		</span>

		<span class="third semibold rightalign">
			<% $weekend ? "Dates: ".$weekend->name : "" %>
		</span>

		<span class="sixth rightalign marno">
			<input 
				type    = "button"
				id      = "toggle"
				class   = "thin"
				value   = "Show Empty Slots"
				onclick = "toggleEmpties(this)"
			>
		</span>

%		unless ($event->rounds) { 

			<form 
				action="clone_schedule.mhtml" 
				method="post"
			>

			<input 
				type  = "hidden"
				name  = "destination_event_id"
				value = "<% $event->id %>"
			>

			<div class="centeralign full even nospace">

				<span class="third rightalign">
					Clone schedule of:
				</span>

				<span class="third centeralign">

					<select name="source_event_id" class="fixedmed">

						<option value=""></option>

%						foreach my $other ($tourn->events) { 
%							next if $event->id == $other->id;
%							next if $weekend && $weekend->id ne $other->setting('weekend');
							<option value="<% $other->id %>"><% $other->name %></option>
%						}

					</select>

				</span>

				<span class="leftalign third">
					<input 
						type  = "submit"
						value = "Clone"
						class = "thin"
					>
				</span>

				</form>
			</div>
%		}


		<table class="narrow">

			<form 
				action = "event_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "event_id"
				value = "<% $event->id %>"
			>

<%perl>

			TIMESLOT:
			foreach my $timeslot (
				sort {$a->start->epoch <=> $b->start->epoch} 
				$tourn->timeslots 
			) { 

				if ($weekend) { 
					next TIMESLOT if $timeslot->start->epoch > $weekend_end;
					next TIMESLOT if $timeslot->end->epoch < $weekend_start;
				}

				if (
					(not defined $current_day)
					|| $current_day->day != $timeslot->start->set_time_zone($tz)->day
				) { 

					$current_day = $timeslot->start->set_time_zone($tz);

</%perl>

					<tr class="yellowrow">

						<th class="smaller">
							<% $current_day->day_abbr %>
							<% Tab::niceshortdate($current_day) %>
						</th>

						<th class="smaller">
							Y/N
						</th>

						<th colspan="2" class="smaller">
							Label
						</th>

						<th class="smaller">
							Type
						</th>

						<th class="smaller">
							Tiebreaks
						</th>

%						if (scalar @sites > 1) { 
							<th class="smaller">
								Site
							</th>
%						}

%						if ($type ne "congress") { 
							<th class="smaller">
								Flights
							</th>
%						}

						</th>

					</tr>

%				}

<%perl>

				my $second;
				@{$round_by_timeslot{$timeslot->id}} = (0)
					unless $round_by_timeslot{$timeslot->id};

				foreach my $round (@{$round_by_timeslot{$timeslot->id}}) { 

					undef $round unless $round > 0;

					my $hidden = "hidden" unless $round && $round > 0;
					my $published;

					$published++ if $weekend && $weekend->end < $now;

					if ($round) { 
						$published++ if $round->published > 0;
						$published++ if $round->panels;
						undef $published unless $round->panels;
					} else { 
						undef $published;
					}
					

					my $warning = "This round is assigned, and unchecking this box would delete it.  To move it without deleting go to the Settings tab on the schematic.  If you really want to delete it, do so under Change and Destroy on the schematic.";

</%perl>

				<tr 
					class="<% $round && $round_highlight == $round->id ? "lirdrow" : "row" %>  
					<% $round ? "" : "empty ".$empty %>"
				>

					<td class="smaller nowrap">

						<div class="nospace <% $second ? "redtext semibold" : "" %>">
							<% $timeslot->name %> 
							<% $second ? "WARNING: TWO ROUNDS IN TIMESLOT!" : "" %>
						</div>

						<div class="padno martophalf">
							<% Tab::shorttime($timeslot->start->set_time_zone($tz)) %>
						</div>

					</td>

					<td class="centeralign">

						<label for="<% $timeslot->id %>">

						<div	
							<% $published ? 'title="'.$warning.'"' : "" %>
							class="hover"
						>
							<input 
								type    = "checkbox"
								id      = "<% $timeslot->id %>"
								name    = "<% $timeslot->id %>"
								value   = "1"
%								if ($published) { 
									onclick = "return false;"
%								} else { 
									onclick = "showMe(<% $timeslot->id %>);"
%								}
								<% $round && $round > 0 ? "checked" : "" %>
							><% $published ? '*' : "" %>
							</div>
						</label>
					</td>

					<td class="smallish centeralign">
						<% ($round) ? $round->name : "" %>
					</td>

					<td class="smallish">

						<div class = "centeralign nospace <% $hidden %> <% $timeslot->id %>" >

							<input 
								type        = "text"
								size        = "<% $district ? "16" : "4" %>"
								name        = "<% $timeslot->id %>_label"
								placeholder = "Label"
								value       = "<% ($round && $round->label) ? $round->label : "" %>"
							>
						</div>
					</td>

					<td class="centeralign">

						<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

							<select 
								name  = "<% $timeslot->id %>_type"
								class = "smallish plain"
							>
							
								<option 
									value="prelim" 
									<% ($round && $round->type eq "prelim") 
										? "selected" : "" 
									%> 
								>
									Prelim/Preset
								</option>

%								if ($type eq "debate") { 
									<option 
										value="highlow" 
										<% ($round && $round->type eq "highlow") 
											? "selected" : ""
										%> 
									>
										Hi/Lo
									</option>	

									<option 
										value="highhigh" 
										<% ($round && $round->type eq "highhigh") 
											? "selected" : ""
										%>
									>
										Hi/Hi
									</option>	
%								}

%								if ($type eq "speech") { 

									<option 
										value="snaked_prelim" 
										<% ($round && $round->type eq "snaked_prelim") 
											? "selected" : ""
										%>
									>
										Snaked Prelim
									</option>	
%								}

								<option 
									value="elim" 
									<% ($round && $round->type eq "elim") 
										? "selected" : ""
									%> 
								>
									Elim
								</option>

								<option 
									value="final" 
									<% ($round && $round->type eq "final") 
										? "selected" : ""
									%> 
								>
									Final
								</option>

								<option 
									value="runoff" 
									<% ($round && $round->type eq "runoff") 
										? "selected" : ""
									%> 
								>
									Runoff
								</option>

							</select>

						</div>

					</td>

					<td 
						class="centeralign nospace smallish 
						<% $round > 0 && $round->id == $round_highlight ? "dkred" : "" %> "
					>

						<div 
							class = "nospace full <% $hidden %> <% $timeslot->id %> 
							<% $round && $round->tiebreak_set && $round->tiebreak_set->id ? "" : "dkred" %>"
						>

						<select 
							name="<% $timeslot->id %>_tiebreak_set" 
							class="fixedsmaller plain"
						> 

							<option value=""></option>

%							foreach my $tiebreak_set (@tiebreak_sets) { 
								<option 
									value="<% $tiebreak_set->id %>"  
									<% 	$round 
										&& $round->tiebreak_set 
										&& $round->tiebreak_set->id == $tiebreak_set->id ? "selected" : "" 
									%> 
								>
									<% ucfirst($tiebreak_set->name) %>
								</option>
%							}

						</select>
						</div>

					</td>

%					if (scalar @sites > 1) { 

						<td class="centeralign smallish">
						
							<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

								<select 
									name  = "<% $timeslot->id %>_site"
									class = "fixedsmaller plain"
								>

								<option value="">Select Site</option>

%									foreach my $site (@sites) { 

										<option 
											value="<% $site->id %>" 
											<% ($round && $round->site && $site->id == $round->site->id) ? 'selected' : "" %>
										>
											<% $site->name %>
										</option>
%									}

									<option value="">No Site</option>

								</select>

							</div>

						</td>

%					} else { 

						<input 
							type  = "hidden"
							name  = "<% $timeslot->id %>_site"
							value = "<% $default_site %>"
						>

%					}


%					if ($type ne 'congress') { 

						<td class="centeralign">

							<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

								<select name="<% $timeslot->id %>_flight" class="plain">

									<option 
										value="1" 
										<% $round && $round->flighted == 1 ? "selected" : ""%>
									>1</option>

									<option 
										value="2" 
										<% $round && $round->flighted == 2 ? "selected" : ""%>
									>2</option>

									<option 
										value="3" 
										<% $round && $round->flighted == 3 ? "selected" : ""%>
									>3</option>

								</select>
							</div>
						</td>
%					}

				</tr>

%				if ($round > 0 && $round->tiebreak_set < 1) { 

					<tr class="lird">
						
						<td 
							colspan = "4"
							class   = "centeralign strong smallish redtext"
						>

							DANGER WILL ROBINSON!
						</td>

						<td 
							colspan="3" 
							class="centeralign strong smallish redtext"
						>

							<div class="strong">
								<h5 class="nospace">&#65514;&#65514;&#65514;&#65514;&#65514;&#65514;</h5>
							</div>

							Every round must have a tiebreaker set, or you cannot enter ballots.  (Tiebreakers are how Tabroom knows what scores to ask for).

							<br />
							<br />
								Please correct the red box above.
							<br />
							<br />
						</td>
					</tr>

%				}
%				$second++;
%				}

%			}

			<tr class="liblrow">

				<td colspan="10" class="rightalign">
					<input type="submit" value="  Save Rounds  " class="thin">
					</form>
				</td>

			</tr>

		</table>

		<p class='explain'>

			* You may not delete or move rounds that have been sectioned with
			this screen; it will delete and re-create rounds, not move them.
			If you want to move rounds on your schedule, go to the schematic
			and use the menu on the Settings tab.

		</p>


	</div>

