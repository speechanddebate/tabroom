<%args>
	$tourn
	$date => undef
	$tz
	$all => undef
</%args> 
<%init> 

	$tz = $tourn->tz unless $tz;

	my $today;

	if ($date) { 
		$today = Tab::dateme($date);
	}

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	$today = $days[0] unless $today;

	$today->set_time_zone($tz);
	$today->truncate( to => 'day' );
	
	if ($today->epoch < $tourn->start->epoch) {
		my $err = "That day ".$today->ymd." is before your tournament begins.  Quit screwing around.";
		$m->redirect("sked.mhtml?err=$err");
	}
	
	if ($today->epoch > $tourn->end->epoch) { 
		my $err = "That day ".$today->ymd." is after your tournament ends.  Quit screwing around.";
		$m->redirect("sked.mhtml?err=$err");
	}

	my @timeslots;

	if (scalar @days > 1 && not defined $all) { 

		$today = $days[0] unless $today;
	
		my @tmp = Tab::Timeslot->search( tourn => $tourn->id, {order_by => 'start'});

		foreach my $ts (@tmp) { 
			push (@timeslots, $ts) if $ts->start && $ts->start->set_time_zone($tz)->dmy == $today->dmy;
		}

	} else  { 

		@timeslots = sort {$a->start <=> $b->start} Tab::Timeslot->search( tourn => $tourn->id, {order_by => 'start'});
		$today = shift @days;

	}

	my $start = $tourn->start;
	my $end = $tourn->end;

	my $switch;

	my $time_warning;
	my $impossible_warning;

</%init>

	<& sidebar.mas, tourn => $tourn, days => \@days, today => $today &>

	<div class="left huge">
	
		<h2>Timeslots: <% $today->day_name %></h2>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="yellowrow">

				<th>
					Label
				</th>
%				if (@days) { 
					<th>
						Day
					</th>
%				}
				<th>
					Start Time
				</th>

				<th>
					End Time
				</th>

				<th>
%					if (@timeslots) { 
						<form action="save.mhtml" method="post">
						<input type="hidden" name="date" value="<% $today->mdy('/') %>">
%					}
				</th>

			</tr>

% 			foreach my $timeslot (@timeslots) {

% 				my $roundstart = $timeslot->start;
% 				my $roundend = $timeslot->end;
%				my $duration = $roundend - $roundstart;

%				if ( $duration->in_units('hours') > 4 ) { 

					<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>

%					$time_warning++;

%				} elsif ($roundstart > $roundend) { 

%					$impossible_warning++ if $roundstart > $roundend;

					<tr <% ($switch++ % 2) ? "class=\"bluerow\"" : "class=\"liblrow\"" %>>

%				} else {

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%				}


					<td class="centeralign">
						<input type="text" name="<% $timeslot->id %>_name" value="<% $timeslot->name %>" size="15">
					</td>

%					if (@days) { 

						<td class="centeralign">

							<select name="<% $timeslot->id %>_day">
%								foreach my $day (@days) { 
									<option <% $day->day eq $timeslot->start->day ? 'selected' : "" %> value="<% $day->mdy('/') %>">
										<% $day->day_abbr %>
									</option>
%								}
							</select>

						</td>
%					}

					<td class="centeralign">
						<& /funclib/timepicker.mas, name => $timeslot->id."_start", time => $timeslot->start->set_time_zone($tz) &>
					</td>

					<td class="centeralign">
						<& /funclib/timepicker.mas, name => $timeslot->id."_end", time => $timeslot->end->set_time_zone($tz) &>
					</td>

					<td class="centeralign">
						<a class="dkred block" href="delete.mhtml?timeslot_id=<% $timeslot->id %>">Delete</a>
					</td>

				</tr>

%			}

%			if ($impossible_warning) { 

				<div class="annoy">
					WARNING: One or more rounds (in blue) ends before it is scheduled to
					begin.  Time and space laugh at your disobedience.  Chances are
					there's an am/pm problem here.
				</div>
%			}

%			if ($time_warning) { 

				<div class="annoy">
					WARNING: One or more rounds (in red) were scheduled for longer than
					4 hours.  Dear God, what are you doing to those poor judges?
					Chances are there's an am/pm problem here.
				</div>

%			}

%			if (@timeslots) { 

				<tr class="liblrow">

					<td colspan="5" align="right">
						<input  style="width: 150px;" type="submit" value="Save Timeslots">
						</form>
					</td>

				</tr>

%			}

		</table>

		<br />
		<br />

%		undef ($switch);

		<h4>Add a new timeslot:</h4>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td align="center" colspan="2">
					<form action="create.mhtml" method="post">
					<input type="text" name="name" size="20" placeholder="Add new...">
					<input type="hidden" name="date" value="<% $today->mdy('/') %>">
				</td>

				<td align="center">

					<& /funclib/timepicker.mas, name => "new_start" &>

				</td>
			
				<td align="center">

					<& /funclib/timepicker.mas, name => "new_end" &>

				</td>

			</tr>

			<tr class="liblrow">

				<td align="right" colspan="4">
					<input  style="width: 150px;" type="submit" value="Add">
					</form>
				</td>

			</tr>

		</table>

	</div>

