<%args>
	$tourn
	$person
	$tourn_settings
	$category_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $category = Tab::Category->retrieve($category_id);
	my %category_settings = $category->all_settings if $category;

	my $prefs = $category_settings{"prefs"};

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline->set_time_zone($tz) if $judge_deadline;

	my $deadline = $category_settings{"deadline"};
	$deadline->set_time_zone($tz) if $deadline;

	my $strike_start = $category_settings{"strike_start"};
	$strike_start->set_time_zone($tz) if $strike_start;

	my $strike_end = $category_settings{"strike_end"};
	$strike_end->set_time_zone($tz) if $strike_end;

	my $elim_strike_start = $category_settings{"elim_strike_start"};
	$elim_strike_start->set_time_zone($tz) if $elim_strike_start;

	my $elim_strike_end = $category_settings{"elim_strike_end"};
	$elim_strike_end->set_time_zone($tz) if $elim_strike_end;

</%init>

    <& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		page           => "ratings",
		category_id    => $category_id
	&>

	<div class="main">

		<h2>
			<% $category->name %>
		</h2>

		<&
			"tabbar.mas",
			tourn          => $tourn,
			whoami         => "ratings",
			tourn_settings => $tourn_settings,
			category       => $category
		&>

		<form
			action = "ratings_save.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "category_id"
			value = "<% $category %>"
		>

<%perl>

		if (
			(not defined $tourn_settings->{"nsda_district"})
			|| (defined $tourn_settings->{"nsda_strikes"})

		) {

		my $strikeword = "prefs";

		$strikeword = "strikes" if $tourn_settings->{"nsda_district"};

</%perl>
			<h5>
%				if ($tourn_settings->{"nsda_district"}) {
					Strikes
%				} else {
					Strikes, judging ratings, mutually-preferred judging
%				}
			</h5>


			<div class="row">

				<span class="half">

					Judge registration deadline

					<p class="explain padless marno smaller">
						use only if earlier than tournament deadline,
						<% Tab::niceshortdt($judge_deadline) %>
					</p>

				</span>

				<span class="quarter centeralign">
					<& /funclib/datepicker.mas, id => "deadline" &>
					<input
						type        = "text"
						name        = "deadline"
						id          = "deadline"
						size        = "16"
						value       = "<% ($deadline) ? Tab::pickerdate($deadline) : "" %>"
						class       = "notfirst"
						placeholder = "Date..."
					>
				</span>

				<span class="quarter centeralign">
					<&
						"/funclib/timepicker.mas",
						name        => "deadline_time",
						time        => $deadline,
						size        => "16",
						placeholder => "Time..."
					&>
				</span>

			</div>

			<div class="row">

				<span class="sixth">
					<% ucfirst($strikeword) %> open
				</span>

				<span class="sixth">

				   <& /funclib/datepicker.mas, id => "strike_start" &>

					<input
						type  = "text"
						name  = "strike_start"
						id    = "strike_start"
						size  = "10"
						class = "notfirst"
						value = "<% ($strike_start) ? Tab::pickerdate($strike_start) : "" %>"
					>
				</span>

				<span class="sixth">
					<&
						"/funclib/timepicker.mas",
						name => "strike_start_time",
						time => $strike_start
					&>
				</span>

				<span class="sixth">
					<% ucfirst($strikeword) %> due
				</span>

				<span class="sixth">
					<& /funclib/datepicker.mas, id => "strike_end" &>

					<input
						type  = "text"
						name  = "strike_end"
						id    = "strike_end"
						size  = "10"
						class = "notfirst"
						value = "<% ($strike_end) ? Tab::pickerdate($strike_end) : "" %>"
					>
				</span>

				<span class="sixth">
					<& /funclib/timepicker.mas,
						name => "strike_end_time",
						time => $strike_end
					&>
				</span>
			</div>

%			if ($prefs eq "ndt") {

				<div class="row">

					<span class="sixth">
						Elim Prefs open
					</span>

					<span class="sixth">
						   <& /funclib/datepicker.mas, id => "elim_strike_start" &>
						<input
							type  = "text"
							name  = "elim_strike_start"
							id    = "elim_strike_start"
							size  = "10"
							class = "notfirst"
							value="<% ($elim_strike_start) ? Tab::pickerdate($elim_strike_start) : "" %>"
						>
					</span>

					<span class="sixth">
						<&
							/funclib/timepicker.mas,
							name => "elim_strike_start_time",
							time => $elim_strike_start
						&>
					</span>

					<span class="sixth">
						Elim Prefs due
					</span>

					<span class="sixth">
						<& /funclib/datepicker.mas, id => "elim_strike_end" &>
						<input
							type  = "text"
							name  = "elim_strike_end"
							id    = "elim_strike_end"
							size  = "10"
							class = "notfirst"
							value = "<% ($elim_strike_end) ? Tab::pickerdate($elim_strike_end) : "" %>"
						>
					</span>

					<span class="sixth">
						<& /funclib/timepicker.mas,
							name => "elim_strike_end_time",
							time => $elim_strike_end
						&>
					</span>
				</div>

%			}


			<h5>Registration Settings</h5>

			<span class="pagehalf">

				<label for="obligation_before_strikes">
					<div class="hover row" >

						<span class="fivesixth ">
							No <% $strikeword %> until judge obligations met
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "obligation_before_strikes",
								value   => $category_settings{"obligation_before_strikes"},
								target  => $category,
								smaller => 1,
							&>
						</span>

					</div>
				</label>

				<label for="ask_paradigm">
					<div class="row hover" >
						<span class="fivesixth ">
							Ask for judge paradigms during registration
						</span>
						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "ask_paradigm",
								value   => $category_settings{"ask_paradigm"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="paradigm_before_strikes">
					<div class="hover row" >

						<span class="fivesixth ">
							No <% $strikeword %> unless all judges have paradigms
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "paradigm_before_strikes",
								value   => $category_settings{"paradigm_before_strikes"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

%			unless ($tourn_settings->{"nsda_district"}) {
				<label for="diversity_selfie">
					<div class="hover row" >

						<span class="fivesixth ">
							Judges may self-identify as diversity enhancing
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "diversity_selfie",
								value   => $category_settings{"diversity_selfie"},
								target  => $category,
								smaller => 1,
							&>
						</span>

					</div>
				</label>
%			}

			</span>

			<span class="pagehalf">
				<label for="free_strikes_dont_count">
					<div class="hover row" >
						<span class="fivesixth ">
							Free Strikes don't meet judge obligations
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "free_strikes_dont_count",
								value   => $category_settings{"free_strikes_dont_count"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="fyo_free_strikes">
					<div class="hover row" >
						<span class="fivesixth ">
							First year out judges are free strikes
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "fyo_free_strikes",
								value   => $category_settings{"fyo_free_strikes"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="free_strikes_no_pref">
					<div class="hover row" >
						<span class="fivesixth ">
							Do not pref free strikes
						</span>

						<span class="rightalign sixth">
							<& "/funclib/bool_switch.mas",
								tag     => "free_strikes_no_pref",
								value   => $category_settings{"free_strikes_no_pref"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row">
					<span class="third">
						Pref/strike pool
					</span>

					<span class="twothird rightalign">
						<select name="pref_jpool" class="fixedmed">
							<option value="">All <% $category->abbr %> judges</option>
%							foreach my $jpool ($category->jpools) {
								<option
									value="<% $jpool->id %>"
									<% $jpool->id == $category_settings{'pref_jpool'} ? "selected" : "" %>
								><% $jpool->name %></option>
%							}
						</select>
					</span>
				</div>

			</span>

%		}

		<span class="pagehalf">

			<h5>Conflicts</h5>

			<label for="conflicts">
				<div class="row">

					<span class="fivesixth">
						Enter conflicts separately
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "conflicts",
							value   => $category_settings{"conflicts"},
							target  => $category,
							smaller => 1,
						&>
					</span>

				</div>
			</label>

%		unless ($tourn_settings->{"nsda_district"}) {

			<label
				for   = "conflict_denominator"
				class = ""
			>

				<div class="row hover">

					<span class="fivesixth ">
						Include conflicts in ordinals' denominator
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "conflict_denominator",
							value   => $category_settings{"conflict_denominator"},
							target  => $category,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

%		}

%		unless ($tourn_settings->{"nsda_district"} && (not defined $tourn_settings->{"nsda_strikes"}) ) {

			<h5>Strikes</h5>

			<div class="row">

				<span class="threequarter">
					School-wide strikes/scratches
				</span>

				<span class="quarter centeralign">
					<input
						type  = "number"
						class = "smaller"
						name  = "school_strikes"
						size  = "3"
						min   = "0"
						max   = "99"
						value = "<% $category_settings{"school_strikes"} %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="threequarter">
					Per-entry strikes/scratches
				</span>

				<span class="quarter centeralign">
					<input
						type  = "number"
						class = "smaller"
						name  = "entry_strikes"
						size  = "3"
						min   = "0"
						max   = "99"
						value = "<% $category_settings{"entry_strikes"} %>"
					>
				</span>
			</div>

%		}

		</span>


		<span class="pagehalf">

%			unless ($tourn_settings->{"nsda_district"}) {

				<h5>Mutually Preferred Judging</h5>

				<div class="row">

					<span class="third">
						Pref Method
					</span>

					<span class="twothird rightalign">

						<select name="prefs" class="fixedmed">

							<option value="">
								None
							</option>

							<option value="tiered" <% $prefs eq "tiered" ? "selected" : "" %>>
								MPJ Tiers (by whole judge)
							</option>

							<option value="tiered_round" <% $prefs eq "tiered_round" ? "selected" : "" %>>
								MPJ Tiers (by round)
							</option>

							<option value="ordinals" <% $prefs eq "ordinals" ? "selected" : "" %>>
								MPJ Ordinals
							</option>

							<option value="community" <% $prefs eq "community" ? "selected" : "" %>>
								Community Ratings
							</option>

							<option value="caps" <% $prefs eq "caps" ? "selected" : "" %>>
								Whole Number Caps
							</option>

						</select>
					</span>
				</div>

				<label for="cumulate_prefs">

					<div class="row hover">

						<span class="fivesixth">
							Extra 1s = less 2s, etc
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "cumulate_prefs",
								value   => $category_settings{"cumulate_prefs"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

%			}

			<h5>Other Ratings</h5>

			<label for="coach_ratings">

				<div class="row hover">

					<span class="fivesixth">
						Ask coaches to rate their judges
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "coach_ratings",
							value   => $category_settings{"coach_ratings"},
							target  => $category,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<label for="tab_ratings">

				<div class="row hover">

					<span class="fivesixth">
						Use tab room ratings
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "tab_ratings",
							value   => $category_settings{"tab_ratings"},
							target  => $category,
							smaller => 1,
						&>
					</span>
				</div>
			</label>
			<label for="elim_only_ratings">

				<div class="row hover">

					<span class="fivesixth">
						IE: only use ratings for elims
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "elim_only_ratings",
							value   => $category_settings{"elim_only_ratings"},
							target  => $category,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

		</span>

		<div class="libl pagefull rightalign">
			<input
				type  = "submit"
				value = "Save Rating Changes"
			>
		</div>

	</div>

