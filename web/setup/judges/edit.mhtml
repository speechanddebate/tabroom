<%args>
	$person
	$tourn
	$tourn_settings
	$session
	$perms       => undef
	$new         => undef
	$page        => undef
	$category_id => undef
	$defaults    => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my ($category, $category_settings, $categories) = $m->comp('perms.mas',
		tourn       => $tourn,
		perms       => $perms,
		defaults    => $defaults,
		category_id => $category_id
	);

	if ($category && $defaults->{tourns}{$tourn}{category} ne $category) {
		$defaults->{tourns}{$tourn}{category} = int($category->{id});
		$session->default($defaults);
	}

	unless ($category_id == int($category)) {
		$category_id = int($category);
	}

	if ($ARGS{"new"}) {
		undef $category;
		undef $category_id;
		undef $page;
	}

	if ($page) {
		$m->redirect("edit.mhtml?category_id=".$category->{id}) if $page eq "edit";
		$m->redirect("hires.mhtml?category_id=".$category->{id}) if $page eq "hires";
		$m->redirect("tabbing.mhtml?category_id=".$category->{id}) if $page eq "tabbing";
		$m->redirect("ratings.mhtml?category_id=".$category->{id}) if $page eq "ratings";
		$m->redirect("tiers.mhtml?category_id=".$category->{id}) if $page eq "tiers";
		$m->redirect("coach_tiers.mhtml?category_id=".$category->{id}) if $page eq "coach_tiers";
		$m->redirect("shifts.mhtml?category_id=".$category->{id}) if $page eq "shifts";
		$m->redirect("pools.mhtml?category_id=".$category->{id}) if $page eq "pools";
	}

	my $judge_per++ if $category_settings->{"judge_per"};
	my $rounds_per++ if $category_settings->{"rounds_per"};

	if ($category_settings->{"details_deadline"}) {
		$category_settings->{"details_deadline"}->set_time_zone("UTC");
		$category_settings->{"details_deadline"}->set_time_zone($tz);
	}

	if ($category_settings->{"open_switcheroo"}) {
		$category_settings->{"open_switcheroo"}->set_time_zone("UTC");
		$category_settings->{"open_switcheroo"}->set_time_zone($tz);
	}

	if ($category_settings->{"close_switcheroo"}) {
		$category_settings->{"close_switcheroo"}->set_time_zone("UTC");
		$category_settings->{"close_switcheroo"}->set_time_zone($tz);
	}

	$page = "edit";
	$page = "new" if $new;

	my $dbh = Tab::DBI->db_Main();
	my $sth = $dbh->prepare('
		select
			event.id
		from event, event_setting es
		where event.category = ?
		and event.id = es.event
		and es.tag = "online_mode"
		and es.value IN ("nsda_campus", "nsda_campus_observers")
	');

	$sth->execute($category_id);
	my $campus_events = $sth->fetchall_hash();

	my @events = Tab::Event->search( category => $category->{id}, type => "congress");

	my $regions = $m->comp('/funclib/regions.mas',
		dbh            => $dbh,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
	);

</%init>

	<&
		"menu.mas",
		person         => $person,
		category_id    => $category_id,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		perms          => $perms,
		page           => $page,
		categories     => $categories
	&>

	<div class="main">

%	if ($category || $new) {

		<h2>
			<% ($category) ? $category->{name} : "Add New Judging Group" %>
		</h2>

%		if ($category) {
			<&
				"tabbar.mas",
				tourn             => $tourn,
				tourn_settings    => $tourn_settings,
				whoami            => "edit",
				category_settings => $category_settings,
				category          => $category->{id}
			&>
%		}

		<h4>Registration settings</h4>

		<form action="edit_save.mhtml" method="post">

		<input
			type  = "hidden"
			value = "<% $category->{id} %>"
			name  = "category_id"
		>

		<div class="pagefull wrap">

		<span class="pagehalf">
			<div class="row flexrow">
				<span class="twofifths padleft">
					Category Name
				</span>

				<span class="threefifths padright">
					<input
						id    = "category_name"
						type  = "text"
						name  = "name"
						class = "notfirst"
						value = "<% $category ?  $category->{name} : ""%>"
					>
				</span>
			</div>

			<label for="no_codes">
				<div class="row hover flexrow flexrow">
					<span class="fivesixth padleft">
						Suppress judge codes (names only)
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag      => "no_codes",
                            value    => $category_settings->{"no_codes"},
                            category_id   => $category,
                            smaller  => 1,
							function => "checkCode();"
                        &>
					</span>
				</div>
			</label>

			<div class="row codeme flexrow">
				<span class="fourfifths padleft">
					Start judge codes with
				</span>
				<span class="quarter">
					<input
						type  = "number"
						name  = "code_start"
						size  = "5"
						min   = "1"
						max   = "99999"
						value = "<% $category_settings->{"code_start"} %>"
					>
				</span>
			</div>

%			unless ($tourn_settings->{'mock_trial_registration'}) {
				<label for="field_report">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Publish the list of judges online
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "field_report",
								value   => $category_settings->{"field_report"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

				<label for="publish_paradigms">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Publish paradigms
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "publish_paradigms",
								value   => $category_settings->{"publish_paradigms"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			unless ($tourn_settings->{'mock_trial_registration'}) {
				<label for="linked_only">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Require judges to have linked Tabroom accounts
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag      => "linked_only",
								value    => $category_settings->{"linked_only"},
								category_id   => $category,
								smaller  => 1,
								callback => "checkLink()"
							&>
						</span>
					</div>
				</label>
%				}

				<div class="nospace link">
%				unless ($tourn_settings->{'mock_trial_registration'}) {
					<label for="link_phone_required">
						<div class="row hover flexrow">
							<span class="fivesixths padleft">
								Require judge accounts to have phone numbers
							</span>
							<span class="sixth centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "link_phone_required",
									value   => $category_settings->{"link_phone_required"},
									category_id  => $category,
									smaller => 1,
								&>
							</span>
						</div>
					</label>
%				}

%				if (scalar @{$campus_events} > 0) {
					<label for="link_campus_required">
						<div class="row hover flexrow">
							<span class="fivesixths padleft">
								Require judges to have accessed NSDA Campus
							</span>

							<span class="sixth centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "link_campus_required",
									value   => $category_settings->{"link_campus_required"},
									category_id  => $category,
									smaller => 1,
								&>
							</span>
						</div>
					</label>
%				}
			</div>

%			unless ($tourn_settings->{'mock_trial_registration'}) {
				<label for="departure_times">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Ask for judge departure times at registration
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "departure_times",
								value   => $category_settings->{"departure_times"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row flexrow">
					<span class="twofifths padleft">
						Judge details due
					</span>

					<span class="threetenths padmore">
						<& /funclib/datepicker.mas, id => "details_deadline" &>
						<input
							type        = "text"
							name        = "details_deadline"
							id          = "details_deadline"
							size        = "12"
							value       = "<% ($category_settings->{"details_deadline"}) ? Tab::pickerdate($category_settings->{"details_deadline"}) : "" %>"
							class       = "notfirst"
							placeholder = "Date"
						>
					</span>

					<span class="threetenths padmore padright">
						<&
							"/funclib/timepicker.mas",
							name        => "details_deadline_time",
							time        => $category_settings->{"details_deadline"},
							size        => "8",
							placeholder => "Time"
						&>
					</span>
				</div>
%			}

% 			if ($tourn_settings->{"ncfl"}) {

				<label for="tab_room">
					<div class="row flexrow">
						<span class="fivesixths padleft">
							Flat obligation (tab room)
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "tab_room",
								value   => $category_settings->{"tab_room"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row flexrow">
					<span class="threefifths padleft">
						Minimum per diocese
					</span>

					<span class="twofifths rightalign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "dio_min"
							value = "<% $category_settings->{"dio_min"} %>"
							size  = "4">
					</span>
				</div>
% 			}
		</span>

		<span class="pagehalf padleft">
			<div class="row flexrow">
				<span class="fivesixths padleft <% $category > 0 && (not defined $category->{abbr}) ? "required" : "" %>">
					Category Abbreviation
				</span>

				<span class="sixth padright">
					<input
						type      = "text"
						maxlength = "4"
						name      = "abbr"
						value     = "<% $category ? $category->{abbr} : "" %>"
					>
				</span>
			</div>

%			unless ($tourn_settings->{"mock_trial_registration"}) {
				<label for="show_judge_contacts">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Show judge contact info on registration printouts
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "show_judge_contacts",
								value   => $category_settings->{"show_judge_contacts"},
								category_id  => $category,
								smaller => 1
							&>
						</span>
					</div>
				</label>

				<label for="judge_quals">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Ask for judge qualifications and histories
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "judge_quals",
								value   => $category_settings->{"judge_quals"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			if ( $category && Tab::Event->search( category => $category->{id}, type => "congress") ) {

				<label for="ask_parli">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Ask for parliamentarians
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "ask_parli",
								value   => $category_settings->{"ask_parli"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			unless ($tourn_settings->{'mock_trial_registration'}) {

				<label for="first_year_outs">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Registrants can mark first year outs
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "first_year_outs",
								value   => $category_settings->{"first_year_outs"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row flexrow">
					<span class="twofifths padleft">
						Label for FYOs
					</span>

					<span class="threefifths rightalign padright">
						<input
							type  = "text"
							name  = "fyo_label"
							id    = "fyo_label"
							size  = "24"
							value = "<% $category_settings->{"fyo_label"}  %>"
						>
					</span>
				</div>

				<label for="neutrals">
					<div
						class = "row hover flexrow"
						title = "Neutral judges will be able to judge their own school's entries"
					>
						<span class="fivesixth padleft">
							Registrants can mark neutral judges
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "neutrals",
								value   => $category_settings->{"neutrals"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="double_entry">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Allow judge double-entry in other categories
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "double_entry",
								value   => $category_settings->{"double_entry"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="ask_alts">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Ask to specify an 2nd/alternate judge category
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "ask_alts",
								value   => $category_settings->{"ask_alts"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"mock_trial_registration"}) {

				<label for="observers">
					<div
						class = "row hover flexrow"
						title = "This category exists so adult observers and attendees can register without judging. It will show this category to all schools regardless of whether they have entries in an event in it."
					>
						<span class="fivesixths padleft">
							Observers or non-judging attendees
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "observers",
								value   => $category_settings->{"observers"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			if ($tourn_settings->{"nsda_district"}) {

				<div class="row hover flexrow">
					<span class="half">
						District weekend for category
					</span>
<%perl>
					my $alert;

					if ($category) {
						$alert = " Changing the weekend of a judge category will also change ";
						$alert .= "the weekend of the ".scalar @events." events in ";
						$alert .= "this category.  Events in one category must all be on the same ";
						$alert .= "weekend.  Are you sure?";
					}
</%perl>
					<span class="half rightalign">
						<select
							<& "/funclib/warn.mas", warning => $alert, change => 1 &>
							name  = "weekend"
							class = "fixedsmall"
						>
						<option value="nope">Not Held</option>
%						foreach my $weekend ($tourn->weekends) {
							<option
								value="<% $weekend->id %>"
								<% $weekend->id == $category_settings->{"weekend"}
									? 'selected="selected"'
									: ""
								%>><% $weekend->name %></option>
%						}
						</select>
					</span>
				</div>
%			}
		</span>

		<span class="pagehalf padright <% $tourn_settings->{"mock_trial_registration"} ? "hidden" : "" %>">
			<div>
				<span class="half nospace">
					<h5>
						Burden method
					</h5>
				</span>

				<span class="half rightalign semibold redtext nospace bottom padbottom">
					Pick only one
				</span>
			</div>

%			if ($tourn_settings->{"nsda_nats"}) {

				<label for="nats_category">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Main NSDA Nationals Judge Category
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "nats_category",
								value   => $category_settings->{"nats_category"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="usa_wsdc">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							NSDA Nationals World Schools
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "usa_wsdc",
								value   => $category_settings->{"usa_wsdc"},
								category_id  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

			<div class="row flexrow">
			    <span class="fourfifths padleft">
					Entries per judge owed
				</span>
				<span class="fifth padright">
					<input
						type     = "number"
						step     = ".01"
						min      = 0
						max      = 99
						name     = "judge_per"
						id       = "judge_per"
						class    = "burdens"
						onChange = "checkBurdens(this)";
						value    = "<% $category_settings->{"judge_per"} %>"
						size     = "4">
				</span>
			</div>

			<div class="row flexrow">
			    <span class="fourfifths padleft">
					Rounds owed per entry
				</span>
				<span class="fifth padright">
					<input
						type     = "number"
						min      = 0
						max      = 99
						step     = ".01"
						name     = "rounds_per"
						id       = "rounds_per"
						class    = "burdens"
						onChange = "checkBurdens(this)";
						value    = "<% $category_settings->{"rounds_per"} %>"
						size     = "4">
				</span>
			</div>

%			unless ($tourn_settings->{"nsda_district"}) {

				<h5 class="fixedheight">
					Charge for judges/bond
				</h5>

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Fee per judge in attendance
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							size  = "4"
							min   = "0"
							max   = "99999"
							name  = "attending_judge_fee"
							value = "<% $category_settings->{"attending_judge_fee"} %>"
						>
					</span>
				</div>

				<div
					class="row flexrow"
					id    = "auto_bond"
					title = "This feature is for a judge bond, not for hiring judge"
				>
					<span class="fourfifths padleft">
						Fee per judge obligation, hired or registered
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							size  = "4"
							min   = "0"
							max   = "999999"
							name  = "auto_bond"
							value = "<% $category_settings->{"auto_bond"} %>"
						>
					</span>
				</div>
% 			}

			<div class="full <% $category_settings->{"rounds_per"} ? "" : "hidden" %> custom_roundsper">

				<h5>Custom Round Obligations</h5>

				<p class="explain">
					Overrides the normal burden for specific entry numbers. Any
					number of entries not listed below will be obligated at the
					usual rate above.
				</p>
<%perl>
					my %customs = eval {
						return %{$category_settings->{'custom_rounds_per'}};
					};

					my @keys = sort keys %customs;
					my $limit = scalar @keys;
					$limit++;
					$limit = 5 if $limit < 5;

					foreach my $tick (1 .. $limit) {

						my $key = shift @keys if @keys;
</%perl>
						<div class="row flexrow">
							<span class="third">
								Entries
							</span>

							<span class="sixth centeralign">
								<input
									type  = "number"
									name  = "entries_<% $tick %>"
									min   = "0"
									max   = "999999"
									class = "smaller"
									value = "<% $key %>"
								>
							</span>

							<span class="third">
								Round Burden:
							</span>

							<span class="sixth centeralign">
								<input
									type  = "number"
									name  = "rounds_<% $tick %>"
									min   = "0"
									max   = "999999"
									class = "smaller"
									value = "<% $key ? $customs{$key} : "" %>"
								>
							</span>
						</div>
%					}
			</div>
		</span>

		<span class="padleft pagehalf <% $tourn_settings->{"mock_trial_registration"} ? "hidden" : "" %>">

			<h5>
				Alter burden
			</h5>

			<label for="drops_no_burden">
				<div class="row hover flexrow">
					<span class="fivesixths padleft">
						Drops do not count against judge burden
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "drops_no_burden",
                            value   => $category_settings->{"drops_no_burden"},
                            category_id  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

%			if ($judge_per || $rounds_per) {

				<div class="row flexrow">
					<span
						class="fourfifths padleft"
						title="Not hires; will print a warning"
					>
						Fine per missing <% $judge_per ? "judge" : "round" %>
					</span>

					<span class="fifth padright">
						<input
							type  = "number"
							size  = "4"
							min   = "0"
							max   = "999999"
							name  = "missing_judge_fee"
							value = "<% $category_settings->{"missing_judge_fee"} %>"
						>
					</span>
				</div>
%			}

%			if ($rounds_per || $category_settings->{"nats_category"}) {

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Maximum <% $tourn_settings->{"nsda_nats"} ? "days" : "rounds" %> per individual judge
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = 0
							max   = 99
							name  = "max_rounds"
							value = "<% $category_settings->{"max_rounds"} %>"
							size  = "4">
					</span>
				</div>
%			}

%			if ($category_settings->{"nats_category"}) {

                <& "/funclib/datepicker.mas",
                    id  => "open_switcheroo"
                &>

				<div class="row flexrow" title="The Judge Switcheroo is when judges can swap assignments">
					<span class="twofifths">
						Open Nats Switcheroo
					</span>
					<span class="twofifths">
                        <input
                            type  = "text"
                            name  = "open_switcheroo"
                            id    = "open_switcheroo"
                            size  = "8"
                            value = "<% Tab::pickerdate($category_settings->{"open_switcheroo"}) %>"
                        >
					</span>
					<span class="fifth padright">
                        <& /funclib/timepicker.mas,
                            name => "open_switcheroo_time",
                            size => 6,
                            time => $category_settings->{"open_switcheroo"}
						&>
					</span>
				</div>

                <& "/funclib/datepicker.mas",
                    id  => "close_switcheroo"
                &>

				<div class="row flexrow">
					<span class="twofifths">
						Close Switcheroo
					</span>
					<span class="twofifths">
                        <input
                            type  = "text"
                            name  = "close_switcheroo"
                            id    = "close_switcheroo"
                            size  = "8"
                            value = "<% Tab::pickerdate($category_settings->{"close_switcheroo"}) %>"
                        >
					</span>
					<span class="fifth padright">
                        <& /funclib/timepicker.mas,
                            name => "close_switcheroo_time",
                            size => 6,
                            time => $category_settings->{"close_switcheroo"}
						&>
					</span>
				</div>
%			}

%			if ($category_settings->{"rounds_per"}) {

				<label for="sections_per">
					<div class="row hover flexrow">
						<span class="fivesixths padleft">
							Count obligation by debate flight, not round
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag         => "sections_per",
								value       => $category_settings->{"sections_per"},
								category_id => $category,
								smaller     => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Free rounds: reduce total burden by
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = -999999
							max   = 999999
							name  = "free"
							value = "<% $category_settings->{"free"} %>"
							size  = "4">
					</span>
				</div>

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Large entry threshold
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "commitment_bump_after"
							value = "<% $category_settings->{"commitment_bump_after"} %>"
							size  = "4"
						>
					</span>
				</div>

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Add rounds per entry above threshold
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = -99
							max   = 99
							name  = "commitment_bump_unit"
							value = "<% $category_settings->{"commitment_bump_unit"} %>"
							size  = "4"
						>
					</span>
				</div>

%			} elsif ($category_settings->{"judge_per"}) {

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Minimum judges owed if school has entries
					</span>

					<span class="fifth padright">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "min_burden"
							value = "<% $category_settings->{"min_burden"} %>"
							size  = "4"
						>
					</span>
				</div>

%				if ($tourn_settings->{"nsda_nats"}) {

					<div class="row flexrow">
						<span class="fourfifths padleft">
							Penalty fine for not meeting minimum
						</span>

						<span class="fifth padright">

							<input
								type  = "number"
								min   = 0
								max   = 999999
								name  = "min_burden_fine"
								value = "<% $category_settings->{"min_burden_fine"} %>"
								size  = "8"
							>
						</span>
					</div>
%				}

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Maximum judges a school can owe
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "max_burden"
							value = "<% $category_settings->{"max_burden"} %>"
							size  = "4">
					</span>
				</div>

				<div class="row flexrow">
					<span class="fourfifths padleft">
						Free judges: reduce judge burden by
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = -99
							max   = 99
							name  = "free"
							value = "<% $category_settings->{"free"}  %>"
							size  = "4">
					</span>
				</div>

				<div class="row flexrow">
					<span class="fourfifths smallish padleft">
						Maximum number of judges that can <br />count towards their alternate category
					</span>
					<span class="fifth padright">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "alt_max"
							value = "<% $category_settings->{"alt_max"}  %>"
							size  = "4">
					</span>
				</div>
%			}
		</span>
		</div>

        <div class="libl rightalign full marno marbottom">
			<span class="centeralign half">
				<input
					type  = "submit"
					value = "Save Registration Settings"
				>
			</span>
		</div>

		</form>

<%perl>
		if ($category) {

			if ($tourn_settings->{regions}) {
</%perl>
				<div class="pagefull wrap">

					<span class="pagehalf padright">

						<div class="flexrow fixedheight">
							<span class="threefifths">
								<h5>
									Regional Judging Adjustment
								</h5>
							</span>
							<span
								class="twofifths rightalign padright padtop"
								title="Enter a percentage that the existing burden should be multiplied by.  To discount by half, enter 50.  To surcharge 25%, enter 125".
							>
								Percentage multiplier
							</span>
						</div>

						<form
							action = "region_adjustments.mhtml"
							method = "post"
						>
							<input
								type  = "hidden"
								name  = "category_id"
								value = "<% $category ? $category->id : "" %>"
							>

							<div class="full flexrow row">
								<span class="tenth semibold padleft">
									Add
								</span>

								<span class="half">
									<select name="region_id">
<%perl>
										foreach my $region_id (
											sort {$regions->{$a}{"code"} cmp $regions->{$b}{'code'}}
											keys %{$regions}
										) {
											next if $category_settings->{regional_judge_adjustments}{$region_id};
</%perl>
											<option
												value="<% $region_id %>"
											><% $regions->{$region_id}{code}." ".$regions->{$region_id}{name} %></option>
%										}
									</select>
								</span>

								<span class="sixth semibold padleft padright flexrow">
									<span class="threequarters">
										<input
											name = "adjustment"
											type = "number"
											min  = "-999"
											max  = "999"
											placeholder = '100'
										>
									</span>
									<span class="quarter padleft">%</span>
								</span>

								<span class="tenth semibold padleft">
									<input
										class = "thin"
										type  = "submit"
										value = "Go"
									>
								</span>

							</div>
<%perl>
							foreach my $region_id (
								sort {
									$regions->{$a}{code} cmp $regions->{$b}{code}
									|| $regions->{$a}{name} cmp $regions->{$b}{name}
								} keys %{$category_settings->{regional_judge_adjustments}}

							) {

								my $adjustment = $regions->{$region_id};
</%perl>
								<div
									id    = "adjustment_<% $region_id %>"
									class = "row full flexrow padvertless"
								>
									<span class="tenth semibold padleft padvert">
									</span>

									<span class="half padleft padvertless">
										<% $adjustment->{code} %>
										<% $adjustment->{name} %>
									</span>

									<span class="sixth semibold padleftmore padright flexrow">
										<% $category_settings->{regional_judge_adjustments}{$region_id} %>&percnt;
									</span>

									<span class="tenth semibold padleft">
										<a
											region_id   = "<% $region_id %>"
											category_id = "<% $category->id %>"
											class       = "fa fa-sm redtext fa-trash buttonwhite"
											onClick     = "postSwitch(this, 'regional_adjustment_rm.mhtml');"
										></a>
									</span>
								</div>
%							}

						</form>

					</span>

					<span class="pagehalf padleft">
%				}

				<div class="full nospace">

					<div class="fixedheight marno">
						<h5 class="padleftless">
							Qualifications &amp; questionnaires
						</h5>
					</div>
<%perl>
					my @quizzes = Tab::Quiz->search(hidden => 0);
					my %quiz_by_id = map {$_->id => $_} @quizzes;

					if ($category_settings->{"required_quizzes"}) {
</%perl>
						<div class="full" id="quiz_list">
							<p class="semibold">
								Required certification or quizzes
							</p>
<%perl>
							my $counter = 1;

							foreach my $quiz_id (@{$category_settings->{'required_quizzes'}}) {

								my $quiz = $quiz_by_id{$quiz_id};
								next unless $quiz;
</%perl>
								<div
									id    = "<% $quiz_id %>"
									class = "row flexrow"
								>
									<span class="tenth semibold">
										<% $counter++ %>.
									</span>

									<span class="fourfifths nowrap">
										<% $quiz->label %>
									</span>

									<span class="tenth centeralign">
										<a
											quiz_id      = "<% $quiz_id %>"
											category_id  = "<% $category %>"
											setting_name = "required_quizzes"
											class        = "buttonwhite redtext fa fa-sm fa-trash"
											onClick      = "postSwitch(this, 'quiz_rm.mhtml'); fixVisual();"
										></a>
									</span>
								</div>
%							}
						</div>
%					}

					<div class="row full flexrow">
						<span class="third padleft">
							Add requirement
						</span>

						<span class="twothirds padright">
							<select
								name         = "quiz_id"
								category_id  = "<% $category->{id} %>"
								set_class    = "row"
								setting_name = "required_quizzes"
								onChange     = "postSwitch(this, 'quiz_add.mhtml'); fixVisual();";
							>
								<option value=""></option>
<%perl>
								my %circuits = map {$_->id => 1} $tourn->circuits;

								foreach my $quiz_id (
									sort {
										$quiz_by_id{$a}->label cmp $quiz_by_id{$b}->label
									} keys %quiz_by_id
								) {

									unless ($quiz_by_id{$quiz_id}->sitewide) {
										next unless $circuits{$quiz_by_id{$quiz_id}->circuit};
									}
</%perl>
									<option
										value = "<% $quiz_id %>"
									><% $quiz_by_id{$quiz_id}->label %></option>
%								}
							</select>
						</span>
					</div>
				</div>
%			if ($tourn_settings->{regions}) {
				</div>
%			}
%		}

%	} else {

		<h2>Judge Categories</h2>

		<p>
			Add judge categories or edit judge category information.
		</p>
<%perl>

		Tab::Tourn->set_sql(other => "
			select tourn.*
				from tourn, category, category_setting
			where category_setting.value = ?
				and category_setting.tag = 'original_tourn'
				and category_setting.category = category.id
				and category.tourn = tourn.id
		");

		my $whered_they_go = Tab::Tourn->search_other($tourn->id)->first;

		if ($whered_they_go) {

			my @contacts = Tab::Permission->search(
				tourn => $whered_they_go->id,
				tag   => "contact"
			);

</%perl>
			<h3 class="martopmuchmore centeralign">
				Where's your data?!
			</h3>

			<h6 class="redtext centeralign">
				This tournament has been merged for tabbing!
			</h6>

			<p class="bigger semibold bluetext centeralign">
				Your data is in <% $whered_they_go->name %>
			</p>

			<p>
				To access rounds, results, and registration data you have to
				have admin access to that tournament.  If you do, leave this
				tournament (click your email address at top right) and enter
				the <% $whered_they_go->name %>.
			</p>

			<p>

				If you do not have access the other tournament, an admin of
				that tournament will have to grant you access.  The public
				contact info of that tournament is listed as:

			</p>

%			foreach my $contact (@contacts) {
				<a
					class="plain semibold bluetext centeralign martopmore"
					href="mailto:<% $contact->person->email %>"
				><% $contact->person->first." ".$contact->person->last.": ".$contact->person->email %></a>
%			}
%		}
%	}

%	if ($category) {

		<form
			action = "questions_save.mhtml"
			class  = "full"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->{id} %>"
		>

%		my $reg_questions = $category_settings->{"reg_questions"};

		<div class="martop bluebordertop">

			<div class="flexrow full">
				<span class="half">
					<h5>Judge Registration Questions</h5>
				</span>
				<span class="half explain rightalign semibold padtop bluetext">
					Asked of registering coaches or self-signed up judges.
				</span>
			</div>

			<div class="yellowrow semibold smallish padvertless flexrow nowrap">
				<span class = "twenty semibold">
				</span>
				<span class="half">
					Question text
				</span>
				<span class="tenth centeralign">
					Require
				</span>
				<span class="quarter">
					Answer Type
				</span>
				<span class="tenth semibold centeralign">
					Delete
				</span>
			</div>

%			my $deleted;
%			foreach my $rq (@{$reg_questions}) {

%				$deleted++ if $rq->{deleted};
				<div class="row flexrow">
					<span class="twenty semibold centeralign">
						<% $rq->{'id'} %>.
					</span>
					<span class="half">
						<input
							type  = "text"
							name  = "<% $rq->{id} %>_question"
							value = "<% $rq->{question} %>"
						>
					</span>

					<span class="tenth centeralign hover">
						<label for ="<% $rq->{id} %>_required" class='centeralign'>
							<input
								type  = "checkbox"
								name  = "<% $rq->{id} %>_required"
								id    = "<% $rq->{id} %>_required"
								value = "1"
								<% $rq->{required} ? 'checked' : "" %>
							>
						</label>
					</span>

					<span class="quarter centeralign">
						<select name="<% $rq->{id} %>_answer">
							<option value="text"
								<% $rq->{answer} eq "text" ? "selected" : "" %>
							>Open Textbox</option>

							<option
								value="bool"
								<% $rq->{answer} eq "bool" ? "selected" : "" %>
							>Yes/No</option>

							<option
								value="number"
								<% $rq->{answer}  eq "number" ? "selected" : "" %>
							>Number Only</option>
						</select>
					</span>

					<span
						class="tenth centeralign semibold hover"
						title="Hides the question from judges.  Does not delete information."
					>
						<label for ="<% $rq->{id} %>_deleted" class="centeralign">
							<input
								type  = "checkbox"
								name  = "<% $rq->{id} %>_deleted"
								id    = "<% $rq->{id} %>_deleted"
								value = "1"
								<% $rq->{deleted} ? 'checked' : "" %>
							>
						</label>
					</span>
				</div>
%			}

%			my $notfirst;

%			foreach my $tag (1 .. 3) {

				<div class="row flexrow">
					<span
						class = "twenty semibold centeralign"
						title = "Add New"
					>
						+
					</span>
					<span class="half">
						<input
							type = "text"
							name = "add_<% $tag %>_question"
						>
					</span>
					<span class="tenth centeralign">
						<input
							type  = "checkbox"
							name  = "add_<% $tag %>_required"
							value = "1"
						>
					</span>
					<span class="quarter centeralign">
						<select name="add_<% $tag %>_answer">
							<option value="text"
							>Open Textbox</option>

							<option value="bool"
							>Yes/No</option>

							<option value="number"
							>Number Only</option>
						</select>
					</span>
					<span class="tenth semibold">
					</span>
				</div>
%			}

			<div class="liblrow rightalign">
				<span class="half centeralign nospace">
					<input
						type  = "submit"
						value = "Save Questions"
					>
				</span>
			</div>

%			if ($deleted) {
				<p class="explain">
					Judge questions do not fully delete, because doing so would mean the permanent deletion of any
					answers judges have given, making this a non-undoable operation.  Make sure the check box here
					is marked as "delete" and it will not appear to any judges anymore though.
				</p>
%			}

		</div>

		</form>
%	}

	</div>
	<script>

		$(document).ready( () => {
			checkLink();
			checkCode();
		});

		function checkCode() {
			if ($(`#no_codes`).prop('checked') == true) {
				$(`.codeme`).addClass('hidden');
			} else {
				$(`.codeme`).removeClass('hidden');
			}
			fixVisual();
		}

		function checkLink() {
			$(`.link`).addClass('hidden');
			if ($(`#linked_only`).prop('checked') === true) {
				$(`.link`).removeClass('hidden');
			}

			fixVisual();
		}

		function checkBurdens(mememe) {

			var nonzero = 0;

			$(".burdens").each(function() {
				if ($(this).val()) {
					nonzero++;
				}
			});

			if (nonzero > 1) {
				$(".burdens").each(function() {
					if (this.id !== mememe.id) {
						$(this).val("");
					}
				});
				alertify.warning("You can only have one judge burden method, not both active at once");
			}

			if ($("#judge_per").val() > 0) {
				$("#auto_bond").removeClass("hidden");
			} else {
				$("#auto_bond_number").val("");
				$("#auto_bond").addClass("hidden");
			}

			if ($("#rounds_per").val()) {
				$(".custom_roundsper").removeClass("hidden");
				zebraRows();
			} else {
				$(".custom_roundsper").addClass("hidden");
			}
		};
	</script>
