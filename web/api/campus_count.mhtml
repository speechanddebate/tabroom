<%args>
	$date => undef
</%args>
<%init>

	my $now = DateTime->now();
	my $dbh = Tab::DBI->db_Main();

    my %zones = (
        'America/Los_Angeles'   => "us-west-2",
        'America/Denver'        => "us-west-2",
        'America/Phoenix'       => "us-west-2",
        'America/Adak'          => "us-west-2",
        'America/Anchorage'     => "us-west-2",
        'America/Boise'         => "us-west-2",
        'America/Curacao'       => "us-west-2",
        'America/Denver'        => "us-west-2",
        'America/Edmonton'      => "us-west-2",
        'America/El_Salvador'   => "us-west-2",
        'America/Los_Angeles'   => "us-west-2",
        'America/Managua'       => "us-west-2",
        'America/Mexico_City'   => "us-west-2",
        'America/Nome'          => "us-west-2",
        'America/Phoenix'       => "us-west-2",
        'America/Regina'        => "us-west-2",
        'America/Santo_Domingo' => "us-west-2",
        'America/Sitka'         => "us-west-2",
        'America/Tijuana'       => "us-west-2",
        'America/Vancouver'     => "us-west-2",
        'America/Winnipeg'      => "us-west-2",
        'Pacific/Honolulu'      => "us-west-2",
        'Pacific/Guam'          => "us-west-2",
    );

	my $sth = $dbh->prepare("
		select
			tourn.id, tourn.name,
			nc_purchased.value,
			nco_purchased.value,
			nsda_campus_days.value_text,

			CONVERT_TZ(tourn.start, '+00:00', tourn.tz),
			CONVERT_TZ(tourn.end, '+00:00', tourn.tz),

			tourn.tz
		from (tourn)
			 left join tourn_setting nsda_campus_days
				on tourn.id = nsda_campus_days.tourn
				and nsda_campus_days.tag = 'nsda_campus_days'

			 left join tourn_setting nco_purchased
				on tourn.id = nco_purchased.tourn
				and nco_purchased.tag = 'nco_purchased'

			 left join tourn_setting nc_purchased
				on tourn.id = nc_purchased.tourn
				and nc_purchased.tag = 'nc_purchased'

			where tourn.start < (NOW() + INTERVAL 1 HOUR)
			and tourn.end > (NOW() + INTERVAL 1 HOUR)
	");

	$sth->execute();

	my %zonecount;
	my $default = "us-east-2";

	while (
		my (
			$tourn_id, $name, $purchased, $observers,
			$day_json, $start, $tz
		)  = $sth->fetchrow_array()
	) {

		my $dt = DateTime::Format::MySQL->parse_datetime($start);

		my $daycount = 1;

		while ($dt->day != $now->day) {
			$dt->add(days => 1);
			$daycount++;
		}

		my $days = eval{
			return JSON::decode_json($day_json);
		};

		my $zone = $zones{$tz};
		$zone = $default unless $zone;

		$zonecount{$zone}{"tournaments"}++;
		$zonecount{$zone}{"today"} += $days->{$daycount}{"count"};
		$zonecount{$zone}{"purchased"} += $purchased + $observers;
	}

	$m->clear_buffer();
	$r->content_type('application/json');
	$m->print(JSON::encode_json(\%zonecount));
	$m->abort();

</%init>

