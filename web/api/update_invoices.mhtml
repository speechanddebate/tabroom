<%init>

	# Piss off, LinkedIn.
	my $remote_ip = $ENV{"HTTP_X_FORWARDED_FOR"} || $ENV{"REMOTE_ADDR"};

	unless (
		$remote_ip eq "127.0.0.1"
		|| $remote_ip eq "172.105.148.25"
		|| (index($remote_ip, "10.19.25") != -1)
		|| (index($remote_ip, "10.19.26") != -1)
	) {
		$m->print('{ "error": true, "message": "Access Denied to External Hosts"}');
		$m->abort();
	}

	my $now = DateTime->now();
	my $msg = $m->comp('/funclib/update_invoices.mas');

</%init>

<%doc>

	#This all did work so we can disable it now.

	my $person = Tab::Person->retrieve(1);
	my @accounts = ($person);

	my $from_string = "NSDA Office <info\@speechanddebate.org>";
	my $subject = "Invoice update ran";

	my $text = "The invoice notification ran starting at $now \n";
	$text .= "Output was $msg\n";

	$m->comp("/funclib/send_email.mas",
		accounts    => \@accounts,
		from_string => $from_string,
		real        => 1,
		subject     => $subject,
		body        => $text,
		no_footer   => 1,
		override    => 1
	);
</%doc>
