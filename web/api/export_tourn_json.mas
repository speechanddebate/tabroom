<%args>
	$tourn_id
	$username   => undef
	$password   => undef
	$session_id => undef
	$exclude_results => undef
</%args>
<%init>

	# This will probably break stuff for you if you find this before I can
	# manage to talk to you about it, but without it you created a method by
	# which anyone can download all data about any tournament in the system,
	# including prefs, contact info etc...   -- CLP
	# I am lighting a candle to the Catholic Saint of internet permissions
	# in your honor at the Cathederal de la Computistas in Los Angeles -- jcb

	my ($person, $tourn) = $m->comp("login_api.mas", 
		tourn_id   => $tourn_id,
		username   => $username,
		password   => $password,
		session_id => $session_id
	); 

	use JSON;
	use Encode qw(encode_utf8);
	use Switch;
	
	my $dbh = Tab::DBI->db_Main(); 

	#STEP ONE: create hash and put in entry info

	my %tourn_data;
	my $sql;

	# You had to know that a hand numbered case statement was like waving red
	# meat in front of a starving lion.  -- CLP
	# easy there, tiger -- jcb

	$sql = "SELECT entry.* FROM entry, event WHERE entry.event = event.id and event.tourn = ?";
	$tourn_data{"entry"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT entry_setting.* FROM entry_setting, entry 
			WHERE entry_setting.entry = entry.id and entry.tourn = ?";
	$tourn_data{"entry_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT event.* FROM event WHERE event.tourn = ?";
	$tourn_data{"event"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tourn WHERE id = ?";
	$tourn_data{"tourn"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tourn_setting WHERE tourn_setting.tourn = ?";
	$tourn_data{"tourn_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tourn_site WHERE tourn_site.tourn = ?";
	$tourn_data{"tourn_site"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT event_setting.* FROM event_setting, event 
		WHERE event_setting.event = event.id and event.tourn = ?";
	$tourn_data{"event_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT entry_student.* FROM entry_student, event, entry 
		WHERE entry_student.entry = entry.id 
		and entry.event = event.id 
		and event.tourn = ?";
	$tourn_data{"entry_student"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT category.* FROM category 
		WHERE category.tourn = ?";
	$tourn_data{"category"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT category_setting.* FROM category_setting, category 
		WHERE category_setting.category = category.id 
		and category.tourn = ?";
	$tourn_data{"category_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT jpool.* FROM jpool, category 
		WHERE jpool.category = category.id and category.tourn = ?";
	$tourn_data{"jpool"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT jpool_judge.* FROM jpool_judge, jpool, category 
		WHERE jpool_judge.jpool = jpool.id 
		and jpool.category = category.id 
		and category.tourn = ?";
	$tourn_data{"jpool_judge"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT jpool_round.* FROM jpool_round, jpool, category 
		WHERE jpool_round.jpool = jpool.id and jpool.category = category.id and category.tourn = ?";
	$tourn_data{"jpool_round"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT jpool_setting.* FROM jpool_setting, jpool, category 
		WHERE jpool_setting.jpool = jpool.id and jpool.category = category.id and category.tourn = ?";
	$tourn_data{"jpool_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT judge.* FROM judge, category WHERE judge.category = category.id and category.tourn = ?";
	$tourn_data{"judge"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT judge_setting.* FROM judge_setting, judge, category 
		WHERE judge_setting.judge = judge.id 
		and judge.category = category.id 
		and category.tourn = ?";
	$tourn_data{"judge_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM judge_hire WHERE tourn = ?";
	$tourn_data{"judge_hire"} = &execute_query($dbh, $sql, $tourn->id);

	unless ($exclude_results) {
		$sql = "SELECT panel.* FROM panel, round, event 
			WHERE panel.round = round.id 
			and round.event = event.id 
			and event.tourn = ?";
		$tourn_data{"panel"} = &execute_query($dbh, $sql, $tourn->id);
	}

	$sql = "SELECT * FROM pattern WHERE tourn = ?";
	$tourn_data{"pattern"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM rating WHERE tourn = ?";
	$tourn_data{"rating"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT rating_subset.* FROM rating_subset, category 
		WHERE rating_subset.category = category.id and category.tourn = ?";
	$tourn_data{"rating_subset"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT rating_tier.* FROM rating_tier, category 
		WHERE rating_tier.category = category.id and category.tourn = ?";
	$tourn_data{"rating_tier"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM region WHERE tourn = ?";
	$tourn_data{"region"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM region_fine WHERE tourn = ?";
	$tourn_data{"region_fine"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT circuit.* FROM circuit, tourn_circuit 
		WHERE tourn_circuit.circuit = circuit.id and tourn_circuit.tourn = ?";
	$tourn_data{"circuit"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT result.* FROM result, entry WHERE result.entry = entry.id and entry.tourn = ?";
	$tourn_data{"result"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM result_set WHERE tourn = ?";
	$tourn_data{"result_set"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT result_value.* FROM result_value, result, entry 
		WHERE result_value.result = result.id and result.entry = entry.id and entry.tourn = ?";
	$tourn_data{"result_value"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT site.* FROM site, tourn_site 
		WHERE tourn_site.site = site.id and tourn_site.tourn = ?";
	$tourn_data{"site"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tourn_site WHERE tourn = ?";
	$tourn_data{"tourn_site"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT room_strike.* FROM room_strike, room, tourn_site 
		WHERE room_strike.room = room.id 
		and room.site = tourn_site.site 
		and tourn_site.tourn = ?";
	$tourn_data{"room_strike"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT room.* FROM room, site, tourn_site 
		WHERE room.site = site.id and tourn_site.site = site.id 
		and tourn_site.tourn = ?";
	$tourn_data{"room"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT round.* FROM round, event 
		WHERE round.event = event.id and event.tourn = ?";
	$tourn_data{"round"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT round_setting.* FROM round_setting, round, event 
		WHERE round_setting.round = round.id 
		and round.event = event.id 
		and event.tourn = ?";
	$tourn_data{"round_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM rpool 
		WHERE tourn = ?";
	$tourn_data{"rpool"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT rpool_room.* FROM rpool_room, rpool 
		WHERE rpool_room.rpool = rpool.id and rpool.tourn = ?";
	$tourn_data{"rpool_room"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT rpool_round.* FROM rpool_round, rpool 
		WHERE rpool_round.rpool = rpool.id and rpool.tourn = ?";
	$tourn_data{"rpool_round"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM school 
		WHERE tourn = ?";
	$tourn_data{"school"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT school_setting.* FROM school_setting, school 
		WHERE school_setting.school = school.id and school.tourn = ?";
	$tourn_data{"school_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT chapter.* FROM chapter, school 
		WHERE chapter.id = school.chapter and school.tourn = ?";
	$tourn_data{"chapter"} = &execute_query($dbh, $sql, $tourn->id);

	unless ($exclude_results) {

		$sql = "SELECT score.* FROM score, ballot, entry, event 
			WHERE score.ballot = ballot.id 
			and ballot.entry = entry.id 
			and entry.event = event.id 
			and event.tourn = ?";
		$tourn_data{"score"} = &execute_query($dbh, $sql, $tourn->id);

		$sql = "SELECT ballot.* FROM ballot, entry, event 
			WHERE ballot.entry = entry.id 
			and entry.event = event.id 
			and event.tourn = ?";
		$tourn_data{"ballot"} = &execute_query($dbh, $sql, $tourn->id);

	}

	$sql = "SELECT * FROM strike 
		WHERE tourn = ?";
	$tourn_data{"strike"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT shift.* FROM shift, category 
		WHERE shift.category = category.id and category.tourn = ?";
	$tourn_data{"shift"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT student.* FROM student, entry_student, entry, event 
		WHERE entry_student.student = student.id 
		and entry_student.entry = entry.id 
		and entry.event = event.id 
		and event.tourn = ?";
	$tourn_data{"student"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT student_setting.* 
		FROM student_setting, entry_student, entry, event 
		WHERE student_setting.student = entry_student.student
		and entry_student.entry = entry.id 
		and entry.event = event.id 
		and event.tourn = ?";
	$tourn_data{"student_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT sweep_event.* FROM sweep_event, event 
		WHERE sweep_event.event = event.id and event.tourn = ?";
	$tourn_data{"sweep_event"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM sweep_set WHERE tourn = ?";
	$tourn_data{"sweep_set"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT sweep_rule.* FROM sweep_rule, sweep_set 
		WHERE sweep_rule.sweep_set = sweep_set.id and sweep_set.tourn = ?";
	$tourn_data{"sweep_rule"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tiebreak_set WHERE tourn = ?";
	$tourn_data{"tiebreak_set"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT tiebreak.* FROM tiebreak, tiebreak_set 
		WHERE tiebreak.tiebreak_set = tiebreak_set.id and tiebreak_set.tourn = ?";
	$tourn_data{"tiebreak"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT tiebreak_set_setting.* FROM tiebreak_set, tiebreak_set_setting 
		WHERE tiebreak_set_setting.tiebreak_set = tiebreak_set.id and tiebreak_set.tourn = ?";
	$tourn_data{"tiebreak_set_setting"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM timeslot WHERE tourn = ?";
	$tourn_data{"timeslot"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT * FROM tourn_circuit WHERE tourn = ?";
	$tourn_data{"tourn_circuit"} = &execute_query($dbh, $sql, $tourn->id);

	$sql = "SELECT district.* FROM district, school WHERE school.tourn = ? 
		and school.district = district.id";
	$tourn_data{"district"} = &execute_query($dbh, $sql, $tourn->id);
	
	sub execute_query { 

		my ($dbh, $query, $args) = @_;
		
		my $entry_sth = $dbh->prepare($query);

		$entry_sth->execute($args);

		my $ref;
		my %response; 

		while($ref = $entry_sth->fetchrow_hashref) {
			foreach my $key ( keys %$ref ) {
				$response{ %$ref{'id'} }{$key} = %$ref{$key};
			}
		}

		return \%response;
	}

	my $now = DateTime->now();
	my $filename = $tourn->name;

	$filename  = ~ s/[\W_]//g;
	$filename = $filename."-".$now->ymd('-')."-at-".$now->hms('-').".json";

	$r->content_type('application/json');
	$r->headers_out->{'Content-Disposition'} = "attachment; filename = $filename";

	my $json = JSON->new->indent(0)->latin1(0)->canonical->allow_blessed->convert_blessed->encode( \%tourn_data );

	$m->clear_buffer();
	$m->print( $json );
	$m->abort();

</%init>
