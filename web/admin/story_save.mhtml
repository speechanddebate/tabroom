<%args>
	$account
	$title
	$text
	$pinned => undef
	$story_id => undef
	$attach => undef
	$active => undef
</%args>
<%init>

	my $story = Tab::News->retrieve($story_id) if $story_id;

	chomp $text;
	chomp $title;

	my $now = DateTime->now;

	my $err;

	if ($story)  { 

		$story->title($title);
		$story->active($active);
		$story->text($text);
		$story->edited_by($account->id);
		$story->edited_on($now);
		$story->pinned($pinned);
		$story->update;

		$err = "Changes to ". $story->title ." saved";

	} else {  

		$story = Tab::News->create({ 
			title => $title,
			author => $account->id,
			active => $active,
			pinned => $pinned,
			sitewide => 1,
			posted => $now,
			text => $text,
		});

		$err = "Story ". $story->title ." created ";

	}

    if ($attach) {
        my $req = Apache2::Request->new($r);
        my $upload = $req->upload("attach");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
        $filename =~ s/\'//g;  # '  stupid vim
        my $filepath = "$Tab::file_root/files/sitewide/articles/".$story->id;
        my $garbage = `rm -f $filepath`;
        $garbage = `mkdir -p $filepath`;
        my $filetemp = $upload->tempname;
        $garbage = `cp $filetemp $filepath/$filename`;
        $story->file($filename);
        $story->update;
	}

	$m->redirect("story_edit.mhtml?story_id=".$story->id."&err=$err");

</%init>

