<%args>
	$tourn
	$tourn_settings
	$panel_id
	$session
</%args>
<%perl>

	my $panel = Tab::Panel->retrieve($panel_id);

	unless ($panel) {
		$m->comp(
			"/funclib/abort.mas",
			message => "No such section found."
		);
	}

	my $round = $panel->round;
	my $event = $round->event;

	#Set up the filename and the needed trace files
    my $name = $event->abbr."-".$panel->letter."-".$round->realname;
    $name =~ s/[\W_]//g;

    my $filename = "MasterBallots-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;

	my $type = $event->type;

	$type = "debate"
		if $type eq "ld"
		|| $type eq "policy"
		|| $type eq "pf"
		|| $type eq "big_questions"
		|| $type eq "parli";

	my $big_questions = $event->setting("big_questions");

    $m->comp("/funclib/printout.mas",
		tourn         => $tourn,
		filename      => $filename,
		head          => 1,
		wide          => 1,
		big_questions => $big_questions
	);

	if ($round && $tourn_settings->{"nsda_nats"}) {

		if ($event->setting("combined_ballots")) {

			$m->comp("ballots/combined_masters.mas",
				round    => $round,
				panel    => $panel,
				filename => $filename
			);

			$m->comp("/funclib/printout.mas",
				tourn    => $tourn,
				filename => $filename,
				tail     => 1,
				pdflatex => 1
			);
		}
	}

	foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {

		$m->comp("ballots/speech_master.mas",
				judge_id => $judge->id,
				panel_id => $panel->id,
				chair    => $judge->chair,
				filename => $filename) if $type eq "speech";

		$m->comp("ballots/congress_master.mas",
				judge_id       => $judge->id,
				panel_id       => $panel->id,
				chair          => $judge->chair,
				tourn_settings => $tourn_settings,
				filename       => $filename) if $type eq "congress";

		$m->comp("ballots/wudc_master.mas",
				judge_id => $judge->id,
				panel_id => $panel->id,
				filename => $filename) if $type eq "wudc" && $judge->chair;

		$m->comp("ballots/wsdc_master.mas",
				judge_id => $judge->id,
				panel_id => $panel->id,
				chair    => $judge->chair,
				filename => $filename) if $type eq "wsdc";

		if ($type eq "debate") {

			if ($big_questions) {
				$m->comp("ballots/big_questions.mas",
					judge_id => $judge->id,
					panel_id => $panel->id,
					chair    => $judge->chair,
					filename => $filename
				);
			} else {
				$m->comp("ballots/debate_master.mas",
					judge_id => $judge->id,
					panel_id => $panel->id,
					chair    => $judge->chair,
					filename => $filename
				);
			}
		}

    	open (TEXOUT, ">>$filepath.tex");
		print TEXOUT "\\newpage\n";
		close TEXOUT;
	}

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1,
		pdflatex => 1
	);

</%perl>
