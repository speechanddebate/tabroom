<%args>
	$tourn
	$session
	$round_id    => undef
	$timeslot_id => undef
	$debug       => undef
	$event_id    => undef
	$panel_id    => undef
</%args>
<%init>

	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $tourn_id = $tourn->id;
	my @events;
	my @panels;
	my $round;

	if ($round_id) {
		$round = Tab::Round->retrieve($round_id);
		push @events, $round->event;
	} elsif ($panel_id) {
		push (@panels, Tab::Panel->retrieve($panel_id));
		push (@events, $panels[0]->round->event);
	} elsif ($event_id eq "all") {
		@events = $m->comp(
			"/funclib/tourn_events.mas",
			tourn => $tourn
		);
	} else {
		push (@events, Tab::Event->retrieve($event_id));
	}

 	my @timeslots;

	if ($timeslot_id eq "all") {
		@timeslots = $tourn->timeslots;
	} else {
		push (@timeslots, Tab::Timeslot->retrieve($timeslot_id));
	}

	@events = sort {$a->abbr <=> $b->abbr} @events;

	my $ncfl = $tourn->setting("ncfl");

	# Set up the filename and the needed trace files

	my $event_name;
	if ($event_id) {
		$event_name .= $events[0]->abbr;
	}
	$event_name =~ s/[\W_]//g;

	my $timeslot_name;
	if ($timeslot_id) {
		$timeslot_name .= $timeslots[0]->name;
	}
	$timeslot_name =~ s/[\W_]//g;

	my $panel_name;

	if ($panel_id && $events[0]->type eq "speech") {
		$panel_name .= "Section ".$panels[0]->letter;
	}
	$panel_name =~ s/[\W_]//g;

	my $name = $event_name;
	$name .= "-".$timeslot_name if $timeslot_name;
	$name .= "-".$panel_name if $panel_name;
	$name = $round->realname."-".$events[0]->abbr if $round;

	my $filename = "Postings-$name";
    my $filepath = $Tab::file_root."/tmp/".$filename;

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		head     => 1,
		taller   => 1
	);

    open (TEXOUT, ">>$filepath.tex");

	foreach my $event (@events) {

		my $names;
		my $codes;

		my $no_codes = $event->category->setting("no_codes");

		my $schem_style  = $event->setting("schem_designation");

		$names++ if $schem_style eq "names" || $schem_style eq "both";
		$codes++ if $schem_style eq "codes" || $schem_style eq "both";

		$codes++ unless $names || $codes;

		if ($round) {

			@panels = $round->panels();

		} elsif (@timeslots && (not defined $panel_id)) {

			@panels = ();

			foreach my $timeslot (@timeslots) {
				push @panels, $m->comp(
					"/funclib/event_panels.mas",
						timeslot => $timeslot,
						event    => $event
					);
			}

		}

		my $fontsize;

		foreach my $panel (@panels) {

			my $round = $panel->round;

			$fontsize = 48;
			$fontsize = 36 if length($event->name) > 20;
			$fontsize = 24 if length($event->name) > 32;

			print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont ";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "{\\bf ".$event->name." }\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";

			$fontsize -= 8;
			print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont ";
			print TEXOUT Tab::texify(uc($round->realname))."\n";

			if ($round->type eq "final" || $round->type eq "runoff") {

			} else {

				print TEXOUT "\\hfill\n";

				if ($event->type eq "congress") {
					print TEXOUT " CHAMBER ";
					print TEXOUT Tab::texify(uc($panel->letter))."\n"
				} elsif ($event->type eq "speech") {
					print TEXOUT " SECTION ";
					print TEXOUT Tab::texify(uc($panel->letter))."\n"
				}
			}

			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			if ($event->type eq "speech") {
				print TEXOUT "\\vspace{-12mm}\n";
			} else {
				print TEXOUT "\\smallskip\n";
			}

			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\makebox[.8\\textwidth]{\\hrulefill}\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			if ($event->type eq "speech") {

				print TEXOUT "\\vspace{4mm}\n";
				print TEXOUT "\\newline\n";
				$fontsize = 36;

			} elsif ($event->type eq "congress") {

				print TEXOUT "\\vspace{4mm}\n";
				print TEXOUT "\\newline\n";
				$fontsize = 32 if $codes;
				$fontsize = 24 if $names;

			} else {

				print TEXOUT "\\vspace{12mm}\n";
				print TEXOUT "\\newline\n";
				$fontsize = 54 if $codes;
				$fontsize = 36 if $names;
			}

			print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont \n";

			my $switch;
			my $notfirst;

			my @entries = $m->comp(
				"/funclib/panel_entries.mas",
				panel    => $panel,
				no_drops => 1
			);

			my $switch_threshold = 3 if $codes;
			$switch_threshold = 2 if $names;

			if ($event->type eq "congress") {
				@entries = sort {$a->code <=> $b->code} @entries if $codes;
				@entries = sort {$a->lastname cmp $b->lastname} @entries if $names;
			}

			foreach my $entry (@entries) {

				if ($event->type eq "speech") {

					print TEXOUT "\\strut\n";
					print TEXOUT "\\hfill\n";
					print TEXOUT Tab::texify($entry->code)." \n" if $codes;
					print TEXOUT Tab::texify($entry->name)." \n" if $names;
					print TEXOUT "\\hfill\n";
					print TEXOUT "\\strut\n";

					print TEXOUT "\\vspace{4mm}\n";
					print TEXOUT "\\newline\n";

				} elsif ($event->type eq "congress") {

					if ($switch++) {
						if ($switch % $switch_threshold) {
							print TEXOUT "\\hfill\n ";
						} else {
							if ($names) {
								print TEXOUT "\\vspace{4mm}\n";
							} else {
								print TEXOUT "\\vspace{8mm}\n";
							}
							print TEXOUT "\\newline\n";
						}
					} elsif ($switch_threshold == 3) {
						$switch += 2; #ugly hack
					} elsif ($switch_threshold == 2) {
						$switch ++; #similarly ugly hack
					}

					print TEXOUT Tab::texify($entry->code)." \n" if $codes;
					print TEXOUT Tab::texify($entry->name)." \n" if $names;

				} else {

					if ($notfirst++) {
						print TEXOUT "\\newline\n";
						print TEXOUT "\\strut\n";
						print TEXOUT "\\hfill\n";
						print TEXOUT "\\noindent \\emph{\\Huge vs} \n";
						print TEXOUT "\\hfill\n";
						print TEXOUT "\\strut\n";
						print TEXOUT "\\bigskip\n";
						print TEXOUT "\\newline\n";
					}

					print TEXOUT "\\strut\n";
					print TEXOUT "\\hfill\n";
					print TEXOUT Tab::texify($entry->code)." \n" if $codes;
					print TEXOUT Tab::texify($entry->name)." \n" if $names;
					print TEXOUT "\\hfill\n";
					print TEXOUT "\\strut\n";
					print TEXOUT "\\medskip\n";
				}

			}

			if ($event->type eq "speech") {
				print TEXOUT "\\vspace{-12mm}\n";
			}

			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\makebox[.8\\textwidth]{\\hrulefill}\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			print TEXOUT "\\newline";

			print TEXOUT "\\fontsize{24pt}{24pt}\\selectfont \n";

			if ($panel->room > 0) {
				print TEXOUT "\\strut\n";
				print TEXOUT "\\hfill\n";
				print TEXOUT "{\\bf ROOM: ".Tab::texify($panel->room->name) ."} ";
				print TEXOUT "\\strut\n";
				print TEXOUT "\\hfill\n";
				print TEXOUT "\\medskip\n";
				print TEXOUT "\\newline";
			}

			my $start = $round->start_time->set_time_zone($tz)
				if $round->start_time;

			$start = $round->timeslot->start->set_time_zone($tz)
				unless $start;

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "BEGIN: ".Tab::texify(Tab::nicetime($start))."\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\makebox[.8\\textwidth]{\\hrulefill}\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "{\\bf JUDGES: }\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\strut\n";

			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			undef $switch;

			$fontsize = 24;
			$fontsize = 20 unless $no_codes;

			print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont \n";

			my @judges = $m->comp(
				'/funclib/panel_judges.mas',
				panel => $panel
			);

			foreach my $judge (@judges) {

				if ($switch++) {
					if ($switch % 2) {
						print TEXOUT "\\vspace{4mm}\n";
						print TEXOUT "\\newline\n";
					} else {
						print TEXOUT "\\hfill\n ";
					}
				}

				if ($judge->chair) {
					print TEXOUT " \\emph{\*}" unless $event->type eq "congress";
					print TEXOUT " \\emph{\*}" if $event->type eq "congress";
				}

				print TEXOUT Tab::texify($judge->schoolcode)." " unless $no_codes;
				print TEXOUT Tab::texify($judge->code)." " unless $no_codes;

				print TEXOUT Tab::texify(ucfirst($judge->last));
				print TEXOUT ", ".Tab::texify(ucfirst($judge->first));

			}

			print TEXOUT "\\newpage \n";

		} # end of foreach panel

	} # end of foreach event

	close TEXOUT;

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1
	);

</%init>
