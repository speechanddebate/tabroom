<%args>
	$session
	$event_id
	$tourn
	$sort_by => undef
</%args>
<%init>

	my @events;

	my $name;

	if ($event_id eq "all") {
		push @events, $tourn->events(type => 'speech');
		$name = $tourn->name;
	} elsif ($event_id eq int($event_id)) {
		push @events, Tab::Event->retrieve($event_id);
		$name = $events[0]->name;
	}

    unless (@events) {
		my $err =  "You did not specify an event to print speech cards.  Please try again";
		$m->redirect("/panel/printouts.mhtml&err=$err");
	}

	$name =~ s/[\W_]//g;

	my $filename = "SpeechCards-$name-".$session->id;
	my $filepath = $Tab::file_root."tmp/".$filename;

	$m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		head     => 1,
		taller   => 1
	);

	open (TEXOUT, ">>$filepath.tex");
	print TEXOUT "\\smallskip\n";

	print TEXOUT "\\renewcommand{\\arraystretch}{1.8}\n";
	print TEXOUT "\\setlength{\\tabcolsep}{6.2pt}";
	print TEXOUT "\\setlength{\\doublerulesep}{0pt}";

	foreach my $event (@events) {

		foreach my $entry (
			sort {$a->code cmp $b->code}
			$event->entries(active => 1)
		) {

			print TEXOUT "\\noindent\n";
			print TEXOUT "\\begin{minipage}{7in}";
			print TEXOUT "\\truncate{1.4in} { ";
			print TEXOUT "\\LARGE \\bf ";
			print TEXOUT &Tab::texify($entry->code);
			print TEXOUT " } ";
			print TEXOUT "\\hspace{.25in} ";

			print TEXOUT "\\textsb{\\large ".&Tab::texify($entry->name)." }\n";
			print TEXOUT "\\hfill {\\normalsize ". &Tab::texify($entry->school->short_name)." } \n";

			print TEXOUT "\\hfill ";
			print TEXOUT "\\textsb{\\large ".&Tab::texify($event->abbr)." } ";

			print TEXOUT "\\vspace{.03in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\raggedright\n";

			my $tabular = "\\begin{tabular}{||p{1.25in}|p{.5in}|p{1.5in}|p{1.5in}||p{1.25in}||}\n";
			my $index = "\\textsb{Speaker} & \\textsb{Rnd} & \\textsb{Section} & \\textsb{Round Rank} & \\textsb{Up/Down} ";

			print TEXOUT $tabular."\n";
			print TEXOUT "\\hline \\hline \n\n";
			print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.3pt\]\[5.3pt\]\n";
			print TEXOUT $index." \\\\ \n";

			foreach my $tick (1 .. 8 ) {

				print TEXOUT "\\hline \\hline \n\n";
				print TEXOUT "\\rowcolor[rgb]{1,.95,.66}\[5.3pt\]\[5.3pt\]\n" if $tick % 2;
				print TEXOUT " & ";
				print TEXOUT "\\hfill $tick \\hfill \\strut & ";
				print TEXOUT " & ";
				print TEXOUT " & ";
				print TEXOUT "\\\\ \n";

			}

			print TEXOUT "\\hline \\hline \n\n";
			print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\vspace{.45in}\n";
			print TEXOUT "\\end{minipage}";
			print TEXOUT "\\newline\n";

		}

		print TEXOUT "\\newpage\n";

	}

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1
	);

</%init>
