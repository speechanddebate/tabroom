<%args>
	$circuit
	$tourn
	$account
	$debug => undef
</%args>

%	my $crap;
%	my $switch;
% 	system $Tab::logger ." Checking for lopsided panels " if $debug;

	<h2>Disasters Waiting to Happen for <% $tourn->name %></h2>

<%perl>

	my @bad_rounds;

	foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 

		next if $event->type eq "debate";

		foreach my $round ($event->rounds) { 

			push (@bad_rounds, $round) if $round->unbalanced;

		}
	}

</%perl>

%	if (@bad_rounds) { 

		<h4>Rounds out of balance </h4>

		<table cellpadding="5" width="75%">

% 			foreach my $round (@bad_rounds) { 

%				my $block = "white block" unless $switch % 1;
%				$block = "grey block" unless $switch % 2;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<% $round->event->name %>
					</td>

					<td>
						Round <% $round->name %>
					</td>
		
					<td>
						<a class="<% $block %>" href="/panel/schemat/show.mhtml?round_id=<% $round->id %>">View Schematic</a>
					</td> 

					<td>
						<a class="<% $block %>" href="/panel/rebalance.mhtml?round_id=<% $round->id %>">Rebalance Round</a>
					</td> 

				</tr>

% 			}

		</table>

%	}

%# Double booked judges

%	system $Tab::logger ." Printed lopsided panels " if $debug;

		<h4>Double booked judges</h4>

%		my @double_booked = $tourn->double_booked_judges;

%		if (@double_booked) { 

			<table cellpadding="5" cellspacing="1" width="75%">

%				foreach my $judge (@double_booked) {

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							Judge <% $judge->code %> <% $judge->last %>
						</td>
						
						<td>
							<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $judge->id %>">Edit Judge</a>
						</td>
					</tr>

%				}

			</table>

%		} else { 
		
			<p>No judges are double booked</p>

%		}

		<h4>Judging panels</h4>

%			my @count_panels = $tourn->panels_with_judgecount;
%			my @bad_panels;

%			foreach my $count (@count_panels) { 
%				my $num_judges = $tourn->method->num_judges;
%				$num_judges = 1 unless $num_judges;
%				push (@bad_panels, $count) if $count->num_judges != $num_judges;
%			}

%			if (@bad_panels) { 

				<table cellpadding="5" cellspacing="1" width="30%">
	
%				foreach my $panel (@bad_panels) { 

%					my $block = "white block" unless $switch % 1;
%					$block = "grey block" unless $switch % 2;
				
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
					
						<td>
							<a class="<% $block %>" href="/panel/panel_view.mhtml?panel_id=<% $panel->id %>">
								<% $panel->event->abbr %> <%$panel->letter %> Round <% $panel->round->name %>
							</a>
						</td>

						<td>
							Has <% $panel->num_judges %> judges
						</td>

					</tr>

%				}
				
				</table>

%			} else { 

				<p>All prelims have judges</p>
% 			}

	<br>

	<h4>Panels without Rooms: </h4>

	<table cellpadding="5" cellspacing="1" width="30%">

% 		$crap = 0;

% 		foreach my $panel (sort {$a->event->name cmp $b->event->name} $tourn->panels_without_rooms) { 

%			$crap++;

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
	
					<a href="<% $Tab::url_prefix %>/panel/rooms_manassign.mhtml?event_id=<% $panel->event->id %>"><% $panel->event->abbr %> <%$panel->letter %> Round <% ($panel->round) ? $panel->round->name : "" %></a>

				</td>
			</tr>

%		}

% 		if ($crap < 1) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					None!
				</td>
				
			</tr>
% 		}

%		system $Tab::logger ." Checked and printed panels without rooms " if $debug;

		</table>

		<h4>Entries without assignments: </h4>

		<table cellpadding="5" cellspacing="1" width="30%">

% 			$crap = 0;

% 			foreach my $entry (sort {$a->code cmp $b->code} $tourn->unassigned_entries) { 

%				$crap++;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
					<td>
						<a href="<% $Tab::url_prefix %>/register/entry_edit.mhtml?entry_id=<% $entry->id %>"><% $entry->school->code." ".$entry->code %></a>
					</td>
				</tr>
%			}

% 			if ($crap < 1) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						None!
					</td>

				</tr>

% 			}

%			system $Tab::logger ." Checked and printed competitors without assignments" if $debug;

		</table>




