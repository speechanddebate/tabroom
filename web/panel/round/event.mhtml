<%args>
	$tourn
	$event_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	use POSIX;
	my $switch;

</%init>

	<& /funclib/tablesorter.mas, table => "panels" &>

	<& menu.mas, tourn => $tourn, event => $event &>

	<div class="left huge">

		<h2>Panel <% $event->name %></h2>

%		unless ($event->rounds) { 

			<p>
				You have no rounds scheduled of <% $event->name %> so it's going
				to be awfully hard for me to panel any.  Please 
				<a href="/setup/schedule/event.mhtml?event_id=<% $event->id %>">set a schedule up</a>.
			</p>

%		} else { 

			<table cellpadding="5" cellspacing="1" width="100%" id="panels">

				<thead>

				<tr class="yellowrow">

					<th class="smaller">
						<form action="panel_master.mhtml" method="post">
						<input type="hidden" name="event_id" value="<% $event->id %>">
						Round
					</th>

					<th class="smaller">
						Field
					</th>

					<th class="smaller">
						Type
					</th>

					<th class="smaller">
%						if ($event->type eq "congress") {
							Number of Chambers
%						} elsif ($event->type eq "speech") {
							Number of Sections
%						} else { 
							Flighting
%						} 
					</th>

					<th class="smaller">
						Custom 
					</th>

					<th class="smaller">
						Existing
					</th>

					<th class="smaller">
						Panel?
					</th>

%					if ($event->type eq "congress") {
						<th class="smaller">
							Wipe*
						</th>
%					}
					
				</tr>

				</thead>

				<tbody>

<%perl>

			foreach my $round (sort {$a->name <=> $b->name} $event->rounds) { 

				next if $round->type eq "elim" || $round->type eq "final";
				next unless $event->entries;

				if ($event->type eq "speech") { 
	   			
			   		my $num_competitors = scalar $event->entries( waitlist => 0, unconfirmed => 0, dropped => 0, dq => 0);

   				 	my $minpanelsize = $tourn->setting("min_panel_size");
					$minpanelsize = 5 unless $minpanelsize;

    				my $maxpanelsize = $tourn->setting("max_panel_size");
					$maxpanelsize = 8 unless $maxpanelsize;
			
	    			my $defaultpanelsize = $tourn->setting("default_panel_size");
					$defaultpanelsize = 6 unless $defaultpanelsize;

   	 				my $max_panel_number = ceil($num_competitors / $minpanelsize);
    				my $min_panel_number = ceil($num_competitors / $maxpanelsize);

					$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
							if ($num_competitors / $minpanelsize) < $min_panel_number;

					$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
						if $min_panel_number && (($num_competitors / $min_panel_number) < $min_panel_number);

</%perl>

					<tr>

						<td class="smaller">
							<% $round->realname %>
						</td>

						<td class="centeralign smaller">	
							<% $num_competitors %>
						</td>

						<td class="centeralign smaller">	
							<% ucfirst($round->type) %>
						</td>

						<td class="smaller">	
<%perl>
							my $last_panel_size;

							foreach my $num_panels ($min_panel_number .. $max_panel_number) {

								next unless $num_panels > 0;
	
		     					my $panel_size = ceil($num_competitors/$num_panels);
    		   					my $competitors_if_panels_full = $num_panels * $panel_size;
								my $num_short_panels = $competitors_if_panels_full - $num_competitors;
								my $num_full_panels = $num_panels - $num_short_panels;
								
								next if $num_short_panels < 0 or $num_full_panels <= 0; 
							
								$defaultpanelsize = $panel_size 
									if ($last_panel_size > $defaultpanelsize && $panel_size < $defaultpanelsize); 
									
								$last_panel_size = $panel_size;

</%perl>

								<span style="smallspan">
									<input style="margin-right: 5px;" type="radio" 
										name="num_panels_<% $round->id %>" id="num_panels_<% $num_panels %>"
										value=" <% $num_panels %> " <% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>>

									<label for="num_panels_<% $num_panels %>">
										<% $num_panels %>
									</label>
								</span>

%							}

						</td>

						<td class="smaller">
							<input type="number" size="5" min=0 max=999 name="force_num_panels_<% $round->id %>" placeholder="# Panels">
						</td>

						<td class="centeralign smallish">
							<% scalar $round->panels %>
						</td>

						<td class="centeralign">
							<input type="checkbox" name="do_<% $round->id %>" value="1" "checked">
						</td>

					</tr>

%				} elsif ($event->type eq "congress") { 

<%perl>
			   		my $num_competitors = scalar $event->entries( waitlist => 0, unconfirmed => 0, dropped => 0, dq => 0);

    				my $minchambersize = $tourn->setting("min_chamber_size");
					$minchambersize = 15 unless $minchambersize;

    				my $maxchambersize = $tourn->setting("max_chamber_size");
					$maxchambersize = 30 unless $maxchambersize;
    
					my $defaultchambersize = $tourn->setting("default_chamber_size");	
					$defaultchambersize = 25 unless $defaultchambersize;

    				my $max_chamber_number = ceil($num_competitors / $minchambersize);
	    			my $min_chamber_number = ceil($num_competitors / $maxchambersize);

					$defaultchambersize = ceil($num_competitors / $min_chamber_number) 
						if ($num_competitors / $minchambersize) < $min_chamber_number;


</%perl>
					<tr>

						<td class="smaller">
							<% $round->realname %>
						</td>
						
						<td class="centeralign smaller">	
							<% $num_competitors %>
						</td>

						<td class="smaller centeralign">	
							<% ucfirst($round->type) %>
						</td>

						<td class="smaller">
<%perl>
							foreach my $num_chambers ($min_chamber_number .. $max_chamber_number) {
    		 					my $chamber_size = ceil($num_competitors/$num_chambers);
       							my $competitors_if_chambers_full = $num_chambers * $chamber_size;
       							my $num_short_chambers = $competitors_if_chambers_full - $num_competitors;
       							my $num_full_chambers = $num_chambers - $num_short_chambers;
       							next if $num_short_chambers < 0 or $num_full_chambers <= 0;
</%perl>
								<span style="smallspan">
									<input style="margin-right: 4px;" type="radio" 
										name="num_panels_<% $round->id %>" id="num_panels_<% $num_chambers %>" 
										value=" <% $num_chambers %> " <% ($chamber_size == $defaultchambersize) ? 'checked' : '' %>>

									<label for="num_panels_<% $num_chambers %>">
										<%$num_chambers %>
									</label>
								</span>

%							}
						</td>

						<td class="smaller">
							<input type="number" size="5" min=0 max=999 name="force_num_panels_<% $round->id %>" placeholder="# Panels">
						</td>
			
						<td class="centeralign">
							<% scalar $round->panels %>
						</td>
			
						<td class="centeralign">
							<input type="checkbox" name="do_<% $round->id %>" value="1" "checked">
						</td>

						<td class="centeralign">
							<input type="checkbox" name="wipe_<% $round->id %>" value="1" "checked">
						</td>

					</tr>

%				} else { 

%			   		my $num_competitors = scalar $event->entries( waitlist => 0, unconfirmed => 0, dropped => 0, dq => 0);

					<tr>

						<td class="smaller">
							<% $round->realname %>
						</td>
						
						<td class="centeralign smaller">	
							<% ucfirst($round->type) %>
						</td>

						<td class="smaller">
							<input type="radio" name="num_panels_<% $round->id %>" value="1" id="<% $round->id %>_1">
								<label for="<% $round->id %>_1">Single</label>
							<input type="radio" name="num_panels_<% $round->id %>" value="2" id="<% $round->id %>_2">
								<label for="<% $round->id %>_2">Double</label>
							<input type="radio" name="num_panels_<% $round->id %>" value="3" id="<% $round->id %>_3">
								<label for="<% $round->id %>_3">Use All Rooms</label>
							<input type="radio" name="num_panels_<% $round->id %>" value="4" id="<% $round->id %>_4">
								<label for="<% $round->id %>_4">Max Prefs</label>
						</td>

						<td class="centeralign">
							<% scalar $round->panels %>
						</td>

						<td class="centeralign">
							<input type="checkbox" name="do_<% $round->id %>" value="1" "checked">
						</td>

					</tr>

%				}

%			}

			</tbody>

			<tr class="liblrow">
				<td colspan="8" class="rightalign">
					<input type="submit" value="Panel All Rounds">
					</form>
				</td> 
			</tr>
		
		</table>

%		} 

%		if ($event->type eq "congress") { 
			<p class="explain">
				* By default if any congress rounds exist, the system will
				clone the same chambers into all prelim rounds.  Checking this
				box will delete any existing rounds and instead create new
				chamber assignments for the tournament
			</p>
%		}

		<div class="liblrow rightalign smallish">
			<form action="manual.mhtml" method="post">
			<input type="hidden" name="event_id" value="<% $event->id %>">
			<input type="submit" value="Panel Rounds Manually">
			</form>
		</div> 

	</div>
