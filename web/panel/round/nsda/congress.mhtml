<%args>
	$tourn
	$tourn_settings
	$person
	$round_id 
	$next    => undef
	$default => undef
</%args>
<%init>

	use POSIX;

	my $round = Tab::Round->retrieve($round_id) if $round_id;

	unless ($round) { 
		$m->comp("/funclib/abort.mas", 
			err => "No valid round ID sent."
		);
	}

	my $previous_round;

	if ($next) { 

		$previous_round = $round;

		my $next_round = Tab::Round->search(
			event => $previous_round->event->id,
			name  => ($round->name + 1)
		)->first;

		if ($next_round > 0) { 

			$round = $next_round;
			undef $next;

		} else { 
			undef $round;
		}
		
	} else  { 

		$previous_round = Tab::Round->search(
			event => $round->event->id,
			name  => ($round->name - 1)
		)->first;
	}

	my $event = $round->event;
	my %event_settings = $event->all_settings();

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	unless ($event->type eq "speech" || $event->type eq "congress") { 
		$m->comp("/funclib/abort.mas", 
			err => "Sorry, this is really intended for speech events only"
		);
	}

	my $minpanelsize = 20;
	my $maxpanelsize = 30;

	my $num_competitors = scalar $event->entries( active => 1, dq => 0);

	my $num_chambers = floor($num_competitors / 30);
	$num_chambers++ if $num_competitors % 30;

	my $max_panel_number = ceil($num_competitors / $minpanelsize);
	my $min_panel_number = ceil($num_competitors / $maxpanelsize);

	my $final_minimum = 8;
	my $final_maximum = 12;

	if ($num_competitors > 60) { 
		$final_minimum = 6;
		$final_maximum = 8;
	}

	if ($num_competitors > 90) { 
		$final_minimum = 4;
		$final_maximum = 6;
	}

	my $final_limit = floor(30 / $num_chambers);

	my $final_floor = ceil(24 / $num_chambers);

	$final_maximum = $final_limit 
		if $final_limit < $final_maximum;

	$final_minimum = $final_floor 
		if $final_floor < $final_minimum;

	my $elim_minimum;
	my $elim_maximum;

	if ($num_competitors > 120) { 

		$elim_minimum = $final_minimum;
		$elim_maximum = $final_maximum;

		$final_minimum = 4;
		$final_maximum = 8;
	}

    my @tabs;

    if ($previous_round) { 
        push @tabs, "results";
    }   

    push @tabs, "create";

	my @chambers = $round->panels;

    if (@chambers && scalar @chambers > 0) { 
        push @tabs, "checks";
    }   

    unless ($default) { 
        $default = "create";
        $default = "checks" if (@chambers && scalar @chambers > 0); 
    }   

    my %outs;
    my %entries_by_id = (); 

    if ($previous_round) { 
        %entries_by_id =
            map {$_->id => $_} 
            $m->comp("/funclib/round_entries.mas", 
                round => $previous_round
            );
    } else { 
 
        %entries_by_id = 
            map {$_->id => $_} 
            $event->entries( active => 1) ;

    }   

    my $district = Tab::District->retrieve($tourn_settings->{"nsda_district"});

	my @seed_results = $m->comp(
		"/tabbing/results/order_entries.mas",
		round        => $previous_round
	);

	my $entries_ref = pop @seed_results if @seed_results;
	my %round_settings = $round->all_settings if $round; 

	my ($total_quals, $alternates, $total_entries) = 
		$m->comp("/funclib/nsda_qualifier_count.mas", event => $event);

</%init>

    <&  "menu.mas",
        round          => $round,
        event          => $event,
        whoami         => "congress",
        round_settings => \%round_settings,
        event_settings => \%event_settings,
        district       => $district,
        total_quals    => $total_quals,
        total_entries  => $total_entries,
        alternates     => $alternates
    &>  


	<div class="main">

		<div class="full nospace">

			<span class="twofifths nospace">
				<h2>Assign Chambers</h2>
			</span>
			
			<span class="threefifths nospace rightalign bluetext">
				<h4><% $round->realname %> of <% $event->name %></h4>
			</span>

		</div>

%       unless (scalar @tabs < 2) { 
            <&
                "/funclib/tabs.mas", 
                    tabs    => \@tabs,
                    default => $default
            &>
%       }
	

		<div 
			id="create"
            class = "create screens"
		>

		<form 
			action="/panel/round/panel_master.mhtml" 
			method="post"
		>

			<input 
				type    = "hidden"
				id      = "room_<% $event->id %>"
				name    = "room_<% $event->id %>"
				value   = "1"
			>

			<input 
				type    = "hidden"
				name    = "round_id"
				value   = "<% $round->id %>"
			>

			<input 
				type    = "hidden"
				name    = "whoami"
				value   = "congress.mhtml"
			>

%           if (@chambers) { 

                <div class="lightrow">

                    <div class="full warning centeralign">
                        This round has already been sectioned!
                    </div>

                    <span class="threequarters rightalign">
                        Type "I am certain" to confirm deleting existing
                        sections and creating new ones:
                    </span>

                    <span class="quarter">
                        <input 
                            type           = "text"
                            size           = '16'
                            name           = "certain"
                            autocomplete   = "off"
                            autocorrect    = "off"
                            autocapitalize = "off"
                            spellcheck     = "false"
                        >
                    </span>
                </div>

%           }


			<div class="lightrow">

				<span class="rightalign quarter semibold padtop">
					Timeslot
				</span>

				<span class="twentieth">
				</span>

				<span class="threeeighths padtop">

					<select 
						name  = "timeslot_id"
						class = "fixedmed"
					>

<%perl>
					my $round_timeslot_id;

					if ($round && $round->timeslot) { 
						$round_timeslot_id = $round->timeslot->id;
					} 

					my $minimum_start = 
						$previous_round->timeslot->end->set_time_zone($tz) 
						if $previous_round;

					foreach my $timeslot ($tourn->timeslots) { 

						my $start = $timeslot->start->set_time_zone($tz);
						next if $start < $minimum_start;

</%perl>

						<option 
							value="<% $timeslot->id %>"
							<% $round_timeslot_id == $timeslot->id ? 'selected="true"' : "" %>
						><% $timeslot->name %> &ndash; <% Tab::niceshortdayt($start) %></option>
%					}
					</select>

				</span>

				<span class="threeeighths">
				</span>

			</div>

			<div class="lightrow">

				<script>

					function changeRoundType() {


						if ($("#prelim").prop("checked")) { 

							$(".final").addClass("hidden");
							$(".elims").addClass("hidden");
							$(".prelims").removeClass("hidden");

							$(".finalbox").prop("disabled", true);
							$(".elimbox").prop("disabled", false);
							$(".prelimbox").prop("disabled", false);
						} 

						if ($("#elim").prop("checked") ) { 

							$(".elims").removeClass("hidden");
							$(".elimbox").prop("disabled", false);

							$(".final").addClass("hidden");
							$(".prelims").addClass("hidden");

							$(".finalbox").prop("disabled", true);
							$(".prelimbox").prop("disabled", true);
						}

						if ($("#final").prop("checked") ) { 

							$(".final").removeClass("hidden");
							$(".elims").addClass("hidden");
							$(".prelims").addClass("hidden");

							$(".finalbox").prop("disabled", false);
							$(".elimbox").prop("disabled", false);
							$(".prelimbox").prop("disabled", true);
						} 

						zebraRows();
					};

					$(document).ready(function(){
						changeRoundType();
						zebraRows();
					});
					
				</script>

				<span class="quarter rightalign semibold">
					Session Type
				</span>

				<span class="twentieth">
				</span>

				<span class="threefifths">

					<label for="prelim">

						<span class="quarter hover">
							<input 
								type    = "radio"
								name    = "round_type"
								value   = "prelim"
								id      = "prelim"
								onchange = "changeRoundType();"
								<% (not defined $round) ? 'checked="checked"' : "" %>
								<% $round && $round->type ne "final" ? 'checked="checked"' : "" %>
							>
							Prelim 
						</span>

					</label>

%					if ($num_competitors > 120) { 

						<label for="elim">

							<span class="quarter hover">
								<input 
									type     = "radio"
									name     = "round_type"
									value    = "elim"
									id       = "elim"
									onchange = "changeRoundType();"
									<% $round && $round->type eq "elim" ? 'checked="checked"' : "" %>
								>
								Semi
							</span>

						</label>
%					}


					<label for="final">

						<span class="quarter hover">
							<input 
								type     = "radio"
								name     = "round_type"
								value    = "final"
								id       = "final"
								onchange = "changeRoundType();"
								<% $round && $round->type eq "final" ? 'checked="checked"' : "" %>
							>
							Final
						</span>

					</label>
				</span>

			</div>

			<div class="lightrow">

				<span class="quarter semibold rightalign">
					Number of Scorers
				</span>

				<span class="twentieth">
				</span>

				<span class="quarter">
					<input
						type  = "number"
						name  = "num_judges"
						value = "3"
						min   = "1"
						max   = "7"
					>

				</span>

				<span class="fourtenths rightalign semibold explain redtext">
					Parliamentarians must be manually assigned
				</span>


			</div>

%			my @rpools = $tourn->rpools;
%			my @jpools = $event->category->jpools;

%			if (@rpools) { 

				<div class="lightrow">

					<span class="rightalign quarter semibold martopmore marbottommore">
						Room Pool(s)
					</span>

					<span class="twentieth">
					</span>

					<span class="threeeighths">

						<select 
							name="rpool_id" 
							class="fixedmed"
						>
							<option value=""></option>

%							foreach my $rpool (@rpools) {
								<option 
									value="<% $rpool->id %>"
								><% $rpool->name %></option>
%							}

						</select>

					</span>

					<span class="quarter">
%						if ($round) { 
%							foreach my $rpool ($round->rpools) { 
								<div class='full padless marno'>
									<% $rpool->name %>
								</div>
%							}
%						}

					</span>

				</div>

%			}

%			if (@jpools) { 

				<div class="lightrow">

					<span class="rightalign quarter semibold martopmore marbottommore">
						Judge Pool(s)
					</span>

					<span class="twentieth">
					</span>


					<span class="threeeighths">

						<select 
							name="jpool_id" 
							class="fixedmed"
						>
							<option value=""></option>
%							foreach my $jpool (@jpools) {
								<option 
									value="<% $jpool->id %>"
								><% $jpool->name %></option>
%							}
						</select>
					</span>

					<span class="quarter">
%						if ($round) { 
%							foreach my $jpool ($round->jpools) { 
								<div class='full padless marno'>
									<% $jpool->name %>
								</div>
%							}
%						}

					</span>

				</div>
%			}


			<div class="lightrow padmuchmore">

				<span class="rightalign quarter semibold">
					Active Competitors
				</span>

				<span class="twentieth">
				</span>

				<span class="eighth padtop padbottom">
					<% $num_competitors %>
				</span>

			</div>

			<div class="lightrow prelims">

				<span class="quarter semibold rightalign">
					Number of Chambers
				</span>

				<span class="twentieth">
				</span>

				<span class="threequarters">

%				if ($num_competitors < 120) { 

					<span class="full nospace padtopmore padbottommore">

						<% $num_chambers %>

						<input 
							class = "hidden prelimbox"
							type  = "text"
							name  = "num_panels"
							value = "<% $num_chambers %>"
						>

					</span>

%				} else { 

<%perl>
					my $last_panel_size;

					foreach my $num_panels ($min_panel_number .. $max_panel_number) {

						next unless $num_panels > 0;

						my $panel_size = ceil($num_competitors/$num_panels);

						my $competitors_if_panels_full = $num_panels * $panel_size;

						my $num_short_panels = $competitors_if_panels_full - $num_competitors;

						my $num_full_panels = $num_panels - $num_short_panels;
							
						next if $num_short_panels < 0 
							|| $num_full_panels <= 0; 
						
						my $defaultpanelsize = $panel_size ;
							
						$last_panel_size = $panel_size;

</%perl>

						<label for="num_panels_<% $round->id %>_<% $num_panels %>">

							<span class="sixth hover nospace padtopless padbottomless">

								<input 
									type  = "radio"
									name  = "num_panels_<% $round->id %>"
									id    = "num_panels_<% $round->id %>_<% $num_panels %>"
									value = "<% $num_panels %>"
									<% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>
								>

								<%$num_panels %>

							</span>

						</label>

%					}


%				}

			</div>

			<div class="lightrow elims">

				<span class="quarter semibold rightalign">
					Advance
				</span>

				<span class="twentieth">
				</span>

				<span class="half">

%					foreach my $tick ($elim_minimum .. $elim_maximum) { 

						<label for="<% $tick %>">
							<span class="quarter hover">

								<input 
									id    = "<% $tick %>"
									type  = "radio"
									class = "elimbox"
									name  = "advance"
									value = "<% $tick %>"
								>

								<% $tick %>

							</span>
						</label>

%					}

				</span>

				<span class="fifth semibold rightalign">
					per chamber
				</span>

			</div>

			<div class="lightrow final">

				<span class="quarter semibold rightalign">
					Advance
				</span>

				<span class="twentieth">
				</span>

				<span class="half">

%					foreach my $tick ($final_minimum .. $final_maximum) { 

						<label for="<% $tick %>">
							<span class="fifth hover centeralign nospace">

								<input 
									id    = "<% $tick %>"
									type  = "radio"
									class = "finalbox"
									name  = "advance"
									value = "<% $tick %>"
								>

								<% $tick %>

							</span>
						</label>

%					}

				</span>

				<span class="fifth semibold rightalign">
					per chamber
				</span>

			</div>

			<div class="libl nospace">

				<span class="threequarters">
				</span>

				<span class="quarter padtopmore marno">
					<input 
						type  = "submit"
						value = "Assign Chambers"
					>
				</span>
			</div>

		</form>

		</div>

%       if (@chambers) { 

            <div 
                id    = "checks"
                class = "checks screens"
            >

                <& "congress_checks.mas", 
                    round          => $round,
                    tourn          => $tourn,
                    tourn_settings => $tourn_settings,
					event          => $event,
                    person         => $person,
                    strength       => ${$entries_ref}{"tiebreak"}{"1"}
                &>

            </div>

%       }

	


	</div>

