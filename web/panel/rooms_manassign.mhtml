<%args>
	$circuit
	$tourn
	$timeslot_id => undef
	$event_id => undef
	$err => undef
	$debug => undef
</%args>
<%init>
	
	my @timeslots = Tab::Timeslot->search( 
			tournament => $tourn->id, {order_by => "start"});

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $event = Tab::Event->retrieve($event_id) if $event_id;

	my @rounds;

	if ($timeslot_id) {
		system "$Tab::logger Calling the timeslot specificity" if $debug;
		@rounds = $timeslot->rounds unless $event_id;
		@rounds = $timeslot->rounds( event => $event_id) if $event_id;
		@rounds = sort {$a->event->name cmp $b->event->name} @rounds;
	}

	if ($event_id &! $timeslot_id) {
		system "$Tab::logger Calling the event specificity" if $debug;
		@rounds = $event->rounds;
		@rounds = sort {$a->timeslot->start->epoch <=> $b->timeslot->start->epoch} @rounds;
		system "$Tab::logger I found ".scalar @rounds." rounds" if $debug;
	}

</%init>

	<div class="left huge">
				
		<h2>Manual room assignment</h2>

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr> 
			
				<td class="smaller">
					<form action="rooms_manassign.mhtml" method="post"> 
					For timeslot:
				</td> 
				
				<td>
					<select name="timeslot_id">
					<option value="">All Timeslots</option>

% 					foreach my $ts (@timeslots) {
						<option value="<% $ts->id %>" <% ($ts->id == $timeslot_id) ? "selected" : "" %> >
							<% $ts->name %>
						</option>
% 					}	
			
				</td> 
				
				<td>
					Event:
				</td>
				
				<td>
				
					<select name="event_id">

						<option value="">All Events</option>

%							foreach my $event (sort {$a->name cmp $b->name} $tourn->events) {

								<option value="<% $event->id %>" <% ($event->id == $event_id) ? "selected" : "" %> >
									<% $event->name %>
								</option>

% 							}

					</select>

				</td> 
				
				<td>
					<input class="blue" type="submit" value="Show">
					</form>
				</td> 
				
			</tr> 
			
		</table>

		<hr>

		<table cellpadding="5" cellspacing="1" width="100%" >
			<form action="rooms_save.mhtml" method="post">
			<input type="hidden" name="timeslot_id" value="<% $timeslot_id %>">
			<input type="hidden" name="event_id" value="<% $event_id %>">

%			if ($timeslot_id) { 

%				my $switch;

%				foreach my $round (@rounds) { 
%					my @panels = $round->panels;
%					next unless @panels;
%				    @panels = sort {$a->letter cmp $b->letter } @panels;
%					@panels = sort {$a->event->abbr cmp $b->event->abbr } @panels;

%					foreach my $panel (@panels) { 
						<& room_panel_options.mas, panel => $panel, switch => $switch++ &>
%					}
%				}

%			} elsif ($event_id &! $timeslot_id) { 

				<tr>

%					my $counter;

%					foreach my $round (@rounds) { 
%						my @panels = $round->panels;
%						next unless @panels;
%		    			@panels = sort {$a->letter cmp $b->letter } @panels;
%						@panels = sort {$a->event->abbr cmp $b->event->abbr } @panels;

%						my $switch;

%						if ($switch % 3) { 
							</tr>
							<tr>
%						}

						<td class="center">
							<table cellpadding="3" cellspacing="1" width="95%">
	
								<tr>
									<th colspan="4">
										Round: <% ($round->label) ? $round->label : $round->name %>
									</th>
								</tr>

%								foreach my $panel (@panels) { 
									<& room_panel_options.mas, panel => $panel, switch => $switch++ &>
%								}

							</table>
						</td>
%					}

			</tr>

%		}	

%		if (@rounds) { 

			<tr>
				<td colspan="5" align="center">
					<input class="blue" type="submit" value="Save Assignments">
					</form>
				</td>
			</tr>

%		}

		</table>

	</div>


	<div id="rightsmall">

		<h3>Rooms Assignment:</h3>

		<a href="rooms.mhtml?type=auto" class="blue block">Automatic Panel</a>
		<a href="rooms.mhtml?type=manual" class="dkblue block">Manual Panel</a>
		<a href="rooms_master.mhtml" class="blue block">View Rooms Master</a>
		<a href="rooms_print.mhtml" class="blue block">Print Rooms Master</a>

	</div>
