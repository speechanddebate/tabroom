<%args>
	$person
	$round_id
	$bracket            => -1
	$entries_hash_ref   => undef
	$precluded_hash_ref => undef
	$entry_to_pair      => undef
</%args>
<%init>

	#WARN CHRIS ABOUT SAVE_PAIRING.MAS

	#set to zero to suppress messages, 1 to enable
	my $debug = 0;

	print "Round id is $round_id. " if $debug;
	print "At load bracket is $bracket<br>" if $debug;

	$m->abort unless $round_id;

	# Works off of 4 basic global hash/arrays; this allows the functions to
	# access the information they need @entries is a global array of all
	# entries in the event; %entries is a hash with record and SOP information
	# in it %precluded stores which teams can't hit each other; %bracket are
	# the teams in the bracket being paired
	# for top 3 tables, 0=code, 1=W, 2=seed, 3=SOP, 4=TB2, 5=seed w/o wins,
	# 6=oppW, 7=side due, 8=pullups, 9=oppon, 10=bye button, 11=pull button, 12=entry id, 13=bracket

	use POSIX;
	use List::Util 'shuffle';
	use Time::HiRes qw( time );

	my $round = Tab::Round->retrieve($round_id);
	$m->abort unless $round;

	my $event = $round->event;
	my %event_settings = $event->all_settings;

	my $powermatch_method = $event_settings{"powermatch"};

	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};
	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $round_name = $round->name;
	my $bracket_not_set++ if $event_settings{"bracket_set_for"} != $round_id;

    my $side_locked;
    my $side_lock_against;

	my $sidelock_against = $round->setting("sidelock_against");

    if ($sidelock_against) {

        if ($sidelock_against ne "NONE"
			&& $sidelock_against ne "RANDOM"
		) {
            $side_locked++;
            $side_lock_against = $sidelock_against;
        }

    } else {
        $side_locked++ unless ($round->name % 2);
        undef $side_locked if $event_settings{"no_side_constraints"};
    }

	my $style_str = "style='display:none';" unless $side_locked;
	print "Side locked: ".$side_locked."<br>" if $debug;

	my $start = time();

	#load the pairing hash
	($entries_hash_ref, $precluded_hash_ref)
		= $m->comp(
			"/funclib/make_pairing_hash.mas",
			round_id => $round->id
		);

	my %entries = %{$entries_hash_ref};
	my %precluded = %{$precluded_hash_ref};

	my %bracket_keys;

	foreach my $key (
		sort {$entries{$a}->{'seed'} <=> $entries{$b}->{'seed'}}
		keys(%entries)
	) {

		next unless $entries{$key}{'opponent'} == 0;
		next unless $key > 0;
		$bracket_keys{$entries{$key}{'wins'}}++;
	}

	my @brackets = sort {$b <=> $a} keys %bracket_keys;

	$bracket = $brackets[0] unless defined $bracket;
	print "After check bracket is $bracket<br>" if $debug;

	my $end = time();
	if ($debug) {
		print "hash setup time:  ";
		printf("%.2f\n", $end - $start);
		print "<Br>";
	}

	my $nteams = keys %entries;
	my $num_preclusions = keys %precluded;

	if ($debug) {
		print "n entries from hash:".$nteams."<br>";
		print "n preclusions from hash:".$num_preclusions."<br>";
		$end = time();
		print "Current round setup time:  ";
		printf("%.2f\n", $end - $start);
		print "<br>";
	}

	sub hasconflict {

		my ($team1, $team2, %precluded_ref) = @_;
		my $returnvalue = 0;

		if ($precluded_ref{$team1}{$team2} == 1) { $returnvalue = 1; }
		if ($precluded_ref{$team2}{$team1} == 1) { $returnvalue = 1; }
		if ($team1 == $team2) { $returnvalue = 1; }

		return $returnvalue;
	}

#	Declare the variables to mark the number of teams in the bracket

	my $aff_teams_in_bracket = 0;
	my $neg_teams_in_bracket = 0;

#	Count paired and unpaired teams in the bracket

	my $paired_teams = 0;
	my $unpaired_teams = 0;

	foreach my $key (keys %entries) {

		if (
			($entries{$key}{'placement'} == $bracket or $bracket == -1)
				and $entries{$key}{'opponent'} > 0
		) {
			$paired_teams++;
		}

		if (
			($entries{$key}{'placement'} == $bracket or $bracket == -1)
				and $entries{$key}{'opponent'} < 1
		) {
			$unpaired_teams++;
		}
	}

	sub had_bye_already {

		my ($team) = @_;

		Tab::Ballot->set_sql(  byes => "
			select distinct ballot.id
			from ballot
			where ballot.entry = ?
			and ballot.bye = 1
		");

		Tab::Ballot->set_sql(  panel_byes => "
			select distinct ballot.id
			from ballot, panel
			where ballot.entry = ?
			and ballot.panel = panel.id
			and panel.bye = 1
		");

		my @byes = Tab::Ballot->search_byes($team);
		push @byes, Tab::Ballot->search_panel_byes($team);

		my $warn = "This entry has already received a bye.  Proceed?" if @byes;
		return $warn;
	}

	print "bracket is $bracket<br>" if $debug;

	my $bracket_change_display_str="";

	if ( $bracket == -1 ) {
		$bracket_change_display_str ="style='display:none;'";
	}

	my $display_flag;
	my $win_tag;

</%init>

	<div class="main" display="table">

	<script>

		showbracket = function(bracket) {

			// SET VARIABLES

			var BracketIn;
			var row_ctr;

			// UPDATE AFF BRACKET

			var MasterTable = document.getElementById("affbracket");

			if (MasterTable) {

				var TableRows = MasterTable.getElementsByTagName("tr");

				row_ctr=0;

				for (var i = 1; i < TableRows.length; i++) {
					BracketIn = parseFloat(TableRows[i].cells[13].textContent);
					TableRows[i].style.display = "none" ;
					if ( BracketIn == bracket || bracket == -1 ) {
						TableRows[i].style.display = "table-row" ;
						row_ctr++;
						TableRows[i].className = "odd";
						if ((row_ctr % 2) == 0) { TableRows[i].className = "even"; }
					}
					if (TableRows[i].cells[9].textContent.trim() == "Choose" ) {
						TableRows[i].cells[10].style.display = "table-cell";
						TableRows[i].cells[11].style.display = "table-cell";

					}
				}
			}

			// UPDATE NEG BRACKET

			var MasterTable = document.getElementById("negbracket");

			if (MasterTable) {

				var TableRows = MasterTable.getElementsByTagName("tr");
				row_ctr=0;

				for (var i = 1; i < TableRows.length; i++) {
					BracketIn = parseFloat(TableRows[i].cells[13].textContent);
					TableRows[i].style.display = "none" ;
					if ( BracketIn == bracket || bracket == -1 ) {
						TableRows[i].style.display = "table-row" ;
						row_ctr++;
						TableRows[i].className = "odd";
						if ((row_ctr % 2) == 0) { TableRows[i].className = "even"; }
					}
					if (TableRows[i].cells[9].textContent.trim() == "Choose" ) {
						TableRows[i].cells[10].style.display = "table-cell";
						TableRows[i].cells[11].style.display = "table-cell";
					}
				}
			}

			//UPDATE UNPAIRED TABLES
			var MasterTables = document.getElementsByClassName("unpaired");

			if (MasterTables != null) {

				for (var z = 0; z < MasterTables.length; z++) {

					var stupid = MasterTables[z].id;

					if (stupid) {
						var table_dummy = document.getElementById( "table_" + stupid);
					}

					var TableRows = MasterTables[z].getElementsByTagName("tr");
					var Oppn;

					row_ctr=0;
					MasterTables[z].style.display = "none" ;

					if (table_dummy) {
						table_dummy.style.display = "none";
					}

			    	if ( TableRows.length > 0 ) {
						MasterTables[z].style.display = "table" ;
						if (table_dummy) {
							table_dummy.style.display = "full";
						}
					}

					var bracket_dummy =  document.getElementById("bracketselector").value;

					if ( bracket_dummy == -1 ) {
						MasterTables[z].style.display = "none" ;
						if (table_dummy) {
							table_dummy.style.display = "none" ;
						}
					}

				   	for (var i = 1; i < TableRows.length; i++) {
						var team_dummy = TableRows[i].cells[0].innerHTML;
						BracketIn = parseFloat(TableRows[i].cells[13].firstChild.nodeValue);
						Oppn = parseFloat(TableRows[i].cells[9].firstChild.nodeValue);
						TableRows[i].style.display = "none" ;
						if ( BracketIn != bracket && (isNaN(Oppn) == true  || Oppn == 0) ) {
							TableRows[i].style.display = "table-row" ;
							row_ctr++;
							TableRows[i].className = "odd";
							if ((row_ctr % 2) == 0) { TableRows[i].className = "even"; }
						}
					}
				}
			}

//			UPDATE THE HEADINGS AT THE TOP
			var headingDiv = document.getElementById("bracketlabel");
			if (headingDiv) {
				headingDiv.innerHTML = bracket + " bracket";
			}

			if (bracket == -1) {
				$("#affheader").html("All <% $aff_string %> entries");
				$("#negheader").html("All <% $neg_string %> entries");
			} else {
				$("#affheader").html("<% $aff_string %> " + bracket + " bracket");
				$("#negheader").html("<% $neg_string %> " + bracket + " bracket");
			}

//			UPDATE THE BRACKET PAIRING FUNCTIONS

			var curr_rd = <% $round_id %>;
			document.getElementById("autopairlink").href
				= "/panel/round/pair_bracket.mhtml?round_id=" + curr_rd + "&bracket_to_pair=" + bracket + "&fromjava=true";

			document.getElementById("collapse_up").href
				= "collapse_bracket.mhtml?round_id=" + curr_rd + "&bracket=" + bracket + "&pull_iterator=1&fromjava=true";

			var adj_bracket = parseFloat(bracket) + 1;
			var max_wins = <% $round->name %> -1 ;
			var pull_iterator = 1;

			if ( adj_bracket > max_wins ) {
				adj_bracket = max_wins;
				pull_iterator = 0;
			}

			document.getElementById("collapse_up").innerHTML
				= "Collapse " + bracket + " into " + adj_bracket + " bracket";

			document.getElementById("collapse_up").href
				= "collapse_bracket.mhtml?round_id=" + curr_rd + "&bracket=" + bracket +"&pull_iterator=" + pull_iterator + "&fromjava=true";

			var adj_bracket = parseFloat(bracket) - 1;
			pull_iterator = -1;

			if (adj_bracket < 0) {
				adj_bracket = 0;
				pull_iterator = 0;
			}

			document.getElementById("collapse_down").innerHTML
				= "Collapse " + bracket + " into " + adj_bracket + " bracket";

			document.getElementById("collapse_down").href
				= "collapse_bracket.mhtml?round_id=" + curr_rd + "&bracket=" + bracket +"&pull_iterator=" + pull_iterator + "&fromjava=true";

			document.getElementById("dump_bracket").innerHTML
				= "Dump debates in " + bracket + " bracket";

			document.getElementById("dump_bracket").href
				= "dump_bracket.mhtml?round_id=" + curr_rd + "&bracket_to_pair=" + bracket +"&fromjava=true";

			document.getElementById("dump_and_autopair_bracket").innerHTML
				= "Dump debates in bracket " + bracket + " &amp; autopair";

			document.getElementById("dump_and_autopair_bracket").href
				= "/panel/round/pair_bracket.mhtml?round_id=" + curr_rd + "&bracket_to_pair=" + bracket + "&delete_existing=Seaver&fromjava=true";

			count_paired(bracket);

			var dummy = document.getElementById("bracket_changes");
			if ( bracket != -1 ) {
				dummy.style.display = "full";
			} else {
				dummy.style.display = "none";
			}

			// HIDE THE UNPAIRED TABLE BELOW AND SHOW ALL THE OTHERS

			$(".bracketology").removeClass('hidden');
			$(".bracketology").removeAttr('style');

			$(".bracketology").each(function(index) {
				var localBracket = $("#"+index).attr("entrycode");
				if (localBracket > bracket) {
					$("#"+index).addClass('hidden');
				}
			});

			// these are the done brackets so they don't get revived from the grave
			$(".noreallyhideme").addClass('hidden');
			$("#table_"+bracket).addClass('hidden');
		}

		count_paired = function(bracket) {

			// this is totally annoying and should be un-necessary but
			// otherwise it doesn't work

			var due_aff=0;
			var due_neg=0;
			var n_unpaired=0;

			//UPDATE AFF BRACKET
			var MasterTable = document.getElementById("affbracket");

			var TableRows = MasterTable.getElementsByTagName("tr");
			for (var i = 1; i < TableRows.length; i++) {
				BracketIn = parseFloat(TableRows[i].cells[13].textContent);
				if ( BracketIn == bracket ) {
					due_aff++;
					if (TableRows[i].cells[9].textContent.trim() == "Choose" ) {
						n_unpaired++;
						// window.alert("Counted " + TableRows[i].cells[0].textContent.trim() + " " + TableRows[i].cells[9].textContent.trim());
					}
				}
			}

			//UPDATE NEG BRACKET
			var MasterTable = document.getElementById("negbracket");
			if (MasterTable != null) {
				var TableRows = MasterTable.getElementsByTagName("tr");
				row_ctr=0;
				for (var i = 1; i < TableRows.length; i++) {
					BracketIn = parseFloat(TableRows[i].cells[13].textContent);
					if ( BracketIn == bracket ) {
						due_neg++;
						if (TableRows[i].cells[9].textContent.trim() == "Choose" ) {
							n_unpaired++;
							// window.alert("Counted " + TableRows[i].cells[0].textContent.trim() + " " + TableRows[i].cells[9].textContent.trim());
						}
					}
				}
			}

			document.getElementById("due_aff").innerHTML = due_aff;

			var sideLocked = parseFloat(document.getElementById("sideLocked").value);

			if ( sideLocked == 1 ) {
				document.getElementById("due_neg").innerHTML = due_neg;
			}

			document.getElementById("paired_already").innerHTML = due_neg + due_aff - n_unpaired;
			document.getElementById("left_to_pair").innerHTML = n_unpaired;

			console.log(" Bracket "+bracket+" count unpaired is "+n_unpaired);

			if (n_unpaired == 0) {
				$("#table_"+bracket).addClass('hidden');
				$("#table_"+bracket).addClass('noreallyhideme');
			} else {
				$("#table_"+bracket).removeClass('noreallyhideme');
				$("#table_"+bracket).removeClass('hidden');
			}
		}

		var pullme = function(table_from, pull_direction, entry) {

			//change the table they are in
			var current_row = document.getElementById(table_from+entry);

			//see if they've been pulled up before and confirm if yes
  			var pullups = current_row.cells[8].textContent.trim();
			var x = pullups.length;
			var n_pulls = parseFloat(pullups.slice(x-2, x));

			if ( n_pulls > 0 && pull_direction == "UP" ) {
				var c = window.confirm("This entry has been pulled up " + n_pulls + " times(s) before.  Pull them up anyway?");
				if ( c == false ) { return; }
			}

		   	var BracketIn = parseFloat(current_row.cells[13].firstChild.nodeValue);
			var bracket = document.getElementById("bracketselector").value;

			if (bracket != BracketIn) {
				if (Math.abs(bracket - BracketIn) > 1) {
					alert("Warning:  This is a double pullup!  Please be certain this is what you want to do.");
				}
				var NewBracket = bracket;

			} else {
				if (pull_direction == 'DOWN' ) NewBracket = BracketIn - 1;
				if (pull_direction == 'UP' ) NewBracket = BracketIn + 1;
			}

			$("#"+table_from+entry).addClass("hidden");
			current_row.cells[13].innerHTML = NewBracket;

			//change the unpaired table
			if (table_from == "aff" || table_from == "neg" ) {

				var current_row = document.getElementById('unp'+entry);
				current_row.cells[13].innerHTML = NewBracket;
				var bracket_dummy = document.getElementById("bracketselector").value;

				//save it
				$.post("/panel/manipulate/manual_pullup.mhtml",{ bracket: NewBracket, entry_id: entry });
				showbracket(bracket_dummy);
			}

			if (table_from == "unp") {

				try {
					var current_row = document.getElementById('aff'+entry);
					current_row.cells[13].innerHTML = NewBracket;
				} catch(err) {}

				try {
					var current_row = document.getElementById('neg'+entry);
					current_row.cells[13].innerHTML = NewBracket;
				} catch(err) {}

				//save it
				$.post("/panel/manipulate/manual_pullup.mhtml", {bracket: NewBracket, entry_id: entry});
				showbracket(NewBracket);
			}
		}

		update_screen_after_bye = function(panel_id, entry, wins) {

			var entry_name;

			//update their row for the onscreen display
			try {
				var current_row = document.getElementById('aff'+entry);
				entry_name = current_row.cells[0].textContent;
				current_row.cells[9].colSpan=3;
				current_row.cells[9].innerHTML = "<a class='semibold greentext full hover' onclick='deletePanel( " + panel_id + ", " + entry + ", -1) '>BYE</a>";
				current_row.cells[10].style.display = "none" ; current_row.cells[11].style.display = "none" ;
			} catch(err) {}

			try {
				var current_row = document.getElementById('neg'+entry);
				entry_name = current_row.cells[0].textContent;
				current_row.cells[9].colSpan=3;
				current_row.cells[9].innerHTML = "<a class='semibold greentext full hover' onclick='deletePanel(" + panel_id + ", " + entry +", -1)'>BYE</a>";
				current_row.cells[10].style.display = "none" ; current_row.cells[11].style.display = "none" ;
			} catch(err) {}

			try {
				var current_row = document.getElementById('unp'+entry);
				current_row.cells[9].innerHTML = -1;
				entry_name = current_row.cells[0].textContent;
				current_row.style.display = "none" ;
			} catch(err) {}

			//add it to the pairings table
			var pairings_table = document.getElementById("pairings");
			var my_row = pairings_table.insertRow();
			my_row.id = "pair"+panel_id;
			var cell1 = my_row.insertCell(0);
			var cell2 = my_row.insertCell(1);
			var cell3 = my_row.insertCell(2);
			var cell4 = my_row.insertCell(3);

			$(my_row).addClass("row");
			$(cell4).addClass("centeralign nospace");
			cell2.innerHTML = "<span class='twothird nowrap'>" + entry_name + "</span><span class='third'>" + <% $win_tag %> + "wins</span>";
			cell3.innerHTML = "<span class='twothird nowrap semibold redtext'> BYE </span>";
			cell4.innerHTML = "<a class='redtext buttonwhite fa fa-lg fa-trash' onclick='deletePanel( " + panel_id + ", " + entry + ", -1 );'></a>";

			count_paired(wins);
			zebraRows();
			console.log("Bye and rows!");
		}

		givebye = function(entry, hadbye, wins) {

			//Give user abort option if had bye before
			if (hadbye.length > 5) {
				var doit = window.confirm(hadbye);
				if ( doit == false ) { return; }
			}

			//store the bye and call screen update
			var rd_id= <% $round_id %>,
			bracket=<% $bracket %>,
			panel_id;

			$.post("save_pairing.mhtml",{
					round_id          : rd_id,
					team1             : entry,
					wins1             : wins,
					seed1             : wins,
					team2             : -1,
					wins2             : 0,
					seed2             : 0,
					bracket_to_return : -42
				},
				function(responseMessage){

					if (responseMessage === "FAIL") {

					} else {
						panel_id = parseFloat(responseMessage);
						update_screen_after_bye(panel_id, entry, wins);
					}
				}
			);
		}

		function deletePanel(panel_id, aff, neg) {

			//delete the row from the pairings
			var current_row = document.getElementById("pair"+panel_id);

			if (current_row) {
				current_row.parentNode.removeChild(current_row);
			}

			//update the other 3 tables

			//GOTTA ADD THE TEAM TO THE CHOOSE BUTTON

			var aff_row = document.getElementById('aff'+aff);

			if (aff_row == null) {
				aff_row = document.getElementById('neg'+aff);
			}

			if (aff_row) {

				aff_row.cells[9].colSpan=1;

				aff_row.cells[9].innerHTML = "<a class='smallbutton' onclick='save_pairing( 1, "
					+ aff_row.cells[12].innerHTML
					+ ", "
					+ aff_row.cells[1].innerHTML
					+ ", "
					+ aff_row.cells[2].innerHTML
					+ ")' > Choose </a>";
			}

			var neg_row = document.getElementById('aff'+neg);

			if (neg_row == null) {
				neg_row = document.getElementById('neg'+neg);
			}

			if (neg_row) {
				neg_row.cells[9].colSpan=1;
				neg_row.cells[9].innerHTML = "<a class='smallbutton' onclick='save_pairing( 2, " + neg_row.cells[12].innerHTML + ", " + neg_row.cells[1].innerHTML + ", " + neg_row.cells[2].innerHTML + ")' > Choose </a>";
			}

			var unp_aff_row = document.getElementById('unp'+aff);
			if (unp_aff_row) {
				unp_aff_row.cells[9].innerHTML = 0;
			}

			var unp_neg_row = document.getElementById('unp'+neg);
			if (unp_neg_row) {
				unp_neg_row.cells[9].innerHTML = 0;
			}

			var bracket = document.getElementById("bracketselector").value;
			showbracket(bracket);

			var pairings_table = document.getElementById("pairings");
			$(pairings_table).trigger('update');

			//process in database
			$.post("dump_panel.mhtml",{ panel_id: panel_id });

		}

		testfunction = function() {

			var dummy;
			$.post("test.mhtml",{suggest:42},function(result){
			    window.alert(result);
			    dummy = result;
			  });

			window.alert("call finished");
			window.alert("dummy is " + dummy);
			window.alert("function done");
  		}

		show_opponents = function(entry, wins, seed) {

			var entry_code = $("#"+entry).attr("entrycode");

			//update header
			$('#instruction_header').html("<h5 class=\"nospace\">Find opponent for " + entry_code + " </h5>");

			//store entry id in entry_to_pair element
			$('#entry_to_pair_entry').html(entry);
			$('#entry_to_pair_wins').html(wins);
			$('#entry_to_pair_preset_seed').html(seed);

			//reset anchor styles
			reset_anchor_styles();

			//update conflicts
			var MasterTable = document.getElementById("preclusion_data");
			var TableRows = MasterTable.getElementsByTagName("tr");
			row_ctr=0;

			for (var i = 1; i < TableRows.length; i++) {
				if ( TableRows[i].cells[0].textContent == entry || TableRows[i].cells[1].textContent == entry ) {
					var to_change;
					if (TableRows[i].cells[0].textContent == entry) {
						to_change = TableRows[i].cells[1].textContent.trim();
					}
					if (TableRows[i].cells[1].textContent == entry) {
						to_change = TableRows[i].cells[0].textContent.trim();
					}

					try {
						$('#'+to_change).removeClass('white');
						$('#'+to_change).addClass('redtext semibold nowrap marno padleft');
						if ( parseFloat(current_row.cells[12].textContent) == entry ) {
							$('#'+to_change).removeClass('redtext');
							$('#'+to_change).addClass('bluetext nowrap marno padleft');
						}
					} catch(err) { }

				}
			}
			$('#'+entry).removeClass('redtext');
			$('#'+entry).addClass('bluetext nowrap marno padleft');
		}

		reset_anchor_styles = function() {

			var MasterTable = document.getElementById("affbracket");
			if (MasterTable) {
				var TableRows = MasterTable.getElementsByTagName("tr");
				for (var i = 1; i < TableRows.length; i++) {
					var curr_anchor = TableRows[i].cells[0].firstElementChild;
					curr_anchor.className = "padleft limit3 nowrap white padtop padbottom";
				}
			}

			var MasterTable = document.getElementById("negbracket");
			if (MasterTable) {
				var TableRows = MasterTable.getElementsByTagName("tr");
				for (var i = 1; i < TableRows.length; i++) {
					var curr_anchor = TableRows[i].cells[0].firstElementChild;
					curr_anchor.className = "padleft limit3 nowrap white padtop padbottom";
				}
			}

			var MasterTables = document.getElementsByClassName("unpaired");

			if (MasterTable) {
				for (i = 0; i < MasterTables.length; i++) {
					var TableRows = MasterTables[i].getElementsByTagName("tr");
					for (var x = 1; x < TableRows.length; x++) {
						var curr_anchor = TableRows[x].cells[0].firstElementChild;
						curr_anchor.className = "padleft limit3 nowrap white padtop padbottom";
					}
				}
			}
		}

		update_screen_after_pairing = function(panel_id, aff, neg, bracket) {

			//pull aff name & wins
			var aff_row = document.getElementById('aff'+aff);
			if (aff_row == null) {
				aff_row = document.getElementById('neg'+aff);
			}

			if (aff_row) {
				var aff_name = aff_row.cells[0].textContent;
				var aff_wins = aff_row.cells[1].textContent;
			}

			//pull neg name & wins
			var neg_row = document.getElementById('neg'+neg);

			if (neg_row == null) {
				neg_row = document.getElementById('aff'+neg);
			}

			if (neg_row) {
				var neg_name = neg_row.cells[0].textContent;
				var neg_wins = neg_row.cells[1].textContent;
			}

			//update aff row for the onscreen display, plus suppress the action buttons
			if (aff_row) {
				aff_row.cells[9].innerHTML = "<a class='white full padtop padbottom nowrap limit3' onclick='deletePanel( " + panel_id + ", " + aff + ", " + neg + ") '>" + neg_name + "</a>";
				aff_row.cells[9].colSpan=3;
				aff_row.cells[10].style.display = "none" ;
				aff_row.cells[11].style.display = "none" ;
				$(aff_row.cells[9]).removeClass("centeralign");
			}

			//update neg row for the onscreen display and suppress action buttons
			if (neg_row) {
				neg_row.cells[9].innerHTML = "<a class='white full padtop padbottom nowrap limit3' onclick='deletePanel( " + panel_id + ", " + aff + ", " + neg + ") '>" + aff_name + "</a>";
				neg_row.cells[9].colSpan=3;
				neg_row.cells[10].style.display = "none" ;
				neg_row.cells[11].style.display = "none" ;
				$(neg_row.cells[9]).removeClass("centeralign");
			}

			//update unpaired table
			var unpaired_row = document.getElementById('unp'+aff);
			if (unpaired_row) {
				unpaired_row.cells[9].innerHTML = neg;
			}

			var unpaired_row = document.getElementById('unp'+neg);
			if (unpaired_row) {
				unpaired_row.cells[9].innerHTML = aff;
			}

			//add it to the pairings table
			var pairings_table = document.getElementById("pairings");
			var my_row = pairings_table.insertRow(1);
			my_row.id = "pair"+panel_id;

			var cell1 = my_row.insertCell(0);
			var cell2 = my_row.insertCell(1);
			var cell3 = my_row.insertCell(2);
			var cell4 = my_row.insertCell(3);

			$(cell4).addClass("centeralign");
			$(cell4).addClass("nospace");

			var bracket = aff_wins, aff_pullup, neg_pullup;

			if (bracket < neg_wins) {
				bracket = neg_wins;
				aff_pullup = " semibold bluetext";
			}

			if (neg_wins < aff_wins) {
				neg_pullup = " semibold bluetext";
			}

			cell1.innerHTML = bracket;

			cell2.innerHTML = "<span class='twothird nowrap'>"
				+ aff_name
				+ "</span><span class='third"
				+ aff_pullup
				+ "'>"
				+ aff_wins
				+ "wins </span>"
			;

			cell3.innerHTML = "<span class='twothird nowrap'>"
				+ neg_name
				+ "</span><span class='third"
				+ neg_pullup
				+ "'>"
				+ neg_wins
				+ "wins </span>";

			cell4.innerHTML = "<a class='buttonwhite hover redtext fa fa-lg fa-trash'"
					+ "onclick='deletePanel( "
						+ panel_id
						+ ", "+ aff
						+ ", "+ neg
						+ ");'></a>";
			//update header
			var instr = document.getElementById('instruction_header');
			instr.innerHTML = "Tap an entry code to find a match";

			$(pairings_table).trigger('update');
			count_paired(bracket);
			zebraRows();

		}

		save_pairing = function( side, entry, wins, seed ) {

			//pull the entry team row

			// this change allows you to pair a team against its own side locked side,
			// which in some screwy conditions is a necessary evil.

			var current_row = document.getElementById("aff"+entry);
			if (current_row == null) {
				var current_row = document.getElementById("neg"+entry);
			}

			var bracket = current_row.cells[13].textContent;
			//let the user bail if there's a conflict
			if ( current_row.cells[0].firstElementChild.className.trim() == "padleft nowrap dkred marno") {
				var doit = window.confirm("These teams have a conflict; click OK to pair them anyway or cancel to cancel:");
				if ( doit == false ) { return; }
			}

			//get round
			var curr_rd = <% $round_id %>;

			//load entry_to_pair values
			var entry_to_pair_entry = document.getElementById('entry_to_pair_entry').innerHTML;
			var entry_to_pair_wins = document.getElementById('entry_to_pair_wins').innerHTML;
			var entry_to_pair_preset_seed = document.getElementById('entry_to_pair_preset_seed').innerHTML;

			if (entry_to_pair_entry.length == 0) {
				alert("You must choose a team to pair first from the left hand column");
				return;
			}

			//set sides correctly
			var team1;
			var wins1;
			var seed1;
			var team2;
			var wins2;
			var seed2;

			if ( side == 1) {
				team1 = entry;
				wins1 = wins;
				seed1 = seed;
				team2 = entry_to_pair_entry;
				wins2 = entry_to_pair_wins;
				seed2 = entry_to_pair_preset_seed;
			} else {
				team1 = entry_to_pair_entry;
				wins1 = entry_to_pair_wins;
				seed1 = entry_to_pair_preset_seed;
				team2 = entry;
				wins2 = wins;
				seed2 = seed;
			}

			// save it

			$.post("save_pairing.mhtml",{
					round_id          : curr_rd,
					team1             : team1,
					wins1             : wins1,
					seed1             : seed1,
					team2             : team2,
					wins2             : wins2,
					seed2             : seed2,
					bracket_to_return : -42
				},
				function(responseMessage){
					panel_id = parseFloat(responseMessage);
					update_screen_after_pairing(panel_id, team1, team2, bracket);
				}
			);

			//clean up screen
			reset_anchor_styles();
			var bracket = document.getElementById("bracketselector").value;
			showbracket(bracket);

		}

	</script>

		<div class="nospace">
			<span class="twothird nospace">
				<h4><% $round->realname %> Manual Powermatch</h4>
				<input
					id    = "sideLocked"
					type  = "hidden"
					value = "<% $side_locked %>"
				>
			</span>

%			unless ($bracket_not_set) {
				<span class="third rightalign nospace right">
					<h4 id="bracketlabel"><% $bracket == -1 ? "All Entries" : $bracket ." bracket" %></h4>
				</span>
%			}
		</div>

%		if ($bracket_not_set) {

%			my $other_round_id = $event_settings{"bracket_set"};
%			my $other_round = Tab::Round->retrieve($other_round_id) if $other_round_id;

%			if ($other_round) {

				<p>
					Current brackets are set for <% $other_round->realname %>.
					Recalculating brackets will mess with that round unless
					it's already completed.
				</p>

				<div class="evenrow centeralign full">
					<a
						class="inline dkblue"
						href="reset_bracket.mhtml?round_id=<% $round_id %>&winsonly=true&fromjava=true"
					>
						Calculate Initial Brackets
					</a>
				</div>

<%perl>

			} else {
				$m->redirect("reset_bracket.mhtml?round_id=$round_id&winsonly=true");
			}

		} else {

</%perl>

			<& "/funclib/tablesorter.mas", table => "affbracket", nobuttons => 1 &>

			<div class="nospace">

				<span class="third nospace">
%					if ($side_locked) {
						<h5 id="affheader">
							<%
								$bracket == -1
								? "All ".$aff_string." Entries"
								: $aff_string." ".$bracket." win bracket"
							%>
						</h5>
%					}
				</span>

				<span class="twothird nospace right martop">

					<div
						id    = "instruction_header"
						class = "nospace rightalign"
					>
						<h6 class="nospace">Tap an entry code to find a match</h6>
					</div>

				</span>
			</div>

<%perl>

				my $side_save = 2;
				$side_save = 1 if $side_locked;

				my @keys = keys %entries;

				@keys = sort {
					$entries{$a}->{'seed'} <=> $entries{$b}->{'seed'}
				} @keys if $powermatch_method;

				@keys = sort {
					$entries{$a}->{'SOP'} <=> $entries{$b}->{'SOP'}
				} @keys if $powermatch_method eq "sop";

				my $sample_key = $keys[0] if @keys;
				my $win_tag = uc(substr($entries{$sample_key}{'tb_desc'}, 0, 1));
				my $win_long_tag = uc(substr($entries{$sample_key}{'tb_desc'}, 0, 3));

</%perl>

			<table
				id    = "affbracket"
				class = "martop"
			>

				<thead>
					<tr class="yellowrow">

						<th class="smaller" title="Entry Designation">
							Code
						</th>

						<th class="smaller" title="Bracket Method: <% $entries{$sample_key}{'tb_long_desc'} %>">
							<% $win_tag %>
						</th>

						<th class="smaller" title="Seed">
							Seed
						</th>

						<th class="smaller" title="Seed + Opponent Average Seed">
							SOP
						</th>

						<th class="smaller" title="2nd Tiebreaker: <% $entries{$sample_key}{'next_long_desc'} %>">
							<% uc(substr($entries{$sample_key}{'next_desc'}, 0, 2)) %>
						</th>

						<th class="smaller" title="Overall Seed Excluding Win/Loss">
							BktSd
						</th>

%						if ($event_settings{bracket_by_ballots}) {
							<th class="smaller" title="Average Opp Seed & Avg Opp Ballots">
								<span class="half nospace">
									OSd
								</span>
								<span class="fortyfive nospace">
									OBal
								</span>
							</th>
%						} else {
							<th class="smaller" title="Average Opp Seed & Avg Opp Wins">
								<span class="half nospace">
									OSd
								</span>
								<span class="fortyfive nospace">
									OW
								</span>
							</th>
%						}

%#						if ($side_locked) {
							<th class="hidden smaller" <% $style_str %> title="Side Due" <% $display_flag %>>
								Due
							</th>
%#						}

						<th class="smaller" title="Got Pulled Up/Debated The Pullup">
							Pull
						</th>

						<th class="smaller" title="Opponent This Round">
							Vs
						</th>

						<th class="smaller nosort" colspan="3">
							Action
						</th>
					</tr>
				</thead>

				<tbody class="smallish">

<%perl>

				foreach my $key (@keys) {

					if ($key and $key > -1 and ($entries{$key}{sidedue} == 1 or not defined $side_locked) ) {

						$display_flag="style='display:none;'";

						undef $display_flag if $entries{$key}{'placement'} == $bracket or $bracket == -1;
						$aff_teams_in_bracket++ if $entries{$key}{'placement'} == $bracket;


</%perl>
						<tr
							class = "rightalign" <% $display_flag %>
							id    = "aff<% $key %>"
							title = "bracket <% $bracket %>"
						>

							<!-- Col 0, entry -->
							<td class="nospace leftalign limit3">

%								unless ($key == $entry_to_pair) {

									<a
										class     = "padleft limit3 nowrap white padtop padbottom"
										id        = "<% $key %>"
										title     = "<% $entries{$key}{'code'} %>"
										entrycode = "<% $entries{$key}{"code"} %>"
										onclick   = "show_opponents(
											<% $key %>,
											<% $entries{$key}{'wins'} %>,
											<% $entries{$key}{'seed'} %>
										);"
									>
%								}
									<% $entries{$key}{'code'} %>
								</a>
							</td>

							<!-- Col 1, wins -->
							<td class="centeralign">
								<% $entries{$key}{'wins'} %>
							</td>

							<!-- Col 2, seed -->
							<td>
								<% $entries{$key}{'seed'} %>
							</td>

							<!-- Col 3, SOP -->
							<td>
								<% sprintf("%.1f", $entries{$key}{'SOP'}) %>
							</td>

							<!-- Col 4, TB after wins -->
							<td>
								<% sprintf("%.1f", $entries{$key}{'next_tb'}) %>
							</td>

							<!-- Col 5, seed w/o wins -->
							<td>
								<% $entries{$key}{'seed_nowins'} %>
							</td>

							<!-- Col 6, avg opp wins -->
							<td class="nospace centeralign">
								<span class="half nospace">
									<% sprintf("%.1f", $entries{$key}{'opp_seed'}) %>
								</span>
								<span class="fortyfive nospace">
%								if ($event_settings{bracket_by_ballots}) {
									<% sprintf("%.1f", $entries{$key}{'opp_ballots'}) %>
%								} else {
									<% sprintf("%.1f", $entries{$key}{'opp_wins'}) %>
%								}
								</span>
							</td>

							<!-- Col 7, side due -->

							<td class="hidden centeralign" <% $style_str %>>
								<% $entries{$key}{'sidedue'} == 1 ? "A" : "N" %>
							</td>

							<!-- Col 8, pullup status -->
							<td class="centeralign">
								<% $entries{$key}{'pulled_up'} %> / <% $entries{$key}{'got_pullup'} %>
							</td>

							<!-- Col 9, oppn -->
%							if ( $entries{$key}{'opponent'} > 0 ) {

								<td
									class   = "leftalign padleft nospace"
									colspan = "3"
								>

									<a class="white full limit3 padtop padbottom nowrap"
										onclick="deletePanel(
											<% $entries{$key}{'panel'} %>,
											<% $key %>,
											<% $entries{$key}{'opponent'} %>
										)"
									>
										<% $entries{$entries{$key}{'opponent'}}{'code'} %>
									</a>

%								} elsif ( $entries{$key}{'opponent'} == -1 ) {

									<td
										class   = "leftalign nospace"
										colspan = "3"
									>

										<a class="semibold greentext full hover marno padleftmore"
											onclick="deletePanel(
												<% $entries{$key}{'panel'} %>,
												<% $key %>,
												<% $entries{$key}{'opponent'} %>
											)"
										> BYE </a>

%								} else {

									<td class="centeralign nospace">

										<a class="smallbutton"
											onclick="save_pairing( <% $side_save %>,
												<% $key %>,
												<% $entries{$key}{'wins'} %>,
												<% $entries{$key}{'seed'} %>
											)">
											Choose

										</a>

%								}
							</td>

							<!-- Col 10, the bye button -->
%#							set display flag for columns 10 and 11

%							undef $display_flag;

%							$display_flag="style='display:none'"
%								if $entries{$key}{'opponent'} == -1
%								|| $entries{$key}{'opponent'} > 0;

							<td class="centeralign nospace" <% $display_flag %>>

%							my $warn = had_bye_already($key);

								<a
									id      = "affbyebutton<% $key %>"
									class   = "smallbutton"
									onclick = "givebye(
										<% $key %>,
										'<% $warn %>',
										<% $entries{$key}{'wins'} %>
									);"
								>
									Bye
								</a>
							</td>

							<!-- Col 11, pull up/down button -->
							<td <% $display_flag %> class="nospace centeralign">
								<a
									id      = "affpullbutton<% $key %>"
									class   = "smallbutton"
									onclick = "pullme('aff', 'DOWN', <% $key %>);"
								>
									Pull &darr;
								</a>
							</td>

							<!-- Col 12, entry id -->
							<td style="display:none">
								<% $key %>
							</td>

							<!-- Col 13, bracket -->
							<td style="display:none">
								<% $entries{$key}{'placement'} %>
							</td>


						</tr>
%					}

%				}

			</tbody>
			</table>

%		if ($side_locked) {

			<& "/funclib/tablesorter.mas", table => "negbracket", nobuttons => 1 &>

			<table id="negbracket">

				<h5 id="negheader">
					<%
						$bracket == -1
						? "All ".$neg_string." Entries"
						: $neg_string." ".$bracket." win bracket"
					%>
				</h5>

				<thead>
					<tr class="yellowrow">
						<th class="smaller" title="Entry Designation">Code</th>

						<th class="smaller" title="Bracket Method: <% $entries{$sample_key}{'tb_long_desc'} %>">
							<% $win_tag %>
						</th>

						<th class="smaller" title="Seed" >Seed</th>
						<th class="smaller" title="Seed + Opponent Average Seed">SOP</th>

						<th class="smaller" title="2nd Tiebreaker: <% $entries{$sample_key}{'next_long_desc'} %>">
							<% uc(substr($entries{$sample_key}{'next_desc'}, 0, 2)) %>
						</th>

						<th class="smaller" title="Overall Seed Excluding Win/Loss">
							BktSd
						</th>

%						if ($event_settings{bracket_by_ballots}) {
							<th class="smaller" title="Average Opp Seed & Avg Opp Ballots">
								<span class="half nospace">
									OSd
								</span>
								<span class="fortyfive nospace">
									OBal
								</span>
							</th>
%						} else {
							<th class="smaller" title="Average Opp Seed & Avg Opp Wins">
								<span class="half nospace">
									OSd
								</span>
								<span class="fortyfive nospace">
									OW
								</span>
							</th>
%						}

%#						if ($side_locked) {
							<th class="hidden smaller" title="Side Due" <% $style_str %>>Due</th>
%#						}

						<th class="smaller" title="Got Pulled Up/Debated The Pullup">Pl-up</th>
						<th class="smaller" title="Opponent This Round">Vs</th>
						<th class="smaller nosort" colspan="3">Action</th>
					</tr>
				</thead>

				<tbody class="smallish">

<%perl>

				my @keys = keys %entries;

				@keys =
					sort {$entries{$a}->{'seed'} <=> $entries{$b}->{'seed'}} @keys
					if $powermatch_method;

				@keys =
					sort {$entries{$a}->{'SOP'} <=> $entries{$b}->{'SOP'}} @keys
					if $powermatch_method eq "sop";

				foreach my $key (@keys) {

					$display_flag="style='display:none;';";

					if ($entries{$key}{'placement'} == $bracket or $bracket == -1) {
						$display_flag=""
					}

</%perl>
%					if ($key and $key > -1 and $entries{$key}{sidedue} == 2 ) {

						<tr <% $display_flag %> id="neg<% $key %>" class="rightalign">

%							$neg_teams_in_bracket++ if $entries{$key}{'placement'} == $bracket;
							<!-- Col 0, entry -->
							<td class="nospace leftalign limit3">
								<a
									class     = "padleft limit3 nowrap white padtop padbottom"
									id        = "<% $key %>"
									title     = "<% $entries{$key}{'code'} %>"
									entrycode = "<% $entries{$key}{"code"} %>"
									onclick   = "show_opponents(
										<% $key %>,
										<% $entries{$key}{'wins'} %>,
										<% $entries{$key}{'seed'} %>
									)">
									<% $entries{$key}{'code'} %>
								</a>
							</td>

							<!-- Col 1, wins -->
							<td class="centeralign padno">
								<% $entries{$key}{'wins'} %>
							</td>

							<!-- Col 2, seed -->
							<td>
								<% $entries{$key}{'seed'} %>
							</td>

							<!-- Col 3, SOP -->
							<td>
								<% sprintf("%.1f", $entries{$key}{'SOP'}) %>
							</td>

							<!-- Col 4, 1st TB after wins -->
							<td>
								<% sprintf("%.1f", $entries{$key}{'next_tb'}) %>
							</td>

							<!-- Col 5, seed w/o wins -->
							<td>
								<% $entries{$key}{'seed_nowins'} %>
							</td>

							<!-- Col 6, oppwins -->
							<td>
								<% sprintf("%.1f", $entries{$key}{'opp_wins'}) %>
							</td>

							<!-- Col 7, side due -->
%#							if ($side_locked) {
								<td class="hidden centeralign" <% $style_str %> >
									<% $entries{$key}{'sidedue'} == 1 ? "A" : "N" %>
								</td>
%#							}

							<!-- Col 8, pullup status -->
							<td class="centeralign">
								<% $entries{$key}{'pulled_up'} %> / <% $entries{$key}{'got_pullup'} %>
							</td>

							<!-- Col 9, oppn -->
%							if ( $entries{$key}{'opponent'} > 0 ) {

								<td
									class   = "leftalign padleft nospace"
									colspan = "3"
								>

									<a class="white full limit3 padtop padbottom nowrap"
										onclick="deletePanel(
											<% $entries{$key}{'panel'} %>,
											<% $key %>,
											<% $entries{$key}{'opponent'} %>
										)"
									>
										<% $entries{$entries{$key}{'opponent'}}{'code'} %>
									</a>

%								} elsif ( $entries{$key}{'opponent'} == -1 ) {

									<td
										class   = "nospace centeralign"
										colspan = "3"
									>

										<a
											class   = "semibold greentext full hover"
											onclick = "deletePanel(
												<% $entries{$key}{'panel'} %>,
												<% $key %>,
												<% $entries{$key}{'opponent'} %>
											)"
										> BYE </a>

%								} else {
									<td class="centeralign nospace">
										<a
											class   = "smallbutton"
											onclick="save_pairing( 2,
												<% $key %>,
												<% $entries{$key}{'wins'} %>,
												<% $entries{$key}{'seed'} %>
											)"
										>
											Choose

										</a>

%								}
							</td>

							<!-- Col 10, bye button -->
%							#set display flag for both columns 10 and 11
%							undef $display_flag;
%							$display_flag="style='display:none;'" if $entries{$key}{'opponent'} == -1 || $entries{$key}{'opponent'} > 0;

							<td class="centeralign nospace" <% $display_flag %> >
%								my $warn = had_bye_already($key);
								<a
									id      = "negbyebutton<% $key %>"
									class   = "smallbutton"
									onclick = "givebye(
										<% $key %>,
										'<% $warn %>',
										<% $entries{$key}{'wins'} %>
									);">
									Bye
								</a>
							</td>

							<!-- Col 11, pull up/down button -->
							<td class="centeralign nospace" <% $display_flag %>>
								<a
									id      = "negpullbutton<% $key %>"
									class   = "smallbutton"
									onclick = "pullme('neg', 'DOWN', <% $key %>);">
									Pull &darr;
								</a>
							</td>

							<!-- Col 12, entry id -->
							<td style="display:none">
								<% $key %>
							</td>

							<!-- Col 13, bracket -->
							<td style="display:none">
								<% $entries{$key}{'placement'} %>
							</td>

						</tr>

%					}

%				}

				</tbody>
				</table>

%			} #don't show neg table in a non-sidelocked round

			<hr>
<%perl>
			foreach my $this_bracket (@brackets) {

				next if $this_bracket == -1;
				my $hidden = "hidden" if $this_bracket == $bracket;
</%perl>
				<div
					id      = "table_<% $this_bracket %>"
					bracket = "<% $this_bracket %>"
					class   = "bracket_<% $this_bracket %> bracketology nospace <% $hidden ? "hidden" : "" %>"
				>

					<h4 class="martop">
						Unpaired entries in the <% $this_bracket %> bracket
					</h4>

					<& "/funclib/tablesorter.mas",
						table     => $this_bracket,
						nobuttons => 1
					&>

					<table id="<% $this_bracket %>" class="unpaired">

						<thead>

							<tr class="yellowrow">

								<th
									class="smaller"
									title="Entry Designation"
								>Code</th>

								<th
									class="smaller"
									title="Rounds Won"
								>W</th>

								<th
									class="smaller"
									title="Seed"
								>Seed</th>

								<th
									class="smaller"
									title="Seed + Opponent Average Seed"
								>SOP</th>

								<th
									class="smaller"
									title="2nd Tiebreaker (usually Points)"
								>TB2</th>

%								if ($event_settings{bracket_by_ballots}) {
									<th class="smaller" title="Average Opponent Ballots">
										<span class="half nospace">
											OSd
										</span>
										<span class="fortyfive nospace">
											OBal
										</span>
									</th>

%								} else {
									<th class="smaller" title="Average Opponent Wins">
										<span class="half nospace">
											OSd
										</span>
										<span class="fortyfive nospace">
											OW
										</span>
									</th>
%								}

								<th
									class="smaller"
									title="Average Opp Seed"
								>OpSd</th>

%#								if ($side_locked) {
									<th
										class="smaller"
										title="Side Due" <% $style_str %>
									>Due</th>
%#								}

								<th
									class="smaller"
									title="Got Pulled Up/Debated The Pullup"
								>Pl-up</th>

								<th style='display:none;'>Opponent</th>

								<th
									class="smaller nosort"
									colspan="3"
								>Action</th>
							</tr>
						</thead>

						<tbody class="rightalign smallish">

<%perl>

						foreach my $key (
							sort {$entries{$a}->{'seed'}
									<=>
								$entries{$b}->{'seed'}
							} keys(%entries)
						) {

							next unless $key && $key > -1;
							next unless $entries{$key}{'placement'} == $this_bracket;
							next unless $entries{$key}{'opponent'} == 0;

							$display_flag = "style='display:none;'";

							if ($entries{$key}{'opponent'} == 0
								and $entries{$key}{'placement'} != $bracket
							) {
								$display_flag="table-row";
							}

		#					col 8 is bracket, col 9 is opponent, starts with col 0
</%perl>

								<tr id="unp<% $key %>">

									<td class="nospace leftalign">
										<span
											class   = "padleft nowrap white padtop padbottom"
											id    = "<% $key %>"
											title = "<% $entries{$key}{'code'} %>"
										>
											<% $entries{$key}{'code'} %>
										</span>
									</td>

									<td class="centeralign padno">
										<% $entries{$key}{'wins'} %>
									</td>

									<td>
										<% $entries{$key}{'seed'} %>
									</td>

									<td>
										<% sprintf("%.1f", $entries{$key}{'SOP'}) %>
									</td>

									<td>
										<% sprintf("%.1f", $entries{$key}{'next_tb'}) %>
									</td>

									<td class="centeralign">
										<% sprintf("%.1f", $entries{$key}{'opp_seed'}) %>
%										if ($event_settings{bracket_by_ballots}) {
											<% sprintf("%.1f", $entries{$key}{'opp_ballots'}) %>
%										} else {
											<% sprintf("%.1f", $entries{$key}{'opp_wins'}) %>
%										}
									</td>

									<td>
										<% sprintf("%.1f", $entries{$key}{'oppseed'}) %>
									</td>

%#									if ($side_locked) {
										<td class="centeralign" <% $style_str %> >
											<% $entries{$key}{'sidedue'} == 1 ? "A" : "N" %>
										</td>
%#									}

									<td class="centeralign">
										<% $entries{$key}{'pulled_up'} %>
										/ <% $entries{$key}{'got_pullup'} %>
									</td>

									<td style='display:none;'>
										<% $entries{$key}{'opponent'} %>
									</td>

									<td class="nospace">
										<a
											class   = "smallbutton"
											onclick = "pullme('unp', 'UP', <% $key %>);"
										>
											Pull &uarr;
										</a>
									</td>

									<td class="nospace">
%										my $warn = had_bye_already($key);
										<a
											class   = "smallbutton"
											onclick = "givebye(
												<% $key %>,
												'<% $warn %>',
												<% $entries{$key}{'wins'} %>
											);">
											Bye
										</a>
									</td>

									<td style='display:none;'>
									</td>

									<td style='display:none;'>
										<% $entries{$key}{'placement'} %>
									</td>

								</tr>

%							}	# end team loop

						</tbody>
					</table>
				</div>
%	 		}

		<h5>Current Pairings</h5>

		<&
			"/funclib/tablesorter.mas",
			table     => "pairings",
			nobuttons => 1
		&>

		<table id="pairings">

			<thead>
				<tr class="yellowrow">
					<th class="smaller">Bracket</th>
					<th class="smaller"><% $aff_string %></th>
					<th class="smaller"><% $neg_string %></th>
					<th class="smaller nosort" colspan="3">Action</th>
				</tr>
			</thead>

			<tbody class="smallish">
<%perl>

				my @panels = Tab::Panel->search( round => $round_id );

				foreach my $panel (sort {$b->bracket <=> $a->bracket} @panels) {

					my @ballots = Tab::Ballot->search( panel => $panel->id );

					my $aff = 0;
					my $neg = 0;
					my $bye = "";
					my $warning = "";

					foreach my $ballot (@ballots) {

						if ($ballot->side == 1) {
							$aff = $ballot->entry;
						}

						if ($ballot->side == 2) {
							$neg = $ballot->entry;
						}

						if ($panel->bye or $ballot->bye) {
							$aff = $ballot->entry;
							$bye = "BYE";
						}

						if ($ballot->side != 1 and $ballot->side != 2 and $bye eq "" and $aff == 0) {
							$aff = $ballot->entry;
							$warning = "SIDE ERROR";
						} elsif ($ballot->side != 1 and $ballot->side != 2 and $bye eq "" and $neg == 0) {
							$neg = $ballot->entry;
							$warning = "SIDE ERROR";
						}
					}
</%perl>

					<tr id="pair<% $panel->id %>">

						<td>
							<% $panel->bracket %>
						</td>

						<td>
							<span class="twothird nowrap leftalign">
								<% $entries{$aff}{'code'} %>
							</span>

							<span class="third <% $entries{$aff}{"wins"} ne $panel->bracket ? "semibold bluetext" : "" %>">
								<% $entries{$aff}{'wins'} %> <% $win_long_tag %> <% $warning %>
							</span>
						</td>

						<td>
%							if ($bye) {
								<span class="full padleft redtext semibold marno">
									<% $bye %>
								</span>
%							} elsif ($entries{$neg}) {
								<span class="twothird nowrap leftalign">
									<% $entries{$neg}{'code'} %>
								</span>
								<span class="third <% $entries{$neg}{"wins"} ne $panel->bracket ? "semibold bluetext" : "" %>">
									<% $entries{$neg}{'wins'} %> <% $win_long_tag %> <% $bye %> <% $warning %>
								</span>
%							}
						</td>

						<td class="centeralign nospace">
							<a
								class="buttonwhite redtext fa fa-trash fa-sm"
									onclick="deletePanel(
										<% $panel->id %>,
										<% $aff %>,
										<% $neg %>
									);"
							>
							</a>
						</td>
					</tr>
%				}
			</tbody>
			</table>
%		}

		<table id="preclusion_data" style="display:none;" >

%		foreach my $key1 (keys %precluded) {
%			foreach my $key2 (keys %{$precluded{$key1}}) {
				<tr>
					<td> <% $key1 %> </td>
					<td> <% $key2 %> </td>
				</tr>
%			}
%		}
		</table>

		<p id="entry_to_pair_entry" style="display:none;"></p>
		<p id="entry_to_pair_wins" style="display:none;"></p>
		<p id="entry_to_pair_preset_seed" style="display:none;"></p>
</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Bracket <% $round->name %></h4>

			<div class="evenrow centeralign">

				<form action="manual_powermatch.mhtml?round_id=<% $round_id %>" method="POST">

					<select
						id       = "bracketselector"
						name     = "bracket"
						onchange = 'showbracket(this.value)'
						class    = "fixedsmall"
					>
%						print "ROUND IS".$round->name."<br>";
%						foreach my $i (reverse 0..$round->name-1) {
							<option value="<% $i %>" <% $i == $bracket ? "selected" : "" %>>
								Bracket <% $i %>
							</option>
%						}
						<option value="-1" <% $bracket == -1 ? "selected" : "" %> >Show All</option>
					</select>
				</form>
				<noscript>
					<input class="thin" type="submit" value="Load">
				</noscript>
			</div>

%			unless ($side_locked) {

				<div class="even full">
					<span class="half">
						Entries in bracket
					</span>
					<span id="due_aff" class="half">
						<% $aff_teams_in_bracket %>
					</span>
				</div>

%			} else {
				<div class="odd full">
					<span class="half">
						Due <% $aff_string %> Entries
					</span>
					<span id="due_aff" class="half">
						<% $aff_teams_in_bracket %>
					</span>
				</div>

				<div class="even full">
					<span class="half">
						Due <% $neg_string %> Entries
					</span>
					<span id="due_neg" class="half">
						<% $neg_teams_in_bracket %>
					</span>
				</div>
%			}

			<div class="odd full">
				<span class="half">
					Paired Already
				</span>
				<span id="paired_already" class="half">
					<% $paired_teams %>
				</span>
			</div>

			<div class="even full">
				<span class="half">
					Left to Pair
				</span>
				<span id="left_to_pair" class="half">
					<% $unpaired_teams %>
				</span>
			</div>

			<a class="blue full" href="/panel/schemat/show.mhtml?round_id=<% $round_id %>">
				<% $round->realname %> Schematic
			</a>

		</div>

		<div
			class="sidenote"
			id="bracket_changes"
			<% $bracket_change_display_str %>
		>

			<h4>Bracket Changes</h4>

				<a
					id    = "autopairlink"
					class = "yellow full"
					href  = "/panel/round/pair_bracket.mhtml?round_id=<% $round_id %>&bracket_to_pair=<% $bracket %>&fromjava=true">
					Auto-pair remaining entries
				</a>

				<a
					id    = "collapse_up"
					class = "yellow full"
					href  = "collapse_bracket.mhtml?round_id=<% $round %>&bracket=<% $bracket %>&pull_iterator=1&fromjava=true">
					Collapse <% $bracket %> into <% $bracket + 1 %> bracket
				</a>

				<a
					id    = "collapse_down"
					class = "yellow full"
					href="collapse_bracket.mhtml?round_id=<% $round %>&bracket=<% $bracket %>&pull_iterator=-1&fromjava=true">
					Collapse <% $bracket %> into <% $bracket - 1 %> bracket
				</a>

				<a
					id    = "dump_bracket"
					class = "martop dkred full"
					href="dump_bracket.mhtml?round_id=<% $round_id %>&bracket_to_pair=<% $bracket %>&fromjava=true"
				>
					Dump debates in <% $bracket %> bracket
				</a>

				<a
					id    = "dump_and_autopair_bracket"
					class = "martop dkred full"
					href  = "/panel/round/pair_bracket.mhtml?round_id=<% $round_id %>&bracket_to_pair=<% $bracket %>&delete_existing=Seaver"
				>
					Dump <% $bracket %> debates &amp; autopair
				</a>

		</div>

		<div class="sidenote">

			<h4>Round Changes</h4>

			<a
				class="yellow full"
				href="reset_bracket.mhtml?round_id=<% $round_id %>&winsonly=false&fromjava=true"
			>Reset brackets using current pairings</a>

			<a
				class="yellow full"
				href="reset_bracket.mhtml?round_id=<% $round_id %>&winsonly=true&fromjava=true"
			>Reset brackets to win totals</a>

%			unless ($side_locked) {
				<a
					class="yellow full"
					href="snake_sides.mhtml?round_id=<% $round_id %>"
				>Assign debate sides</a>
%			}

<!--			<a class="yellow full" href="index.mhtml">Exit and assign rooms (inactive) </a>
				<a class="yellow full" href="index.mhtml">Exit and assign judges (inactive)</a>
-->

			<a
				class="martop dkred full"
				href="round_dump.mhtml?round_id=<% $round_id %>&from_pairing=Redsox&fromjava=true"
			>Dump Whole Round</a>

		</div>


	</div>
