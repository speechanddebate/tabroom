<%args>
	$tourn
	$tourn_settings
	$timeslot_id => undef
	$confirm     => undef
	$message     => undef
	$category_id    => undef
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $category = Tab::Category->retrieve($category_id);

	$m->abort unless $timeslot;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now( time_zone => $tz);

	if ($confirm) { 

		foreach my $round ($timeslot->rounds) { 

			my $event = $round->event;

			if ( $event->type eq "speech" ) { 
				$m->comp("/panel/schemat/blast_speech.mas", 
					round          => $round,
					event          => $event,
					tourn          => $tourn,
					tourn_settings => $tourn_settings,
					message        => $message
				);
			} elsif ( $event->type eq "congress" ) { 
				$m->comp("/panel/schemat/blast_congress.mas", 
					round          => $round,
					event          => $event,
					tourn          => $tourn,
					tourn_settings => $tourn_settings
				);
			} elsif ( $event->type eq "wudc" ) { 
				$m->comp("/panel/schemat/blast_wudc.mas", 
					round          => $round,
					tourn          => $tourn,
					event          => $event,
					tourn_settings => $tourn_settings,
					message        => $message
				);
			} else { 
				$m->comp("/panel/schemat/blast_debate.mas", 
					round          => $round,
					event          => $event,
					tourn          => $tourn,
					tourn_settings => $tourn_settings,
					message        => $message
				);
			}

			$round->setting("blasted", "date", $now);

		}

		my $msg = "Email and text notices sent for timeslot ".$timeslot->name;
		$m->redirect("blast.mhtml?timeslot_id=$timeslot_id&category_id=$category_id&msg=$msg");

	}

</%init>

	<div class="main">

		<h2>Blast Pairing</h2>

		<p>This will send individual email and text assignments to all the participants in the rounds below</p>

		<form action="blast.mhtml">

		<input 
			type  = "hidden"
			name  = "timeslot_id"
			value = "<% $timeslot_id %>"
		>

		<input 
			type  = "hidden"
			name  = "category_id"
			value = "<% $category_id %>"
		>

		<span class="block evenrow">
			Include a short message to recipients: 
			<input 
				type="text" 
				name="message" 
				maxlength="50" 
				size="40" 
				value=""
				class="marleftmore"
			>

		</span>

		<span class="liblrow block rightalign">
			<input 
				type        = "submit"
				name        = "confirm"
				value       = "Send email/text blast"
				placeholder = "Max 50 characters"
			>
			</form>
		</span>

		<h4>Rounds included</h4>

%		foreach my $round ($timeslot->rounds) { 
			<p><% $round->realname %> of <% $round->event->name %></p>
%		}

	</div>

	<div class="menu">
	
		<div class="sidenote">

			<h4>Judge Category</h4>

%			foreach my $other_category ($tourn->categories) { 
				<a class="<% $other_category->id == $category_id? "dk" : ""%>blue nowrap block" 
					href="timeslots.mhtml?category_id=<% $other_category->id %>">
					<% $other_category->name %>
				</a>
%			}

			<h4>Timeslot</h4>

%			foreach my $timeslot ($m->comp("/funclib/category_timeslots.mas", category => $category)) { 
				<a class="<% $timeslot->id == $timeslot_id? "dk" : ""%>yellow nowrap block" 
					href="blast.mhtml?category_id=<% $category_id %>&timeslot_id=<% $timeslot->id %>">
					<% $timeslot->name %>
				</a>
%			}

			<a href="index.mhtml" class="martop yellow block">
				By Division
			</a>

		</div>

	</div>
		
