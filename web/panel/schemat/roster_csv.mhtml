<%args>
	$round_id => undef
	$person
	$session
	$tourn
</%args>
<%init>
	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now;    
    $now->set_time_zone($tz);

	my $round = Tab::Round->retrieve($round_id);

	my $event = $round->event;

    my $event_name = $round->event->abbr;
    $event_name =~ s/[\W_]//g;

    my $name = $round->realname;
    $name =~ s/[\W_]//g;

    my $filename = "RoundParticipants-$event_name-$name.csv";

	$m->clear_buffer();
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print('"'.$event->name.'"');
	$m->print("\n");

	$m->print('"'.$round->realname.'"');
	$m->print("\n");


	my $sort_by = "codes";
	$sort_by = "lastnames" if $event->type eq "congress";

	my @entries = $m->comp(
		"/funclib/round_entries.mas",
		round    => $round,
		sort_by  => $sort_by
	);

	$m->print('"'.scalar @entries.' Contestants ",');
	$m->print("\n");

	foreach my $entry (@entries) {
		$m->print('"'.$entry->schoolname.'",');
		$m->print('"'.$entry->state.'",');
		$m->print('"'.$entry->name.'",');
		$m->print('"'.$entry->code.'",');
		$m->print('"'.$entry->lastname.'"') if $event->type eq "congress";
		
		$m->print("\n");
	}

	$m->flush_buffer();
	$m->abort();

</%init>

