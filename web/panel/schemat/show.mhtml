<%args>
	$person
	$person_settings
	$tourn
	$tourn_settings
	$show     => undef
	$done     => undef
	$event_id => undef
	$round_id => undef
	$perms    => undef
	$default  => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	$event = $round->event() if $round && not defined $event;
	$m->abort() unless $event;

	my @rounds = sort {$a->name <=> $b->name} $event->rounds();

	unless ($round) {

		unless (@rounds) {
			my $msg = "There are no rounds scheduled of ".$event->name.".  Try scheduling some?";
			$m->redirect("/setup/schedule/event.mhtml?event_id=$event_id&msg=$msg");
		}

		$round = $m->comp(
			"/funclib/event_current_round.mas",
				event => $event
		);

		$round = $m->comp(
			"/funclib/event_current_round.mas",
				event => $event,
				done  => "done"
		) unless $round;

		$round = $rounds[0] unless $round;

	}

	my %round_settings = $round->all_settings if $round;
	my $round_type = $round->type;

	my $ncfl++ if $tourn_settings->{"ncfl"};

	unless ($event || $round) {
		my $msg = "Please pick an event or a round plz";
		$m->redirect("/register/index.mhtml?msg=$msg");
	}

	my $event_type = $event->type;
	$event_type = "debate" if $event_type eq "wsdc";

	my $section = "section" if $event_type eq "speech";
	$section = "chamber" if $event_type eq "congress";
	$section = "pair" if $event_type eq "debate";
	$section = "assign" if $event_type eq "wudc";

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $category = $event->category if $event;
	$m->abort unless $category;

	my %category_settings   = $category->all_settings;
	my %event_settings      = $event->all_settings;
	my $round_robin         = $event_settings{"round_robin"};
	my $multi_sites         = $event_settings{"wsdc_multiple_sites"};
	my $no_side_constraints = $event_settings{"no_side_constraints"};
	my $rounds_per          = $category_settings{"rounds_per"};
	my $tab_ratings         = $category_settings{"tab_ratings"};
	my $coach_ratings       = $category_settings{"coach_ratings"};

	undef $rounds_per if $round_type eq "elim" || $round_type eq "final";

	my $prefs = $category_settings{"prefs"};
	undef $prefs if $prefs eq "none";
	undef $prefs if $event_settings{"no_prefs"};

	my $hihi_warn;

	if ($round) {

		my $oddround = $round->name % 2;

		if ( $round_type eq "highhigh"
			&! $oddround
			&! $no_side_constraints
		) {

			$hihi_warn = " This round is set to pair high-high in a side-constrained round.  Pairing this way will lead to some weird brackets and results. If you don't have a very good reason you should probably change the settings to high-low and try again.";

		}
	}

	my $unbalanced++ if $m->comp(
		"/funclib/round_unbalanced.mas",
		round => $round
	);

	my $preset++ unless $m->comp(
		'/funclib/round_entries.mas',
		round => $round
	);

	my @panels = $round->panels;

	my @flights = (1 .. $round->flighted);

	my %ballots_out = ();
	my $all_done++;

	if ($event_settings{"online_ballots"}) {

		foreach my $flight (@flights) {

			Tab::Judge->set_sql(ballots_out => "
				select count(distinct ballot.judge)
				from ballot, panel
				where panel.round = ?
				and panel.id = ballot.panel
				and ballot.audit != 1
				and panel.flight = ?
				and ballot.judge > 0
			");

			$ballots_out{$flight} =
				Tab::Judge->sql_ballots_out->select_val(
					$round->id,
					$flight
				);

			undef $all_done if $ballots_out{$flight} > 0;

		}

	} else {

		Tab::Judge->set_sql(ballots_out => "
			select count(distinct ballot.judge)
			from ballot, panel
			where panel.round = ?
			and panel.id = ballot.panel
			and ballot.audit != 1
			and ballot.judge > 0
		");

		$ballots_out{"all"} = Tab::Judge->sql_ballots_out->select_val($round->id);

		undef $all_done if $ballots_out{"all"} > 0;

	}

	Tab::Panel->set_sql( missing_rooms => "
		select panel.*
		from panel
		where panel.bye != 1
		and panel.round = ?
		and not exists (
			select room.id
			from room
			where room.id = panel.room
		)
		and exists (
			select ballot.id
			from ballot
			where ballot.panel = panel.id
			and ballot.bye != 1
			and ballot.forfeit != 1
		)
	");

	my @missing = Tab::Panel->search_missing_rooms($round->id);
	my $missing_rooms++ if @missing;
	my $all_missing_rooms++ if scalar @missing == scalar $round->panels;

	Tab::Panel->set_sql( missing_judges => "
		select panel.*
		from panel, ballot
		where panel.bye != 1
		and panel.round = ?
		and ballot.panel = panel.id
		and ballot.bye != 1
		and ballot.forfeit != 1
		and not exists (
			select judge.id
			from judge
			where judge.id = ballot.judge
		)
	");

	my $missing_judges++ if Tab::Panel->search_missing_judges($round->id);
	my $entered++ if $all_done && (not defined $missing_judges);
	my $settings_visible++ if $missing_judges || $missing_rooms;

    my @tabs;
	my %links;


	if (
		($event_type eq "speech" || $event_type eq "congress")
		&& $round_type eq "elim"
		&& (
			(not defined $tourn_settings->{"nsda_district"})
			|| $tourn_settings->{"nsda_pilot_".$event_type}
		)
	) {
		$links{"snake"} = "show_snake.mhtml?round_id=".$round->id;
	}

    push @tabs, "settings";

	if ($preset && ($round_type eq "elim" || $round_type eq "final")) {
    	push @tabs, "pre-create";
		$default = "pre-create" unless $default;
	} elsif ($preset) {
		$default = "schematic" unless $default;
	}

	if ($round) {
		push @tabs, "schematic";
		push @tabs, "reports";
		push @tabs, "results";
	}

	unless ($default) {
		$default = "pre-create" if $preset && ($round_type eq "elim" || $round_type eq "final");
		$default = "schematic" unless $default;
	}

	my $start = $round->start_time;
	$start = $round->timeslot->start
		if $round->timeslot && (not defined $start);
	$start->set_time_zone($tz) if $start;

	my $prep_offset;

	if ($event_settings{"prep_offset"}) {
		$prep_offset = $start->clone();
		$prep_offset->subtract( minutes => $event_settings{"prep_offset"});
	}

	my $entry_only++ if ${$perms}{"entry_only"};
	undef $entry_only if $person_settings->{"nsda_district"};
	undef $entry_only if $person->site_admin;

	$show = "schools" if $entry_only;

	my $gplus_warn = $m->comp(
		"/funclib/gplus_check_round.mas",
		tourn_id => $tourn->id
	);

	Tab::Panel->set_sql(next_round =>  "
		select distinct panel.*
		from panel, round
		where round.name = ?
		and round.event = ?
		and round.id = panel.round
	");

</%init>

	<div class="menu">

%		if ($entry_only) {

			<div class="sidenote">

				<h4>Return</h4>

				<a
					class="blue full"
					href="/tabbing/entry/index.mhtml"
				>
					Return to Ballot Entry
				</a>

			</div>

%		} else {

			<script>
				$(document).ready(function(){
					$("#hide").click(function(){
						$("#eraser").hide();
						$("#hide").hide();
						$("#show").show();
					});
					$("#show").click(function(){
						$("#eraser").show();
						$("#hide").show();
						$("#show").hide();
					});
				});
			</script>

			<div class="sidenote">

%				$settings_visible++ if $preset;
%				$settings_visible++ if $unbalanced;

				<div
					style = "border-bottom: 1px dashed #444;"
					class = "nowrap"
				>

					<span class="tenth">

						<a
							class = "notfirst fa fa-sm fa-eye-slash buttonwhite redtext invert"
							id    = "hide"
							style = "<% $settings_visible ? "" : "display: none;"%>"
						></a>

						<a
							class = "notfirst fa fa-sm fa-eye buttonwhite redtext"
							id    = "show"
							style = "<% $settings_visible ? "display: none;" : ""%>"
						></a>

					</span>

					<span class="ninetenth">
						<h4 class="marno">Change &amp; Destroy</h4>
					</span>

				</div>

				<div
					id    = "eraser"
					style = "<% $settings_visible ? "" : "display: none;"%>
				">

<%perl>

			my %show_buttons;

			if ($tourn_settings->{"nsda_district"}) {
				$show_buttons{"qualifiers"}++ if $round_type eq "final";
				$show_buttons{"qualifiers"}++ if $round_type eq "runoff";
			}

			if ($tourn_settings->{"nsda_nats"}) {
				$show_buttons{"top14"}++ if $round_type eq "final";
			}

			if (
				$tourn_settings->{"nsda_district"}
				&& (not defined $event_settings{"not_districts"})
				&& (not defined $tourn_settings->{"nsda_pilot_".$event_type})
			) {

				# NSDA Districts that are not using the sane pilot system.

				$show_buttons{"nsda_section"}++ unless $round_type eq "runoff";
				$show_buttons{"nsda_next_section"}++
					if $entered && $round_type ne "runoff" && $round_type ne "final";

			} elsif (
				$tourn_settings->{"nsda_nats"}
				&& (not defined $event_settings{"not_nats"})
				&& ($round_type eq "elim" || $event_type eq "final")
				&& $event_type ne "congress"
			) {

				# NSDA Nationals rules in the elims are more like districts than not

				$show_buttons{"nsda_section"}++ unless $round_type eq "runoff";
				$show_buttons{"nsda_next_section"}++
					if $entered && $round_type ne "runoff" && $round_type ne "final";

			} else {

				# Congratulations.  You are running a normal tournament.

				if ($event_settings{"round_robin"}) {
					$show_buttons{"round_robin_warning"}++
						unless $round_type eq "elim" || $round_type eq "final";
				}

				if ($round_type eq "elim" || $round_type eq "final") {

					$show_buttons{"normal_elim_section"} = "Auto-Advance to ".ucfirst($round_type)." Round";

					if ($event_type eq 'congress' && $round_type eq "elim") {
						$show_buttons{"clone_elim"}++;
					}

				} elsif ($round_type eq "runoff") {

				} else {
					if ($event_type eq "debate" || $event_type eq "wudc") {
						$show_buttons{"normal_section"} = "Auto Pair";
						$show_buttons{"normal_powermatch"}++
							if $round_type eq "highhigh" || $round_type eq "highlow";

					} elsif ($event_type eq "speech" || $event_type eq "congress") {
						$show_buttons{"normal_ie_section"} = "Auto Section";
					}
				}
			}

			if ($event_type eq "wudc") {

				my @entries = $event->entries( active => 1 );

				if (scalar @entries % 4) {
					$show_buttons{"wudc_warn"} = "The field size (".scalar @entries.") is not ";
					$show_buttons{"wudc_warn"} .= "divisible by 4.  This pairing will have byes.";
				}
			}

			$show_buttons{"runoff_warning"}++ if $round_type eq "runoff";

			my $pair_class = "yellow half";
			$pair_class = "centeralign dkgreen half" if $preset;

</%perl>

%				if ($show_buttons{"qualifiers"}) {
					<a
						class="dkyellow full martopmore centeralign"
						href="/tabbing/results/nsda_qualifiers.mhtml?event_id=<% $event->id %>"
					>
						Display National Qualifiers
					</a>
%				}

%				if ($show_buttons{"top14"}) {
					<a
						class="dkgreen full martopmore"
						href="/tabbing/results/nsda_qualifiers.mhtml?event_id=<% $event->id %>"
					>
						Display Top 14 Finishers
					</a>
%				}

%				if ($round->name == 1 && $show_buttons{"nsda_section"}) {
					<a
						class="<% $preset ? "dkgreen" : "dkyellow" %> martop full marbottom"
						href="/panel/round/nsda/redirector.mhtml?round_id=<% $round->id %>"
					>
						<% $preset ? "" : "Re-" %><% ucfirst($section) %>
						<% $round->realname %>
					</a>
%				}

<%perl>
				if (
					($round->name == 1
						&& $tourn_settings->{nsda_district}
						&& (not defined $tourn_settings->{"nsda_pilot_".$event_type})
					)
					|| ((not defined $preset) && $show_buttons{"nsda_next_section"})
				) {
</%perl>
					<a
						class = "dkgreen martop full marbottom"
						href  = "/panel/round/nsda/redirector.mhtml?round_id=<% $round->id %>&next=1"
					>
						Create next round
					</a>

%				} elsif ($preset && $tourn_settings->{"nsda_district"} && (not defined $tourn_settings->{"nsda_pilot_".$event_type})) {

					<span class="centeralign redtext semibold marleftmore marrightmore bigger martopmore">
						To pair this Districts round, go to the previous debate
						and use the "Create next round" button under Change
						&amp; Destroy.
					</span>

%				}

%				if ($show_buttons{"runoff_warning"}) {
					<p class='semibold redtext biggish'>
						To schedule a runoff, start from the round where the tie occurred,
						and use 'Schedule Runoff to Break Ties' under Change &amp; Destroy.
					</p>"
<%perl>
				}

				my $warn;

				if ($show_buttons{"round_robin_warning"}) {
					$warn = "This button will pair the ENTIRE round robin ";
					$warn .= " AND delete any existing rounds.  Continue?";
				} else {
					$warn = "This will delete the existing ".$round->realname." and resection it.  Are you sure?";
				}

				if ($show_buttons{"normal_section"}) {
</%perl>
					<a
						class = "<% $pair_class %> martop"
						href  = "/panel/round/panel_master.mhtml?round_id=<% $round->id %>"
%						unless ($preset) {
							<& "/funclib/confirm.mas", warn => $warn &>
%						}
					>
						<% $show_buttons{"normal_section"} %>
					</a>
%				}

%				if ($show_buttons{"normal_ie_section"}) {
					<a
						class = "<% $pair_class %> martop"
						href  = "/panel/round/panel_single.mhtml?round_id=<% $round->id %>"
%						unless ($preset) {
							<& "/funclib/confirm.mas", warn => $warn &>
%						}
					>
						<% $show_buttons{"normal_ie_section"} %>
					</a>
%				}

%				if	($show_buttons{"normal_elim_section"}) {
					<a
						class = "<% $pair_class %> martop full"
						href="/tabbing/break/index.mhtml?preset_id=<% $round->id %>&event_id=<% $event->id %>"
%						unless ($preset) {
							<& "/funclib/confirm.mas", warn => $warn &>
%						}
					>
						<% $show_buttons{"normal_elim_section"} %>
					</a>
<%perl>
				}

				if ($show_buttons{"clone_elim"}) {

					my $first_elim;
					my $elim_count;

					foreach my $other (sort {$a->name <=> $b->name} @rounds) {
						if ($other->type eq "elim") {
							$first_elim = $other unless $first_elim;
							$elim_count++;
						}
					}

					if ($elim_count > 1
						&& $first_elim != $round
					) {
</%perl>
						<a
							class = "<% $pair_class %> martop full"
							href  = "/panel/round/panel_master.mhtml?round_id=<% $round->id %>&clone=1";
%							unless ($preset) {
								<& "/funclib/confirm.mas", warn => $warn &>
%							}
						>
							Clone <% $first_elim->realname %> into <% $round->realname %>
						</a>

<%perl>
					}
				}

				if ($show_buttons{"normal_powermatch"}) {
</%perl>
					<a
						class = "yellow half"
						href  = "/panel/manipulate/manual_powermatch.mhtml?round_id=<% $round->id %>"
					>
						Manually Power
					</a>
%				}

%				if ($show_buttons{"normal_section"}) {

%					if ($event_type eq "wudc") {
						<a
							class = "yellow half"
							href  = "/panel/manipulate/manual_wudc.mhtml?round_id=<% $round->id %>">
							Manually pair
						</a>
%					} else {
						<a
							class = "yellow half"
							href  = "/panel/manipulate/manual_debate.mhtml?round_id=<% $round->id %>">
							Manually pair
						</a>
%					}
%				}

%				if ($show_buttons{"normal_ie_section"}) {
					<a
						class = "yellow half"
						href  = "/panel/manipulate/manual_speech.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>">
						Manually section
					</a>
%				}

				<span class="nospace padvertless full"></span>

<%perl>
				unless ($preset) {

					if (
						(not defined $tourn_settings->{"nsda_district"})
						|| $tourn_settings->{"nsda_pilot_".$event_type}
						|| $round_settings{"nsda_confirmed"}
						|| $round_type eq "runoff"
					) {

						$warn = "You are about to erase judges and re-assign them.  Are you sure?";
						undef $warn if $missing_judges;

						if ($event_type eq "congress" && $category_settings{"ask_parli"}) {

							my $parli_warn = "You are about to erase parliamentarians and re-assign them";
							$parli_warn = " in ALL prelim chambers" if $round_type eq "prelim";
							$parli_warn .= ". Are you sure?";

							my $scorer_warn = "You are about to erase scorers in ".$round->realname;
							$scorer_warn .= " and re-assign them.  Are you sure?";

							undef $parli_warn if $missing_judges;
							undef $scorer_warn if $missing_judges;

</%perl>
							<a
								class="yellow half"
								href="/panel/round/judges.mhtml?round_id=<% $round->id %>&parlis=1"
								<& "/funclib/confirm.mas", warn => $parli_warn &>
							>
								Auto-assign parlis
							</a>

							<a
								class="yellow half"
								href="/panel/round/judges.mhtml?round_id=<% $round->id %>&parlis=2"
								<& "/funclib/confirm.mas", warn => $scorer_warn &>
							>
								Auto-assign scorers
							</a>

							<a
								class="yellow half"
								href="/panel/round/judges.mhtml?round_id=<% $round->id %>&parlis=3"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign both
							</a>
<%perl>

						} elsif (
							$event_type eq "speech"
							|| $event_type eq "congress"
							|| $event_type eq "wudc"
						) {
</%perl>
							<a
								class="yellow half"
								href="/panel/round/judges.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign judges
							</a>

%						} elsif ($multi_sites) {

							<a
								class="yellow half"
								href="/panel/round/debate_judge_multisite.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign judges
							</a>

<%perl>
						} elsif (
							$round_settings{"num_judges"} > 1
							&& $prefs
							&& $round_type eq "elim"
						) {
</%perl>
							<a
								class="yellow half"
								href="/panel/round/debate_judge_panel.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign judges
							</a>
<%perl>
						} else {

							if ($event_settings{"break_point"}
								&& ($round_type eq "highhigh" || $round_type eq "highlow")
							) {

								my $break_bracket = $round->name - $event_settings{"break_point"} - 1;
</%perl>

								<a
									class = "yellow half"
									href  = "/panel/round/debate_judge_assign.mhtml?min_bracket=<% $break_bracket  %>&round_id=<% $round->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>
								>
									Judges (In debates)
								</a>

								<a
									class="yellow half"
									href="/panel/round/debate_judge_assign.mhtml?max_bracket=<% ($break_bracket) %>&round_id=<% $round->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>
								>
									Judges (Out debates)
								</a>

%							}

							<a
								class="yellow half"
								href="/panel/round/debate_judge_assign.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign judges
							</a>

%						}

						<a
							class="yellow half"
							href="/panel/round/manual_judges.mhtml?round_id=<% $round->id %>"
						>
							Hand place judges
						</a>
<%perl>

						if ($round_settings{"num_judges"} > 1
							&& $round->flighted > 1
							&& (
								($round_type ne "elim") || (not defined $prefs)
							)
						) {

</%perl>
							<a
								class = "yellow full nowrap"
								title = "Use this if your judging is tight"
								href  = "/panel/round/debate_judge_panel.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-place judges w/o same panels flight 2
							</a>
%						}

%						if ($prefs eq "ordinals") {
							<a
								class="yellow half"
								href="/panel/round/debate_judge_assign_cat.mhtml?round_id=<% $round->id %>"
							>
								CAT/STA-Assign Judges
							</a>
%						}

							<span class="nospace padvertless full"></span>
<%perl>

							undef $warn;
							$warn = "This will assign rooms to any rounds without rooms for the whole day"
								if $multi_sites;
</%perl>

							<a
								class = "yellow half"
								href  = "/panel/round/rooms.mhtml?round_id=<% $round->id %>"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Auto-assign rooms
							</a>

							<a
								class = "yellow half"
								href  = "/panel/round/manual_rooms.mhtml?round_id=<% $round->id %>"
							>
								Hand place rooms
							</a>

<%perl>

						} elsif (
							$tourn_settings->{"nsda_district"}
							&& (not defined $round_settings{"nsda_confirmed"})
							&& (not defined $tourn_settings->{"nsda_pilot_".$event_type})
							&! $round_type eq "runoff"
						) {
</%perl>

							<div class="row">

								<p>
									Round must be confirmed before judges/rooms can be assigned.
								</p>
								<p>
									Hit 're-<% $section %>' round above and double check the Check tab.
								</p>

							</div>

%						}
%						if ($event_type eq "speech" || $event_type eq "congress") {
%							if ($unbalanced) {
								<a
									class = "dkgreen full martop marbottom"
									href  = "/panel/manipulate/manual_rebalance.mhtml?round_id=<% $round->id %>"
								>
									Rebalance <% $section%>s
								</a>
%							}
%						}

%						if ($event_type ne "congress") {
							<a
								class="full yellow marbottom martopmore"
								href="/panel/round/runoff.mhtml?round_id=<% $round->id %>"
							>
								Schedule Runoff to Break Ties
							</a>
<%perl>
						}

						$warn = "You are about to delete all entries from this round.  You cannot get them back.  Please, for the love of all that is good and holy, be certain you mean it";

</%perl>

						<a
							class = "dkred full martopmore centeralign "
							href  = "round_dump_entries.mhtml?round_id=<% $round->id %>"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
							Erase entries
						</a>

<%perl>

						$warn = "You are about to delete all judges from this round.  You cannot get them back.  Please, for the love of all that is good and holy, be certain you mean this";

</%perl>

						<a class = "dkred full centeralign "
							href = "round_dump_judges.mhtml?round_id=<% $round->id %>"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
							Erase judges
						</a>

%						if ($event_type eq "congress") {

							<a class = "dkred half centeralign "
								href = "round_dump_judges.mhtml?round_id=<% $round->id %>&erase_chairs=1"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Erase parlis
							</a>

							<a class = "dkred half centeralign "
								href = "round_dump_judges.mhtml?round_id=<% $round->id %>&erase_chairs=2"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
								Erase scorers
							</a>
%						}

<%perl>

						$warn = "You are about to delete all ROOMS from this round.  You cannot get them back.  Please, for the love of all that is good and holy, be certain you mean this";

</%perl>

						<a class="dkred full centeralign "
							href="round_dump_rooms.mhtml?round_id=<% $round->id %>"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
							Erase rooms
						</a>

<%perl>
						$warn = "You are about to delete this ENTIRE ROUND. You cannot get it back.  Please, for the love of all that is good and holy, be certain you mean this!";
</%perl>

						<a class="dkred full centeralign "
							href="round_dump.mhtml?round_id=<% $round->id %>"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
							Erase round
						</a>

%						if ($tourn->hidden) {

<%perl>
							$warn = "You are about to fake the ranks for an entire round.  Existing ranks will be wiped out.  Please be sure.  There is no undo here.";

</%perl>
							<a
								class="dkred full martopmuchmore centeralign "
								<& "/funclib/confirm.mas", warn => $warn &>
								href="/tabbing/entry/fake/<% $event_type %>.mhtml?round_id=<% $round->id %>">
								Fake Results
							</a>

%							$warn = "You are about to fake the ranks for the ENTIRE EVENT.  ALL Existing ranks will be wiped out.  Please be sure.  There is no undo here.";

							<a
								class="dkred full martop centeralign  full"
								<& "/funclib/confirm.mas", warn => $warn &>
								href="/tabbing/entry/fake/<% $event_type %>.mhtml?event_id=<% $event->id %>">
								Whole Event
							</a>

<%perl>
						}

					if ($round_type ne "runoff"
						&& ($round_type eq "elim" || $tourn_settings->{"wsdc"})
					) {
</%perl>
						<a
							class="martopmore full yellow"
							href="/panel/manipulate/bracket_edit.mhtml?round_id=<% $round->id %>"
						>Edit Bracket</a>
%					}

%					my @idle = $m->comp("/funclib/round_idle_judges.mas", round => $round);

					<a
						class = "yellow full martopmore"
						href  = "/panel/manipulate/free_judges.mhtml?round_id=<% $round->id %>"
					>
						Assign/List <% scalar @idle %> Unused Judges
					</a>

%				}


				</div>

			</div>

			<div class="sidenote">

				<h4>Share & Enjoy</h4>

%				my $sizebutton = "full";

%				if ($tourn_settings->{"nsda_district"}) {

%					$sizebutton = "half";

					<a
						class="yellow martop half"
						href="/panel/round/nsda/redirector.mhtml?round_id=<% $round->id %>&default=checks"
					>
						NSDA Confirmation
					</a>

%				}

%				if ($tourn_settings->{"nsda_nats"} &! $event_settings{"not_nats"}) {

%					$sizebutton = "half";

					<a
						class="marbottom yellow <% $sizebutton %>"
						href="show_snake.mhtml?round_id=<% $round->id %>"
					>
						NSDA Confirmation
					</a>

%				}

				<a
					class="marbottom yellow <% $sizebutton %>"
					href="disaster_check.mhtml?round_id=<% $round->id %>"
				>
					Check for Disasters
				</a>

				<div class="row marno full padless">

					<span class="fourfifths nospace">

						<span class="third nowrap">
							Start time
						</span>

						<span class="twothirds nospace">
							<input
								id    = "start_time_round_id"
								type  = "hidden"
								name  = "round_id"
								value = "<% $round->id %>"
							>
							<input
								id    = "start_time_tourn_id"
								type  = "hidden"
								name  = "tourn_id"
								value = "<% $tourn->id %>"
								onSubmit="schematPost('start_time.mhtml');"
							>

							<& "/funclib/timepicker.mas",
								name => "starttime",
								time => $start,
								size => 12
							&>

						</span>

					</span>

					<span class="fifth rightalign nospace">
						<input
							type  = "submit"
							class = "notfirst thin"
							value = "Set"
							onClick="schematPost('start_time.mhtml',
								{
									tourn:$('#start_time_tourn_id').val(),
									round_id:$('#start_time_round_id').val(),
									starttime:$('#starttime').val()
								});"
							>
					</span>

<script>

				function schematPost(dest,vals,warning){
					// I would use promises here, but...
					var df = $.Deferred();

					if (warning){
						alertify.confirm(
							"Please confirm",
							warning,
							function() {
								sendIt(dest,vals);
							},
							function(){
								alertify.notify("Action canceled");
							}
						);
					} else {
						sendIt(dest,vals);
					}
				}

				function sendIt(dest,vals){
					return $.post(dest,vals)
					.done(function(data) {
						if (data.error) {
							alertify.error(data.message);
						} else {
							alertify.notify(data.message, "custom");
							switch (dest){
								case 'start_time.mhtml':
									$('#round-start-time').text(data.message.split(' ').slice(-2).join(' '));
									$('#start_time').val(data.message.split(' ').slice(-2).join(' ')); // UMMMMMM :grimacing:
								break;
								case 'publish.mhtml':
								break;
								case 'post_results.mhtml':
								break;
							}
						}
					});
				}
</script>

				</div>

				<div class="row marno full padless">

					<input
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>
<%perl>

					undef $warn;

					$warn = "This round has missing rooms.  Are you sure you want to publish it? "
						if $missing_rooms;

					$warn = "This round has missing judges.  Are you sure you want to publish it? "
						if $missing_judges;

					$warn = "This round has missing rooms AND judges.  Are you sure you want to publish it? "
						if $missing_judges && $missing_rooms;

</%perl>

					<span class="fourfifths nospace">

						<span class="third">
							Publish
						</span>

						<span class="twothirds nospace">

							<select
								name  = "published"
								id    = "notfirst"
								class = "notfirst fixedsmallest plain"
							>

								<option
									value="0"
									<% $round->published ? "" : "selected" %>
								>Not Public</option>

								<option
									value="1"
									<% $round->published == 1 ? "selected" : "" %>
								>On Web</option>

								<option
									value="2"
									<% $round->published == 2 ? "selected" : "" %>
								>On Web w/o Judges</option>

%								if ($event_type eq "wudc") {
									<option
										value="3"
										<% $round->published == 3 ? "selected" : "" %>
									>On Web w/Motion</option>
%								}
							</select>
						</span>
					</span>

					<span class="fifth rightalign nospace">
						<input
							type  = "submit"
							value = "Go"
							class = "thin notfirst"
							onClick="schematPost('publish.mhtml',{
								tourn     : $('#start_time_tourn_id').val(),
								round_id  : $('#start_time_round_id').val(),
								published : $('#notfirst').val()
							},'<% $warn %>');"
						>
					</span>
				</div>

				<form action="blast.mhtml" method="post">

				<input
					type  = "hidden"
					name  = "round_id"
					value = "<% $round->id %>"
				>

				<div class="row marno full padnovert">

					<span class="fourfifths nospace">
						<span class="full">
							Blast Emails &amp; Texts
						</span>
					</span>

					<span class="fifth rightalign nospace">
						<input
							type  = "submit"
							value = "Go"
							class = "thin notfirst"
						>
					</span>
				</div>

				</form>

				<div class="row marno full padless">
					<input
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span class="fourfifths nospace ">

						<span class="third">
							Results
						</span>

						<span class="twothirds nospace">
							<select
								name  = "post"
								id    = "notfirst"
								class = "notfirst fixedsmallest plain">

								<option
									value = "0"
									<% $round->post_results ? "" : "selected" %>
								>Not Public</option>

								<option
									value="1"
									<% $round->post_results == 1 ? "selected" : "" %>
								>Only <% $event_type ne "debate" ? "Ranks" : "Win/Loss"%></option>

								<option
									value="2"
									<% $round->post_results == 2 ? "selected" : "" %>
								>Full Results</option>

							</select>
						</span>
					</span>

<%perl>

					my $publish_warn = "You are publishing results before ballots are entered.  This will mean people can see each ballot as it is entered by judges or you. Click OK to confirm you are a little insane and actually want to do this..." unless $all_done;

</%perl>
					<span class="fifth rightalign  nospace">
						<input
							type  = "submit"
							value = "Go"
							class = "thin notfirst"
							onClick="schematPost('post_results.mhtml',{
								round_id	:$('input[name=round_id]').val(),
								post		:$('select[name=post]#notfirst').val()
							},'<% $publish_warn %>');"
						>
					</span>

				</div>

%				if ($event_settings{"wsdc_subtotal_ballot"}) {

					<form
						action = "/panel/report/wsdc_email_ballot.mhtml"
						method = "post"
					>

					<input
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<div class="row marno full padless">

						<span class="fourfifths nospace ">
							Email WSDC Ballot Scores
						</span>

						<span class="fifth rightalign  nospace">
							<input
								type  = "submit"
								value = "Go"
								class = "thin notfirst">
						</span>

					</div>

					</form>
%				}

%				if ($round_type eq "elim" || $round_type eq "final") {

					<input
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>


					<div class="row full nospace">

						<label for="clearing">
							<span class="fourfifths nospace hover padleft">

								<span class="threequarters nospace">
									Publish clearing entries
								</span>

								<span class="quarter centeralign nospace">

									<input
										type  = "checkbox"
										class = " notfirst thin"
										id    = "clearing"
										name  = "clearing"
										value = "1"
										<% $round_settings{'publish_entry_list'}
											? 'checked="checked"'
											: ""
										%>
									>
								</span>

							</span>
						</label>

						<span class="fifth rightalign nospace">
							<input
								type  = "submit"
								value = "Go"
								class = "thin notfirst"
								onClick="
									schematPost('publish.mhtml',{
										tourn    : $('#start_time_tourn_id').val(),
										round_id : $('#start_time_round_id').val(),
										clearing : $('#clearing').prop('checked'),
										type     : 'clearing'
									},'<% $warn %>');"
							>
						</span>

					</div>
%				}

				<h4>Display</h4>
<%perl>

				my %displays = (
					entrynames  => { order => 1, label => "Entry Names"},
					entrycodes  => { order => 2, label => "Entry Codes", default => "on"},
					judgenames  => { order => 3, label => "Judge Names", default => "on"},
					schoolnames => { order => 5, label => "Schools"},
				);

				my $order = 6;

				unless ($category_settings{"no_codes"}) {
					$displays{"judgecodes"} = { order => 4, label => "Judge Codes" };
				}

				unless ($tourn_settings->{"nsda_nats"} || $tourn_settings->{'ncfl'}) {
					if ($tourn_settings->{"school_codes"} ne "none") {
						$displays{"schoolcodes"} = { order => $order++, label => "School Codes" };
					}
				}

				if ($tourn_settings->{"nsda_district"} && $event->abbr eq "HOU") {
					$displays{"blocs"} = { order => $order++, label => "House Blocs"};
				}

				if ($tourn_settings->{"nsda_nats"}) {
					$displays{"districtcodes"} = { order => $order++, label => "District Codes"};
					$displays{"districtnames"} = { order => $order++, label => "District Names"};
					$displays{"states"} = { order => $order++, label => "States"};
				} elsif ($tourn_settings->{"ncfl"}) {
					$displays{"regioncodes"} = { order => $order++, label => "Diocese Codes"};
					$displays{"regionnames"} = { order => $order++, label => "Diocese Names"};
					if ($event_type eq "debate") {
						$displays{"dioregions"} = { order => $order++, label => "Diocese Region"};
					}
				} elsif ($tourn_settings->{"regions"}) {
					$displays{"regioncodes"} = { order => $order++, label => "Region Codes"};
					$displays{"regionnames"} = { order => $order++, label => "Region Names"};
				}

				if ($round_settings{"showrooms_from"}) {
					my $from_round = Tab::Round->retrieve($round_settings{"showrooms_from"});
					$displays{"showrooms_from"} = {
						order => $order++, label => $from_round->realname." Rooms"
					};
				}

				$displays{"anonymize"} = { order => $order++, label => "Anonymize"};

				if ($prefs || $tab_ratings || $coach_ratings) {
					$displays{"prefs"} = { order => $order++, label => "Prefs/Ratings", default => "on"};
				}

				if ($event_type eq "debate") {
					if ($round_type eq "elim") {
						$displays{"records"} = { order => $order++, label => "Records"};
					} else {
						$displays{"records"} = { order => $order++, label => "Records", default => "on"};
					}
					$displays{"decisions"} = { order => $order++, label => "Decisions", default => "on"};
				}

				if ( $round_type eq "prelim" && (
					$event_settings{"pair_seeds"}
					|| $event_settings{"apda"}
					|| $event_settings{'seed_presets'}
				)) {
					$displays{"seeds"} = { order => $order++, label => "Seeds"};
				}

</%perl>

				<script>

					// Show/hide various values on the schematic.  This time
					// with at least a vague understanding of JS and not just
					// flinging shit around until it sticks.  Progress!  -CLP

					function showProperty(fieldName) {

						if ( $("#"+fieldName).prop("checked") ) {

							$("."+fieldName).removeClass('hidden');
							$("."+fieldName+"_placeholder").addClass('hidden');
							$("."+fieldName+"_label").addClass('semibold');
							$("."+fieldName+"_label").addClass('bluetext');

							if (fieldName === "anonymize") {
								$(".identities").addClass("hidden");
							}

						} else {

							$("."+fieldName).addClass('hidden');
							$("."+fieldName+"_placeholder").removeClass('hidden');
							$("."+fieldName+"_label").removeClass('semibold');
							$("."+fieldName+"_label").removeClass('bluetext');

							if (fieldName === "anonymize") {
								$(".identities").removeClass("hidden");
							}
						}
					}
				</script>

<%perl>
				foreach my $field (
					sort {$displays{$a}{"order"} <=> $displays{$b}{"order"}}
					keys %displays
				) {
</%perl>
					<label for="<% $field %>">
						<span class="pagehalf hover padvertless marno ltborder">
							<span
								class="
									threequarters <% $field %>_label padleft
									<% $displays{$field}{"default"} eq "on"
										? "semibold bluetext"
										: ""
									%>"
								>
								<% $displays{$field}{"label"} %>
							</span>

							<span class="fifth centeralign nospace padvertless">
								<input
									type     = "checkbox"
									id       = "<% $field %>"
									value    = "1"
									class    = "padvertless marno notfirst"
									onChange = "showProperty('<% $field %>');"
									<% $displays{$field}{"default"} eq "on"
										? "checked"
										: ""
									%>
								>
							</span>
						</span>
					</label>
%				}


				<div class="odd padvert centeralign semibold bluetext">
					<span
						class="fa fa-arrow-left inline"
					></span>
					Printouts? Click blue "Reports" button above
				</div>

			</div>

			<div class="sidenote">

				<h4>Stats & Data</h4>

%				if ($event_type eq "wudc") {
					<a
						class = "blue full"
						href  = "/panel/manipulate/wudc_positions.mhtml?round_id=<% $round->id %>"
					>
						Check Team Positions
					</a>
%				}

<%perl>
				if ($round_type eq "prelim"
					&& (
						$event_settings{"pair_seeds"}
						|| $event_settings{"apda"}
						|| $event_settings{'seed_presets'}
					)
				) {
</%perl>
					<a
						class="blue full"
						href="/panel/report/preset_draw.mhtml?event_id=<% $event->id %>"
					>
						Preset Draw Report
					</a>
%				}

%				if ($event_type eq "wudc") {

					<div class="odd full">

						<span class="third full">
							Motion
						</span>

						<span class="twothird full">
							<% $round_settings{"motion"} ? "Entered" : "Not Entered" %>
						</span>

					</div>
%				}

				<div class="row marno full padless">

					<span class="half rightalign padless semibold">
						<% ucfirst($section) %>ed
					</span>

					<span class="half padless">
						<% $round->created
							? &Tab::niceshortdayt($round->created->set_time_zone($tz))
							: "Not recorded" %>
					</span>
				</div>

<%perl>

				Tab::Score->set_sql( last_altered => "
					select score.*
					from panel, ballot, score
					where panel.round = ?
					and panel.id = ballot.panel
					and ballot.id = score.ballot
					and score.tag in ('ballot', 'rank')
					order by score.timestamp DESC limit 1
				");

				my $last_bv = Tab::Score->search_last_altered($round->id)->first if $round;

				my $last_timestamp;

				if ($last_bv) {
					$last_timestamp = $last_bv->timestamp;
					$last_timestamp->set_time_zone("UTC");
					$last_timestamp->set_time_zone($tz);
				}

				my $blasted = $round_settings{'blasted'};

				if ($blasted) {
					$blasted->set_time_zone("UTC");
					$blasted->set_time_zone($tz);
				}

</%perl>

				<div class="row marno marno full padless">

					<span class="half rightalign padless semibold">
						Blasted:
					</span>

					<span class="half padless">
						<% $blasted
							?  &Tab::niceshortdayt($blasted)
							: "Not yet blasted" %>
					</span>
				</div>

				<div class="row marno full padless">

					<span class="half rightalign padless semibold">
						First Ballot:
					</span>

					<span class="half padless">
						<% $round_settings{"first_ballot"}
							?  &Tab::niceshortdayt($round_settings{"first_ballot"}->set_time_zone($tz))
							: ""
						%>
					</span>
				</div>

				<div class="row marno marno full padless">

					<span class="half rightalign padless semibold">
						Finished
					</span>

					<span class="half padless">
						<% $last_timestamp
							? &Tab::niceshortdayt($last_timestamp)
							: "Not recorded" %>
					</span>
				</div>


<%perl>

				if ($rounds_per > 0 ) {

					my ($assigned_judges_past, $paired_panels_current, $assigned_judges_current,
						$needed_panels_current, $needed_judges_current, $paired_panels_future,
						$assigned_judges_future, $needed_panels_future, $needed_judges_future,
						$category_rds_left, $assigned_to_last, $unassigned_burned_already,
						$unassigned_one_plus_left, $unassigned_one_left, $total_in_category)
					= $m->comp(
						"/funclib/judge_oblig_count_by_category.mas",
						current_rd_id => $round->id
					);

</%perl>
					<h5>
						Preferences stats
					</h5>

					<div class="row marno full padless">

						<span class="sixth rightalign">
							<% $total_in_category %>
						</span>

						<span class="fivesixth">
							Total judges in <% $category->abbr %>
						</span>

					</div>

					<div class="row marno full padless">

						<span class="sixth rightalign">
							<% $assigned_judges_past %>
						</span>

						<span class="fivesixth">
							Assignments before <% $round->realname %>
						</span>

					</div>

%					if ($round_type ne "elim") {

						<h5>
							Current pairing
						</h5>

						<div class="row marno full padless marno">

							<span class="sixth rightalign">
								<% $assigned_judges_current %>
							</span>

							<span class="fivesixth">
								Judges assigned
							</span>

						</div>

						<div class="row marno full padless marno">

							<span class="sixth rightalign">
								<% $needed_judges_current %>
							</span>

							<span class="fivesixth">
								Judges needed this round
							</span>

						</div>

						<div class="row full padless marno">

							<span class="sixth rightalign">
								<% $assigned_to_last %>
							</span>

							<span class="fivesixth">
								In for last rd of commitment
							</span>
						</div>

						<div class="row full padless marno">

							<span class="sixth rightalign">
								<% $unassigned_burned_already %>
							</span>

							<span class="fivesixth">
								Unassigned &amp; burned already
							</span>
						</div>

						<div class="row full padless marno">
							<span class="sixth rightalign">
								<% $unassigned_one_left %>
							</span>
							<span class="fivesixth">
								Unassigned with 1 round left
							</span>
						</div>

						<div class="row full padless marno">
							<span class="sixth rightalign">
								<% $unassigned_one_plus_left %>
							</span>
							<span class="fivesixth">
								Unassigned with &gt;1 round left
							</span>
						</div>

						<h5>
							To Infinity and Beyond!
						</h5>

						<div class="row full padless marno nowrap">

							<span class="twofifth nospace">
								Future Need:
							</span>

							<span class="tenth nospace">
								<% $needed_judges_future %>
							</span>

							<span class="twofifth nospace">
								Assigned:
							</span>

							<span class="tenth nospace">
								<% $assigned_judges_future %>
							</span>

						</div>

						<div class="row full padless marno nowrap">

							<span class="fourfifths">
								Future rounds of committment:
							</span>
							<span class="fifth">
								<% $category_rds_left %>
							</span>

						</div>

						<div class="row full padless marno">
							<span class="fourfifths">
								Individual judges not burned:
							</span>
							<span class="fifth">
								<% $total_in_category-$assigned_to_last-$unassigned_burned_already %>
							</span>
						</div>

%					}
%				}

%				if ($prefs) {

%					my %prefs_data = $m->comp("/funclib/round_pref_data.mas", round => $round);

					<div class="full semibold redtext biggish marno">
						All Debates:
					</div>

					<div class="row full nospace">
						<span class="quarter biggish bluetext semibold">
							Prefer
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Avg
							</div>
							<div class="full nospace">
								<% $prefs_data{"average_pref"} %>
							</div>
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Best
							</div>
							<div class="full nospace">
								<% $prefs_data{"best_pref"} %>
							</div>
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Worst
							</div>
							<div class="full nospace">
								<% $prefs_data{"worst_pref"} %>
							</div>
						</span>

					</div>

					<div class="row full nospace">
						<span class="quarter biggish bluetext semibold">
							Mutual
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Avg
							</div>
							<div class="full nospace">
								<% $prefs_data{"average_mut"} %>
							</div>
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Best
							</div>
							<div class="full nospace">
								<% $prefs_data{"best_mut"} %>
							</div>
						</span>

						<span class="quarter centeralign nospace">
							<div class="full nospace semibold">
								Worst
							</div>
							<div class="full nospace">
								<% $prefs_data{"worst_mut"} %>
							</div>
						</span>
					</div>

<%perl>
					if ( $round_type ne "elim"
						&& $event_settings{"break_point"}
						&& $event_settings{"break_point"} < ($round->name)
					) {
</%perl>

						<div class="full semibold redtext biggish marno">
							Debates &lt; <% $event_settings{"break_point"} %> losses
						</div>

						<div class="row full nospace">
							<span class="quarter biggish bluetext semibold">
								Prefer
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Avg
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_average_pref"} %>
								</div>
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Best
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_best_pref"} %>
								</div>
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Worst
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_worst_pref"} %>
								</div>
							</span>

						</div>

						<div class="row full nospace">
							<span class="quarter biggish bluetext semibold">
								Mutual
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Avg
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_average_mut"} %>
								</div>
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Best
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_best_mut"} %>
								</div>
							</span>

							<span class="quarter centeralign nospace">
								<div class="full nospace semibold">
									Worst
								</div>
								<div class="full nospace">
									<% $prefs_data{"matters_worst_mut"} %>
								</div>
							</span>
						</div>

%					}
%				}

%				if ($rounds_per > 0) {
					<a
						class = "blue half"
						href  = "judge_fits.mhtml?round_id=<% $round->id %>">
						Judge fits
					</a>

					<a
						class = "blue half"
						href  = "judge_use_status.mhtml?round_id=<% $round->id %>&event_id=<% $event %>">
						Judge Use
					</a>
%				}


%				if ($prefs eq "tiered_round") {
					<a
						class = "blue half"
						href  = "pref_diagnostics.mhtml?event_id=<% $event->id %>"
					>
						Pref Diagnostics
					</a>

%				} elsif ($prefs eq "ordinals" || $prefs eq "ndt") {

					<a
						class = "blue half"
						href  = "pref_diagnostics_mjp.mhtml?event_id=<% $event->id %>"
					>
						Pref Diagnostics
					</a>
%				}

%				if ($prefs) {
					<a
						class = "blue half"
						href  = "/panel/report/round_prefs.mhtml?round_id=<% $round->id %>"
					>
						Entry Pref Totals
					</a>
%				}

			</div>

<%perl>
			if (
				$event_type eq "debate"
				&& $round_type ne "elim"
				&& $round_type ne "final"
				&& $round_type ne "runoff"
				&& (not defined $round_robin)
			) {
</%perl>
				<& "pascal.mas", round => $round &>
<%perl>

			}
		}

		my $name = $event->name;
		$name = "House" if $name eq "Congressional Debate: House";
		$name = "Senate" if $name eq "Congressional Debate: Senate";

</%perl>

	</div>

	<div class="main">

		<div class="nospace">

			<span class="half nowrap">
				<h4 class="nospace">
					<% $name %>
				</h4>
			</span>

			<span class="threetenths nowrap">
				<h6 class="nospace semibold bluetext">
					<% $round->realname %>: <% &Tab::nicetime($start) %>
				</h6>

%				if ($prep_offset) {
					<p class="nospace semibold bluetext">
						Draw begins: <% &Tab::nicetime($prep_offset) %>
					</p>
%				}
			</span>

%			unless ($missing_judges) {

				<span class="marno fifth rightalign">

%				if ($event_settings{"online_ballots"}) {
%					foreach my $flight (@flights) {
						<p class="semibold nowrap nospace bigger
							<% $ballots_out{$flight} ? "" : "greentext" %>"
						>
							<% (scalar @flights) > 1
								? " F".$flight.": "
								: ""
							%> <% $ballots_out{$flight}
								? $ballots_out{$flight}." out"
								: "DONE"
							%>
						</p>
%					}
%				} else {

					<h6 class="semibold nowrap nospace
						<% $ballots_out{"all"} ? "" : "greentext" %>"
					>
						<% $ballots_out{"all"}
							? $ballots_out{"all"}." judges out"
							: "DONE"
						%>
					</h6>
%				}
				</span>
%			}

		</div>

		<& "round_tabs.mas",
			default        => $default,
			round          => $round,
			round_settings => \%round_settings,
			event          => $event,
		&>

<%perl>

		my $blast_setting = Tab::RoundSetting->search(
			round => $round->id,
			tag => "scheduled_blast"
		)->first;

		if ($blast_setting && $blast_setting->value_date) {

			my $when = $blast_setting->value_date->set_time_zone($tz);

</%perl>

			<div class="dkred row marbottom">

				<span class="twothirds martop">
					Round will be
						<% $blast_setting->value eq "both" ? "both blasted &amp; published" : "" %>
						<% $blast_setting->value eq "blast" ? "blasted only" : "" %>
						<% $blast_setting->value eq "publish" ? "published only" : "" %>

						at
						<% $blast_setting->value_date
							? Tab::niceshortdayt($when)." ".Tab::tzname($tz)
							: ""
						%>

					<% $blast_setting->value_text
						? '<div class="padno full explain marbottom"> Message: '.$blast_setting->value_text.'</div>'
						: "" %>
				</span>

				<span class="third centeralign">
					<a
						class="buttonwhite orangetext hover invert"
						href="schedule_delete.mhtml?setting_id=<% $blast_setting->id %>"
					>
						Cancel Scheduled Blast
					</a>
				</span>

			</div>
%		}

%		if ($round) {

%			unless ($round->tiebreak_set && $round->tiebreak_set->id) {

				<div class="dkred bigger centeralign padvert">
					<h4>Doom awaits you!</h4>
					<h4 class="padtopmore">No tiebreakers assigned!</h4>
				</div>

%				if ($tourn_settings->{"nsda_district"}) {

					<div class="bigger centeralign">

						<p class="bigger redtext">
							At Districts, tiebreakers are auto-selected.  Please just go
							to the event schedule, remove the round, and save.  Then create
							it again, and you should be good to go.
						</p>

%				} else {

					<div class="bigger centeralign">

						<p class="bigger redtext semibold semibold">
							Tiebreakers are how Tabroom knows which scores
							(win/loss, points, ranks) to ask for.
						</p>

						<p class="bigger redtext semibold">
							Every round must have a tiebreaker set assigned,
							or else ballot entry, and tabbing, and printouts
							all will not work.
						</p>

						<p class="bigger redtext semibold">
							Go to Setup :: Schedule to set tiebreakers for every round.
							Otherwise your ballots, both printed and online, will be
							blank.
						</p>
					</div>
<%perl>
				}
			}
		}

		my $count = scalar @tabs;
		$count += scalar (keys %links);

		unless ($count < 2) {
</%perl>
            <&
                "/funclib/tabs.mas",
                    tabs    => \@tabs,
                    links   => \%links,
                    default => $default,
					center  => "yes",
					buttons => "yes"
            &>
<%perl>

		}

		unless (
			$tourn_settings->{"nsda_district"}
			&& (not defined ($tourn_settings->{"nsda_pilot_".$event_type}))
		) {
</%perl>

%			if ($round_type eq "elim") {

				<div
					id    = "snake"
					class = "snake screens hidden"
				>

%				if ($event_type eq "speech") {

					<& "snake_speech.mas",
						person          => $person,
						person_settings => $person_settings,
						tourn           => $tourn,
						tourn_settings  => $tourn_settings,
						round           => $round,
						event           => $event,
						event_settings  => \%event_settings
					&>

%				} elsif ($event_type eq "congress") {

					<& "snake_congress.mas",
						person          => $person,
						person_settings => $person_settings,
						tourn           => $tourn,
						tourn_settings  => $tourn_settings,
						round           => $round,
						event           => $event,
						event_settings  => \%event_settings
					&>


%				}

				</div>
% 	    	}
%       }


%		if ($preset) {

			<div
				id    = "pre-create"
				class = "pre-create screens hidden"
			>

%			if ($event_type eq "speech" || $event_type eq "congress") {

				<& "preset_edit.mas",
					person            => $person,
					round             => $round,
					tourn             => $tourn,
					tourn_settings    => $tourn_settings,
					event             => $event,
					event_settings    => \%event_settings,
					category          => $category,
					category_settings => \%category_settings
				&>

%			} else {

%				if ($person->site_admin) {

					<h4>Import a CSV round</h4>

					<div class="row">
						<form
							enctype  = "multipart/form-data"
							name     = "panels"
							action   = "upload_debate.mhtml"
							method   = "post"
						>

						<input
							type  = "hidden"
							name  = "round_id"
							value = "<% $round->id %>"
						>

						<span
							class="quarter strong padtopmore padbottommore padleftmore"
						>
							Upload round file:
						</span>

						<span class="twofifth">

							<div class="uploader">

								<input
									type     = "file"
									name     = "panels"
									style    = "opacity: 0;"
									onchange = "uploaderName('panels', 'filename')"
									id       = "panels"
								>

								<span
									id    = "filename"
									class = "filename"
									style = "-webkit-user-select: none;"
								>No file selected</span>

								<span
									class = "action"
									style = "-webkit-user-select: none;"
								>Choose File</span>
							</div>
						</span>

						<span
							class="quarter centeralign"
						>

							<input
								type  = "submit"
								value = "Upload"
								class = "thin"
							>
						</span>

						</form>
					</div>

%				}
%			}
			</div>
%		}

%		if ($round) {

			<div
				class = "reports screens hidden"
				id    = "reports"
			>
				<div class="full nospace">

					<span class="half nospace">
						<h5 class="marno bluetext">Reports and Printouts</h5>
					</span>
					<span class="quarter bluetext semibold rightalign martopmore">
						Change Font Sizes:
					</span>
					<span class="quarter rightalign martopmore">
						<& "/funclib/fonts.mas", default => $person_settings->{"fontsize"} &>
					</span>

					<h6>Schematics/pairings</h6>

					<div class="row">
						<span class="twenty">
							&nbsp;
						</span>

						<div class="nineteen nospace">

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $event->id %>">
								By Room
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/schematic.mhtml?by_judge=yaykansas&round_id=<% $round->id %>&event_id=<% $event->id %>"
							>
								By Judge
							</a>
						</span>

%						if ($event_settings{"show_panel_letters"}) {
							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/schematic.mhtml?by_letter=yaykansas&round_id=<% $round->id %>&event_id=<% $event->id %>"
								>
									By Letter
								</a>
							</span>
%						}

%						if ($event_type eq "congress" || $event_type eq "speech") {
							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $event->id %>&schools=yep">
									w/<% $ncfl ? "Dioceses" : "Schools" %>
								</a>
							</span>
%						} else {
							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/schematic.mhtml?record=sanchez&round_id=<% $round->id %>&event_id=<% $event->id %>"
								>
									With Records
								</a>
							</span>
%						}

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite greentext smallish invert"
								href="round_csv.mhtml?round_id=<% $round->id %>"
							>
								CSV
							</a>
						</span>
						</div>
					</div>

%					if ($event_type eq "congress") {

						<h6 class = "martopmore" >
							Congress Specific Goodies
						</h6>

						<div class="row">

							<span class="twenty">
								&nbsp;
							</span>

							<div class="nineteen nospace">

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/round_report.mhtml?round_id=<% $round->id %>"
								>
									Roster by Chamber
								</a>
							</span>

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/chamber_roster.mhtml?round_id=<% $round->id %>"
								>
									Roster by Entry
								</a>
							</span>

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="seating_chart.mhtml?round_id=<% $round->id %>"
								>
									Seating Charts
								</a>

							</span>

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/placards.mhtml?round_id=<% $round->id %>"
								>
									Placards
								</a>
							</span>

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/chamber_report.mhtml?round_id=<% $round->id %>"
								>
									Chamber Report
								</a>
							</span>
						</div>
						</div>
%					}

					<h6
						class = "martopmore"
						title = "If you must..."
					>
						Paper Ballots
					</h6>

					<div class="row">

						<span class="twenty">
							&nbsp;
						</span>

						<div class="nineteen nospace">

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/master_ballots.mhtml?round_id=<% $round->id %>&sort_by=name"
							>
								Ballots by Name
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/master_ballots.mhtml?round_id=<% $round->id %>&sort_by=room"
							>
								Ballots by Room
							</a>
						</span>

%						if ($event_settings{"online_ballots"}) {
%#							Warren Decker

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/master_ballots.mhtml?timeslot_id=<% $round->timeslot->id %>&event_id=<% $event->id %>&sort_by=name&personless=1"
								>
									Unlinked judges
								</a>
							</span>

%						}

%						if ($event_type eq "congress") {

							<span class="quarter">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/congress_scoresheet.mhtml?round_id=<% $round->id %>"
								>
									Scorer Sheets
								</a>
							</span>

							<span class="<% $event_settings{"online_ballots"} ? "quarter" : "fifth" %>">
								<a
									class="centeralign full padvert buttonwhite bluetext smallish invert"
									href="/panel/report/congress_student_ballots.mhtml?round_id=<% $round->id %>"
								>
									Student Ballots
								</a>
							</span>

%						}
						</div>

					</div>

<%perl>
					if (
						$event_type ne "speech"
						&& $event_type ne "congress"
						&& ( $round_type eq "elim" || $round_type eq "final")
					) {

						my $round_settings = $round->all_settings();

						my $default = $round_settings{'strikes'};
						$default = 0 unless $default;

						my $now = DateTime->now(time_zone => $tz);
						my $strikes_due = $round_settings{'strikes_due'};

						unless ($strikes_due) {
							$strikes_due = $now->clone();
							$strikes_due->add(minutes => 20);
						}

						$strikes_due->set_time_zone($tz);

</%perl>

						<h6 class="martopmore">
							Strike Cards
						</h6>

						<div class="row">

							<span class="third rightalign semibold bluetext">
								Strikes Allowed
								<input
									type         = "number"
									name         = "number"
									min          = "0"
									max          = "99"
									class        = "smaller"
									value        = <% $default %>
									setting_name = "strikes"
									target_type  = "round"
									target_id    = "<% $round->id %>"
									onChange     = "postSwitch( this, 'strike_cards.mhtml');"
								>
							</span>

							<span
								title="When set the system will auto-strike down to this number where necessary.  If unset, the system will strike down to the first odd number if necessary."
								class="third centeralign semibold bluetext"
							>
								Target panel size
								<input
									type         = "number"
									name         = "number"
									min          = "0"
									max          = "99"
									class        = "smaller"
									value        = "<% $round_settings{'strikes_panel_size'} %>"
									setting_name = "strikes_panel_size"
									target_type  = "round"
									target_id    = "<% $round->id %>"
									onChange     = "postSwitch( this, 'strike_cards.mhtml');"
								>
							</span>

							<span class="third centeralign hover semibold bluetext">
								Due <% $now->month."/".$now->day %> @

								<script type="text/javascript">
									 $(document).ready(function() {
										 $('#strikes_due').timepicker({
											 showLeadingZero : false,
											 showPeriod      : true,
											 periodSeparator : ' '
										 });
									 });
								 </script>

								<input
									class        = "notfirst"
									id           = "strikes_due"
									size         = "8"
									type         = "text"
									name         = "strikes_due"
									value        = "<% Tab::pickertime($strikes_due) %>"
									setting_name = "strikes_due"
									target_type  = "round"
									target_id    = "<% $round->id %>"
									onChange     = "postSwitch( this, 'strike_cards.mhtml');"
								>

							</span>

						<div class="full nospace ltbordertop">

							<span class="third rightalign semibold bluetext"
								title="This setting will randomly remove judges if an even number remains after the strikes are processed, or for teams that do not enter strikes by the deadline.  It will also automatically publish and blast the round once all strikes are in or the deadline is reached. Otherwise you will have to do so manually."
							>
								Auto-publish when done
								<label class="switch smaller">
									<input
										type         = "checkbox"
										value        = "1"
										id           = "<% $round->id %>"
										setting_name = "strikes_auto"
										target_type  = "round"
										target_id    = "<% $round->id %>"
										onChange     = "postSwitch( this, 'strike_cards.mhtml');"
										<% $round_settings{"strikes_auto"}
											? 'checked="checked"'
											: ""
										%>
									>
									<div class="slider"></div>
								</label>
							</span>

							<span class="third rightalign semibold bluetext">

								<span class="twothirds leftalign semibold bluetext">
									Publish Cards
									<label class="switch smaller">
										<input
											type         = "checkbox"
											value        = "1"
											id           = "<% $round->id %>"
											setting_name = "strikes_published"
											target_type  = "round"
											target_id    = "<% $round->id %>"
											onChange     = "postSwitch( this, 'strike_cards.mhtml');"
											<% $round_settings{"strikes_published"}
												? 'checked="checked"'
												: ""
											%>
										>
										<div class="slider"></div>
									</label>
								</span>

								<span class="third rightalign semibold bluetext">
									<button
										class   = "buttonwhite bluetext invert thin"
										value        = "1"
										id           = "<% $round->id %>"
										setting_name = "strikes_blast"
										target_type  = "round"
										target_id    = "<% $round->id %>"
										onClick     = "postSwitch( this, 'strike_cards.mhtml');"
									>Blast!</button>
								</span>

							</span>
							<span
								class = "third centeralign semibold bluetext"
								title = "Paper strike cards"
							>
								<form
									action = "/panel/report/strike_cards.mhtml"
									method = "post"
								>

									<input
										type = "hidden"
										name    = "round_id"
										value   = "<% $round->id %>"
									>

									<button
										title   = "Paper?  Booooooooo."
										class   = "buttonwhite bluetext invert padless thin"
										onClick = "this.form.submit();"
									>Print Cards</button>

								</form>
							</span>

						</div>
						</div>
%					}

					<h6 class="martopmore">
						Lists
					</h6>

					<div class="row">

						<span class="twenty">
							&nbsp;
						</span>

						<div class="nineteen nospace">

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/tabbing/report/print_pending.mhtml?round_id=<% $round->id %>&done=1"
							>
								Unentered Ballots
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/schematic.mhtml?list_by_entry=kdebate&round_id=<% $round->id %>"
							>
								Entry List
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/schematic.mhtml?list_by_judge=kdebate&round_id=<% $round->id %>"
							>
								Judge List
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite greentext smallish invert"
								href="roster_csv.mhtml?round_id=<% $round->id %>"
							>
								Entry CSV
							</a>
						</span>

					</div>
					</div>

					<h6 class="martopmore">
						Large Format Section/Round Printouts
					</h6>

					<div class="row">

						<span class="twenty">
							&nbsp;
						</span>

						<div class="nineteen nospace">

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/postings.mhtml?round_id=<% $round->id %>"
							>
								1-Page Poster
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/half_postings.mhtml?round_id=<% $round->id %>"
							>
								Multipage Poster
							</a>
						</span>

						</div>
					</div>

					<h6 class="martopmore">
						Large Format Lists of Clearing Entries
					</h6>

					<div class="row">

						<span class="twenty">
							&nbsp;
						</span>

						<div class="nineteen nospace">

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/list_postings.mhtml?round_id=<% $round->id %>"
							>
								Large List o' Codes
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/giant_postings.mhtml?round_id=<% $round->id %>"
							>
								<% $person->site_admin ? "Bigass" : "Giant" %> List o' Codes
							</a>
						</span>

						<span class="quarter">
							<a
								class="centeralign full padvert buttonwhite bluetext smallish invert"
								href="/panel/report/bigass_posting.mhtml?round_id=<% $round->id %>"
							>
								Giant List o' Names
							</a>
						</span>

					</div>
					</div>
				</div>
			</div>

			<div
				class = "results screens hidden"
				id    = "results"
			>

%	 			if ( $event_type eq "debate" ) {
					<& 'debate_results.mas',
						round          => $round,
						event          => $event,
						tourn          => $tourn,
						event_settings => \%event_settings,
						tourn_settings => $tourn_settings
					&>
%				}

%		 		if ( $event_type eq "speech" ) {
					<& speech_results.mas,
						round          => $round,
						event          => $event,
						tourn          => $tourn,
						event_settings => \%event_settings,
						tourn_settings => $tourn_settings
					&>
%				}

%	 			if ( $event_type eq "congress" ) {
					<& congress_results.mas,
						round          => $round,
						event          => $event,
						tourn          => $tourn,
						event_settings => \%event_settings,
						tourn_settings => $tourn_settings
					&>
%				}

%	 			if ( $event_type eq "wudc" ) {
					<& wudc_results.mas, round => $round &>
%				}

			</div>

			<div
				class = "schematic screens"
				id    = "schematic"
			>

%			if ($gplus_warn) {
				<div class="dkred block centeralign marbottom">
					<h5>Warnings:</h5>
					<div class="block"><% $gplus_warn %></div>
				</div>
%			}

%	 			if ( $event_type eq "speech" ) {

					<& show_speech.mas,
						entry_only        => $entry_only,
						round             => $round,
						round_settings    => \%round_settings,
						tourn             => $tourn,
						tourn_settings    => $tourn_settings,
						event             => $event,
						event_settings    => \%event_settings,
						category          => $category,
						category_settings => \%category_settings,
						show              => $show,
						admin             => $person->site_admin,
						entered           => $entered,
						person            => $person
					&>

%				} elsif ( $event_type eq "congress" ) {

					<&
						"show_congress.mas",
						entry_only        => $entry_only,
						round             => $round,
						round_settings    => \%round_settings,
						tourn             => $tourn,
						tourn_settings    => $tourn_settings,
						event             => $event,
						event_settings    => \%event_settings,
						category          => $category,
						category_settings => \%category_settings,
						show              => $show,
						person            => $person,
						tourn_settings    => $tourn_settings
					&>

%				} elsif ( $event_type eq "wudc" ) {

					<&
						"show_wudc.mas",
						entry_only => $entry_only,
						round      => $round,
						show       => $show,
						person     => $person
					&>

%				} elsif ( $event_type eq "debate" ) {

%					my $nowarn++ if $tourn_settings->{"nsda_district"};

					<&
						"show_debate.mas",
							round             => $round,
							round_settings    => \%round_settings,
							tourn             => $tourn,
							tourn_settings    => $tourn_settings,
							event             => $event,
							event_settings    => \%event_settings,
							category          => $category,
							category_settings => \%category_settings,
							entered           => $entered,
							person            => $person,
							nowarn            => $nowarn
						&>

%				} else {

					<p class='warning'>
						You have not chosen an event type.
					</p>

					<p>
						Tabroom does not know how to show you this
						pairing/schematic because that depends on what type of
						event it is (debate, speech, etc).
					</p>

					<p>
						You have confused Tabroom.  Tabroom is lost, and scared.
						Please help it out.  Or it'll totally screw up your
						tournament and not even mean to.
					</p>

					<p>
						You can change the event type from the
							<a
								href="/setup/events/edit.mhtml?event_id=<% $event->id %>"
							>Event Settings</a>
					</p>
%				}
			</div>
%		}

		<div
			id    = "settings"
			class = "settings screens hidden"
		>
			<& "settings_edit.mas",
				person          => $person,
				person_settings => $person_settings,
				tourn           => $tourn,
				tourn_settings  => $tourn_settings,
				round           => $round,
				event           => $event,
				event_settings  => \%event_settings
			&>
		</div>

	</div>

