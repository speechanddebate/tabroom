<%args>
	$tourn
	$tourn_settings
	$person
	$panel_id
	$judge_id => undef
	$from     => undef
	$perms    => undef
</%args>
<%init>

	my %events = $m->comp('/funclib/perms/events.mas',
		perms   => $perms,
		tourn   => $tourn,
		limited => 1
	);

	my %categories = $m->comp('/funclib/perms/categories.mas',
		perms   => $perms,
		limited => 1,
		tourn   => $tourn
	);

	my $panel = Tab::Panel->retrieve($panel_id);
	my $dbh = Tab::DBI->db_Main();

	$m->redirect("/setup/tourn/main.mhtml?err=Could%20not%20retrieve%20requested%20panel.") unless $panel;

	# I do this because it makes it easy to pass all the options to the judge
	# menu formatter.  I am not proud of it.

	my %settings;
	$settings{"nsda_nats"}               = $tourn_settings->{"nsda_nats"};
	$settings{"ncfl"}                    = $tourn_settings->{"ncfl"};
	$settings{"region"}                  = $tourn_settings->{"regions"};
	$settings{"no_school_judges"}        = $tourn_settings->{"no_school_judges"};
	$settings{"mock_trial_registration"} = $tourn_settings->{"mock_trial_registration"};

	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	my $checker++ if ${$perms}{"checker"};

	unless ($panel) {
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $round      = $panel->round;
	my $timeslot   = $round->timeslot;
	my $event      = $round->event;
	my $event_type = $event->type;
	my $start      = $timeslot->start;

	unless ($events{$event->id} || $categories{$event->category}) {
		$m->comp("/funclib/abort.mas", message => "You do not have access to view that panel.");
	}

	if ($round->start_time) {
		$start = $round->start_time();
	}

	unless ($start) {
		$m->comp("/funclib/abort.mas",
			message => "This round apparently has neither a round start time or a timeslot start time.  Please correct to continue"
		);
	}

	$start->set_time_zone("UTC");
	$start->set_time_zone($tz);
	my %event_settings = $event->all_settings();

	if ($round->setting("use_normal_rooms")) {
		$event_settings{'online_mode'} = "sync";
	}

	$settings{"online_hybrid"} = $event_settings{"online_hybrid"};
	$settings{"online_mode"} = $event_settings{"online_mode"};
	$settings{"flighted"} = $round->flighted;

	my $judge_sth = $dbh->prepare("
		select
			judge.id, judge.first, judge.middle, judge.last, judge.code,
			school.code school_code, school.name school_name,
			ballot.audit, ballot.chair,
			person.id person, person.email email,
			school.id school, school.code school_code, school.name school_name,
			district.id district, district.code district_code, district.name district_name,
			region.id region, region.code region_code, region.name region_name,
			CONVERT_TZ(ballot.timestamp, '+00:00', tourn.tz) timestamp,
			audited_by.id audited_id, CONCAT(audited_by.first,' ',audited_by.last) audited_name,
			started_by.id started_id, CONCAT(started_by.first,' ',started_by.last) started_name,
			started_by.first start_first, started_by.last start_last,
			CONVERT_TZ(ballot.judge_started, '+00:00', tourn.tz) start_time,
			score.id score,
			room_reserved.value room_reserved,
			online_hybrid.value online_hybrid,
			tab_rating.value tab_rating,
			diverse.value diverse

		from (judge, ballot, category, tourn)

			left join person on person.id = judge.person
			left join school on school.id = judge.school

			left join region on school.region = region.id
			left join district on school.district = district.id

			left join person audited_by on audited_by.id = ballot.audited_by
			left join person started_by on started_by.id = ballot.started_by
			left join score on score.ballot = ballot.id and score.tag in
				('comments', 'point', 'rank', 'refute', 'rfd', 'speech', 'categories', 'winloss')

			left join judge_setting room_reserved on room_reserved.tag = 'room_reserved' and room_reserved.judge = judge.id
			left join judge_setting online_hybrid on online_hybrid.tag = 'online_hybrid' and online_hybrid.judge = judge.id
			left join judge_setting tab_rating on tab_rating.tag = 'tab_rating' and tab_rating.judge = judge.id
			left join judge_setting diverse on diverse.tag = 'diverse' and diverse.judge = judge.id

		where judge.id = ballot.judge
			and ballot.panel =  ?
			and judge.category = category.id
			and category.tourn = tourn.id

		group by judge.id
	");

	$judge_sth->execute($panel->id);
	my $judges = $judge_sth->fetchall_hash();
	$judge_sth->finish();

	my %judge_sites = ();
	my @reserved_rooms;
	my $scores;

	my $blind_mode++ if $event_settings{"blind_mode"} && $round->published < 1;
	$settings{"blind_mode"} = $blind_mode;
	$settings{"online_ballots"}++ if $event_settings{"online_ballots"};

	my %anonymize = $m->comp(
		"/funclib/blind_mode.mas",
		round => $round
	) if $blind_mode;

    my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);

	$settings{"region"}++ if $event_settings{"region_avoid"};
	$settings{"region"}++ if $event_settings{"region_constrain"};

	my $category = $event->category;
	my %category_settings = $category->all_settings();

	if ($event_settings{"conflict_dioregion_judges"}) {
		$settings{"dio_regions"}++;
		$settings{"dio_region"} = $event_settings{"diocese_regions"};
	}

	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	$start->add(minutes => $event_settings{"flight_offset"} * ($panel->flight - 1));

	my $all++ if $tourn_settings->{"nsda_nats"} && $event_settings{"supp"};

	my %entry_wins;
	my %entry_losses;

	my %tb_types = $m->comp("/funclib/tiebreak_types.mas", round => $round);

	if ($tb_types{"winloss"}) {

		my $last_round = Tab::Round->search(
			event => $event->id,
			name  => ($round->name - 1)
		)->first;

		%entry_wins = $m->comp(
			"/funclib/entry_wins.mas",
				event    => $event,
				round    => $last_round,
				all      => $all,
				first_tb => $event_settings{"bracket_by_ballots"}
			);

		unless ($event_settings{"bracket_by_ballots"}) {
			%entry_losses = $m->comp(
				"/funclib/entry_losses.mas",
					event    => $event,
					round    => $last_round,
					all      => $all,
					first_tb => $event_settings{"bracket_by_ballots"}
			);
		}
	}

	my %flips;

	my $entries_sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name, entry.dropped,
			dq.value dq,
			online_hybrid.value,
			student.last,
			ballot.id, ballot.side, ballot.speakerorder,
			panel_hybrid.value,
			share.value,
			flip.value_text,
			flip_at.value_date,
			flip_status.value,
			flip_winner.value,

			team_order.value,
			school.id, school.code, school.name, school.state,
			region.id, region.code, region.name,
			district.id, district.code, district.name,
			po.value,
			strike.person, strike.description, strike.timestamp,
			autostrike.description, autostrike.timestamp,
			count(follower.id), count(distinct student.person),
			video_link.value_text

		from (entry, ballot, panel)
			left join school on school.id = entry.school
			left join region on school.region = region.id
			left join district on school.district = district.id
			left join score po on po.ballot = ballot.id and po.tag = 'po'
			left join entry_student es on es.entry = entry.id
			left join student on es.student = student.id
			left join follower on follower.entry = entry.id

			left join change_log strike
				on strike.panel = panel.id
				and strike.entry = entry.id
				and strike.tag   = 'strikecard'

			left join change_log autostrike
				on autostrike.panel = panel.id
				and autostrike.tag  = 'autostrike'

			left join event_setting team_order
				on team_order.event = entry.event
				and team_order.tag = 'flip_team_order'

			left join entry_setting dq
				on dq.entry = entry.id
				and dq.tag = 'dq'

			left join entry_setting online_hybrid
				on online_hybrid.entry = entry.id
				and online_hybrid.tag = 'online_hybrid'

			left join entry_setting video_link
				on video_link.entry = entry.id
				and video_link.tag = 'video_link'

			left join panel_setting panel_hybrid
				on panel_hybrid.panel = panel.id
				and panel_hybrid.tag = 'online_hybrid'

			left join panel_setting share
				on share.panel = panel.id
				and share.tag = 'share'

			left join panel_setting flip
				on flip.panel = panel.id
				and flip.tag = 'flip'

			left join panel_setting flip_winner
				on flip_winner.panel = panel.id
				and flip_winner.tag = 'flip_winner'

			left join panel_setting flip_at
				on flip_at.panel = panel.id
				and flip_at.tag = 'flip_at'

			left join panel_setting flip_status
				on flip_status.panel = panel.id
				and flip_status.tag = 'flip_status'

		where 1=1
			and panel.id = ?
			and ballot.panel = panel.id
			and entry.id = ballot.entry
		group by ballot.entry, ballot.judge
		order by ballot.side, ballot.speakerorder, entry.code
	");

	$entries_sth->execute($panel->id);

	my %entries;
	my %schools;
	my $panel_online;

	my $aff;
	my $neg;

	while (
		my (
			$entry_id, $entry_code, $entry_name, $entry_dropped, $entry_dq,
			$online_hybrid,
			$student_last,
			$ballot_id, $ballot_side, $ballot_speakerorder,
			$panel_hybrid,
			$share_room,
			$flip, $flip_at, $flip_status, $flip_winner,
			$team_order,
			$school_id, $school_code, $school_name, $school_state,
			$region_id, $region_code, $region_name,
			$district_id, $district_code, $district_name,
			$po_value,
			$strike_person, $strike_description, $strike_timestamp,
			$autostrike_description, $autostrike_timestamp,
			$follower_count, $person_count,
			$video_link
		) = $entries_sth->fetchrow_array()
	) {

		$entries{$entry_id}{"followers"}     = int($follower_count + $person_count + 0);
		$entries{$entry_id}{"dropped"}       = $entry_dropped;
		$entries{$entry_id}{"dq"}            = $entry_dq;
		$entries{$entry_id}{"code"}          = $entry_code;
		$entries{$entry_id}{"name"}          = $entry_name;
		$entries{$entry_id}{"school_code"}   = $school_code;
		$entries{$entry_id}{"school_name"}   = $school_name;
		$entries{$entry_id}{"school_state"}  = $school_state;
		$entries{$entry_id}{"video_link"}    = $video_link;
		$entries{$entry_id}{"online_hybrid"} = $online_hybrid;

		$panel_online = $panel_hybrid;

		if ($ballot_side == 1) {
			$aff = $entry_id;
			$settings{"aff"} = $entry_id;
		} elsif ($ballot_side == 2) {
			$neg = $entry_id;
			$settings{"neg"} = $entry_id;
		}

		if ($strike_person) {
			$entries{$entry_id}{"strike_by"}   = $strike_person;
			$entries{$entry_id}{"strike_desc"} = $strike_description;
			$entries{$entry_id}{"strike_at"}   = $strike_timestamp;
		} elsif ($autostrike_description) {
			$entries{$entry_id}{"strike_auto"}  = 1;
			$entries{$entry_id}{"strike_desc"} = $autostrike_description;
			$entries{$entry_id}{"strike_at"}   = $autostrike_timestamp;
		}

		if ($share_room) {
			$settings{"share"} = $share_room;
		}

		if ($flip) {
			unless (%flips) {
				%flips = eval {
					return %{JSON::decode_json($flip)};
				};
			}
		}

		$flips{"deadline"} = eval {
			my $dt = DateTime::Format::MySQL->parse_datetime($flip_at);
			$dt->set_time_zone("UTC");
			$dt->set_time_zone($tz);
		};

		$flips{"team_order"} = $team_order;

		if ($flip_winner == $entry_id) {
			$flips{"won"} = $entry_id;
			$flips{"winner"} = $entry_code;
		}

		$flips{"status"} = $flip_status;

		$entries{$entry_id}{"region_code"}   = $region_code;
		$entries{$entry_id}{"region_name"}   = $region_name;
		$entries{$entry_id}{"district_code"} = $district_code;
		$entries{$entry_id}{"district_name"} = $district_name;

		if ($event_type eq "speech") {
			$entries{$entry_id}{"speaks"} = $ballot_speakerorder;
		} elsif ($event_type eq "congress") {
			$entries{$entry_id}{"po"}     = $po_value;
			$entries{$entry_id}{"last"}   = $student_last;
			if ($event_settings{"sort_precedence"}) {
				$entries{$entry_id}{"speaks"} = $ballot_speakerorder;
			}
		} else {
			$entries{$entry_id}{"order"}  = $ballot_speakerorder;
			$entries{$entry_id}{"side"}   = $ballot_side;
			$entries{$entry_id}{"speaks"} = 0;
			$entries{$entry_id}{"po"}     = 0;
		}
	}

	$settings{"tab_ratings"}++ if $category_settings{"tab_ratings"};
	$settings{"prefs"} = $category_settings{"prefs"};

	if ($settings{"prefs"} eq "ndt") {
		$settings{"prefs"} = "ordinals";
		$settings{"prefs"} = "tiered" if $round->type eq "elim";
		$settings{"prefs"} = "tiered" if $round->type eq "final";
		$settings{"prefs"} = "tiered" if $round->type eq "runoff";
		$settings{"prefs"} = "ordinals" if $round->name == 9;
	}

	undef $settings{"prefs"} if $settings{"prefs"} eq "none";

	if ($settings{"prefs"}) {
		%{$settings{"averages"}} = $m->comp("/funclib/judge_averages.mas", category => $category, prefs => $settings{"prefs"});
	}

	$settings{"no_judge_codes"}++ if $category_settings{"no_codes"};
	$settings{"no_school_codes"}++ if $tourn_settings->{"school_codes"} eq "none";
	$settings{"diversity"}++ if $category_settings{"track_diversity"};

	my %rating_by_judge = ();

	$settings{"coach_ratings"} = $category_settings{"coach_ratings"};

	if ($category_settings{"coach_ratings"} ) {

		my $rating_sth = $dbh->prepare("

			select judge.id, rating_tier.name, subrt.name

			from (judge, round, event, rating_tier, rating)

				left join rating_subset on rating_subset.id = event.rating_subset
				left join rating subrating on subrating.rating_subset = rating_subset.id
					and subrating.judge = judge.id
					and subrating.type = 'coach'

				left join rating_tier subrt on subrt.id = subrating.rating_tier

			where round.id = ?
				and round.event = event.id
				and judge.id = rating.judge
				and rating.rating_tier = rating_tier.id
				and rating.type = 'coach'

				and (
					judge.category = event.category
					or judge.alt_category = event.category
				)
		");

		$rating_sth->execute($round->id);

		while (
			my ($judge_id, $rating_tier, $better_rating_tier) = $rating_sth->fetchrow_array()
		) {
			$rating_by_judge{$judge_id} = $rating_tier;
			$rating_by_judge{$judge_id} = $better_rating_tier if $better_rating_tier;
		}
	}

	$settings{"rating_by_judge_ref"} = \%rating_by_judge;
	$settings{"rounds_per"} = $category_settings{"rounds_per"};

	my $round_type = $round->type;

	undef $settings{"rounds_per"}
		if $round_type eq "elim"
		|| $round_type eq "final"
		|| $round_type eq "runoff";

	my $section = "Debate";
	$section = "Section" if $event_type eq "speech";
	$section = "Chamber" if $event_type eq "congress";

	my $room = $panel->room if $panel->room;
	my $panel_room = $room->id if $room;

	my $judge_use_ref = $m->comp(
		"/funclib/judge_use.mas",
			round      => $round,
			event      => $event
		);

	$settings{"judge_use_ref"} = $judge_use_ref;

	my %judge_use = %{$judge_use_ref};

	$round_type = "flip" if $event_settings{"no_side_constraints"};

	my $judge_indicator;

	# Judges who are not judging this round

	my %clean_judges = $m->comp(
		"/funclib/clean_judges.mas",
			panel           => $panel,
			round           => $round,
			event           => $event,
			include_standby => 1
	);

	my @good_judges = List::Util::shuffle(keys %clean_judges);
	@good_judges = sort {$clean_judges{$b}{"strikes"} <=> $clean_judges{$a}{"strikes"}} @good_judges;
	@good_judges = sort {$clean_judges{$b}{"ballots"} <=> $clean_judges{$a}{"ballots"}} @good_judges;

	if ($settings{"rounds_per"}) {
		@good_judges = sort {$judge_use{$b}{"percentage"} <=> $judge_use{$a}{"percentage"}} @good_judges;
	} else {
		@good_judges = sort {$judge_use{$a}{"everything"} <=> $judge_use{$b}{"everything"}} @good_judges;
	}

	if ($settings{"coach_ratings"}) {
		@good_judges =
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} }
			@good_judges;

		@good_judges =
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})}
			@good_judges;
	}

	if ($settings{"tab_ratings"}) {
		@good_judges =
			sort { $clean_judges{$a}{"tab_ratings"} <=> $clean_judges{$b}{"tab_ratings"} }
			@good_judges;
	}

	# These are judges who are already judging in this round but could be
	# stolen to judge this one. Useful for preffed divisions

	my %busy_judges = $m->comp(
		"/funclib/clean_judges.mas",
			panel     => $panel,
			round     => $round,
			event     => $event,
			stealable => "daveroberts"
	);

	my @busy_judges = keys %busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"strikes"} <=> $busy_judges{$a}{"strikes"}} @busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"ballots"} <=> $busy_judges{$a}{"ballots"}} @busy_judges;

	if ($settings{"coach_ratings"}) {
		@busy_judges =
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} }
			@busy_judges;

		@busy_judges =
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})}
			@busy_judges;
	}

	if ($settings{"tab_ratings"}) {
		@busy_judges =
			sort { $busy_judges{$a}{"tab_ratings"} <=> $busy_judges{$b}{"tab_ratings"} }
			@busy_judges;
	}

	my $ratings;
	my $diffref;
	my %others = ();

	unless ($event_settings{"online_mode"} eq "async") {
		%others = $m->comp(
			"/funclib/round_judge_panels.mas",
				round  => $round,
				event  => $event,
				flight => $panel->flight
		);
	}

	$settings{"others_ref"} = \%others;

	if ($settings{"prefs"}) {

		my $mutuality = $category_settings{"mutuality"};
		my $preference = $category_settings{"preference"};
		$mutuality = 40 unless $mutuality;
		$preference = 20 unless $preference;

		($ratings, $diffref) = $m->comp(
			"/funclib/panel_ratings.mas",
			panel    => $panel,
			type     => $settings{"prefs"}
		);

		$settings{'ratings'} = $ratings;

		my %sort_score;

		foreach my $gj (@good_judges) {
			${$diffref}{$gj} = 110 unless defined ${$diffref}{$gj};
			$sort_score{$gj} = ($diffref->{$gj} * $mutuality)
				+ (
					($ratings->{$aff}{$gj} + + $ratings->{$neg}{$gj}) * $preference
				);
		}

		foreach my $bj (@busy_judges) {
			${$diffref}{$bj} = 110 unless defined ${$diffref}{$bj};

			$sort_score{$bj} = ($diffref->{$bj} * $mutuality)
				+ ( ($ratings->{$aff}{$bj} + + $ratings->{$neg}{$bj}) * $preference);
		}

		if ($event_settings{"max_pref"}) {

			foreach my $judge (@good_judges, @busy_judges) {

				if ($ratings->{$aff}{$judge} > $event_settings{"max_pref"}) {
					$sort_score{$judge} += 50000000;

					if ($clean_judges{$judge}) {
						$clean_judges{$judge}{"gong"}++;
					}
					if ($busy_judges{$judge}) {
						$busy_judges{$judge}{"gong"}++;
					}
				}

				if ($ratings->{$neg}{$judge} > $event_settings{"max_pref"}) {
					$sort_score{$judge} += 50000000;

					if ($clean_judges{$judge}) {
						$clean_judges{$judge}{"gong"}++;
					}
					if ($busy_judges{$judge}) {
						$busy_judges{$judge}{"gong"}++;
					}
				}
			}
		}

		@good_judges =
			sort {$sort_score{$a} <=> $sort_score{$b}}
			@good_judges;

		@busy_judges =
			sort {$sort_score{$a} <=> $sort_score{$b}}
			@busy_judges;
	}

	@good_judges =
		sort {$clean_judges{$b}{"standby"} <=> $clean_judges{$a}{"standby"}}
		@good_judges;

	my %burned;

	if ($settings{"rounds_per"}
		&& $round_type ne "elim"
		&& $round_type ne "final"
		&& $round_type ne "runoff"
	) {

		foreach my $gj (@good_judges) {
			$burned{$gj}++ if $judge_use{$gj}{'left'} < 1;
		}

		@good_judges = sort {$burned{$a} <=> $burned{$b}} @good_judges;
	}

	my $due_aff;

	if ($event_type eq "debate" && $round_type ne "flip") {
		$due_aff = $m->comp("/funclib/round_elim_dueaff.mas", panel => $panel);
	}

	my %judge_strings;
	my %judge_headers;

	my $active;

	my %region_override;

	if ($tourn_settings->{"mock_trial_registration"}) {
		my $region_sth = $dbh->prepare("
			select
				judge.id, region.code
			from judge, strike, region
			where judge.category = ?
				and judge.id = strike.judge
				and strike.region = region.id
		");

		$region_sth->execute($category->id);

		my $region_refs = $region_sth->fetchall_hash();

		foreach my $ref (@{$region_refs}) {
			$region_override{$ref->{id}} .= " ".$ref->{"code"};
		}
	}

	my %good_fields = $m->comp(
		"/funclib/judge_swaplabels.mas",
			judges          => \%clean_judges,
			settings_ref    => \%settings,
			worlds          => $event_settings{"usa_wsdc"},
			category        => $category,
			anonymize       => \%anonymize,
			region_override => \%region_override
	);

	my %busy_fields = $m->comp(
		"/funclib/judge_swaplabels.mas",
			judges          => \%busy_judges,
			settings_ref    => \%settings,
			busy            => 1,
			category        => $category,
			anonymize       => \%anonymize,
			region_override => \%region_override
	);

	my ($code_school, $code_name) = $m->comp("/funclib/code_style.mas", event => $event);

	my $show_async = $panel->setting("show_async");

</%init>

	<script>

		function prefTotal() {

			let affTotal = 0;
			let negTotal = 0;

			$(".aff_pref").each( (block, tackle) => {
				const pref = parseFloat($(tackle).text());
				if (typeof pref === 'number') {
					affTotal += pref;
				}
			});

			$(".neg_pref").each( (block, tackle) => {
				const pref = parseFloat($(tackle).text());
				if (typeof pref === 'number') {
					negTotal += pref;
				}
			});

			$("#neg_total").addClass('yellowhover');
			$("#neg_total").text(negTotal.toFixed(1));
			$("#aff_total").text(affTotal.toFixed(1));
			$("#pref_diff").text(Math.abs(negTotal - affTotal).toFixed(1));
		}

		function chaChing() {
			var audio = new Audio('/lib/images/register.mp3');
			audio.loop = false;
			audio.play();
		}

		function showJudges() {
			var checkObjectId = "<% $panel->id %>_bye";
			if ($("#"+checkObjectId).prop("checked") ) {
				$(".judgebar").addClass('hidden');
				$(".coachover").removeClass('hidden');
			} else {
				$(".judgebar").removeClass('hidden');
				$(".coachover").addClass('hidden');
			}
		};

		$(document).ready(function(){
			showJudges();
			prefTotal();
			$('#flip_at_time').timepicker({
				showLeadingZero : false,
				showPeriod      : true,
				periodSeparator : ' '
			});
		});

	</script>

	<div class="main">

		<div class="full padvertless flexrow">
			<span class="third">
				<h4 class="nospace smallish">
					<% $round->realname %>
				</h4>
			</span>

			<span class="third centeralign bigger semibold nospace">
				<& "/funclib/showtime.mas",
					dt     => $start,
					format => "murica",
					day    => "yes"
				&>
			</span>

			<span class="third flexrow rightalign padright">
				<span class="threequarters rightalign nowrap grow">
					<h5 class="nospace">
						<% $section %>
						<% $panel->letter %> of <% $event->abbr %>
					</h5>
				</span>
%				if ($event_settings{"online_mode"} && ( (not defined $event_settings{"online_hybrid"}) || $panel_online)) {
					<span class="quarter centeralign top">
						<& "/funclib/online_room.mas",
							panel   => $panel,
							person  => $person,
							show    => 1,
							no_name => 1,
							class   => "fa-sm"
						&>
					</span>
%				}
			</span>
		</div>

		<div class="coachover full nospace odd padtopmore padbottommore hidden">
<%perl>

			if (
				$round->type eq "elim"
				|| $round->type eq "final"
				|| $round->type eq "runoff"
			) {

				my $winner_sth = $dbh->prepare("
					select entry.code
					from entry, ballot, score
					where ballot.panel = ?
						and ballot.id = score.ballot
						and score.tag = 'winloss'
						and score.value = 1
						and ballot.entry = entry.id
				");

				$winner_sth->execute($panel->id);
				my $winner;

				while (
					my ($winner_code) = $winner_sth->fetchrow_array()
				) {
					$winner = $winner_code;
				}

</%perl>
				<h5 class="centeralign redtext">
					This debate is an elimination walkover
				</h5>

				<p class="centeralign">
					To hold the debate, uncheck the "Walk Over" indicator at right.
				</p>

				<div class="full padtopmore padbottommore centeralign bluetext semibold">
%					if ($winner) {
						<% $winner %> is marked as advancing
%					}
				</div>

				<div class="full padmore centeralign">
					<a
						href="/tabbing/entry/closeout.mhtml?panel_id=<% $panel->id %>&from=panel"
						class="buttonwhite bluetext"
					>
						Enter Walkover Result
					</a>
				</div>

%			} else {

				<h5 class="centeralign redtext">This debate is an assigned bye</h5>

				<p class="centeralign semibold">
					All debaters in this section will earn a win and averaged points
				</p>

				<p class="centeralign semibold bluetext">
					To hold an actual debate, uncheck the "Walk Over" indicator at right
				</p>

%			}

		</div>

		<div class="judgebar full nospace">

			<h6 class="semibold">Judges</h6>

			<& "/funclib/tablesorter.mas", table => 'panel_judges', nobuttons => 1 &>

			<div class="sidescroll">

			<table id="panel_judges">

%				if (@{$judges}) {

					<thead>
						<tr>
							<th class="<% $event_type eq "mock_trial" ? "" : "smallhide" %>">
%								if ($event_settings{"chair_label"}) {
									<% $event_settings{"chair_label"} %>
%								} elsif ($event_type eq "congress") {
									Parli
%								} else {
									Chair
%								}
							</th>

							<th>
%								if ($event_settings{"chair_label"} eq "Judge") {
									Critic
%								} else {
									Judge
%								}
							</th>

%							if ($event_settings{"online_hybrid"}) {
								<th>
									Online
								</th>
%							}

%							if ($settings{"rounds_per"}) {
								<th>
									Use
								</th>
%							}

%							if ($settings{"diversity"}) {
								<th title="Diverse" class="smallhide">
									Div.
								</th>
%							}

%							if ($settings{"coach_ratings"} || $settings{"tab_ratings"}) {
								<th title="Rating" class="single">
									<span class="smallhide">
										Rating
									</span>
									<span class="smallshow">
										Rt
									</span>
								</th>
%							}

%							if ($settings{"prefs"}) {
								<th>
									Prefs
								</th>
								<th>
									Avg
								</th>
%							}

%							unless ($tourn_settings->{"no_school_judges"} || $event_type eq "mock_trial") {
								<th>
									School
								</th>
%							}

<%perl>
							if (
								$tourn_settings->{"mock_trial_registration"}
								&& $tourn_settings->{regions}
							) {
</%perl>
								<th>
									Region
								</th>

%							} elsif ($tourn_settings->{"nsda_nats"}) {

								<th>
									State
								</th>

								<th>
									District
								</th>

%							} elsif ($tourn_settings->{"ncfl"}) {

								<th>
									Dio
								</th>

%								if ($settings{"dio_regions"}) {
									<th>
										Reg
									</th>
%								}

%							} elsif ($tourn_settings->{"regions"}) {
								<th>
									Region
								</th>
%							}

							<th class="nosort nospace">
								<div class="full flexrow nospace">
									<span class="smallhide half centeralign grow">
										Remove
									</span>
									<span class="smallshow half centeralign grow">
										Rm
									</span>
%									unless ($tourn_settings->{"no_school_judges"} || $tourn_settings->{"mock_trial_registration"}) {
										<span class="half centeralign ltborderleft nospace">
											&amp; Fine
										</span>
%									}
								</div>
							</th>

							<th>
								Start
							</th>

							<th>
								Voted
							</th>

%							if ($event_type eq "mock_trial") {
								<th class="nosort centeralign">
									<div class="nospace smallhide">
										Delete Scores
									</div>
									<div class="nospace smallshow">
										Wipe
									</div>
								</th>
%							}

%							if ($person->site_admin) {
								<th class="nosort smallhide">
									Ballot
								</th>
%							}
						</tr>
					</thead>
					<tbody>
<%perl>
						foreach my $judge_ref (
							sort {
								$b->{"chair"} <=> $a->{"chair"}
								|| $a->{"last"} cmp $b->{"last"}
							}  @{$judges}
						) {

							my $url_args = "judge_id=".$judge_ref->{"id"}."&panel_id=".$panel->id;

							if ($judge_ref->{"room_reserved"}) {
								push @reserved_rooms, Tab::Room->retrieve($judge_ref->{"room_reserved"});
							}
</%perl>
							<tr id="<% $judge_ref->{"id"} %>" 
								class="<%
								($event_type eq "mock_trial" &&
								($judge_ref->{'audit'} && (not defined $judge_ref->{'score'})))
								? "strike"
								: ""
							%>">
								<td class="smaller centeralign padless <% $event_type eq "mock_trial" ? "" : "smallhide" %>">
									<a
										id    = "chair_<% $judge_ref->{"id"} %>"
										class = "chairs buttonwhite hover semibold smallish marno padless
											<% $judge_ref->{"chair"}
												? "greentext invert fa fa-lg fa-gavel"
												: "redtext fa fa-lg fa-circle-o padleft"
											%>"
										href="chair_switch.mhtml?<% $url_args %>"
									></a>
								</td>

								<td class="smallish nospace padleftless">
									<div class="full flexrow nospace">
%									if ($blind_mode) {
										<% $anonymize{"judge"}{$judge_ref->{"id"}} %>

%									} else {
%										unless ($checker) {
											<a
												class="white flexrow half grow"
												href="/register/judge/edit.mhtml?judge_id=<% $judge_ref->{"id"} %>"
											>
%										}
%											if ($settings{"no_judge_codes"}) {
												<% $judge_ref->{first}." ".$judge_ref->{last} %>
%											} else {
												<span class="quarter">
													<% $judge_ref->{"code"} %>
												</span>
												<span class="threequarters">
													<% $judge_ref->{first}." ".$judge_ref->{last}%>
												</span>
%											}
										</a>

%										if ($settings{"online_ballots"} && (not defined $judge_ref->{person})) {
											<span
												title = "LUDDITE!  Judge is not linked to a Tabroom account and cannot use online ballots"
												class = "redtext italic semibold smallish third nospace"
											>Not linked!</span>
%										}
%									}
									</div>
								</td>

%								if ($event_settings{"online_hybrid"}) {
									<td class="smallish centeralign">
%										if ($judge_ref->{"online_hybrid"} ) {
											<span class="greentext fa fa-lg fa-laptop"></span>
%										}
									</td>
%								}

%								if ($settings{"rounds_per"}) {
									<td class="smallish centeralign nospace">
										<span class="padrightmore">
											<% $judge_use{$judge_ref->{"id"}}{'percentage'} %>%
										</span>
										<span>
											<%
												$judge_use{$judge_ref->{"id"}}{'left'}
											%>/<%
												($judge_use{$judge_ref->{"id"}}{'judged_already'}
													+ $judge_use{$judge_ref->{"id"}}{'will_judge'}
												)
											%>/<%
												$judge_use{$judge_ref->{"id"}}{'oblig'}
											%>
										</span>
									</td>
%								}

%								if ($settings{"diversity"}) {
									<td class="smallish centeralign smallhide">
										<% $judge_ref->{"diverse"} ? "Y" : "N" %>
									</td>
%								}

%								if ($settings{"coach_ratings"} || $settings{"tab_ratings"}) {
									<td class="smallish centeralign nospace">
										<div class="full flexrow">
%										if ($settings{"coach_ratings"}) {
											<span class="half grow">
												<% $rating_by_judge{$judge_ref->{"id"}} %>
											</span>
%										}
%										if ($settings{"tab_ratings"}) {
											<span class="half grow">
												<% $judge_ref->{"tab_rating"} %>
											</span>
%										}
										</div>
									</td>
%								}

%								if ($settings{"prefs"}) {
									<td class="smallish centeralign">
										<div class="full nospace flexrow">
										<span
											class = "half nospace rightalign aff_pref
											<% $event_settings{"max_pref"} && $ratings->{$aff}{$judge_ref->{"id"}} > $event_settings{"max_pref"}
												? "semibold redtext"
												: ""
											%>
										">
											<% $ratings->{$aff}{$judge_ref->{"id"}} || "&ndash;" %>
%											$ratings->{$aff}{"total"} += $ratings->{$aff}{$judge_ref->{"id"}};
										</span>

										<span
											class = "half nospace rightalign neg_pref
											<% $event_settings{"max_pref"} && $ratings->{$neg}{$judge_ref->{"id"}} > $event_settings{"max_pref"}
												? "semibold redtext"
												: ""
											%>
										">
											<% $ratings->{$neg}{$judge_ref->{"id"}} || "&ndash;" %>
%											$ratings->{$neg}{"total"} += $ratings->{$neg}{$judge_ref->{"id"}};
										</span>
										</div>
									</td>

									<td class="smallish centeralign">
										<% $settings{"averages"}{$judge_ref->{id}} %>
									</td>
%								}

%								unless ($tourn_settings->{"no_school_judges"} || $event_type eq "mock_trial") {
									<td class="smallish" id="school_<% $judge_ref->{id} %>">
%										unless ($blind_mode) {
											<% $judge_ref->{"school_name"}
												? Tab::short_name($judge_ref->{"school_name"})
												: "HIRED"
											%>
%										}
									</td>
<%perl>
								}

								unless ($blind_mode) {

									if (
										$tourn_settings->{"mock_trial_registration"}
										&& $tourn_settings->{regions}
									) {
</%perl>
										<td class="smallish centeralign">
											<% $region_override{$judge_ref->{"id"}} %>
										</td>

%									} elsif ($tourn_settings->{"nsda_nats"}) {

										<td class="smallish centeralign">
											<% $judge_ref->{"region_code"} %>
										</td>

										<td class="smallish centeralign">
											<% $judge_ref->{"district_code"} %>
										</td>

%									} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) {

										<td class = "smallish centeralign" >
											<% $judge_ref->{"region_code"} %>
										</td>

%										if ($settings{"dio_regions"}) {
											<td class="smallish centeralign">
												<% $settings{"dio_region"}{$judge_ref->{"region"}}  %>
											</td>
<%perl>
										}
									}
								}

								my $warn;
								my $chair_warn;
								my $rm_chair;

								if ($judge_ref->{"score"}) {
									$scores++;
									$warn = $judge_ref->{"first"}." ".$judge_ref->{last}." has scores or feedback entered.";
									$warn .= " If you remove the judge, you will also delete those scores.";
									$warn .= " Continue?";
								}

								if ($judge_ref->{"chair"}
									&& $event_type eq "congress"
									&& $round->type eq "prelim"
								) {
									$chair_warn .= " Removing the parliamentarian with this button";
									$chair_warn .= " will also remove them from the other two sessions.";
									$chair_warn .= " Are you sure?";
									$rm_chair = "rm_chair=1";
								}
</%perl>
								<td class="centeralign flexrow" style="min-width: 80px;">
									<span class="half flexrow centeralign grow">
%										if ($rm_chair) {
											<span class="half grow marright">
											<a
												class = "buttonwhite redtext hover padless"
												alt   = "Remove from All Chambers as Parliamentarian"
												title = "Remove from All Chambers as Parliamentarian"
%												if ($warn || $chair_warn) {
													<& "/funclib/confirm.mas", warn => $warn.$chair_warn &>
%												}

												href="judge_rm.mhtml?from=<% $from %>&<% $url_args %>&<% $rm_chair %>">
												<span class="fa fa-gavel"></span>
											</a>
											</span>
%										}
										<span class="half grow centeralign">
											<a
												class      = "buttonwhite redtext hover padless marno"
												alt        = "Remove judge from this section"
												title      = "Remove judge from this section"
												judge_id   = "<% $judge_ref->{"id"} %>"
												panel_id   = "<% $panel->id %>"
%												if ($warn) {
													<&
														"/funclib/confirm.mas",
															url    => "judge_remove.mhtml",
															warn   => $warn,
															switch => 1
													&>
%												} else {
													onClick  = "postSwitch(this, 'judge_remove.mhtml', prefTotal);"
%												}
											>
												<span class="fa fa-sm fa-trash"></span>
											</a>
										</span>
									</span>

%									unless ($tourn_settings->{"no_school_judges"} || $tourn_settings->{"mock_trial_registration"}) {
										<span class="half padvertless ltborderleft marno">
											<a
												class        = "buttonwhite greentext hover padvertless marno bigger"
												alt          = "Remove & Fine"
												title        = "Remove & Fine"
												judge_id     = "<% $judge_ref->{"id"} %>"
												panel_id     = "<% $panel->id %>"
												setting_name = "cha-ching!"
												onMouseDown  = "chaChing();"
												onClick      = "postSwitch(this, 'judge_remove.mhtml', prefTotal());"
%												if ($warn) {
													<& "/funclib/confirm.mas", warn => $warn &>
%												} else {
													onClick  = "postSwitch(this, 'judge_remove.mhtml', prefTotal());"
%												}
											>
												<% $tourn_settings->{"currency"}
													? $tourn_settings->{"currency"}
													: '&#36;'
												%>
											</a>
%										}
									</span>
								</td>

								<td
									class="centeralign nospace smallish"
									title="Started by <% $judge_ref->{"started_name"} %>"
								>
									<div class="nospace smallhide">
										<& "/funclib/showtime.mas", string => $judge_ref->{start_time} &>
									</div>
									<div class="nospace smallshow">
										<& "/funclib/showtime.mas", string => $judge_ref->{start_time}, format => 'shorter' &>
									</div>
								</td>

								<td
									class="centeralign nospace smallish"
									title="<% $judge_ref->{"audited_name"} ? "Ballot confirmed by ".$judge_ref->{"audited_name"} : "" %>"
								>
%									if ($judge_ref->{"audit"}) {
										<div class="nospace smallhide">
											<& "/funclib/showtime.mas", string => $judge_ref->{timestamp} &>
										</div>
										<div class="nospace smallshow">
											<& "/funclib/showtime.mas", string => $judge_ref->{timestamp}, format => 'shorter' &>
										</div>
%									}
								</td>

%								if ($event_type eq "mock_trial") {
%									my $warn = "This will remove the judge's scores but mark them as complete.  Are you sure?";
										<td
											class = "centeralign smallish nospace"
										>
%										unless ($judge_ref->{'audit'} && (not defined $judge_ref->{'score'})) {
											<a
												class         = "buttonwhite orangetext hover padless marno smallish"
												alt           = "Remove judge scores from this section"
												title         = "Remove judge scores from this section"
												judge_id     = "<% $judge_ref->{"id"} %>"
												property_name = "<% $panel->id %>"
%												if ($warn) {
													<&
														"/funclib/confirm.mas",
															url    => "score_remove.mhtml",
															warn   => $warn,
															switch => 1
													&>
%												} else {
													onClick  = "postSwitch(this, 'score_remove.mhtml');"
%												}
											>
												<span class="fa fa-sm fa-superpowers"></span>
											</a>
%										}
									</td>
%								}

%								if ($person->site_admin) {
									<td
										class="centeralign nospace smallish smallhide"
										title="Started by <% $judge_ref->{"started_by"} %>"
									>
										<a
											class  = "fa fa-sm buttonwhite greentext fa-file-text"
											target = "_blank"
											href   = "/user/judge/ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge_ref->{"id"} %>"
										></a>
									</td>
%								}
							</tr>
%	 					}
					</tbody>
%				}

%	 			if ($settings{"prefs"}) {

					<tr class="row bordertopthin">

%	 					if ($settings{"coach_ratings"}) {
							<td class="smallish centeralign">
							</td>
%	 					}

%	 					if ($settings{"diversity"}) {
							<td class="smallish centeralign">
							</td>
%	 					}
%						if ($event_settings{"online_hybrid"}) {
							<td class="smallish" align="center">
							</td>
%	 					}

						<td colspan="<% $tourn_settings->{"no_school_judges"} ? "2" : "3" %>" class="smallish rightalign">
							Pref Totals
						</td>

						<td class="smallish centeralign">
							<div class="full flexrow">
								<span class="half nospace padright rightalign nowrap" id="aff_total">
								</span>

								<span class="half nospace rightalign" id="neg_total">
								</span>
							</div>

						</td>

						<td class="smallish centeralign" id="pref_diff">
							<% sprintf("%.1f", abs($ratings->{$aff}{"total"} - $ratings->{$neg}{"total"})) %>
						</td>

						<td colspan="8" class="smallish">
							Differential
						</td>

					</tr>
%				}

			</table>
			</div>

			<form
				action = "judge_add.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<input
				type  = "hidden"
				name  = "from"
				value = "<% $from %>"
			>

			<div class="row smallish martopmore flexrow">

				<span class="sixth padleft semibold">
					Available
				</span>

				<span class="twothirds">
					<select
						name             = "judge_id"
						onChange         = "this.form.submit();"
						data-placeholder = "Clean judges <% $event_settings{"online_mode"} eq "async"
							? ""
							: "without assignments..."
						%>"
					>
<%perl>
						my %used;
						my $in_standby;
						my $not_in_standby;
						my $strikes;
						my $wilderson;
</%perl>
						<option value=""></option>
						<optgroup class="key" label="<% $good_fields{"label"} %>">
<%perl>
						foreach my $judge_id (@good_judges) {
							next if $used{$judge_id}++;
							if ($burned{$judge_id} && not defined $wilderson) {
</%perl>
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges past commitment</option>
%	 							$wilderson++;
%							}

%							if ($clean_judges{$judge_id}{"gong"} && not defined $strikes) {
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges who have been struck</option>
%	 							$strikes++;
%							}

%							if ($clean_judges{$judge_id}{"standby"} && not defined $in_standby) {
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges in standby pool:</option>
<%perl>
								 $in_standby++;
							}

							if ($in_standby
								&& (not defined $not_in_standby)
								&& (not defined $clean_judges{$judge_id}{"standby"})
							) {
</%perl>
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges not in standby pool:</option>
%								undef $in_standby;
%							}
							<option value="<% $judge_id %>"><% $good_fields{$judge_id} %></option>
%	 					}

						</optgroup>
					</select>
				</span>

				<span class="sixth centeralign">
					<button
						value   = "Add"
						class   = "thin buttonwhite bluetext fa fa-lg fa-plus"
					></button>
				</span>

				</form>
			</div>

%			unless ($event_settings{"online_mode"} eq "async") {

				<form
					action = "judge_add.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel_id %>"
				>

				<input
					type  = "hidden"
					name  = "from"
					value = "<% $from %>"
				>

				<input
					type  = "hidden"
					name  = "steal"
					value = "yes"
				>

				<div class="even smallish martop flexrow">
					<span class="sixth padleft semibold">
						Judging
					</span>

					<span class="twothirds">
						<select
							name             = "judge_id"
							data-placeholder = "Clean judges who are judging already..."
						>
							<option value=""></option>
							<optgroup class="key" label="<% $busy_fields{"label"} %>">

%							undef $strikes;
%							foreach my $judge_id (@busy_judges) {
%								next if $used{$judge_id}++;
%								if ($busy_judges{$judge_id}{"gong"} && not defined $strikes) {
									<option
										value    = "x"
										disabled = "true"
										class    = "key"
									>Judges who have been struck</option>
%									$strikes++;
%								}
								<option value="<%$judge_id %>"><% $busy_fields{$judge_id} %></option>
%							}

							</optgroup>
						</select>
					</span>

					<span class="sixth centeralign">
						<button
							value   = "Add"
							class   = "thin buttonwhite bluetext fa fa-lg fa-plus"
						></button>
					</span>
				</div>
				</form>
%			}
		</div>

		<h5 class="martopmore">
			<% scalar (keys %entries) %> Entries
		</h5>

		<& "/funclib/tablesorter.mas", table => "Entries", nobuttons => 1 &>

		<table id="Entries">
			<thead>
				<tr>
%					if ($event_type eq "speech") {
						<th class="centeralign">
							Spks
						</th>
%					} elsif ($event_type eq "congress") {

%						if ($event_settings{"sort_precedence"}) {
							<th class="centeralign">
								Recency
							</th>
%						}

%					} elsif ($event_type eq "wudc") {
						<th>
							Pos
						</th>
%					} else {

						<th>
							Side
						</th>

%						if ($flips{"team_order"}) {
							<th title="Speaker Position">
								Spks
							</th>
%						}

						<th title="Records">
							Rs
						</th>
%					}

%					if ($event_settings{"online_hybrid"}) {
						<th>
							Online
						</th>
%					}

					<th>
						Entry
					</th>

%					if ($event_settings{"online_prep"}) {
						<th>
							Prep
						</th>
%					}

%					unless ($tourn_settings->{"no_school_judges"} || $tourn_settings->{"mock_trial"}) {
						<th>
							School
						</th>
%					}

%					if ($tourn_settings->{"nsda_nats"}) {

						<th>
							State
						</th>

						<th>
							District
						</th>

%					} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) {

						<th>
							<% $tourn_settings->{"ncfl"} ? "Dio" : "Region" %>
						</th>

%						if ($settings{"dio_regions"}) {
							<th>
								Reg
							</th>
<%perl>
						}
					}

					if ($event_settings{"online_mode"} eq "async"
						|| $event_settings{"show_async_links"}
						|| $show_async
					) {
</%perl>
						<th>
							Video Link
						</th>
%					}

%					unless ($checker) {
						<th>
							Move
						</th>
%					}
				</tr>
			</thead>
			<tbody>
<%perl>
			my $speaks = 1;

 			foreach my $entry_id (
				sort {
					$entries{$b}{"po"} <=> $entries{$a}{"po"}
					|| $entries{$a}{"speaks"} <=> $entries{$b}{"speaks"}
					|| $entries{$a}{"side"} <=> $entries{$b}{"side"}
					|| $entries{$a}{"last"} cmp $entries{$b}{"last"}
					|| $entries{$a}{"code"} cmp $entries{$b}{"code"}
				} keys %entries
			) {

				$m->print('<tr class="row">');

				if (
					$entries{$entry_id}{"dq"}
					|| $entries{$entry_id}{"dropped"}
				) {
</%perl>
					<td class="semibold redtext centeralign">
						<% ($entries{$entry_id}{"dq"}) ? "DQ" : "" %>
						<% ($entries{$entry_id}{"dropped"}) ? "DROP" : "" %>
					</td>

%					if ($event_type eq "debate" || $event_type eq "wsdc") {
%						if ($flips{"team_order"}) {
							<td class="smallish centeralign">
								<% $entries{$entry_id}{"order"} %>
							</td>
%						}
						<td class="smallish centeralign padless">
						</td>
%					} elsif ($event_type eq "mock_trial") {
						<td class="smallish centeralign padless">
							<%
								$entry_wins{$entry_id}
								? $entry_wins{$entry_id}
								: 0
							%><%
								$event_settings{"bracket_by_ballots"}
								? ""
								: $entry_losses{$entry_id}
									? "-".$entry_losses{$entry_id}
									: "-0"
							%>
						</td>
%					}

%				} elsif ($event_type eq "speech") {
					<td class="smallish centeralign">
						<% $entries{$entry_id}{"speaks"}
							? Lingua::EN::Numbers::Ordinate::ordinate($entries{$entry_id}{"speaks"})
							: ""
						%>
					</td>
%				} elsif ($event_type eq "wudc") {
					<td class="smallish centeralign">
						<% $entries{$entry_id}{"speaks"} == 1 ? "OG" : "" %>
						<% $entries{$entry_id}{"speaks"} == 2 ? "OO" : "" %>
						<% $entries{$entry_id}{"speaks"} == 3 ? "CG" : "" %>
						<% $entries{$entry_id}{"speaks"} == 4 ? "CO" : "" %>
					</td>

%				} elsif ($event_type eq "congress" ) {
%					if ($event_settings{"sort_precedence"}) {
						<td class="smallish centeralign">
							<%  $entries{$entry_id}{"po"}
								? "<span class='centeralign bluetext semibold smallish'>PO</span>"
								: $entries{$entry_id}{"speaks"}
									? Lingua::EN::Numbers::Ordinate::ordinate($speaks++)
									: ""
							%>
						</td>
%					}
<%perl>
				} else {

					if (
						( $round_type eq "elim"
							|| $round_type eq "final"
							|| $round_type eq "runoff"
							|| $round_type eq "flip"
						)
						&& ($event_type ne "mock_trial")
						&& ($scores)
						&& (not defined $due_aff)
						&& (scalar (keys %flips) < 0 || $flips{'status'} ne "done")
					) {
</%perl>
						<td class="smallish centeralign">
							Flip
						</td>

%					} else {

						<td class="smallish padleft">
%							if ($due_aff) {
%								if ($entry_id == $due_aff && $entries{$entry_id}{"side"} == 1)  {
									<% $entries{$entry_id}{"side"} == 1 ? "Locked ".$aff_string : ""%>
%								} elsif (($entry_id != $due_aff) && $entries{$entry_id}{"side"} == 2) {
									<% $entries{$entry_id}{"side"} == 2 ? "Locked ".$neg_string : ""%>
%								} else {
									<span class="redtext full marno padless semibold">
										Sidelock broken!
									</span>

									<span class="redtext full marno padless semibold">
										Locked <% $due_aff == $entry_id ? "Aff" : "Neg" %>
									</span>
									but on the
									<%
										$entries{$entry_id}{"side"} == 1
										? $aff_string
										: ""
									%>
									<%
										$entries{$entry_id}{"side"} == 2
										? $neg_string
										: ""
									%>
%								}
%							} else {
								<% $entries{$entry_id}{"side"} == 1 ? $aff_string : $neg_string %>
%							}
						</td>
%					}

%					if ($flips{"team_order"}) {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"order"} %>
						</td>
%					}

					<td class="centeralign smallish">
						<%
							$entry_wins{$entry_id}
							? $entry_wins{$entry_id}
							: 0
						%><%
							$event_settings{"bracket_by_ballots"}
							? ""
							: $entry_losses{$entry_id}
								? "-".$entry_losses{$entry_id}
								: "-0"
						%>
					</td>
%				}

%				if ($event_settings{"online_hybrid"}) {
					<td class="smallish nospace padless centeralign">
%					if ($entries{$entry_id}{"online_hybrid"}) {
						<span class="greentext fa fa-lg fa-laptop"></span>
%					}
					</td>
%				}

				<td class="smallish nospace padless">

%					if ($blind_mode) {
						<% $anonymize{"entry"}{$entry_id} %>
%					} else {

%						unless ($checker) {
							<a
								class="white full leftalign marno"
								href="/register/entry/edit.mhtml?entry_id=<% $entry_id %>"
							>
%						}

%						if ($event_type eq "mock_trial") {
							<div class="full nospace centeralign padleft"
							><% $entries{$entry_id}{"code"} %></div>

%						} elsif ($code_name) {
							<span class="threequarters marno padleft"
							><% $entries{$entry_id}{"code"} %></span>

%						} else {

							<span class="half nospace padleft"
							><% $entries{$entry_id}{"code"} %></span>

							<span
								class="half nospace top padleft"
							><% $entries{$entry_id}{"name"} %></span>
%						}
%						unless ($checker) {
							</a>
%						}
%					}
				</td>

%				if ($event_settings{"online_prep"}) {
					<td class="centeralign">
						<& "/funclib/online_room.mas",
                            entry  => $entry_id,
                            person => $person,
							role   => "Tab: ",
                            show   => 1,
                            class  => "fa-sm padless"
                        &>
					</td>
%				}

				<td class="smallish padleft">
%					unless ($blind_mode) {
						<% (not defined $settings{"no_school_codes"})
							? '<span class="threetenths">'.$entries{$entry_id}{"school_code"}.'</span><span class="twothirds">'
							: ""
						%>
						<% Tab::short_name($entries{$entry_id}{"school_name"}) %>
						<% (not defined $settings{"no_school_codes"})
							? '</span>'
							: ""
						%>
%					}
				</td>

%				unless ($blind_mode) {
%					if ($tourn_settings->{"nsda_nats"}) {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"region_code"} %>
						</td>

						<td class="smallish centeralign">
							<% $entries{$entry_id}{"district_code"} %>
						</td>
%					} elsif ($tourn_settings->{"regions"} || $tourn_settings->{"ncfl"} ) {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"region_code"} %>
						</td>

%						if ($settings{"dio_regions"}) {
							<td class="smallish centeralign">
								<% $settings{"dio_region"}{$entries{$entry_id}{"region_code"}} %>
							</td>
%						}
%					}
%				}
<%perl>
				if ($event_settings{"online_mode"} eq "async"
					|| $event_settings{"show_async_links"}
					|| $show_async
				) {
</%perl>
					<td class="smallish centeralign nospace">
%						if ($entries{$entry_id}{"video_link"}) {
							<a
								class  = "buttonwhite greentext marno fa fa-video-camera"
								target = "_blank"
								href   = "<% $entries{$entry_id}{"video_link"} %>"
							></a>
%						} else {
							<span class="smaller semibold redtext centeralign nospace">
								NO VIDEO!
							</span>
%						}
					</td>
%				}

%				unless ($checker) {
					<td class="smallish centeralign nospace">
						<a
							title = "Move Competitor to different debate"
							class = "buttonwhite bluetext smallish marno fa fa-arrows-alt"
							href  = "/panel/manipulate/entry_edit.mhtml?entry_id=<%$entry_id%>&round_id=<% $round->id %>"
						></a>
					</td>
%				}
				</tr>
%	 		}
			</tbody>
		</table>
<%perl>

 		foreach my $entry_id (sort keys %entries) {

			if ($entries{$entry_id}{"strike_desc"}) {
				my $strike_by = Tab::Person->retrieve($entries{$entry_id}{"strike_by"});
</%perl>
				<span class="half centeralign smallish italic martop">
					<span class="third semibold rightalign">
						Strikes entered by
					</span>
					<span class="twothirds">
						<% $strike_by
							? $strike_by->first." ".$strike_by->last
							: ""
						%>
						<% $entries{$entry_id}{"strike_auto"}
							? "Autostrike process"
							: ""
						%>
						at <& "/funclib/showdt.mas",
							string => $entries{$entry_id}{"strike_at"},
							tz     => $tz,
							length => 'seconds'
						&>
					</span>
				</span>
%			}
%		}

<%perl>
		if ($event_settings{"flip_online"}
			&& $event_settings{"no_side_constraints"}
			|| (
				( $round_type eq "elim"
					|| $round_type eq "final"
					|| $round_type eq "runoff"
				)
				&& (not defined $due_aff)
				&& ($event_type ne "speech")
				&& ($event_type ne "congress")
			)
		) {
</%perl>
			<h6 class="semibold marbottom martopmore padbottomless">
				Flip Status
			</h6>

			<form
				action = "panel_flip_save.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<span class="ltbordervert full flexkids">
				<div class="row smallish flexrow">
					<span class="eighth semibold bluetext padleft">
						Flip Winner
					</span>

					<span class="quarter centeralign">
						<select name="winner_id">
							<option value="">No flip performed (Resets flip)</option>
% 							foreach my $entry_id (sort keys %entries) {
								<option
									value="<% $entry_id %>"
									<% $flips{'won'} eq $entry_id ? "selected" : "" %>
								>
									<% $entries{$entry_id}{"code"} %>
								</option>
%							}
						</select>
					</span>

					<span class="eighth padleft semibold bluetext">
						Status
					</span>

					<span class="quarter centeralign">
						<select
							name  = "flip_status"
							class = "fixedmost"
						>
							<option
								value="winner"
								<% (not defined $flips{"status"}) ?  "selected" : "" %>
							>
								No Flip Done
							</option>

							<option
								value="winner"
								<% $flips{"status"} eq "winner" ? "selected" : "" %>
							>
								Flip Winner's Choice
							</option>

							<option
								value="loser"
								<% $flips{"status"} eq "loser" ? "selected" : "" %>
							>
								Flip Loser's Choice
							</option>

							<option
								value="anyone"
								<% $flips{"status"} eq "anyone" ? "selected" : "" %>
							>
								Anyone's Choice
							</option>

							<option
								value="done"
								<% $flips{"status"} eq "done" ? "selected" : "" %>
							>
								Flip Done
							</option>
						</select>
					</span>

					<span class="quarter rightalign padright">
%						my $warn = "Are you sure you want to send notices of the flip status to this section?";
						Blast Section
						<a
							class         = "redtext buttonwhite fa fa-paper-plane"
							title         = "Send flip results and winner to this debate only"
							value         = "1"
							id            = "<% $panel_id %>"
							property_name = "panel"
							setting_name  = "blast_only"
							panel_id      = "<% $panel_id %>"
							onClick       = "postConfirm('<% $warn %>', this, 'flips.mhtml');"
						></a>
					</span>
				</div>

				<div class="row smallish flexrow">
					<span class="eighth semibold bluetext padleft">
						Deadline
					</span>

					<span class="eighth">
						<select name="flip_at_date">
%							foreach my $day (@days) {
								<option
									value="<% $day->ymd %>"
									<% $flips{"deadline"} && $flips{"deadline"}->day == $day->day ? "selected" : "" %>
								><% $day->day_abbr %> <% $day->month %>/<% $day->day %></option>
%							}
						</select>
					</span>

					<span class="eighth">
						<& "/funclib/timepicker.mas",
							name => "flip_at_time",
							time => $flips{"deadline"}
						&>
					</span>

					<span class="eighth bluetext semibold padleft">
						Choices Made
					</span>

					<span class="eighth hover">
						<label for="side_locked">
							Side
							<input
								type  = "checkbox"
								name  = "side_locked"
								id    = "side_locked"
								value = 1
								<% $flips{"side_locked"} ? "checked" : "" %>
							>
						</label>
					</span>

%					if ($flips{"team_order"}) {
						<span class="eighth hover padleft">
							<label for="order_locked">
								Order
								<input
									type  = "checkbox"
									name  = "order_locked"
									id    = "order_locked"
									value = 1
									<% $flips{"order_locked"} ? "checked" : "" %>
								>
							</label>
						</span>
%					}

					<span class="quarter rightalign padright">
						Save Changes
						<button class = "buttonwhite bluetext fa fa-lg fa-save" /></button>
					</span>
				</div>
			</span>
			</form>
%		}

<%perl>
		if ($ARGS{"came_from"}) {
			my $came = Tab::Panel->retrieve($ARGS{came_from});
			my $taken = Tab::Judge->retrieve($ARGS{taken});

</%perl>
			<div class="full padvtop odd">
				<span class="redtext semibold rightalign threefifths">
					Judge <% $taken ? $taken->first." ".$taken->last : "" %> was taken from section:
				</span>

				<span class="twofifths">
					<a
						class  = "redtext buttonwhite invert"
						target = "_blank"
						href   = "panel_view.mhtml?panel_id=<% $came->id %>"
					>Section <% $came->letter %> <% $came->round->event->abbr %>
					</a>
				</span>
			</div>
<%perl>
		}

			$m->print("<h5 class='semibold martopmore marbottom'>Room Log</h5>");

			my %logdata;
			my $counter = 1;

			my $confirmed_sth = $dbh->prepare("
				select
					ps.timestamp, person.first, person.last
				from panel_setting ps
					left join person on ps.value = person.id
				where ps.tag = 'confirmed_started'
					and ps.panel = ?
			");

			$confirmed_sth->execute($panel->id);
			my $confirmeds = $confirmed_sth->fetchall_hash();

			if ($confirmeds) {
				foreach my $confirmed (@{$confirmeds}) {

					my $ts = $confirmed->{timestamp};
					$ts =~  s/[\D_]//g;

					$logdata{$counter++} = ({
						tag       => "Confirmed",
						time      => $confirmed->{timestamp},
						timestamp => $ts,
						name      => $confirmed->{"first"}." ".$confirmed->{"last"},
						desc      => 'Section confirmed started'
					});

				}
			}

			my $log_sth = $dbh->prepare("
				select
					cl.id, cl.tag, cl.description, cl.created_at, cl.count,
					cl.panel,
					person.id, person.first, person.last,
					judge.first jfirst, judge.last jlast, school.name sname
				from (change_log cl, person)
					left join judge on cl.judge = judge.id
					left join school on judge.school = school.id
				where cl.panel = ?
					and cl.person = person.id
					and cl.tag IN ('blast', 'judge')
				order by cl.created_at DESC
			");

			$log_sth->execute($panel->id);
			my $logs = $log_sth->fetchall_hash();

			foreach my $log (@{$logs}) {

				my $desc;

				if ($log->{'tag'} eq 'blast') {
					$desc = "Blast: ".$log->{"description"};
				} else {
					$desc = $log->{"description"};
				}

				my $ts = $log->{created_at};
				$ts =~  s/[\D_]//g;

				$logdata{$counter++} = ({
					tag       => $log->{tag},
					time      => $log->{created_at},
					timestamp => $ts,
					name      => $log->{"first"}." ".$log->{"last"},
					desc      => $desc
				});
			}

			my $entry_sth = $dbh->prepare("
				select
					person.first, person.last,
					entry.code, entry.name,
					judge.first jfirst, judge.last jlast,
					student.first sfirst, student.last slast,
					cl.description,
					cl.timestamp

				from (campus_log cl, tourn)
					left join person on cl.person = person.id
					left join entry on cl.entry = entry.id
					left join student on cl.student = student.id
					left join judge on cl.judge = judge.id

				where cl.panel = ?
					and cl.tourn = tourn.id
				group by cl.id
				order by cl.timestamp DESC
			");

			$entry_sth->execute($panel->id);
			my $entries = $entry_sth->fetchall_hash();

			foreach my $entry (@{$entries}) {

				my $name;

				if ($entry->{last}) {
					$name = $entry->{first}." ".$entry->{last};
				} elsif ($entry->{jlast}) {
					$name = $entry->{jfirst}." ".$entry->{jlast};
				} elsif ($entry->{slast}) {
					$name = $entry->{sfirst}." ".$entry->{slast};
				} elsif ($entry->{code}) {
					$name = $entry->{code}." ".$entry->{name};
				}

				my $ts = $entry->{timestamp};
				$ts =~  s/[\D_]//g;

				$logdata{$counter++} = ({
					tag       => "Present",
					time      => $entry->{timestamp},
					timestamp => $ts,
					name      => $name,
					desc      => $entry->{description}
				});
			}

			my $strike_sth = $dbh->prepare("
				select
					log.tag, log.created_at, log.description,
					person.id person, person.first, person.last,
					school.id school, school.name
				from change_log log
					left join person on person.id = log.person
					left join school on school.id = log.school
				where log.panel = ?
					and log.tag IN ('strikecard', 'autostrike')
			");

			$strike_sth->execute($panel->id);
			my $strike_logs = $strike_sth->fetchall_hash();

			foreach my $strike (@{$strike_logs}) {

				my $ts = $strike->{"created_at"};
				$ts =~  s/[\D_]//g;

				my $desc;

				if ($strike->{tag} eq "autostrike") {
					$desc = $strike->{description};
				} else {
					$desc = "Strike entered for ".$strike->{"name"};
				}

				$logdata{$counter++} = ({
					tag       => "Strike Card",
					time      => $strike->{"created_at"},
					timestamp => $ts,
					name      => $strike->{"first"}." ".$strike->{'last'},
					desc      => $desc
				});
			}

			foreach my $type ("side", "order") {
				if ($flips{$type."_chosen_at"}) {

					my $chooser = Tab::Person->retrieve($flips{$type."_chosen_by"});
					my $desc;

					if ($flips{$type."_chosen"}) {
						$desc = "Chose to debate ".$flips{$type."_chosen"};
					} elsif ($flips{$type."_auto_chosen"}) {
						$desc = "Chosen automatically at deadline";
					}

					my $ts = $flips{$type."_chosen_at"};
					$ts =~  s/[\D_]//g;

					$logdata{$counter++} = ({
						tag       => "Flip ".ucfirst($type),
						time      => $flips{$type."_chosen_at"},
						timestamp => $ts,
						name      => $chooser ? $chooser->first." ".$chooser->last : "",
						desc      => $desc
					});
				}
			}

			foreach my $key (
				sort {
					$logdata{$b}{"timestamp"} <=> $logdata{$a}{"timestamp"}
					|| $a <=> $b
				} keys %logdata
			) {

</%perl>
				<div class="row smallish flexrow">
					<span class="tenth semibold padvertless smallhide">
						<% ucfirst($logdata{$key}{'tag'}) %>
					</span>
					<span class="fifth nospace smallhide">
						<& "/funclib/showtime.mas",
							string => $logdata{$key}{'time'},
							format   => "day",
							tz       => $tourn->tz,
							day_name => 1,
							tzname   => 1
						&>
					</span>
					<span class="fifth nospace smallhide">
						<% $logdata{$key}{'name'} %>
					</span>

					<span class="half flexrow padvertless smallshow">
						<span class="half">
							<div class="semibold padbottomless">
								<% ucfirst($logdata{$key}{'tag'}) %>
							</div>
							<div>
								<& "/funclib/showtime.mas",
									string => $logdata{$key}{'time'},
									format   => "day",
									tz       => $tourn->tz,
									day_name => 1,
									tzname   => 1
								&>
							</div>
						</span>
						<span class="half">
							<% $logdata{$key}{'name'} %>
						</span>
					</span>

					<span class="half padvertless marno">
						<% $logdata{$key}{'desc'} %>
					</span>
				</div>
%			}
	</div>

	<div class="menu">

%		if ($checker) {
	        <div class="sidenote">
				<h4>Return</h4>

				<a class="blue full" href="/tabbing/entry/index.mhtml">
					Return to Ballot Entry
				</a>
			</div>

%		} else {

		<div class="sidenote">

			<span class="twothirds nospace">
				<h4>Printout</h4>
			</span>
			<span class="third rightalign nospace">
				<a
					class = "fa bluetext buttonwhite <% $person->id == 16454 ? "fa-smile-o" : "fa-undo" %>"
					href="show.mhtml?round_id=<% $round->id %>"
					title = "<% $event->abbr %> <% $round->realname %> Pairing"
				></a>
			</span>

			<a class="blue half"
				href="/panel/report/print_ballots.mhtml?panel_id=<% $panel->id %>"
			>Print Ballots</a>

			<a class="blue half"
				href="/panel/report/postings.mhtml?panel_id=<% $panel->id %>"
			>Print Posting</a>

%			if ($event_type eq "congress") {
				<a class="blue half"
					href="/panel/report/placards.mhtml?panel_id=<% $panel->id %>"
				>Placards</a>
				<a class="blue half"
					href="/panel/report/placards.mhtml?panel_id=<% $panel->id %>&no_pronoun=1"
				>Placards w/o Pronouns</a>

				<a class="blue half"
					href="/panel/schemat/seating_print.mhtml?panel_id=<% $panel->id %>&views=judges"
				>Parli's Seating Chart</a>

				<a class="blue half"
					href="/panel/schemat/seating_print.mhtml?panel_id=<% $panel->id %>&views=parli"
				>Scorer's Seating Chart</a>
%			}
<%perl>
			if (
				$event_type eq "debate"
				&& ($round_type eq "elim"
					|| $round_type eq "final"
					|| $round_type eq "runoff"
				)
			) {
</%perl>
				<a class="blue half"
					href="/panel/report/strike_cards.mhtml?panel_id=<% $panel->id %>"
				>
					Print Strike Cards
				</a>
%			}

			<h4>Communicate</h4>

			<a class="blue full"
				href="/panel/schemat/section_blast.mhtml?panel_id=<% $panel->id %>"
			>
				Blast notifications to this section
			</a>

%			if ($tourn_settings->{"nsda_nats"} && $round->type eq "final") {
				<a class="blue full martop"
					href="/panel/report/nats_elim_bios.mhtml?panel_id=<% $panel->id %>"
				>Judge Bios</a>
%			}

		</div>

		<div class="sidenote">
<%perl>
			if (
				(
					$event_settings{"online_mode"} ne "public_jitsi"
					&& $event_settings{"online_mode"} ne "public_jitsi_observers"
					&& $event_settings{"online_mode"} ne "nsda_campus"
					&& $event_settings{"online_mode"} ne "nsda_campus_observers"
					&& $event_settings{"online_mode"} ne "async"
				) || ($event_settings{"online_hybrid"})
			) {
</%perl>
				<form
					action = "panel_room_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel_id %>"
				>

				<div class="row flexrow padvertno">
					<span class="quarter semibold padleft">
						Room
					</span>

					<span class="threequarters padright nospace padvertno">
						<select
							name             = "room_id"
							class            = "marno"
							onchange         = 'this.form.submit()'
							data-placeholder = "Select room"
						>

%							if ($room) {
								<option
									value="<% $panel_room %>" "selected"
								><% $room->name %></option>
%							}

							<option value="">--NONE--</option>

%							foreach my $room (@reserved_rooms) {
								<option
									value="<% $room->id %>"
								><% $room->name %></option>
<%perl>
							}

							my %rooms =	$m->comp("/funclib/clean_rooms_hash.mas", panel => $panel);

							foreach my $room_id (
								sort {
									$rooms{$a}{"quality"} <=> $rooms{$b}{"quality"}
									|| $rooms{$a}{"string"} cmp $rooms{$b}{"string"}
									|| $rooms{$a}{"number"} <=> $rooms{$b}{"number"}
								} keys %rooms
							) {
</%perl>
								<option
									value="<% $room_id %>"
								><% $rooms{$room_id}{"name"} %></option>
%							}
						</select>
					</span>
				</div>
				</form>

%			} else {

				<div class="row flexrow">
					<span class="half semibold padleft">
						Enter Room
					</span>
					<span class="half padvertless">
						<& "/funclib/online_room.mas",
							panel   => $panel,
							person  => $person,
							show    => 1,
							no_name => 1,
							class   => "fa-sm"
						&>
					</span>
				</div>
<%perl>
			}

			if (
				(
					$event_settings{"online_mode"} eq "public_jitsi"
					|| $event_settings{"online_mode"} eq "public_jitsi_observers"
					|| $event_settings{"online_mode"} eq "nsda_campus"
					|| $event_settings{"online_mode"} eq "nsda_campus_observers"
				) && (
					(not defined $event_settings{"online_hybrid"})
					|| ($panel_online)
				)
			) {
</%perl>
				<div
					class = "row flexrow"
					title = "Changing this will assign the round to a new Campus room"
				>
					<span class="threequarters semibold padleft">
						Section
					</span>

					<span class="quarter padright">
						<input
							type          = "text"
							name          = "letter"
							class         = "marno"
							value         = "<% $panel->letter %>"
							size          = 4
							maxlength     = 3
							panel_id     = "<% $panel->id %>"
							property_name = "letter"
							onChange      = "postSwitch(this, 'panel_switch.mhtml');"
						>
					</span>
				</div>
<%perl>
			}

			if (
				$event_type ne "speech"
				&& $event_type ne "congress"
				&& ($panel->bye || (scalar (keys %schools) < 2))
			) {
</%perl>
				<label for="<% $panel->id %>_bye">
					<div class="row flexrow">
						<span class="threequarters semibold padleft leftalign nospace">
<%perl>
							if (
								$round->type eq "elim"
								|| $round->type eq "final"
								|| $round->type eq "runoff"
							) {
</%perl>
								Elim Walk Over
%							} else {
								Assigned Bye
%							}
						</span>

						<span class="quarter rightalign nospace padright">
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $panel->id %>_bye"
									property_name = "bye"
									panel_id      = "<% $panel->id %>"
									onChange      = "
										postSwitch( this, 'panel_switch.mhtml');
										showJudges( );
									"
									<% $panel->bye ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>
							</label>
						</span>

					</div>
				</label>
<%perl>
			}

			if (
				$event_type eq "speech"
				&& $event_settings{"online_mode"}
				&& $event_settings{"online_mode"} ne "async"
			) {
</%perl>
				<div class="row flexrow nospace">
					<span class="threefifths semibold marno padleft">
						Async Section
					</span>

					<span class="quarter centeralign">
						<span class="hidden"><% $show_async %></span>
						<label class="switch smaller">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $panel->id %>_async"
								setting_name = "show_async"
								panel_id     = "<% $panel->id %>"
								onChange     = "
									postSwitch( this, 'panel_switch.mhtml');
									showJudges( );
								"
								<% $show_async ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

%			if ($event_settings{"online_hybrid"}) {

				<div class="row flexrow">
					<label for="<% $panel->id %>_hybrid">
					<span class="half semibold padleft">
						Online Section
					</span>

					<span class="sixth padleft nospace">
						<label class="switch smaller">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $panel->id %>_hybrid"
								setting_name = "online_hybrid"
								panel_id    = "<% $panel->id %>"
								onChange     = "
									postSwitch( this, 'panel_switch.mhtml');
									showJudges( );
								"
								<% $panel_online ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
					<span class="third">
					</span>
					</label>
				</div>
%			}

%			if ($settings{"flighted"} > 1) {

				<form
					action = "panel_flight_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel_id %>"
				>

				<div class="row flexrow">
					<span class="half semibold padleft">
						Flight
					</span>

					<span class="half flexrow wrap padright nospace">
%						foreach my $flight (1 .. $settings{"flighted"}) {
							<span class="half hover padleft nospace">
								<label for="flight_<% $flight %>">
									<input
										type     = "radio"
										class    = "padvertless marvertno"
										name     = "flight"
										id  	 = "flight_<% $flight %>"
										value    = "<% $flight %>"
										onchange = 'this.form.submit();'
										<% $flight == $panel->flight ? "checked" : "" %>
									> <% $flight %>
								</label>
							</span>
%						}
					</span>
				</div>
				</form>
%			}

%			my @jpools = $round->jpools;

%			if (@jpools) {

				<div class="row flexrow">
					<span class="fifth semibold padleft">
						Judges
					</span>

                    <span class="fourfifths nospace flexrow">
%						foreach my $jpool (@jpools) {
							<a
								class = "plain hover semibold bluetext grow rightalign padleft"
								href  = "/panel/judge/jpool.mhtml?pool_id = <% $jpool->id %>"
							><% $jpool->name %></a>
%						}
					</span>
				</div>
%			}

%			if ($round->published > 0 && $event_settings{"judge_publish_results"}) {
				<label for="<% $panel->id %>_publish">
					<div class="row flexrow nospace">
						<span class="half semibold padleft">
							Results Published
						</span>
						<span class="half padleft">
							<label class="switch smaller noflex">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $panel->id %>_publish"
									property_name = "publish"
									panel_id     = "<% $panel->id %>"
									onChange      = "postSwitch( this, 'panel_switch.mhtml');"
									<% $panel->publish ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</div>
				 </label>
%			}

%			if ($settings{'share'}) {
				<div class="row flexrow nospace">
					<span class="twofifths semibold padleft">
						Share Room
					</span>

					<span class="threefifths padvertless">
						<a
							href="https://share.tabroom.com/<% $settings{"share"} %>"
							class="full biggish bluetext link-underline hover"
						><% $settings{"share"} %></a>
					</span>
				</div>
%			}
		</div>

		<div class="sidenote">
			<h4 title="NO HOLDS BARRED, NO RULES FOLLOWED!  DANGER LURKETH HERE!">No-Constraint Changes</h4>

%			if ($event_type eq "congress" && $event_settings{"sort_precedence"}) {
				<a
					href  = "speaker_order.mhtml?panel_id=<% $panel->id %>"
					class = "yellow full"
				>Change Recency</a>

%			} elsif ($event_type eq "speech") {
				<a
					href="speaker_order.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Speaker Order
				</a>
%			} elsif ($event_type eq "wudc") {
				<a
					href="wudc_sides.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Team Positions
				</a>
%			} else {
				<a
					href="debate_sides_swap.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change/Flip Sides
				</a>

%				if ($flips{"team_order"}) {
					<a
						href="debate_order_swap.mhtml?panel_id=<% $panel->id %>"
						class="yellow full"
					>
						Change Speaker Position
					</a>
%				}
%			}

%			unless ($blind_mode) {
				<a
					href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					View/Edit Results
				</a>

%				if ($settings{"prefs"}) {
					<a
						href="prefs_report.mhtml?panel_id=<% $panel->id %>"
						class="yellow full"
					>
						Judge Pref Report
					</a>
%				}
%			}

% 			unless (@{$judges} || keys %entries) {
				<a
					href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel_id %>"
					class="dkred full"
				>Delete <% $section %></a>
% 			}
% 		}

%		unless ($checker) {
			<p class="padno semibold redtext martopmore">
				Add literally any judge
			</p>

			<form
				action = "judge_add.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

   			<input
				type  = "hidden"
				name  = "bypass_check"
				value = "true"
			>

			<div class="row centeralign nospace flexrow">
				<span class="fivesixths padleft">
					<select
						name             = "judge_id"
						data-placeholder = "Select judge"
					>
						<option value=""></option>
<%perl>
						my $all_judges_sth = $dbh->prepare("
							select judge.id, judge.first, judge.last, judge.code, category.abbr
							from judge, category
							where judge.category = category.id
							and category.tourn = ?
							order by category.abbr, judge.code, judge.last
						");

						$all_judges_sth->execute($tourn->id);

						while(
							my ($judge_id, $first, $last, $code, $abbr) =
								$all_judges_sth->fetchrow_array()
						) {
</%perl>
							<option
								value="<% $judge_id %>"
							><% $abbr %>- <% $code %> <% $last %>, <% $first %></option>
%						}
					</select>
				</span>

				<span class="sixth">
					<button
						class = "buttonwhite bluetext fa fa-lg fa-plus"
					></button>
				</span>
			</div>

			</form>

			<p class="padno semibold redtext">
				Change to literally any room
			</p>

			<form
				action = "panel_room_save.mhtml"
				method = "post"
			>

				<input
					type             = "hidden"
					name             = "panel_id"
					value            = "<% $panel->id %>"
					data-placeholder = "Select room"
				>

				<div class="row centeralign nospace flexrow">

					<span class="fivesixths padleft">
						<select
							name             = "room_id"
							data-placeholder = "Select Room"
						>
							<option value=""></option>
<%perl>
							my $all_rooms_sth = $dbh->prepare("
								select room.id, room.name, room.quality, site.name
								from site, tourn_site, room
								where tourn_site.tourn = ?
									and tourn_site.site = room.site
									and tourn_site.site = site.id
									and room.deleted = 0
								order by site.name, room.name
							");

							$all_rooms_sth->execute($tourn->id);

							while(
								my (
									$room_id, $room_name, $room_quality, $site_name
								) = $all_rooms_sth->fetchrow_array()
							) {
</%perl>
								<option
									value="<% $room_id %>"
								><% $room_name %> - <% $room_quality %> <% $site_name %></option>
%							}
						</select>
					</span>

					<span class="sixth">
						<button
							class = "buttonwhite bluetext fa fa-lg fa-plus"
						></button>
					</span>
				</div>
			</form>

			<p class="padno semibold greentext">
				Move this
					<% $event_type eq "speech" ? "Section" : "" %>
					<% $event_type eq "congress" ? "Chamber" : "" %>
					<% $event_type ne "speech" && $event_type ne "congress" ? "Debate" : "" %>
				to
			</p>

			<form
				action = "move_panel.mhtml"
				method = "post"
			>
				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel->id %>"
				>

				<div class="row centeralign nospace  flexrow">
					<span class="fivesixths padleft">
						<select
							name  = "round_id"
							data-placeholder = "Select Room"
						>
							<option value=""></option>

%							foreach my $round ($event->rounds) {
								<option
									value="<% $round->id %>"
								><% $round->realname %> </option>
%							}
						</select>
					</span>
					<span class="sixth">
						<button
							class = "buttonwhite bluetext fa fa-lg fa-refresh invert"
						></button>
					</span>
				</div>

			</form>

%			my $warn = "This will delete this section, together with all results and records.  Are you sure?";
			<div class="full marbottom centeralign">
				<a
					class="buttonwhite redtext invert threequarters martopmuchmore centeralign marbottommore bigger"
					href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel->id %>&from=schemat"
					<& "/funclib/confirm.mas", warn => $warn &>
				>
					Delete This
						<% $event_type eq "speech" ? "Section" : "" %>
						<% $event_type eq "congress" ? "Chamber" : "" %>
						<% $event_type ne "speech" && $event_type ne "congress" ? "Debate" : "" %>
				</a>
			</div>
		</div>
%		}
	</div>

