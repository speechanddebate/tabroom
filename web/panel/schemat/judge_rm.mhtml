<%args>
	$fine => undef
	$judge_id => undef
	$panel_id => undef
	$tourn
	$account
	$pre => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	my @ballots = Tab::Ballot->search( panel => $panel->id, judge => $judge->id );

	# Clear any existing ranks and stuff
	my @values = $m->comp("/funclib/panel_ballot_values.mas", panel => $panel, judge => $judge);
	foreach my $value (@values) { 
		$value->delete;
	}

	my @all = $m->comp("/funclib/panel_judges.mas", panel => $panel);

	if (scalar @all == 1) { 

		foreach my $ballot (@ballots) { 
			$ballot->judge('');
			$ballot->audit('');
			$ballot->collected('');
			$ballot->collected_by('');
			$ballot->cat_id('');
			$ballot->update;
		}


	} else { 

		foreach my $ballot (@ballots) { 
			$ballot->delete;
		}

	}

	if ($fine) { 

		my $reason = "Judge ".substr($judge->first,0,1)." ".$judge->last." ".$panel->round->realname." of ".$panel->round->event->abbr;

		my $fine_amount = $tourn->setting("noshow_judge_fine") if $panel->round->type eq "prelim";
		$fine_amount = $tourn->setting("noshow_judge_fine_elim") unless $panel->round->type eq "prelim";

		if ($tourn->setting("ncfl")) { 

			$reason .= " (".$judge->school->short_name.")";

		    $fine = Tab::RegionFine->create({
				tourn => $tourn->id,
	        	region => $judge->school->region->id,
	        	amount => $fine_amount,
	        	reason => $reason,
				levied_on => $now,
				levied_by => $account->id
	    	});

		} else { 

		    $fine = Tab::SchoolFine->create({
				tourn => $tourn->id,
	        	school => $judge->school->id,
	        	amount => $fine_amount,
	        	reason => $reason,
				levied_on => $now,
				levied_by => $account->id
	    	});

		}

	}

	my $text = "Removed judge ".$judge->first." ".$judge->last." (";
	$text .= $judge->school->short_name if $judge->school;
	$text .= "Hired" unless $judge->school;
	$text .= ") from ".$panel->round->event->name." panel ".$panel->letter." round ".$panel->round->realname;
	$text .= "and fined them ".$fine->amount if $fine;

	my $change = Tab::TournChange->create({ 
		tourn => $tourn->id,
		type => "judge",
		judge => $judge_id,
		text => $text,
		old_panel => $panel->id,
		account => $account->id
	});

	$change->fine($fine->id) if $fine;
	$change->update;

	my $msg = "Judge ".$judge->first." ".$judge->last." has been removed from this panel";
	$msg .= " and fined \$".$fine->amount if $fine;

	$m->redirect("show.mhtml?round_id=".$panel->round->id."&msg=$msg") if $pre;
	$m->redirect("panel_view.mhtml?panel_id=$panel_id&msg=$msg");

</%init>

