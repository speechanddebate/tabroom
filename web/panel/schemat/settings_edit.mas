<%args>
	$round
	$person
	$person_settings
	$tourn
	$tourn_settings
</%args>
<%init>
	
	my $event = $round->event;
	my $event_type = $event->type;

	my %event_settings = $event->all_settings;
	my %round_settings = $round->all_settings;

	$event_type = "debate" 
		if $event_type eq "ld"
		|| $event_type eq "parli"
		|| $event_type eq "pf"
		|| $event_type eq "policy"
		|| $event_type eq "wsdc"
		|| $event_type eq "wudc";

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $switch;

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;

	my $round_type = $round->type;

	my %default_setting = $m->comp(
		"/funclib/default_rating_settings.mas", 
		type => $event->type
	);

	my @jpools = $event->category->jpools;;
	my @rpools = $tourn->rpools;

	my %already;

	my $readonly;

	if ($tourn_settings->{"nsda_district"}) {
		$readonly = 'readonly = "true"';
		undef $readonly if $person->site_admin;
		undef $readonly if $person_settings->{"nsda_admin"};
	}

</%init>

%	if (@jpools || @rpools) { 

		<h4>Pools</h4>

%		if (@jpools) { 

			<span class="pagehalf odd">

				<div class="full">

					<span class="third padleft strong smallish">
						<a 
							class="plain" 
							href="/panel/judge/edit_jpools.mhtml?category_id=<% $event->category->id %>">
							Judge Pools:
						</a>
					</span>

					<span class="twothirds nospace">

%						foreach my $jpool ($round->jpools) { 

%							$already{$jpool->id}++;

							<div class="full marless padless smallish padleft">

								<span class="twothirds nospace">
									<% $jpool->name %>
								</span>

								<span class="third nospace centeralign">

									<a 
										class="buttonwhite fa fa-trash redtext"
										href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&round_id=<% $round->id %>">
									</a>

								</span>

							</div>
%						}
					</span>

				</div>

				<div class="full marno padless even">

					<form action="jpool_add.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span class="third padleft smallish">
						Add Pool:
					</span>

					<span class="twothirds nospace">

						<select 
							name     = "jpool_id"
							onchange = 'this.form.submit()'
							class    = "fixedmed"
						>

							<option value=""></option>
%							foreach my $jpool (@jpools) { 
%								next if $already{$jpool->id}++;
								<option value="<% $jpool->id %>"><% $jpool->name %></option>
%							}
						</select>
					</span>
					</form>

				</div>

			</span>

%		}

%		if (@rpools) { 

			<span class="pagehalf odd">

				<div class="full">

					<span class="third padleft strong smallish">
						<a class="plain" href="/panel/room/edit_rpools.mhtml">
							Room Pools:
						</a>
					</span>

					<span class="twothirds nospace">

%						foreach my $rpool ($round->rpools) { 
%							next unless $rpool;
%							$already{$rpool->id}++;

							<div class="full marless padless smallish">

								<span class="twothirds nospace">
									<% $rpool->name %>
								</span>

								<span class="third nospace centeralign">

									<a 
										class="buttonwhite fa fa-trash redtext marno"
										href="rpool_rm.mhtml?rpool_id=<% $rpool->id %>&round_id=<% $round->id %>"
									>
									</a>

								</span>
							</div>
%						}
					</span>

				</div>

				<div class="full marno padless even">

					<form action="rpool_add.mhtml" method="post">

						<input 
							type  = "hidden"
							name  = "round_id"
							value = "<% $round->id %>"
						>

						<span class="third padleft smallish">
							Add:
						</span>

						<span class="twothirds nospace">

							<select 
								name     = "rpool_id"
								onChange = 'this.form.submit();'
								class    = "fixedmed">

								<option value=""></option>

%								foreach my $rpool (@rpools) { 
%									next if $already{$rpool->id}++;
									<option value="<% $rpool->id %>"><% $rpool->name %></option>
%								}

							</select>
						</span>

					</form>

				</div>
			</span>
%		}

%	}

	<form action="settings_save.mhtml" method="post">
	<input 
		type  = "hidden"
		name  = "round_id"
		value = "<% $round->id %>"
	>

	<h4 class="clear">Pairing & Times</h4>

%		if ($round_type eq "prelim") { 

%			my $seed_order = $round_settings{"tab_seed_priority"};

			<div class="odd pagefull">

				<span class="threefifth">

					<div class="marno">
						Judge Assignment Seed Order
					</div>

					<div class="smallish marno martop">
						List prelim seeding categories in order of importance
						for judge assignments.  Use numbers, not names, and
						separate with commas.  If this confuses you, it's an
						APDA thing.  It confuses me, too.  Just ignore it.
					</div>

					<div class="smaller marno <% $round_settings{"num_judges"} > 1 ? "" : "hidden" %> ">
						List seedings multiple times for paneled prelims.
					</div>
				</span>

				<span class="twofifth rightalign">
					<input 
						type  = "text"
						name  = "tab_seed_priority"
						value = "<% $seed_order %>"
						size  = "32"
					>
				</span>

			</div>

%		}

<%perl>

		unless ($round_type eq "prelim" 
			|| $round_type eq "elim" 
			|| $round_type eq "final"
		) { 

			my $bracket_order = $round_settings{"tab_rating_priority"};

			$bracket_order = $default_setting{$round->name} unless $bracket_order;

</%perl>
			<div class="odd pagefull">

				<span class="threefifth">

					<div class="marno">
						Judge Assignment Bracket Order
					</div>

					<div class="smaller marno padtop">
						<% $event->type eq "wudc" 
							? "List brackets by points earned" 
							: "List brackets by number of wins" 
						%>. Separate with commas.
					</div>

					<div class="smaller marno <% $round_settings{"num_judges"} > 1 ? "" : "hidden" %> ">
						List brackets multiple times for paneled prelims
					</div>
				</span>

				<span class="twofifth rightalign">
					<input 
						type  = "text"
						name  = "tab_rating_priority"
						value = "<% $bracket_order %>"
						size  = "32"
					>
				</span>

			</div>
%		}

		<span class="pagehalf">

            <div class="row">
				<span class="half">
					Round Label <br />
					Default is "Round <% $round->name %>"
				</span>

				<span class="half rightalign">
					<input 
						type        = "text"
						name        = "label"
						size        = "17"
						placeholder = "Round <% $round->name %>"
						value       = "<% $round->label %>"
					>
				</span>
			</div>


            <div class="row">

                <span class="half">
					Round Type
                </span>

				<span class="half rightalign"> 

%					if ($readonly) { 

						<input 
							type  = "hidden"
							name  = "type"
							value = "<% $round_type %>"
						>

						<span class="full centeralign marless">
							<% ucfirst($round_type) %>
						</span>

%					} else { 

						<select 
							name     = "type"
							class    = "fixedsmall"
						>

							<option
								value="prelim" 
								<% ( $round_type eq "prelim") ? "selected" : "" %> 
							> Prelim/Preset </option>

							<option 
								value="highlow" 
								<% ( $round_type eq "highlow") ? "selected" : "" %> 
							> Hi/Lo </option>   

							<option 
								value="highhigh" 
								<% ( $round_type eq "highhigh") ? "selected" : "" %> 
							> Hi/Hi </option>   

							<option 
								value="elim" 
								<% ( $round_type eq "elim") ? "selected" : "" %> 
							> Elim </option>

							<option 
								value="final" 
								<% ( $round_type eq "final") ? "selected" : "" %> 
							> Final </option>

						</select>
	
%					} 

				</span>
            </div>

            <div class="row">

                <span class="half">
					Time Block
                </span>

				<span class="half rightalign">

					<select 
						name  = "timeslot"
						class = "fixedsmall chosen"
					>

%						foreach my $timeslot ($tourn->timeslots) { 

%							my $start = $timeslot->start->set_time_zone($tz);

							<option 
								value="<% $timeslot->id %>" 
								<% $timeslot->id == $round->timeslot->id ? "selected" : "" %>
							> <% $timeslot->name %> &ndash; <% Tab::niceshortdayt($start) %> </option>
%						}
					</select>
				</span>
            </div>

            <div class="row">
                <span class="half">
					Number of flights
                </span>
				<span class="half rightalign">
					<select 
						name="flighted" 
						class="fixedsmall"
					>

						<option 
							value="1"  
							<% $round->flighted == 1 ? "selected" : "" %> 
						>Single</option>

						<option 
							value="2"  
							<% $round->flighted == 2 ? "selected" : "" %>
						>Double</option>

						<option 
							value="3"  
							<% $round->flighted == 3 ? "selected" : "" %>
						>Triple</option>

					</select>
				</span>
			</div>

            <div class="row">

                <span class="half">
					Seeding tiebreakers 
                </span>
				<span class="half rightalign">

%					if ($readonly) { 

						<input 
							type  = "hidden"
							name  = "tiebreak_set"
							value = "<% $round->tiebreak_set ? $round->tiebreak_set->id : "" %>"
						>

						<span class="full centeralign marless">
							<% $round->tiebreak_set ? $round->tiebreak_set->name : "NONE!" %>
						</span>

%					} else { 

						<select 
							name  = "tiebreak_set"
							class = "fixedsmall"
						>

%							foreach my $tiebreak_set ($tourn->tiebreak_sets) { 
								<option 
									value="<% $tiebreak_set->id %>"  
									<% $round && $round->tiebreak_set == $tiebreak_set ? "selected" : "" %> 
								><% $tiebreak_set->name %></option>
%							}
						</select>
%					}
				</span>
			</div>

%			if ($event_type eq "debate") { 

				<div class="row">

					<span class="half">
						Sidelock against round
					</span>

					<span class="half rightalign">
						<select name="sidelock_against" class="fixedsmall chosen">

%							my $sidelock_against = $round_settings{'sidelock_against'} if $round;

							<option value="">Default (previous)</option>

							<option 
								value="NONE" 
								<% $sidelock_against eq "NONE" ? 'selected="selected"' : "" %>
							>Do Not Sidelock</option>

%							foreach my $sa_round ($event->rounds) { 

%								next if $round->name < $sa_round->name; 

								<option 
									value="<% $sa_round->id %>"  
									<% $sidelock_against  == $sa_round->id ? "selected" : "" %> 
								><% $sa_round->realname %></option>
%							}
						</select>
					</span>

				</div>

%			} 

%			if ($event->type eq "wsdc") { 

%				my $round_prep = $round_settings{'wsdc_round_type'};

				<div class="row">

					<span class="third nospace">
						Type of round
					</span>

					<label for="prepped">
						<span class="third hover">
							<input 
								type  = "radio"
								id    = "prepped"
								name  = "wsdc_round_type"
								value = "prepped"
								<% $round_prep eq "prepped" ? 'checked="checked"' : "" %>
							> Prepared
						</span>
					</label>

					<label for="impromptu">
						<span class="third hover">
							<input 
								type  = "radio"
								id    = "impromptu"
								name  = "wsdc_round_type"
								value = "impromptu"
								<% $round_prep eq "impromptu" ? 'checked="checked"' : "" %>
							> Impromptu
						</span>
					</label>
					
				</div>

%			}

%			if ($event_settings{'breakouts'}) { 

				<div class="row">

					<span class="half">
						Breakout for:
					</span>
					<span class="half rightalign">

						<select 
							name  = "use_for_breakout"
							class = "fixedsmall chosen"
						>

							<option value="">None</option>

%							foreach my $breakout (1 .. $event_settings{"breakouts"}) {

%								next if $event_settings{"breakout_".$breakout."_delete"};

								<option value="<% $breakout %>" <% $round_settings{"use_for_breakout"} == $breakout ? 'selected="selected"' : ""%>>
									<% $event_settings{"breakout_".$breakout."_label"} %>
								</option>
%							}
						</select>
					</span>
				</div>
%			}


		</span>

%		undef $switch;

		<span class="pagehalf">

            <div class="row">
                <span class="half">
					Number of judges per panel
                </span>
				<span class="half rightalign">
					<input 

						<% $readonly %>
						type  = "number"
						name  = "judges"
						min   = 0
						max   = 999
						class = "larger"
						size  = 12
						value = "<% $round_settings{"num_judges"} %>"
					>
				</span>
			</div>


            <div class="row">
                <span class="half">
					Start Time on pairings
                </span>
				<span class="half rightalign">
					<& "/funclib/timepicker.mas", 
						name => "start_time",
						time => $start,
						size => 12 
					&>
				</span>
            </div>

%			if ($round->flighted > 1) { 

				<div class="row">
					<span class="threefifth">
						<div class="marno">
							Round length in minutes
						</div>
						<div class="full nospace smallish explain">
							Offsets start time on Flt B ballots
						</div>
					</span>
					<span class="twofifth rightalign">
						<input 
							type  = "number"
							name  = "offset"
							min   = 0
							max   = 999
							size  = "12"
							class = "larger"
							value = "<% $event_settings{"flight_offset"} %>"
						>
					</span>
				</div>
%			} 

%			if ($event_type ne "speech" && $event_type ne "congress") { 

				<label for="reset_room_moves">
					<div class="hover row">
						<span class="threequarter">
							Do not minimize room moves
						</span>
						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "reset_room_moves"
								id    = "reset_room_moves"
								value = "1"
								<% $round_settings{"reset_room_moves"} ? 'checked="checked"' : "" %>
							>
						</span>
					</div>
				</label>

				<label for="flight_rooms_only">
				<div class="row hover">
					<span class="threequarter">
						Flight rooms but not judging
					</span>
					<span class="quarter rightalign">
						<input 
							type  = "checkbox"
							name  = "flight_rooms_only"
							id    = "flight_rooms_only"
							value = "1"
							<% $event_settings{"flight_rooms_only"} ? 'checked="checked"' : "" %>
						>
					</span>
				</div>
				</label>

				<label for="include_room_notes">
				<div class="row hover">
					<span class="threequarter">
						Include room notes on pairings
					</span>
					<span class="quarter rightalign">
						<input
							type  = "checkbox"
							name  = "include_room_notes"
							id    = "include_room_notes"
							value = "1"
							<% $round_settings{"include_room_notes"} ? 'checked="checked"' : "" %>
						>
					</span>
				</div>
				</label>

%				if ($round_type eq "elim" || $round_type eq "final") { 
					<label for="omit_from_bracket">
						<div class="row hover">
							<span class="threequarter">
								Omit from brackets
							</span>
							<span class="quarter rightalign">
								<input 
									type  = "checkbox"
									name  = "omit_from_bracket"
									id    = "omit_from_bracket"
									value = "1"
									<% $round_settings{"omit_from_bracket"} ? 'checked="checked"' : "" %>
								>
							</span>
						</div>
					</label>
%				}

				<label for="ignore_results">
					<div class="hover row">

						<span class="threequarter smallish padleft">
							I'm talking about practice, not a game. <br />
							Ignore this round's results
						</span>

						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "ignore_results"
								id    = "ignore_results"
								value = "1"
								<% $round_settings{'ignore_results'} ? 'checked="checked"' : "" %>
							>
						</span>
					</div>
				</label>
%			}

		</span>

		<div class="liblrow rightalign">
			<input type="submit" value="Save Round Settings">
		</div>


	<h4>Labels and Information</h4>


		<& /funclib/editor.mas &>

		<div class="odd block">

			<span class="third">
				Message on pairing/posting
			</span>

			<span class="twothird">
				<input 
					type  = "text"
					name  = "notes"
					value = "<% $round_settings{"notes"} %>"
					size  = "55"
				>
			</span>

		</div>

%		if ($event_type ne "speech" && $event_type ne "congress") { 

			<div class="even block">

				<span class="third">
					Resolution/Motion
				</span>

				<span class="twothird">
					<input 
						type  = "text"
						name  = "motion"
						value = "<% $round_settings{"motion"} %>"
						size  = "55"
					>
				</span>

			</div>
%		}

		<h4>Message/Rules for Ballots</h4>

		<span class="block centeralign even">
			<textarea 
				name = "ballot_rules"
				rows = 10
				cols = "80"
				wrap = "virtual"
			><% $event_settings{"ballot_rules"} %></textarea>
		</span>

		<div class="liblrow rightalign">
			<input type="submit" value="Save Round Settings">
			</form>
		</div>

