<%args>
	$tourn
	$account
	$pool_id       => undef
	$group_id      => undef
	$pull_group_id => undef
</%args>
<%init>

	my $pool = Tab::Pool->retrieve($pool_id);
	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);
	my @timeslots = sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots;

	my $switch = 1;
	my $ncfl++ if $tourn->setting("ncfl");

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	unless ($pool) { 
		my @pools = $group->pools;
		$pool = shift @pools if @pools;
	}

</%init>

	<& menu.mas, tourn => $tourn, group => $group, whoami => "pool", pool => $pool &>

	<div class="main">

%		unless ($group) { 

			<h2>Choose a judge group at right</h2>
	
%		} elsif (not defined $pool)  { 

			<h2><% $group->name %></h2>
			
			<& tabbar.mas, group => $group, whoami => "pools" &>

			<h4>Choose a pool at right</h4>

%		} else {

			<h2><% $group->name %></h2>
			
			<& tabbar.mas, group => $group, whoami => "pools" &>

			<form action="pool.mhtml#judges" method="post">
			<input type="hidden" name="pool_id" value="<% $pool->id %>">
			<input type="hidden" name="group_id" value="<% $group->id %>">

			<div class="block nospace odd">

				<span class="half">
					<h4>Judges for <% $pool->name %></h4>
				</span>

				<span class="half rightalign ">

					<span class="third">
						Pull from
					</span>

					<span class="twothirds nospace">
						<select name="pull_group_id" onchange='this.form.submit()' class="fixedsmall chosen">
%							foreach my $group ($tourn->groups) { 
								<option value="<% $group->id %>" <% $group->id == $pull_group_id ? "selected" : "" %> >
									<% $group->name %>
								</option>
%							} 
						</select>
					</span>
				</span>

				</form>

			</div>

<%perl>
			my @pool_judges = $m->comp("/funclib/pool_judges.mas", pool => $pool);
			my $no_codes = $group->setting("no_codes");

			my $pull_group = Tab::JudgeGroup->retrieve($pull_group_id) if $pull_group_id;
			$pull_group = $group unless $pull_group;

			my @judges = $m->comp("/funclib/group_judges.mas", group => $pull_group);

			my %struck_judges;

			if ($pool->standby && $pool->standby_timeslot) { 

				Tab::Judge->set_sql( struck => "
					select distinct judge.id
					from judge, strike, timeslot
					where judge.id = strike.judge
					and strike.start < timeslot.end
					and strike.end > timeslot.start
					and timeslot.id = ? 
				");

				my @struck_out = Tab::Judge->search_struck($pool->standby_timeslot->id);
				%struck_judges = map {$_->id => 1} @struck_out;
			}

</%perl>


			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.judge").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"1", pool_id:"<% $pool->id %>" },
								success: function(data) { 
									$(spanstring).removeClass('even').addClass('blue');
								}

							});
						} else {
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"0", pool_id:"<% $pool->id %>" },
								success: function(data){ 
									$(spanstring).removeClass('blue').addClass('even');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

			<div class="half">

				<h4><% scalar @pool_judges %> in pool:</h4>

%				foreach my $judge (@pool_judges) { 

%					next if $struck_judges{$judge};

%					$used{$judge->id}++;
%					my $rating = $m->comp("/funclib/judge_avg_rating.mas", judge => $judge);

					<label for="<% $judge->id %>">
					<div class="full blue" id="span_<% $judge->id %>">

						<span class="half">
							<% $judge->first." ".$judge->last %>
%							unless ($no_codes) { 
								<span class="full smaller">
									<% $judge->code %> 
								</span>
%							}
						</span>

						<span class="half nospace">
							<span class="threequarters smaller marno padless">

								<div class="full padno marno nowrap">
%									if ($ncfl) { 
										<% $judge->school->region->code." - ".$judge->school->region->name%>
%									}
									<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
								</div>

								<div class="full padno marno">
									<% $judge->judge_group->abbr %> 
									<% $rating ? " $rating " : "" %> 
									<% $judge->tab_rating ? $judge->tab_rating : "" %> 
								</div>

							</span>

							<span class="quarter centeralign">
								<input type="checkbox" class="judge" id="<% $judge->id %>" name="<% $judge->id %>" value="1" checked="checked">
							</span>

						</span>

					</div>
					</label>

%				}

			</div>

%			if ($pull_group) { 

%				my %rating;
%				foreach my $judge (@judges) { 
%					$rating{$judge} = $m->comp("/funclib/judge_avg_rating.mas", judge => $judge);
%				}

%				@judges = sort {$a->tab_rating <=> $b->tab_rating} @judges;
%				@judges = sort {$rating{$a} <=> $rating{$b}} @judges;

				<div class="half">

					<h4><% scalar @judges %> <% $pull_group->abbr %> judges:</h4>

%					foreach my $judge (@judges) { 

%						next if $struck_judges{$judge};

%						next if $used{$judge->id};

						<label for="<% $judge->id %>">
						<span class="full even" id="span_<% $judge->id %>">

							<span class="half">

								<% $judge->first." ".$judge->last %>

%								unless ($no_codes) { 
									<span class="full smaller">
										<% $judge->code %> 
									</span>
%								}

							</span>

							<span class="half nospace">
								<span class="threequarter smaller marno padless">
									<div class="full padno marno nowrap">
%										if ($ncfl) { 
											<% $judge->school->region->code." - ".$judge->school->region->name%>
%										}
										<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
									</div>
									<div class="full padno marno">
										<% $judge->judge_group->abbr %> 
										<% $rating{$judge->id} ? " - $rating{$judge->id} " : "" %> 
										<% $judge->tab_rating ? $judge->tab_rating : "" %> 
									</div>
								</span>

								<span class="quarter centeralign">
									<input type="checkbox" class="judge" id="<% $judge->id %>" name="<% $judge->id %>" value="1">
								</span>
							</span>

						</span>
						</label>
%					}

				</div>
%			}
%		}

	</div>

