<%args>
	$person
	$jpool_id
	$message => undef
	$blast   => undef
	$tourn
	$tourn_settings
	$perms
	$session
	$defaults
	$only_category => undef
</%args>
<%init>

	my $event_id;
	my $category_id;

    my ($event, $eventsref,
        $category, $categoriesref,
        $jpool, $jpoolsref, $jpool_settingsref,
        $childrenref) = $m->comp("pools.mas",
            tourn       => $tourn,
            session     => $session,
            defaults    => $defaults,
            nsda_nats   => $tourn_settings->{"nsda_nats"},
            perms       => $perms,
            jpool_id    => $jpool_id,
            event_id    => $event_id,
            category_id => $category_id,
        );

	unless ($jpool) {
		$m->comp("/funclib/abort.mas", message => "No judge pool found for ID $jpool_id");
	}

	if ($only_category && ($jpool->category != $only_category)) {
		$m->comp("/funclib/abort.mas", message => "You do not have permission to blast that category");
	}

	my $sent;
	my $msg;

	if ($message) {

		my $email;
		$email++ unless $blast;

		my @emails = $m->comp("/funclib/judge_follower.mas",
			jpool       => $jpool->id,
			person_only => 1,
			emails      => $email
		);

		my $subject = "Message to judge pool ".$jpool->name;

		if ($email) {

		    $message = $message."\n-----------------------------<br />\n";
			$message = $message."Email sent to:\n";
			$message = $message." Judges in pool ".$jpool->name."\n\n ";

			$m->comp( "/funclib/send_email.mas",
				from    => $person,
				array   => \@emails,
				subject => $subject,
				body    => $message
			);

			$msg = "Email sent to ".scalar @emails." recipients";

		} else {

			$message = substr($message, 0, 150);

		    $m->comp( "/funclib/send_notify.mas",
				from    => $person->email,
				array   => \@emails,
				subject => $subject,
				body    => $message
			);

			$msg = "Blast sent to ".scalar @emails." recipients";
		}

		$sent++;
	}

	$category = $jpool->category;
	my $nats_category++;
	$nats_category++ if $category->setting("nats_category");

</%init>

%	if ($sent) {

		<script>

			$(document).ready(function() {
				alertify.notify("<% $msg %>", "custom");
			});

		</script>

%	}

	<& "menu.mas",
		tourn             => $tourn,
		tourn_settings    => $tourn_settings,
		perms             => $perms,
		category          => $jpool->category,
		whoami            => "jpool",
		jpool             => $jpool,
		only_category     => $only_category,
		nats_category     => $nats_category,
        eventsref         => $eventsref,
        childrenref       => $childrenref,
        categoriesref     => $categoriesref,
        jpoolsref         => $jpoolsref,
        jpool_settingsref => $jpool_settingsref,
		blastme           => 1
	&>


	<div class="main">

		<h4>Blast Judge Pool <% $jpool->name %></h4>

		<form action="blast_jpool.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "jpool_id"
			value = "<% $jpool_id %>"
		>

		<div class="row full marno">
			<span class="quarter semibold bluetext">
				Message:
			</span>

			<span class="threequarters">
				<textarea
					name="message"
					rows="3"
					cols="64"
				></textarea>
			</span>
		</div>

		<div class="row full marno">
			<span class="quarter semibold bluetext">
				Send as
			</span>

			<span class="threequarters">
				<label for="blast">
					<span
						class = "half hover"
						title = "Blast messages will go as texts and emails and are limited to 150 letters"
					>
						Blast (Text/Emails)*
						<input
							type  = "radio"
							name  = "blast"
							id    = "blast"
							value = "1"
							checked
						>
					</span>
				</label>
				<label for="email">
					<span class="half hover">
						Email Only
						<input
							type  = "radio"
							name  = "blast"
							id    = "email"
							value = "0"
							checked
						>
					</span>
				</label>
			</span>
		</div>

		<div class="full row semibold redtext centeralign nospace">
			<p>*Text blast notices are limited to 150 characters because of some carrier's limits.</p>
			<p>But with email only, go ahead, write a novel.</p>
		</div>

		<div class="libl row rightalign">
			<span class="quarter rightalign">
				<input
					type="submit"
					value="Send Message"
				>
			</span>
		</div>

	</div>
