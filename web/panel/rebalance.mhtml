<%args>
	$round_id
	$tourn
	$league
	$more => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);

	my @all_panels = $round->panels;

	my %panels_by_size = ();

	foreach my $panel (@all_panels) {
		my @comps = $panel->comps;
		my $num_comps = scalar @comps;
		push (@{$panels_by_size{ $num_comps }}, $panel);
	}

	my @sizes = sort {$a <=> $b} keys %panels_by_size;

	my $largest = pop @sizes;
	my $smallest = shift @sizes;
	my $switch;

</%init>

	<div id="rightsmall">

		<a class="blueblock" href="schemat_show.mhtml?round_id=<% $round->id %>">Return to Schematic</a>
		<a class="blueblock" href="dagnabit.mhtml?round_id=<% $round->id %>">Return to Disaster Check</a>
		<hr>
		<a class="redblock" href="rebalance.mhtml?more=yessir&round_id=<% $round->id %>">Show more kids as options</a>

		<a class="redblock" href="panel_balance.mhtml?round_id=<% $round->id %>">Balance Automatically</a>

		<h3>Explanation:</h3>

		<p>The score furthest left is the total number of school hits + double
		hits moving the student selected would cause.  Choose the lowest score
		you can </p>

		<hr>

	</div>

	<div id="leftbig">

		<h2>Short sections for <% $round->event->abbr." ".$round->name %></h2>


<%perl>
		if ($largest > $smallest + 1) { 
	
			foreach my $panel (@{$panels_by_size{$smallest}}) { 

				my @largest = @{$panels_by_size{$largest}};

				if ($more) { 
					push (@largest, @{$panels_by_size{$largest - 1}});
				}

				my @comps;

				foreach my $large (@largest) { 
					push (@comps, $large->comps);
				}

				my %comps_by_score = ();

				foreach my $comp (@comps) {   
					my $score = $panel->score($comp);
					$comps_by_score{$comp->id} = $score;
				}

				@comps = sort {$comps_by_score{$a->id} <=> $comps_by_score{$b->id}} @comps;
				@comps = sort {$comps_by_score{$a->id} <=> $comps_by_score{$b->id}} @comps;
	
</%perl>
			
				<h3>Section: <% $panel->letter %> Room: <% $panel->room->name %></h3>
			
				<p class="smaller">Choose a kid to move into this section:</p>
			
				<table cellpadding="3" cellspacing="1" width="100%">

					<tr class="liblrow">
						
						<th>
							Competitor
						</th>

						<th <% ($league->diocese_based) ? "colspan=\"2\"" : "" %> >
							School
						</th>

						<th class="smaller">
							Current Room
						</th>

						<th class="smaller" colspan="2">
							Score
						</th>

					</tr>

%					foreach my $comp (@comps) { 

%						my $clean++ if $panel->clean_judges($comp);
%     					my $block = "whiteblock";
%						my $current = $comp->panel_in_round($round);
								
%						if ($clean) { 
							<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%						} else { 
							<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%						} 

							<td class="smaller"> 
								<a href="/register/comp_edit.mhtml?comp_id=<% $comp->id %>" class="<% $block %>">
									<% $comp->code %> 
									<% $comp->team_name %>
								</a>
							</td>

							<td class="smaller"> 
								<% $comp->school->short_name %>
							</td>

%							if ($league->diocese_based) { 
								<td class="smaller"> 
									<a href="/register/diocese/index.mhtml?diocese_id=<% $comp->school->region->id %>" class="<% $block %>">
									<% ($comp->school->region) ? substr($comp->school->region->name,0,20)." (".$comp->school->region->code.")" : "" %>
									</a>
								</td>
%							}

							<td class="smaller">
								<a href="panel_view.mhtml?panel_id=<% $current->id %>" class="<% $block %>">
									<% ($current->room) ? $current->room->name : "" %>
								</a>
							</td>

							<td class="smaller" align="center">
								<% $comps_by_score{$comp->id} %>
							</td>

							<td class="smaller" align="center">
%								if ($clean) { 
									<a href="comp_move.mas?comp_id=<% $comp->id %>&panel_id=<% $panel->id %>&back=rebalance" class="<% $block %>">
										Move	
									</a>
%								} else { 
									Judge<br />
									Conflict
%								}

							</td>

						</tr>

%					} 
					
				</table>

%			} 

%		} #end of foreach panel

	</div>

	<br style="clear: both;">
