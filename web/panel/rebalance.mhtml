<%args>
	$round_id
	$tourn
	$circuit
	$more => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);

	my @all_panels = $round->panels;

	my %panels_by_size = ();

	foreach my $panel (@all_panels) {
		my @entries = $panel->entries;
		my $num_entries = scalar @entries;
		push (@{$panels_by_size{ $num_entries }}, $panel);
	}

	my @sizes = sort {$a <=> $b} keys %panels_by_size;

	my $largest = pop @sizes;
	my $smallest = shift @sizes;
	my $switch;

</%init>

	<div class="right small">

		<a class="blue block" href="schemat_show.mhtml?round_id=<% $round->id %>">Return to Schematic</a>
		<a class="blue block" href="dagnabit.mhtml?round_id=<% $round->id %>">Return to Disaster Check</a>
		<hr>
		<a class="red block" href="rebalance.mhtml?more=yessir&round_id=<% $round->id %>">Show more kids as options</a>

		<a class="red block" href="panel_balance.mhtml?round_id=<% $round->id %>">Balance Automatically</a>

		<h3>Explanation:</h3>

		<p>The score furthest left is the total number of school hits + double
		hits moving the student selected would cause.  Choose the lowest score
		you can </p>

		<hr>

	</div>

	<div class="left huge">

		<h2>Short sections for <% $round->event->abbr." ".$round->name %></h2>


<%perl>
		if ($largest > $smallest + 1) { 
	
			foreach my $panel (@{$panels_by_size{$smallest}}) { 

				my @largest = @{$panels_by_size{$largest}};

				if ($more) { 
					push (@largest, @{$panels_by_size{$largest - 1}});
				}

				my @entries;

				foreach my $large (@largest) { 
					push (@entries, $large->entries);
				}

				my %entries_by_score = ();

				foreach my $entry (@entries) {   
					my $score = $panel->score($entry);
					$entries_by_score{$entry->id} = $score;
				}

				@entries = sort {$entries_by_score{$a->id} <=> $entries_by_score{$b->id}} @entries;
				@entries = sort {$entries_by_score{$a->id} <=> $entries_by_score{$b->id}} @entries;
	
</%perl>
			
				<h3>Section: <% $panel->letter %> Room: <% $panel->room->name %></h3>
			
				<p class="smaller">Choose a kid to move into this section:</p>
			
				<table cellpadding="3" cellspacing="1" width="100%">

					<tr class="liblrow">
						
						<th>
							Entryetitor
						</th>

						<th <% ($circuit->diocese_based) ? "colspan=\"2\"" : "" %> >
							School
						</th>

						<th class="smaller">
							Current Room
						</th>

						<th class="smaller" colspan="2">
							Score
						</th>

					</tr>

%					foreach my $entry (@entries) { 

%						my $clean++ if $panel->clean_judges($entry);
%     					my $block = "whiteblock";
%						my $current = $entry->panel_in_round($round);
								
%						if ($clean) { 
							<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%						} else { 
							<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%						} 

							<td class="smaller"> 
								<a href="/register/entry_edit.mhtml?entry_id=<% $entry->id %>" class="<% $block %>">
									<% $entry->code %> 
									<% $entry->team_name %>
								</a>
							</td>

							<td class="smaller"> 
								<% $entry->school->short_name %>
							</td>

%							if ($circuit->diocese_based) { 
								<td class="smaller"> 
									<a href="/register/diocese/index.mhtml?diocese_id=<% $entry->school->region->id %>" class="<% $block %>">
									<% ($entry->school->region) ? substr($entry->school->region->name,0,20)." (".$entry->school->region->code.")" : "" %>
									</a>
								</td>
%							}

							<td class="smaller">
								<a href="panel_view.mhtml?panel_id=<% $current->id %>" class="<% $block %>">
									<% ($current->room) ? $current->room->name : "" %>
								</a>
							</td>

							<td class="smaller" align="center">
								<% $entries_by_score{$entry->id} %>
							</td>

							<td class="smaller" align="center">
%								if ($clean) { 
									<a href="entry_move.mas?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>&back=rebalance" class="<% $block %>">
										Move	
									</a>
%								} else { 
									Judge<br />
									Conflict
%								}

							</td>

						</tr>

%					} 
					
				</table>

%			} 

%		} #end of foreach panel

	</div>

	<br style="clear: both;">
