<%args>
	$tourn
	$circuit
	$session
	$rooms => undef
	$judges => undef
</%args>
<%perl>

$m->print("<h3>Paneling all the unpanelled events...</h3>");

$m->flush_buffer;

my @judge_groups;


foreach my $event (sort {$a->name cmp $b->name} $tourn->events) {

	next unless $ARGS{"do_".$event->id};

	push (@judge_groups, $event->judge_group);

	$m->print("<p>Paneling ".$event->name.".....");
	$m->flush_buffer;

	my $num_competitors = $event->comps;

	my $paneler = "panel_speech_large.mhtml" if $num_competitors > 30;
	$paneler = "panel_speech_small.mhtml" if $num_competitors <= 30;
	$paneler = "panel_speech_small.mhtml" if $circuit->diocese_based;

	$paneler = "panel_congress.mas" if $event->type eq "congress";
	
	next if $event->panels( type => "prelim");
	next if $event->type eq "debate";

	my $num_panels = $ARGS{"num_of_panels_".$event->id};

	$m->comp( $paneler,  circuit => $circuit, tourn => $tourn, event_id => $event->id, number_of_panels => $num_panels, return => 1 );

	$m->print("...setting speaker order....");
	$m->flush_buffer;

	$m->comp( "speaker_order.mas", tourn => $tourn, event_id => $event->id, return => 1 );

	$m->print("...done</p>");

	$m->flush_buffer;

}

if ($rooms) { 

	$m->print("<h4>Assigning rooms....");

	$m->comp( "rooms_autoassign.mas",  tourn => $tourn, which_rooms => "prelims", return => 1);

	$m->print("...done</h4>");

	$m->flush_buffer;

}

if ($judges) { 

	my %seen = ();
	#uniq the judge group
	@judge_groups = grep { ! $seen{$_->id} ++ } @judge_groups;

	$m->print("<h4>Assigning judges (this takes a while)....");
	$m->flush_buffer;

	foreach my $group (@judge_groups) {

		$m->comp( "judges_panel.mas", 
				session => $session, 
				circuit => $circuit, 
				tourn => $tourn, 
				group_id => $group->id, 
				timeslot => "prelims", 
				return => 1);

		$m->print("...evening out judge assignments....");
		$m->flush_buffer;

		$m->comp("judges_unscrew_over.mas", 
			group_id => $group->id, 
			session => $session, 
			return => 1);

		$m->flush_buffer;

	}

	$m->print("...done</h4>");
	$m->flush_buffer;

} 

$m->print("<h4>Checking for disasters.....</h4>");
$m->flush_buffer;


</%perl>

<h3>All done</h3>

<a href="<% $Tab::url_prefix %>/panel/dagnabit.mhtml">Disaster Check</a>
