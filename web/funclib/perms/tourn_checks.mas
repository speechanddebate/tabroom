<%args>
	$args
</%args>
<%init>

	my $person = $args->{"person"};

	my $dbh = Tab::DBI->db_Main();
	my $sth;
	my %checks;

	if (
		(not defined $args->{'panel_id'})
		&& $args->{'section_id'}
	) {
		$args->{'panel_id'} = $args->{'section_id'};
	}

	if ($args->{"panel_id"} && $args->{"panel_id"} eq int($args->{"panel_id"})) {

		$checks{test}++;
		$checks{disallow} = "Panel ".$args->{"panel_id"};

		$sth = $dbh->prepare("
			select
				event.tourn,
				event.id event,
				category.id category
			from (panel, round, event, category)
			where panel.id = ?
				and panel.round = round.id
				and round.event = event.id
				and event.category = category.id
		");

		$sth->execute($args->{"panel_id"});

	} elsif ($args->{"round_id"} && $args->{"round_id"} eq int($args->{"round_id"})) {

		$checks{test}++;
		$checks{disallow} = "Round ".$args->{"round_id"};

		$sth = $dbh->prepare("
			select
				event.tourn,
				event.id event,
				category.id category
			from (round, event, category)
			where round.id = ?
				and round.event = event.id
				and event.category = category.id
		");

		$sth->execute($args->{"round_id"});

	} elsif ($args->{"event_id"} && $args->{"event_id"} eq int($args->{"event_id"})) {

		$checks{test}++;
		$checks{disallow} = "Event ".$args->{"event_id"};

		$sth = $dbh->prepare("
			select
				event.tourn,
				event.id event,
				category.id category
			from (event, category)
			where event.id = ?
				and event.category = category.id
		");

		$sth->execute($args->{"event_id"});

	} elsif ($args->{"category_id"} && $args->{"category_id"} eq int($args->{"category_id"})) {

		$checks{test}++;
		$checks{disallow} = "Category ".$args->{"category_id"};

		$sth = $dbh->prepare("
			select category.tourn,
				category.id category
				from (category)
				where category.id = ?
		");

		$sth->execute($args->{"category_id"});

	} elsif ($args->{"school_id"} && $args->{"school_id"} eq int($args->{"school_id"})) {

		$checks{test}++;
		$checks{disallow} = "School ".$args->{"school_id"};

		$sth = $dbh->prepare("
			select
				school.tourn
			from (school)
			where school.id = ?
		");

		$sth->execute($args->{"school_id"});

	} elsif ($args->{"jpool_id"} && $args->{"jpool_id"} eq int($args->{"jpool_id"})) {

		$checks{test}++;
		$checks{disallow} = "Judge Pool ".$args->{"jpool_id"};

		$sth = $dbh->prepare("
			select
				category.tourn,
				category.id category
			from (jpool, category)
			where jpool.id = ?
				and jpool.category = category.id
		");

		$sth->execute($args->{"jpool_id"});

	} elsif ($args->{"tourn_id"} && $args->{"tourn_id"} eq int($args->{"tourn_id"})) {
		$checks{tourn} = $args->{"tourn_id"};
	}

	# Will not work if this is a tournament
	my $result = eval {
		return $sth->fetchall_hash();
	};

	if ($result && scalar @{$result} > 0) {
		my $object = shift @{$result};
		$checks{"tourn"} = $object->{tourn} if $object->{tourn};
		$checks{"event"} = $object->{event} if $object->{event};
		$checks{"category"} = $object->{category} if $object->{category};
	}

	return %checks;

</%init>
