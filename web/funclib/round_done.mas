<%args>
	$round
</%args>
<%init>

	my $now = DateTime->now();

	my @left = $m->comp(
		"/funclib/round_judges.mas",
			round => $round,
			not_in => "1"
	);

	my $judges_left = scalar @left;

	my $event = $round->event;

	#First ballot in notification
	my $first_notified = $event->setting("first_round_notified");

	unless ($ARGS{"admin_done"}) {
		unless ($round->setting("first_ballot")) {
			$round->setting("first_ballot", "date", $now);
		}
		$round->setting("last_ballot", "date", $now);
	}

	if ($first_notified < $round->name) {

		my $follower_ids = $event->setting("followers");
		my $subject = $event->name;

		my $body = "\n\n".$round->realname." of ".$event->name." first ballot entered.  $judges_left  left.\n";

		foreach my $id (split(/,/, $follower_ids)) {

			next unless $id;

			my $person = Tab::Person->retrieve($id);
			next unless $person;
			my $to;

			if ($person->phone && $person->provider) {

				my $phone = $person->phone;
				$phone =~ s/[\D_]//g;
				$to = $phone.'@'.$person->provider;

			} else {
				$to = $person->email;
			}

			$m->comp( "/funclib/send_notify.mas",
				from    => 'Tab Central <live@tabroom.com>',
				to      => $to,
				subject => $subject,
				body    => $body
			);
		}

		$event->setting("first_round_notified", $round->name);

	}

	return if $judges_left > 0;

	# Last ballot in notification

	my $notified = $event->setting("round_notified");

	if ($notified < $round->name) {

		my $follower_ids = $event->setting("followers");
		my $subject = $event->name;
		my $body = "\n\n".$round->realname." of ".$event->name." last ballot entered.\n";

		foreach my $id (split(/,/, $follower_ids)) {

			next unless $id;

			my $person = Tab::Person->retrieve($id);
			next unless $person;
			my $to;

			if ($person->phone && $person->provider) {

				my $phone = $person->phone;
				$phone =~ s/[\D_]//g;
				$to = $phone.'@'.$person->provider;
			} else {
				$to = $person->email;
			}

			$m->comp( "/funclib/send_notify.mas",
				from    => 'Tab Central <live@tabroom.com>',
				to      => $to,
				subject => $subject,
				body    => $body
			);
		}

		$event->setting("round_notified", $round->name);

		#this is driving me UP THE GODDAMNED WALL.

		my @ranks = Tab::Score->search( tag => "", tiebreak => 1);
		my @ballots = Tab::Score->search( tag => "", tiebreak => 2);
		my @points = Tab::Score->search( tag => "", tiebreak => 3);
		my @rfds = Tab::Score->search( tag => "", tiebreak => 4);
		my @comments = Tab::Score->search( tag => "", tiebreak => 5);

		my $return;

		foreach my $rank (@ranks) {
			$rank->tag("rank");
			eval{ $rank->update; };

			my $id = $rank->id;
			undef $rank;
			$rank = Tab::Score->retrieve($id);
			$rank->delete if $rank->tag eq "";
		}

		foreach my $ballot (@ballots) {
			$ballot->tag("ballot");
			eval{ $ballot->update; };

			my $id = $ballot->id;
			undef $ballot;
			$ballot = Tab::Score->retrieve($id);
			$ballot->delete if $ballot->tag eq "";
		}

		foreach my $point (@points) {
			next unless $point;

			$point->tag("points");
			eval{ $point->update; };

			my $id = $point->id;
			undef $point;
			$point = Tab::Score->retrieve($id);
			$point->delete if $point->tag eq "";
		}

		foreach my $rfd (@rfds) {
			$rfd->tag("rfd");
			eval{ $rfd->update; };

			my $id = $rfd->id;
			undef $rfd;
			$rfd = Tab::Score->retrieve($id);
			$rfd->delete if $rfd && $rfd->tag eq "";
		}

		foreach my $comment (@comments) {
			$comment->tag("comment");
			eval{ $comment->update; };

			my $id = $comment->id;
			undef $comment;
			$comment = Tab::Score->retrieve($id);
			$comment->delete if $comment->tag eq "";
		}
	}

	$m->comp(
		"/funclib/auto_backups.mas",
		subject => "Results Posted",
		round   => $round
	);

	return;

</%init>
