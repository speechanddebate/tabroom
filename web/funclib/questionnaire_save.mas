<%args>
	$tag     => undef
	$judge   => undef
	$response => undef
</%args>
<%init>

	use Switch;
	use Data::Dumper;

	return unless $tag;

	$tag =~ s/[\W_]//g;

	my %form = $m->comp(
		"/funclib/questions.mas",
		tag => $tag
	);

	return unless %form;
	my %answers;
	my $blanks;

	foreach my $key (keys %{$form{"questions"}}) {

		my $answer;

		switch ($form{"questions"}{$key}{"type"}) {

			case "string" {
				$answers{$key} = $response->{$key};
			}

			case "textbox" {
				$answers{$key} = $response->{$key};
			}
			case "number" {
				$answers{$key} = $response->{$key};
			}

			case "radio" {
				$answers{$key} = $response->{$key};
			}

			case "boolean" {
				$answers{$key} = $response->{$key};
			}

			case "required" {
				$answers{$key} = $response->{$key};
			}

			case "checkbox" {
				foreach my $answer (@{$form{"questions"}{$key}{"answers"}}) {
					$answers{$key."_".$answer} = $response->{$key."_".$answer};
				}
			}
		}

		unless ( defined($answers{$key})
			|| $form{"questions"}{$key}{"type"} eq "boolean"
			|| $form{"questions"}{$key}{"type"} eq "checkbox"
			|| $form{"questions"}{$key}{"type"} eq "subtitle"
			|| $form{"questions"}{$key}{"type"} eq "title") {

			$blanks++;

		}
	}

	my $json = eval {
		return JSON::encode_json(\%answers);
	};

	$judge->setting("form_".$tag, "text", $json) if $json;

	if ($blanks > 0) {
		$judge->setting("form_complete_".$tag, 0);

	} else {
		$judge->setting("form_complete_".$tag, 1);
	}

	if ($ARGS{"nats"}) {
		$m->comp("/funclib/nsda/judge_nats_check.mas", judge => $judge);
	}

	my $msg = "Answers saved for ".$form{'title'}."!";

	return $msg;

</%init>
