<%args>
	$entry 
	$round     => undef
	$published => undef
	$coach     => undef
</%args>
<%init>

	if ($round && $round->id && $entry && $entry->id) { 

		Tab::Ballot->set_sql( by_round => "
			select distinct ballot.* 
			from ballot, panel
			where ballot.entry = ? 
			and ballot.panel = panel.id
			and panel.round = ?
		");

		return Tab::Ballot->search_by_round($entry->id, $round->id);
	
	} elsif ($entry && $entry->id) { 

		my $limit = " and round.post_results > 0 " if $published;

		my $now = DateTime->now();
		$now->add(days => 2);

		if ($entry->school->tourn->end > $now) { 
			undef $limit;
		}

		Tab::Ballot->set_sql( all_ballots => "
			select distinct ballot.* 
			from ballot, panel, round
			where ballot.entry = ? 
			and ballot.panel = panel.id
			and panel.round = round.id
			$limit
			order by round.name, ballot.judge
		");
		
		my @ballots = Tab::Ballot->search_all_ballots($entry->id);

		if ($coach) { 

			Tab::Ballot->set_sql( all_ballots => "
				select distinct ballot.* 
				from ballot, panel, round
				where ballot.entry = ? 
				and ballot.panel = panel.id
				and panel.round = round.id

				and exists ( 
					select round_setting.id
					from round_setting
					where round_setting.round = round.id
					and (
						round_setting.tag = 'coach_wins'
						or round_setting.tag = 'coach_points'
						or round_setting.tag = 'coach_feedback'
					)
				)
				order by round.name, ballot.judge
			");
			
			push @ballots, Tab::Ballot->search_all_ballots($entry->id);

		}

		my %seen;
		@ballots = grep { ! $seen{$_->id} ++ } @ballots;

		return @ballots;

	} else { 

		return;
	}

</%init>
