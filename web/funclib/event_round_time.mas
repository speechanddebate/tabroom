<%args>
	$event
	$when => undef
</%args>
<%init>

	my $tz = $event->tourn->tz;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);

	if ($when eq "tourntime") { 

		if ($now < $event->tourn->start) { 

			Tab::Round->set_sql( by_event_first => "
				select distinct round.id
					from round, timeslot, panel, ballot, entry
					where round.event = ? 
					and round.id = panel.round
					and panel.id = ballot.panel
					and ballot.entry = entry.id
					and entry.dropped != 1
					order by timeslot.start limit 1
				");

			my ($round) = Tab::Round->search_by_event_first($event->id);
			return $round; 

		} else { 

			Tab::Round->set_sql( by_event_last => "
				select round.id
					from round, timeslot, panel, ballot, entry
					where round.event = ? 
					and round.id = panel.round
					and panel.id = ballot.panel
					and ballot.entry = entry.id
					and entry.dropped != 1
					order by timeslot.start DESC limit 1
				");
	
			my ($round) = Tab::Round->search_by_event_last($event->id);
			return $round;

		} 

	} 

	Tab::Round->set_sql( by_event_and_now => "
		select distinct round.id from round, timeslot
			where round.event = ? 
			and round.timeslot = timeslot.id
			and timeslot.start > NOW()
			and timeslot.end < NOW()
			order by round.name limit 1
	");

	my ($round) = Tab::Round->search_by_event_and_now($event->id);
	return $round;

</%init>

