<%args>
	$text        => undef
	$message     => undef
	$restrictive => undef
</%args>
<%init>

	$text = $message unless $text;
	return unless $text;

	$text =~ s/\r\n\r\n/\r\n/g;
	$text =~ s/\n\n/\n/g;
	$text =~ s/\r\r/\r/g;

	my $scrubber;

	if ($restrictive) {
		$scrubber = HTML::Scrubber->new(
			allow => [ qw[strong b i u] ]
		);

		$text =~ s/<br \/>/\n/g;
		$text =~ s/\n\n/\n/g;
		$text =~ s/\n\n/\n/g;

	} else {
		$scrubber = HTML::Scrubber->new(
			allow => [ qw[p strong b i u hr br ol ul li] ]
		);
	}

	$scrubber->rules(
		img => {
			src => qr{^(?!http://)}i,
			alt => 1,
			'*' => 0,
		},
		a => {
			href => 1,
			'*'  => 0
		}
	);

	$text =~ s/&nbsp;/ /g;
	my $result = $scrubber->scrub($text);

	$result =~ s/<p>\s+<\/p>//g;  #Nonsense
	$result =~ s/<p><\/p>//g;  #Nonsense

	$result =~ s/^\s+//;  # Leading only
	$result =~ s/\s+$//;  # Trailing

	$m->print($result) if $ARGS{"print"};

	return $result;

</%init>
