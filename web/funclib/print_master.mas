<%args>
	$panel_id
	$judge_id
	$filename
</%args>
<%perl>

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	my $tourn = $panel->event->tournament;
	my $league = $tourn->league;
	my $event = $panel->event;

	my $whatto = $tourn->method->master_printouts;

    my $points++ if $tourn->method->tiebreaks(tiebreaker => "points");

	open (TEXOUT, ">>$filename.tex");

	unless ($panel->event->ballot_type eq "cfl") { 

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT "{\\Large ".$panel->event->abbr." ".$panel->letter." - ";
		print TEXOUT "Judge: ";
		print TEXOUT &Tab::texify($judge->school->code)  if $judge->school;
		print TEXOUT &Tab::texify("Hire") unless $judge->school;
		print TEXOUT " ";
		print TEXOUT &Tab::texify($judge->code)." - ";
		print TEXOUT &Tab::texify($judge->first." ".$judge->last)."}";
		print TEXOUT "\\ \n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";

	   	print TEXOUT "\\begin{center}\n";
		print TEXOUT "{\\Large ".&Tab::texify($tourn->name)." } \\\\ \n";

		if ($judge->is_chair($panel)) {
			print TEXOUT "\\bigskip\n {\\Large\\bf CHAIR MASTER BALLOT }\\\\ \n";
		} else {
			print TEXOUT "\\bigskip\n {\\Large\\bf MASTER BALLOT }\\\\ \n";
		}

		print TEXOUT "\\end{center} \n";

		print TEXOUT "\\renewcommand{\\arraystretch}{1.3}\n";
		print TEXOUT "\\begin{center}\n";
#	   	print TEXOUT "\\begin{tabular}{llll}\n";
		print TEXOUT "\\begin{tabular}{p{.5in}p{2.0in}p{.5in}p{3.0in}}\n";
		print TEXOUT "{\\small\\bf Event}: & ".$panel->event->name." & ";
		print TEXOUT "{\\small\\bf Round:} & ".$panel->round->name;
		print TEXOUT " (". &Tab::texify($panel->round->label).")" if $panel->round->label;
		print TEXOUT " \\\\ \n ";
		print TEXOUT "{\\small\\bf Room:} & ";
		print TEXOUT ($panel->room->id) ? &Tab::texify($panel->room->name) : "NO ROOM LISTED ";
		print TEXOUT " & ";

		my $roundstart = $panel->round->timeslot->start;
		$roundstart->set_time_zone($league->timezone);
		my $roundend = $panel->round->timeslot->end;
		$roundend->set_time_zone($league->timezone);

		print TEXOUT "{\\small\\bf Time:} & ";
		print TEXOUT $roundstart->hour_12.":";
		print TEXOUT $roundstart->strftime('%M')." ";
		print TEXOUT $roundstart->strftime('%p')." to ";

		print TEXOUT $roundend->hour_12.":";
		print TEXOUT $roundend->strftime('%M')." ";
		print TEXOUT $roundend->strftime('%p')." \\\\ \n ";

		print TEXOUT "\\end{tabular}\n \\end{center} \n \\medskip \n";
		print TEXOUT "\\begin{center} \n \\large \n";
		print TEXOUT "\\renewcommand{\\arraystretch}{2.2} \n" if $event->type eq "speech";
		print TEXOUT "\\renewcommand{\\arraystretch}{1.5} \n" if $event->type eq "congress";
		print TEXOUT "\\begin{tabular}{|p{4.5in}|p{.75in}|p{.5in}|} \n" if $event->type eq "speech" && not defined $points;
		print TEXOUT "\\begin{tabular}{|p{4in}|p{.75in}|p{.5in}|p{.5in}|} \n" if $event->type eq "speech" && defined $points;
		print TEXOUT "\\begin{tabular}{|p{.5in}|p{2in}|p{3in}|p{.5in}|} \n" if $event->type eq "congress";
		print TEXOUT "\\hline ";
		print TEXOUT " Title/Question &" if $event->type eq "speech" && $whatto eq "titles";
		print TEXOUT " Name &" if ($whatto eq "name_schcode" || $whatto eq "names" || $whatto eq "first") && $event->type ne "Congress";
		print TEXOUT " Competitor & School \\\\ \\hline \n" if $event->type eq "congress";

		print TEXOUT "Code &";

		if (defined $points && $event->type eq "speech") {
			print TEXOUT " Rank & Points \\\\ \\hline \n";
		} else {
			print TEXOUT " Rank \\\\ \\hline \n";
		}
		
		my $count;

		my $doubled;

		foreach my $comp ($panel->comps) {

			my $doublestars;

			foreach ($comp->how_doubled($panel)) { 
				$doublestars .= "*";
			}

			$doubled++ if $doublestars;

			print TEXOUT $comp->student->first." ".$comp->student->last." & ".$comp->school->chapter->name
				if $event->type eq "congress";

			print TEXOUT $comp->school->code." - " if $whatto eq "name_schcode";

			print TEXOUT $comp->student->first
				if $event->team == 1 && $whatto eq "first" && $event->type ne "congress";

			print TEXOUT Tab::texify($comp->team_name)				 
				if $whatto eq "names" && $event->type ne "congress";

			print TEXOUT Tab::texify($comp->team_name)
				if $whatto eq "name_schcode" && $event->type ne "congress";

			print TEXOUT $comp->student->first." \\& ".$comp->partner->first
				if $event->team == 2 && $whatto eq "first" && $event->type ne "congress";

			print TEXOUT $comp->name if $event->team == 3 && $whatto eq "names" && $event->type ne "congress";
			print TEXOUT " & ";
			print TEXOUT $comp->school->code if $tourn->method->schemat_school_code > 0;
			print TEXOUT $comp->code;
			print TEXOUT $doublestars;
			print TEXOUT " & ";
			print TEXOUT " & " if defined $points && $event->type eq "speech";
			print TEXOUT " \\\\ \\hline \n";
			$count++;
		}

		#Fill in extra spaces, up to 7.
		while ($count < 7) {
			print TEXOUT " & " if $event->type eq "congress";
			print TEXOUT " & " if $points && $event->type eq "speech";
			print TEXOUT " & & \\\\ \\hline \n ";
			$count++;
		}

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\end{center}\n";


		print TEXOUT "*Students are double (or triple, etc) entered.  Please accomodate late arrivals, or allow them to leave early.\n "if $doubled;

		print TEXOUT "\\medskip \n "if $doubled;
		print TEXOUT "\\break \n " if $doubled;
		print TEXOUT "\\small \n";
		print TEXOUT "\\flushleft \n";

		if ($judge->is_chair($panel)) {
			print TEXOUT "\\smallskip \n ";
			print TEXOUT &Tab::texify($tourn->chair_ballot_message);
			print TEXOUT "\\break \n ";

			print TEXOUT "\\normalsize {\\bf Other judges:} ";

			foreach my $oj ($panel->judges) {
				next if $oj->id == $judge->id;
				print TEXOUT $oj->code." ".$oj->last." ";
			}

		} else {
			print TEXOUT &Tab::texify($tourn->ballot_message)."\n";
		}

		print TEXOUT "\\normalsize \n";

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT $panel->id."\n";;
		print TEXOUT " \\end{flushright} \n  \\medskip \n";
	}

	if ($panel->event->ballot_type eq "cfl") { 

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT "{\\Large ".$panel->event->abbr." ".$panel->letter." - ";
		print TEXOUT &Tab::texify("(".$judge->school->region->code.")")." " if $league->diocese_based;
		print TEXOUT &Tab::texify($judge->school->code)." " unless $league->diocese_based;
		print TEXOUT &Tab::texify($judge->code)." - ";
		print TEXOUT &Tab::texify($judge->first." ".$judge->last)."} ";
		print TEXOUT "\\\\ \n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";

	   	print TEXOUT "\\begin{center}\n";
		print TEXOUT "{\\Large ".$league->name."} \\\\ \n";
		print TEXOUT "\\medskip\n";
		print TEXOUT "{\\large ".&Tab::texify($tourn->name)." } \\\\ \n";

		if ($judge->is_chair($panel)) {
			print TEXOUT "\\bigskip\n {\\Large\\bf CHAIR MASTER BALLOT }\\\\ \n";
		} else {
			print TEXOUT "\\bigskip\n {\\Large\\bf ".&Tab::texify(uc($event->name))." MASTER BALLOT }\\\\ \n";
		}

		print TEXOUT "\\end{center} \n";
		print TEXOUT "Rules of Procedure:\n\n";

		print TEXOUT $event->text;
		print TEXOUT "\\renewcommand{\\arraystretch}{1.3}\n";
		print TEXOUT "\\begin{center}\n";
#	   	print TEXOUT "\\begin{tabular}{llll}\n";
		print TEXOUT "\\begin{tabular}{p{.5in}p{1.0in}p{.5in}p{1.5in}p{.5in}p{1.5in}}\n";
		print TEXOUT "{\\small\\bf Round:} & ".$panel->round->name;
		print TEXOUT " (". &Tab::texify($panel->round->label).")" if $panel->round->label;
		print TEXOUT "& {\\small\\bf Room:} & ";
		print TEXOUT ($panel->room->id) ? &Tab::texify($panel->room->name) : "NO ROOM";
		print TEXOUT " & ";

		my $roundstart = $panel->round->timeslot->start;
		$roundstart->set_time_zone($league->timezone);
		my $roundend = $panel->round->timeslot->end;
		$roundend->set_time_zone($league->timezone);

		print TEXOUT "{\\small\\bf Time:} & ";
		print TEXOUT $roundstart->hour_12.":";
		print TEXOUT $roundstart->strftime('%M')." ";
		print TEXOUT $roundstart->strftime('%p')." to ";

		print TEXOUT $roundend->hour_12.":";
		print TEXOUT $roundend->strftime('%M')." ";
		print TEXOUT $roundend->strftime('%p')." \\\\ \n ";

		print TEXOUT "\\end{tabular}\n \\end{center} \n \\medskip \n";
		print TEXOUT "\\begin{center} \n \\large \n";
		print TEXOUT "\\renewcommand{\\arraystretch}{2.2} \n" if $event->type eq "speech";
		print TEXOUT "\\renewcommand{\\arraystretch}{1.5} \n" if $event->type eq "congress";
		print TEXOUT "\\begin{tabular}{|p{4.5in}|p{.75in}|p{.5in}|} \n" if $event->type eq "speech" && not defined $points;
		print TEXOUT "\\begin{tabular}{|p{4in}|p{.75in}|p{.5in}|p{.5in}|} \n" if $event->type eq "speech" && defined $points;
		print TEXOUT "\\begin{tabular}{|p{.5in}|p{2in}|p{3in}|p{.5in}|} \n" if $event->type eq "congress";

		print TEXOUT "\\hline ";

		if ($event->type eq "speech") {
			if ($whatto eq "titles") {
				print TEXOUT " Title/Question & ";
			} else { 
				print TEXOUT " Name & ";
			}
		}

		print TEXOUT " Code &";

		print TEXOUT " Competitor & School & Rank \\\\ \\hline \n" if $event->type eq "congress";

		if (defined $points) {
			print TEXOUT " Rank & Points \\\\ \\hline \n" if $event->type eq "speech";
		} else {
			print TEXOUT " Rank \\\\ \\hline \n" if $event->type eq "speech";
		}
		
		my $count;

		foreach my $comp ($panel->comps) {

			my $doublestars;
			foreach ($comp->how_doubled($panel)) { 
				$doublestars .= "*";
			}

			print TEXOUT $comp->student->first." ".$comp->student->last." & ".$comp->school->chapter->name
				if $event->type eq "congress";

			print TEXOUT Tab::texify($comp->team_name) 
				if $whatto eq "name_schcode" && $event->type ne "congress";

			print TEXOUT Tab::texify($comp->team_name) 
				if $whatto eq "names" && $event->type ne "congress";

			print TEXOUT $comp->student->first
				if $event->team == 1 && $whatto eq "first" && $event->type ne "congress";

			print TEXOUT $comp->student->first." \\& ".$comp->partner->first
				if $event->team == 2 && $whatto eq "first" && $event->type ne "congress";

			print TEXOUT " & ";

			print TEXOUT $comp->school->code if $tourn->method->schemat_school_code > 0;
			print TEXOUT $comp->code;
			print TEXOUT &Tab::texify($doublestars);
			print TEXOUT " & ";
			print TEXOUT " & " if defined $points && $event->type eq "speech";
			print TEXOUT " \\\\ \\hline \n";
			$count++;
		}

		#Fill in extra spaces, up to 7.
		while ($count < 7) {
			print TEXOUT " & " if $event->type eq "congress";
			print TEXOUT " & " if $points && $event->type eq "speech";
			print TEXOUT " & & \\\\ \\hline \n ";
			$count++;
		}

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\end{center}\n";

		if ($judge->is_chair($panel)) {
			print TEXOUT $tourn->chair_ballot_message ;
			print TEXOUT "\n\\small {\\bf Other judges:} ";

			foreach my $oj ($panel->judges) {
				next if $oj->id == $judge->id;
				print TEXOUT $oj->code." ".&Tab::texify($oj->last)." ";
			}

			print TEXOUT "\\normalsize\n";

		} else {
			print TEXOUT &Tab::texify($tourn->ballot_message)."\n";
		}

		print TEXOUT "\\begin{flushright} \n";
		print TEXOUT $panel->id."\n";
		print TEXOUT " \\end{flushright} \n  \\medskip \n";
	}

	close (TEXOUT);

</%perl>
