<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

    my $dbh = Tab::DBI->db_Main(); 

    my %school_data;

	my $unconfirmed_sth = $dbh->prepare("
		select school.id, 
			count(entry.id) as pending, 
			DATE_FORMAT(max(entry.created_at), '%c/%e') as last_created
		from school, entry
            where school.id = entry.school
            and school.tourn = ?
            and entry.unconfirmed = 1 
			and school.chapter > 0

            and not exists (
                select es.id 
                from entry_setting es
                where es.tag = 'rejected_by'
                and es.entry = entry.id
            )

            and not exists (
                select supp.id 
                from event_setting supp
                where supp.tag = 'supp'
				and supp.event = entry.event
            )

            and not exists (
                select conn.id 
                from event_setting conn
                where conn.tag = 'conn'
				and conn.event = entry.event
            )

        group by school.id
	");

	$unconfirmed_sth->execute($tourn->id);

    while (
        my ($school_id, $pending, $last_created) = $unconfirmed_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"pending"} = $pending;
		$school_data{$school_id}{"last_created"} = $last_created;
	}

	my $unrejected_sth = $dbh->prepare("
		select school.id, count(entry.id)
			from school, entry
			where school.id = entry.school
			and school.tourn = ? 
			and school.chapter > 0
			and not exists (
				select es.id
				from entry_setting es
				where es.tag = 'rejected_by'
				and es.entry = entry.id
			)
			group by school.id
	");

	$unrejected_sth->execute($tourn->id);

    while (
        my ($school_id, $entry_count) = $unrejected_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"unrejected"} = $entry_count;
	}

	my $incomplete_sth = $dbh->prepare("
		select school.id, count(entry.id)
			from school, entry
			where school.id = entry.school
			and school.tourn = ? 
			and entry.active = 1
			and school.chapter > 0
			and not exists (
				select es.id
				from entry_setting es
				where es.tag = 'status'
				and es.value = 'complete'
				and es.entry = entry.id
			)
			and not exists (
				select evset.id
				from event_setting evset
				where evset.tag = 'supp'
				and evset.event = entry.event
			)
			and not exists (
				select evset.id
				from event_setting evset
				where evset.tag = 'conn'
				and evset.event = entry.event
			)
			group by school.id
	");

	$incomplete_sth->execute($tourn->id);

    while (
        my ($school_id, $entry_count) = $incomplete_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"incomplete"} = $entry_count;
	}

	my $incom_judge_sth = $dbh->prepare("

		select school.id, count(judge.id)
			from school, judge
			where school.id = judge.school
			and school.tourn = ? 
			and school.chapter > 0
			and exists (
				select js.id
				from judge_setting js
				where js.tag = 'incomplete'
				and js.judge = judge.id
			)
			group by school.id
	");

	$incom_judge_sth->execute($tourn->id);

    while (
        my ($school_id, $judge_count) = $incom_judge_sth->fetchrow_array()
    ) {
		$school_data{$school_id}{"incom_judges"} = $judge_count;
	}

	my $school_sth = $dbh->prepare('
		select school.id, school.name, school.state
		from school
		where school.tourn = ? 
		and school.chapter > 0
	');

	$school_sth->execute($tourn->id);

    while (
        my ($school_id, $school_name, $school_state, $contact_name, $contact_email) 
			= $school_sth->fetchrow_array()
    ) {

		$school_data{$school_id}{"name"} = $school_name;
		$school_data{$school_id}{"state"} = $school_state;
		$school_data{$school_id}{"short_name"} = Tab::short_name($school_name);
	}

	return %school_data;

</%init>
