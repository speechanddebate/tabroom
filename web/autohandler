<%args>
	$err           => undef
	$msg           => undef
	$quick         => undef
	$fullmsg       => undef
	$greenmsg      => undef
	$yellowmsg     => undef
	$event_id      => undef
	$only_category => undef
</%args>
<%init>

	my $debug = $Tab::debug;		

	my ($person, $session) = 
		$m->comp( "/user/login/authenticate.mas");

	my $tourn;
	my %tourn_settings;

	if ($session) { 
		#Tournament being managed
		$tourn = $session->tourn;
		%tourn_settings = $tourn->all_settings if $tourn;
	}

	my %person_settings = $person->all_settings if $person;

	my %perms = $person->all_permissions($tourn) if $person;

	if ($person && $person->site_admin) { 
		$perms{"owner"}++;
		undef $perms{"entry_only"};
	}

	my $event = Tab::Event->retrieve($event_id) 
		if ($event_id);

	$event = $session->event 
		if $session 
		&& not defined $event;

</%init>

%	unless ($r->uri =~ /\/api\//) { 

	<!DOCTYPE 
		html 
		PUBLIC 
		"-//W3C//DTD XHTML 1.0 Transitional//EN" 
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"
	>

	<meta 
		http-equiv="Content-Type" 
		content="text/html; charset=utf-8"
	>

	<html>

		<head>

			<link rel="stylesheet" type="text/css" href="/lib/css/reset.css">
			<link rel="stylesheet" type="text/css" href="/lib/css/jqueryui.css">
			<link rel="stylesheet" type="text/css" href="/lib/css/uniform.css">
			<link rel="stylesheet" type="text/css" href="/lib/css/fonts/fonts.css">
			<link rel="stylesheet" type="text/css" href="/lib/css/tabroom.css">

%			if ($r->hostname eq "local.tabroom.com" || $r->hostname eq "dev.tabroom.com") { 

				<link 
					rel   = "stylesheet"
					type  = "text/css"
					media = screen
					href  = "/lib/css/local.css"
				>

%			} elsif ($r->hostname =~ "testing.tabroom.com" || $r->hostname =~ "profiler.tabroom.com") { 

				<link 
					rel   = "stylesheet"
					type  = "text/css"
					media = screen
					href  = "/lib/css/testing.css"
				>

%			} elsif ($r->hostname eq "staging.tabroom.com") { 
			
				<link 
					rel   = "stylesheet"
					type  = "text/css"
					media = screen
					href  = "/lib/css/staging.css"
				>

%			} elsif ($r->hostname eq "backup.tabroom.com") { 

				<link 
					rel   = "stylesheet"
					type  = "text/css"
					media = screen
					href  = "/lib/css/staging.css"
				>

%			}

%			if ($r->uri eq "/tabbing/status/dashboard.mhtml") { 
				<meta 
					http-equiv = "refresh"
					content    = "60"
				>
%			}


			<title>
				<%
					$event ? 
					$event->abbr : ""
				%> <% 
					$tourn && $tourn->start ? $tourn->start->year : "" 
				%> <% 
					$tourn ?  $tourn->name : "" 
				%> Tabroom.com
			</title>

			<script
				type="text/javascript" 
				src="/lib/javascript/tabroom.min.js"
			></script>

			<script>
				$(document).ready(function(){

					// adds zebra striping to elements.  in web/lib/javascript/tabroom.js
					zebraRows();  

					// put the focus on the first editable element. 
					$('*:input:enabled:visible:not(.notfirst):first').focus();
					$('.starthere').focus();

					// Adds the searchable select menus to eligible elements
					$("select:not(.plain)").chosen({
						no_results_text: "Oops, nothing found!", 
						disable_search_threshold: 10
					});

					// Control-s gives you the search box
					Mousetrap.bind('mod+s', function(e) {
						$('#searchtext').focus();
						return false;
					});

					// Sets up the little arrows to close and open the sidebars
					$(".menu").prepend("<div class='shade openshade fa fa-forward'></div>");
					$("#content").prepend("<div class='hidden shade closedshade fa fa-backward'></div>");

					$(".shade").click( function() { 
						$(".menu").toggleClass("hidden");
						$(".closedshade").toggleClass("hidden");
						$(".main").toggleClass("mainfull");
					});

				}); 

			</script>

			<!-- This displays errors in a growl-like interface on the right when present. -->

%			if ($err) { 
				<script type="text/javascript" language="javascript">
					$(document).ready(function() {
						$.jGrowl("<% $err %>", { 
							header   : 'Warning',
							life     : 8000,
							theme    : 'warning',
							position : 'top-center',
							closer   : false 
						});
					});

				</script>
%			}

			<!-- This displays messages (not errors) in a growl-like interface on the right when present. -->

%			unless ($fullmsg) { 

%				if ($msg) { 
					<script type="text/javascript" language="javascript">
						$(document).ready(function() {
							$.jGrowl("<% $msg %>", { 
								header   : 'Message',
								life     : 5000,
								position : 'top-center',
								closer   : false
							});
						});
					</script>
%				}

%				if ($greenmsg) { 
					<script type="text/javascript" language="javascript">
						$(document).ready(function() {
							$.jGrowl("<% $greenmsg %>", { 
								header   : 'All Done',
								life     : 5000,
								position : 'top-center',
								theme    : 'green'  
							});
						});
					</script>
%				}

%				if ($yellowmsg) { 
					<script type="text/javascript" language="javascript">
						$(document).ready(function() {
							$.jGrowl("<% $yellowmsg %>", { 
								header   : 'Half Done',
								life     : 5000,
								position : 'top-center',
								theme    : 'yellow'  
							});
						});
					</script>
%				}

%				if ($quick) { 
					<script type="text/javascript" language="javascript">
						$(document).ready(function() {
							$.jGrowl("<% $quick %>", { 
								life     : 500,
								theme    : 'quick',
								position : 'top-center' 
							});
						});
					</script>
%				}

%			} else { 

				<script type="text/javascript" language="javascript">
					$(document).ready(function() {
						$.jGrowl("<% $fullmsg %>", { 
							header   : 'ATTENTION!',
							theme    : 'fullmsg',
							life     : 10000,
							position : 'center'
						});
					});
				</script>
%			}

%			if ($r->hostname eq "www.tabroom.com" ) { 
				<script>
					  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
					  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
					  ga('create', 'UA-43754389-1', 'tabroom.com');
					  ga('send', 'pageview');
				</script>

% 			}

			<meta 
				property = "og:image"
				content  = "http://www.tabroom.com/lib/images/nsda-blue.png"
			/>

	</head>

	<body>

	<div id="overlay">

		<div id="header">

			<span id="logo">

				<span class="headline">

					<span id="sparky">
						<img 
							src = "/lib/images/sparky.png"
							alt = "National Speech and Debate Association"
						>
					</span>

					<span id="sparked">
						<a 
							tabindex = "-1"
							href     = "<% $Tab::url_prefix %>"
						>
							Tabroom.com
						</a>
					</span>
				</span>

				<span class="nsda">

					<span class="blurb">
						a project of the
					</span>

					<span class="nsdalogo">

						<a 
							tabindex = "-1"
							href     = "http://www.speechanddebate.org"
						>

							<img 
								src = "/lib/images/nsda-header-logo.png"
								alt = "National Speech and Debate Association"
							>
						</a>

					</span>
				</span>
			</span>

			<span id="toprow">

%				if ($session) { 

%					if ($session->su && $session->su->id) { 

						<a 
							tabindex = "-1"
							href     = "/user/admin/su_return.mhtml"
						>
							Return to <% $session->su->email %>
						</a>

%					} else { 

						<a 
							tabindex = "-1"
							href     = "/user/login/logout.mhtml"
						>
							Logout
						</a>

						<a 
							tabindex = "-1"
							href     = "/user/login/profile.mhtml"
						>
							Profile
						</a>

%					} 

					<a 
						tabindex = "-1"
						href     = "/user/home.mhtml"
					>
						<% $session->person->email %>
					</a>

%				} else { 

					<& "/user/login/login_block.mas" &>


%				}

<%perl>

				if ($tourn && (
					$r->uri =~ /setup/ 
					|| $r->uri =~ /register/ 
					|| $r->uri =~ /panel/ 
					|| $r->uri =~ /tabbing/ 
					|| $r->uri =~ /com\/results\//)
				) { 

					if ( 
						$perms{"owner"} 
						|| $perms{"registration"} 
						|| $perms{"full_admin"} 
						|| $perms{"tabbing"} 
						|| $perms{"category_tab"} ) { 

</%perl>
						<span 
							id    = "search"
							title = "Search schools, judges and entries"
						>	

							<form action="/register/search/tourn_search.mhtml">	

							<input 
								type           = "text"
								maxlength      = "128"
								size           = "15"
								name           = "search"
								placeholder    = "SEARCH"
								autocomplete   = "off"
								autocorrect    = "off"
								autocapitalize = "off"
								spellcheck     = "false"
								id             = "searchtext"
								class          = "notfirst"
								tabindex       = "-1"
							>

							<input 
								type  = "hidden"
								name  = "caller"
								value = "<% $r->unparsed_uri %>"
							>

							<button 
								type  = "submit"
								class = "search notfirst">

								<img src="/lib/images/search.png">
							</button>
							</form>
						</span>
%					}

%				} else { 

					<span 
						id    = "search"
						title = "Search for tournaments"
					>

						<form action="/index/search.mhtml">

						<input 
							type           = "text"
							maxlength      = "128"
							size           = "15"
							name           = "search"
							placeholder    = "SEARCH"
							autocomplete   = "off"
							autocorrect    = "off"
							autocapitalize = "off"
							spellcheck     = "false"
							id             = "searchtext"
							class          = "notfirst"
							tabindex       = "-1"
						>

						<input 
							type  = "hidden"
							name  = "caller"
							value = "<% $r->unparsed_uri %>"
						>

						<button 
							type  = "submit"
							class = "search notfirst"
						>

							<img src="/lib/images/search.png">
						</button>

						</form>
					</span>

%				}

				<span id="helpbutton" title="Tabroom Help">
					<a 
						tabindex = "-1"
						href     = "http://docs.tabroom.com"
						target   = "_blank"
						class    = "fa fa-question-circle"
					>

					</a>
				</span>

			</span>

			<span id="menus"> 
<%perl>
				if ($tourn && ($r->uri =~ /setup/ 
					|| $r->uri =~ /register/ 
					|| $r->uri =~ /panel/ 
					|| $r->uri =~ /tabbing/ 
					|| $r->uri =~ /com\/results\//)
				) { 

</%perl>

					<& 
						"/lib/menu/menubar_tourn.mas", 
						session         => $session,
						tourn           => $tourn,
						person          => $person,
						tourn_settings  => \%tourn_settings,
						person_settings => \%person_settings,
						perms           => \%perms,
					&>

%				} else { 

					<& 
						"/lib/menu/menubar_index.mas", 
						session => $session 
					&>

%				}

			<span>

		</div>

%		if ($r->hostname eq "backup.tabroom.com" ) { 

			<div class="backupwarning">
				This is a backup copy of Tabroom.  Please use it only to access
				data and information.  Any registration or tournament changes
				entered here will not be copied back to the master Tabroom
				site.
			</div>

%		}

<%perl>

		$m->call_next( 
			debug           => $debug,
			session         => $session,
			person          => $person,
			tourn           => $tourn,
			tourn_settings  => \%tourn_settings,
			person_settings => \%person_settings,
			perms           => \%perms
		);

</%perl>

	<div id="footer">

		<a 	
			tabindex = "-1"
			href     = "https://www.speechanddebate.org/join"
		>
			Join the National Speech & Debate Association
		</a>


		<a 
			tabindex = "-1"
			href     = "https://www.speechanddebate.org/mission"
		>About</a>

		<a 
			tabindex = "-1"
			href     = "https://support.tabroom.com"
		>Help</a>

		<a 
			tabindex = "-1"
			href     = "https://www.tabroom.com/index/about.mhtml"
		>Contact</a>

%		if ($person && $person->site_admin && $tourn) {

			<div 
				class="smallish padmore right"
			>
				Tournament <% $tourn->name %> 
				ID <% $tourn->id %> 
				Session <% $session->id %>
			</div>
%		}

	</div>


	</div>

%	if (
%			$person_settings{'scream_in_pain'} 
%			&& (not defined $person_settings{'please_stop_screaming'})
%	)  { 
		<& "/funclib/scream_in_pain.mas" &>
%	}

	</body>

</html>

% }	else { 
%		$m->call_next;
% }
