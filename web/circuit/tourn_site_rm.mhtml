<%args>
	$circuit
	$tourn_id
	$site_id
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id);

	my @already = Tab::TournSite->search( tournament => $tourn->id, 
											  	site => $site_id );

	foreach my $already (@already) { 

		$already->delete; 

		my $err = "Site Deleted.  Existing room assignments have not been touched.";

		# Check if there's another site in the tournament. 
		my @sites = $tourn->sites;

		# If there is, assign these rounds the the first site.  Better than the current default.
		my @existing_rounds = Tab::Round->search_by_site_and_tourn($site_id, $tourn->id);

		if (@sites) { 

			my $siteone = shift @sites;

			foreach my $er (@existing_rounds) { 
				$er->site($siteone->id);
				$er->update;
			}

			$err = "Site deleted.  Rounds shifted to site ".$siteone->name;

		} else {

			foreach my $er (@existing_rounds) { 
				$er->site();
				$er->update;
			}

		}

		$m->redirect("$Tab::url_prefix/circuit/tourn_edit.mhtml?err=$err&tourn_id=$tourn_id");
 	} 

</%init> 

