<%args>
	$circuit
	$account
	$email_id => undef;
</%args>
<%init>

	my $email = Tab::Email->retrieve($email_id) if $email_id;
	my $now = DateTime->now(time_zone => $circuit->timezone);

	my $nowkey = DateTime::Format::MySQL->format_date($now);

	my @tournaments = Tab::Tourn->search_where(
		circuit => $circuit->id);
#		reg_start => {'<', $nowkey},
#		end => {'>', $nowkey},
#		);	

	my $switch;

</%init>

	<h2>Send email</h2>

	<table width="100%" cellpadding="3" cellspacing"1">

		<tr class="evenrow">

			<td width="100%">
				Subject:
			</td>

			<td class="right">
				<form action="email_send.mhtml" method="post"> 
				<input type="hidden" name="status" value="unsent">
				<input type="text" name="subject" size="50" value="<% ($email) ? $email->subject : "" %>" >
			</td>

		</tr>

		<tr>
			<td colspan="2">
				<h4>Email text:</h4>
			</td>
		</tr>

		<tr>
			<td colspan="2" class="center">
				<textarea name="text" cols="55" rows="20"><% ($email) ? $email->text : "" %></textarea>
			</td>
		</tr>

	</table>

	<h4>Send email to:</h4>

	<table width="100%" cellpadding="3" cellspacing"1">

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
			<td>
				All Members:
			</th>
	
			<td>
				<input type="checkbox" name="members" value="1">
			</td>
	
		</tr>
	
%		foreach my $tournament (sort {$b->start->epoch <=> $a->start->epoch} @tournaments) { 
	
% 			my $now = DateTime->now;
% 			my $year = $now->year;
% 			$year-- if $now->month < 8;
	
%			my $limit_date = $year."-07-01";

%			my $limit = DateTime::Format::MySQL->parse_date($limit_date);

%			next if $tournament->end && $tournament->end->epoch < $limit->epoch;
% 			next if $tournament->reg_start && $tournament->reg_start->epoch > $now->epoch;
	
% 			my $tournament_key = "tournament_".$tournament->id;
	
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	
				<td>
					<% $tournament->name %> entrants
				</td>
	
				<td>
					<input type="checkbox" name="<% $tournament_key %>" value="1">
				</td>
	
			</tr>
% 		}
	
		<tr>
	
			<td colspan="2" align="right">
				<input class="grey" type="submit" value="   Send Email   ">
				</form>
			</td>
	
		</tr>
	
	</table>
