<%args>
	$person
	$person_settings => undef
	$chapter         => undef
	$region          => undef
	$nodiv           => undef
	$circuit_id      => undef
	$whoami          => undef
	$district        => undef
</%args>
<%init>

	my $chapter_name;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			perm.id, perm.tag,
			perm.tourn, perm.chapter, perm.region, perm.district, perm.circuit,
			tourn.name, tourn.state, tourn.country, tourn.start, tourn.end,
			chapter.id, chapter.name,
			region.id,  region.circuit, region.name, region.arch,
			district.id, district.name,
			circuit.id, circuit.name, tc.id
		from permission perm

			left join tourn on perm.tourn = tourn.id
			left join chapter on perm.chapter = chapter.id
			left join region on perm.region = region.id
			left join district on perm.district = district.id
			left join circuit on perm.circuit = circuit.id
			left join tourn_circuit tc on tc.circuit = circuit.id and tc.approved != 1

		where perm.person = ?
	");

	$sth->execute($person->id);

	my %menus;

	my $any_tourns;

	my $now = DateTime->now();

	my $now_string = DateTime::Format::MySQL->format_datetime($now);
	$now_string =~ s/[\D_]//g;

	if ($now->year < 2022) {
		#fuck everything especially online debate
		$now->subtract(days => 6);
	}

	my $limit_string = DateTime::Format::MySQL->format_datetime($now);
	$limit_string =~ s/[\D_]//g;

	while (
		my (
			$id, $tag,
			$perm_tourn, $perm_chapter, $perm_region, $perm_district, $perm_circuit,
			$tourn_name, $tourn_state, $tourn_country, $tourn_start, $tourn_end,
			$chapter_id, $chapter_name,
			$region_id, $region_circuit, $region_name, $region_arch,
			$district_id, $district_name,
			$circuit_id, $circuit_name, $tc_id
		) = $sth->fetchrow_array()
	) {

		if ($tourn_name) {
			$tourn_end =~ s/[\D_]//g;
			$any_tourns++;

			next if $tourn_end < $now_string;

			my $month = substr($tourn_start, 5, 2);
			my $day = substr($tourn_start, 8, 2);

			$month =~ s/^0+(?=[0-9])//;
			$day =~ s/^0+(?=[0-9])//;

			$menus{"tourn"}{$perm_tourn}{"sort"}  = $tourn_end;
			$menus{"tourn"}{$perm_tourn}{"name"}  = $tourn_name;
			$menus{"tourn"}{$perm_tourn}{"extra"} = $month."/".$day;

		} elsif ($chapter_name) {

			$menus{"chapter"}{$chapter_id}{"sort"} = $chapter_name;
			$menus{"chapter"}{$chapter_id}{"name"} = $chapter_name;

			if ($tag eq "prefs_only") {
				$menus{"chapter"}{$chapter_id}{"extra"} = "Prefs Only";
			}

		} elsif ($district_name) {

			$menus{"district"}{$district_id}{"sort"} = $district_name;
			$menus{"district"}{$district_id}{"name"} = $district_name;

			if ($tag eq "chair") {
				$menus{"district"}{$district_id}{"extra"} = "Chair";
			}

		} elsif ($region_name) {

			if ($region_circuit == 3) {
				if ($region_arch) {
					$region_name = "Archdiocese of ".$region_name;
				} else {
					$region_name = "Diocese of ".$region_name;
				}

				$menus{"region"}{$region_id}{"diocese"}++;
			}

			$menus{"region"}{$region_id}{"sort"} = $region_name;
			$menus{"region"}{$region_id}{"name"} = $region_name;

		} elsif ($circuit_name) {

			$menus{"circuit"}{$circuit_id}{"sort"} = $circuit_name;
			$menus{"circuit"}{$circuit_id}{"name"} = $circuit_name;

			if ($tc_id) {
				$menus{"circuit"}{$circuit_id}{"approvals"}++;
			}

		}
	}

	$sth->finish();

	my $entries;

	$sth = $dbh->prepare("
		select student.id, chapter.name
			from (student, chapter)
		left join entry_student es on es.student = student.id
		where student.person = ?
			and student.chapter = chapter.id
		order by es.id DESC, student.id DESC
		limit 1
	");

	$sth->execute($person->id);

	($entries, $chapter_name) = $sth->fetchrow_array();

	$sth->finish();

	$sth = $dbh->prepare("
		select judge.id,
			category.abbr,
			tourn.id, tourn.name, tourn.start, tourn.end,
			chapter.name,
			nsda_nats.id

		from (judge, category, tourn)
			left join chapter_judge cj on cj.id = judge.chapter_judge
			left join chapter on cj.chapter = chapter.id
			left join tourn_setting nsda_nats
				on nsda_nats.tag = 'nsda_nats'
				and nsda_nats.tourn = tourn.id

		where judge.person = ?
			and judge.category = category.id
			and category.tourn = tourn.id

		order by tourn.end DESC
	");

	my %judges;

	my $current;
	my $nsda_nats;

	$sth->execute($person->id);

	while (
		my (
			$id, $cat, $tourn_id, $tourn_name, $start, $end, $cname, $nats
		) = $sth->fetchrow()
	) {

		my $month = substr($start, 5, 2);
		my $day = substr($start, 9, 2);

		$start =~ s/[\D_]//g;
		$end   =~ s/[\D_]//g;

		$judges{$id}{"tourn"}      = $tourn_id;
		$judges{$id}{"category"}   = $cat;
		$judges{$id}{"tourn_name"} = $tourn_id;
		$judges{$id}{"date"}       = $day.'/'.$month;

		if ($start < $now_string && $now_string < $end) {
			$current++;
		}

		if ($start > $limit_string && $nats) {
			$nsda_nats++;
		}
	}

	my $school_year = &Tab::school_year;

</%init>

%	unless ( $nodiv) {
		<div class="menu">
%	}

%	if ($any_tourns || keys %menus) {
		<div class="sidenote">

<%perl>
			my $notfirst;

			foreach my $key ("chapter", "district", "region") {

				foreach my $cid (
					sort {$menus{$key}{$a}{"sort"} cmp $menus{$key}{$a}{"sort"}} keys %{$menus{$key}}
				) {

					unless ($notfirst++) {
						$m->print('<h4>Institutions</h4>');
					}

					if ($key eq "district") {
</%perl>
						<a
							class=" <% ($ARGS{$key} == $cid )? "dk" : "" %>blue full"
							href="/user/nsda/district.mhtml?district_id=<% $cid %>"
						>
%							if ($menus{$key}{$cid}{"extra"}) {
								<span class="threequarters nospace">
									<% $menus{$key}{$cid}{"name"} %>
								</span>
								<span class="quarter nospace">
									<% $menus{$key}{$cid}{"extra"} %>
								</span>
%							} else {
								<% $menus{$key}{$cid}{"name"} %>
%							}
						</a>

%					} else {

<%perl>
						my $tmpkey = $key;

						if ($key eq "region" && $menus{$key}{$cid}{"diocese"}) {
							$tmpkey = "diocese"
						}
</%perl>

						<a
							class=" <% ($ARGS{$key} == $cid )? "dk" : "" %>blue full"
							href="/user/<% $tmpkey %>/tournaments.mhtml?<% $key %>_id=<% $cid %>"
						>
%							if ($menus{$key}{$cid}{"extra"}) {
								<span class="threequarters nospace">
									<% $menus{$key}{$cid}{"name"} %>
								</span>
								<span class="quarter nospace">
									<% $menus{$key}{$cid}{"extra"} %>
								</span>
%							} else {
								<% $menus{$key}{$cid}{"name"} %>
%							}
						</a>
%					}
%				}
%			}

%			if ($any_tourns) {

				<h4>
					Tournaments
				</h4>

%				foreach my $tid (
%					sort {$menus{tourn}{$a}{sort} <=> $menus{tourn}{$b}{sort}} keys %{$menus{tourn}}
%				) {

					<a
						class="blue full"
						href="/user/tourn/select.mhtml?tourn_id=<% $tid %>"
					>
						<span class="fivesixth">
							<% $menus{tourn}{$tid}{"name"} %>
						</span>

						<span class="sixth mono smaller rightalign">
							<% $menus{tourn}{$tid}{"extra"} %>
						</span>
					</a>
%				}

				<a
					class="martop-half blue full"
					href="/user/tourn/all.mhtml"
				>
					Past Tournaments
				</a>
%			}

		</div>
%	}

<%perl>

	if (
		$person->site_admin
		|| ( $person_settings
			&& ( $person_settings->{"nsda_admin"} || $person_settings->{"naudl_admin"})
		)
	){
</%perl>

		<&
			"admin/menu.mas",
			person          => $person,
			person_settings => $person_settings,
			nodiv           => 1,
			whoami          => $whoami
		&>
%	}

		<div class="sidenote">

			<h4>
				Judging
			</h4>

%			if ($nsda_nats) {
%				my $nationals = $m->comp("/funclib/current_nationals.mas");
				<a class="dkblue larger full centeralign"
					href="/user/judge/nats.mhtml"
				>
					<% $nationals ? $nationals->name : "" %>
				</a>
%			}


%			if ($current) {
				<a class="yellow full"
					href="/user/judge/panels.mhtml"
				>
					Current Ballots & Panels
				</a>
%			}

%			if (keys %judges) {

				<a class="<% $whoami eq "judgeindex" ? "dk" : "" %>blue half"
					href="/user/judge/index.mhtml"
				>
					Upcoming
				</a>

				<a class="<% $whoami eq "judgehistory" ? "dk" : "" %>blue half"
					href="/user/judge/history.mhtml?person_id=<% $person->id %>"
				>
					History
				</a>
%			}

			<a
				class="<% $whoami eq "conflicts" ? "dk" : "" %>blue half"
				href="/user/judge/conflicts.mhtml"
			>
				Standing Conflicts
			</a>

			<a
				class="<% $whoami eq "judgeparadigm" ? "dk" : "" %>blue half"
				href="/user/judge/paradigm.mhtml"
			>
				Paradigm
			</a>

%			if ($m->comp("/funclib/tourn_exchange.mas")) {
				<a
					class="<% $whoami eq "exchange" ? "dk" : "" %>blue full"
					href="/user/judge/hire.mhtml?person_id=<% $person->id %>"
				>
					Offer Hired Judging Rounds
				</a>
%			}
		</div>

%	if (keys %{$menus{"circuit"}}) {

		<div class="sidenote">

			<h4>
				Circuits
			</h4>

%			foreach my $cid (
%				sort {$menus{circuit}{$a}{"sort"} cmp $menus{circuit}{$a}{"sort"}} keys %{$menus{circuit}}
%			) {

				<a
					class="<% $cid == $circuit_id ? "dk" : "" %>blue full"
					href="/user/circuit/index.mhtml?circuit_id=<% $cid %>"
				>
					<% $menus{circuit}{$cid}{"name"} %>
				</a>

%				if ($menus{"circuit"}{$cid}{"approvals"}) {
					<a
						class="yellow full indent"
						href="/user/circuit/approvals.mhtml?circuit_id=<% $cid %>"
					>
						Approve Tourn Requests
					</a>
%				}
%			}

		</div>
%	}

%		if ($entries) {

			<div class="sidenote">

				<h4>
					Competing
				</h4>

				<a
					class="<% $whoami eq "competitor" ? "dk" : "" %>blue full"
					href="/user/student/index.mhtml?person_id=<% $person->id %>"
				>
					Entries
				</a>

				<a
					class="<% $whoami eq "comp_conflicts" ? "dk" : "" %>blue full"
					href  = "/user/student/conflicts.mhtml"
				>
					Standing Conflicts
				</a>

				<a
					class = "<% $whoami eq "parents" ? "dk" : "" %>blue full"
					href  = "/user/student/parents.mhtml"
				>
					Parent Notifications
				</a>

			</div>
%		}

		<div class="sidenote">

			<h4>NSDA Campus Test Rooms</h4>

			<div
				class = "row"
				title = "This online room is on the NSDA Campus server.  It will disconnect you after 2 mins."
			>
				<span class="twothirds semibold bluetext nospace">
					<span class="halfspace"></span>
					Test Competition Room
				</span>

				<span class="third centeralign">
					<& "/funclib/online_room.mas",
						person      => $person,
						test        => "private",
						test_school => $chapter_name,
						class       => "fa-sm"
					&>
				</span>
			</div>

			<div
				class = "row"
				title = "This online room is on the Jitsi public server.  It will disconnect you after 2 mins."
			>
				<span class="twothirds semibold bluetext nospace">
					<span class="halfspace"></span>
					Test Practice/Utility Room
				</span>

				<span class="third centeralign">
					<& "/funclib/online_room.mas",
						person      => $person,
						test        => "public",
						test_school => $chapter_name,
						class       => "fa-sm"
					&>
				</span>
			</div>

			<h4>Your Account</h4>

			<a
				class = "<% $ARGS{"unfollow"} ? "dk" : "" %>yellow full"
				href  = "/user/unfollow.mhtml"
			>
				Edit Live Updates/Parent Memos
			</a>

			<a class="yellow full" href="/user/chapter/create.mhtml">
				Create a new school/team
			</a>

			<a class="yellow full" href="/user/tourn/request.mhtml">
				Request a new tournament
			</a>

			<a class="yellow full" href="/user/judge/search.mhtml">
				Link your account to a judge
			</a>

			<a class="yellow full" href="/user/student/search.mhtml">
				Link your account to a competitor
			</a>

		</div>

%	unless ( $nodiv) {
		</div>
%	}

