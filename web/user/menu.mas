<%args>
	$person
	$person_settings => undef
	$chapter         => undef
	$region          => undef
	$nodiv           => undef
	$circuit_id      => undef
	$whoami          => undef
	$district        => undef
</%args>
<%init>

	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);

	my $chapter_name;

	my @tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person => $person
	);

	my @any_tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person => $person,
		any    => 1
	);

	my @entries = $m->comp(
		"/funclib/person_entries.mas",
		person => $person
	);

	my @students = $person->students(
		retired => 0
	);

	my @allentries = $m->comp(
		"/funclib/person_entries.mas",
		person => $person,
		all    => 1
	);

	my @pref_chapters = $m->comp(
		"/funclib/person_chapters.mas",
		person => $person,
		prefs  => "yes"
	);

	my @chapters = $m->comp(
		"/funclib/person_chapters.mas",
		person => $person
	);

	my @regions = $m->comp(
		"/funclib/person_regions.mas",
		person => $person
	);

	my @circuits = $m->comp(
		"/funclib/person_circuits.mas",
		person => $person
	);

	my @districts = $m->comp(
		"/funclib/person_districts.mas",
		person => $person
	);

	my @nowjudges = $m->comp(
		"/funclib/person_judges.mas",
		person  => $person,
		current => 1
	);

	my @natsjudges = $m->comp(
		"/funclib/person_judges.mas",
		person    => $person,
		nationals => 1
	);

	my @any_judges = $m->comp(
		"/funclib/person_judges.mas",
		person => $person,
		any    => 1
	);

	my @all_chapter_judges = $person->chapter_judges;

	Tab::Student->set_sql(by_ndt => "
		select distinct s2.id, s1.id as code
			from student s1, entry_student es1, entry, event,
				tourn_circuit, student s2, entry_student es2
			where s1.person = ?
			and es1.student = s1.id
			and es1.entry = entry.id
			and entry.event = event.id
			and event.tourn = tourn_circuit.tourn
			and tourn_circuit.circuit = '43'
			and es2.entry = entry.id
			and es2.student != es1.student
			and es2.student = s2.id
			and entry.timestamp > ?
	");

	my $school_year = &Tab::school_year;

	my @partners = Tab::Student->search_by_ndt(
		$person->id,
		DateTime::Format::MySQL->format_datetime($school_year)
	);

	if (@entries) {
		$chapter_name = $entries[0]->chaptername."-".$entries[0]->chapterstate;
	} elsif (@nowjudges) {
		$chapter_name = $nowjudges[0]->chaptername."-".$nowjudges[0]->chapterstate;
	} elsif (@students && $students[0]->chapter) {
		$chapter_name = $students[0]->chapter->name."-".$students[0]->chapter->state;
	} else {
		$chapter_name = $person->first." ".$person->last." ";
	}

</%init>

%	unless ( $nodiv) {
		<div class="menu">
%	}

%		if (@pref_chapters || @chapters || @any_tourns || @circuits || @regions || @districts) {
			<div class="sidenote">
%		}

%			if (@pref_chapters || @chapters || @regions || @districts) {
				<h4>
					Institutions
				</h4>

%				foreach my $ochapter (@chapters) {
					<a
						class=" <% ($chapter && $ochapter->id == $chapter->id )? "dk" : "" %>blue full"
						href="/user/chapter/tournaments.mhtml?chapter_id=<% $ochapter->id %>"
					>
						<% $ochapter->name %>
					</a>
%				}

%				foreach my $ochapter (@pref_chapters) {
					<a
						class=" <% ($chapter && $ochapter->id == $chapter->id )? "dk" : "" %>blue full"
						href="/user/chapter/tournaments.mhtml?chapter_id=<% $ochapter->id %>"
					>
						<span class="threequarter">
							<% $ochapter->name %>
						</span>
						<span class="quarter">
							Prefs Only
						</span>
					</a>
%				}

%				foreach my $odistrict (@districts) {
					<a
						class="<% $odistrict == $district ? "dk" : "" %>blue full"
						href="/user/nsda/district.mhtml?district_id=<% $odistrict->id %>"
					>
						<% $odistrict->name %> District
					</a>
%				}

%				foreach my $oregion (@regions) {

%					if ($oregion->circuit->id == 3) {   #NCFL
						<a
							class=" <% ($region && $oregion->id == $region->id )
								? "yellow"
								: "blue"
							%> full"
							href="/user/diocese/tournaments.mhtml?region_id=<% $oregion->id %>"
						>
							<% $oregion->setting("arch")
								? "Archdiocese"
								: "Diocese"
							%> of <% $oregion->name %>
						</a>
%					} else {

						<a
							class=" <% ($region && $oregion->id == $region->id )
								? "yellow"
								: "blue"
							%> full"
							href="/user/region/tournaments.mhtml?region_id=<% $oregion->id %>"
						>
							<% $oregion->name %> Region
						</a>
%					}
%				}
%			}

%		if (@any_tourns || @tourns) {

			<h4>
				Tournaments
			</h4>

%			foreach my $tourn (@tourns) {

				<a
					class="blue full"
					href="/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
				>

					<span class="fivesixth">
						<% $tourn->name %>
					</span>

					<span class="sixth mono smaller rightalign">
						<% $tourn->location %>
					</span>
				</a>
%			}

			<a
				class="martop-half blue full"
				href="/user/tourn/all.mhtml"
			>
				See Past Tournaments
			</a>
%		}

<%perl>
		if (@pref_chapters
			|| @chapters
			|| @any_tourns
			|| @circuits
			|| @regions
			|| @districts
		) {
</%perl>
			</div>
%		}

<%perl>

		if (
			$person->site_admin
			|| ( $person_settings
					&& ( $person_settings->{"nsda_admin"}
						|| $person_settings->{"naudl_admin"}
					)
				)
		){

</%perl>
			<&
				"admin/menu.mas",
				person          => $person,
				person_settings => $person_settings,
				nodiv           => 1,
				whoami          => $whoami
			&>
%		}

%		if (@circuits) {

			<div class="sidenote">

				<h4>
					Circuits
				</h4>

%				foreach my $circuit (@circuits) {

					<a
						class="<% $circuit->id == $circuit_id ? "dk" : "" %>blue full"
						href="/user/circuit/index.mhtml?circuit_id=<% $circuit->id %>"
					>

						<span class="fivesixth">
							<% $circuit->name %>
						</span>

						<span class="sixth mono smaller rightalign">
							<% ($circuit->state) ? $circuit->state."/" : "" %><% $circuit->country %>
						</span>
					</a>

%					if ($m->comp("/funclib/circuit_tourns.mas", circuit => $circuit, approval => 1)) {

						<a
							class="yellow full indent"
							href="/user/circuit/approvals.mhtml?circuit_id=<% $circuit->id %>"
						>
							Approve Tourn Requests
						</a>
%					}
%				}

			</div>
%		}

		<div class="sidenote">

			<h4>
				Judging
			</h4>

%			if (@natsjudges) {
%				my $nationals = $m->comp("/funclib/current_nationals.mas");
				<a class="dkblue larger full centeralign"
					href="/user/judge/nats.mhtml"
				>
					<% $nationals ? $nationals->name : "" %>
				</a>
%			}


%			if (@nowjudges) {

				<a class="yellow full"
					href="/user/judge/panels.mhtml"
				>
					Current Ballots & Panels
				</a>
%			}

%			if (@any_judges || @all_chapter_judges) {

				<a class="<% $whoami eq "judgeindex" ? "dk" : "" %>blue half"
					href="/user/judge/index.mhtml"
				>
					Upcoming
				</a>

				<a class="<% $whoami eq "judgehistory" ? "dk" : "" %>blue half"
					href="/user/judge/history.mhtml?person_id=<% $person->id %>"
				>
					History
				</a>
%			}

			<a
				class="<% $whoami eq "conflicts" ? "dk" : "" %>blue half"
				href="/user/judge/conflicts.mhtml"
			>
				Standing Conflicts
			</a>

			<a
				class="<% $whoami eq "judgeparadigm" ? "dk" : "" %>blue half"
				href="/user/judge/paradigm.mhtml"
			>
				Paradigm
			</a>

%			if ($m->comp("/funclib/tourn_exchange.mas")) {
				<a
					class="<% $whoami eq "exchange" ? "dk" : "" %>blue full"
					href="/user/judge/hire.mhtml?person_id=<% $person->id %>"
				>
					Offer Hired Judging Rounds
				</a>
%			}
		</div>

%		if (@students || @entries || @allentries) {

			<div class="sidenote">

				<h4>
					Competing
				</h4>

%				if (@allentries) {
					<a
						class="<% $whoami eq "competitor" ? "dk" : "" %>blue full"
						href="/user/student/index.mhtml?person_id=<% $person->id %>"
					>
						Entries
					</a>
%				}

				<a
					class="<% $whoami eq "comp_conflicts" ? "dk" : "" %>blue full"
					href  = "/user/student/conflicts.mhtml"
				>
					Standing Conflicts
				</a>

				<a
					class = "<% $whoami eq "parents" ? "dk" : "" %>blue full"
					href  = "/user/student/parents.mhtml"
				>
					Parent Notifications
				</a>

%				foreach my $partner (@partners) {
					<a
						class="yellow full"
						href="/index/results/team_results.mhtml?id1=<% $partner->id %>&id2=<% $partner->code %>"
					>
						NDT Bid Sheet w/<% $partner->last %>
					</a>
%				}

			</div>
%		}

		<div class="sidenote">

			<h4>NSDA Campus Test Rooms</h4>

			<div
				class = "row"
				title = "This online room is on the NSDA Campus server.  It will disconnect you after 2 mins."
			>
				<span class="twothirds semibold bluetext nospace">
					<span class="halfspace"></span>
					Test Competition Room
				</span>

				<span class="third centeralign">
					<& "/funclib/online_room.mas",
						person      => $person,
						test        => "private",
						test_school => $chapter_name,
						class       => "fa-sm"
					&>
				</span>
			</div>

			<div
				class = "row"
				title = "This online room is on the Jitsi public server.  It will disconnect you after 2 mins."
			>
				<span class="twothirds semibold bluetext nospace">
					<span class="halfspace"></span>
					Test Practice/Utility Room
				</span>

				<span class="third centeralign">
					<& "/funclib/online_room.mas",
						person      => $person,
						test        => "public",
						test_school => $chapter_name,
						class       => "fa-sm"
					&>
				</span>
			</div>

			<h4>Your Account</h4>

			<a
				class = "<% $ARGS{"unfollow"} ? "dk" : "" %>yellow full"
				href  = "/user/unfollow.mhtml"
			>
				Edit Live Updates/Parent Memos
			</a>

			<a class="yellow full" href="/user/chapter/create.mhtml">
				Create a new school/team
			</a>

			<a class="yellow full" href="/user/tourn/request.mhtml">
				Request a new tournament
			</a>

			<a class="yellow full" href="/user/judge/search.mhtml">
				Link your account to a judge
			</a>

			<a class="yellow full" href="/user/student/search.mhtml">
				Link your account to a competitor
			</a>

		</div>

%	unless ( $nodiv) {
		</div>
%	}

