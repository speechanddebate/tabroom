<%args>
	$person
	$person_settings => undef
	$chapter         => undef
	$region          => undef
	$nodiv           => undef
	$circuit_id      => undef
	$whoami          => undef
	$district        => undef
</%args>
<%init>

	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);

	my @all_tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person => $person,
		all    => 1
	);

	my @tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person => $person
	);

	my @entries = $m->comp(
		"/funclib/person_entries.mas",
		person => $person
	);

	my @students = $person->students(
		retired => 0
	);

	my @allentries = $m->comp(
		"/funclib/person_entries.mas",
		person => $person,
		all    => 1
	);

	my @pref_chapters = $m->comp(
		"/funclib/person_chapters.mas",
		person => $person,
		prefs  => "yes"
	);

	my @chapters = $m->comp(
		"/funclib/person_chapters.mas",
		person => $person
	);

	my @regions = $m->comp(
		"/funclib/person_regions.mas",
		person => $person
	);

	my @circuits = $m->comp(
		"/funclib/person_circuits.mas",
		person => $person
	);

	my @districts = $m->comp(
		"/funclib/person_districts.mas",
		person => $person
	);

	my @nowjudges = $m->comp(
		"/funclib/person_judges.mas",
		person  => $person,
		current => 1
	);

	my @natsjudges = $m->comp(
		"/funclib/person_judges.mas",
		person    => $person,
		nationals => 1
	);

	my @alljudges = $m->comp(
		"/funclib/person_judges.mas",
		person => $person,
		all    => 1
	);

	my @all_chapter_judges = $person->chapter_judges;

	Tab::Student->set_sql(by_ndt => "
		select distinct s2.id, s1.id as code
			from student s1, entry_student es1, entry, event,
				tourn_circuit, student s2, entry_student es2
			where s1.person = ?
			and es1.student = s1.id
			and es1.entry = entry.id
			and entry.event = event.id
			and event.tourn = tourn_circuit.tourn
			and tourn_circuit.circuit = '43'
			and es2.entry = entry.id
			and es2.student != es1.student
			and es2.student = s2.id
			and entry.timestamp > ?
	");

	my $school_year = &Tab::school_year;

	my @partners = Tab::Student->search_by_ndt(
		$person->id,
		DateTime::Format::MySQL->format_datetime($school_year)
	);

</%init>

%	unless ( $nodiv) {
		<div class="menu">
%	}

%		if (@pref_chapters || @chapters || @all_tourns || @circuits || @regions || @districts) {

			<div class="sidenote">
%		}

%			if (@pref_chapters || @chapters || @regions || @districts) {

				<h4>
					Institutions
				</h4>

%				foreach my $ochapter (@chapters) {
					<a
						class=" <% ($chapter && $ochapter->id == $chapter->id )? "dk" : "" %>blue full"
						href="/user/chapter/tournaments.mhtml?chapter_id=<% $ochapter->id %>"
					>
						<% $ochapter->name %>
					</a>
%				}

%				foreach my $ochapter (@pref_chapters) {
					<a
						class=" <% ($chapter && $ochapter->id == $chapter->id )? "dk" : "" %>blue full"
						href="/user/chapter/tournaments.mhtml?chapter_id=<% $ochapter->id %>"
					>
						<span class="threequarter">
							<% $ochapter->name %>
						</span>
						<span class="quarter">
							Prefs Only
						</span>
					</a>
%				}

%				foreach my $odistrict (@districts) {
					<a
						class="<% $odistrict == $district ? "dk" : "" %>blue full"
						href="/user/nsda/district.mhtml?district_id=<% $odistrict->id %>"
					>
						<% $odistrict->name %> District
					</a>
%				}

%				foreach my $oregion (@regions) {

%					if ($oregion->circuit->id == 3) {   #NCFL
						<a
							class=" <% ($region && $oregion->id == $region->id )
								? "yellow"
								: "blue"
							%> full"
							href="/user/diocese/tournaments.mhtml?region_id=<% $oregion->id %>"
						>
							<% $oregion->setting("arch")
								? "Archdiocese"
								: "Diocese"
							%> of <% $oregion->name %>
						</a>
%					} else {

						<a
							class=" <% ($region && $oregion->id == $region->id )
								? "yellow"
								: "blue"
							%> full"
							href="/user/region/tournaments.mhtml?region_id=<% $oregion->id %>"
						>
							<% $oregion->name %> Region
						</a>
%					}

%				}
%		}

%		if (@all_tourns) {

			<h4>
				Tournaments
			</h4>

%			foreach my $tourn (@tourns) {

				<a
					class="blue full"
					href="/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
				>

					<span class="fivesixth">
						<% $tourn->name %>
					</span>

					<span class="sixth mono smaller rightalign">
						<% $tourn->location %>
					</span>
				</a>
%			}

			<a
				class="martop-half blue full"
				href="/user/tourn/all.mhtml"
			>
				See Past Tournaments
			</a>
%		}

<%perl>
		if (@pref_chapters
			|| @chapters
			|| @all_tourns
			|| @circuits
			|| @regions
			|| @districts
		) {
</%perl>
			</div>
%		}

<%perl>

		if (
			$person->site_admin
			|| ( $person_settings
					&& ( $person_settings->{"nsda_admin"}
						|| $person_settings->{"naudl_admin"}
					)
				)
		){

</%perl>
			<&
				"admin/menu.mas",
				person          => $person,
				person_settings => $person_settings,
				nodiv           => 1,
				whoami          => $whoami
			&>
%		}

%		if (@circuits) {

			<div class="sidenote">

				<h4>
					Circuits
				</h4>

%				foreach my $circuit (@circuits) {

					<a
						class="<% $circuit->id == $circuit_id ? "dk" : "" %>blue full"
						href="/user/circuit/index.mhtml?circuit_id=<% $circuit->id %>"
					>

						<span class="fivesixth">
							<% $circuit->name %>
						</span>

						<span class="sixth mono smaller rightalign">
							<% ($circuit->state) ? $circuit->state."/" : "" %><% $circuit->country %>
						</span>
					</a>

%					if ($m->comp("/funclib/circuit_tourns.mas", circuit => $circuit, approval => 1)) {

						<a
							class="yellow full indent"
							href="/user/circuit/approvals.mhtml?circuit_id=<% $circuit->id %>"
						>
							Approve Tourn Requests
						</a>

%					}

%				}

			</div>
%		}

		<div class="sidenote">

			<h4>
				Judging
			</h4>

%			if (@natsjudges) {
%				my $nationals = $m->comp("/funclib/current_nationals.mas");
				<a class="dkblue larger full centeralign"
					href="/user/judge/nats.mhtml"
				>
					<% $nationals ? $nationals->name : "" %>
				</a>
%			}


%			if (@nowjudges) {

				<a class="yellow full"
					href="/user/judge/panels.mhtml"
				>
					Current Ballots & Panels
				</a>
%			}

%			if (@alljudges || @all_chapter_judges) {

				<a class="<% $whoami eq "judgeindex" ? "dk" : "" %>blue half"
					href="/user/judge/index.mhtml"
				>
					Upcoming
				</a>

				<a class="<% $whoami eq "judgehistory" ? "dk" : "" %>blue half"
					href="/user/judge/history.mhtml?person_id=<% $person->id %>"
				>
					History
				</a>
%			}

			<a
				class="<% $whoami eq "conflicts" ? "dk" : "" %>blue half"
				href="/user/judge/conflicts.mhtml"
			>
				Standing Conflicts
			</a>

			<a
				class="<% $whoami eq "judgeparadigm" ? "dk" : "" %>blue half"
				href="/user/judge/paradigm.mhtml"
			>
				Paradigm
			</a>

%			if ($m->comp("/funclib/tourn_exchange.mas")) {
				<a
					class="<% $whoami eq "exchange" ? "dk" : "" %>blue full"
					href="/user/judge/hire.mhtml?person_id=<% $person->id %>"
				>
					Offer Hired Judging Rounds
				</a>
%			}


		</div>


%		if (@students || @entries || @allentries) {

			<div class="sidenote">

				<h4>
					Competing
				</h4>

%				if (@allentries) {
					<a
						class="<% $whoami eq "competitor" ? "dk" : "" %>blue full"
						href="/user/student/index.mhtml?person_id=<% $person->id %>"
					>
						Past Pairings &amp; Results
					</a>
%				}

				<a
					class="<% $whoami eq "comp_conflicts" ? "dk" : "" %>blue full"
					href  = "/user/student/conflicts.mhtml"
				>
					Standing Conflicts
				</a>

				<a
					class = "<% $whoami eq "parents" ? "dk" : "" %>blue full"
					href  = "/user/student/parents.mhtml"
				>
					Parent Notifications
				</a>

%		}


%		foreach my $partner (@partners) {
			<a
				class="yellow full"
				href="/index/results/team_results.mhtml?id1=<% $partner->id %>&id2=<% $partner->code %>"
			>
				NDT Bid Sheet w/<% $partner->last %>
			</a>
%		}


%		if (@students || @entries) {

			<h4>
				Upcoming/Present
			</h4>

<%perl>

			foreach my $entry (@entries) {

				next unless $entry->event;
				next unless $entry->event->category;

				my $event = $entry->event;
				my $tourn = $event->tourn;

				my $tourn_start = $tourn->start->set_time_zone($tz);
				my $tourn_end = $tourn->end->set_time_zone($tz);

				my $date_string .= Tab::niceshortdate($tourn_start);
				$date_string .= " - ".Tab::niceshortdate($tourn_end)
					if $tourn_end->day != $tourn_start->day;

				my $prefs_due = $event->category->setting("strike_end");
				my $prefs_start = $event->category->setting("strike_start");

				my $pref_string;

				if ($prefs_start > $now) {
					$prefs_start->set_time_zone($tz);
					$pref_string = "Prefs open: ";
					$pref_string .= Tab::niceshortdt($prefs_start);
					$pref_string .= " ".Tab::tzname($tz);
				} elsif ($prefs_due) {
					$prefs_due->set_time_zone($tz);
					$pref_string = "Prefs due: ";
					$pref_string .= Tab::niceshortdt($prefs_due);
					$pref_string .= " ".Tab::tzname($tz);
				}

</%perl>

				<a
					class="blue full"
					href="/user/student/entry.mhtml?entry_id=<% $entry->id %>"
				>

					<span class="threefifths">
						<% $tourn->name %>
					</span>

					<span class="fifth">
						<% $event->abbr
							? $event->abbr :
							substr($event->name, 0, 4)
						%>
					</span>

					<span class="fifth">
						<% $date_string %>
					</span>

%					if ($pref_string) {
						<span class="full centeralign semibold bigger padmore">
							<% $pref_string %>
						</span>
%					}

				</a>
%			}

%			foreach my $student ($person->students) {
				<a
					class=" blue full"
					href="/user/student/index.mhtml?student_id=<% $student->id %>"
				>
					<% $student->chapter ? $student->chapter->name : "" %> signups &amp; records
				</a>
%			}
%		}

%		if (@students || @allentries || @entries) {
			</div>
%		}


		<div class="sidenote">

			<h4>Your Account</h4>

			<a class="<% $ARGS{"unfollow"} ? "dk" : "" %>yellow full" href="/user/unfollow.mhtml">
				Edit Live Updates/Parent Memos
			</a>

			<a class="yellow full" href="/user/chapter/create.mhtml">
				Create a new school/team
			</a>

			<a class="yellow full" href="/user/tourn/request.mhtml">
				Request a new tournament
			</a>
<!--
			<a class="yellow full" href="/user/circuit/request.mhtml">
				Request a new circuit
			</a>
-->

			<a class="yellow full" href="/user/judge/search.mhtml">
				Link your account to a judge
			</a>

			<a class="yellow full" href="/user/student/search.mhtml">
				Link your account to a student
			</a>

		</div>

%	unless ( $nodiv) {
		</div>
%	}

