<%args> 
	$circuit
	$account
	$year => undef
</%args>
<%init>

	my $err;
	my $tz = $account->tz;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);
	my $foo++ unless $year;

	$year = $now->year unless $year;

	if ($now->month > 6 && $foo)  {
		$year++;
	}

	my $begin = DateTime->new( 
		year => $year - 1,
		month => 7,
		day  => 01 );

	my $stop = DateTime->new(
		year => $year,
		month => 6,
		day => 30 );

	my @all_tourns = $circuit->tourns if $circuit;

	my @tourns;

	foreach my $at (@all_tourns) { 
		push (@tourns, $at) if ($at->start > $begin && $at->end < $stop);
	}

	@tourns = sort {$a->start <=> $b->start } @tourns;

	$m->redirect("/index/index.mhtml?err=No circuit found") unless $circuit;

</%init>

	<& menu.mas, whoami => "tourns", circuit => $circuit, year => $year  &>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortable" &>

		<h2>The <% $circuit->abbr." ".$year." season "%></h2>

		<table cellpadding="3" cellspacing="1" border="0" width="100%" id="sortable">

			<thead>

			<tr class="yellowrow">

				<th>Name</th>
	
				<th>Contact(s)</th>
	
				<th>Date(s)</th>

				<th colspan="2" class="nosort"></th>

			</tr>

			</thead>

			<tbody>

%	 		my $switch;

%			foreach my $tourn (@tourns) { 

				<tr>

% 					my $start = $tourn->start;
% 					my $end = $tourn->end;
%					$start->set_time_zone($tz);
%					$end->set_time_zone($tz);

					<td class="smaller">
						<a href="tourn_edit.mhtml?circuit_id=<% $circuit->id %>&tourn_id=<% $tourn->id %>" class="nowrap judgechart padmore plain white block">
							<% $tourn->name %>
						</a>
					</td>
	
					<td class="smaller">
%						my $notfirst;
% 						foreach my $contact ($m->comp("/funclib/tourn_admins.mas", tourn => $tourn, contact => "yep" )) { 
							<a class="padless nowrap plain white block" href="mailto:<% $contact->email %>">
								<% $contact->first." ".$contact->last %>
							</a>
%						}
					</td>
	
					<td class="smaller">
						<% Tab::niceshortdate($start) %>
						<% ($start->day != $end->day) ? " - ".Tab::niceshortdate($end) : "" %>
					</td>
		
					<td class="smaller centeralign">
						<a class="dkgreen block" href="tourn_edit.mhtml?circuit_id=<% $circuit->id %>&tourn_id=<% $tourn->id %>">Access</a>
					</td>
					<td class="smaller centeralign">
						<a class="dkred block" href="deny.mhtml?from=tourns&circuit_id=<% $circuit->id %>&tourn_id=<% $tourn->id %>">Remove</a>
					</td>
	
				</tr>
	
%			}

		</table>

	<hr />

	<table cellpadding="5" cellspacing="1" width="100%">

		<tr class="evenrow">

			<td colspan="2">
				<form action="tourns.mhtml" method="post">
				View School Year ending:
			</td>
			
			<td colspan="2" class="centeralign">
				<input type="text" name="year" size="5" value="<% $year %>"> 
			</td>

			<td class="centeralign">
				<input  type="submit" value=" Show Schedule ">
				</form>
			</td>

		</tr>
	
	</table>
	
	</div>
