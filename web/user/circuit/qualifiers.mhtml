<%args>
	$person
	$person_settings
	$circuit_id
	$iterations   => 8
	$qualifier_id => undef
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id);
	my $qualifiers = $circuit->setting("qualifiers");

	my %cats;
	use Tab::NSDACategory;

	foreach my $cat (Tab::NSDACategory->retrieve_all) {
		$cats{$cat->id}{"name"}     = $cat->name;
		$cats{$cat->id}{"type"}     = $cat->type;
		$cats{$cat->id}{"national"} = $cat->national;
	}

</%init>

	<& menu.mas,
		circuit => $circuit,
		whoami  => "qualifiers"
	&>

	<div class="main">

		<div class="full flexrow">
			<span class="twothirds padleft">
				<h4 class='nospace'>Circuit Qualifiers</h4>
			</span>
			<span class="third rightalign padright">
				<select
					onChange = "showQual();"
					id       = "qualSelect"
					class    = "notfirst"
				>
					<option value=""></option>
%					foreach my $key (sort keys %{$qualifiers}) {
%						next if $key eq "lastkey";
						<option
							value="<% $key %>"
							<% $key == $qualifier_id ? "selected" : "" %>
						><% $qualifiers->{$key}{"label"} %></option>
%					}
				</select>
			</span>
		</div>

<%perl>

		foreach my $key (sort keys %{$qualifiers}) {

			next if $key eq "lastkey";
			my $qualifier = $qualifiers->{$key};
			my $events = $qualifier->{events};

			my $warn = 'You are about to delete this entire qualifying rule set, which will also delete all the qualifying points that correspond to it.  Are you sure you want to do that?';

</%perl>
			<div class="bluebordertop martopmore hidden quals" id="<% $key %>">

				<div
					id    = "<% $key %>_label"
					class = "padvert flexrow"
				>
					<span class="half padleft">
						<h5>
							Rule Set: <% $qualifier->{label} %>
						</h5>
					</span>
					<span class="half rightalign padright <% $key ? "" : "hidden" %>">
						<a
							class      = "fa buttonwhite redtext invert fa-lg fa-trash"
							circuit_id = "<% $circuit->id %>"
							onClick    = "postConfirm('<% $warn %>', this, 'qualifier_rm.mhtml');"
							key        = "<% $key %>"
						></a>
					</span>
				</div>
				<div class="row flexrow">
					<span class="fifth semibold padleft">
						Set Label
					</span>
					<span class="threetenths">
						<input
							id           = "<% $key %>_label_field"
							type         = "text"
							size         = "32"
							name         = "label"
							class        = "notfirst"
							value        = "<% $qualifier->{label} %>"
							placeholder  = "User-readable label like 'State Speech Rules' or 'TOC Octos Bid'"
							circuit_id   = "<% $circuit->id %>"
							qualifier_id = "<% $key %>"
							onChange     = "postSwitch(this, 'qualifier_label.mhtml');"
						>
					</span>
				</div>

				<div class="row flexrow">

					<span class="threetenths semibold padleft">
						Qualify As Individuals, Not Entries
					</span>
					<span class="fifth semibold">
						<& "/funclib/bool_switch.mas",
							setting_name => "individuals",
							tag          => $key."_individuals",
							value        => $qualifier->{"individuals"},
							circuit_id   => $circuit->id,
							qualifier_id => $key,
							url          => "qualifier_label.mhtml",
							function     => "showIndy(".$key.");"
						&>
					</span>

					<span
						class = "half hidden flexrow"
						id    = "<% $key %>_min_percent_box"
					>
						<span class="threequarters semibold padleft">
							Minimum Prelims Spoken In to earn Points <br />
							<span class="inline explain normalweight">
								Will round down if fractional
							</span>
						</span>
						<span class="fifth padright">
							<input
								type         = "number"
								min          = "0"
								circuit_id   = <% $circuit->id %>
								qualifier_id = <% $key %>
								max          = "100"
								step         = 1
								value        = "<% $qualifier->{"min_percent"} %>"
								name         = "min_percent"
								id           = "<% $key %>_min_percent"
								setting_name = "min_percent"
								onChange     = "postSwitch(this, 'qualifier_label.mhtml');"
							>
						</span>

						<span class="semibold inline bigger marno padright grow">
							%
						</span>
					</span>
				</div>

				<div class="row flexrow">
					<span class="quarter semibold padvertmore padleft">
						Qualifying Event Codes
					</span>
					<span class="threequarters" id="<% $key %>_events">
%						foreach my $event_code (sort {$a cmp $b} keys %{$events}) {
%							my $event = $events->{$event_code};
							<span
								id           = "<% $key.'_'.$event_code %>"
								class        = "quarter yellowhover"
								circuit_id   = "<% $circuit->id %>"
								qualifier_id = "<% $key %>"
								event_code   = "<% $event_code %>"
								action       = "rm"
								onClick      = "postSwitch(this, 'qualifier_event.mhtml');"
							>
								<% $event_code %>
								<% $event->{'level'} ? "<span class='smaller padleft padbottomless'>Level:".$event->{'level'}."</span>" : "" %>
								<% $event->{'nsda'} ? "<span class='smaller padleft padbottomless'>NSDA:".$event->{'nsda'}."</span>" : "" %>
							</span>
%						}
					</span>

				</div>

				<div class='row flexrow'>
					<span class="quarter semibold italic graytext smallish padleftmore">
						Add Event
					</span>

					<span class='fifth'>
						<input
							type        = "text"
							id          = "<% $key %>_event_code"
							action      = "add"
							class  		 = "notfirst"
							placeholder = "Code designator"
							onKeyDown   = 'saveEnter(event, <% $key %>);'
						>
					</span>

					<span class='quarter'>
						<select
							name        = "nsda_code"
							id          = "<% $key %>_nsda_code"
							placeholder = "NSDA Event Category"
						>
							<option value=""></option>
<%perl>
							foreach my $cat_id (
								sort {$cats{$a}{"type"} cmp $cats{$b}{"type"} || $cats{$a}{"name"} cmp $cats{$b}{"name"}}
								keys %cats
							) {
</%perl>
								<option value="<% $cat_id %>"
								><% $cats{$cat_id}{"name"} %> (<% $cat_id %>)</option>
%							}
						</select>
					</span>

					<span class='fifth'>
						<select
							name        = "event_level"
							id          = "<% $key %>_event_label"
							placeholder = "Event Level"
						>
							<option value="any">Any</option>
							<option value="jv">JV</option>
							<option value="novice">Novice</option>
							<option value="varsity">Varsity</option>
							<option value="open">Open</option>
						</select>
					</span>

					<span class="tenth rightalign padright">
						<a
							class   = "fa fa-plus buttonwhite bluetext invert"
							onClick = "saveEvent(<% $key %>);"
						></a>
					</span>

				</div>

				<h6 class="martopmore">
					Rules
				</h6>

				<form
					action = "qualifier_rules.mhtml"
					id     = "qualifier_rules.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "circuit_id"
					value = "<% $circuit->id %>"
				>

				<input
					type  = "hidden"
					name  = "qualifier_id"
					value = "<% $key %>"
				>

				<div class="ltyellow semibold smallish padvertless flexrow">

					<span class="tenth padleftmore">
						# Entries
					</span>

					<span class="tenth padleft">
						# Schools
					</span>

					<span class="tenth">
					</span>

					<span class="seventenths borderleft centeralign">
						<div class='nospace flexrow'>
							<span class="quarter smaller">
							</span>
							<span class="quarter" title="Final overall placement in results">
								Placement
							</span>
							<span class="quarter" title="Last elim # reached BEFORE end. So final = 1, semis = 2, quarters = 3">
								Reverse Elim
							</span>
							<span class="quarter" title="How many qualifying points or bids are earned?">
								Points/Bids
							</span>
						</div>
					</span>
				</div>
<%perl>
				foreach my $set_key (sort { $a cmp $b } (keys %{$qualifier->{rulesets}}, "new")) {

					my $set;

					if ($set_key eq "new") {
						$set = ({
							placement    => "",
							reverse_elim => "",
							points       => 1
						});
					} else {
						$set = $qualifier->{rulesets}{$set_key};
					}
</%perl>
					<div class="row flexrow">

						<span class="tenth padleftmore">
							<input
								type  = "number"
								name  = "<% $key."_".$set_key %>_entries"
								class = "<% $key eq "new" ? "" : "notfirst" %>"
								min   = 0
								max   = 99999
								value = "<% $set->{"entries"} %>"
							>
						</span>

						<span class="tenth">
							<input
								type  = "number"
								name  = "<% $key."_".$set_key %>_schools"
								class = "<% $key eq "new" ? "" : "notfirst" %>"
								min   = 0
								max   = 99999
								value = "<% $set->{"schools"} %>"
							>
						</span>

						<span class="tenth">
						</span>

						<span class="seventenths borderleft centeralign">
<%perl>
							my $notfirst;

							my @keys = sort {
								$set->{"rules"}{$b}{"reverse_elim"} cmp $set->{"rules"}{$a}{"reverse_elim"}
								|| $set->{"rules"}{$b}{"placement"} cmp $set->{"rules"}{$a}{"placement"}
							} keys %{$set->{'rules'}};
							push @keys, "new";

							foreach my $rule_tick (@keys) {

								my $rule;

								if ($rule_tick eq "new") {
									$rule = ({
										key          => "new",
										placement    => "",
										reverse_elim => "",
										points       => 1
									});
								} else {
									$rule = $set->{"rules"}{$rule_tick};
								}
</%perl>
								<div class="nospace flexrow <% $notfirst++ && $rule_tick eq "new" ? "bordertop" : "" %>">
									<span class="quarter smaller">
										<% $rule_tick eq "new" ? "Add New:"  : "" %>
									</span>
									<span class="quarter">
										<input
											type  = "number"
											name  = "<% $key."_".$set_key %>_<% $rule_tick %>_placement"
											id    = "<% $key."_".$set_key %>_<% $rule_tick %>_placement"
											class = "<% $rule_tick eq "new"  && $set_key ne "new" ? "first_".$key : "notfirst" %>"
											min   = 0
											max   = 99999
											value = "<% $rule_tick eq 'new' ? '' : $rule->{"placement"} %>"
										>
									</span>
									<span class="quarter">
										<input
											type  = "number"
											name  = "<% $key."_".$set_key %>_<% $rule_tick %>_reverse_elim"
											id    = "<% $key."_".$set_key %>_<% $rule_tick %>_reverse_elim"
											class = "<% $rule_tick eq "new" ? "" : "notfirst" %>"
											min   = 0
											max   = 99999
											value = "<% $rule_tick eq 'new' ? '' : $rule->{"reverse_elim"} %>"
										>
									</span>
									<span class="quarter">
										<input
											type  = "number"
											name  = "<% $key."_".$set_key %>_<% $rule_tick %>_points"
											id    = "<% $key."_".$set_key %>_<% $rule_tick %>_points"
											class = "<% $rule_tick eq "new" ? "" : "notfirst" %>"
											min   = 0
											max   = 99999
											value = "<% $rule_tick eq 'new' ? '' : $rule->{"points"} %>"
										>
									</span>
								</div>
%							}
						</span>
					</div>
%				}

				<div class='rightalign liblrow flexrow'>
					<span class='third centeralign'>
						<input
							type  = "submit"
							value = "Save Changes"
						>
					</span>
				</div>
				</form>
			</div>
%		}

		<form
			action = "qualifier_add.mhtml"
			id     = "qualifier_add.mhtml"
			method = "post"
		>
			<input
				type  = "hidden"
				name  = "circuit_id"
				value = "<% $circuit_id %>"
			>

			<div class="row flexrow martopmuchmore bluebordertop padtop">
				<span class="fifth padleft">
					Add new set called
				</span>
				<span class="threefifths">
					<input
						type        = "text"
						name        = "label"
						placeholder = "Description, like Octafinals Bid or State IE"
					>
				</span>
				<span class="fifth centeralign">
					<input
						type  = "submit"
						value = "Add"
					>
				</span>
			</div>
		</form>
	</div>

	<script>
		function saveEnter(e, qualId) {
			if (e.keyCode == 13) {
				saveEvent(qualId);
				return false;
			}
			return true;
		}

		function saveEvent(qualId) {

			const event_code = $(`#${qualId}_event_code`).val();
			const nsda_code  = $(`#${qualId}_nsda_code`).val();
			const level      = $(`#${qualId}_event_level`).val();

			const data = {
				event_code,
				nsda_code,
				level,
				qualifier_id : qualId,
				circuit_id   : <% $circuit->id %>,
				raw          : 1
			};

			postSwitch(data, 'qualifier_event.mhtml');

			$(`#${qualId}_event_code`).val(``);

			$(`#${qualId}_nsda_code option:selected`).removeAttr(`selected`);
			$(`#${qualId}_event_level option:selected`).removeAttr(`selected`);

			$(`#${qualId}_nsda_code option[value=""]`).attr(`selected`, true);
			$(`#${qualId}_event_level option[value=""]`).attr(`selected`, true);

			$(`#${qualId}_nsda_code`).trigger("chosen:updated");
			$(`#${qualId}_event_level`).trigger("chosen:updated");

			fixVisual();
		}

		function showQual() {
			const selected = $(`#qualSelect`).val();
			$('.quals').addClass("hidden");
			$(`#${selected}`).removeClass('hidden');
			fixVisual();
			$(`.first_${selected}`).focus();
			showIndy(selected);
		}

		function showIndy(selected) {
			if ($(`#${selected}_individuals`).prop("checked")) {
				$(`#${selected}_min_percent_box`).removeClass('hidden');
			} else {
				$(`#${selected}_min_percent_box`).addClass('hidden');
			}
		}

		$(document).ready( function() {
			showQual();
		});

	</script>


