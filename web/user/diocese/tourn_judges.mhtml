<%args>
	$category_id => undef
	$region
	$tourn
	$person
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline->set_time_zone($tz);

	my $hide_code = $tourn->setting("hide_codes");

	our $standard_links = "tourn_id=".$tourn->id."&region_id=".$region->id;

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	if ($category) {

		my @judges = $m->comp(
			"/funclib/ncfl/covering_judges.mas",
				diocese => $region,
				category => $category
			);

		my $tab_room++ if $category->setting("tab_room");

		my @elim_jpools = $m->comp(
			"/funclib/category_jpools.mas",
			category => $category,
			limit => "ncfl_elims"
		);

		my @prelim_jpools = $m->comp(
			"/funclib/category_jpools.mas",
				category => $category,
				limit => "ncfl_prelims"
			);

		my %judges_by_jpool = ();

		my @jpoolless_judges;

		if (@prelim_jpools) {

			foreach my $judge (@judges) {

				push (@jpoolless_judges, $judge) unless $judge->setting("prelim_jpool");
				next unless $judge->setting("prelim_jpool");

				push (@{$judges_by_jpool{$judge->setting("prelim_jpool")}}, $judge);

			}

		}

		my $jpool_obligation;

		my @chapters = sort {$a->name cmp $b->name} $region->chapters;

		my $judge_burden = $m->comp(
			"/funclib/ncfl/judge_obligation.mas",
			diocese  => $region,
			category => $category
		);

		my @events =
			sort {$a->name cmp $b->name}
			$m->comp("/funclib/tourn_events.mas", tourn => $tourn);

		my $switch;

		my $online_ballots;

		foreach my $event ($category->events) {
			$online_ballots++ if $event->setting("online_ballots");
		}

</%init>

		<div class="main">

			<h2>
				<% $region->arch ? "Archdiocese" : "Diocese" %>
				of <% $region->name %>
			</h2>

			<& menubar.mas,
				tourn  => $tourn,
				region => $region,
				whoami => "judges"
			&>

			<span class="half nospace">
				<h4>Judges for <% $category->abbr %></h4>
			</span>

			<span class="half nospace rightalign">

%				if ($now < $judge_deadline) {
					<form
						action="<% ($tab_room)
							? "tourn_tab_edit.mhtml"
							: "tourn_judge_edit.mhtml" %>"
						method="post">

						<input
							type  = "hidden"
							name  = "category_id"
							value = "<% $category->id %>">

						<input
							type  = "hidden"
							name  = "tourn_id"
							value = "<% $tourn->id %>">

						<input
							type  = "hidden"
							name  = "region_id"
							value = "<% $region->id %>">

						<input
							type  = "submit"
							value = " Add <% $category->abbr %> <% ($tab_room) ? "Tabber" : "Judge" %>"
						>
					</form>
%				}
			</span>

			<table>
<%perl>
				if (@prelim_jpools) {

					foreach my $jpool (sort {$a->id <=> $b->id} @prelim_jpools) {

						my @pool_judges = @{$judges_by_jpool{$jpool->id}}
							if $judges_by_jpool{$jpool->id};

						my $jpool_burden = $m->comp(
							"/funclib/ncfl/prelim_jpool_obligation.mas",
							diocese => $region,
							jpool   => $jpool
						);

						my $needed = $jpool_burden - scalar @pool_judges;

						$needed = 0 if $needed < 0;

						$jpool_obligation = "Short in ".$jpool->name if $needed > 0;

</%perl>
						<tr class="odd">

							<th colspan="5">
								<span class="twothird">
									<h4>Judges in <% $jpool->name %></h4>
								</span>
								<span class="third">
									(Minimum <% $jpool_burden %> owed)
								</span>
							</td>

							<td class="centeralign" colspan="4">
								<span class="<% ($needed) ? "redtext" : "greentext" %> button padmuchmore">
								<% ($needed) ? $needed." more needed " : "Obligation met!" %>
								</span>
							</td>

						</tr>

						<tr class="yellowrow">

							<th class="smaller">
								<% $hide_code ? "" : "Code" %>
							</td>

							<th class="smaller">
								First
							</th>

							<th class="smaller">
								Last
							</th>

							<th class="smaller">
								School
							</th>

							<th class="smaller">
								Exp
							</th>

%							if ($online_ballots) {
								<th title="Is account linked for online ballots?"
									class="smaller"
								>
									Linked Account?
								</th>
%							}

%							if ($now < $judge_deadline) {
								<th class="smaller" colspan="2">
									Functions
								</th>
%							} elsif ($online_ballots) {
								<th>
									Link
								</th>
%							}

						</tr>

<%perl>
						foreach my $judge (@{$judges_by_jpool{$jpool->id}}) {

							$switch = print_judge($judge, $category,$switch, $hide_code, $online_ballots);

						}

					}

					if (@jpoolless_judges) {
</%perl>

						<tr class="odd">

							<td class="strong" colspan="5">
								Judges without prelim pools:
							</td>

							<td
								class   = "smallish centeralign"
								colspan = "2"
								style   = "padding-top: 2px;"
							>
							</td>
						</tr>

						<tr class="yellowrow">

							<th class="smaller">
								<% $hide_code ? "" : "Code" %>
							</td>

							<th class="smaller">
								First
							</th>

							<th class="smaller">
								Last
							</th>

							<th class="smaller">
								School
							</th>

							<th class="smaller">
								Exp
							</th>

%							if ($online_ballots) {
								<th title="Is account linked for online ballots?"
									class="smaller"
								>
									Linked Account?
								</th>
%							}

%							if ($now < $judge_deadline) {
								<th class="smaller" colspan="2">
									Functions
								</th>
%							} elsif ($online_ballots) {
								<th>
									Link
								</th>
%							}

						</tr>

<%perl>


						foreach my $judge (@jpoolless_judges) {

							$switch = print_judge($judge, $category,$switch, $hide_code, $online_ballots);

						}

					}

				} else {

</%perl>

						<tr class="yellowrow">

							<th class="smaller">
								<% $hide_code ? "" : "Code" %>
							</td>

							<th class="smaller">
								First
							</th>

							<th class="smaller">
								Last
							</th>

							<th class="smaller">
								School
							</th>

							<th class="smaller">
								Exp
							</th>

%							if ($online_ballots) {
								<th title="Is account linked for online ballots?"
									class="smaller"
								>
									Linked Account?
								</th>
%							}

%							if ($now < $judge_deadline) {
								<th class="smaller" colspan="2">
									Functions
								</th>
%							} elsif ($online_ballots) {
								<th class="smaller">
									Link
								</th>
%							}


						</tr>

<%perl>
					foreach my $judge (@judges) {

						$switch = print_judge($judge, $category,$switch, $hide_code, $online_ballots);

					}

				}

	</%perl>

				<tr>

					<th
						colspan="4"
						class="martopmore marbottommore centeralign semibold <%
							($judge_burden > scalar (@judges))
							? "redtext"
								: ($jpool_obligation)
									? "redtext"
									: "greentext"
							%>"
					>

						<% $judge_burden %> total
						<% $tab_room ? "tabber " : "prelim judges"  %> owed,

						<% ($judge_burden - scalar (@judges) > 0)
							? ($judge_burden - scalar (@judges))." more needed"
							: ($jpool_obligation) ? $jpool_obligation : "Obligation met!"
						%>

					</td>

					<td colspan="6" class="centeralign">
					</td>
				</tr>


			</table>

%			if (@elim_jpools) {

				<a name="elims"></a>

				<h4>Judges for <% $category->abbr %> Elims:</h4>

				<p class="explain">
					Note: "D" judges (first year outs) may not judge elim
					rounds and will not appear below.
				</p>

				<p class="explain">
					Judges can only judge in one division during elims, but may
					judge a different division than they judged in prelims.
				</p>

				<table>

					<tr class="yellowrow">

						<th class="smaller">

							<form
								action = "tourn_judge_elims_save.mhtml"
								method = "post"
							>

							<input
								type  = "hidden"
								name  = "category_id"
								value = "<% $category->id %>"
							>
							<input
								type  = "hidden"
								name  = "tourn_id"
								value = "<% $tourn->id %>"
							>
							<input
								type  = "hidden"
								name  = "region_id"
								value = "<% $region->id %>"
							>
							Judge
						</th>

%						foreach my $jpool (@elim_jpools) {

							<th class="smaller centeralign">
								<% $jpool->name %>
							</th>

%						}

					</tr>

<%perl>

					foreach my $judge (
						$m->comp("/funclib/region_judges.mas",
							tourn  => $tourn,
							region => $region,
							elim   => $category
						)
					) {

						next unless $judge->category;
						next if $judge->category->setting("tab_room");

						my %jpool_yes = map {$_->id => 1} $judge->jpools;

</%perl>
						<tr class="row">

							<td class="smallish">
								<span class="threequarter">
									<% $judge->first." ".$judge->last %>
								</span>
								<span class="quarter">
									<% $judge->category->abbr %>
								</span>
							</td>

%							foreach my $jpool (@elim_jpools) {

%								next if (index($judge->avg, "D") != -1) &! ($jpool->setting("fyo_ok"));

								<td class="centeralign nospace">

									<label for="<% $judge->id %>_<% $jpool->id %>">

										<span class="hover full padless marno">

%											if ($now < $judge_deadline) {
												<input
													type  = "checkbox"
													id    = "<% $judge->id %>_<% $jpool->id %>"
													name  = "<% $judge->id %>_<% $jpool->id %>"
													value = "1"
													<% $jpool_yes{$jpool->id} ? "checked" : "" %>
												>
%											} else {
												<% $jpool_yes{$jpool->id} ? "Y" : "" %>
%											}
										</span>
									</label>
								</td>
%							}

						</tr>
%					}

<%perl>

					# Calculate the total owed if the region is small enough to
					# qualify for the Alternative Maximum Tax.

					my ($total_owed, $style) =
						$m->comp(
							"/funclib/ncfl/jpool_obligation.mas",
							diocese => $region,
							category => $category
						);

</%perl>

					<tr class="row">

						<th class="bluetext padvertmore semibold">
							Elim Rounds Owed:
						</td>

%						if ($style eq "overall") {

							<td colspan="6" class="">
%							if ($total_owed) {

								<span class="full nospace semibold redtext">
									<% $total_owed %> more elim round(s) required
								</span>

%							} else {

								<span class="full nospace semibold bigger greentext">
									Elim round obligation met!
								</span>
%							}
							</td>

<%perl>

						} else {

							foreach my $jpool (@elim_jpools) {

								my ($owed, $ditch) = $m->comp(
									"/funclib/ncfl/jpool_obligation.mas",
									diocese => $region,
									jpool   => $jpool
								);
</%perl>

								<td class="centeralign">
									<span class="button padmuchmore strong
										<% $owed ? "redtext" : "greentext" %>"
									>
										<% ($owed) ? $owed." more " : "OK!" %>
									</span>
								</td>
%							}
%						}
					</tr>

%					if ($now < $judge_deadline) {
						<tr class="liblrow">
							<td colspan="8" class="rightalign">
								<input
									type  = "submit"
									class = "thin"
									value = "  Save Elim Assignments "
								>
								</form>
							</td>
						</tr>
%					}

				</table>

%			}

%			unless ($tab_room) {

%				if ($now < $judge_deadline) {
					<p class="martopmore">

						For elim rounds, you owe EITHER a percentage of your
						judges for each elim round, OR a total of elim rounds
						equal to

						<% $category->setting("max_burden") ? "" : "2x" %>

						the number of judges you owe in that judge category,
						whichever is smaller.  This rule affects smaller
						dioceses, keeping them from having to place their
						judges in every elim round to fill quotas.
					</p>

					<p>
						A diocese owing 2 judges in a category thus only owes
						<% $category->setting("max_burden") ? "2" : "4" %> elim rounds
						total.  You may, of course, always register to judge MORE
						elims than your obligation, if desired.
					</p>

%				} else {

					<p>
						The judge change deadline has passed.  Please email changes directly
						to <a href="mailto:ncfl@tabroom.com">ncfl@tabroom.com</a>
					</p>

%				}
%			}

%	} else {

		<div class="main">

			<h2>
				<% $region->arch ? "Archdiocese" : "Diocese" %>
				of <% $region->name %>
			</h2>

			<& menubar.mas,
				tourn  => $tourn,
				region => $region,
				whoami => "judges"
			&>

			<h5 class="martopmuchmore centearlign">
				Choose a judge category at right to begin
			</h5>
%	}

%	if ($category && $category->setting("judge_policy")) {
		<h4>Note:</h4>
		<p><% $category ? $category->setting('judge_policy') : "" %></p>
%	}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Categories</h4>

<%perl>

				foreach my $other_category (
					sort {$a->name cmp $b->name}
					$tourn->categories
				) {

					my @judges = $m->comp(
						"/funclib/ncfl/covering_judges.mas",
							diocese  => $region,
							category => $other_category
						);

					my $judge_burden = $m->comp(
						"/funclib/ncfl/judge_obligation.mas",
							diocese  => $region,
							category => $other_category
						);

					my $remainder = $judge_burden - scalar @judges;

					my ($total_owed, $style) = $m->comp(
						"/funclib/ncfl/jpool_obligation.mas",
							diocese  => $region,
							category => $other_category
						);

</%perl>
					<a 	class="<% $remainder > 0
						? "red"
						: $other_category == $category_id
							? "dkblue"
							: "blue"
						%> full"

						href="tourn_judges.mhtml?category_id=<% $other_category->id %>&<% $standard_links %>">

						<span class="threequarter">
							<% $other_category->name %>
						</span>

						<span class="quarter">
							<% scalar @judges %>/<% $judge_burden %>
						</span>
					</a>

%					if ($remainder <= 0 && $total_owed > 0) {
						<div class="nospace rightalign">
							<span class="<% $other_category == $category_id
											? "dk"
											: ""
										%>red fourfifths padmore rightalign smaller">
								<% $total_owed %> <% $other_category->abbr %> Elims Owed
							</span>
						</div>
%					}
%				}
		</div>
	</div>

<%perl>

	undef $standard_links;

	sub print_judge {

		my ($judge, $category, $switch, $hide_code, $online_ballots) = @_;

		my $rating = $judge->avg;
		$rating =~ s/\d//g;

		my $tourn = $category->tourn;

		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;

		my $now = DateTime->now(time_zone => $tz);

		my $judge_deadline = $tourn->setting("judge_deadline");
		$judge_deadline->set_time_zone($tz);

		my $region = $judge->school->region;

</%perl>

		<tr class="row">

			<td class="smallish centeralign">
				<% $hide_code ? $switch."." : $judge->code %>
			</td>

			<td class="smallish">
				<% $judge->first %>
			</td>

			<td class="smallish">
				<% $judge->last %>
			</td>

			<td class="smallish">
				<% $judge->school ? $judge->school->name : "Hired" %>
			</td>

			<td class="smallish centeralign">
				<% $rating %>
			</td>

%			if ($online_ballots) {
				<th
					class="centeralign"
					title="Online ballot account <% $judge->person > 0 ? "LINKED!" : "Not Linked" %>"
				>
					<span class="fa fa-2x <% $judge->person > 0
						? "fa-check-circle-o greentext"
						: "fa-times redtext"
					%>">
					</span>
				</th>
%			}

%			if ($judge && $judge->alt_category && $judge->alt_category->id == $category->id ) {

				<td
					colspan = "2"
					class   = "smallish centeralign"
				>

					<a class="semibold biggish bluetext"
						href="tourn_judges.mhtml?<% $standard_links %>&category_id=<% $category->id %>"
					>
						From <% $judge->category->name %>
					</a>
				</td>

%			} else {

%				if ($now < $judge_deadline) {


					<td class="centeralign smallish">
						<a
							class="buttonwhite padless bluetext marless fa fa-edit"
							href="tourn_judge_edit.mhtml?<% $standard_links %>&judge_id=<% $judge->id %>">
						</a>
					</td>

					<td class="centeralign smallish">
%						my $warn = "You are about to drop that judge entirely.  Are you sure?";

						<a
							class="buttonwhite padless redtext fa fa-trash fa-lg marless"
							href="tourn_judge_drop.mhtml?<% $standard_links %>&judge_id=<% $judge->id %>"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
						</a>
					</td>

%				} elsif ($online_ballots) {

					<td class="centeralign smallish">
%						unless ($judge->person > 0) {
						<a
							class = "buttonwhite padless bluetext marno fa fa-link"
							href  = "tourn_judge_link.mhtml?<% $standard_links %>&category_id=<% $category->id %>&judge_id=<% $judge->id %>">
						</a>
%						}
					</td>

%				}

%			}

		</tr>

%		return $switch;

%	}
