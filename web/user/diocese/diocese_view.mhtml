<%args>
	$session
	$account
	$diocese_id
</%args>
<%init> 

	my $diocese = Tab::Region->retrieve($diocese_id);

	my $circuit = $diocese->circuit;

	$session->circuit($circuit->id);
	$session->update;

	unless ($diocese->director->id eq $account->id || $account->site_admin) { 

		$m->redirect("$Tab::url_prefix/account/access_denied.mhtml");
	}

    my @all_tourns = Tab::Tourn->search( circuit => $circuit->id );

    my @open_tourns;
	my @closed_tourns; 

    my $now = DateTime->now(time_zone => $circuit->timezone);

    foreach my $at (@all_tourns) {

        if ($now->epoch < $at->reg_end->epoch && $now->epoch > $at->reg_start->epoch) {
            push (@open_tourns, $at);
        }

		if ($now->epoch < $at->end->epoch && $now->epoch > $at->reg_end->epoch) { 
			push (@closed_tourns, $at);
		}
    }

	my $switch;

</%init>

	<div class="left huge">

		<h2><% ($diocese->arch) ? "Archdiocese" : "Diocese" %> of <% $diocese->name %></h2>

		<table width="100%" cellspacing="1" cellpadding="6">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Director:
				</td>
	
				<td align="right">
					<form action="contact_save.mhtml" method="post">
					<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					<% $diocese->director->first." ".$diocese->director->last %>
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Quota:
				</td>

				<td align="right">
					<% $diocese->quota %>
				</td>

			</tr>

			<tr>
				<td colspan="2">
					<h3 style="margin-left: -5px;">Diocesan director contact info:</h3>
				</td>
			</tr>


			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Cell Phone Number:
				</td>

				<td align="right">
					<input type="text" name="phone" value="<% $account->phone %>" size="30">
				</td>

			</tr>

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Which hotel are you staying at?
				</td>

				<td align="right">
					<input type="text" name="hotel" value="<% $account->hotel %>" size="30">
				</td>

			</tr>

			<tr class="liblrow">
				<td colspan="2" align="right">
					<input type="submit" value="   Save Contact Info   ">
					</form>
				</td>
			</tr>

		</table>

		<br />
		<br />

% 			foreach my $tourn (@open_tourns) { 

				<h3>Register for <% $tourn->name %></h3>

					<p style="padding-left: 5px;">Before entering, be sure to update your schools at right, and make any coach
					credit changes for the program book.</p>

					<table cellpadding="6" cellspacing="1" width="100%">

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

							<td>
								You must add entries by
							</td>

							<td class="smaller">
								<% &Tab::nicedt($tourn->reg_end->set_time_zone($circuit->timezone)) %>
							</td>
		
						</tr>

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
		
							<td>
								Nuisance fines for changes start at
							</td>

							<td class="smaller">
								<% &Tab::nicedt($tourn->fine_deadline->set_time_zone($circuit->timezone)) %>
							</td>
			
						</tr>

						<tr class="liblrow"> 
						
							<td colspan="2" align="right">
								<form action="diocese_entry.mhtml" method="post">
								<input type="hidden" name="diocese_id" value="<% $diocese_id %>">
								<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
								<input  type="submit" value="Register for <% $tourn->name %>">
								</form>
							</td>
						</tr>

					</table>

% 			}

% 			foreach my $tourn (@closed_tourns) { 
					
				<table cellpadding="6" cellspacing="1" width="100%">

				<tr>
					<td colspan="3">

						<p>Registration for Nationals has closed.  Please email
						any further changes to ncfl@tabroom.com.  Thank
						you!
						</p>

					</td> 

				</tr>
				
				<tr class="liblrow">
				
					<td colspan="3" align="right"> 
						<form action="print_entry.mhtml" method="post">
						<input type="hidden" name="diocese_id" value="<% $diocese_id %>">
						<input type="hidden" name="tourn_id" value="<% $tourn->id %>"> 
						<input  type="submit" value="   Print Registration Sheet for <% $tourn->name %>   ">
						</form>
					</td>

				</tr>
		
				</table>
% 			}

	</div>

	<div class="right small">
	
		<h3>Member Schools:</h3>

			<a class="red block" href="chapter_edit.mhtml?diocese_id=<% $diocese->id %>">Create New School</a>

		<h4>Edit Existing Schools:</h4>

% 			foreach my $chapter (sort {$a->name cmp $b->name} $diocese->chapters) { 
				<a class="blue block" href="chapter_edit.mhtml?chapter_id=<% $chapter->id %>"><% $chapter->name %></a>
% 			} 

% 			if ($account->site_admin) { 

				<p>
					Diocese ID: <% $diocese->id %>
				</p> 
%			}	

	</div>

	<br style="clear: both;">
