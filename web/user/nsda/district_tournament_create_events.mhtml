<%args>
	$person
	$person_settings
	$district_id => undef
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id) if $district_id;
	$m->abort unless $district;

	my $permission = Tab::Permission->search( 
		district => $district->id,
		person   => $person->id 
	)->first;

	$permission++ if $person->site_admin;
	$permission++ if $person_settings->{"nsda_admin"};

	unless ($permission) { 
		$m->print('<div class="main"><h4 class="warning">');
		$m->print("You do not have access to that district");
		$m->print('</h4></div>');
		$m->abort();
	}

	my @existing = $m->comp("/funclib/district_tourns.mas", 
		district => $district
	);

	my ($keys, $event_ref) = $m->comp("/funclib/nsda_events.mas");

	my @event_keys = @{$keys};
	my %events = %{$event_ref};

	my @types = ("congress", "debate", "speech");

	my $tourn_name = $district->name." District Tournament";
	my $webname = lc($district->name);

	$webname =~ s/\([^)]*\)//;
	$webname =~ s/[\W_]//g;

	my $tz = $ARGS{"tz"};
	$tz = "America/Chicago" unless $tz;

	my @weekend_hashes;

	my $earliest_start;
	my $latest_end;

	foreach my $tick (1 .. 4) { 

		my $start_dt;
		my $end_dt;

		my $start_time = "08:00:00";
		my $end_time   = "20:00:00";

		eval { 
			$start_dt = Tab::dtme($ARGS{"start_date_".$tick}, $start_time, $tz);
			$end_dt = Tab::dtme($ARGS{"end_date_".$tick}, $end_time, $tz);
		};


		if ($ARGS{"name_".$tick} && $start_dt && $end_dt) { 

			my %weekend = ( 
				name  => $ARGS{"name_".$tick},
				start => $start_dt,
				end   => $end_dt
			);

			push @weekend_hashes, \%weekend;

			$earliest_start = $start_dt->clone() unless $earliest_start;
			$latest_end = $end_dt->clone() unless $latest_end;

			$earliest_start = $start_dt->clone() if $start_dt < $earliest_start;
			$latest_end = $end_dt->clone() if $end_dt > $latest_end;

		}

	}

	my $tourn;

	$tourn = shift @existing 
		if @existing;

	my @weekends;
	my %event_weekend;

	my %event_ballots;

	if ($tourn) { 

		@weekends = $tourn->weekends();

		foreach my $event ($tourn->events) { 
			$event_weekend{$event->abbr} = $event->setting('weekend');
			$event_ballots{$event->abbr} = $event->setting('nsda_ballot_order');
		}

	} elsif ($earliest_start && $latest_end) { 

		my $reg_start = $earliest_start->clone();
		$reg_start->subtract(months => 1);

		my $reg_end = $earliest_start->clone();
		$reg_end->subtract(days => 7);

		my $state = substr($district->location, 0, 2);

		$tourn = Tab::Tourn->create({
			name      => $tourn_name,
			tz        => $tz,
			start     => $earliest_start,
			end       => $latest_end,
			reg_start => $reg_start,
			reg_end   => $reg_end,
			webname   => $webname,
			hidden    => 0,
			country   => "US",
			state     => $state
		});

		foreach my $weekend (@weekend_hashes) { 

			my $start = $weekend->{'start'};
			my $end = $weekend->{'end'};

			my $reg_start = $start->clone();
			$reg_start->subtract(months => 1);

			my $reg_end = $start->clone();
			$reg_end->subtract(days => 7);

			$reg_end->set( hour => 20);

			my $weekend_obj = Tab::Weekend->create({
				name            => $weekend->{"name"},
				tourn           => $tourn->id,
				start           => $start,
				end             => $end,
				reg_start       => $reg_start,
				reg_end         => $reg_end,
				freeze_deadline => $reg_end,
				drop_deadline   => $reg_end,
				judge_deadline  => $reg_end,
				fine_deadline   => $reg_end,
			});

			push @weekends, $weekend_obj;

		}

	}

	$tourn->setting("nsda_district", $district->id);
	$tourn->setting("nsda_speech_method", $ARGS{"nsda_speech_method"});
	$tourn->setting("nsda_tabbing_software", $ARGS{"nsda_tabbing_software"});
	$tourn->setting("nsda_tabroom_first", $ARGS{"nsda_tabroom_first"});

	if ($ARGS{"nsda_pilot_speech"}) { 
		$tourn->setting("nsda_speech_method", "california_2");
	} 

	$tourn->setting("nsda_pilot_speech", $ARGS{"nsda_pilot_speech"});
	$tourn->setting("nsda_pilot_debate", $ARGS{"nsda_pilot_debate"});
	$tourn->setting("nsda_pilot_congress", $ARGS{"nsda_pilot_congress"});

	my %questions = $m->comp("/funclib/districts_awards.mas");

	foreach my $key (sort keys %questions) { 
		$tourn->setting($questions{$key}{"label"}, $ARGS{$questions{$key}{"label"}});
	}

</%init>

	<script>

		$(function() {

			$('form').on('submit', function(e) { 

				var weGood = true;

				$(".options").each(function() { 

			        var question = $(this);

			        if (!$(this).find('input').is(':checked')) {

						$(question).addClass('lird');
						weGood = false;

					} else {
						$(question).removeClass('lird');
					}

				});

				if (weGood) {

					return weGood;

				} else { 
				 	e.preventDefault();
					alertify.confirm("You have to assign weekends to every event before continuing.");
				}

			});

		});

	</script>

	<div class="menu">
		<& "nsda_step.mas", step => 2 &>
	
	</div>

	<div class="main">

		<h2>Events Schedule</h2>

			<p class="semibold bigger centeralign nospace">
				Please indicate which weekend/dates each event is held on.  If
				you are not offering a qualifier in a given event, select "Not
				Offered".  
			</p>
				
			<p class="semibold bigger centeralign marbottommore">
				You can change this later if you alter your district dates.
			</p>
			
			<form 
				action = "district_tournament_dates.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "district_id"
				value = "<% $district->id %>"
			>

			<div class="row semibold ltyellow">

				<span class="eighth">
					Event
				</span>

				<span class="half centeralign">

%					foreach my $weekend (@weekends) { 
						<span 
							title="<% $weekend->name %>"
							class="fifth centeralign  marno"
						>
							<div class="full padno marless smaller"><% $weekend->name %></div>
							<% $weekend->start->month."/".$weekend->start->day %>
						</span>
%					}

					<span class="fifth centeralign smallish marno redtext">
						Not Offered
					</span>

				</span>

				<span class="threeeighths">
					Order debate ballots:
				</span>

			</div>

%		foreach my $event (@event_keys) { 

			<div class="row <% $event %>">

				<span class="eighth">
					<% $event %>
				</span>

				<span 
					id    = "options_<% $event %>"
					class = "half nospace options centeralign"
				>

%					foreach my $weekend (@weekends) { 

						<label for="<% $weekend->id %>_<% $event %>" >
							<span 
								class = "fifth hover centeralign marno"
								title = "<% $weekend->name %>"
							>
								<input 
									type     = "radio"
									class    = "eventradios"
									name     = "<% $event %>"
									value    = "<% $weekend->id %>"
									id       = "<% $weekend->id %>_<% $event %>"
									tabindex = "-1"
									<% $event_weekend{$event} == $weekend->id ? 
										'checked'
										: ""
									%>
								>
							</span>
						</label>
%					} 

					<label for="nope_<% $event %>">
						<span 
							class = "fifth redhover centeralign marno ltborder"
							title = "No Qualifier Held in <% $event %>"
						>
							<input 
								type     = "radio"
								class    = "eventradios"
								name     = "<% $event %>"
								value    = "nope"
								id       = "nope_<% $event %>"
								<% $event_weekend{$event} eq "nope" 
									? 'checked'
									: ""
								%>
							>
						</span>
					</label>

				</span>

				<span class="threeeighths">

%					if ($events{$event}{"ballots"}) { 
						Order

						<input 
							type  = "number"
							name  = "<% $event %>_ballots"
							min   = "0"
							max   = "9999"
							value = "<% $event_ballots{$event} %>"
						>
						<% $event %> ballots
%					}

				</span>

			</div>

%		}
	
		<div class="liblrow rightalign">
			<input 
				type  = "submit"
				value = "Go to Next Step"
			>
			</form>
		</div>

	</div>

