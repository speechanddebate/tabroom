<%args>
	$person
	$chapter_id
	$nsda_chapter_id => undef
</%args>
<%init>

	use Tab::NSDA::MemberSchool;
	use Tab::NSDA::Person;
	use Tab::NSDA::Login;
	use Tab::NSDA::PersonSchool;

	my $is_admin++ if Tab::Permission->search( 
		tag     => "chapter",
		person  => $person->id,
		chapter => $chapter_id
	);

	$m->abort unless $is_admin;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my $nsda_chapter;

	if ($person->nsda) { 

		my @candidates = $m->comp(
			"/funclib/nsda_school_by_person.mas", 
			nsda => $person->nsda
		);

		foreach my $candidate (@candidates) { 
			$nsda_chapter = $candidate if $candidate->school_id == $nsda_chapter_id;
			last if $nsda_chapter;
		}
	}

	unless ($nsda_chapter) { 

		my $err = "You do not have access to a target member school ";
		$err .= "in the NSDA Points System, so you may not link students";
		$m->redirect("index.mhtml?err=$err");
	}

	$chapter->name($nsda_chapter->school_name);
	$chapter->city($nsda_chapter->school_city);
	$chapter->state($nsda_chapter->school_state);
	$chapter->level("highschool") if $nsda_chapter->realm eq "NFL";
	$chapter->level("university") if $nsda_chapter->realm eq "PKD";
	$chapter->level("middle") if $nsda_chapter->realm eq "MID";
	$chapter->nsda($nsda_chapter_id);

	$chapter->update;

	$chapter->setting('nsda_degrees', $nsda_chapter->school_total_deg);
	$chapter->setting('nsda_charter', $nsda_chapter->school_charter_status);
	$chapter->setting('nsda_paid', $nsda_chapter->school_paid_status);

	$m->redirect("student_roster.mhtml?chapter_id=$chapter_id")

</%init>
