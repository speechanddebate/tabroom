<%args>
	$person
	$person_settings
	$district_id => undef
	$name        => undef
	$city        => undef
	$state       => undef
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id) 
		if $district_id;

	$m->abort unless $district;

	my $permission = Tab::Permission->search( 
		district => $district->id,
		person   => $person->id 
	)->first;

	$permission++ if $person->site_admin;
	$permission++ if $person_settings->{"nsda_admin"};

	unless ($permission) { 
		$m->print('<div class="main"><h4 class="warning">');
		$m->print("You do not have access to that district");
		$m->print('</h4></div>');
		$m->abort();
	}

	my @exists = $m->comp(
		"/funclib/district_tourns.mas", 
		district => $district
	);

	my $existing = $exists[0] if @exists;

	my %questions = $m->comp("/funclib/districts_awards.mas");

	my $tz = $existing->tz if $existing;
	$tz = $person->tz unless $tz;
	$tz = "America/Chicago" unless $tz;

</%init>

	<div class="menu">

		<& "nsda_step.mas", step => 1 &>

		<div class="sidenote">

			<h5>Districts Signup Notes</h5>

			<p>
				This year, you should create a district tournament series
				within Tabroom whether or not you will be using it to tabulate.
				The Tabroom district listing will inform the NSDA Office of
				information we need to know about events, dates, and locations.
				Also, once your district tournament(s) are finished, you will
				upload results into Tabroom even if you tabulation on Joy of
				Tournaments.
			</p>

			<p>
				This process will streamline both Nationals registration, and
				will allow district chairs to confirm promotion of alternates
				for declined entries to Nationals. 
			</p>

			<p>
				All districts on Tabroom will consist of one and only one
				master tournament.  You can configure a tournament to run on
				multiple weekends now to support that; the tournament will have
				separate dates, registration deadlines, etc for each weekend
				you run on. 
			</p>


		</div>

	
	</div>

	<div class="main">

		<h2>Create a New District Tournament</h2>

		<form 
			action = "district_tournament_create_events.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "district_id"
			value = "<% $district->id %>"
		>

		<h4>General Information</h4>

			<div class="row">

				<span class="third ">
					Time Zone
				</span>

				<span class="twothirds">
				
					<select 
						name  = "tz"
						class = "fixedbig"
					>

						<& 
							"/funclib/timezones.mas", 
							country => "US",
							tz      => $tz
						&>

					</select>
				</span>

			</div>

			<h4>Dates/Weekends</h4>

			<p class='explain centeralign'>
				If you don't know the precise dates of all your weekends, put
				in your best estimate; it can be changed later.
			</p>

			<p class="explain centeralign">
				There's no need to include your district name in the weekend
				name; that will be included automatically.  Names like "IE
				&amp; Congress" or "Debate" are fine.
			</p>

			<p class="explain centeralign semibold redtext">
				New in 2017-18: Be sure to list the weekend of your Big
				Questions event (and register by Nov 15th) if you want to qualify
				for grant funding.
			</p>

%			my @weekends = $existing->weekends() if $existing;

%			foreach my $notch (1 .. 5) { 

%				my $weekend = shift @weekends if @weekends;

				<div class="row">

					<span class="tenth semibold">
						<% $notch %>.
					</span>

					<span class="twofifths">
						<input 
							type        = "text"
							name        = "name_<% $notch %>"
							size        = "32"
							placeholder = "Weekend Label (IE, Debate, Congress, etc)"
							value       = "<% $weekend ? $weekend->name : "" %>"
						>
					</span>

					<span class="fifth">

						<& "/funclib/datepicker.mas", id => "start_".$notch &>

						<input 
							name        = "start_date_<% $notch %>"
							type        = "text"
							id          = "start_<% $notch %>"
							size        = 12
							placeholder = "Start Date"
							value       = "<% $weekend ? Tab::pickerdate($weekend->start) : "" %>"
						>
					</span>

					<span class="fifth">

						<& "/funclib/datepicker.mas", id => "end_".$notch &>

						<input 
							name        = "end_date_<% $notch %>"
							type        = "text"
							id          = "end_<% $notch %>"
							size        = 12
							placeholder = "End Date"
							value       = "<% $weekend ? Tab::pickerdate($weekend->end) : "" %>"
						>
					</span>


				</div>

%			}

			<h4 class="martopmore">Rules &amp; orders</h4>

			<div class="row ">

				<span class="sixth semibold">
					IE Ruleset
				</span>

				<span class="fivesixths nospace rightalign">

					<label for="doubledown">
				
						<span class="third leftalign hover">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "doubledown"
								value = "doubledown"
								<% $existing && $existing->setting("nsda_speech_method") eq "doubledown"
									? 'checked="checked"' 
									: ""
								%>
							
							>Double Downs

						</span>

					</label>

					<label for="california_3">

						<span class="third leftalign hover">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "california_3"
								value = "california_3"
								<% $existing && $existing->setting("nsda_speech_method") eq "california_3" 
									? 'checked="checked"' 
									: ""
								%>
							>California Plan w/3 judges

						</span>

					</label>

					<label for="california_2">

						<span class="third leftalign hover marno">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "california_2"
								value = "california_2"
								<% $existing && $existing->setting("nsda_speech_method") eq "california_2" 
									? 'checked="checked"' 
									: ""
								%>
							>California Plan w/2 judges

						</span>

					</label>

				</span>

			</div>

			<div class="row">

				<span class="sixth semibold">
					Tabbing Software
				</span>

				<span class="fivesixths nospace rightalign">

				<label for="tabroom">
					<span class="third leftalign hover">
						<input 
							type    = "radio"
							name    = "nsda_tabbing_software"
							id      = "tabroom"
							value   = "tabroom"
							<% $existing && $existing->setting("nsda_tabbing_software") ne "jot"
								? 'checked="checked"' 
								: ""
							%>
						>Tabroom.com
					</span>
				</label>

				<label for="jot">
					<span class="third leftalign hover">
						<input 
							type    = "radio"
							name    = "nsda_tabbing_software"
							id      = "jot"
							value   = "jot"
							<% $existing && $existing->setting("nsda_tabbing_software") eq "jot"
								? 'checked="checked"' 
								: ""
							%>
						>Joy of Tournaments
					</span>
				</label>

				</span>

			</div>

%			foreach my $key (sort keys %questions) { 
	
				<label for="<% $questions{$key}{"label"} %>">

					<div class="row hover">

						<span class="fourfifths">
							<% $questions{$key}{"text"} %>
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								id    = "<% $questions{$key}{"label"} %>"
								name  = "<% $questions{$key}{"label"} %>"
								value = "1"
								<% $existing && $existing->setting($questions{$key}{"label"}) 
									? 'checked="checked"' 
									: ""
								%>
							> Yes
						</span>

					</div>
				</label>
%			}

			<div class="liblrow rightalign">
				<input 
					type  = "submit"
					value = "Step Two: Assign Events to Dates"
				>

				</form>
			</div>

	</div>
