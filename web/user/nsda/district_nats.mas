<%args>
	$district
	$tourn
	$person
	$chapter => undef
</%args>
<%init>

	my $now = DateTime->now();
	my $deadline = $tourn->setting("bill_deadline");
	$deadline->set_time_zone($tourn->tz);

	use List::Util;
		
</%init>

		<div class="martopmuchmore padtopmore bordertop full padno">

			<span class="half nospace">
				<h5 class="nospace">District Congress Legislation</h5>
			</span>

			<span class="quarter semibold bluetext bigger centeralign nospace">
				Due: <% Tab::nicedate($deadline) %>
			</span>

			<span class="quarter semibold redtext bigger rightalign nospace">
				1 bill per file please
			</span>
		</div>

%		if ($tourn->setting("legislation_message")) { 
			<div class="biggish padmuchmore full">
				<% $tourn->setting("legislation_message") %>
			</div>
%		}

<%perl>


		my $limit = 2;

		foreach my $file ($tourn->files( 
				type     => "bill",
				tourn    => $tourn->id,
				district => $district->id
			) 
		) { 

			$limit--;
</%perl>

			<div class="row">
				
				<span class="half">
					<a 
						class = "plain semibold bluetext"
						href  = "<% $Tab::s3_url %>/<% $tourn->id %>/bills/<% $district->id %>/<% $file->id %>/<% $file->filename %>"
					><% $file->filename %></a>
				</span>

				<span class="fourtenths">
					<div class="full nospace padless">
						Posted by <% $file->person->first." ".$file->person->last %>
					</div>
					<div class="full nospace padless">
						at <% Tab::csvdt($file->uploaded) %>
					</div>
				</span>

%				my $warn = "This will delete this piece of legistlation.  Are you sure?";

%				unless ($now > $deadline) { 
					<span class="tenth">
						<a 
							<& "/funclib/confirm.mas", warn => $warn &> 
							class="fa fa-sm fa-trash buttonwhite redtext"
							href="/user/nsda/legislation_rm.mhtml?file_id=<% $file->id %>&district_id=<% $district %>"
						></a>
					</span>
%				}

			</div>

%		}

%		if (($limit > 0) && ($now < $deadline)) { 

			<form 
				action   = "/user/nsda/upload_legislation.mhtml"
				enctype = "multipart/form-data"
				method   = "post"
			>

				<input 
					type  = "hidden"
					value = "<% $district->id %>"
					name  = "district_id"
				>

				<input 
					type  = "hidden"
					value = "<% $tourn->id %>"
					name  = "tourn_id"
				>

				<div class="row">

					<span class="quarter semibold">
						Upload Legislation:
					</span>

					<span class="half centeralign nospace">
						<div class="uploader wider">

							<input 
								type     = "file"
								name     = "bill"
								style    = "opacity: 0;"
								onchange = "uploaderName('bill', 'bill_file');"
								id       = "bill"
							>

							<span 
								id    = "bill_file"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>

						</div>
					</span>

					<span class="quarter rightalign">
						<input type="submit" value="Upload Bill">
					</span>

				</div>

			</form>

%		}

<%perl>

		my $ws_event = $tourn->events(
			type => "wsdc"
		)->first;

		my $ws_cat = $ws_event->category;

		my $district_school = $tourn->schools( 
			chapter  => 0,
			district => $district->id
		)->first;

		my @existing_teams = $district_school->entries( 
			event => $ws_event->id 
		) if $district_school;


		my @paid_members;
		my %taken;

		foreach my $member ($district->chapters()) { 
			next unless $member->nsda;
			next unless $member->setting("nsda_paid");
			push @paid_members, $member;
			$taken{$member->nsda}++;
		}

		my @non_tabroom_schools; 

		SCHOOL:
		foreach my $nsda_school (
			$m->comp("/funclib/district_schools.mas", 
				district => $district
			)
		) { 

			next if $taken{$nsda_school->school_id};

			my $other = Tab::Chapter->search(
				nsda => $nsda_school->school_id
			)->first;

			if ($other) { 
				$other->district($district->id);
				$other->update();
				push @paid_members, $other;
				next SCHOOL;
			} elsif ($nsda_school->school_status > 0) { 
				push @non_tabroom_schools, $nsda_school;
			}
		}
		my $year = $now->year;
		$year-- if $now->month < 8;

		Tab::Student->set_sql(nats_eligible => "

			select student.* 
				from student 
				where student.chapter = ? 
				and student.nsda > 0
				and student.retired != 1
				and student.grad_year > ?

				and exists ( 
					select nsda_paid.id
					from student_setting nsda_paid
					where nsda_paid.student = student.id
					and nsda_paid.tag = 'nsda_paid'
					and nsda_paid.value = 1
				)

				and not exists (

					select es.id
					from entry_student es, entry, event
					where event.tourn = ? 
					and event.id = entry.event
					and entry.id = es.entry
					and es.student = student.id

					and not exists ( 
						select supp.id
						from event_setting supp
						where supp.event = event.id
						and supp.tag = 'supp'
						and supp.value = 1
					)
					and not exists ( 
						select conn.id
						from event_setting conn
						where conn.event = event.id
						and conn.tag = 'conn'
						and conn.value = 1
					)

					and not exists (
						select rejection.id
						from entry_setting rejection
						where rejection.entry = entry.id
						and rejection.tag = 'rejected_by'
						and rejection.value > 0
					)
				)

				order by student.last
		");

		my %chapter_students;

		foreach my $paid_member (@paid_members) { 
		 	push @{$chapter_students{$paid_member->id}}, 
				Tab::Student->search_nats_eligible($paid_member->id, $year, $tourn->id);
		}

		my @colors = ( 
			"red",
			"white",
			"blue",
			"black",
			"orange",
			"violet",
			"gold",
			"green",
			"yellow",
			"gray",
			"silver",
			"brown"
		);

	@paid_members = sort {$a->name cmp $b->name} @paid_members;

	my $cap = $ws_event->setting("district_cap");
	$cap = scalar @existing_teams if (scalar @existing_teams) > $cap; 

	my $max = $ws_event->setting('max_entry');
	my $min = $ws_event->setting('min_entry');

</%perl>

		<div class="martopmuchmore bordertop full padno nospace">

			<div class="full nospace martopmore">

				<span class="half nospace">
					<h4 class="nospace">
						World Schools District Teams
					</h4>
				</span>

				<span class="fourtenths nospace centeralign semibold redtext">
					Teams must have <% $min %>-<% $max %> competitors
				</span>

				<span class="tenth centeralign nospace">
					<a 
						class = "buttonwhite bluetext fa fa-file-pdf-o"
						title = "Print WSDC Entry"
						href  = "wsdc_print.mhtml?district_id=<% $district->id %>&tourn_id=<% $tourn->id %>"
					></a>
				</span>

			</div>

		</div>

%		if (@non_tabroom_schools) { 

			<form 
				action = "import_chapter.mhtml"
				method = "post"
			>

			<div class="row martopmore marbottommore">

				<span class="quarter semibold bluetext padsetting padno smallish">
					Add a school not in Tabroom:
				</span>

				<span class="centeralign half">
					<select 
						name  = "nsda_school_id"
						class = "fixedbig"
					>
%					foreach my $nts (@non_tabroom_schools) { 
						<option 
							value="<% $nts->school_id %>"
						><% $nts->school_name %></option>
%					}
					</select>
				</span>

				<span class="quarter nospace">
					<input 
						type  = "submit"
						value = "Add School"
						class = "thin"
					>
				</span>

			</div>
			</form>
%		}

		<form 
			action = "/user/nsda/wsdc_team_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>
		<input 
			type  = "hidden"
			name  = "district_id"
			value = "<% $district->id %>"
		>

<%perl>

		foreach my $team (1 .. $cap) { 

			my $existing = shift @existing_teams if @existing_teams;

			my $code;
			$code = $existing->code if $existing;

			my $dist_name = $district->name." ";
			$code =~ s/$dist_name//g;
			$code = lc($code);

			my @students;
			@students = $existing->students if $existing;

</%perl>

			<div class="full martop">

				<span class="sixth nospace">
					<h5 class="nospace">Team <% $team %></h5>
				</span>

				<span class="fivesixths rightalign nospace">

					<span class='third rightalign'>
						<% $district->name %>
					</span>

					<span class='third leftalign marrightmore'>
						<select name="<% $team %>_color" class="fixedsmall">
%							foreach my $color (List::Util::shuffle @colors) { 
								<option 
									value="<% $color %>"
									<% $color eq $code ? "selected" : "" %>
								><% ucfirst($color) %></option>
%							}
						</select>
					</span>

					<span class="third explain semibold centeralign bluetext">
						It is traditional to choose team colors
						from your state or national flag.
					</span>

				</span>

			</div>

%			foreach my $count (1 .. $ws_event->setting('max_entry')) { 

%				my $already;
%				$already = shift @students if @students;

				<div class="row">

					<span class="tenth semibold bluetext padsetting centeralign">
						<% $count %>.

						<% $already %>
					</span>

					<span class="fourtenths centeralign">

						<select 
							name     = "<% $team %>_<% $count %>_school"
							id       = "<% $team %>_<% $count %>_school"
							class    = "fixedbig schools"
							team     = "<% $team %>"
							count    = "<% $count %>"
							onChange = "showSchools();"
						>

						<option value=""></option>

%						foreach my $chapter (@paid_members) { 
							<option value="<% $chapter->id %>"
								<% $already && $already->chapter->id == $chapter->id 
									? "selected='true'" : "" %>
							><% $chapter->name %></option>
%						}
						</select>

					</span>

					<span class="fourtenths centeralign">

%						foreach my $chapter (@paid_members) { 

							<span 
								id    = "<% $team %>_<% $count %>_<% $chapter->id %>"
								class = "schoolstudents">

							<select 
								name  = "<% $team %>_<% $count %>_<% $chapter->id %>_student"
								class = "fixedbig"
							>
								<option value="">None</option>

%								foreach my $student ($already, @{$chapter_students{$chapter->id}}) { 
%									next unless $student > 0;
									<option 
										value = "<% $student->id %>"
										<% $already && $already->id == $student->id ? "selected" : "" %>
									><% 
										$student->first." ".$student->last.
										" (".$student->grad_year.", ID ".$student->nsda.")" 
									%></option>
%								}

							</select>
							</span>
%						}
					</span>

				</div>

%			}


			<div class="row">

				<span 
					title = "For awards ceremonies etc"
					class = "third semibold rightalign bluetext"
				>
					Coach name(s) for award ceremonies:
				</span>

				<span class="twothirds">
					<input 
						type  = "text"
						name  = "<% $team %>_coaches"
						size  = "64"
						value = "<% $existing ? $existing->setting('coach_script') : "" %>"
					>
				</span>

			</div>


%		}

		<div class="liblrow rightalign marbottommore">
			<input type="submit" value="Save Teams">
		</div>

<%perl>

		if ($district_school) { 

			my $judge_burden = $m->comp(
				"/funclib/judgemath/judges_needed_by_category.mas",
				school => $district_school,
				category => $ws_cat
			);

			my @cat_judges = $district_school->judges(category => $ws_cat->id);

			my $judge_ok++ if (scalar @cat_judges >= $judge_burden);

</%perl>

			<span class="threefifths">
				<h5>Worlds Schools Judging</h5>
			</span>

			<span class="fifth centeralign <% $judge_ok ? "green" : "red" %>text semibold">
				<% $judge_burden %> judges required
			</span>

			<span class="fifth centeralign">
				<a 
					class="buttonwhite greentext hover invert smallish"
					href = "/user/nsda/wsdc_judge_edit.mhtml?school_id=<% $district_school->id %>&category_id=<% $ws_cat->id %>"
				>Add <% $ws_cat->abbr %> Judge</a>
			</span>

			<div class="ltyellow row semibold smallish">

				<span class="threetenths">
					Judge name
				</span>

				<span class="fifth">
					School affiliation
				</span>

				<span class="threetenths">
					Tabroom.com account
				</span>

				<span class="tenth nospace centeralign">
					Edit
				</span>

				<span class="tenth nospace centeralign">
					Drop
				</span>

			</div>

<%perl>
			foreach my $judge (
				$district_school->judges(  
					category => $ws_cat->id
				)
			) { 

				my $original_id = $judge->setting("original_school");

				my $original_school;
				$original_school = Tab::School->retrieve($original_id) if $original_id;

</%perl>
				<div class="row">

					<span class="threetenths padvert">
						<% $judge->first." ".$judge->last %>
					</span>

					<span class="fifth">
						<% $original_school ? $original_school->short_name : "No School" %>
					</span>

					<span class="threetenths">
						<% $judge->person ? $judge->person->email  : "NO ACCOUNT" %>
					</span>

					<span class="tenth nospace centeralign">
						<a 
							class = "buttonwhite bluetext fa fa-edit fa-sm"
							href  = "/user/nsda/wsdc_judge_edit.mhtml?judge_id=<% $judge->id %>"	
						></a>
					</span>

					<span class="tenth nospace centeralign">
						<a 
							class = "buttonwhite redtext fa fa-trash fa-sm"
							href  = "/user/nsda/wsdc_judge_drop.mhtml?judge_id=<% $judge->id %>"	
						></a>
					</span>

				</div>

%			}
%		}

	<script>

		function showSchools() { 

			$(".schoolstudents").addClass('hidden');

			$(".schools").each(function() { 

				var schoolId = this.id;
				var teamId = $(this).attr('team');
				var countId = $(this).attr('count');
				var selectedSchool = $("#"+schoolId+" option:selected").val();
				$("#"+teamId+"_"+countId+"_"+selectedSchool).removeClass("hidden");
			});
		}

		$(document).ready(function() {
			showSchools();
		});

	</script>

