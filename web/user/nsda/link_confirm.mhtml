<%args>
	$person
	$nsda_username => undef
	$nsda_password => undef
	$confirm       => undef
</%args>
<%init>

	if ($confirm ne "I am this person and no other") { 
		$m->redirect("link.mhtml?reconfirm=1");
	}

	use Tab::NSDA::MemberSchool;
	use Tab::NSDA::Person;
	use Tab::NSDA::Login;
	use Tab::NSDA::PersonSchool;

	use Digest::MD5 qw(md5_hex);

	my $now = DateTime->now();
	my $err;

	unless ($nsda_username && $nsda_password ) { 
		$err = "No username and/or password supplied.  Try again <br />";
		$m->redirect("link.mhtml?err=$err");
	}

	my $nsda_login = Tab::NSDA::Login->search( 
		username => $nsda_username 
	)->first;

	my $encoded_password = md5_hex($nsda_password.$nsda_username.$Tab::points_salt);

	unless ($nsda_login) { 
		$err = "Username was not found in the NSDA points system.  Try again.<br />";
		$m->redirect("link.mhtml?err=$err");
	}

	unless ($nsda_login && ($encoded_password eq $nsda_login->password) ) { 

		Tab::log("NSDA link from ".$person->email." to NSDA username $nsda_username failed. ");
		Tab::log("Password hash is $encoded_password versus ".$nsda_login->password);

		$err = "Login was invalid.  Please try again";
		$m->redirect("link.mhtml?err=$err");
	} 

	my $nsda_person = Tab::NSDA::Person->search( 
		user_id => $nsda_login->person_id 
	)->first;

	my $salt = $m->comp("/funclib/generate_randomstring.mas"); 
	my $sha512 = crypt($nsda_password, '$6$'.$salt);

	my $msg;

	my $already_person = Tab::Person->search( 
		nsda => $nsda_person->user_id
	)->first;

	if ($already_person) { 

		foreach my $permission ($already_person->permissions) {
			$permission->person($person->id);
			$permission->update;
		}

		foreach my $login ($already_person->logins) {
			$login->person($person->id);
			$login->update;
		}

	}

	eval {
		$person->ualt_id($nsda_person->ualt_id);
		$person->nsda($nsda_person->user_id);
		$person->update;
	};

	unless (Tab::Login->search( username => $nsda_login->username )) { 

		Tab::Login->create({ 
			username      => $nsda_login->username,
			sha512        => $sha512,
			person        => $person->id,
			accesses      => 1,
			last_access   => $now,
			source        => "points"
		});
	}

	$msg = "Your Tabroom record has been linked to the NSDA coach account $nsda_username.";
	$msg .= "You should still log in with your Tabroom.com user account but now you  ";
	$msg .= "will have the ability to autopost student points from Tabroom and import";
	$msg .= "your NSDA student roster. ";
	$msg .= "Your password and login was not changed";

	$m->redirect("index.mhtml?msg=$msg");

</%init>
