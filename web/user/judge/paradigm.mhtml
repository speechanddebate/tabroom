<%args>
	$person
	$person_settings
	$dbh
</%args>
<%init>

	my $strip = HTML::Strip->new();

	my $ts_sth = $dbh->prepare("
		select ps.timestamp, ps.value_text
			from person_setting ps
		where ps.person = ?
			and ps.tag = 'paradigm'
	");

	$ts_sth->execute($person->id);
	my $tsen = $ts_sth->fetchall_hash();

	my $paradigm_timestamp = eval {
		return ${$tsen}[0]->{timestamp};
	};

	my $word_limit = Tab::TabroomSetting->search(
		tag   => "paradigm_word_limit"
	)->first;

	my $word_limit_deadline = Tab::TabroomSetting->search(
		tag   => "paradigm_word_limit_deadline"
	)->first;

	my $word_limit_guidelines = Tab::TabroomSetting->search(
		tag   => "paradigm_word_limit_guidelines"
	)->first;

	my $err;

	if ($word_limit && $word_limit->value > 0) {
		my $text = ${$tsen}[0]->{value_text};
		my $raw_text = $strip->parse($text);
	    my $count;
   		$count++ while $raw_text =~ /\S+/g;

		if ($count > $word_limit->value) {
			$err = "Your paradigm's word count of $count is over the limit of ".$word_limit->value;
			if ($word_limit_deadline) {
				$err .= "</p><p class='semibold redtext'>Deadline: ".$word_limit_deadline->value_date->mdy('/');
				$err .= "</p>";
			}
			if ($word_limit_guidelines) {
				$err .= "</p><p class='padleft'>".$word_limit_guidelines->value_text;
			}
		}
	}

</%init>

	<& /funclib/editor.mas &>

	<& menu.mas,
		person          => $person,
		whoami          => "judgeparadigm",
		person_settings => $person_settings
	&>

	<div class="main">

		<div class="full flexrow">

			<span class="twofifths">
				<h2>Your Paradigm</h2>
			</span>

			<span class="half rightalign semibold bluetext padright">
				Last reviewed or changed
				<& "/funclib/showdt.mas",
					string => $paradigm_timestamp,
					tz     => $person->tz,
					tzname => 1
				&>
				<p class="nospace padtopless graytext">
					Word Count: <% $person_settings->{paradigm_word_count} %>
				</p>
			</span>

			<span class="tenth rightalign">
				<a
					href   = "/index/paradigm.mhtml?judge_person_id=<% $person->id %>"
					class  = "fa fa-lg fa-file-text-o buttonwhite bluetext"
					target = "_blank"
					title  = "Link to your paradigm's public page"
				></a>
			</span>
		</div>

%		if ($err) {
			<div class="bluebordertop blueborderbottom padvertmore padleft padright bigger">
				<h6 class='semibold'>Word Count Over Limit</h6>
				<p class="italic smaller">
				<% $err %>
				</p>
			</div>
%		}

%		if ($person_settings->{email_unconfirmed}) {

			<p class="centeralign bigger marvertmore padvertmore semibold">
				Your Tabroom.com account email is not confirmed. You may not
				publish a paradigm until you do so!
			</p>

			<p class="centeralign">
				<a
					href="/user/login/confirm.mhtml"
					class="buttonwhite bluetext invert"
				>Confirm your Tabroom Account</a>
			</p>

%		} else {

		<p>
			This paradigm will be displayed publicly on the main Tabroom site,
			and will also be linked off pref/strike sheets for tournaments.
		</p>

		<p>
			Please bear in mind that paradigms are
			<span class="semibold redtext inline nospace">
				public, geared to an educational audience, and have your name attached.
			</span>
			For more on how to write a helpful paradigm, consult
			<a
				href  = 'https://www.speechanddebate.org/judge-paradigm-guide'
				class = "inline semibold"
			>
				the NSDA judge paradigm guide
			</a>.
		</p>

		<p>
			Discriminatory, hateful, harmful and/or profane language is
			forbidden, and its use will result in your paradigm being removed.
			We might also lock or delete your Tabroom account. In other words,
			be mature educators, and good people.
		</p>

		<form
			action = "paradigm_save.mhtml"
			method = "post"
		>

		<div class="centeralign full padleftmore odd padvertmore">
			<textarea
				name = "paradigm"
				rows = "32"
			><%
				${$tsen}[0]->{value_text}
			%></textarea>
		</div>

		<div class="liblrow flexrow rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Save Paradigm"
				>
			</span>
		</div>

		</form>

%		}
	</div>

