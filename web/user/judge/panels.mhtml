<%args>
	$person
	$session
</%args>
<%init>

	my @ballot_panels = $m->comp(
		"/funclib/person_panels.mas",
		person => $person
	);

	my @list_panels = $m->comp(
		"/funclib/person_panels.mas",
		person   => $person,
		listonly => 1
	);

	my @done_panels = $m->comp(
		"/funclib/person_panels.mas",
		person  => $person,
		done    => 1,
		reverse => 1
	);

	my %panels_done = ();

	my $now = DateTime->now();

</%init>

	<&
		"/user/menu.mas",
		person => $person
	&>

	<div class="main">

		<h3>
			Current Ballots
		</h3>

<%perl>
		if (
			(scalar @ballot_panels)
			|| (scalar @list_panels)
		) {

</%perl>
			<&
				"/funclib/tablesorter.mas",
				table => "pendingrounds"
			&>

			<span class="half">
				<h4>Pending Rounds</h4>
			</span>

			<span
				id    = "pendingrounds_buttonarea"
				class = "half rightalign">
			</span>

			<table id="pendingrounds">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Round
						</th>

						<th class="smaller">
							Room
						</th>

						<th class="smaller">
							Starts
						</th>

						<th class="smaller">
							Entries
						</th>

						<th class="smaller">
						</th>

					</tr>

				</thead>

				<tbody>

%		} else {

			<span class="third nospace">
				<h6 class="padleftmore greentext marbottommore semibold">
					None Posted...yet!
				</h6>
			</span>
			<span class="twothirds rightalign semibold nospace">
				<p>Ballots will appear here once rounds have been published
				on the web</p>
			</span>

<%perl>

		}

		foreach my $panel (@ballot_panels) {

			my $round = $panel->round;
			my $event = $round->event;
			my $tourn = $event->tourn;

			my $legion = $tourn->setting('legion');

	   		my $no_side_constraints++
				if $event->setting('no_side_constraints');

			my $sidelocks++
				if ($round->type eq "elim"
					|| $round->type eq "final"
					|| $round->type eq "runoff"
				) && not defined $no_side_constraints;

			my $locked =  $m->comp(
				"/funclib/round_elim_dueaff.mas",
				panel => $panel
			) if $sidelocks;

			my $tz = $event->tourn->tz;
			$tz = "UTC" unless $tz;

			$panels_done{$panel->id}++;

			next unless $panel
				&& $round
				&& ($round->published || $round->setting("judges_ballots_visible") );

			my $judge = Tab::Judge->retrieve($panel->judge);

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
					panel    => $panel,
					no_drops => 1
			);

			my @scores = $m->comp(
				'/funclib/panel_scores.mas',
					panel => $panel,
					judge => $judge
			);

			my $chair;
			my $started;

			foreach my $ballot ($panel->ballots( judge => $judge->id)) {
				$chair++ if $ballot->chair;
				$started = $ballot->judge_started();
			}

			my $scored;

			foreach my $score (@scores) {
				$scored++ if $score->value;
			}

</%perl>

			<tr>

				<td class="">

					<span class="hidden">
						<% $round->name %>-<% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					if ($round->flighted > 1) {

						<a
							class="white padless full"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="semibold bluetext">
					<% $panel->room ? $panel->room->name : "No Room Listed" %>
				</td>

				<td class="centeralign semibold redtext">
%					my $start = $round->start_time;
%					$start = $round->timeslot->start unless $start;
%					$start = $start->set_time_zone($tz);
					<% Tab::nicetime($start)." ".Tab::tzname($tz) %>
				</td>
<%perl>

				my $length;

				foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
					$length = length($entry->code) if $length < length($entry->code);
				}

				my $spansize = "eighth";
				$spansize = "sixth" if $length > 4;
				$spansize = "fifth" if $length > 8;
				$spansize = "third" if $length > 10;
				$spansize = "half" if $length > 16;

</%perl>

				<td class="centeralign">

%				unless ($legion) {
%					if ($event->type eq "speech") {
%						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
							<span class="<% $spansize %> leftalign">
								<% $event->type eq "speech" ? $entry->speaks."." : "" %>
								<% $entry->code %>
							</span>
%						}
%					} elsif ($event->type eq "congress") {

						<span class="semibold">Chamber <% $panel->letter %></span>

%					} else {
%						foreach my $entry (@entries) {

							<div class="leftalign">

%								unless ($event->type eq "congress") {
									<span class="quarter">
%										if ($event->type eq "wudc") {
											<% $entry->speaks == 1 ? "1G" : "" %>
											<% $entry->speaks == 2 ? "1O" : "" %>
											<% $entry->speaks == 3 ? "2G" : "" %>
											<% $entry->speaks == 4 ? "2O" : "" %>
%										} elsif ($sidelocks && not defined $locked) {
											<% $entry->side
												? $entry->side == 1
													? "Flip for" : "Sides"
												: ""
											%>
%										} else {
											<% $entry->side
												? $entry->side == 1
													? $aff_string : $neg_string
												: ""
											%>
%										}
									</span>

									<span class="threequarter nowrap">
%								}  else {
									<span class="full nowrap padless marno">
<%perl>
								}

								if ($event->type eq "wudc" || $event->type eq "wsdc") {
   									$m->print($entry->code);
								} else {
   									$m->print($entry->name);
								}
</%perl>
								</span>

							</div>
%						}
%					}
%				}
				</td>

				<td class="centeralign padless">

%					if ($legion) {

%						if ($started) {
							<a
								class="bluetext invert buttonwhite"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							><% (@scores ) ? "RE" : "" %>ENTER</a>
%						} elsif ($scored) {
							<a
								class="redtext buttonwhite invert"
								href="legion_confirm.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>CONFIRM</a>
%						} else {
							<a
								class="greentext buttonwhite invert"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>Scores</a>
%						}

						<a
							class  = "bluetext buttonwhite invert marleftmore"
							target = "_blank"
							href="legion_comments.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
						>Feedback</a>

%					} elsif ($event->type eq "wudc" &! $chair) {

						Panelist Judge <br /> (only Chairs enter ballots)

%					} else {

%						if ($chair) {

							<p class="explain marno padless">
								Please Chair this round
							</p>

%						}
%						if ($started) {

							<a
								class="bluetext invert buttonwhite"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								<% (@scores ) ? "RE" : "" %>ENTER
							</a>

%						} elsif ($scored) {

							<a
								class="redtext buttonwhite invert"
								href="re_confirm.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								CONFIRM
							</a>
%						} else {

							<a
								class="greentext buttonwhite invert"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								START ROUND
							</a>
%						}
%					}

				</td>
			</tr>

<%perl>
			if ( ($event->type eq "wudc"
				|| $event->type eq "wsdc")
				&& $round->published == 3
			) {
</%perl>
				<tr>

					<td>
						<span class="hidden">
						<% $round->name %><% $panel->flight %>
						</span>
					</td>

					<th class="">
						Motion:
					</td>

					<td colspan="3">
						<% $round->setting("motion") %>
					</td>
				</tr>
%			}

%		}

<%perl>

		my $last_round;

		foreach my $panel (@list_panels) {

			my $round = $panel->round;
			$panels_done{$panel->id}++;

			next unless $panel && $round && $round->published;

			my $event = $round->event;
			my $judge = Tab::Judge->retrieve($panel->judge);
			my $tourn = $event->tourn;
			my $legion = $tourn->setting('legion');

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
				panel => $panel
			);

			my $key = $round->id."-".$panel->flight;

</%perl>
			<tr class="<% $last_round && $last_round ne $key ? "bordertop" : "" %>">

				<td class="padless">

					<span class="hidden">
						<% $round->name %><% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					if ($round->flighted > 1) {
						<a
							class="white padless full marno border"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="">
					<% $panel->room ? $panel->room->name : "No Room Listed" %>
				</td>

				<td class="">
					<% Tab::nicetime($round->timeslot->start->set_time_zone($tourn->tz)) %>
				</td>

				<td class="">
<%perl>

					if ($event->type eq "speech" || $event->type eq "congress") {

						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {

							my $spansize = "third";

							$spansize = "eighth"
								if ($event->setting('code_style') eq "numbers"
								|| $event->setting('code_style') eq "school_number");

</%perl>

							<span class="<% $spansize %>">
%								if ($legion) {
									<% $entry->speaks %>
%								} else {
									<% $event->type eq "speech" ? $entry->speaks."." : "" %>
									<% $entry->code %>
%								}
							</span>
%						}

%					} else {

%						foreach my $entry (@entries) {

							<div>
								<span class="quarter">
%									if ($event->type eq "wudc") {
										<% $entry->speaks == 1 ? "1G" : "" %>
										<% $entry->speaks == 2 ? "1O" : "" %>
										<% $entry->speaks == 3 ? "2G" : "" %>
										<% $entry->speaks == 4 ? "2O" : "" %>
%									} elsif ($event->type eq "congress") {

%									} else {
										<% $entry->side ? $entry->side == 1 ? $aff_string : $neg_string : "" %>
%									}
								</span>

								<span class="threequarter">
<%perl>
									if (
										$event->type eq "wudc"
										|| $event->type eq "wsdc"
									) {

</%perl>
										<% $entry->code %>
%									} else {
										<% $entry->name %>
%									}
								</span>

							</div>
%						}
%					}
				</td>

				<td>
				</td>

			</tr>

%			$last_round = $round->id."-".$panel->flight;

%		}

%		if (@ballot_panels || @list_panels) {

			</tbody>
			</table>
%		}

%		if (@done_panels) {

			<h4 class="martopmore">
				Previously Entered Results
			</h4>

			<p class="martop marbottom bluetext semibold">
				Note: You cannot edit past results; you can only view them.
				Once you have confirmed a ballot, you must contact the
				tournament officials to make changes.  You may edit/extend past
				comments until the tournament ends.
			</p>
<%perl>

		}

		undef $last_round;

		foreach my $done (@done_panels) {

			my $round    = $done->round;
			my $event    = $round->event;
			my $noedit;

			my $tourn = $event->tourn;
			$noedit++ if $tourn->end < $now;

			my $category = $event->category;
			my $legion   = $event->tourn->setting('legion');


			my $judge = Tab::Judge->retrieve($done->judge)
				if $done->judge;

			my @entries = $m->comp(
				'/funclib/panel_entries.mas',
				panel => $done
			);

			my @scores = $m->comp(
				'/funclib/panel_scores.mas',
				panel => $done,
				judge => $judge
			);

			@scores = $m->comp(
				'/funclib/panel_scores.mas',
				panel => $done)
			if $event->type eq "wudc";

			my %scores_by_recipient =();

			foreach my $score (@scores) {
				push @{$scores_by_recipient{$score->student->id}}, $score
					if $score->student && $score->student->id;
			}

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my %category_settings  = $category->all_settings;
			my $ballot_entry_name  = $category_settings{"ballot_entry_names"};
			my $ballot_entry_title = $category_settings{"ballot_entry_titles"};
			my $ballot_school_code = $category_settings{"ballot_school_codes"};
			my $ballot_school_name = $category_settings{"ballot_school_names"};
			my $ballot_entry_first_name = $category_settings{"ballot_entry_first_names"};

</%perl>

			<& /funclib/tablesorter.mas, table => $done->id &>

			<div class="full nospace martop">

				<span class="threefifths padleft">
					<h5>
						<% $event->name %>
					</h5>
				</span>

				<span class="fifth nospace">
					<h6>
						<% $round->realname %>
						<% $round->flighted > 1 ? "Flt ".$done->flight : "" %>
					</h6>
				</span>

				<span class="fifth rightalign">
%					if ($noedit) {

%					} elsif ($legion) {
						<a
							class = "bluetext buttonwhite hover smallish invert"
							href  = "legion_comments.mhtml?panel_id=<% $done->id %>&judge_id=<% $judge->id %>"
						>
							Edit Feedback
						</a>
%					} elsif ($done && $judge)  {
						<a
							class = "bluetext buttonwhite hover smallish invert"
							href  = "rfd_only.mhtml?panel_id=<% $done %>&judge_id=<% $judge %>"
						>
							Edit Feedback
						</a>
%					}
				</span>

			</div>

<%perl>

			my %entry_result = ();
			my %entry_score = ();
			my %entry_sort = ();

			foreach my $entry (@entries) {

				foreach my $score (@scores) {

					next if $score->student > 0;
					next unless $score->ballot;
					next unless $score->ballot->entry;
					next unless $score->ballot->entry->id == $entry->id;

					if ($score->tag eq "congress_speech") {
						$entry_score{$entry->id} .= " &ndash; "
							if $entry_score{$entry->id};
					} else {
						$entry_result{$entry->id} .= " &ndash; "
							if $entry_result{$entry->id};
					}

					if ($entry->event->type eq "wudc"
						&& $round->type ne "elim"
						&& $round->type ne "final"
						&& $round->type ne "runoff"
					) {

						$entry_result{$entry->id} .= (4 - $score->value)." pts"
							if $score->tag eq "rank";

					} elsif ($entry->event->type eq "wudc") {

						$entry_result{$entry->id} .= " Advances "
							if $score->value == 1;

					} else {

						$entry_result{$entry->id} .= " Bye " if $score->ballot->bye;
						$entry_result{$entry->id} .= " Fft " if $score->ballot->forfeit;

						if ($score->tag eq "ballot") {
							if ($score->value == 1) {
								$entry_result{$entry->id} .= " W ";
							} else {
								$entry_result{$entry->id} .= " L ";
							}
						}

						if (
							$entry->event->type eq "speech"
							|| $entry->event->type eq "congress"
						) {

							$entry_sort{$entry->id} = $score->value
								if $score->tag eq "rank";

						} else {

							$entry_sort{$entry->id} = (10 - $score->value)
								if $score->tag eq "ballot";
						}

						$entry_result{$entry->id} .= "Rank: ".$score->value
							if $score->tag eq "rank";

						$entry_result{$entry->id} .= $score->value
							if $score->tag eq "points";

						$entry_score{$entry->id} .= $score->value
							if $score->tag eq "congress_speech";
					}
				}
			}

			@entries =
				sort {$entry_sort{$a} <=> $entry_sort{$b}}
				@entries;

			foreach my $entry (@entries) {

</%perl>

				<div class="row">

%					if ($event->type eq "congress") {

						<span class="quarter padvert">
							<% $entry->code %>
						</span>

						<span class="quarter">

%					} elsif ($event->type eq "wudc") {
						<span class="sixth padvert">
							<% $entry->speaks == 1 ? "1G" : "" %>
							<% $entry->speaks == 2 ? "1O" : "" %>
							<% $entry->speaks == 3 ? "2G" : "" %>
							<% $entry->speaks == 4 ? "2O" : "" %>
						</span>
						<span class="third">
%					} else {

						<span class="sixth padvert smaller">
							<% $entry->side
								? $entry->side == 1
									? $aff_string
									: $neg_string
								: Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks)
							%> Speaker
						</span>

						<span class="third semibold bluetext">
%					}
<%perl>
						if ($event->type eq "wudc"
							|| $event->type eq "speech"
							|| $event->type eq "wsdc"
							|| $event->setting("anonymous_public")
						) {
</%perl>
							<% $entry->code %>
							<% $ballot_school_code ? $entry->school->code  : "" %>
							<% $ballot_school_name ? $entry->school->name  : "" %>
<%perl>
						}

						if ($event->type eq "wudc"
							|| $event->type eq "speech"
							|| $event->type eq "wsdc"
							|| $event->type eq "congress"
						) {

							$m->print($entry->name) if $ballot_entry_name;

							if ($ballot_entry_first_name) {
								foreach my $student ($entry->students) {
									$m->print($student->first);
								}
							}

						} else {
							$m->print($entry->name);
						}

					if ($ballot_entry_title) {

						$m->print('<div class="full nospace">');

						my $title = Tab::Score->search(
							ballot => $entry->ballot,
							tag    => "title"
						)->first;
</%perl>

							<% $title ? $title->content  : "" %>
						</div>
%					}

					</span>

<%perl>

					my $span = "tenth";

					$span = "half"
						if $event->type eq "speech"
						|| $event->type eq "congress";

</%perl>

					<span class="<% $span %> centeralign marno padno">

%						if ($entry_score{$entry->id}) {

							<span class="quarter">
								<% $entry_result{$entry->id} %>
							</span>

							<span class="threequarters rightalign">
								Speech Scores: <% $entry_score{$entry->id} %>
							</span>

%						} else {
							<% $entry_result{$entry->id} %>
%						}
					</span>

%					unless ($event->type eq "speech" || $event->type eq "congress") {

						<span class="fourtenths">

<%perl>
							foreach my $student ($entry->students) {

								my @scores = @{$scores_by_recipient{$student->id}}
									if $student->id && $scores_by_recipient{$student->id};

								next unless @scores;

</%perl>
								<span class="fourtenths nospace">

									<span class="threequarters nowrap marno">
										<% $student->last %>:
									</span>

									<span class="quarter">
%										my $notfirst;
%										foreach my $score (@scores) {
%											next if $score->position > 3;
											<% $notfirst++ ? " - " : "" %>
											<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
											<% $score->tag eq "rank" ? $score->value : "" %>
											<% $score->tag eq "points" ? $score->value : "" %>
%										}
									</span>
								</span>
%							}

%							if ($event->type eq "wsdc") {

								<span class="half nospace">

<%perl>
									STUDENT:
									foreach my $student ($entry->students) {

										my @scores = @{$scores_by_recipient{$student->id}}
											if $student->id
											&& $scores_by_recipient{$student->id};

										next unless @scores;

										foreach my $score (@scores) {

											next STUDENT unless $score->position > 3;

</%perl>
												<span class="twothird nowrap">
													REPLY: <% $student->last %>:
												</span>
												<span class="third">
													<% $score->value %>
												</span>
%										}
										</span>
%									}
								</span>
%							}

						</span>
%					}

				</div>

%				$last_round = $round->id."-".$done->flight;

%			}
%		}

	</div>

