<%args>
	$judge
	$panel
	$person
	$event 
	$event_settings
	$entry_id => undef
</%args>
<%init>

	my @ballots = $panel->ballots;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my @entries = $m->comp(
		"/funclib/panel_entries.mas", 
		panel => $panel
	);

    my $max_points = $event_settings->{"max_points"};
    my $min_points = $event_settings->{"min_points"};

    my $max_ob_points = $event_settings->{"max_ob_points"};
    my $min_ob_points = $event_settings->{"min_ob_points"};

    $min_ob_points = $min_points unless $min_ob_points;
    $max_ob_points = $max_points unless $max_ob_points; 

	$min_ob_points = 0 unless $min_ob_points;
	$max_ob_points = 6 unless $max_ob_points;

</%init>

	<div class="full">

		<div class="twofifths bluetext">

			<h5>
				Per-Speech Points
			</h5>

		</div>

		<div class="fifth rightalign redtext strong">
			Select a speaker:
		</div>

		<div class="twofifths">

			<form 
				action="ballot.mhtml" 
				method="post"
			>

				<input
					type = "hidden"
					name = "panel_id"
					value= "<% $panel->id %>"
				>

				<input
					type = "hidden"
					name = "judge_id"
					value= "<% $judge->id %>"
				>

			<select
				name  = "entry_id"
				class = "fixedbig"
				onChange = "this.form.submit();"
			>
				<option value=""></option>

%				foreach my $entry (@entries) { 
%					next if $entry->active != 1;

					<option 
						value="<% $entry->id %>"
						<% $entry->id == $entry_id ? "selected='true'" : "" %>
					><% $entry->code %> &ndash; <% $entry->name %></option>

%				}

			</select>

			</form>

		</div>


	</div>

<%perl>

	if ($entry) { 

		my $ballot = Tab::Ballot->search( 
			judge => $judge->id, 
			entry => $entry->id, 
			panel => $panel->id)->first; 

		unless ($ballot) { 
			$m->comp("/funclib/abort.mas", err => "You are not slated to judge that competitor this round");
		}

		my @scores = 
			sort {$b->speech <=> $a->speech} 
			$ballot->scores( tag => "congress_speech");

		my $score_count = scalar @scores;

		foreach my $score ("new", @scores) { 

</%perl>

		<div 
			id = "<% $entry->id %>"
		>

			<form 
				action = "congress_speech_save.mhtml"
				method = "post"
			>

%			unless ($score eq "new") { 
				<input
					type = "hidden"
					name = "score_id"
					value= "<% $score->id %>"
				>
%			}

			<input
				type = "hidden"
				name = "panel_id"
				value= "<% $panel->id %>"
			>

			<input
				type = "hidden"
				name = "judge_id"
				value= "<% $judge->id %>"
			>

			<input
				type = "hidden"
				name = "entry_id"
				value= "<% $entry->id %>"
			>

%			if ($score eq "new") { 
				<h4 class="centeralign martopmore">
					<% $entry->code %> <% $entry->name %>
				</h4>

				<h6 class="nospace marbottom">
					New speech:
				</h6>

%			} else { 

				<div class="full">
					<span class="half">
						<h6>Speaker's Speech # <% $score_count-- %></h6>
					</span>

					<span class="half rightalign">
						<h6>Session Speech #<% $score->speech %></h6>
					</span>
				</div>

%			}

			<div class="lightrow">

				<span class="eighth strong centeralign">
					Topic/Bill:
				</span>

				<span class="threeeighths">
					<input
						type = "text"
						name = "topic"
						size = "32"
						value = "<% $score ne "new" ? $score->topic : "" %>"
					>
				</span>

				<span class="eighth strong centeralign">
					Side:
				</span>

				<span class="threetenths">

					<label for="<% $score %>_aff">
						<span class="half hover">
							<input
								id    = "<% $score %>_aff"
								type  = "radio"
								name  = "side"
								value = "1"
								<% $score ne "new" && $score->position == 1 ? 'checked="checked"': "" %>
							>Affirmative
						</span>
					</label>

					<label for="<% $score %>_neg">
						<span class="half hover">
							<input
								id    = "<% $score %>_neg"
								type  = "radio"
								name  = "side"
								value = "2"
								<% $score ne "new" && $score->position == 2 ? 'checked="checked"': "" %>
							>Negative
						</span>
					</label>
				</span>
			</div>

			<div> 
				<textarea 
					placeholder = "General feedback and comments on this speech"
					name        = "comments"
				><% $score ne "new" ? $score->content : ""%></textarea>
			</div>

			<div class="lightrow nospace">

				<span class="fiveeighths rightalign strong greentext">
					Points for this speech: (<% $min_ob_points %> - <% $max_ob_points %>)
				</span>

				<span class="eighth rightalign">
					<input
						type = "number"
						name = "points"
						min  = "<% $min_ob_points %>"
						max  = "<% $max_ob_points %>"
						value = "<% $score ne "new" ? $score->value : "" %>"
					>
				</span>

				<span class="quarter rightalign">
					<input
						type  = "submit"
						value = "Save Speech"
					>
					</form>
				</span>
			</div>

		</div>

%		}
%	}

