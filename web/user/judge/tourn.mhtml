<%args>
	$account
	$tourn_id
</%args>

%	my $tourn = Tab::Tourn->retrieve($tourn_id);
%	my @judges = $m->comp("/funclib/account_judges.mas", account => $account, tourn => $tourn);

%	my $switch;

	<& menu.mas, account => $account &>

	<div class="left huge">

%		foreach my $judge (@judges) { 

			<h4><% $judge->judge_group->tourn->name %> </h4>

			<div class="half left">

				<span class="odd block padmore smallish">
					<span class="medspan">
						Judging For:
					</span>
					<% $judge->school ? $judge->school->short_name : "Hired" %>
				</span>

				<span class="even block padmore smallish">
					<span class="medspan">
						Division:
					</span>
					<% $judge->judge_group->name %>
				</span>
	
%				unless  ($judge->judge_group->setting("no_codes")) { 

					<span class="odd block padmore smallish">
						<span class="medspan">
							Judge Code
						</span>
						<% $judge->code %>
					</span>

%				}

			</div>

			<div class="right half">

%				if ($judge->judge_group->setting("rounds_per")) { 

					<span class="odd block padmore smallish">
						<span class="medbigspan">
							Obligation for School
						</span>
						<span class="evensmallerspan">
							<% $judge->obligation ? $judge->obligation : "0" %>
						</span>
					</span>

					<span class="even block padmore smallish">
						<span class="medbigspan">
							Hired Rounds
						</span>
						<span class="evensmallerspan">
							<% $judge->hired ? $judge->hired : "0" %>
						</span>
					</span>
%				}

%				if ($m->comp("/funclib/account_panels.mas", account => $account, judge => $judge)) {

					<span class="odd block padmore smallish">

						<span class="medbigspan" style="margin-top: 6px;">
							Enter Ballots Online:
						</span>

						<span class="smallishspan padno">
							<a class="dkgreen inline" href="panels.mhtml">
								ENTER
							</a>
						</span>

					</span>

%				} 

			</div>

			<br style="clear: both;" />

%			my @upcoming =  $m->comp("/funclib/judge_panels.mas", judge => $judge, published => 1);

%			if (@upcoming) { 

				<h4>Assigned Rounds</h4>

				<& /funclib/tablesorter.mas, table => "sortmebaby" &>

				<table cellpadding="3" cellspacing="1" id="sortmebaby">

					<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Round
						</th>

						<th class="smaller">
							Room
						</th>

						<th class="smaller">
							Starts
						</th>

						<th class="smaller">
							Entries
						</th>

						<th class="smaller">
						</th>

					</tr>

					</thead>

					<tbody>

%					foreach my $panel (@upcoming) { 


%						my $event = $panel->round->event;

%						my @entries = sort {$a->side <=> $b->side} $m->comp('/funclib/panel_entries.mas', panel => $panel);
%						my @ballots = $panel->ballots; 

%						my $chair;
%						foreach my $ballot (@ballots) { 
%							$chair++ if $ballot->chair && $ballot->judge->id == $judge->id;
%						}

						<tr>

							<td class="smallish">
								<a class="white padless inline" href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $panel->round->id %>">
									<% $panel->round->event->abbr %> <% $panel->round->realname %>
								</a>

%								if ($panel->round->flighted > 1) { 

									<br />

									<a class="white padless inline" href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $panel->round->id %>">
										Flight <% $panel->flight %>
									</a>
%								}

							</td>

							<td class="smallish">
								<% $panel->room ? $panel->room->name : "No Room Listed" %> 
							</td>

							<td class="smallish">
								<% Tab::nicetime($panel->round->timeslot->start->set_time_zone($tourn->tz)) %>
							</td>

							<td class="smallish">
%								foreach my $entry (@entries) { 
									<span class="smallerspan">
%										if ($event->type eq "wudc") { 
											<% $entry->speaks == 1 ? "1G" : "" %> 
											<% $entry->speaks == 2 ? "1O" : "" %> 
											<% $entry->speaks == 3 ? "2G" : "" %> 
											<% $entry->speaks == 4 ? "2O" : "" %> 
%										} else { 
											<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
%										} 
									</span>

									<span class="medbigspan nowrap" style="padding-bottom: 5px">
%										if ($event->type eq "wudc" || $event->type eq "speech") { 
											<% $entry->code %> 
%										} else { 
											<% $entry->name %> 
%										} 
									</span>

									<br />
%								}
							</td>

						</tr>

%					}

				</table>
%			}

%			my @done =  $m->comp("/funclib/judge_panels.mas", judge => $judge, post_results => 1);

%			if (@done) { 

				<& /funclib/tablesorter.mas, table => "sortmenow" &>

				<h4>Entered Results:</h4>

				<table cellpadding="3" cellspacing="1" id="sortmenow">

					<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Rnd
						</th>

						<th class="smaller">
							Entry
						</th>

						<th class="smaller">
							Res
						</th>

						<th colspan="8" class="smaller">
							Speakers
						</th>

					</tr>

					</thead>

				<tbody>

%				foreach my $done (@done) { 


%					my $event = $done->round->event;

%					my @entries = $m->comp('/funclib/panel_entries.mas', panel => $done);
%					my @scores = $m->comp('/funclib/panel_scores.mas', panel => $done, judge => $judge);
%					@scores = $m->comp('/funclib/panel_scores.mas', panel => $done) if $event->type eq "wudc";
%					my %scores_by_recipient =();

%					foreach my $score (@scores) {  
%						push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; 
%					}

%					foreach my $entry (@entries) { 

						<tr>

							<td class="smallish">
								<% $done->round->realname %>
								<% $done->round->flighted > 1 ? $done->flight : "" %>
							</td>

							<td class="smallish nowrap">

								<span class="tinyspan">
%									if ($event->type eq "wudc") { 
										<% $entry->speaks == 1 ? "1G" : "" %> 
										<% $entry->speaks == 2 ? "1O" : "" %> 
										<% $entry->speaks == 3 ? "2G" : "" %> 
										<% $entry->speaks == 4 ? "2O" : "" %> 
%									} else { 
										<% $entry->side ? $entry->side == 1 ? "Aff" : "Neg" : "" %>
%									} 
								</span>

								<span class="medspan nowrap">
%									if ($event->type eq "wudc") { 
										<% $entry->code %>  
%									} else { 
										<% $entry->name %>  
%									} 
								</span>

							</td>

							<td class="smallish nowrap">

%								foreach my $score (@scores) { 
%									next if $score->student > 0;
%									next unless $score->ballot->entry->id == $entry->id;
%									if ($entry->event->type eq "wudc") { 
										<% $score->tag eq "rank" ? 4 - $score->value : "" %> pts
%									} else { 
										<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
										<% $score->tag eq "rank" ? $score->value : "" %>
										<% $score->tag eq "points" ? $score->value : "" %>
%									} 
%								}
							</td>

%							foreach my $student ($entry->students) { 
%								my @scores = @{$scores_by_recipient{$student->id}} if $student->id && $scores_by_recipient{$student->id};
%								next unless @scores;
									
								<td class="smallish nowrap">

									<% $student->last %>:
		
%									my $notfirst;
%									foreach my $score (@scores) { 
										<% $notfirst++ ? "-" : "" %>
										<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
										<% $score->tag eq "rank" ? $score->value : "" %>
										<% $score->tag eq "points" ? $score->value : "" %>
%									}
									
								</td>

%							}

						</tr>

%					}

%				}

				</table>
%			}

%		}

	</div>

