<%args>
	$account
	$panel_id
	$judge_id
</%args>
<%init>

    unless ($panel_id && $judge_id) { 
        my $err = "I didn't get both a judge and a ballot record";
        $m->redirect("/user/home.mhtml?err=$err");
    }   

    my $panel = Tab::Panel->retrieve($panel_id);
    my $judge = Tab::Judge->retrieve($judge_id);

    unless ($panel && $judge) { 
        my $err = "No ballots found for that judge and that panel.";
        $m->redirect("/user/home.mhtml?err=$err");
    }   

    unless ($judge->account->id == $account->id) { 
        my $err = "You are not authorized to enter ballots for that judge.";
        $m->redirect("/user/home.mhtml?err=$err")
    }   

    my @ballots = Tab::Ballot->search( panel => $panel->id, judge => $judge_id);

    unless (@ballots) { 
        my $err = "That judge does not judge in that room.";
        $m->redirect("/user/home.mhtml?err=$err");
	}

	my $rfd;

	foreach my $ballot (@ballots) { 
		$ballot->audit(1);
		$ballot->update;
		$rfd = Tab::BallotValue->search( tag => "rfd", ballot => $ballot->id )->first unless $rfd;
	}

	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);
	my $type = $panel->round->event->type;

	my $undone;

	if ($type eq "wudc") { 
		foreach my $ballot ($panel->ballots) { 
			$ballot->audit(1);
			$ballot->update;
		}

	} else {

		foreach my $other (@judges) { 
			next if $judge->id == $other->id;
			my ($win, $winside) = $m->comp('/funclib/panel_winner.mas', panel => $panel, judge => $other);
			$undone++ unless $win;
		}
	}

</%init>

%	if ($undone) { 

		<div class="main">

		<h2>Panel Decision Incomplete</h2>

		<p>Other judges have yet to vote.  When all ballots are confirmed you
		can refresh this page to see the decision.  The last judge to vote will
		also automatically see the decision.</p>

		</div>

%	} elsif ($type ne "wudc" && scalar @judges > 1) { 

%		$m->comp("/funclib/round_done.mas", round => $panel->round);

		<div class="main">

		<h2>Panel Decision Complete</h2>

%		my $proceed++;
%		my $aff_count = 0;
%		my $neg_count = 0;
%		my $switch;

%		foreach my $ojudge (@judges) { 

%			my ($win, $winside) = $m->comp('/funclib/panel_winner.mas', panel => $panel, judge => $ojudge, noob => 1);

%			$aff_count++ if $winside == 1;
%			$neg_count++ if $winside == 2;

%			my $winner = Tab::Entry->retrieve($win) if $win;

%			my $side = "Aff" if $winside == 1;
%			$side = "Neg" if $winside == 2;
%			$side = "Pro" if $winside == 1 && $type eq "pf";
%			$side = "Con" if $winside == 2 && $type eq "pf";

			<div class="<% ($switch++ % 2) ? "odd" : "even" %> full">

				<span class="half">
					<h5>
						<% $ojudge->first." ".$ojudge->last %> 
					</h5>
				</span>

				<span class="quarter">
					<h5>
						<% $side %> 
					</h5>
				</span>
						
				<span class="quarter">
					<h5>
						<% $winner ? $winner->code : "" %>
					</h5>
				</span>
			</div>
%		}

		<br />
		<br />

		<h2>Result:</h2>

		<h4 class="centeralign">
%			if ($aff_count == $neg_count) { 
				<% $aff_count."-".$neg_count %> SPLIT DECISION
%			} elsif ($aff_count > $neg_count) { 
				<% $aff_count."-".$neg_count %> for the AFFIRMATIVE 
%			} else { 
				<% $neg_count."-".$aff_count %> for the NEGATIVE
%			} 

		</h4>

%		if ($rfd) { 

			<br />
			<br />

			<h4>RFD</h4>

			<div style="padding-left: 25px;">
				<% $rfd->content %>
			</div>

%		}

		</div>

		<& /user/menu.mas, account => $account &>

%	} else {

%		my $msg = "Thank you for entering your ballot.  If you come to believe you screwed up, please contact the tournament staff";
%		$m->redirect("/user/home.mhtml?msg=$msg");

%	} 

