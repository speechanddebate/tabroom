<%args>
	$tz
	$account
	$name
	$circuit_id
	$start
	$end
	$reg_start
	$reg_end
	$frozen
	$judge
	$drops
	$fines
	$site_id => undef
	$site_name => undef
	$copy_tournament_id => undef
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id);

	my $startdt = DateTime::Format::MySQL->parse_datetime($start);
	my $enddt = DateTime::Format::MySQL->parse_datetime($end);
	my $reg_startdt = DateTime::Format::MySQL->parse_datetime($reg_start);
	my $reg_enddt = DateTime::Format::MySQL->parse_datetime($reg_end);
	my $frozendt = DateTime::Format::MySQL->parse_datetime($frozen);
	my $finesdt = DateTime::Format::MySQL->parse_datetime($fines);
	my $judgedt = DateTime::Format::MySQL->parse_datetime($judge);
	my $dropsdt = DateTime::Format::MySQL->parse_datetime($drops);

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	unless ($site) { 

		$site_name = $name." Host Site" unless $site_name;

		$site = Tab::Site->create({
			circuit => $circuit_id,
			host => $account->id,
			name => $site_name
		});

	}

	my $tourn = Tab::Tourn->create( { 
		name => $name,
		circuit => $circuit_id,
		director => $account->id,
		start => $startdt,
		end => $enddt,
		reg_start => $reg_startdt,
		reg_end => $reg_enddt,
		freeze_deadline => $frozendt,
		fine_deadline => $finesdt,
		judge_deadline => $judgedt,
		drop_deadline => $dropsdt,
		approved => 0,
		hidden => 0
	});


	if ($copy_tournament_id) { 

		my $old_tourn = Tab::Tourn->retrieve($copy_tournament_id);

		my $start = $tourn->start;
		my $end = $tourn->end;

		my $ostart = $old_tourn->start;

		my $oend = $old_tourn->end;

		#Direct tournament settings.

		$tourn->judge_policy($old_tourn->judge_policy);
		$tourn->ballot_message($old_tourn->ballot_message);
		$tourn->invoice_message($old_tourn->invoice_message);
		$tourn->disclaimer($old_tourn->disclaimer);
		$tourn->update;

		#Copy over the method
		my $old_method = $old_tourn->method; 
		my $tm = $old_method->copy;
		$tm->is_standard(0);
		$tm->update;
		$tourn->method($tm->id);
		$tourn->update;

		#Tiebreakers come along with the method
		foreach my $otb ($old_method->tiebreaks) { 
			my $ntb = $otb->copy;
			$ntb->method($tm->id);
			$ntb->update;
		}

		#Sites
		foreach my $osit (Tab::TournSite->retrieve(tournament => $old_tourn->id)) {
			my $nsit = $osit->copy if $osit; 
			$nsit->tournament($tourn->id) if $nsit;
			$nsit->update if $nsit;
		}

		#Pools
		my %pool_translator = ();
		foreach my $op ($old_tourn->pools) {
			my $np = $op->copy;
			$np->tournament($tourn->id);
			$np->update;
			$pool_translator{$op->id} = $np->id;
		}

		#Items/Concessions
		foreach my $ocon ($old_tourn->items) {
			my $ncon = $ocon->copy;
			$ncon->tournament($tourn->id);
			$ncon->update;
		}

		#Sweep points
		foreach my $osw ($old_tourn->sweeps) {
			my $nsw = $osw->copy;
			$nsw->tournament($tourn->id);
			$nsw->update;
		}

		my %event_translator = ();

		#Judge groups

		foreach my $jg ($old_tourn->groups) { 

			my $njg = $jg->copy;

			$njg->tournament($tourn->id);

			if ($njg->deadline) { 
				my $deadline = $njg->deadline;
				my $days_offset = $deadline->delta_days($ostart);

				$deadline->set( month => $start->month);
				$deadline->set( day => $start->day);
				$deadline->set( year => $start->year);
				$deadline->subtract_duration($days_offset);

				$njg->deadline($deadline);
			}
	
			if ($njg->strike_reg_opens) { 
				my $strike_reg_opens = $njg->strike_reg_opens;
				my $days_offset = $strike_reg_opens->delta_days($ostart);
				$strike_reg_opens->set( month => $start->month);
				$strike_reg_opens->set( day => $start->day);
				$strike_reg_opens->set( year => $start->year);
				$strike_reg_opens->subtract_duration($days_offset);
				$njg->strike_reg_opens($strike_reg_opens);
			}

			if ($njg->strike_reg_closes) { 
				my $strike_reg_closes = $njg->strike_reg_closes;
				my $days_offset = $strike_reg_closes->delta_days($ostart);
				$strike_reg_closes->set( month => $start->month);
				$strike_reg_closes->set( day => $start->day);
				$strike_reg_closes->set( year => $start->year);
				$strike_reg_closes->subtract_duration($days_offset);
				$njg->strike_reg_closes($strike_reg_closes);
			}

			$njg->update;

			#Qualification Subsets
			my %subset_translator = ();

			#Quals
			foreach my $oq ($jg->quals) {
				my $nq = $oq->copy;
				$nq->judge_group($njg->id);
				$nq->tournament($tourn->id);
				$nq->update;
			}

			foreach my $qsb (Tab::QualSubset->search( judge_group => $jg->id) ) { 
				my $nqsb = $qsb->copy;
				$nqsb->judge_group($njg->id);
				$nqsb->update;
				$subset_translator{$qsb->id} = $nqsb->id;
			}

			#Registration pools
			foreach my $opg (Tab::PoolGroup->search( judge_group => $jg->id) ) {
				my $npg = $opg->copy;
				$npg->judge_group($njg->id);
				$npg->pool($pool_translator{$opg->pool->id});
				$npg->update;
			}

			#Registration time bins
			foreach my $obin ($jg->bins) { 

				my $nbin = $obin->copy;
				$nbin->judge_group($njg->id);

				my $nstart = $nbin->start;
				my $nend = $nbin->end;

				#Offset in days from the start of the old tournament
				my $nstart_days_offset = $nstart->delta_days($ostart);
				my $nend_days_offset = $nend->delta_days($ostart);

				#Set to the first day of the new tournament
				$nstart->set( month => $start->month);
				$nstart->set( day => $start->day);
				$nstart->set( year => $start->year);

				$nend->set( month => $start->month);
				$nend->set( day => $start->day);
				$nend->set( year => $start->year);

				#Add in the offset
				$nstart->add_duration( $nstart_days_offset );
				$nend->add_duration( $nend_days_offset );

				#Set the new date/time
				$nbin->start($nstart);
				$nbin->end($nend);
				$nbin->update;	
			}
		
			#Events
			foreach my $ev ($jg->events) { 
				my $nev = $ev->copy;
				$nev->tournament($tourn->id);
				$nev->judge_group($njg->id);
				$nev->qual_subset($subset_translator{$ev->qual_subset->id}) if $ev->qual_subset;
		
				if ($nev->deadline) { 
					my $deadline = $nev->deadline;
					my $days_offset = $deadline->delta_days($ostart);
					$deadline->set( month => $start->month);
					$deadline->set( day => $start->day);
					$deadline->set( year => $start->year);
					$deadline->subtract_duration($days_offset);
					$nev->deadline($deadline);
					$njg->update;
				}

				$nev->update;

				$event_translator{$ev->id} = $nev->id;

				# Make the event directory
				system "/bin/mkdir -p $Tab::file_root/files/".$circuit->id."/tournaments/".$tourn->id."/events/".$nev->id;

				# Copy the ballots from the old tournament into it
				system "/bin/cp $Tab::file_root/files/".$circuit->id."/tournaments/".$tourn->id."/events/".$ev->id."/".$ev->ballot." $Tab::file_root/files/".$circuit->id ."/tournaments/". $tourn->id."/events/".$nev->id."/".$nev->ballot;

				#Copy the room pool assignments over
				foreach my $pool ($ev->room_pools) { 
					my $npo = $pool->copy;
					$npo->tournament($tourn->id);
					$npo->event($event_translator{$npo->event->id});
					$npo->update;
				}

			} # End of events

		}
		 # End of judge groups

		# Timeslots

		# These must be translated to the new day, but not the hour.  In order.

		my @ndays;

		foreach my $ots (sort {$a->start->epoch <=> $b->start->epoch} $old_tourn->timeslots) { 
	
			my $nts = $ots->copy;
			$nts->tournament($tourn->id);

			my $ntstart = $nts->start;
			my $ntend = $nts->end;
			my $ntstart_days_offset = $ntstart->delta_days($ostart);
			my $ntend_days_offset = $ntend->delta_days($ostart);

			Tab::log($start);

			$ntstart->set( day => $start->day);
			$ntstart->set( month => $start->month);
			$ntstart->set( year => $start->year);

			$ntend->set( day => $start->day);
			$ntend->set( month => $start->month);
			$ntend->set( year => $start->year);

			$ntstart->add_duration( $ntstart_days_offset );
			$ntend->add_duration( $ntend_days_offset );

			$nts->start($ntstart);
			$nts->end($ntend);
			$nts->update;

			# Rounds
			foreach my $or ($ots->rounds) { 

				my $nr = $or->copy;
				$nr->event($event_translator{$or->event->id});
				$nr->pool($pool_translator{$or->pool->id}) if $or->pool;
				$nr->preset(1) if $nr->type ne "prelim";
				$nr->timeslot($nts->id);
				$nr->site($or->site->id);
				$nr->update;

			}

		}

	} else { 

        my $join = Tab::TournSite->create ({
            tournament => $tourn->id,
            site => $site_id
        });

	}

	# Send email to the circuit administrators

	foreach my $admin ($circuit->admins) { 
	
		my $subject =  $circuit->short_name." Tournament Requested";

		my $body = "
".$account->first." ".$account->last." <".$account->email."> has requested approval for a tournament on tabroom.com in the circuit:\n\n".$circuit->name."\n
Tournament information:\n\n";

		$body .= "\tName: ".$tourn->name."\n";
		$body .= "\tStart Date: ".Tab::nicedate($tourn->start)."\n";
		$body .= "\tEnd Date: ".Tab::nicedate($tourn->end)."\n";
		$body .= "\tLocation: ".$site->name." \n";
		$body .= "\tOnline Registration opens ".Tab::nicedt($tourn->reg_start->set_time_zone($tz))."\n\n";

		$body .="A circuit administrator (such as yourself) must approve this tournament before it can open for online registration. To do so, go to:\n\n".$Tab::url_prefix."/circuit/approvals.mhtml?circuit_id=".$circuit->id."\n\nOr, you can log into Tabroom and click on the Tournaments Pending Approval button on the right.\n\n";


		$m->comp( "/funclib/send_email.mas", from => $account, to => $admin, subject => $subject, body => $body );

	}

	$m->redirect("$Tab::url_prefix/user/request/confirm.mhtml?tourn_id=".$tourn->id);

</%init>



