<%perl>

	use APR::Request qw/encode decode/;
	use Data::Dumper;

	my %cookies = eval { 

		# The standard ModPerl implementation horks on cookies which are
		# illegal under the cookie spec but which our friggin ad company
		# apparently uses anyway, so I implemented the below which will
		# probably break something but that's life sometimes.  -CLP

		my @cookies = split(";", $r->headers_in->{'Cookie'});
		my %return;

		foreach my $cookie (@cookies) { 
			my ($key, @values) = split(/=/, $cookie);
			my $value = decode(join("=", @values));
			$key =~ s/\s+//g; 
			$return{$key} = $value;
		}
		return %return;
	};

    if ( defined $cookies{'TabroomToken'} ) { 

		my $user_key = $cookies{"TabroomToken"};

		# Authentication key must correspond to a session in the database
		my $session = Tab::Session->search( 
			userkey => $user_key 
		)->first;

		my $check_key = crypt($session->id.$Tab::string, $user_key) if $session;

		if ($session) { 

			# Userid must correspond to a user in the database
			my $person = $session->person;

			unless ($person && $person->email && ($check_key eq $user_key) ) { 
				$session->delete;
				my $err = "Your current session has expired or is somehow invalid.  Please log in again";
				$m->redirect("/index/index.mhtml?err=$err");
			} else { 
				return ($person, $session);
			}

		}
	}

	return;

</%perl>
