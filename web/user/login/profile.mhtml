<%args>
	$person
	$person_settings
	$session
	$defaults
	$first   => undef
</%args>
<%init>

	unless ($person) {
		$m->redirect("/index/index.mhtml?err=Your account does not appear to exist. Please log in");
	}

	my $token = $m->comp("/funclib/generate_randomstring.mas", length => 64);
	$defaults->{"token"} = $token;
	$session->default($defaults);

</%init>

	<div class="main">

		<h2>Your Tabroom.com Account</h2>

		<form
			action = "profile_save.mhtml"
			method = "post"
		>

		<input
			type = "hidden"
			name = "token"
			value = "<% $token %>"
		>

		<span class="pagehalf">

%		if ($person_settings->{'scream_in_pain'}) {

			<div class="row">

				<span class="twofifths">
					Please stop screaming
				</span>

				<span class="rightalign nospace">

					<label for="stop_screaming">

						<span class="hover padrightmore">
							<input
								type  = "checkbox"
								name  = "please_stop_screaming"
								value = 1
								id    = "stop_screaming"
								<% $person_settings->{"please_stop_screaming"} ? 'checked="true"' : "" %>
							>
						</span>
					</label>
				</span>
			</div>
%		}

		<div class="row">
			<span class="twofifths">
				First Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "first"
					value = "<% $person->first %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Middle Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "middle"
					value = "<% $person->middle %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Last Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "last"
					value = "<% $person->last %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Street Address
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "street"
					value = "<% $person->street %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				City
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "city"
					value = "<% $person->city %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				State
			</span>

			<span class="threefifths rightalign">
				<select
					name="state"
					class="fixedmed"
				>
					<&
						"/funclib/state_select.mas",
						state => $person->state
					&>
				</select>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Country
			</span>

			<span class="threefifths rightalign">
				<select
					name  = "country"
					class = "fixedmed"
				>
					<& "/funclib/country_select.mas",
						country => $person->country
					&>
				</select>
			</span>
		</div>

%		if ($person->country eq "US") {

			<div class="row">
				<span class="twofifths">
					ZIP code
				</span>

				<span class="threefifths rightalign" >
					<input
						type  = "text"
						name  = "zip"
						value = "<% sprintf("%05d", $person->zip) %>"
						size  = "8"
					>
				</span>
			</div>

%		} else {

			<div class="row">
				<span class="twofifths">
					Postal code
				</span>

				<span class="threefifths rightalign" >
					<input
						type  = "text"
						name  = "postal"
						value = "<% $person->postal %>"
						size  = "16"
					>
				</span>
			</div>
%		}

	</span>

	<span class="pagehalf">

		<div class="row">
			<span class="twofifths">
				Email/Username
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "email"
					value = "<% $person->email %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Phone Number
			</span>

			<span class="threefifths rightalign">
				<input
					type  = "tel"
					name  = "phone"
					value = "<% Tab::phone($person->phone) %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Cell provider *
			</span>

			<span class="threefifths rightalign">
				<select
					name  = "provider"
					class = "fixedmed"
				>
					<& "/funclib/cell_domains.mas",
						provider => $person->provider
					&>
				</select>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Time Zone
			</span>

			<span class="threefifths rightalign">
				<select name="timezone" class="fixedmed">
					<& /funclib/timezones.mas, tz => $person->tz &>
				</select>
			</span>
		</div>

		<div class="row">
			<span class="twofifths">
				Pronouns &dagger;
			</span>

			<span class="threefifths rightalign">
				<input
					type  = "text"
					name  = "pronoun"
					value = "<% $person ? $person->pronoun : "" %>"
					size  = "24"
				>
			</span>
		</div>

%		my $warn = "Fair warning: Checking this option prevents you from getting ANY emails, text blasts, or tournament notices!";

		<label for="shaddap">
			<div class="row hover">
				<span class="threequarters padsetting">
					No Emails or Texts **
				</span>

				<span class="quarter centeralign">
					<input
						type     = "checkbox"
						id       = "shaddap"
						value    = "1"
						name     = "no_email"
						onChange = "warnEmail()"
						<% ($person->no_email) ? "checked" : "" %>
					>
				</span>

			</div>
		</label>

		<script>
			function warnEmail() {
				if ($("#shaddap").prop("checked")) {
					alertify.alert('Please confirm', '<% $warn %>');
				}
			}
		</script>

<%perl>
		if ($person->nsda) {

		    my ($person_ref, $flubber) = $m->comp(
				"/funclib/nsda/api_client.mas",
				path => "/members/".$person->nsda
			) if $person->nsda;

			if ($person_ref) {
</%perl>
				<div class="row">
					<span class="quarter semibold bluetext padsettingtext">
						NSDA ID
					</span>
					<span class="sixth semibold greentext rightalign">
						#<% $person_ref->{person_id} %>
					</span>
					<span class="twofifths semibold bluetext centeralign">
						<% $person_ref->{first}." ".$person_ref->{middle}." ".$person_ref->{last} %>
					</span>
					<span class="fifth semibold greentext rightalign">
						<& "/funclib/commify.mas", number => $person_ref->{points} &> pts
					</span>
				</div>

%			}
%		}

		</span>

		<div class="libl pagefull rightalign">
			<input
				type  = "submit"
				value = "<%($person) ? 'Save Changes' : 'Create Account' %>"
			>
			</form>
		</div>

%		my @logins= $person->logins;

		<h5>Logins</h5>

%		foreach my $login (@logins) {

			<div class="row">

				<span class="fourtenths semibold redtext">
					<% $login->username %>
				</span>

				<span class="fifth padsetting">
					<span class="semibold bluetext half nospace">
						# Logins
					</span>
					<span class="half leftalign nospace">
						<% $login->accesses %>
					</span>
				</span>

				<span class="threetenths">
					<span class="third semibold bluetext nospace">
						Last Login
					</span>
					<span class="twothirds nospace leftalign">
%						if ($login->last_access) {
							<& "/funclib/showdt.mas",
								dt     => $login->last_access,
								length => 'medium'
							&>
%						} else {
							Never
%						}
					</span>
				</span>

				<span class="twenty nospace rightalign">
%					if ($login->username ne $person->email) {
						<a
							class  = "buttonwhite redtext fa fa-sm fa-trash"
							href   = "login_rm.mhtml?login_id=<% $login->id %>"
							title  = "You may delete spare logins if you no longer use them"
						>
						</a>
%					}
				</span>
			</div>
%		}

		<div class="explain padtopmore biggish">
			<p>
				<span class="semibold redtext inline">*CELL PROVIDER:</span>
				Tabroom needs to know this in order to send you text message
				alerts of assignments &amp; results. If you set it to the wrong
				provider you won't get text blast. Set to "Landline/Do Not Text Me"
				if you only want email alerts.
			</p>

			<p class="padtop">
				<span class="semibold redtext inline">**NO EMAILS:</span>
				This setting will prevent you from getting ANY tournament and
				circuit announcement emails. If you're not actively coaching
				anymore, that's fine, but if you're coaching you'll almost
				certainly miss something important by checking this box.
			</p>

			<p>
				If another coach has taken over your program, you should
				go to your home screen, add them to the chapter's
				access tab, and remove yourself.
			</p>


			<p class="padtop">
				<span class="semibold redtext inline">&dagger;PRONOUNS:</span>
				These pronouns will be sent to judges and competitors of a
				section/debate via text message/emails as part of round
				pairings. Pronouns also will appear on judges' online or
				printed ballots. They will NOT appear on the public
				Tabroom.com website either to tournament/tab staff or on the
				public schematics/pairings/entry lists.
			</p>

			<p>
				Please leave blank if you do not consent to these pronouns
				being disclosed to the competitors and judges in the rounds you
				are competing or judging in, or anyone who might be "following"
				their text/email notifications.
			</p>
		</div>
	</div>

	<div class="menu">

%		if ($person_settings->{"api_key"}) {

			<div class="sidenote">

				<h4>API Key</h4>

				<div class="row">
					<span class="third semibold">
						<span class="halfspacer"></span>
						Account ID
					</span>

					<span class="twothirds padvertless">
						<% $person->id %>
					</span>
				</div>

				<div class="row">
					<span class="third semibold">
						<span class="halfspacer"></span>
						API Key
					</span>

					<span class="twothirds padvertless">
						<% $person_settings->{"api_key"} %>
					</span>
				</div>
			</div>
%		}

		<div class="sidenote">

			<h4>Change Password</h4>

			<form
				action = "passwd.mhtml"
				method = "post"
			>

				<input
					type  = "hidden"
					name  = "person_id"
					value = "<% $person->id %>"
				>

				<input
					type  = "hidden"
					name  = "token"
					value = "<% $token %>"
				>

				<div class="row marno">
					<span class="quarter rightalign semibold bluetext">
						Old
					</span>

					<span class="threequarter bigger">
						<input
							type        = "password"
							name        = "oldpass"
							placeholder = "Current Password"
						>
					</span>
				</div>

				<div class="row marno">
					<span class="quarter rightalign semibold bluetext">
						New
					</span>

					<span class="threequarter bigger">
						<input
							type        = "password"
							name        = "newpass"
							id          = "newpass"
							placeholder = "New Password"
							onKeyUp     = "checkStrength();"
						>
					</span>
				</div>

				<div class="row marno">
					<span class="quarter semibold bluetext padsetting rightalign">
						Strength
					</span>

					<span class="threefifths padleft marleft">
                        <meter
                            id      = "passwordStrength"
                            value   = "00"
                            max     = "100"
                            low     = "15"
                            high    = "35"
                            optimum = "60"
                            style   = "width: 84%;"
                        ></meter>
					</span>
				</div>

				<div class="row marno">
					<span class="quarter rightalign semibold bluetext">
						Repeat
					</span>

					<span class="threequarter bigger">
						<input
							type        = "password"
							name        = "repeatpass"
							placeholder = "Repeat New Password"
						>
					</span>
				</div>

				<div class="libl rightalign">
					<span class="third centeralign">
						<input
							type  = "submit"
							value = "Save"
						>
					</span>
				</div>
			</form>
		</div>

		<div class="sidenote">
			<h4>External Login Sync</h5>

			<p>
				Tabroom accounts are also used to Classrooms.cloud
				and the casewiki. If your password stops working on
				either service, but still works on Tabroom, resync it:
			</p>

			<div class="libl rightalign">
				<span class="third centeralign">
					<button
						class     = "full buttonwhite bluetext invert"
						onClick   = "postSwitch(this, 'ldap_sync.mhtml');"
						target_id = "<% $person->id %>"
					>Resync</button>
				</span>
			</div>
		</div>

		<div class="sidenote">
			<h6 class="semibold redtext">
				Don't Share Passwords
			</h6>

			<p class="padleft bigger">
				Your password controls access to your school, student info, and
				tournaments. If someone uses your account to try to pull
				shenanigans, you will be on the hook. Thereforem, every
				individual should use their OWN tabroom.com account. You can
				grant anyone access to your chapter or tournament instead of
				sharing your password.
			</p>

			<h6 class="semibold redtext">
				Privacy &amp; Account Deletion
			</h6>

			<p class="padleft bigger">
				Tabroom.com is a website created &amp; run for the benefit of
				the forensics community by the

				<a 	class="inline hover"
					href="http://www.speechanddebate.org"
				>National Speech and Debate Association.</a>

				Circuit officials and tournament directors will be able to see
				registering coaches' &amp; judges' contact info, &mdash; but
				cannot see competitor contact info directly. Tabroom staff and
				NSDA officials can see any contact information to operate the
				site. But we will never sell or give away your contact
				information to anyone else without your consent.
			</p>

			<div class='full martopmore centeralign'>
				<a
					class="buttonwhite redtext invert bigger semibold"
					href="user_remove.mhtml"
				>Delete your Tabroom account</a>

			</div>
		</div>

		<script
			type = "text/javascript"
			src  = "/lib/javascript/sources/jquery.complexify.js"
		></script>
		<script
			type = "text/javascript"
			src  = "/lib/javascript/sources/jquery.complexify.banlist.js"
		></script>

		<script type="text/javascript">
			function checkStrength() {
				$("#newpass").complexify({}, function (valid, complexity) {
					$("#passwordStrength").val(complexity);
				});
			}
		</script>

	</div>
