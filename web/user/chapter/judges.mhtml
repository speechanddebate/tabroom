<%args>
	$person
	$chapter_id
	$show_retired => undef
	$err          => undef
	$from         => undef
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->abort unless $chapter;

	my @chapter_judges;
 
	if ($show_retired) {
		@chapter_judges = $chapter->chapter_judges;
	} else {
		@chapter_judges = $chapter->chapter_judges( retired => 0 );
	}

	unless (@chapter_judges) {
		$m->redirect("judge_edit.mhtml?newbie=yes&chapter_id=".$chapter_id);
	}

	my $message;

	my @judge_requests = Tab::ChapterJudge->search_where({ 
		chapter => $chapter->id,
		person_request => { ">", 0 }
	});

</%init>

	<div class="main">

		<h2><% $chapter->name %>: Judges</h2>

		<& "tabbar.mas",
			chapter => $chapter,
			person  => $person,
			whoami  => "judges"
		&>

%		if (@judge_requests) { 

			<h4>Judges requesting online access</h4>

			<p>
				The following accounts have asked to be linked to these judges.
				Only permit this if you know the account is the same person as
				the judge; otherwise online balloting and other access may be
				given incorrectly.
			</p>

			<& /funclib/tablesorter.mas, 
				table     => "requests",
				nobuttons => 1
			&>

			<table id="requests">
				
				<tr class="yellowrow">

					<th>
						Judge
					</th>

					<th>
						Requesting Account
					</th>

					<th colspan="2">
					</th>

				</tr>
						
%				foreach my $request (@judge_requests) { 
					
					<tr class="row">
						
						<td>
							<% $request->first." ".$request->last %>
						</td>

						<td>
							<% $request->person_request->first %>
							<% $request->person_request->last %>
							<a href="mailto:<% $request->person_request->email %>">
							(<% $request->person_request->email %>)
							</a>
						</td>

						<td class="centeralign nospace">
							<a 
								class         = "greentext buttonwhite fa fa-lg fa-check"
								target_id     = "<% $request->id %>"
								on_success    = "destroy"
								property_name = "accept"
								onClick  	  = "postSwitch(this, 'judge_link.mhtml');"
							></a>
						</td>

						<td class="centeralign nospace">
							<a 
								class         = "redtext buttonwhite hover fa fa-lg fa-times-circle"
								target_id     = "<% $request->id %>"
								on_success    = "destroy"
								property_name = "deny"
								onClick       = "postSwitch(this, 'judge_link.mhtml');"
							></a>
						</td>

					</tr>
%				}
			</table>
%		}
	
		<div class="full nospace martopmore">

			<span class="half nospace">
				<h4>
					<% scalar @chapter_judges %>
					<% $show_retired ? "Total" : "Active" %>
					Judges
				</h4>
			</span>

			<span class="half rightalign nospace">

				<a 
					class="<% $show_retired ? "redtext" : "bluetext" %> invert buttonwhite hover marrightmore" 
					href="judges.mhtml?show_retired=<% $show_retired ? "" : "true" %>&chapter_id=<% $chapter->id %>"
				>
					<% ($show_retired) ? "Hide Retireds" : "Show Retireds" %>
				</a>
				<a
					class = "buttonwhite greentext fa fa-lg fa-file-excel-o hover"
					title = "Download Excel roster of students"
					href  = "judges_csv.mhtml?chapter_id=<% $chapter->id %>&show_retired=<% $show_retired %>"
				></a>

			</span>

		</div>

		<& "/funclib/tablesorter.mas", table => "judges",  nobuttons => 1 &>

		<table id="judges">

			<thead>

			<tr class="yellowrow">

				<th class="smallish">
					Last 
				</th>

				<th class="smallish">
					First
				</th>

				<th class="smallish">
					Phone
				</th>

				<th class="smallish">
					Account
				</th>

				<th class="centeralign">
					Inactive
				</th>

			</tr>

			</thead>
			<tbody>

%			my $last_judge;

% 			foreach my $chapter_judge (@chapter_judges) { 

%				next if $chapter_judge->retired &! $show_retired;

				<tr>

					<td class="nospace padleft">

						<a id="<% $chapter_judge->id %>"></a>

						<a class="white padtop padbottom" 
							href="/user/chapter/judge_edit.mhtml?chapter_judge_id=<% $chapter_judge->id %>">
							<% $chapter_judge->last %>
						</a>

					</td>

					<td class="nospace padleft">

						<a class="white padtop padbottom" 
							href="/user/chapter/judge_edit.mhtml?chapter_judge_id=<% $chapter_judge->id %>">
							<% $chapter_judge->first %>
						</a>
					</td>

					<td>
						<% Tab::phoneme($chapter_judge->phone) %>
					</td>

					<td class="nospace padleft">

%						if ($chapter_judge->person > 0 ) {
							<a class="white padtop padbottom" 
								href="mailto:<% $chapter_judge->person->email %>"
							>
								<% $chapter_judge->person->email %>
							</a>
%						}
					</td>

					<td class="centeralign nospace">

						<span class="hidden"><% $chapter_judge->retired %></span>

						<label class="switch smaller">
							<input 
								type          = "checkbox"
								value         = "1"
								id            = "<% $chapter_judge->id %>_retired"
								property_name = "retired"
								target_type   = "chapter_judge"
								target_id     = "<% $chapter_judge->id %>"
								onChange      = "postSwitch( this, 'judge_retire.mhtml');"

								<% $chapter_judge->retired ? 'checked="checked"' : "" %>
							>
							<div class="slider offmore"></div>
						</label>

					</td>

				</tr>

%				$last_judge = $chapter_judge->id;

% 			}
			</tbody>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Roster</h4>

			<a class="yellow block" href="judge_edit.mhtml?chapter_id=<% $chapter->id %>">
				Add a new judge
			</a>

			<a class="yellow block" href="diets.mhtml?chapter_id=<% $chapter->id %>#judges">
				Dietary Restrictions
			</a>

			<a class="yellow block" href="dedupe_judges.mhtml?chapter_id=<% $chapter->id %>">
				Deduplicate Judges
			</a>
		
			<a class="<% $show_retired ? "dkred" : "blue" %> block" href="judges.mhtml?show_retired=<% ($show_retired) ? "" : "a" %>&chapter_id=<% $chapter->id %>">
				<% ($show_retired) ? "Hide Inactives" : "Show Inactives" %>
			</a>

		</div>

        <& /user/menu.mas, chapter => $chapter, person => $person, nodiv => 1 &>

	</div>

