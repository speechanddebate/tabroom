<%args>
	$person
	$student_id => undef
	$first      => undef
	$middle     => undef
	$last       => undef
	$phonetic   => undef
	$grad_year  => undef
	$gender     => undef
	$retired    => '0'
	$novice     => '0'
	$chapter_id => undef
	$from       => undef
	$birthdate  => undef
	$race       => undef
	$school_sid => undef
	$diet       => undef
	$nsda       => undef
	$ualt_id    => undef
</%args>
<%init> 

	use Tab::NSDA::Person;

	my $err;
	my $msg;
	my $student;
	my $now = DateTime->now;

#	Remove leading spaces
	$first =~ s/^\s+//;
	$middle =~ s/^\s+//;
	$last =~ s/^\s+//;
	$phonetic =~ s/^\s+//;

#	Capitalize, bitches
	$first = ucfirst($first);
	$middle = ucfirst($middle);
	$last = ucfirst($last);

#	Numbers only please
	$ualt_id =~ s/[\D_]//g;
	$nsda =~ s/[\D_]//g;

	if ($ualt_id) { 
		my $ualt_person = Tab::NSDA::Person->search(ualt_id => $ualt_id)->first;
		$ualt_id = 0 unless $ualt_person;
		$nsda = $ualt_person->user_id if $ualt_person && (not defined $nsda);
	}

	if ($nsda) { 
		my $nsda_person = Tab::NSDA::Person->search(user_id => $nsda)->first;
		$nsda = 0 unless $nsda_person;
		$ualt_id = $nsda_person->ualt_id if $nsda_person &! ($ualt_id > 0);
	}

	unless ($chapter_id) { 
		$err = "WARNING: You do not appear to have an active school";
	}
	$last = ucfirst($last);

	unless ($chapter_id) { 
		$err = "WARNING: You do not appear to have an active school";
	}

	unless ($first) { 
		$err = "WARNING: You have not supplied a first name ";
	}

	unless ($last) { 
		$err = "WARNING: You have not supplied a last name " unless $err;
		$err .= " or last name " if $err;
	}

	if ($err) { 
		$err .= ". Student not saved.";
		$m->redirect("/user/chapter/student_edit.mhtml?student_id=$student_id&err=$err") if ($student_id);
		$m->redirect("/user/chapter/students.mhtml?chapter_id=$chapter_id&err=$err");
	}		

	if ($grad_year) { 

		$grad_year =~  s/[\D_]//g;
		
		my $now_year = $now->year;
		$now_year++ if $now->month > 6;

		unless ($grad_year >= $now_year) { 
			$err = "WARNING: You have entered a graduation year in the past!  Be sure to put the whole year in, not just the last two digits. ";
		}

		if ($grad_year > ($now_year + 10)) {
			$err = "WARNING:  You have entered a graduation year far in the future! ";
		}

		if ($grad_year < 200) { 
			$err = "You have entered a graduation year during the Roman Empire.  Please try again";
			$m->redirect("/user/chapter/student_edit.mhtml?first=$first&middle=$middle&last=$last&chapter_id=$chapter_id&err=$err");
		}

	} else { 

		my $now_year = $now->year;
		$now_year++ if $now->month > 6;
		$grad_year = $now_year unless $grad_year;

		$err = "WARNING: You have not supplied a year of graduation!  Using $grad_year" unless $err;
		$err = $err ." or year of graduation " if $err;
	}

	my $birth_dt;

	if ($birthdate) { 
		$birth_dt = Tab::dateme($birthdate);
	}
	
	if ($student_id) { 

		$student = Tab::Student->retrieve($student_id);
		my $student_school = $student->chapter;
		my $student_school_id = $student_school->id if $student_school;

		my @acc = Tab::Permission->search( 
			tag     => "chapter",
			person  => $person->id,
			chapter => $student_school_id 
		);

		push (@acc, 1) if $person->site_admin;

		if (@acc) { 
			$student->first($first);
			$student->middle($middle);
			$student->last($last);
			$student->phonetic($phonetic);
			$student->grad_year($grad_year);
			$student->novice($novice);
			$student->retired($retired);
			$student->gender($gender);
			$student->birthdate($birth_dt);
			$student->school_sid($school_sid);
			$student->race($race);
			$student->diet($diet);
			$student->chapter($chapter_id);

			$student->ualt_id($ualt_id);
			$student->nsda($nsda);

			$student->update();
			$msg .= " Changes have been saved to ". $first." ".$last;

		} else { 

			$err = "You are not authorized to make that change.  No changes have been saved to ". $first." ".$last;
		}

	} else { 

		$student = Tab::Student->create({ 	
			first      => $first,
			middle     => $middle,
			last       => $last,
			phonetic   => $phonetic,
			grad_year  => $grad_year,
			gender     => $gender,
			birthdate  => $birth_dt,
			school_sid => $school_sid,
			race       => $race,
			diet       => $diet,
			novice     => $novice,
			retired    => $retired,
			ualt_id    => $ualt_id,
			nsda       => $nsda,
			person     => 0,
			chapter    => $chapter_id
		});

		$msg = $first." ".$last." has been added to your school.";
	}

	if ($ualt_id > 0) { 
		$m->comp("/funclib/person_ualt_sync.mas", ualt_id => $ualt_id);
		$m->comp("/funclib/nsda_person_link.mas", 
			student => $student,
			ualt_id => $ualt_id,
			nsda    => $nsda
		);
	}

	$m->redirect("/user/chapter/student_edit.mhtml?student_id=".$student->id."&err=$err&msg=$msg") if $err || $from eq "edit";
	$m->redirect("/user/chapter/student_edit.mhtml?chapter_id=".$chapter_id."&msg=$msg");

</%init> 
