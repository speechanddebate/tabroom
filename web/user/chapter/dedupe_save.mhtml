<%args>
	$account
	$chapter_id
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->print($account->email." is my email");

	my %students_by_name = ();

	foreach my $student ($chapter->students) { 
		next unless $student->last;
		push @{$students_by_name{$student->first."-".$student->last}}, $student;
	}

	Tab::EntryStudent->set_sql( steal => "
		update entry_student
		set student = ?
		where student = ?
	");

	Tab::Housing->set_sql( steal => "
		update housing
		set student = ?
		where student = ?
	");

	Tab::BallotValue->set_sql( steal => "
		update ballot_value
		set student = ?
		where student = ?
	");

	Tab::Result->set_sql( steal => "
		update result
		set student = ?
		where student = ?
	");

	my $count;

	foreach my $key (keys %students_by_name) { 

		next if scalar @{$students_by_name{$key}} < 2;
		next unless $ARGS{$key};

		my $dest = shift @{$students_by_name{$key}};

		my $account_id = $dest->account->id if $dest->account;
		my $grad_year = $dest->grad_year;

		foreach my $student (@{$students_by_name{$key}}) { 

			Tab::log($account->email." transferring ".$student->id." records to ".$dest->id);

			$grad_year = $student->grad_year unless $grad_year;
			$account_id = $student->account->id if $student->account && not defined $account_id;
			Tab::EntryStudent->sql_steal->execute($dest->id, $student->id);
			Tab::Housing->sql_steal->execute($dest->id, $student->id);
			Tab::BallotValue->sql_steal->execute($dest->id, $student->id);
			Tab::Result->sql_steal->execute($dest->id, $student->id);
			$student->delete;
			$count++;
		}

		$dest->grad_year($grad_year);
		$dest->account($account_id);
		$dest->update;

	}

	my $msg = "$count students de-duplicated.";

	$m->redirect("dedupe.mhtml?chapter_id=$chapter_id&msg=$msg");



</%init>
