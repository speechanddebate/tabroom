<%args>
	$chapter_id => undef
	$tourn_id   => undef
</%args>
<%init>

	use Tab::NSDA::MemberSchool;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	unless ($chapter->nsda) { 

		$m->comp(
			"/funclib/abort.mas", 
			err => "That school has no NSDA Chapter ID"
		);

	}

	my $nsda_chapter = Tab::NSDA::MemberSchool->retrieve($chapter->nsda);

	$chapter->setting('nsda_degrees', $nsda_chapter->school_total_deg);
	$chapter->setting('nsda_charter', $nsda_chapter->school_charter_status);
	$chapter->setting('nsda_paid', $nsda_chapter->school_paid_status);

	my $now = DateTime->now;
	my $grad_year_limit = $now->year;
	$grad_year_limit++ if $now->month > 8;

	my $dbh = Tab::NSDA::PointsDBI->db_Main();

	my $sth = $dbh->prepare("

		select distinct NEW_USERS.user_id, NEW_USERS.ualt_id, NEW_USERS.grad_yr, 

			NEW_USERS.total_pts, 
			NEW_USERS.paid_status, 
			DEMOGRAPHICS.student_email, 
			high_joined.dateacquired,
			middle_joined.dateacquired

		from (NEW_USERS, NEW_USERS_TO_SCHOOLS)
		left join DEMOGRAPHICS on DEMOGRAPHICS.person_id = NEW_USERS.user_id

		left join NEW_USERS_TO_DEGREES high_joined 
			on high_joined.ualt_id = NEW_USERS.ualt_id 
			and high_joined.degree_id = 51

		left join NEW_USERS_TO_DEGREES middle_joined 
			on middle_joined.ualt_id = NEW_USERS.ualt_id 
			and middle_joined.degree_id = 21

		where NEW_USERS_TO_SCHOOLS.school_id = ? 
		and NEW_USERS_TO_SCHOOLS.ualt_id = NEW_USERS.ualt_id
		and (NEW_USERS.utype = 'Student'
			or NEW_USERS.utype = 'MIDStudent')
		and NEW_USERS_TO_SCHOOLS.enddate = '0000-00-00 00:00:00'
		and NEW_USERS.grad_yr >= ? 
		order by NEW_USERS.ulname, NEW_USERS.ufname
	");

	$sth->execute($chapter->nsda, $grad_year_limit);

	#existing students mapped by NSDA id
	my %students = map {$_->nsda => $_} $chapter->students();

	while ( my (
			$user_id, $ualt_id, 
			$grad_year, $nsda_points, $nsda_paid, 
			$student_email, $high_join_date, $middle_join_date
		) = $sth->fetchrow_array() 
	) {

		my $student = $students{$user_id};
		next unless $student;

		my $ok;
		unless ($ualt_id == $student->ualt_id) { 
			$student->ualt_id($ualt_id);
			$student->update();
		}

		$student->setting('student_email', $student_email); 
		$student->setting('nsda_paid', $nsda_paid); 
		$student->setting('nsda_points', int($nsda_points)); 

		my $high_datetime = 
			DateTime::Format::MySQL->parse_datetime($high_join_date) 
			if $high_join_date;

		my $middle_datetime = 
			DateTime::Format::MySQL->parse_datetime($middle_join_date) 
			if $middle_join_date;

		$student->setting('nsda_joined', "date", $high_datetime) if $high_datetime;
		$student->setting('nsda_joined', "date", $middle_datetime) if $middle_datetime;  

	}

	my $msg = $chapter->name." records synchronized with the latest data in the NSDA Points system";
	$m->redirect("/user/nsda/student_roster.mhtml?chapter_id=".$chapter->id."&tourn_id=$tourn_id&msg=$msg") if $tourn_id;
	$m->redirect("nsda.mhtml?chapter_id=".$chapter->id."&msg=$msg");

</%init>
