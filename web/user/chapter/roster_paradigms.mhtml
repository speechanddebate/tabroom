<%args>
	$chapter_id
	$person
	$person_settings
	$perms
	$dbh
</%args>
<%init>

	unless ($person->site_admin || $perms->{chapter}{$chapter_id} eq "chapter") {
		$m->comp("/funclib/abort.mas",
			message => "You are not an admin for that chapter."
		);
	}

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my $sth = $dbh->prepare("
		select
			person.id,
			person.first, person.middle, person.last,
			person.email,
			paradigm.timestamp,
			paradigm.value_text

		from (chapter_judge cj, person, person_setting paradigm)

		where cj.chapter = ?
			and cj.person = person.id
			and cj.retired = 0
			and paradigm.person = cj.person
			and paradigm.tag = 'paradigm'
		group by person.id
		order by person.last
	");

	$sth->execute(int($chapter_id));

	my $judges = $sth->fetchall_hash();

</%init>

	<script>
		const toggleParadigm = ( (personId) => {
			$(`#${ personId }_button`).toggleClass('fa-eye-slash');
			$(`#${ personId }_button`).toggleClass('fa-eye');
			$(`#${ personId }_button`).toggleClass('invert');
			$(`#${ personId }_paradigm`).toggleClass('hiddencsv');
			fixVisual();
		});
	</script>

	<div class="main">

		<div class="full flexrow">
			<span class="quarter">
				<h5>Judge Paradigms</h5>
			</span>
			<span class="fiveeighths grow rightalign semibold biggish">
				<% $chapter->name %>:
				<% scalar @{$judges} %> active paradigms
			</span>
			<span
				class = "eighth rightalign"
				id    = "chapter_paradigms_buttonarea"
			>
			</span>
		</div>

		<& "/funclib/tablesorter.mas",
			table => "chapter_paradigms"
		&>

		<table id="chapter_paradigms">

			<thead>
				<tr>
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Email
					</th>

					<th>
						Last Edit
					</th>

					<th>
						Words
					</th>

					<th>
						View
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>
				foreach my $judge (@{$judges}) {

					my $test_length = $judge->{value_text};

					$test_length =~ s|<.+?>||g;
					$test_length =~ s/^\s+//;
					$test_length =~ s/\s+$//;

					my @words = split (/\ /, $test_length);
					my $word_count = scalar @words;

</%perl>
					<tr class='nohover'>
						<td>
							<% $judge->{first} %>
						</td>

						<td>
							<% $judge->{last} %>
						</td>

						<td>
							<% $judge->{email} %>
						</td>

						<td
							class     = "smallish nowrap"
							data-text = "<% $judge->{timestamp} %>"
						>
							<& "/funclib/showdate.mas",
								string => $judge->{timestamp},
								format => 'medium',
							&>
						</td>

						<td class="rightalign padright">
							<% $word_count %>
						</td>

						<td>
							<button
								id      = "<% $judge->{id} %>_button"
								class   = 'fa fa-eye-slash buttonwhite bluetext'
								onClick = "toggleParadigm(<% $judge->{id} %>);"
							></button>
						</td>
					</tr>

					<tr
						class = 'hiddencsv nohover'
						id    = "<% $judge->{id} %>_paradigm"
					>
						<td colspan="12" class="padleft padright padbottommore">
							<% $judge->{value_text} %>
						</td>
					</tr>
%				}
			</tbody>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Roster</h4>

			<a class="yellow full"
				href="judge_edit.mhtml?chapter_id=<% $chapter_id %>"
			>
				Add a new judge
			</a>

			<a class="yellow full"
				href="diets.mhtml?chapter_id=<% $chapter_id %>#judges"
			>
				Dietary Restrictions
			</a>

			<a class="yellow full"
				href="dedupe_judges.mhtml?chapter_id=<% $chapter_id %>"
			>
				Deduplicate Judges
			</a>

			<a class="dkblue full"
				href="roster_paradigms.mhtml?chapter_id=<% $chapter_id %>"
			>
				Your Judge's Paradigms
			</a>

			<a class="blue full"
				href="judges.mhtml?show_retired=1&chapter_id=<% $chapter_id %>"
			>
				Show Inactive Roster
			</a>

		</div>

        <& /user/menu.mas,
			person_settings => $person_settings,
			chapter         => $chapter,
			person          => $person,
			nodiv           => 1
		&>

	</div>

