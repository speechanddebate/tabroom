<%args>
	$person
	$school_id
	$category_id => undef
</%args>
<%init>

	use POSIX;

	my $school = Tab::School->retrieve($school_id);
	my $category = Tab::Category->retrieve($category_id);
	my $tourn = $school->tourn;
	my %tourn_settings = $tourn->all_settings;

	my @categories;

	if ($tourn_settings{"mock_trial_registration"}) {

		Tab::Category->set_sql( "observers" => "
			select
				category.*
			from category, category_setting cs
				where category.tourn = ?
				and category.id = cs.category
				and cs.tag = 'observers'
			order by category.abbr
		");
		@categories = Tab::Category->search_observers($tourn->id);
	} else {
		@categories = $tourn->categories;
	}

	$category = $categories[0] if scalar @categories == 1;
	$category_id = $category->id if scalar @categories == 1;

	my @events = $category->events if $category;

	my %category_settings = $category->all_settings if $category;

	my $err;

	my $tz = $person->tz;
	$tz = $tourn->tz unless $tz;
	$tz = "UTC" unless $tz;

	#Make sure that the tournament is open for registration
	my $now = DateTime->now( time_zone => $tz);

	my $judge_deadline = $tourn_settings{"judge_deadline"};
	$judge_deadline->set_time_zone($tz) if $judge_deadline;

	my $judge_per = $category_settings{"judge_per"};
	my $rounds_per = $category_settings{"rounds_per"};
	my $frees_no = $category_settings{"free_strikes_dont_count"};

	my $total_rounds;

	my $fyo_label = $category_settings{"fyo_label"};
	$fyo_label = "First Year Judge" unless $fyo_label;

	my @requests;

	if ($category && $school) {
		@requests = Tab::JudgeHire->search(
			school   => $school->id,
			category => $category->id
		);
	}

	my $deadline;
	my %used_judge = ();

	my %category_weekend;
	my %weekends;

	if ($tourn_settings{"nsda_district"}) {

		OCATEGORY:
		foreach my $ocategory (@categories) {

			my $weekend_id = $ocategory->setting("weekend");

			next unless $weekend_id;
			next if $weekend_id eq "nope";
			my $weekend;

			unless ($weekends{$weekend_id}) {

				$weekend = Tab::Weekend->retrieve($weekend_id);
				next OCATEGORY unless $weekend;

				$category_weekend{$ocategory->id} = $weekend;
				$weekends{$weekend_id}{'object'} = $weekend;
				$weekends{$weekend_id}{"judge_deadline"} = $weekend->judge_deadline->set_time_zone($tz);
				$weekends{$weekend_id}{"reg_start"} = $weekend->reg_start->set_time_zone($tz);

			} else {
				$weekend = $weekends{$weekend_id}{'object'};
			}

			if ($category == $ocategory) {
				$judge_deadline = $weekends{$weekend_id}{"judge_deadline"};
			}
		}
	}

	my $hired_deadline_passed;

	if ($category_settings{"hired_deadline"}) {
		$hired_deadline_passed++
			if $now->epoch > $category_settings{"hired_deadline"}->epoch;
	}

	my $category_deadline = $category_settings{"deadline"};
	$category_deadline->set_time_zone($tz) if $category_deadline;
	$category_deadline = $judge_deadline->clone
		if (not defined $category_deadline)
		&& $judge_deadline;

	if ($category_deadline && $category_deadline < $now) {
		$deadline++;
	}

	my $drop_deadline;

	if ($category_settings{"open_switcheroo"} && $category_settings{"open_switcheroo"} < $now) {
		$drop_deadline++;
	}

	my @free_judges;

	if ($category && not defined $deadline) {
		@free_judges = $m->comp(
			"/funclib/chapter_judges_free.mas",
			school   => $school,
			category => $category
		);
	}

	@free_judges = sort {lc($a->last) cmp lc($b->last)} @free_judges;

	my $exchange_hires;

	my %vax = ();

	if ($tourn_settings{"vaccines"}) {

		my $dbh = Tab::DBI->db_Main();
		my $sth = $dbh->prepare("
			select
				judge.id judge, judge.first, judge.last,
				person.id person, person.email,
				vaccine.value status

			from (judge)
				left join person on judge.person = person.id
				left join person_setting vaccine on vaccine.person = person.id and vaccine.tag = 'vaccine_".$tourn->id."'
			where judge.school = ?
		");

		$sth->execute($school);

		my $results = $sth->fetchall_hash();

		foreach my $result (@{$results}) {
			push @{$vax{$result->{"judge"}}}, $result;
		}
	}


</%init>

	<div class="main">

		<& "tabbar.mas",
			school => $school,
			whoami => "judges"
		&>

		<span class="twothirds nospace">
			<h4><% $tourn_settings{"mock_trial_registration"} ? "Non Competing Attendees" : "Judges" %></h4>
		</span>

		<span class="third rightalign nospace">
%			unless ($tourn_settings{"ncfl"} || ((scalar @categories) < 2 )) {
				<form action="judges.mhtml" method="post">
					<input
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>

					<select
						name             = "category_id"
						class            = "fixedmost"
						onChange         = "this.form.submit();"
						data-placeholder = "Select category..."
					>
						<option value=""></option>
%						foreach my $ocat (sort {$a->name cmp $b->name} @categories) {
							<option
								value="<% $ocat->id %>"
								<% $ocat == $category ? "selected" : "" %>
							>
								<% $ocat->name %>
							</option>
%						}
					</select>
				</form>
%			}
		</span>

%		if ($tourn_settings{"mock_trial_registration"} && $category_settings{"observers"}) {

%			if ($category_settings{"school_registration_notice"}) {
				<p class="centeralign semibold bluetext bigger">
					<% $category_settings{"school_registration_notice"} %>
				</p>
%			}

			<form action="attendee_save.mhtml" method="post">

				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<div class="ltyellow full semibold padvertless">
					<span class="twentieth">
						<span class="halfspacer"></span>
						#
					</span>
					<span class="twoninths">
						<span class="halfspacer"></span>
						First Name
					</span>
					<span class="twoninths">
						<span class="halfspacer"></span>
						Last Name
					</span>
					<span class="twoninths">
						<span class="halfspacer"></span>
						Phone
					</span>
					<span class="threetenths">
						<span class="halfspacer"></span>
						Notes/Role (Coach, parent, etc)
					</span>
					<span class='twentieth'>
					</span>
				</div>

%				my $counter = 1;

%				foreach my $judge ($school->judges( category => $category->id)) {

					<div class='row padvertless' id="<% $judge->id %>">
						<span class="twentieth">
							<span class="halfspacer"></span>
							<% $counter++ %>
						</span>

						<span class="twoninths">
							<input
								type        = "text"
								name        = "first_<% $judge->id %>"
								value       = "<% $judge->first %>"
							>
						</span>
						<span class="twoninths">
							<input
								type        = "text"
								name        = "last_<% $judge->id %>"
								value       = "<% $judge->last %>"
							>
						</span>
						<span class="twoninths">
							<input
								type        = "tel"
								name        = "phone_<% $judge->id %>"
								value       = "<% &Tab::phoneme($judge->setting("phone")) %>"
							>
						</span>
						<span class="threetenths">
							<input
								type        = "text"
								name        = "notes_<% $judge->id %>"
								value       = "<% $judge->setting("notes") %>"
							>
						</span>
						<span class='twentieth'>
							<a
								class       = "fa fa-trash buttonwhite redtext"
								title       = "Remove this attendee"
								judge_id    = "<% $judge->id %>"
								school_id   = "<% $school->id %>"
								category_id = "<% $category->id %>"
								onClick     = "postSwitch(this, 'attendee_rm.mhtml'); fixVisual();"
							></a>
						</span>
					</div>
%				}

%				foreach (1 .. 5) {

					<div class='row padvertless'>

						<span class="twentieth">
							<span class="halfspacer"></span>
							<% $counter++ %>
						</span>

						<span class="twoninths">
							<input
								type        = "text"
								name        = "first_<% $_ %>"
								placeholder = "Add new..."
							>
						</span>
						<span class="twoninths">
							<input
								type        = "text"
								name        = "last_<% $_ %>"
							>
						</span>
						<span class="twoninths">
							<input
								type        = "tel"
								name        = "phone_<% $_ %>"
							>
						</span>
						<span class="threetenths">
							<input
								type        = "text"
								name        = "notes_<% $_ %>"
							>
						</span>
					</div>
%				}

				<div class="libl row rightalign">
					<span class="third centeralign">
						<input
							type  = "submit"
							value = "Save Attendee Info"
						>
					</span>
				</div>
			</form>
%		} else {

<%perl>

		my @show_categories;

		if ($tourn_settings{"ncfl"}) {
			push @show_categories, @categories;
		} elsif ($category) {
			push @show_categories, $category;
		}

		foreach my $category (@show_categories) {

			my %status;
			my $online_ballots;

			foreach my $e (@events) {
				if ($e->setting("online_ballots")) {
					$online_ballots++
				}
			}

			my %category_settings = $category->all_settings();

			my @judges = $m->comp(
				"/funclib/judgemath/judges_by_category.mas",
					school            => $school,
					category          => $category,
					category_settings => \%category_settings
			);

			next if ($tourn_settings{"ncfl"} && (scalar @judges) < 1);

			my $details_deadline;

			if ($category_settings{"details_deadline"}) {
				$details_deadline++ if $category_settings{"details_deadline"} < $now;

			} elsif ($category_weekend{$category->id}) {
				$details_deadline++ if $category_weekend{$category->id}->judge_deadline < $now;

			} else {
				$details_deadline++ if $tourn_settings{"judge_deadline"} < $now;
			}

			my @all_shifts = $category->shifts;

			my @shifts;

			foreach my $shift (@all_shifts) {
				next if $shift->type eq "signup";
				push @shifts, $shift;
			}

			($status{"unc"}, $status{"over"}) = $m->comp(
				"/funclib/judgemath/uncovered_burden_by_category.mas",
					school            => $school,
					category          => $category,
					category_settings => \%category_settings,
					tourn_settings => \%tourn_settings,
			);

            my %stimes_under = $m->comp(
                "/funclib/judgemath/judge_partials_short.mas",
					category          => $category,
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings
            );

			Tab::JPool->set_sql('registrant' => "
				select jpool.*
				from jpool, jpool_setting
				where jpool.category = ?
				and jpool.id = jpool_setting.jpool
				and jpool_setting.tag = 'registrant'
				and jpool_setting.value = 1
			");

			my @registrant_jpools = Tab::JPool->search_registrant($category->id);

			my %in_jpools = ();

			if (@registrant_jpools) {

				my $dbh = Tab::DBI->db_Main();
				my $sth = $dbh->prepare("
					select judge.id, jpool_judge.jpool
					from judge, jpool_judge
					where judge.school = ?
					and judge.id = jpool_judge.judge
				");

				$sth->execute($school->id);

				while (
					my ($judge_id, $jpool_id)  = $sth->fetchrow_array()
				) {
					$in_jpools{$judge_id}{$jpool_id}++;
				}
			}

</%perl>
			<div class="full ltbordertop nospace padtopmore">
				<span class="truethird nospace">
					<h5><% $category->name %></h5>
				</span>

				<span class="truethird centeralign padtop nospace">
%				if ($tourn_settings{"ncfl"}) {

%				} elsif ($status{"unc"}) {
					<p class="redtext semibold bigger">
%						if ($judge_per) {
						 	You owe <% ceil ($status{"unc"} / $judge_per) %>
							more judge<% ($status{"unc"}/$judge_per) > 1 ? "s" : ""%>
%						} elsif ($rounds_per) {
							You owe <% $status{"unc"} %> more round<% ($status{"unc"} == 1) ? "" : "s" %>
%						} else {
							This tournament hasn&apos;t set up its judge burdens yet.
%						}
					</p>
%				}
				</span>

%				if (@free_judges && (not defined $tourn_settings{"ncfl"}) ) {

					<span class="truethird rightalign nospace">

						<form
							action = "judge_save.mhtml"
							method = "post"
						>

							<input
								type  = "hidden"
								name  = "category_id"
								value = "<% $category->id %>"
							>
							<input
								type  = "hidden"
								name  = "school_id"
								value = "<% $school->id %>"
							>

							<select
								name             = "chapter_judge_id"
								size             = "7"
								class            = "fixedmost"
								onChange         = "this.form.submit();"
								data-placeholder = "Add judge..."
							>
<%perl>
								foreach my $chapter_judge (@free_judges) {

									next if $used_judge{$chapter_judge->id}++;
</%perl>
									<option
										value="<% $chapter_judge->id %>"
									><% $chapter_judge->last.", ".$chapter_judge->first %></option>

%								}

							</select>
						</form>
					</span>
%				}

			</div>

%			if ($details_deadline) {
				<p class="centeralign semibold redtext bigger">
					The deadline to change any judge information has passed. <br />
					You must contact the tournament directly to make further changes.
				</p>

%			} elsif ($deadline) {
				<p class="centeralign semibold redtext bigger">
					The deadline to register or drop judges has passed. <br />
					You must contact the tournament directly to make further changes.
				</p>
%			}

%			if ($category_settings{"school_registration_notice"}) {
				<p class="centeralign semibold bluetext bigger">
					<% $category_settings{"school_registration_notice"} %>
				</p>
%			}

<%perl>
			foreach my $key (keys %stimes_under) {

				my $stime = Tab::JudgeShift->retrieve($key);
				next unless $stimes_under{$stime->id} > 0;

				undef $status{"over"};

				if ($stime->no_hires) {
</%perl>
					<h5 class="redtext centeralign">
						You are under obligation a time block.
					</h5>

					<p class="redtext full strong centeralign">

						<br />
							<% $stimes_under{$stime->id} %> too many judges marked as "<% $stime->name %>".
						<br />

						This tournament does not offer partial hires; you must fulfill obligation in all time periods.
					</p>

%				} elsif ($stime->fine) {

					<p class="redtext full strong centeralign">
						<% $stimes_under{$stime->id} %>
							too many judges marked as "<% $stime->name %>".
					</p>

%				}

%				if ($stime->fine) {
					<p class="redtext full strong centeralign">
						You will be charged
						<%
							$tourn_settings{"currency"}
							? $tourn_settings{"currency"}
							: "&#36;"
						%><% $stime->fine * $stimes_under{$stime->id} %>

						unless you meet your judge obligation in all time blocks.
					</p>
%				}
%			}


%			if ($status{"over"}) {

				<p class="greentext full centeralign semibold bigger marno">

%					if ($category_settings{"hired_fee"} > 0 && $judge_per) {
					 	You are over obligation on judging by
							<% ceil ($status{"over"} / $judge_per) %> judges.
%					} elsif ($judge_per) {
						You have enough judging coverage for
							<% $status{"over"} %> more entr<% ($status{"over"} == 1) ? "y" : "ies" %>
%					} elsif ($rounds_per) {
						You are over obligation on judging by
						<% $status{"over"} %> round<% ($status{"over"} == 1) ? "" : "s" %>
%					}

%					if (@requests) {
						<br />
						You may still be charged for undeleted hired requests, even if you provide extra judges.
%					}
				</p>
%			}

%			if ($rounds_per && (not defined $details_deadline)) {

				<form
					action = "rounds_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>
				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>
%			}

%			if (@judges) {
				<table>
					<tr class="yellowrow smallish">
%						unless ($tourn_settings{"ncfl"}) {
							<th>
								Edit
							</th>
%						}

%						unless ($tourn_settings{"hide_codes"} || $category_settings{"no_codes"}) {
							<th>Code</th>
%						}

						<th>
							Name
						</th>

%						if ($rounds_per) {
							<th>
								Rounds
							</th>
%						}

%						if ($online_ballots) {
							<th title="Linked account for online ballots">
								Link?
							</th>
%						}

%						if ($category_settings{"paradigm_before_strikes"} || $category_settings{"paradigm_form"}) {
							<th>
								Paradigm<% $category_settings{"paradigm_before_strikes"} ? '*' : '' %>
							</th>
%						}

%						if (@shifts) {
							<th>
								Availability
							</th>
%						}

%						if (@registrant_jpools) {
							<th>
								Pools
							</th>
%						}

%						if ($category_settings{"coach_ratings"}) {
							<th>
								Ratings
							</th>
%						}

						<th>
							Details
						</th>

						<th>
							Conflicts
						</th>

%						unless ($tourn_settings{"ncfl"} || $deadline) {
							<th>
							</th>
%						}

					</tr>

<%perl>
					my $first_free = 1 if $category_settings{"dont_count_free_strikes"};

					foreach my $judge (@judges) {

						my @strikes = $judge->strikes();

						$used_judge{$judge->chapter_judge->id}++ if $judge->chapter_judge;

						$total_rounds += $judge->obligation unless $judge->setting("free_strike");

						my $args = "school_id=".$school->id."&judge_id=".$judge->id;

						if ($frees_no && $first_free && $judge->setting("free_strike")) {

							undef $first_free;
</%perl>
							<tr class="oddrow">
								<td colspan="28">
									<h4>Non-credited judging:</h4>
								</td>
							</tr>
%						}

						<tr class="row">
%							unless ($tourn_settings{"ncfl"}) {
								<td class="centeralign">
%									unless ($details_deadline || $tourn_settings{"ncfl"}) {
										<a
											class="buttonwhite bluetext fa fa-edit fa-sm"
											href="judge_details.mhtml?<% $args %>">
										</a>
%									}
								</td>
%							}

%							unless ($tourn_settings{"hide_codes"} || $category_settings{"no_codes"}) {
								<td>
									<% $judge->code %>
								</td>
%							}

							<td>
								<% $judge->first." ".$judge->last%>
							</td>

%							if ($rounds_per && $deadline) {

								<td class="centeralign">
									<% $judge->obligation %>
								</td>

%							} elsif ($rounds_per) {

								<td class='centeralign'>
									<input
										type  = "number"
										name  = "<% $judge->id %>"
										size  = "5"
										min   = "1"
										max   = "99"
										value = "<% $judge->obligation %>"
									>
								</td>
%							}

%							if ($online_ballots) {
								<td class="centeralign">
									<span class="fa <% $judge->person > 0 ? "greentext fa-check" : "redtext fa-times" %>"></span>
								</td>
%							}

%							if ($category_settings{"paradigm_form"}) {
								<td class="centeralign">
									<a
										href  = "questionnaire.mhtml?<% $args %>&tag=<% $category_settings{"paradigm_form"} %>"
										class = "bluetext buttonwhite smallish marvertmore fa fa-file-text-o"
									></a>
								</td>
%							} elsif ($category_settings{"paradigm_before_strikes"}) {
								<td class="centeralign nospace">
%									if ($judge->person > 0 && $judge->person->setting('paradigm')) {
										<span class="fa greentext fa fa-check"></span>
%									} else {
										<span class="fa redtext fa fa-times"></span>
%									}
								</td>
%							}

%							if (@shifts) {
%								my $haz_shifts;
								<td class="smaller">
%									unless ($deadline) {
										<a
											class="white"
											href="judge_details.mhtml?<% $args %>"
										>
<%perl>
									}

									foreach my $shift (@shifts) {
										if ($shift->strike($judge)) {
											$haz_shifts++;
											my $name = $shift->name;
											$name =~ s/^No //;
</%perl>
											<span class="full smallish padvertless marno">
												Not available <% $name %>
											</span>
%										}
%									}

%									unless ($haz_shifts) {
										All rounds
%									}
%									unless ($deadline) {
										</a>
%									}
								</td>
%							}

%							if (@registrant_jpools) {
								<td class="smaller nospace">
%									unless ($details_deadline) {
										<a
											class="white bluetext semibold marno padleft padless"
											href="judge_details.mhtml?<% $args %>"
										>
%									}
%									foreach my $jpool (@registrant_jpools) {
%										next unless $in_jpools{$judge->id}{$jpool->id};
										<div class="full nospace padvertless">
											<% $jpool->name %>
										</div>
%									}
%									unless ($details_deadline) {
										</a>
%									}
								</td>
%							}

%							if ($category_settings{"coach_ratings"}) {
								<td class="centeralign smallish">
									<% $m->comp("/funclib/judge_rating.mas",
										print => 1,
										judge => $judge )
									%>
								</td>
%							}

							<td>

%								if ($tourn_settings{"vaccines"}) {
									<span class="full nospace smallish">
%										foreach my $judge (sort {$a->{"last"} cmp $b->{"last"}} @{$vax{$judge->id}}) {
											<span class="fa fa-sm nospace tenth
												<% $judge->{'status'} eq "confirmed" ? "greentext fa-check" : "redtext fa-times" %>"
											></span>
											<% $judge->{"person"} ? "" : "NO TABROOM ACCOUNT" %>
											<% $judge->{"status"} ?
												$judge->{"status"} eq "confirmed"
													? "VaccineCheck Completed"
													: "VaccineCheck ".$judge->{"status"}
												: ""
											%>
											<% $judge->{"person"}
												&& (not defined $judge->{"status"})
												? "VaccineCheck Process Unstarted"
												: ""
											%>
%										}
									</span>
%								}

%								if ($judge->ada) {
									<span class="semibold bluetext full padless marno">
										ADA rooms requested
									</span>
%								}

%								if ( $category_settings{"first_year_outs"} || $category_settings{"dont_count_free_strikes"}) {
									<span class="redtext semibold full padless marno">
										<% $judge->setting("first_year") ?  $fyo_label : "" %>
										<% $judge->setting("free_strike") ? "(Free Strike)" : "" %>
									</span>
%								}
							</td>

							<td>
%								if ($judge->setting("online_hybrid")) {
									<span class="full centeralign semibold redtext nospace padvertless smallish">
										ONLINE
									</span>
%								}

%								foreach my $strike (sort {$a->type cmp $b->type} @strikes) {
%									if ($strike->type eq "departure" && $strike->start < $tourn->end) {
										<span class="full nospace padless smallish bluetext semibold">
											Departing <&
												"/funclib/showdt.mas",
													dt     => $strike->start,
													length => "casual",
													tz     => $tourn->tz
												&> <% &Tab::tzname($tourn->tz) %>
										</span>
%									} elsif ($strike->registrant && $strike->conflict) {
										<span class="full nospace padless smaller redtext semibold">
%											if ($strike->type eq "event") {
												No <% $strike->event->abbr %>
%											} elsif ($strike->type eq "school") {
												No <% $strike->school->short_name %>
%											} elsif ($strike->type eq "entry") {
												No <% $strike->entry->name %>
%											}
										</span>
%									}
%								}
							</td>

%							unless ($deadline || $drop_deadline || $tourn_settings{"ncfl"}) {
								<td class="centeralign padless">
									<a
										class="redtext buttonwhite fa-trash fa fa-lg padless"
										href="judge_drop.mhtml?<% $args %>">
									</a>
								</td>
%							}

						</tr>
%					}

					</table>

%				if ($rounds_per) {
					<div class="row centeralign ltborder">
						<span class="fivesixths rightalign semibold bluetext padvertmore">
							Total Rounds Provided:
						</span>

						<span class="sixth leftalign semibold bluetext padvertmore">
							<% $total_rounds %>
						</span>
					</div>
%				}

%				if ($rounds_per && (not defined $deadline)) {
					<div class="liblrow rightalign">
						<span class="third centeralign">
							<input
								type  = "submit"
								value = "Save Rounds"
							>
						</span>
					</div>
					</form>
%				}

%				if ($category_settings{"paradigm_before_strikes"}) {
					<p class="semibold redtext padbottommore centeralign biggish martopmore">
						*This tournament requires all judges to have a paradigm
						before you may enter strikes or preferences.
					</p>
%				}

%			} elsif ($rounds_per) {
				</form>
%			}

%			if ($tourn_settings{"ncfl"}) {

%			} elsif (@registrant_jpools) {
				<div class="full centeralign">
					<span class="seveneighths leftalign">
						<h6 class="semibold bluetext">
							<% $category->abbr %> Judge Pool Obligations
						</h6>
<%perl>
						foreach my $jpool (@registrant_jpools) {

							my %burdens = $m->comp(
								"/funclib/jpool_burden.mas",
									jpool  => $jpool,
									school => $school
								);

							my $jpool_burden;
							my $round_burden;

							if ($category_settings{"rounds_per"}) {
								$round_burden = POSIX::ceil($burdens{"all"} / $category_settings{"rounds_per"});
							}

							my $hires;

							foreach my $request (@requests) {
								$burdens{"all"} -= $request->entries_accepted;
								$hires += $request->entries_accepted;
								$round_burden -= $request->rounds_accepted;
							}

							if ($category_settings{"judge_per"}) {
								$jpool_burden = POSIX::ceil($burdens{"all"} / $category_settings{"judge_per"});
							}

</%perl>
							<div class="row nospace">
								<span class="quarter semibold bluetext padsetting">
									<% $jpool->name %>
								</span>

								<span class="quarter semibold">
									<% $hires ? $hires." entries covered by hires" : "" %>
								</span>

								<span class="fifth semibold">
									<% $jpool_burden ? $jpool_burden." required" : "" %>
									<% $round_burden ? $round_burden." rounds minimum" : "" %>
								</span>

								<span class="fifth semibold <% $jpool_burden > $burdens{"judges"} ? "redtext" : "greentext" %>">
									<%
										$burdens{"judges"}
										? $burdens{"judges"}
										: "0"
									%> provided
								</span>

								<span class="fa fa-lg twentieth centeralign
									<% $jpool_burden > $burdens{"judges"} ? "redtext fa-times-cirlce" : "greentext fa-check" %>
								"></span>
							</div>
%						}
					</span>
				</div>
%			}
<%perl>
			if ($category_settings{"exchange"} ) {

				my @judges = $m->comp(
					"/funclib/exchange_judges.mas",
					category => $category
				);

				if (@judges) {
</%perl>
					<h5 class="martopmore">Hired Judge Exchange</h5>

					<div class="pagefull">
						<div class="even full nospace">
							<span class="threequarters semibold bluetext centeralign bigger">
								<% scalar @judges %> judge<% scalar @judges > 1 ? "s" : "" %>
								can be hired
							</span>

							<span class="quarter leftalign">
								<a
									class="buttonwhite bluetext invert"
									href="hire_exchange.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>">
									Add Hires
								</a>
							</span>
						</div>
					</div>
%				}

%				if (@requests) {
					<h5 class="martopmore">Exchange Hired Judges</h5>
%				}

%				foreach my $request (@requests) {

%					next unless $request->judge;
%					$exchange_hires += $request->rounds_requested;

					<span class="pagehalf odd ltbordertop ltborderbottom">
						<span class="threequarter semibold">
							<span class="spacer"></span>
							Hired <% $request->judge->first." ".$request->judge->last %>
							for <% $request->rounds_requested %>
							rounds
						</span>

%						unless ($hired_deadline_passed) {
							<span class="quarter leftalign padvert">
								<a
									class = "buttonwhite redtext fa fa-lg fa-trash"
									title = "Cancel Hire and Notify Judge"
									href  = "hire_cancel.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&back=roster"
								></a>
							</span>
%						}
					</span>
<%perl>
				}
			}

			if ($category_settings{"track_judge_hires"} ) {

				if ($category_settings{"min_judges"} > scalar @judges) {
</%perl>
					<p class="centeralign semibold martopmuchmore">
						You must supply a minimum of
						<% $category_settings{"min_judges"} %>
						judge(s) before you can hire the rest.
					</p>

%				} elsif ($category_settings{"min_rounds"} > $total_rounds) {
					<p class="centeralign semibold martopmuchmore">
						You must supply a minimum of
						<% $category_settings{"min_rounds"} %>
						rounds of judging before you can hire
						the rest.
					</p>

%				} else {

					<% $category_settings{"min_judges"} %>

%					if ($category_settings{"uncovered_entry_fee"} > 0) {

						<div class="nospace full ltbordertop">
							<span class="half nospace martopmore">
								<h5>Tournament Hired Judging</h5>
							</span>
							<span class="half nospace semibold rightalign italic redtext">
%							if ($category_settings{"cannot_cancel_hires"}) {
								*This tournament does not allow you to cancel accepted hire requests
%							}
							</span>
						</div>

						<table>

%							foreach my $request (@requests) {

%								next if $request->judge;

								<tr class="row">

									<td >
										Request made on <%
											Tab::niceshortdt($request->requested_at->set_time_zone($tz))
										%>
									</td>

									<td class="centeralign greentext semibold">
										<% $request->entries_accepted
											? $request->entries_accepted
											: 0
										%> accepted
									</td>

									<td class="centeralign bluetext semibold">
										<% $request->entries_requested %> requested
									</td>

<%perl>
									my $warn = "This will reduce your judging request by 1.  Are you sure?";

									unless ($hired_deadline_passed
										|| (	$category_settings{"cannot_cancel_hires"}
												&& ($request->entries_accepted > 0)
											)
										|| ($tourn_settings{"ncfl"})
									)  {
</%perl>
										<td class="centeralign">
											<a
												class = "buttonwhite orangetext fa fa-arrow-down fa-sm"
												title = "Reduce request by 1"
												href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
												<& "/funclib/confirm.mas", warn => $warn &>
											></a>
										</td>

%										$warn = "This will delete your judging request entirely. Are you sure?";

										<td class="centeralign">
											<a
												class = "buttonwhite redtext fa fa-trash fa-sm"
												href  = "hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
												<& "/funclib/confirm.mas", warn => $warn &>
											></a>
										</td>

%									} elsif ($category_settings{"cannot_cancel_hires"}) {

										<td class="centeralign padvertmore semibold redtext">
											Hires Accepted; No Cancellation
										</td>

%									} else {

										<td class="centeralign padvertmore semibold redtext">
											Deadline Passed
										</td>
%									}

								</tr>
<%perl>
							}

							unless ($judge_deadline < $now
								|| $category_deadline < $now
								|| $hired_deadline_passed
							) {
</%perl>
								<tr class="row martop">

									<td class="semibold redtext">
										<form
											action = "hire_save.mhtml"
											method = "post"
										>
										<input
											type  = "hidden"
											name  = "school_id"
											value = "<% $school->id %>"
										>
										<input
											type  = "hidden"
											name  = "category_id"
											value = "<% $category->id %>"
										>
										New Hired Judging Request
									</td>

									<td class="centeralign" colspan="2">
										<span class="quarter rightalign padright">
											Cover
										</span>
										<span class="quarter centeralign">
											<input
												type  = "number"
												min   = "0"
												max   = "99"
												name  = "hired_number"
												size  = "4"
												value = ""
											>
										</span>
										<span class="quarter leftalign padright">
											entries
										</span>
									</td>

									<td
										class="centeralign"
										colspan="2">

										<input
											class = "thin"
											type  = "submit"
											value = "Request Hires"
										>

										</form>
									</td>
								</tr>
%							}

						</table>

						<p class="padleftmore">

							This tournament hires judging by the entry, not the
							whole judge.  Enter hire requests for the

							<span class="inline semibold redtext">number of entries who you do not have judging for</span>.

							Please note that a hire request does not mean the
							tournament has judges available for hire; Tabroom will
							email you when/if your request is accepted.
						</p>
<%perl>
					}

					if ($category_settings{"hired_fee"} > 0) {

						my $hires_requested;
						my $hires_accepted;

						foreach my $request (@requests) {
							$hires_requested += $request->entries_requested;
							$hires_accepted += $request->entries_accepted;
						}

						$hires_requested = ceil($hires_requested / $judge_per) if $judge_per;
						$hires_accepted = ceil($hires_accepted / $judge_per) if $judge_per;
</%perl>
						<div class="nospace full ltbordertop">

						<span class="half nospace martopmore">
							<h5>Tournament Hired Judging</h5>
						</span>

						<span class="half nospace semibold rightalign italic redtext">
%							if ($category_settings{"cannot_cancel_hires"}) {
								*This tournament does not allow you to cancel accepted hire requests
%							}
						</span>

						</div>

%						if ($category_settings{"hired_deadline"}) {

							<span class="full bigger centeralign bluetext semibold marvert">
								Requests for hired judging cannot be added or deleted after
								<& "/funclib/showdate.mas",
									dt => $category_settings{"hired_deadline"},
									tz => $tz
								&> at
								<& "/funclib/showtime.mas",
									dt => $category_settings{"hired_deadline"},
									tz => $tz
								&>
							</span>
%						}

						<table>

%						foreach my $request (@requests) {
%							next if $request->judge;

							<tr class="row">

								<td >
									Request made on
									<% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
								</td>

								<td class="centeralign">
									<% $request->entries_accepted && $judge_per
										? ceil($request->entries_accepted / $judge_per)
										: 0
									%> accepted
								</td>

								<td class="centeralign">
									<% ($judge_per
										? ceil($request->entries_requested / $judge_per)
										: $request->entries_requested )
									%> requested
								</td>

<%perl>
								my $warn = "This will reduce your judging request by 1.  Are you sure?";

								unless (
									(
										$category_settings{"hired_deadline"}
										&& $category_settings{"hired_deadline"} < $now
									) || (
										$category_settings{"cannot_cancel_hires"}
										&& ($request->entries_accepted => $request->entries_requested)
									)
								) {
</%perl>

									<td class="centeralign">
										<a  class = "buttonwhite orangetext fa fa-arrow-down fa-sm"
											title = "Reduce request by 1"
											href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>
										></a>
									</td>
<%perl>
								}

								unless (
									(
										$category_settings{"hired_deadline"}
										&& $category_settings{"hired_deadline"} < $now
									) || (
										$category_settings{"cannot_cancel_hires"}
										&& ($request->entries_accepted > 0)
									)
									|| ($tourn_settings{"ncfl"})
								) {


									$warn = "This will delete your judging request entirely. Are you sure?";
</%perl>

									<td class="centeralign">
										<a
											class="redtext buttonwhite fa-trash fa fa-sm"
											href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>
										></a>
									</td>

%								} elsif ($category_settings{"cannot_cancel_hires"}) {

									<td class="centeralign smallish padvertmore semibold redtext">
										Hires Accepted; No Cancellation
									</td>

%								} else {

									<td class="centeralign smallish padvertmore semibold redtext">
										Deadline Passed
									</td>
%								}

							</tr>
<%perl>
						}

						unless (
							$judge_deadline < $now
							|| $category_deadline < $now
							|| ($category_settings{"hired_deadline"}
								&& $category_settings{"hired_deadline"} < $now)
						) {
</%perl>

							<form action="hire_save.mhtml" method="post">

							<input
								type  = "hidden"
								name  = "school_id"
								value = "<% $school->id %>"
							>

							<input
								type  = "hidden"
								name  = "category_id"
								value = "<% $category->id %>"
							>

							<tr class="row martop">

								<td>
									New Request
								</td>

								<td class="centeralign" colspan="2">
									<input
										type  = "number"
										name  = "hired_number"
										min   = "0"
										max   = "99"
										value = "<% $hires_requested %>'"
									>
									hired judges
								</td>

								<td class="centeralign" colspan="2">
									<input
										type  = "submit"
										value = "Save"
									>
									</form>
								</td>
							</tr>
%						}
						</table>
<%perl>
					}
				}

				if ($category_settings{"round_hire_fee"} > 0) {

					my @requests = Tab::JudgeHire->search(
						school   => $school->id,
						category => $category->id
					);

					my $hires_requested;
					my $hires_accepted;

					foreach my $request (@requests) {
						$hires_requested += $request->rounds_requested;
						$hires_accepted += $request->rounds_accepted;
						$total_rounds += $request->rounds_accepted;
					}

</%perl>
					<div class="nospace full ltbordertop martopmore padtopmore">
						<span class="twofifths nospace">
							<h5>Tournament Hired Judging</h5>
						</span>
						<span class="threefifths nospace semibold rightalign italic redtext">
%							if ($category_settings{"cannot_cancel_hires"}) {
								*This tournament does not allow you to cancel accepted hire requests
%							}
						</span>
					</div>

%					if ($category_settings{"hired_deadline"}) {
						<span class="full bigger centeralign bluetext semibold marvert">
							Requests for hired judging cannot be added or deleted after
							<& "/funclib/showdate.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&> at
							<& "/funclib/showtime.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&>
						</span>
%					}

					<table>

%					foreach my $request (@requests) {

%						next if $request->judge;

						<tr class="row">

							<td >
								Request made on
								<% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
							</td>

							<td
								class="centeralign
									<% $request->rounds_accepted < $request->rounds_requested
										? "redtext"
										: ""
								%>">
								<% $request->rounds_accepted %> rounds accepted
							</td>

							<td class="centeralign">
								<% $request->rounds_requested %> rounds requested
							</td>

							<td class="centeralign">
<%perl>
								my $warn = "This will delete your judging request entirely. Are you sure?";

								unless (
									(
										$category_settings{"hired_deadline"}
										&& $category_settings{"hired_deadline"} < $now
									) || (
										$category_settings{"cannot_cancel_hires"}
										&& ($request->rounds_accepted >= $request->rounds_requested)
									)
								) {
</%perl>
									<a
										class = "buttonwhite orangetext fa fa-arrow-down fa-sm"
										title = "Reduce request by 1"
										href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>
									></a>
%								}
							</td>

							<td class="centeralign smallish">
<%perl>
								unless (
									(
										$category_settings{"hired_deadline"}
										&& $category_settings{"hired_deadline"} < $now
									) || (
										$category_settings{"cannot_cancel_hires"}
										&& ($request->rounds_accepted > 0)
									)
								) {
</%perl>
									<a
										class = "redtext buttonwhite fa-trash fa fa-lg"
										href  = "hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>
									></a>
%								} elsif ($category_settings{"cannot_cancel_hires"}) {
									<div class="centeralign smallish padvertmore semibold redtext">
										Hires Accepted; No Cancellation
									</div>
%								}
							</td>
						</tr>
<%perl>
					}

					unless (
						$judge_deadline < $now
						|| $category_deadline < $now
						|| ($category_settings{"hired_deadline"}
							&& $category_settings{"hired_deadline"} < $now)
					) {
</%perl>
		            	<tr class="row martop">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input
									type  = "hidden"
									name  = "school_id"
									value = "<% $school->id %>"
								>
        		        	    <input
									type  = "hidden"
									name  = "category_id"
									value = "<% $category->id %>"
								>
    		            	    New Request
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input
									type  = "number"
									name  = "rounds"
									min   = "0"
									max   = "<% $status{"unc"} %>"
									value = ""
								> rounds
							</td>

                			<td class="centeralign" colspan="2">
                    			<input
									type  = "submit"
									value = "Save"
								>
                			    </form>
            			    </td>
    		        	</tr>
%					}

					</table>
<%perl>
				}
			}
		}

		unless (@show_categories) {
</%perl>
			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}
%		}
	</div>

	<div class="menu">

		<div class="sidenote">

%			if ($tourn_settings{"ncfl"} || $tourn_settings{"mock_trial_registration"}) {

%			} elsif (@free_judges) {

				<h4>Add a Judge!</h4>

				<form
					action = "judge_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>
				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<div class="row centeralign padvert">

					<select
						name             = "chapter_judge_id"
						size             = "7"
						class            = "fixedmost"
						data-placeholder = "Select judge..."
					>

%					foreach my $chapter_judge (@free_judges) {
						<option
							value="<% $chapter_judge->id %>"
						><% $chapter_judge->last.", ".$chapter_judge->first %></option>

%					}
					</select>
				</div>

				<div class="libl rightalign marno">
					<span class="centeralign half">
						<input
							type  = "submit"
							value = "Add Judge"
						>
					</span>
				</div>

				</form>

				<a
					class="yellow full martopmore semibold"
					href="/user/chapter/judge_edit.mhtml?from=<% $category->id %>&chapter_id=<% $school->chapter->id %>">
					Add New Judge to Roster
				</a>

				<div class="centeralign redtext semibold padvert">
					<% $category->abbr %>
					Judging deadline is <% Tab::xmldt($judge_deadline) %>
				</div>

%			} elsif ($deadline) {
				<div class="centeralign redtext semibold">
					Judge deadline was <% Tab::xmldt($category_deadline) %>
				</div>

%			} elsif ($category) {
				<p>
					You have no judges on your roster to add.  Please add
					them before registering them into the tournament.  You
					only need to type in each judge's name to your roster
					once; they'll be available for all future tournaments.
				</p>

				<a
					class="yellow full martopmore semibold"
					href="/user/chapter/judge_edit.mhtml?from=<% $category->id %>&chapter_id=<% $school->chapter->id %>">
					Add Judge to Roster
				</a>
%			}

%			if ($tourn_settings{"ncfl"} || $tourn_settings{"mock_trial_registration"}) {

%			} else {
				<h4>Judge Categories</h4>
<%perl>
				foreach my $ocategory (sort {$a->name cmp $b->name} @categories) {

					my %status;
					my $ocategory_deadline;
					my %ocategory_settings = ();

					if ($tourn_settings{"ncfl"}) {

						$status{"unc"} = scalar ($school->judges(category => $ocategory->id));

					} else {

						my $weekend_id = $ocategory->setting('weekend');

						next if $weekend_id eq "nope";

						next if $weekend_id
							&& $weekends{$weekend_id}{"reg_start"} > $now;

						%ocategory_settings = $ocategory->all_settings();
						$ocategory_deadline = $ocategory_settings{"deadline"};
						my $no_free = $ocategory_settings{"free_strikes_dont_count"};

						$ocategory_deadline->set_time_zone($tz) if $ocategory_deadline;

						($status{"unc"}, $status{"over"}) = $m->comp(
							"/funclib/judgemath/uncovered_burden_by_category.mas",
								school            => $school,
								category_settings => \%ocategory_settings,
								tourn_settings    => \%tourn_settings,
								category          => $ocategory
						);

						@{$status{"category_judges"}} = $school->judges(category => $ocategory->id);

						$status{"obligation"} = $m->comp(
							"/funclib/judgemath/judges_needed_by_category.mas",
								school            => $school,
								category_settings => \%ocategory_settings,
								tourn_settings    => \%tourn_settings,
								category          => $ocategory
						);

						my %stimes_under = $m->comp(
							"/funclib/judgemath/judge_partials_short.mas",
							category          => $ocategory,
							category_settings => \%ocategory_settings,
							tourn_settings    => \%tourn_settings,
							school            => $school
						);

						my $partial_under;

						foreach my $key (keys %stimes_under) {
							$partial_under += $stimes_under{$key};
						}

						my $rounds;

						if ($rounds_per) {
							foreach my $judge (@{$status{"category_judges"}}) {
								$status{"rounds"} += $judge->obligation
									unless $no_free && $judge->setting("free_strike");
							}
						}

						$status{"line_color"} = "odd";

						if ($status{"unc"} > 0) {

							$status{"status_mark"} = "fa fa-lg fa-times-circle-o redtext";
							$status{"text"} = "redtext";
							$status{"title"} = "You have not met obligation in this judge category";

						} elsif ($partial_under > 0) {

							$status{"status_mark"} = "fa redtext fa-exclamation-triangle";
							$status{"text"} = "redtext";
							$status{"title"} = "You are short of obligation in some time blocks in this category";

						} else {

							$status{"status_mark"} = "fa fa-check-circle greentext";
							$status{"text"} = "greentext";
							$status{"title"} = "Obligation met";
						}

						if ($ocategory == $category) {
							$status{"line_color"} = "even";
						}
					}

					my $name = $ocategory->name;

					$name =~ s/\(/<span class='full smallish graytext'>/g;
					$name =~ s/\)/<\/span>/g;
</%perl>

					<a
						class="<% $status{"line_color"} %> full grayhover white marno ltborderbottom"
						href="judges.mhtml?school_id=<% $school->id %>&category_id=<% $ocategory->id %>"
						title="<% $status{"title"} %>"
					>

						<span class="nowrap threefifths semibold biggish <% $status{"text"} %>">
							<% $name %>
						</span>

						<span class="threetenths nospace biggish semibold <% $status{"text"} %>">
%							if ($status{"obligation"}) {

								<% $status{"rounds"} ? $status{"rounds"} : scalar @{$status{"category_judges"}} %>/<% $status{"obligation"} %>

								<% $status{"rounds"} ?
										( $status{"unc"} < 1
											&& ($status{"rounds"} && $status{"rounds"} < $status{"obligation"}) )
											? "+ ".$exchange_hires." hired"
											: ""
									: ($status{"unc"} < 1 && $status{"obligation"} > 0 && (scalar @{$status{"category_judges"}} < $status{"obligation"}))
										? "+ ".$exchange_hires." hired"
										: ""
									%>
%							} else {
								<% $status{"unc"} %>
%							}
						</span>

						<span class="tenth rightalign <% $status{"status_mark"} %>">
						</span>
					</a>

%					if ($ocategory_deadline) {

						<a
							href="/user/tourn/entry/judges.mhtml?school_id=<% $school->id %>&category_id=<% $ocategory->id %>"
							class="white"
						>
							**<% $ocategory->abbr %>
							Judges due:
							<% &Tab::niceshortdt($ocategory_deadline->set_time_zone($tz)) %>
						</a>

%					}
%				}
%			}

		</div>
	</div>
