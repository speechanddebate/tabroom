<%args>
	$school
	$group_id => undef 
	$account
	$prefs => undef
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;
	my $tourn = $school->tourn;

	use POSIX;
	my $now = DateTime->now;

    my %rating_name = (); 
    foreach my $tier ($group->rating_tiers) { 
        $rating_name{$tier->id} = $tier->name;
    }   
    my %rating_by_judge = (); 
    foreach my $rating ($m->comp("/funclib/group_ratings.mas", group => $group, type => "coach")) { 
        $rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id};
    }   

	my @judges = Tab::Judge->search( judge_group => $group->id, active => 1 );
	@judges = sort {$a->last cmp $b->last} @judges;
	@judges = sort {$a->school->name cmp $b->school->name} @judges;

	my %conflicts_by_id = ();
	my @school_conflicts = $m->comp("/funclib/school_conflicts.mas", school => $school, group => $group);
	foreach (@school_conflicts) { 
		$conflicts_by_id{$_->judge->id} = $_; 
	}

	my $bank = $group->setting("school_strikes");

	my %strikes_by_id = ();
	my @school_strikes = $m->comp("/funclib/school_strikes.mas", school => $school, group => $group);
	foreach (@school_strikes) { 
		$strikes_by_id{$_->judge->id} = $_; 
		$bank--;
	}

	@judges = sort { $strikes_by_id{$b->id} <=> $strikes_by_id{$a->id} } @judges;
	my $switch;

</%init>

	<& /funclib/tablesorter.mas, table => "strikes" &>

    <div class="right small">

		<& sidebar.mas, school => $school, whoami => "school_strikes", nodiv => 1, group_id => $group->id &>

	</div>

	<div class="left huge">

%		unless ($prefs) {
			<h2><% $school->name %> at the <% $tourn->name %></h2>
			<& ../menubar.mas, school => $school, whoami => "ratings" &>
%		}


		<span class="bigspan inline" style="font-size: 100%">  
			<h4>School-wide Strikes in <% $group->abbr %></h4>
		</span>

		<span class="medspan inline rightalign" style="float: right;">
			<h5>Limit: <% $group->setting("school_strikes") %></h5>
		</span>

		<table cellpadding="4" width="100%" id="strikes">

			<thead>

				<tr class="yellowrow">

					<th>
						First
					</th>

					<th>
						Last
					</th>
	
					<th>
						School
					</th>

%					if ($group->setting("coach_ratings")) { 
						<th>
							Exp
						</th>
%					}

%					if ($group->strike_times) {
						<th>
							Constraints 
						</th>
%					}

					<th>
						Strike
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $judge (@judges) {

%					next if $judge->school && $judge->school->id == $school->id;
%					next if $conflicts_by_id{$judge->id};

%					if ($strikes_by_id{$judge->id}) { 
						<tr <% ($switch++ % 2) ? "class=\"yellowrow\"" : "class=\"yellow\"" %>>
%					} else { 
						<tr>
%					}

						<td class="smallish">
%							if ($judge->account && $judge->account->paradigm) { 
								<a class="white block" href="/index/paradigm.mhtml?account_id=<% $judge->account->id %>" targe="_blank">
%							} else { 
								<a class="white block" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
%							} 
								<% $judge->first %>
							</a>
						</td>

						<td class="smallish">
%							if ($judge->account && $judge->account->paradigm) { 
								<a class="white block" href="/index/paradigm.mhtml?account_id=<% $judge->account->id %>" targe="_blank">
%							} else { 
								<a class="white block" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
%							} 
								<% $judge->last %>
							</a>
						</td>
				
						<td class="smaller">
							<span class="medspan nowrap">
							<% ($judge->school->id) ? $judge->school->short_name." ".$judge->school->chapter->state : "Hire" %>
							</span>
						</td>

%						if ($group->setting("coach_ratings")) { 
							<td class="smaller centeralign">
								<% $rating_by_judge{$judge->id} %>
							</td>
%						}
				
%						if ($group->strike_times) {
							<td class="smaller">
%								foreach my $strike_time ($group->strike_times) { 
									<span class="medspan nowrap block padless">
									<% ($strike_time->strike($judge)) ? "No rounds ".$strike_time->name : "" %>
									</span>
%								}
							</td>
%						}

						<td align="center">

%							if ($conflicts_by_id{$judge->id}) { 
								<a class="noblock">Conflict</a>
%							} else { 

%								if ($bank || $strikes_by_id{$judge->id}) { 
									<a class="<% $strikes_by_id{$judge->id} ? "dkred" : "dkgreen" %> block" 
										href="school_strike_switch.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>&group_id=<% $group->id %>">
										<% ($strikes_by_id{$judge->id}) ? "Unstrike" : "Steee-rike!" %>
%								}

								</a>
%							}
						</td>

					</tr>	

%				}	
				
			</tbody>

		</table>

	</div>

