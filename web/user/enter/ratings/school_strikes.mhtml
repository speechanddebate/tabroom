<%args>
	$school
	$group_id => undef 
	$account
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;
	my $tourn = $school->tournament;

	use POSIX;
	my $now = DateTime->now;
	
</%init>

	<h2><% $school->name %> at the <% $tourn->name %></h2>

	<& /user/tourn/entry/menubar.mas, school => $school, whoami => "ratings" &>

    <div class="right small">

		<& sidebar.mas, school => $school, whoami => "school_strikes" &>

		<br />

		<h5>Limit: <% $group->school_strikes %> Strikes </h5>

	</div>

	<div class="left huge">

		<h3>Strikes for <% $school->name %> </h3>

<%perl>

			my @judges = Tab::Judge->search( judge_group => $group->id, active => 1 );
			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->name cmp $b->school->name} @judges;

			my @conflicts = $school->conflicts;
			my %conflicts_by_id = ();
			foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }
	
			my @strikes = $school->strikes;
			my %strikes_by_id = ();

			my $bank = $group->school_strikes;

			foreach (@strikes) { 
				$strikes_by_id{$_->judge->id} = $_; 
				$bank--;
			}

			@judges = sort { $strikes_by_id{$b->id} <=> $strikes_by_id{$a->id} } @judges;

			my $switch;

</%perl>

			<table cellpadding="4" width="100%">

				<tr class="liblrow">

					<th>
						Judge
					</th>
	
					<th>
						School
					</th>

%					if ($group->coach_ratings) { 
						<th>
							Exp
						</th>
%					}

					<th>
						Notes
					</th>

%					if ($group->bins) {
						<th>
							Constraints 
						</th>
%					}

					<th>
						Strike
					</th>

				</tr>

%				foreach my $judge (@judges) {

%					next if $judge->school && $judge->school->id == $school->id;

%					if ($strikes_by_id{$judge->id}) { 
		
						<tr <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>

%					} elsif ($conflicts_by_id{$judge->id}) { 
						
						<tr class="yellowrow">

%					} else { 

						<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%					}

					<td>
						<a class="white block" href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
							<% $judge->first." ".$judge->last %>
						</a>
		
					</td>
				
					<td class="smaller">
						<% ($judge->school->id) ? $judge->school->name.", ".$judge->school->chapter->state : "Hire" %>
					</td>

%					if ($group->coach_ratings) { 
						<td class="smallctr">
							<% $judge->print_ratings %>
						</td>
%					}
				
					<td>
						<% $judge->special %>
					</td>

%					if ($group->bins) {

						<td class="smaller">
%							foreach my $bin ($group->bins) { 
								<% ($bin->strike($judge)) ? "No rounds ".$bin->name : "" %>
%							}
						</td>

%					}

					<td align="center">

%						if ($conflicts_by_id{$judge->id}) { 

							<a class="noblock">Conflict</a>

%						} else { 

							<a class="white block" 
								href="school_strike_switch.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>&group_id=<% $group->id %>">
								<% ($strikes_by_id{$judge->id}) ? "Unstrike" : ($bank) ? "Steee-rike!" : "" %>
							</a>

%						}

					</td>

					</tr>	

%			}	

		</table>

	</div>

