<%args>
	$school
	$group_id => undef 
	$entry_id => undef
	$account
	$prefs => undef
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;
	my $tourn = $school->tourn;
	my %ratings_by_judge = ();
	my %conflicts_by_id = ();

	my @judges;

	use POSIX;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$group = $entry->event->judge_group unless $group;

	my $now = DateTime->now;
	my $switch;

    my %rating_name = (); 
    foreach my $tier ($group->rating_tiers) { 
        $rating_name{$tier->id} = $tier->name;
    }   

	my $coach_ratings = $group->setting("coach_ratings");

    my %coach_rating_by_judge = (); 
    foreach my $rating ($m->comp("/funclib/group_ratings.mas", group => $group, type => "coach")) { 
		next unless $rating->rating_tier;
        $coach_rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id};
    }   

</%init>

	<div class="left huge">

%		unless ($prefs) {
			<h2><% $school->short_name %> at the <% $tourn->name %></h2>
			<& /user/enter/menubar.mas, school => $school, whoami => "ratings" &>
%		}

%		unless ($entry) { 

			<h3>Judge Ratings in <% $group->name %> </h3>
			<p>Choose an entry at right to continue</p>

%		} else { 

<%perl>
			@judges = Tab::Judge->search( judge_group => $group->id, active => 1 );
			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->short_name cmp $b->school->short_name} @judges;

			my @conflicts = $m->comp("/funclib/entry_conflicts.mas", entry => $entry);
			foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

			my @sch_conflicts = $m->comp("/funclib/school_conflicts.mas", school => $school);
			foreach (@sch_conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

			my %ordinal_by_judge = ();

			my @ratings = Tab::Rating->search( entry => $entry->id, type => "entry");

			foreach my $rating (@ratings) {
				$ratings_by_judge{$rating->judge->id} = $rating;
				$ordinal_by_judge{$rating->judge->id} = $rating->ordinal if $rating;
			}

			@judges = sort { $ordinal_by_judge{$a->id} <=> $ordinal_by_judge{$b->id} } @judges;

</%perl>

			<script>
				$(function(prefs) {

					$( "#prefsort" ).disableSelection();

					$( "#prefsort" ).sortable({
						connectWith      : "ul",
						scroll           : "true",
						disableSelection : "true",
						opacity          : 0.6,
						revert           : "true",
						placeholder      : "ui-state-highlight",
						axis             : "y",
						update			: function(event, ui) { 
							$('#sortorder').val($(this).sortable('serialize'));
						},
						stop             : function(event, ui) {
							ui.item.removeClass("ui-state-default");
							ui.item.toggleClass("ui-state-changed");
							$('#subme').removeClass("hidden");
							$('#submoi').removeClass("hidden");
						}

					});

					return false;
				});

			</script>

			<span class="hugespan nowrap">
				<h4>Rate <% $group->abbr %> Judges for <% $entry->name %></h4>
			</span>

			<span class="hundo namespan right" style="margin-top: 8px;">
				<a class="dkgrey block centeralign" href="ordinals_prefs.mhtml?entry_id=<% $entry_id %>&school_id=<% $entry->school->id %>">
					Numeric
				</a>
			</span>

			<br class="clear" />

			<form action="ordinals_sort_save.mhtml" method="post">
				<input type="hidden" name="entry_id" value="<% $entry->id %>">
				<input type="hidden" name="school_id" value="<% $entry->school->id %>">
				<input type="hidden" name="sortorder" id="sortorder">
			<div>

				<ul id="prefsort" class="prefs">

%					foreach my $judge (@judges) { 

%						next if $judge->school->id == $entry->school->id;
%						next if $conflicts_by_id{$judge->id};

						<li class="ui-state-default " id="judge_<% $judge->id %>">

							<span class="tinyspan smaller left" style="font-size: 75%;">
								<%  $ordinal_by_judge{$judge->id} ? $ordinal_by_judge{$judge->id} : "0" %>
							</span>

							<span class="ui-icon ui-icon-arrowthick-2-n-s sortarrow left"></span>

							<span class="medbigspan smaller left">
								<% $judge->first." ".$judge->last %>
							</span>

							<span class="tinyspan smaller left" style="font-size: 75%;">
%								if ($coach_ratings) {
									<% $coach_rating_by_judge{$judge->id} %>
%								}
							</span>

							<span class="medbigspan smaller left">
								<% ($judge->school && $judge->school->id) ? $judge->school->short_name." ".$judge->school->chapter->state : "Hire "%>
							</span>

							<span class="tinyspan smaller left" style="font-size: 75%; margin-left: 5px;">
								<% $judge->obligation + $judge->hired ? $judge->obligation + $judge->hired : "6" %> 
							</span>


						</li>

%					}

				</ul>

			</div>

			<div class="block liblrow rightalign hidden" id="submoi">
				<input type="submit" value=" Save Prefs Order " class="thin">
			</div>

%		}

		</div>

    <div class="right small">

		<& sidebar.mas, 
			school => $school, whoami => "entry_ratings", ajaxify => "whee",
			group_id => $group->id, entry_id => $entry_id,  nodiv => 1 &>

%		if ($entry && scalar $m->comp('/funclib/group_entries.mas', group => $group, school => $entry->school)) {
			
			<div class="sidenote hidden" id="subme">
				<h4>Save Prefs</h4>

				<span class="centeralign greynohover block">
					<input type="submit" value="Save Pref Changes" class="thin">
					</form>
				</span>
			</div>

			<div class="sidenote">

				<h4>Dolly the Sheep</h4>

				<p>Clone these prefs onto:</p>

				<span class="grey block" style="padding-left: 2px; padding-right: 2px;">
					<form action="clone.mhtml" method="post">
					<input type="hidden" name="clone_id" value="<% $entry->id %>">
					<input type="hidden" name="school_id" value="<% $entry->school->id %>">

					<select name="entry_id" class="fixedsmall">
%						foreach my $other ($m->comp('/funclib/group_entries.mas', group => $group, school => $entry->school)) { 
%							next if $entry->id == $other->id;
%							next if $entry->dropped;
							<option value="<% $other->id %>"><% $other->name %></option>
%						}
					</select>

					<input type="submit" class="thin" value="Go" style="padding-left: 2px; padding-right: 2px;">
				</span>

			</div>
%		}

	</div>
