<%args>
	$account
	$school
</%args>
<%init>

	use POSIX;

	my $tourn = $school->tourn;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
    my $now = DateTime->now(time_zone => $tz);

	my $adult;

	$adult++ if ($school->contact_number && $school->contact_name);
	$adult++ unless $tourn->setting("require_adult_contact");

	my $payup++ if $tourn->setting("onsite_only_paid");
	my $deadbeat;

	if ($payup) { 

		my ($fee, $feline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school->id);
		$deadbeat = $fee - $school->paid;

		if ($deadbeat > 0) { 
			$deadbeat = sprintf ("%.2f", $deadbeat);
			my $symbol = $tourn->setting('currency');
			$symbol = '$' unless $symbol;
			$deadbeat = $symbol.$deadbeat;
		} else { 
			undef $deadbeat; 
		}

	}

	unless ($adult) { 
		my $err = "You may not register online without the name of a responsible adult listed";
		$m->redirect("onsite.mhtml?school_id=<% $school->id %>&err=$err");
	}

	if ($deadbeat) { 
		my $err = "You may not register online due to your outstanding balance of $deadbeat";
		$m->redirect("onsite.mhtml?school_id=<% $school->id %>&err=$err");
	}

	$school->registered(1);
	$school->registered_on($now);
	$school->registered_by($account->id);
	$school->update;

	my $msg = "You have confirmed your registration.  Thank you!  You're awesome!";
	$m->redirect("onsite.mhtml?school_id=".$school->id."&msg=$msg");

</%init>

