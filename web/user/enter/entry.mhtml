<%args>
	$person
	$session
	$school
	$tourn
	$dbh
	$disclaimed => undef
</%args>
<%init>

	my %ts = $tourn->all_settings;
	my $tourn_settings = \%ts;


	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);
	my $year = $tourn->start->year;

	my %school_settings = $school->all_settings();
	my $chapter = $school->chapter;

	if ($tourn_settings->{"disclaimer"}) {
		if ($disclaimed) {
			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);
			$school_settings{"disclaimed"} = $person->id;
		} elsif ($school_settings{"disclaimed"}) {
		} else {
			$m->redirect("disclaimer.mhtml?school_id=".$school->id)
		}
	}

   my (@fees) = $m->comp("/funclib/school_fees.mas",
	   school   => $school,
	   all      => 1
   );

   my ($due, $fees, $totals, @junque) = @fees;

	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas",
		school => $school
	);

	my $nsda_chapter;
	my %reasons;

	# Update the NSDA stuff
	if ($tourn_settings->{"nsda_district"} || $tourn_settings->{"nsda_nats"}) {

		my $then = $now->clone();
		$then->subtract(days => 7);

		if ($ARGS{"nats_refresh"} || $school_settings{nats_refresh} < $then) {

			$school->setting('nats_refresh', "date", $now);

			$nsda_chapter = $m->comp("/funclib/nsda/chapter_sync.mas",
				chapter      => $chapter,
				chapter_data => 'yaskween'
			);

			if ($tourn_settings->{nsda_nats}) {
				$m->comp("/funclib/nsda/nats_appearances.mas", tourn => $tourn);
			}
		}
	}

	if ($tourn_settings->{"nsda_nats"}) {
		%reasons = $m->comp("/funclib/nsda/school_status_data.mas", school => $school, check => 1);
	}

	my $adult;
	my $no_adult;

	if ($tourn_settings->{"require_adult_contact"}) {
		if ($tourn_settings->{"account_contacts"}) {

			$no_adult = $m->comp("/funclib/contacts.mas",
				school         => $school,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				nsdacheck      => $tourn_settings->{nsda_nats},
				check          => 1
			);

			if ($no_adult) {

			} else {
				$adult++;
			}

		} else {

			$adult++ if (
				$school_settings{"contact_number"}
				&& $school_settings{"contact_name"}
				&& $school_settings{"contact_email"}
			);
		}
	} else {
		$adult++;
	}

	my $supp_team;
	my %sites_by_id;

	if ($tourn_settings->{"supp_team_show_coaches"}) {
		my $supp_teams = $tourn_settings->{supp_teams};
		$supp_team = $supp_teams->{$school_settings{"supp_team"}};
		%sites_by_id = map {$_->id => $_} $tourn->sites;
	}

	my $cat_warnings = $m->comp("check_empties.mas",
		school => $school,
		dbh    => $dbh
	);

</%init>

	<div class="main">

		<& "tabbar.mas",
			school         => $school,
			whoami         => "tourn",
			adult_check    => $adult ? "yup" : "nopesauce",
			tourn_settings => $tourn_settings,
			reasons        => \%reasons
		&>

%		if ($no_adult) {

			<h5 class="redtext">
				Contact Information Incomplete
			</h5>

			<div class="full padmore centeralign">
				<span class="ninetenths leftalign redborderbottom">
					<p class="semibold">
						This tournament requires your adult contact/coaching
						information be correct before you may register entries and/or
						judging. Please correct the issues below and you will be able
						to proceed.
					</p>
				</span>
			</div>
%		}

%		if ($tourn_settings->{"require_hotel_confirmation"} && (not defined $school_settings{hotel_confirmation})) {
			<h5 class="redtext">
				Hotel Confirmation Number Required
			</h5>

			<div class="full padmore centeralign">
				<span class="ninetenths leftalign redborderbottom">
					<p class="semibold">
						This tournament requires you designate which hotel you
						are using, and provide (one of) your hotel confirmation
						number(s), before you may register entries and/or
						judging.  Please supply this information below, and you will
						be able to proceed.
					</p>
				</span>
			</div>
%		}

%		if ($tourn_settings->{"registration_message"}) {
			<div class="full padmore centeralign">
				<span class="ninetenths leftalign">
					<% $tourn_settings->{"registration_message"} %>
				</span>
			</div>
%		}

%		if ($tourn_settings->{"nsda_nats"} && (scalar ($school->entries(active => 1)) < 1 )) {

			<script>
				function checkPermareject() {
					if ($("#confirm_permareject").prop("checked")) {
						$(".permareject").removeClass('graytext');
						$(".permareject").addClass('redtext');
						$(".permareject").prop("disabled", false);
					} else {
						$(".permareject").addClass('graytext');
						$(".permareject").removeClass('redtext');
						$(".permareject").prop("disabled", true);
					}
				}

			</script>

			<div class="centeralign martopmore">

				<form
					action = "nats/permareject.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<h5 class="leftalign">
					Cannot attend nationals?
				</h5>
				<span class="bluebordertop leftalign padvertmore ninetenths">

					<p class="padleft padright">
						If your school cannot attend Nationals at all this
						year, you may reject all your current entries here.  In
						addition, this function will mark all your entries at
						Districts as ineligible for promotion to Nationals as
						alternates.
					</p>

					<div class="odd ltbordertop ltborderbottom padvert">
						<span class="seveneighths centeralign biggish semibold redtext italic">
							You confirm that you are dropping all CURRENT and reject all FUTURE nationals entries:
						</span>
						<span class="eighth centeralign">
							<input
								type    = "checkbox"
								class   = "notfirst"
								id      = "confirm_permareject"
								onClick = "checkPermareject();"
								value   = 1
							>
						</span>
					</div>

					<div class="even rightalign marvertno padvertless">
						<span class="half centeralign nospace padvert">
							<input
								type  = "submit"
								class = 'graytext permareject'
								disabled
								value = "Decline All"
							>
						</span>
					</div>
				</span>
				</form>
			</div>
%		}

%		unless ($tourn_settings->{"ncfl"}) {

%			if (@empties) {
				<div class="centeralign nospace">
					<span class="bluetext warnbox centeralign padvertmore ninetenths">
						<p class='bigger semibold'>
							There are no individual competitors assigned to the following entries:
						</p>

%						foreach my $empty (@empties) {
							<div class="full centeralign">
								<a
									href="/user/enter/details.mhtml?school_id=<% $school->id %>&entry_id=<% $empty->id %>"
									class="buttonwhite redtext invert"
								>
									<% $empty->code %> in <% $empty->event->abbr %>
								</a>
							</div>
%						}

						<p class='bigger semibold'>
							Please assign competitors to these entries or they will not advance or receive points.
						</p>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"nsda_nats"}) {

				<& "/funclib/nsda/school_status.mas",
					tourn          => $tourn,
					tourn_settings => $tourn_settings,
					school         => $school,
					status         => \%reasons
				&>
%			}


%			if ($tourn_settings->{"account_contacts"}) {

				<h5 class="padtopmore">
					Your Coaches &amp; Contacts
				</h5>

				<div class="martop full explain padleft centeralign">
%					if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {
						<div class="full nospace padbottom ninetenths leftalign">
						Coaches listed below will be listed on your
						school's online tournament book listing.
%					}

%					if ($tourn_settings->{"nsda_nats"}) {
						Coaches must be listed here to be listed as
						the coach of record for merit points.
						</div>
%					} elsif ($tourn_settings->{"nsda_ms_nats"}) {
						</div>
%					}

%					if ($tourn_settings->{"require_adult_contact"}) {
						<div class="full padbottom nospace ninetenths leftalign">
							At least one email receiving, on-site, official contact
							must be listed to proceed with your registration.

%							if ($tourn_settings->{second_adult_contact}) {
								This tournament also requires a backup
								official coach contact, who does not need
								to be onsite or get emails, but must have a phone listed.
%							}
						</div>
						<div class="full padbottom nospace ninetenths leftalign">
							Only coaches listed as email contacts below
							will get emails about this tournament.
						</div>
%					}
				</div>

				<p
					id    = "contact_errors"
					class = "biggish centeralign redtext semibold"
				>
					<% $no_adult %>
				</p>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign nospace">
						<div class="nospace full bluebordertop">
						</div>

						<& "/funclib/contacts.mas",
							tourn          => $tourn,
							tourn_settings => $tourn_settings,
							school         => $school,
							add            => 1
						&>
					</span>
				</div>

<%doc>
				has to live here to avoid clash with add above
</%doc>
				<form
					action  = "contact_save.mhtml"
					enctype = "multipart/form-data"
					method  = "post"
				>
				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

%			} else {

				<form
					action  = "contact_save.mhtml"
					enctype = "multipart/form-data"
					method  = "post"
				>
				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<div class="full nospace martopmuchmore marbottom">
					<span class="half nospace">
						<h5 class="nospace">
							Tournament Adult Contact Information
						</h5>
					</span>

					<span class="half rightalign semibold italic redtext">
%						if (not defined $adult) {
							An adult contact is required before you can continue with
							registration.
%						}
					</span>
				</div>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign">

						<div class="yellowrow smallish semibold marno padvertless bluebordertop nospace">
							<span class='tenth marno centeralign'>
							</span>

							<span class='threetenths'>
								Name
							</span>

							<span class='threetenths'>
								Email
							</span>

							<span class='fifth'>
								Phone
							</span>
						</div>

						<div class="row">

							<span class="eighth semibold bluetext marno centeralign padno">
%							if ($tourn_settings->{"category_adult_contact"}) {
								Overall
%							} elsif ($tourn_settings->{"second_adult_contact"}) {
								Primary
%							}
							</span>

							<span class="threetenths">
								<input
									size  = "24"
									type  = "text"
									name  = "contact_name"
									class = "notfirst"
									value = "<% $school_settings{"contact_name"} %>"
								>
							</span>

							<span class="threetenths">
								<input
									size  = "24"
									type  = "email"
									name  = "contact_email"
									class = "notfirst"
									value = "<% $school_settings{"contact_email"} %>"
								>
							</span>

							<span class="fifth">
								<input
									size  = "18"
									type  = "tel"
									name  = "contact_number"
									class = "notfirst"
									value = "<% Tab::phone($school_settings{"contact_number"}) %>"
								>
							</span>

						</div>

%						if ($tourn_settings->{"second_adult_contact"}) {
							<div class="row">
								<span class="eighth semibold bluetext marno centeralign padno">
									Backup
								</span>

								<span class="threetenths">
									<input
										size  = "24"
										type  = "text"
										name  = "second_contact_name"
										class = "notfirst"
										value = "<% $school_settings{"second_contact_name"} %>"
									>
								</span>

								<span class="threetenths">
									<input
										size  = "24"
										type  = "email"
										name  = "second_contact_email"
										class = "notfirst"
										value = "<% $school_settings{"second_contact_email"} %>"
									>
								</span>

								<span class="fifth">
									<input
										size  = "18"
										type  = "tel"
										name  = "second_contact_number"
										class = "notfirst"
										value = "<% Tab::phone($school_settings{"second_contact_number"}) %>"
									>
								</span>

							</div>
%						}
<%perl>
						if ($tourn_settings->{"category_adult_contact"}) {

							my %contacts = eval{
								return %{JSON::decode_json($school_settings{'category_contacts'})};
							};

							foreach my $category ($m->comp("/funclib/school_categories.mas", school => $school)) {
</%perl>
								<div class="row">
									<span class="eighth semibold bluetext marno centeralign padno">
										<% $category->abbr %>
									</span>

									<span class="threetenths">
										<input
											type  = "text"
											name  = "<% $category->id %>_name"
											size  = "24"
											value = "<% $contacts{$category->id}{"name"} %>"
										>
									</span>

									<span class="threetenths">
										<input
											type  = "email"
											name  = "<% $category->id %>_email"
											size  = "24"
											value = "<% $contacts{$category->id}{"email"} %>"
										>
									</span>

									<span class="fifth">
										<input
											type  = "tel"
											name  = "<% $category->id %>_phone"
											size  = "18"
											value = "<% Tab::phone($contacts{$category->id}{"phone"}) %>"
										>
									</span>
								</div>
%							}
%						}

						<div class="libl rightalign marvertno padvertless padrightmore">
							<span class="third centeralign nospace">
								<input
									type  = "submit"
									value = "Save Contacts"
								>
							</span>
						</div>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"nsda_nats"}) {

				<div class="martopmore full">
					<span class="third nospace">
						<h5>Your Institution Name</h5>
					</span>
					<span class="twothirds explain rightalign">
						The official name by which your school will be
						announced at awards, recognized on results, <br />and
						appears on your name badges and tournament book page.
					</span>
				</div>

				<div class="centeralign nospace">
					<span class="ninetenths centeralign nospace bluebordertop odd">
						<span class="halfspacer"></span>
						<div class="nospace fourfifths padvertmore leftalign">
							<input
								type  = "text"
								class = "notfirst"
								name  = "school_name"
								value = "<% $school->name %>"
								size  = "64"
							>
						</div>
						<span class="tenth">
							<input
								type  = "submit"
								value = "Save"
							>
						</span>
					</span>

				</div>
%			}

%			if ($tourn_settings->{"ask_regions"}) {

				<span class="third nospace">
					<h5 class="martopmore">
						<% $tourn_settings->{"region_label"} || "Region/League" %>
					</h5>
				</span>

				<span class="twothirds nospace rightalign redtext semibold italic padtop martop">
					You cannot proceed with registration until you have chosen your
					correct <% $tourn_settings->{"region_label"} || "region or league" %>
					below.
				</span>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign bluebordertop nospace">
						<div class="row padvertmore">
							<span class="third semibold">
								<span class="halfspacer"></span>
								Your <% $tourn_settings->{"region_label"}
									? $tourn_settings->{"region_label"}
									: "Region/League"
								%> (Required)
							</span>

							<span class="half">

								<select
									name  = "region_id"
									class = "fixedmost notfirst"
								>
									<option value="">Please choose one:</option>
<%perl>
									foreach my $region (
										$m->comp("/funclib/tourn_regions.mas",
											tourn   => $tourn,
											circuit => $tourn_settings->{"region_circuit"}
										)
									) {
</%perl>
										<option
											value="<% $region->id %>"
											<% $region->id == $school->region
												? 'selected="selected"'
												: ""
											%>
										><% $region->name %></option>
%									}
								</select>
							</span>
							<span class="sixth centeralign">
								<input
									type  = "submit"
									class = "notfirst"
									value = "Save"
								>
							</span>
						</div>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"school_upload"}) {

				<h5 class="martopmore">
					Upload
				</h5>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign bluebordertop nospace">
						<p class="biggish"><% $tourn_settings->{"school_upload_text"} %></p>

%						if ($school_settings{"upload_file"}) {
							<div class="row">
								<span class="threequarters semibold">
									<span class="spacer"></span>
									Existing file
									(uploaded on <& "/funclib/showdt.mas",
										dt     => $school_settings{"upload_file_timestamp"},
										format => "murica"
									&>)
								</span>
								<span class="quarter">
									<a
										href   = "<% $Tab::s3_url %>/<% $tourn->id."/school_upload/".$school->id."/".$school_settings{"upload_file"} %>"
										class  = "bluetext link-underline"
										title  = "Uploaded file"
									><% $school_settings{"upload_file"} %></a>
								</span>
							</div>
%						}

						<div class="row padvertmore">
							<span class="spacer"></span>
							<& "/funclib/uploader.mas",
								filename => "school_upload",
								session  => $session,
								ratio    => "quarter",
								save     => "me"
							&>
						</div>
					</span>
				</div>
%			}
<%perl>
			if ($tourn_settings->{"nsda_nats"} && (not defined $tourn_settings->{'account_contacts'})) {

				my $coachref = $school->setting("tbook_coach_ids");

				my %extra_coaches = eval {
					return %{$coachref};
				};

				my $person_id = $person->id;
				undef $person;

				my $tbook_sth = $dbh->prepare("
					select distinct person.id, person.first, person.middle, person.last, person.email,
						GROUP_CONCAT(distinct(entry.name)) entry,
						diamonds.value diamonds
					from (person, entry, entry_setting coach)
						left join person_setting diamonds
							on diamonds.tag = 'diamonds'
							and diamonds.person = person.id
					where entry.school  = ?
						and entry.id    = coach.entry
						and coach.tag   = 'coach_points'
						and coach.value = person.nsda
					group by person.nsda
					order by person.last
				");

				$tbook_sth->execute($school->id);

				my $results = $tbook_sth->fetchall_hash();
				my %coaches = map { $_->{"id"} => $_ } @{$results};

				my $notfirst;
				my %potentials;

				my $coach_sth = $dbh->prepare("
					select person.id, person.first, person.last, person.nsda
						from person, permission
					where person.id = permission.person
						and permission.chapter = ?
				");

				$coach_sth->execute($chapter->id);

				my $potential_ref = $coach_sth->fetchall_hash();

				my %one_potentials = map {$_->{id} => $_} @{$potential_ref} if $potential_ref;

				my @nsda_coaches = $m->comp("/funclib/nsda/coaches.mas", school => $school);

				my $judge_sth = $dbh->prepare("
					select person.id, person.first, person.last, person.nsda
					from person, chapter_judge
					where person.id = chapter_judge.person
						and chapter_judge.chapter = ?
						and chapter_judge.retired = 0
						and person.nsda > 0
					order by person.last, person.id
				");

				$judge_sth->execute($chapter->id);

				my $judge_ref = $judge_sth->fetchall_hash();

				my %more_potentials = map {$_->{id} => $_} @{$judge_ref} if $judge_ref;

				%potentials = (%one_potentials, %more_potentials);
</%perl>
				<h5 class="martopmore">
					Coach Credits
				</h5>

				<div class="centeralign nospace">

					<span class="ninetenths centeralign bluebordertop nospace">

						<p class="leftalign nineteen padvert">
							Coaches receiving points for any entry will
							automatically be listed on your school's online roster.
							Select additional coaches who should be listed for
							credit below.
						</p>
<%perl>
						my $counter = 1;

						foreach my $id (sort {$coaches{$a}{"last"} cmp $coaches{$b}{"last"}} keys %coaches) {

							next unless $coaches{$id}{"last"};

							delete $potentials{$id};
							my $coach_entry = $coaches{$id}{"entry"};
							$coach_entry =~ s/,/, /g;
</%perl>
							<div class="<% $notfirst++ ? "ltbordertop" : "" %> padvertless marno row leftalign flexrow">
								<span class="twenty semibold centeralign">
									<% $counter++ %>
								</span>
								<span class="third">
									<% $coaches{$id}{"first"}." ".$coaches{$id}{"last"} %>
								</span>

								<span class="tenth centeralign" title="Diamonds">
%									foreach (1 .. $coaches{$id}{"diamonds"}) {
%										$m->print("*");
%									}
								</span>
								<span class="fifth smallish bluetext semibold">
									Listed as coach for
								</span>
								<span class="twofifths smallish">
									<% $coach_entry %>
								</span>
							</div>
<%perl>
						}

						foreach my $id (sort {$extra_coaches{$a}{"last"} cmp $extra_coaches{$b}{"last"}} keys %extra_coaches) {

							next if $coaches{$id};
							delete $potentials{$id};
</%perl>
							<div class="row <% $notfirst++ ? "ltbordertop" : "" %> flexrow padvertless leftalign" id="<% $id %>">

								<span class="twenty semibold centeralign">
									<% $counter++ %>.
								</span>

								<span class="third">
									<% $extra_coaches{$id}{"first"}." ".$extra_coaches{$id}{"last"} %>
								</span>

								<span class="tenth centeralign" title="Diamonds">
%									foreach (1 .. $extra_coaches{$id}{"diamonds"}) {
%										$m->print("*");
%									}
								</span>

								<span class="fifth smallish bluetext semibold">
									Additional listing
								</span>
								<span class="twofifths smallish">
								</span>
							</div>
%						}

						<div class="odd bluebordertop">
							<span class="half marno bluetext centeralign padsetting italic rightalign">
								Add a coach from your chapter/judge roster
							</span>

							<span class="half">
								<select name="coach_id" class="fixedmost">
									<option value=""></option>
%									foreach my $id (sort {uc($potentials{$a}{"last"}) cmp uc($potentials{$b}{"last"})} keys %potentials) {
										<option
											value="<% $id %>"
										><% $potentials{$id}{"first"}." ".$potentials{$id}{"last"} %></option>
%									}
								</select>
							</span>
						</div>

						<div class="row">
							<span class="half marno bluetext centeralign padsetting italic rightalign">
								Or, add a coach via their Tabroom account
							</span>

							<span class="half">
								<input
									name        = "coach_email"
									type        = "email"
									placeholder = "Enter email of coach's Tabroom account"
								>
							</span>
						</div>
						<div class="libl rightalign marvertno padvertless padrightmore">
							<span class="third centeralign nospace">
								<input
									type  = "submit"
									value = "Save Coaches"
								>
							</span>
						</div>
					</span>
				</div>
%			}
<%perl>
			my $default_address;

			if ($tourn_settings->{"mailing_address"}) {

				if ($nsda_chapter->{addresses}) {
					foreach my $address (@{$nsda_chapter->{addresses}}) {
						next unless $address->{"shipping"};
						$default_address = $address;
						last;
					}
				}
</%perl>

				<h5 class="martopmore">
					Mailing Address
				</h5>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign odd bluebordertop">
						<p>
							<% $tourn_settings->{"mailing_message"} %>
						</p>

						<div class="full nospace bluebordertop">
							<& "/funclib/address.mas",
								tag      => "mail",
								person   => $person,
								notfirst => 1,
								default  => $school_settings{'mail_address'},
								default2 => $default_address
							&>
						</div>

						<div class="libl rightalign marvertno padvertless padrightmore">
							<span class="third centeralign nospace">
								<input
									type  = "submit"
									value = "Save Mailing Address"
								>
							</span>
						</div>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"nsda_ms_nats"} && $year != 2020) {
				<div class="row">
					<span class="third marno">
						Coaches (for recognition on team awards)
					</span>

					<span class="twothirds">
						<textarea
							cols  = "48"
							rows  = "3"
							type  = "text"
							name  = "coaches"
						><% $chapter->setting("coaches")  %></textarea>
					</span>
				</div>

				<div class="libl rightalign marvertno padvertless padrightmore">
					<span class="third centeralign nospace">
						<input  type="submit" value="Save Coaches">
					</span>
				</div>
%			}

%			my @hotels = $tourn->hotels();

%			if (@hotels) {

				<h5 class="martopmore">
					Hotel Information
				</h5>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign nospace bluebordertop">

%						if ($tourn_settings->{"hotel_message"}) {
							<div class="biggish">
								<% $tourn_settings->{"hotel_message"} %>
							</div>
%						}

						<div class="row">
							<span class="third semibold bluetext">
								Choose Hotel
							</span>

							<span class="twothirds">
								<select
									name  = "hotel"
									class = "fixedbigger notfirst"
								>

									<option value="">Select the hotel you are staying at</option>
<%perl>
								foreach my $hotel (
									sort {
									$b->multiple cmp $a->multiple
									|| $b->surcharge cmp $a->surcharge
									|| $a->name cmp $b->name
									} @hotels
								) {
</%perl>
									<option value="<% $hotel->id %>"
										<% $hotel->id == $school_settings{"hotel"}
											? 'selected="selected"'
											: ""
										%>
									><% $hotel->name %> <%
											(not defined $tourn_settings->{nsda_nats})
											&& (not defined $tourn_settings->{nsda_ms_nats})
											&& $hotel->multiple > 1
											? "(Entry fee surcharge of ".$hotel->multiple."X applies)"
											: ""
									%>
									<%
											(not defined $tourn_settings->{nsda_nats})
											&& (not defined $tourn_settings->{nsda_ms_nats})
											&& $hotel->surcharge > 0
											? "(Surcharge of \$".$hotel->surcharge." per competitor applies)"
											: ""
									%><%
											(not defined $tourn_settings->{nsda_nats})
											&& (not defined $tourn_settings->{nsda_ms_nats})
											&& $hotel->surcharge < 0
											? "(\$".abs($hotel->surcharge)."/competitor discount)"
											: ""
									%></option>
%								}
								</select>
							</span>
						</div>

%						if ($tourn_settings->{"require_hotel_confirmation"}) {
							<div class="row">
								<span class="third semibold bluetext">
									Confirmation Number
								</span>

								<span class="twothirds">
									<input
										type        = "text"
										name        = "hotel_confirmation"
										class       = "notfirst"
										value       = "<% $school_settings{"hotel_confirmation"} %>"
										placeholder = "Enter one of your confirmation numbers at this hotel"
									>
								</span>
							</div>
%						}

						<div class="libl rightalign marvertno padvertless padrightmore">
							<span class="third centeralign nospace">
								<input
									type  = "submit"
									class = "notfirst"
									value = "Save Hotel"
								>
							</span>
						</div>

					</span>
				</div>
<%perl>
			}

			if ($tourn_settings->{"per_person_fee"}) {

				my $warning;

				my $bodies = $m->comp("/funclib/school_bodies.mas", school => $school);

				if ($school_settings{"individuals"} < $bodies) {
					$warning = "WARNING: you have ".$school_settings{'individuals'}." people in your registration count,";
					$warning .= " but you have $bodies individuals registered to compete or judge for you."
				}
</%perl>

				<div class="flexrow martopmuchmore">
					<span class="fourfifths">
						<h5 class="nospace">Per-person Fee Information</h5>
					</span>
					<span class="fifth semibold rightalign padright">
						<% $tourn_settings->{currency} || '$' %><% $tourn_settings->{per_person_fee} %> per person
					</span>
				</div>


				<div class="centeralign nospace">
					<span class="ninetenths leftalign nospace bluebordertop">

						<p class="semibold redtext italic">
							<% $warning %>
						</p>

						<div class="row flexrow">
							<span class="twofifths marno semibold padleft">
								Number of individuals in your party
							</span>

							<span class="fifth">
								<input
									size        = "5"
									type        = "number"
									min         = 0
									max         = 9999
									name        = "individuals"
									value       = "<% $school_settings{"individuals"} %>"
									placeholder = "<% $bodies %>"
								>
							</span>
							<span class="fifth centeralign redtext semibold">
								<% $bodies %> registered
							</span>

							<span class="fifth rightalign padright redtext semibold">
								<input type="submit" value="Save">
							</span>
						</div>
					</span>
				</div>
%			}

%			if ($tourn_settings->{"school_codes"} eq "registrant") {
				<div class="row">
					<span class="third marno">
						Your School Code*
					</span>

					<span class="twothirds">
						<input
							size      = "10"
							type      = "text"
							name      = "school_code"
							value     = "<% ($school->code) ? $school->code : "" %>"
							maxlength = "6">
					</span>
				</div>
%			}

%			if ($tourn_settings->{"refund_information"}) {

				<div class="full flexrow martopmuchmore">
					<span class="twothirds padleft">
						<h5 class="nospace semibold">
							Overpayments &amp; refunds
						</h5>
					</span>
					<span class="third rightalign redtext semibold padright">
						Deadline <&
							"/funclib/showdate.mas",
							dt     => $tourn_settings->{"refund_deadline"},
							length => "medium",
							tz     => $tourn->tz,
						&> at <&
							"/funclib/showtime.mas",
							dt      => $tourn_settings->{"refund_deadline"},
							tz      => $tourn->tz,
							show_tz => 1
						&>
					</span>
				</div>

				<div class="centeralign martop">
					<span class="ninetenths leftalign bluebordertop nospace">
<%perl>
						if ($tourn_settings->{"nsda_nats"}
							|| $tourn_settings->{"nsda_ms_nats"}
							|| $tourn_settings->{"nsda_billing"}
						) {
</%perl>
							<div class="padleftmore padbottom biggish">
								<% $tourn_settings->{"judgebond_message"} %>
							</div>

							<div class="row">

								<span class="third semibold">
									Preferred refund method:
								</span>

								<span class="twothirds semibold">

									<label for="credit">
										<span class="half hover">
											<input
												type     = "radio"
												name     = "refund_method"
												id       = "credit"
												class    = "notfirst"
												value    = "credit"
												onChange = "toggleRefund('credit');"
												<% $school_settings{'refund_method'} eq "credit"
													? "checked"
													: ""
												%>
											> Credit towards <% $year %>-<% $year + 1 %>
										</span>
									</label>

									<label for="check">
										<span class="half hover">
											<input
												type     = "radio"
												name     = "refund_method"
												id       = "check"
												class    = "notfirst"
												value    = "check"
												onChange = "toggleRefund('check');"
												<% $school_settings{'refund_method'} eq "check"
													? "checked"
													: ""
												%>
											> Check
										</span>
									</label>
								</span>
							</div>

							<div class="refundcheck <%
								$school_settings{'refund_method'} eq "check"
									? ""
									: "hidden"
							%> toggle">

%						} else {

							<input
								type  = "hidden"
								name  = "refund_method"
								class = "notfirst"
								value = "check"
							>

							<div class="refundcheck">

%						}
							<div class="row padvert">
								<span class="third semibold bluetext">
									Make refund checks payable to:
								</span>

								<span class="twothirds">
									<input
										type  = "text"
										class = "notfirst"
										name  = "refund_payable"
										size  = "64"
										value = "<% $school_settings{'refund_payable'} %>"
									>
								</span>
							</div>

							<div class="row">
								<span class="quarter semibold bluetext">
									Address to send checks
								</span>

								<span class="threequarters">
									<& "/funclib/address.mas",
										tag      => "refund",
										notfirst => 1,
										person   => $person,
										default  => $school_settings{'refund_address'},
										default2 => $default_address
									&>
								</span>
							</div>
						</div>

						<div class="libl rightalign marvertno padvertless padrightmore">
							<span class="third centeralign nospace">
								<input
									type  = "submit"
									value = "Save Refund Info"
									class = "notfirst"
								>
							</span>
						</div>
					</span>
				</div>
%			}
			</form>

%			unless ($tourn_settings->{"hide_deadlines"}) {
				<div class="full martopmore nospace">
					<span class="twothird nospace">
						<h5 class="martopmore semibold">
							Tournament Registration Deadlines
						</h5>
					</span>

					<span class="third martopmore rightalign semibold purpletext">
						All times are in <% Tab::tzname($tz) %>
					</span>
				</div>

				<p class='explain smaller semibold centeralign'>
					These deadlines are those set in Tabroom for technical
					purposes. Always consult the invitation or tournament
					notices for official policies about deadlines and
					procedures.
				</p>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign bluebordertop nospace">
<%perl>
					if ($tourn_settings->{"nsda_district"}) {

						foreach my $weekend ($tourn->weekends()) {

							$m->print('<h6 class="martopmore semibold">'.$weekend->name."</h6>");

							$m->comp("deadlines.mas",
								object     => $weekend,
								nats       => $tourn_settings->{"nsda_nats"},
								mock_trial => $tourn_settings->{"mock_trial_registration"},
								tz         => $tourn->tz
							);

						}

					} else {

						my @deadlines = (
							"drop_deadline",
							"freeze_deadline",
							"fine_deadline",
							"supp_deadline"
						);

						unless ($tourn_settings->{"mock_trial_registration"}) {
							push (@deadlines, "judge_deadline");
						}

						foreach my $deadline (@deadlines) {
							Tab::Tourn->columns(TEMP => $deadline);
							$tourn->$deadline($tourn_settings->{$deadline});
						}

						$m->comp("deadlines.mas",
							object     => $tourn,
							nats       => $tourn_settings->{"nsda_nats"},
							mock_trial => $tourn_settings->{"mock_trial_registration"},
							tz         => $tourn->tz
						);
					}

					unless ($tourn_settings->{"mock_trial_registration"}) {

						foreach my $category ($tourn->categories) {

							my $deadline = $category->setting("deadline");
							my $strike_start = $category->setting("strike_start");
							my $strike_end = $category->setting("strike_end");

							if ($deadline) {
</%perl>
								<div class="full row marno padless small">
									<span class="semibold threefifths redtext">
										<% $category->name %> judge registrations are due by:
									</span>

									<span class="quarter">
										<% &Tab::nicedate($deadline->set_time_zone($tourn->tz)) %>
									</span>

									<span class="eighth">
										<% &Tab::nicetime($deadline->set_time_zone($tourn->tz)) %>
									</span>
								</div>
%							}

%							if ($strike_start) {

								<div class="full row marno padless small">
									<span class="semibold threefifths bluetext">
										<% $category->name %> prefs/strikes open:
									</span>

									<span class="quarter">
										<% &Tab::nicedate($strike_start->set_time_zone($tourn->tz)) %>
									</span>

									<span class="eighth">
										<% &Tab::nicetime($strike_start->set_time_zone($tourn->tz)) %>
									</span>
								</div>
%							}

%							if ($strike_end) {

								<div class="full row marno padless small">
									<span class="semibold threefifths bluetext">
										<% $category->name %> prefs/strikes deadline
									</span>

									<span class="quarter">
										<% &Tab::nicedate($strike_end->set_time_zone($tourn->tz)) %>
									</span>

									<span class="eighth">
										<% &Tab::nicetime($strike_end->set_time_zone($tourn->tz)) %>
									</span>
								</div>
<%perl>
							}
						}
					}

					foreach my $concession ($tourn->concessions) {

						next unless $concession->deadline;
</%perl>
						<div class="full row marno padless small">
							<span class="semibold threefifths">
								<% $concession->name %> orders are due by:
							</span>

							<span class="quarter">
								<%
									Tab::nicedate($concession->deadline->set_time_zone($tz))
								%>
							</span>

							<span class="eighth">
								<%
									Tab::nicetime($concession->deadline->set_time_zone($tz))
								%>
							</span>
						</div>
%					}
					</span>
				</div>
%			}
<%perl>
			if ($tourn_settings->{"disclaimer"}) {

				my $disclaimed = Tab::Person->retrieve($school_settings{"disclaimed"});
				my $disclaimed_at = $school_settings{'disclaimed_at'};
				$disclaimed_at->set_time_zone($tz) if $disclaimed_at;
</%perl>
				<div class="full martopmore">
					<span class="nospace third">
						<h5>
							Notes &amp; Disclaimer
						</h5>
					</span>

%					if ($disclaimed) {
						<span class="nospace twothirds rightalign">
							<p class="explain marno padless semibold purpletext">
								Agreed to by
								<% $disclaimed->first." ".$disclaimed->last." (".$disclaimed->email.")" %>
								on <% Tab::nicedt($disclaimed_at) %>
							</p>
						</span>
%					} else {

						<span class="nospace twothirds rightalign">
							<span class="buttonwhite redtext">
								No Coach Agreed
							</span>
						</span>
%					}
				</div>

				<div class="centeralign nospace">
					<span class="ninetenths leftalign">
						<div class="padmuchmore borderredthin semibold graytext">
							<% $tourn_settings->{"disclaimer"}%>
						</div>
					</span>
				</div>
%			}
%		}
	</div>

	<div class="menu">

%		unless ($tourn_settings->{"ncfl"}) {

%			if ($supp_team) {
				<div class="sidenote">
					<h4>YOUR SUPP TEAM: <% $supp_team->{label} %></h4>
					<p class="bluetext semibold martopmore">ON WEDNESDAY</p>

					<div class="full flexrow odd marno">
						<span class="third padleft">Speech</span>
						<span class="twothirds semibold bluetext"><% $sites_by_id{$supp_team->{wed_speech}}->name %></span>
					</div>
					<div class="full flexrow odd marno">
						<span class="third padleft">ExtDebate</span>
						<span class="twothirds semibold bluetext"><% $sites_by_id{$supp_team->{wed_debate}}->name %></span>
					</div>

					<p class="bluetext semibold martopmore">ON THURSDAY</p>

					<div class="full flexrow odd marno">
						<span class="third padleft">Speech</span>
						<span class="twothirds semibold orangetext"><% $sites_by_id{$supp_team->{thu_speech}}->name %></span>
					</div>
					<div class="full flexrow odd marno">
						<span class="third padleft">ExtDebate</span>
						<span class="twothirds semibold orangetext"><% $sites_by_id{$supp_team->{thu_debate}}->name %></span>
					</div>

					<p class="explain padtopless smaller semibold padleft">
						Supplemental Events are held at multiple
						locations.  All of your District's entries and judges
						are assigned to the Supp locations above.
					</p>

				</div>
%			}

			<div class="sidenote">
				<h4>Printouts</h4>
%				if ($tourn_settings->{"nsda_nats"}) {
					<a
						href="/register/reports/problem_children.mhtml?school_id=<% $school->id %>"
						class="yellow full"
					>
						Print Updated Problem Sheet
					</a>
%				}

				<a
					href="entry_print.mhtml?school_id=<% $school->id %>"
					class="blue full"
				>
					<span class="nospace half">
						Print Registration
					</span>
					<span class="nospace half">
						By Event
					</span>
				</a>

%				unless ($tourn_settings->{"mock_trial_registration"}) {
					<a
						href="by_person_print.mhtml?school_id=<% $school->id %>"
						class="blue full"
					>
						<span class="nospace half">
							Print Registration
						</span>
						<span class="nospace half">
							By Competitor
						</span>
					</a>
%				}

				<a
					href="entry_csv.mhtml?school_id=<% $school->id %>"
					class="blue full"
				>
					Registration Spreadsheet CSV
				</a>
<%perl>
				unless (
					$tourn_settings->{"nsda_ms_nats"}
					|| $tourn_settings->{"nsda_nats"}
					|| $tourn_settings->{"nsda_billing"}
					|| $tourn_settings->{"no_registration_fees"}
				) {
</%perl>
					<a
						href="invoice_print.mhtml?school_id=<% $school->id %>"
						class="blue full martop"
					>
						Print Tournament Invoice
					</a>

					<hr />
%				}

			</div>

%			my @forms = $tourn->files(tag => "school_form");

%			if (@forms) {
				<div class="sidenote">
					<h4>School Entry Forms</h4>
%					foreach my $form (@forms) {
						<& "/funclib/school_forms.mas", school => $school, form => $form &>
%					}
				</div>
%			}

%			unless ($tourn_settings->{"mock_trial_registration"} || $tourn_settings->{"account_contacts"}) {

				<div class="sidenote">

					<h4
						title="Use this to have a non-school administrator receive all tournament email annoucements that apply to your school"
					>Get Tournament Emails</h4>
<%perl>
					my @followers = Tab::Follower->search(
						school => $school->id,
						type   => 'contact'
					);

					foreach my $follower (@followers) {
</%perl>
						<a
							class = "blue full"
							href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
						>
							<% $follower->person
								? $follower->person->first." ".$follower->person->last
								: $follower->email
							%>
						</a>
%					}

					<form
						action = "school_follow.mhtml"
						method = "post"
					>

					<input
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>

					<input
						type  = "hidden"
						name  = "type"
						value = "contact"
					>

					<input
						type  = "hidden"
						name  = "tourn_id"
						value = "<% $tourn->id %>"
					>

						<div class="row">
							<span class="threequarters marleft marright centeralign padvert">
								<input
									type        = "email"
									class       = "thin"
									name        = "email"
									size        = "24"
									placeholder = "Any email address"
								>
							</span>

							<span class="nospace centeralign fifth">
								<input
									type  = "submit"
									value = "Go"
									class = "thin"
								>
							</span>
						</div>
					</form>
%				}

%				unless ($tourn_settings->{"mock_trial_registration"} || $tourn_settings->{"account_contacts"}) {

					<h4 class="martopmore"
						title="Use this to get all pairings and assignments for the school. You will only get these over email, not text, because of high volume."
					>
						Get All Pairings
					</h4>
<%perl>
					my @followers = Tab::Follower->search(
						school => $school->id,
						type   => 'school'
					);
</%perl>
%					if (@followers) {
						<p class="explain smaller padless">
							The following people will receive emailed pairings for the
							school in one message:
						</p>
%					}

%					foreach my $follower (@followers) {
						<a
							class = "blue full"
							href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
						>
							<% $follower->person
								? $follower->person->first." ".$follower->person->last
								: $follower->email
							%>
						</a>
%					}

					<form
						action="school_follow.mhtml"
						method="post"
					>
						<input
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<input
							type  = "hidden"
							name  = "tourn_id"
							value = "<% $tourn->id %>"
						>

						<div class="row marno">
							<span class="threequarters marleft marright centeralign padvert">
								<input
									type        = "email"
									class       = "thin"
									name        = "email"
									size        = "24"
									placeholder = "Email of Tabroom account"
								>
							</span>

							<span class="nospace fifth centeralign">
								<input
									type  = "submit"
									value = "Go"
									class = "thin">
							</span>
						</div>
					</form>
				</div>
%			}

%			if ($tourn_settings->{"nsda_ms_nats"} || $tourn_settings->{"nsda_nats"}) {
				<div class="sidenote">
					<h4>Privacy Notice</h4>
					<p class="biggish">
						The information on this page will be used only for
						emergency contact during the tournament. The contact
						number you provide will be used in the event of a
						medical emergency involving one of your students or a
						tournament related problem such as a missing ballot.
						The hotel information is used to locate you in the
						event of an emergency.
					</p>
				</div>
%			}

<%perl>
			;

			unless ($totals && $totals->{"payments"}
				|| ($now > $tourn_settings->{"freeze_deadline"}
				|| $tourn_settings->{"nsda_district"}
				|| $tourn_settings->{"nsda_nats"}
			) ) {

				my $warn = "This will drop your entire entry, including any spots on waitlists.  Be very sure!";
</%perl>
				<div class="sidenote martopmore padbottommore">
					<a
						href  = "drop_school.mhtml?school_id=<% $school->id %>"
						class = "dkred full martopmore"
						<& "/funclib/confirm.mas", warn => $warn &>
					>
						DROP ENTIRE ENTRY
					</a>
				</div>
%			}
%		}

%		if (scalar (keys %{$cat_warnings}) > 0) {

%			my $notfirst;
%			foreach my $category (sort {$a cmp $b} keys %{$cat_warnings}) {
%				unless ($notfirst++) {
					<div class="sidenote">
						<h5 class="warning">Judge Warning</h5>
%				}

					<p class="bigger">
						You have active judges in <% $cat_warnings->{$category} %> despite
						having no active entries in that category.
					</p>

					<p class="bigger">
						If you have dropped your entries, please remember to
						<a
							class="bluetext inline semibold"
							href="judges.mhtml?school_id=<% $school->id %>&category_id=<% $category %>"
						>drop your judges</a>
						as well.
					</p>
%			}

			</div>
%		}


	</div>

	<script>
		function toggleRefund(thing) {
			$(".toggle").addClass("hidden");
			$(".refund"+thing).removeClass("hidden");
			resizeAll();
			zebraRows();
		}
	</script>

