<%args>
	$person
	$session
	$school
	$tourn
	$disclaimed => undef
</%args>
<%init>

	use POSIX;

	my %tourn_settings = $tourn->all_settings;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);

	my %school_settings = $school->all_settings;

	if ($tourn_settings{"disclaimer"}) { 

		if ($disclaimed) { 

			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);

		} elsif ($school_settings{"disclaimed"}) { 

		} else { 

			$m->redirect("disclaimer.mhtml?school_id=".$school->id) 

		}

	}

	my $adult++ if ( 
		$school_settings{"contact_number"} 
		&& $school_settings{"contact_name"} 
		&& $school_settings{"contact_email"}
	);

	$adult++ unless $tourn_settings{"require_adult_contact"};

	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas", 
		school => $school
	);

</%init>

	<div class="main">

%		if ($adult) { 
			<& tabbar.mas, school => $school, whoami => "tourn" &>
%		} else { 
			<h2>
				<% $tourn->name %>
			</h2>
%		} 


%		if (@empties) { 

			<div class="full bluetext warnbox centeralign">

				<h5 class="redtext">
					Something has gone horribly, horribly wrong!
				</h5>

				There are no competitors assigned to entries: 

%					foreach my $empty (@empties) { 

						<div class="full centeralign">
							<a 
								href="/user/enter/details.mhtml?school_id=<% $school->id %>&entry_id=<% $empty->id %>"
								class="button dkred"
							>
								<% $empty->code %> in
								<% $empty->event->abbr %>
							</a>
						</div>
%					}

				Please assign competitors to these entries or they will not
				advance or receive points.
			</div>

%		}


%		if ($tourn_settings{"ask_regions"}) { 

			<h3>Region</h3>

			<form action="region_save.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<div class="lightrow">
				<span class="half">
					Your Region/District:
				</span>

				<span class="third">
					<select name="region_id" class="fixedmed">

						<option value="">Please choose one:</option>

%						foreach my $region ($tourn->regions) { 
							<option 
								value="<% $region->id %>" 
								<% $region->id == $school->region ? 'selected="selected"' : "" %>
							><% $region->name %></option>
%						}
					</select>
				</span>

				<span class="sixth">
					<input type="submit" value="Save" class="thin">
					</form>
				</span>

			</div>
			
%		}

%		unless ($adult) { 

			<h4>This tournament requires an adult contact</h4>

			<p>
				Before you can register further, you must supply the name and phone
				number for the responsible adult who is attending the tournament.
			</p>
%		}

		<h4>Adult Contact Information:</h4>

		<form action="contact_save.mhtml" method="post">

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>

		<div class="lightrow">

			<span class="half">
				Adult contact (must be attending the tournament):
			</span>
		
			<span class="half">
				<input 
					size  = "32"
					type  = "text"
					name  = "contact_name"
					value = "<% $school_settings{"contact_name"} %>"
				>
			</span>

		</div>
			
		<div class="lightrow">

			<span class="half">
				That contact's email
			</span>
			
			<span class="half">
				<input 
					size  = "32"
					type  = "email"
					name  = "contact_email"
					value = "<% $school_settings{"contact_email"}  %>"
				>
			</span>

		</div>

		<div class="lightrow">

			<span class="half">
				That contact's mobile phone:
			</span>
		
			<span class="half">
				<input 
					size  = "32"
					type  = "tel"
					name  = "contact_number"
					value = "<% $school_settings{"contact_number"}  %>"
				>
			</span>

		</div>


%		if ($tourn_settings{"require_hotel_form"}) { 


			<div class="lightrow">

				<span class="half">
					<div class="full padless">
						Secondary Cell Phone
					</div>

					<div class="full padless explain marno">
						In case the primary contact is unreachable.
					</div>
				</span>
				
				<span class="half">
					<input 
						size  = "32"
						type  = "tel"
						name  = "second_contact_number"
						value = "<% $school_settings{"second_contact_number"}  %>"
					>
				</span>

			</div>

			<div class="lightrow">

				<span class="half">
					Hotel You Are Staying At:
				</span>
				
				<span class="half">
					<input 
						size  = "32"
						type  = "text"
						name  = "contact_hotel"
						value = "<% $school_settings{"contact_hotel"}  %>"
					>
				</span>

			</div>

			<div class="lightrow">

				<span class="half">
					Number of hotel rooms booked:
				</span>
				
				<span class="half">
					<input 
						size  = "32"
						type  = "number"
						min   = 0
						max   = 999
						name  = "contact_hotel_rooms"
						value = "<% $school_settings{"contact_hotel_rooms"}  %>"
					>
				</span>

			</div>

			<& "/funclib/datepicker.mas", id => "hotel_checkout", min => $tourn->start &> 

			<div class="lightrow">

				<span class="half">
					Hotel checkout date
				</span>
				
				<span class="half">
					<input 
						id    = "hotel_checkout"
						size  = "16"
						type  = "text"
						name  = "contact_hotel_checkout"
						value = "<%
							$school_settings{"contact_hotel_checkout"} ? 
							$school_settings{"contact_hotel_checkout"} :
							Tab::pickerdate($tourn->end->add(days => 1))
						%>"
					>
				</span>

			</div>

%		}


<%perl>

		if ($tourn_settings{"per_person_fee"}) { 

			my $bodies = $m->comp("/funclib/school_bodies.mas", school => $school);

			if ($school_settings{"individuals"} < $bodies) { 
				$school->setting("individuals", $bodies);
				$school_settings{"individuals"}  = $bodies;
			}
			
</%perl>
			<div class="lightrow">

				<span class="half">
					# of individuals in your party
				</span>
			
				<span class="half">
					<input 
						size  = "5"
						type  = "number"
						min   = 0
						max   = 9999
						name  = "individuals"
						value = "<% $school_settings{"individuals"} %>"
					>
				</span>

			</div>

%		}

%		if ($tourn_settings{"school_codes"} eq "registrant") { 

			<div class="lightrow">

				<span class="half">
					Your School Code*
				</span>
		
				<span class="half">
					<input 
						size      = "10"
						type      = "text"
						name      = "school_code"
						value     = "<% ($school->code) ? $school->code : "" %>"
						maxlength = "6">
				</span>

			</div>
%		}

%		if ($tourn_settings{"refund_information"}) { 

			<h6 class="martopmore">
				Refund of waitlist overpay/tournament fees
			</h6>

%			if ($tourn_settings{"refund_judge_bond"}) { 

				<script>

					$(document).ready(function() {
						disableRefund();
					});
		
					function disableRefund() { 

						if ($("#refund_judge_bond").prop("checked")) { 

							$(".refunds").prop("disabled", true);
							$(".refundrows").addClass("hidden");

						} else { 

							$(".refunds").prop("disabled", false);
							$(".refundrows").removeClass("hidden");
						}

					}
					
				</script>

				<div class="lightrow">

					<span class="half">
						Apply refund to an NSDA school credit:
					</span>

					<label for="refund_judge_bond">
						<span class="half hover padleftmore">
							<input 
								type     = "checkbox"
								name     = "refund_judge_bond"
								id       = "refund_judge_bond"
								size     = "34"
								value    = "1"
								onChange = "disableRefund();"
								<% $school_settings{'refund_judge_bond'} 
									? 'checked="true"'
									: ""
								%>
							>
						</span>
					</label>

				</div>
%			}

			<div class="lightrow refundrows">

				<span class="half">
					Make refund checks payable to:
				</span>

				<span class="half">
					<input 
						type  = "text"
						class = "refunds"
						name  = "refund_payable"
						size  = "34"
						value = "<% $school_settings{'refund_payable'} %>"
					>
				</span>

			</div>

			<div class="lightrow refundrows">

				<span class="half">
					Address to send refund checks
				</span>

				<span class="half">
					<textarea 
						name  = "refund_address"
						cols  = "32"
						class = "refunds"
						rows  = "4"
					><% $school_settings{"refund_address"} %></textarea>
				</span>

			</div>
%		}

		<div class="liblrow rightalign">
			<input  type="submit" value="Save Contact Info">
			</form>
		</div>

%		if ($adult) { 

			<div class="padno block martop">
				<span class="twothird padno martop">
					<h4>Tournament Deadlines:</h4>
				</span>

				<span class="third right padno">
					<p class="explain rightalign">All times are <% Tab::tzname($tz) %></p>
				</span>
			</div>

			<table>

				<tr class="lightrow">

					<td class="smaller">
						You must add entries by
					</td>

					<td class="smaller">
						<% ($tourn->reg_end) ? Tab::nicedt($tourn->reg_end->set_time_zone($tz)) : "Not Set" %>
					</td>

				</tr>

				<tr class="lightrow">

					<td class="smaller">
						Your registration fees/obligations are frozen on
					</td>

					<td class="smaller">
%						my $freeze_deadline = $tourn_settings{"freeze_deadline"};
%						$freeze_deadline = $tourn->reg_end unless $freeze_deadline;

						<% ($freeze_deadline && $freeze_deadline->year) 
							? Tab::nicedt($freeze_deadline->set_time_zone($tz)) 
							: "Not Set" 
						%>
					</td>

				</tr>

				<tr class="lightrow">
				
					<td class="smaller">
						You can drop entries or change names yourself online until
					</td>
				
					<td class="smaller">
%						my $drop_deadline = $tourn_settings{"drop_deadline"};
						<% ($drop_deadline) 
							? Tab::nicedt($drop_deadline->set_time_zone($tz)) 
							: "Not Set"
						%>
					</td>

				</tr>

				<tr class="lightrow">
			
					<td class="smaller">
						Judge entries and changes are due by
					</td>

					<td class="smaller">
%						my $judge_deadline = $tourn_settings{"judge_deadline"};
						<% ($judge_deadline) 
							? Tab::nicedt($judge_deadline->set_time_zone($tz)) 
							: "Not Set" 
						%>
					</td>

				</tr>

				<tr class="lightrow">
		
					<td class="smaller">
						Nuisance fines in addition to reg fees for changes start at
					</td>

					<td class="smaller">
%						my $fine_deadline = $tourn_settings{"fine_deadline"};
						<% ($fine_deadline) ? Tab::nicedt($fine_deadline->set_time_zone($tz)) : "Not Set" %>
					</td>
				
				</tr>
			
%				foreach my $category ($tourn->categories) {
		
%					if ($category->setting("deadline")) { 
		
						<tr class="lightrow">
		
							<td class="smaller">	
								<% $category->name %> judges are due by:
							</td>
		
							<td class="smaller">
								<% &Tab::nicedt($category->setting("deadline")->set_time_zone($tourn->tz)) %>
							</td>
		
						</tr>
		
%					}

%					if ($category->setting("strike_start")) { 
		
						<tr class="lightrow">
		
							<td class="smaller">	
								<% $category->name %> strikes/ratings open:
							</td>
		
							<td class="smaller">
								<% &Tab::nicedt($category->setting("strike_start")->set_time_zone($tourn->tz)) %>
							</td>
		
						</tr>
		
%					}

%					my $strike_end = $category->setting("strike_end");

%					if ($strike_end) { 
		
						<tr class="lightrow">
		
							<td class="smaller">	
								<% $category->name %> strikes/ratings due by:
							</td>
		
							<td class="smaller">
								<% &Tab::nicedt($strike_end->set_time_zone($tourn->tz)) %>
							</td>

						</tr>

%					}


%				}

%				foreach my $concession ($tourn->concessions) {

%					next unless $concession->deadline;

					<tr class="lightrow">

						<td class="smaller">	
							<% $concession->name %> orders are due by:
						</td>

						<td class="smaller">
							<% &Tab::nicedt($concession->deadline->set_time_zone($tourn->tz)) %>
						</td>

					</tr>
%				}
		
			</table>

%		}

%		if ($tourn_settings{"disclaimer"}) { 

%			my $disclaimed = Tab::Person->retrieve($school_settings{"disclaimed"});
%			my $disclaimed_at = $school_settings{'disclaimed_at'};
%			$disclaimed_at->set_time_zone($tz) if $disclaimed_at;

			<div class="full">

				<span class="nospace third"> 
					<h4>Notes/Disclaimer:</h4>
				</span>

%				if ($disclaimed) { 

					<span class="nospace twothirds rightalign"> 

						<p class="explain marno padless">
							Agreed to by 
							<% $disclaimed->first." ".$disclaimed->last." (".$disclaimed->email.")" %>
						</p>

						<p class="explain marno padless">
							on <% Tab::nicedt($disclaimed_at) %>
						</p>
					</span>

%				} else { 

					<span class="nospace twothirds rightalign"> 

						<span class="buttonwhite redtext">
							No Coach Agreed
						</span>

					</span>
%				} 

				</div>

			<div class="padmore border martopmore">
				<% $tourn_settings{"disclaimer"}%>
			</div>



%		}

	</div>

	<div class="menu">
	
		<div class="sidenote">

%		if ($adult) { 

			<h4>Printouts</h4>

			<a 
				href="entry_print.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				Print Registration by event
			</a>

			<a 
				href="by_person_print.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				Print Registration by person
			</a>

			<a 
				href="invoice_print.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				Print Tournament Invoice
			</a>

			<a 
				href="entry_csv.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				Registration spreadsheet
			</a>
			
			<hr />

%		}

<%perl>
		   my ($payments, $payments_ref) = $m->comp(
			   "/funclib/school_fees.mas", 
				   school_id => $school->id, 
				   payments => 1
			   );

		unless ( $payments || ($now > $tourn_settings{"freeze_deadline"} ) ) { 

			my $warn = "This will drop your entire entry, including any spots on waitlists.  Be very sure!";

</%perl>
			<a 
				href  = "drop_school.mhtml?school_id=<% $school->id %>" 
				class = "dkred full"
				<& "/funclib/confirm.mas", warn => $warn &>  
			>
				DROP ENTIRE ENTRY
			</a>

%		}

		</div>

		<div class="sidenote">

			<h4>Live updates</h4>

<%perl>

			my @followers = Tab::Follower->search( 
				school => $school->id,
				type   => 'school' 
			);

</%perl>

%			if (@followers) { 
				<p 
					class="explain smaller padless">
					The following <% scalar @followers %> users receive emailed
					pairings for the school in one message:

				</p>
%			}

%			foreach my $follower (@followers) { 

				<a 
					class = "blue full" 
					href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
				>
					<% $follower->follower->first." ".$follower->follower->last %>
				</a>
%			}

			<p class="explain centeralign">Get all your schools' pairings by email:</p>

				<form action="school_follow.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input 
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>
			
				<div class="evenrow">
				
					<span class="threequarter nospace">
						<input 
							type        = "text"
							class       = "thin"
							name        = "email"
							size        = "20"
							placeholder = "Email of Tabroom user">
					</span>

					<span class="nospace quarter">
						<input 
							type  = "submit"
							value = "Go"
							class = "thin">
					</span>

				</div>

				</form>

			</form>

		</div>

%		if ($tourn_settings{"nsda_ms_nats"}) { 

	
			<div class="sidenote">

				<h4>Privacy Notice</h4>

				<p class="biggish">
					The information on this page will be used only for emergency
					contact during the national tournament. The contact number you
					provide will be used in the event of a medical emergency
					involving one of your students or a tournament related problem
					such as a missing ballot. The hotel information is used to
					locate you in the event of an emergency.
				</p>

			</div>
%		}

%		if ($tourn_settings{"nsda_district"} && ($person->site_admin || $session->su > 0)) { 

			<a 
				class="yellow full"
				href="/funclib/chapter_nsda_update.mas?chapter_id=<% $school->chapter->id%>">
				Update NSDA Points
			</a>

%		}

	</div>

