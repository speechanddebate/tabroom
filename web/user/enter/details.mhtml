<%args>
	$tourn
	$entry_id
	$school_id
	$person
	$from => undef
</%args>
<%init>

	use JSON;

	my $entry = Tab::Entry->retrieve($entry_id);

	$m->abort unless $entry;

	my $event = $entry->event;
	my $school = Tab::School->retrieve($school_id);

	my %event_settings = $event->all_settings;
	my %entry_settings = $entry->all_settings;

	my $max = $event_settings{"max_entry"};
	my $min = $event_settings{"min_entry"};

	my $code_style = $event_settings{"code_style"};

	my @clear_students = $m->comp(
		"/funclib/students_evententer.mas",
			event  => $event,
			school => $school
	);

	my @students = $entry->students;

	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $drop_deadline = $tourn_settings{"drop_deadline"};
	$drop_deadline = $tourn->reg_end unless $drop_deadline;
	$drop_deadline->set_time_zone($tz);

	my $script_deadline = $tourn_settings{"script_deadline"};
	$script_deadline = $drop_deadline unless $script_deadline;

	my $release_deadline = $tourn_settings{"release_deadline"};
	$release_deadline = $drop_deadline unless $release_deadline;

</%init>

	<div class="main">

		<& "tabbar.mas",
			school         => $school,
			tourn          => $tourn,
			tourn_settings => \%tourn_settings,
			whoami         => "by_event"
		&>

<%perl>

		if ($tourn_settings{"entry_release"} && $now < $release_deadline) {

			my %release_forms = eval {
				return %{JSON::decode_json($school->setting("release_forms"))};
			};
</%perl>


			<div class="full nospace martopmore rightalign">

				<span class="true marno threequarters leftalign">
					<h5>Release Forms</h5>
				</span>

				<span class="true marno quarter centeralign">
					<a
						class="buttonwhite greentext invert threequarters"
						href="<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn_settings{"entry_release"} %>">
						<span class="inline fa fa-arrow-down"></span> Download Form
					</a>
				</span>

			</div>

			<div class="bordertop bluetext semibold biggish padvertmore centeralign">
				A signed copy of this form is required for every student.
				Download &amp; sign, and then scan &amp; upload below.
			</div>

			<form
				enctype  = "multipart/form-data"
				onsubmit = "return uploadThis()"
				name     = "entry_releases"
				action   = "entry_release_upload.mhtml"
				method   = "post"
			>

			<input
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<input
				type  = "hidden"
				name  = "entry_id"
				value = "<% $entry->id %>"
			>

%			my $count = 1;
%			foreach my $student ($entry->students) {

				<div class="full row nospace">

					<span class="quarter">
						<% $count++ %>.
						<% $student->first %> <% $student->last %>
					</span>

					<span class="half nospace padtop padbottom">

%						if ($release_forms{$student->id}) {

							<span
								class="fa fa-lg fa-check fa-lg greentext fifth centeralign">
							</span>

							<span class="fourfifths">

							<a
								class = "greentext semibold"
								href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$school->id."/".$student->id."/".$release_forms{$student->id} %>"
							> <% $release_forms{$student->id} %> </a>

							</span>

%						} else {
							<span
								class="fa fa-2x fa-times redtext marno marrightmuchmore"
							></span>

							<span class="semibold redtext padvert">
								Not Complete
							</span>
%						}

					</span>

					<span class="true marno quarter centeralign">
						<div class="uploader thinner">

							<input
								type     = "file"
								name     = "entry_release_<% $student->id %>"
								style    = "opacity: 0;"
								onchange = "uploaderName(
									'entry_release_<% $student->id %>',
									'entry_release_<% $student->id %>_file'
								)"
								id       = "entry_release_<% $student->id %>"
							>

							<span
								id  = "entry_release_<% $student->id %>_file"
								class = "filename"
								style = "-webkit-user-select: none;"
							>Upload File</span>

							<span
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>
						</div>

					</div>

				</span>

%			}

			<div class="libl full marno rightalign">
				<span class="true marno quarter centeralign">
					<input
						type  = "submit"
						class = "threequarters"
						value = "Upload Form"
					>
				</span>
			</div>

			</form>
%		}

		<form action="details_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "entry_id"
			value = "<% $entry->id %>"
		>

		<input
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input
			type  = "hidden"
			name  = "from"
			value = "<% $from %>"
		>

%		unless ($now > $drop_deadline) {

		<h5>Entry Details</h5>

%		unless ($tourn_settings{"hide_codes"}) {

			<div class="row borderbottom">

				<span
					class="half semibold
						<% ($code_style eq "register" || $code_style eq "initials") ? "required" : "" %>">
						Entry Code
				</span>

				<span class="half padvert semibold bluetext">

%					if ($code_style eq "initials"
%						|| $code_style eq "register"
%						|| $code_style eq "full_initials") {


						<input
							type  = "text"
							size  = "32"
							name  = "code"
							value = "<% $entry->code %>"
						>

%					} else {

						<span class="padvert">
							<% $entry->code %>
						</span>

%					}
				</span>
			</div>

%		}

%			foreach my $count (1 .. $max) {

<%perl>

				my $student = shift @students if @students;

				my $hybrid = Tab::School->search(
					chapter => $student->chapter->id,
					tourn   => $tourn->id
				)->first

					if $student
						&& $student->chapter
						&&  $student->chapter->id != $school->chapter->id;

</%perl>
				<div class="row">

					<span class="<% $count > $min ? "" : "required" %> half semibold"
						>Competitor <% $max > 1 ? $count : "" %>
						<% $hybrid ? "(".$hybrid->name.")" : "" %>
					</span>

					<span class="half padvert">

						<select name="student_<% $count %>" class="fixedbig">

%							if ($student) {
								<option value="<% $student->id %>"
									><% $person->site_admin
										? $student->id." "
										: ""
									%><% $student->first." ".$student->last %> </option>
%							}

							<option value="">NONE</option>
<%perl>
							if ($hybrid) {

								foreach my $student (
									$m->comp(
										"/funclib/students_evententer.mas",
										event  => $event,
										school => $hybrid
									)
								) {
</%perl>
									<option
										value="<% $student->id %>"
									><% $person->site_admin ? $student->id." " : "" %><% $student->first." ".$student->last %> </option>
%								}

%							} else {

%								foreach my $student (@clear_students) {
									<option
										value="<% $student->id %>"
									><% $person->site_admin ? $student->id." " : "" %><% $student->first." ".$student->last %> </option>
%								}

%							}

						</select>

					</span>

				</div>

%				$count++;

%			}

%			if ($event_settings{"apda"}) {

				<div class="row">

					<span class="half">
						Prelim Seeding
					</span>

					<span class="half martop">

						<select name="seed" class="fixedsmall">

							<option value="">None</option>

							<option
								value="half"
								<% $entry_settings{"registered_seed"} eq "half" ? "selected" : "" %>
							>Half</option>

							<option
								value="full"
								<% $entry_settings{"registered_seed"} eq "full" ? "selected" : "" %>
							>Full</option>

							<option
								value="free"
								<% $entry_settings{"registered_seed"} eq "free" ? "selected" : "" %>
							>Free</option>

						</select>
					</span>

				</div>

%			}

			<label for="ada">

				<div class="row hover">

					<span class="half semibold">
						ADA/Accessible Rooms Needed
					</span>

					<span class="half padvert">
						<input
							type  = "checkbox"
							class = "largecheck"
							id    = "ada"
							name  = "ada"
							value = "1" <% $entry->ada ? "checked" : "" %>>
					</span>

				</div>
			</label>

<%perl>
			if ($event_settings{"waitlist_rank"} && $entry->waitlist) {

				my @waitlisted = $school->entries(
					event    => $event->id,
					waitlist => 1
				);

				my $selected = $entry->setting("waitlist_rank");

</%perl>

				<div class="row">

					<span class="half semibold">
						Order of waitlist admissions
					</span>

					<span class="half nospace padvert">
%						foreach my $order (1 ... scalar @waitlisted) {
							<label>
								<span class="padvertless padleftmore padrightmore hover">
									<input
										type  = "radio"
										name  = "waitlist_rank"
										value = "<% $order %>"
										id    = "<% $order %>"
										<% $order == $selected ? 'checked="checked"' : "" %>
									>
									<% $order %>
								</span>
							</label>
%						}
					</span>

				</div>

%			}
%			}

%			if ($now < $script_deadline) {
%			if ($event_settings{"ask_for_bibliography"}) {

				<& "/funclib/editor.mas" &>

				<h5 class="martopmore">
					Pieces, titles, &amp; publication bibliography
				</h5>

				<div class="row centeralign">
					<textarea
						rows  = "7"
						cols  = "65"
						class = "full"
						name = "bibliography"
					><% $entry_settings{"bibliography"} %></textarea>
				</div>
%			}

<%perl>

				if ($tourn_settings{"nsda_nats"}
					|| $tourn_settings{"nsda_ms_nats"}
					|| $tourn_settings{"nsda_district"}
				) {

					if ($event_settings{"ask_for_titles"}) {
</%perl>

							<h5 class="martopmore">
								Piece/title information
							</h5>

							<div class="row">

								<span class="required half semibold">
									Piece/speech title
								</span>

								<span class="half">
									<input
										type  = "text"
										name  = "title"
										value = "<% $entry_settings{"title"} %>"
										size  = "40"
									>
								</span>

							</div>

%							if ($event_settings{"ask_for_authors"}) {

								<div class="row">

									<span class="required half semibold">
										Author
									</span>

									<span class="half">
										<input
											type  = "text"
											name  = "author"
											value = "<% $entry_settings{"author"} %>"
											size  = "40"
										>
									</span>

								</div>

								<p class="semibold redtext centeralign martopmore biggish">
									You must fill out either the Print or Digital
									publication information:
								</p>

								<span class="pagehalf nospace">

								<p class="semibold centeralign bluetext">
									Print Publications
								</p>

								<div class="row">

									<span class="twofifths">
										Publisher
									</span>

									<span class="threefifths">
										<input
											type  = "text"
											name  = "publisher"
											value = "<% $entry_settings{"publisher"} %>"
											size  = "24"
										>
									</span>

								</div>

								<div class="row">

									<span class="twofifths">
										Publication Year
									</span>

									<span class="threefifths">
										<input
											type  = "text"
											name  = "publish_date"
											value = "<% $entry_settings{"publish_date"} %>"
											size  = "24"
										>
									</span>

								</div>

								<div class="row">

									<span class="twofifths">
										ISBN Number
									</span>

									<span class="threefifths">
										<input
											type  = "text"
											name  = "publish_isbn"
											value = "<% $entry_settings{"publish_isbn"} %>"
											size  = "24"
										>
									</span>

								</div>

								</span>
								<span class="pagehalf nospace marleft">

								<p class="semibold centeralign bluetext">
									Digital (Online) Publication:
								</p>

								<div class="row">

									<span class="twothirds">
										Date the web page was printed:
									</span>

									<& /funclib/datepicker.mas, id => "publish_print_date" &>

%									my $publish_print_date = $entry_settings{"publish_print_date"};

									<span class="third rightalign">
										 <input
											type  = "text"
											name  = "publish_print_date"
											id    = "publish_print_date"
											size  = "8"
											value = "<% Tab::pickerdate($publish_print_date) %>"
										>
									</span>

								</div>

								<div class="row">

									<span class="quarter">
										URL/Address:
									</span>

									<span class="threequarters rightalign">
										<input
											type        = "url"
											name        = "publish_url"
											value       = "<% $entry_settings{"publish_url"} %>"
											size        = "32"
											placeholder = "Script first page if multi-page"
										>
									</span>

								</div>

								</span>

<%perl>
							}

					}

				} else {

					if ($event_settings{"ask_for_titles"}) {
</%perl>

						<div class="row">

							<span class="required half">
								Piece title:
							</span>

							<span class="half">
								<input
									type  = "text"
									name  = "title"
									value = "<% $entry_settings{"title"} %>"
									size  = "40">
							</span>

						</div>
%					}

%					if ($event_settings{"ask_for_authors"}) {

						<div class="row">

							<span class="required half">
								Piece author
							</span>

							<span class="half">
								<input
									type  = "text"
									name  = "author"
									value = "<% $entry_settings{"author"} %>"
									size  = "40">
							</span>

						</div>
<%perl>

					}
				}
			}

			if ($now < $drop_deadline) {

				my $quals = $event_settings{'ask_quals'};
				my $required = $quals;
				$quals = 15 if $event_settings{"more_quals"};

				if ($quals) {
</%perl>

					<div class="full nospace martopmore">
						<span class="pagehalf nospace">
							<h5>Qualifiers</h5>
						</span>

						<span class="pagehalf rightalign nospace">
							<h5><% $required %> Required</h5>
						</span>

					</div>

%					if ($event_settings{"at_larges"}) {

						<label for="at_large">
							<div class="row hover">

								<span class="half rightalign padtopmore padbottommore">
									At-large applicant?
								</span>

								<span class"third">
									<input
										id    = "at_large"
										type  = "checkbox"
										class = "largecheck"
										name  = "atlarge"
										value = "1"
										<% $entry && $entry_settings{"atlarge"} ? 'checked="checked"' : "" %>
									>
								</span>

							</div>
						</label>

%					}

					<div class="yellowrow martop strong smallish">

						<span class="fifth">
							Qualifier
						</span>

						<span class="twofifths">
							Tournament
						</span>

						<span class="twofifths">
							Finish/Points
						</span>

					</div>

%					my @qualifiers = $entry->qualifiers;

%					foreach my $tick (1 .. $quals) {

%						my $qual = shift @qualifiers if @qualifiers;

						<div class="row">

							<span class="fifth <% $tick > $required ? "" : "required" %>">
								Qualifier <% $tick %>
							</span>

							<span class="twofifths">
								<input
									type="text"
									name="qual_<% $tick %>"
									value="<% $qual ? $qual->name : "" %>"
									size="24"
								>
							</span>

							<span class="twofifths">
								<input
									type="text"
									name="qualpts_<% $tick %>"
									value="<% $qual ? $qual->result : "" %>"
									size="24"
								>
							</span>

						</div>

%					}

%				}
%			}


			<div class="liblrow rightalign">
				<span class="true marno quarter centeralign">
					<input
						type  = "submit"
						class = "threequarters"
						value = " Save Entry Details "
					>
				</span>
			</div>

		</form>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Entry</h4>

%			if ($entry->waitlist) {
				<span class="centeralign full bigger redtext semibold borderredthin marbottommore">
					On Waitlist
				</span>
%			}

			<div class="row full marno bigger">
				<span class="quarter semibold">
					Name:
				</span>
				<span class="threequarters">
					<% $entry->name %>
				</span>
			</div>

			<div class="row full marno bigger">
				<span class="quarter semibold">
					Code:
				</span>
				<span class="threequarters">
					<% $entry->code %>
				</span>
			</div>

			<div class="row full marno bigger">
				<span class="quarter semibold">
					Event:
				</span>
				<span class="threequarters">
					<% $event->name %>
				</span>
			</div>

			<div class="full centeralign">
				<a
					class="bluetext buttonwhite button martopmore centeralign invert bigger"
					href="students.mhtml?school_id=<% $school_id %>&event_id=<% $event->id %>">
					Return to entry
				</a>
			</div>

		</div>



	</div>

