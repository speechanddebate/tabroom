<%args>
	$school
	$category_id => undef
	$judge_id    => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	my %judge_settings;
	%judge_settings = $judge->all_settings() if $judge;

	my $category;

	if ($judge) { 
		$category = $judge->category();
	} elsif ($category_id) { 
		$category = Tab::Category->retrieve($category_id);
	}

	unless ($category) { 
		my $err = "Something went wrong: no valid judge or judge category sent?";
		$m->redirect("judges.mhtml?school_id=".$school->id."&err=$err");
	}

	my %category_settings = $category->all_settings();

	if ($judge && 
		(	
			($judge->school->id != $school->id)
			&& ($school->id != $judge->setting('original_school'))
		)
	) { 
		my $err = "That judge does not belong to your school.";
		$m->redirect("judges.mhtml?school_id=".$school->id."&err=$err");
	}

	my @alreadys = $school->judges;

	my %already = map { $_->chapter_judge->id => $_ } @alreadys;

	my %already_nsda = ();
								
	foreach my $already (@alreadys) { 

		if ($already->person) { 
			$already_nsda{$already->person->nsda} = $already;
		} 
		
		if ($already->chapter_judge && $already->chapter_judge->nsda) { 
			$already_nsda{$already->chapter_judge->nsda} = $already;
		}
	}

	my @paradigms = ("LDParadigm", "PolicyParadigm");

	my @jpools;
	my %options;
	my %jpool_settings;
	my %in_jpools;
	my %nomination;

	if ($judge && $category_settings{"nats_category"}) { 

		@jpools = $m->comp(
			"/funclib/category_jpools.mas",
			category => $category,
			limit    => "registrant"
		);

		%jpool_settings = $m->comp(
			"/funclib/jpool_settings.mas",
			category => $category
		);

		%in_jpools = map {$_->id => $_} $judge->jpools();

		foreach my $jpool (@jpools) { 

			$options{"parli"} .= " ".$jpool->id
				if $jpool_settings{$jpool->id}{"parli"};

			$options{"double"} .= " ".$jpool->id
				if $jpool_settings{$jpool->id}{"parli"};

			$options{"prefer"} .= " ".$jpool->id
				if $jpool_settings{$jpool->id}{"prefer"};

			$options{$jpool_settings{$jpool->id}{"paradigm_form"}} .= " ".$jpool->id;

			$options{$jpool_settings{$jpool->id}{"paradigm_form"}."_name"} =  $jpool->name;

		}

		%nomination = eval {
			return %{JSON::decode_json($judge->setting("nomination")) };
		};

	}

	my $tourn = $school->tourn;

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline = $tourn->setting("drop_deadline") unless $judge_deadline;

	my $now = DateTime->now();

	my $closed;
	$closed++ if $now > $judge_deadline;

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Judging</h4>

%			unless ($closed) { 
				<a 
					href="judge_edit.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>"
					class="full blue martop marbottom"
				>Add another judge</a>
%			}

			<a 
				href="judges.mhtml?school_id=<% $school->id %>"
				class="full blue martop marbottom"
			>Return to Judge Roster</a>

		</div>

%		if ($judge) { 

%			if ($judge_settings{"incomplete"}) { 
			
				<div class="sidenote">
				
					<p class="semibold marbottom redtext bigger centeralign">
						Registration Incomplete:
					</p>

					<% $judge_settings{"incomplete"} %>

				</div>
%			}

			<div class="sidenote">

				<h4>Conflicts</h4>

				<p class="semibold redtext nospace marbottom">
					Mark conflicts of schools you previously coached, etc, which you 
					should not judge:
				</p>

				<a class="yellow full"
					href="judge_conflicts.mhtml?school_id=<% $school->id %>&judge_id=<% $judge_id %>"
				>Judge School Conflicts</a>


				<h4>Questionnaires</h4>

				<p class="semibold nospace marbottom">
					These questionnaires may be filled out by the judges themselves
					if you have them linked to a Tabroom.com account, or you can
					fill them out here.
				</p>

				<div class="nospace martopmore">
					<span class='half nospace'>
						<h6>Demographics</h6>
					</span>
					<span class='half bigger italic rightalign semibold bluetext'>
						Optional
					</span>
				</div>

				<p class="explain smaller marno marbottom">
					In order to assess and promote diversity in judging panels,
					we request all judges fill out the diversity questionnaire.
				</p>

				<div class="centeralign nospace">
					<a 
						href="questionnaire.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>&tag=NSDADiversity"
						class="buttonwhite bluetext invert bigger"
						target="_blank"
					>Diversity Questionnaire</a>
				</div>

%				foreach my $paradigm (@paradigms) { 

					<div class="martopmore bordertop options <% $options{$paradigm} %>">

						<span class='half nospace'>
							<h6>Paradigm</h6>
						</span>
						<span class='half bigger italic rightalign semibold redtext'>
							Required
						</span>

						<p class="explain smaller marno marbottom">
							All judges are required to fill out this paradigm form
							by May 1st.  Judges who are linked on Tabroom may fill
							it out themselves; otherwise fill it in for them here.
						</p>

						<div class="centeralign nospace">
							<a 
								href   = "questionnaire.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>&tag=<% $paradigm %>"
								class  = "buttonwhite bluetext bigger invert"
								target = "_blank"
							><% $options{$paradigm."_name"} %> Paradigm</a>
						</div>
					</div>
%				}
			</div>
%		}

	</div>


	<div class="main">

		<& "../tabbar.mas", 
			school => $school, 
			whoami => "judges"
		&>

%		if ($now > $judge_deadline) { 
			<p class="centeralign semibold redtext bigger martopmore">
				The deadline for changing judging has passed.  You may still edit
				questionnaires or paradigms. 
			</p>
%		}

		<span class="half nospace">
			<h5><% $judge 
				? $judge->first." ".$judge->last 
				: "Add a judge" 
			%></h5>
		</span>

%		if ($judge && $judge_settings{"incomplete"}) { 
			<span class="quarter rightalign redtext semibold">
				INCOMPLETE
			</span>
%		} elsif ($judge) { 
			<span class="quarter rightalign greentext semibold">
				COMPLETE
			</span>
%		}

		<span class="quarter rightalign bluetext semibold">
			<% $category->name %>
		</span>

%		unless ($closed) { 
			<form action="judge_save.mhtml" method="post">
%		}

		<input	
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge %>"
		>

		<input	
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input	
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>"
		>

		<span class="pagehalf">
			
%			unless ($judge) { 
				<div class="row centeralign redtext semibold padvertoption">
					For a judge not in our systems:
				</div>
%			}

			<div class="row">

				<span class="fifth semibold padleftmore">
					First
				</span>

				<span class="threequarters">	
					<input 
						type  = "text"
						name  = "first"
						size  = "32"
						<% $closed ? "disabled" : "" %>
						value = "<% $judge ? $judge->first : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Last
				</span>

				<span class="threequarters">	
					<input 
						type  = "text"
						name  = "last"
						<% $closed ? "disabled" : "" %>
						size  = "32"
						value = "<% $judge ? $judge->last : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Phone
				</span>

				<span class="threequarters">	
					<input 
						type  = "tel"
						name  = "phone"
						size  = "32"
						<% $closed ? "disabled" : "" %>
						value = "<% $judge && $judge->person 
								? Tab::phoneme($judge->person->phone)
								: Tab::phoneme($judge_settings{"phone"}) %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Email
				</span>

				<span class="threequarters">
					<input 
						type  = "email"
						name  = "email"
						size  = "32"
						<% $closed ? "disabled" : "" %>
						value = "<% $judge && $judge->person 
								? $judge->person->email
								: $judge_settings{"email"} %>"
					>
				</span>
			</div>

		</span>

		<span class="pagehalf">

%			unless ($judge) { 
				<div class="row centeralign redtext semibold padvertoption">
					Or, select all that apply to this judge:
				</div>
%			}

			<div class="row">

				<span class="third semibold padleft">
					Tabroom judge
				</span>

				<span class="twothirds centeralign">
					<select 
						name  = "chapter_judge_id"
						class = "fixedbiggish"
						<% $closed ? "disabled" : "" %>
					>
						
					<option value=""></option>

%					if ($judge) { 
						<option 
							value="<% $judge->id %>"
							selected="selected"
						><% $judge->first." ".$judge->last %></option>
%					}
<%perl>
					foreach my $chapter_judge (
						$school->chapter->chapter_judges(retired => 0)
					) { 

						next if $already{$chapter_judge->id};
					
</%perl>
						<option 
							value="<% $chapter_judge->id %>"
							<% $judge 
								&& $chapter_judge->id == $judge->chapter_judge->id 
								? 'selected="selected"'
								: ""
						%>><% $chapter_judge->first." ".$chapter_judge->last %></option>
%					}

					</select>
				</span>

			</div>

			<div class="row">

				<span class="third semibold padleft">
					NSDA Coach:
				</span>

				<span class="twothirds centeralign">

					<select 
						name  = "nsda"
						class = "fixedbiggish"
						<% $closed ? "disabled" : "" %>
					>
						<option value=""></option>
						<option value="0">None</option>

%						if ($judge && $judge->chapter_judge && $judge->chapter_judge->nsda) { 
							<option 
								selected="selected"
								value="<% $judge->chapter_judge->nsda %>"
							><% $judge->first." ".$judge->last %> (#<% $judge->chapter_judge->nsda %>)</option>
<%perl>
						}

					foreach my $coach (
						$m->comp(
							"/funclib/nsda_school_coaches.mas",
							school => $school
						)
					) { 

</%perl>
						<option 
							value="<% $coach->user_id %>"
							<% $judge 
								&& $judge->chapter_judge 
								&& $judge->chapter_judge->nsda == $coach->user_id
								? 'selected="selected"'
								: "" 
							%>
						><% $coach->ufname." ".$coach->ulname %> (#<% $coach->user_id %>)</option>
%					}

					</select>
				</span>
			</div>

			<div class="row">
				<span class="third semibold padleft">
					Tabroom email:
				</span>

				<span class="twothirds centeralign">
					<input 
						type        = "email"
						name        = "tabroom_email"
						size        = "32"
						placeholder = "Email used for a Tabroom.com account"
						<% $closed ? "disabled" : "" %>
						value = "<% $judge && $judge->person
							? $judge->person->email 
							: ""
						%>"
					>
				</span>
			</div>

%			if ($judge_settings{"diamonds"} || $judge_settings{"tab_room"}) { 
				<div class="row semibold centeralign">
%					if ($judge_settings{"diamonds"}) { 
						<span class='half padsetting bluetext'>
							<% $judge_settings{"diamonds"} %>
							<% $judge_settings{"diamonds"} > 1 ? "Diamonds" : "Diamond" %> coach
						</span>
%					}
%					if ($judge_settings{"tab_room"}) { 
						<span class='half padsetting purpletext'>
							Tab Room Staff
						</span>
%					}
				</div>
%			}

		</span>

<%perl>

		if ($judge && $category_settings{"nats_category"}) { 

			my $max_rounds = $category_settings{"max_rounds"};
			$max_rounds = 10 if $judge_settings{'tab_room'};
			$max_rounds = 8 unless $max_rounds;

</%perl>

			<h5 class="martopmore">Category Information</h5>

			<div class="row">

				<span class="quarter semibold padleftmore">
					Round Committment
				</span>
				<span class="eighth marno">
					<input 
						type  = "number"
						value = "<% $judge->obligation %>"
						name  = "obligation"
						<% $closed ? "disabled" : "" %>
						min   = "0"
						max   = "<% $max_rounds %>"
					>
				</span>

%				if ($judge_settings{"tab_room"}) { 
					<span class="fiveeighths marno semibold bluetext">
						Tab service provides 10 rounds of judging OR a $100 honorarium.
					</span>
%				} else { 
					<span class="fiveeighths centeralign semibold options <% $options{"parli"} %>">
						Note: a Congress session fulfills 2 rounds of obligation
					</span>
%				} 

			</div>

			<div class="full row nospace">

			<label for="diverse">
				<span class="half hover padleftmore">
					<span class="fourfifths semibold">
						Identify as a diversity-enhancing judge
					</span>
					<span class="sixth centeralign">
						<input 
							type  = "checkbox"
							name  = "diverse"
							value = "1"
							id    = "diverse"
							<% $closed ? "disabled" : "" %>
							<% $judge->setting("diverse") 
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</span>
			</label>

			</div>

			<div class="row">

				<span class="fifth padleftmore semibold">
					Judge Event Pools:
				</span>

				<span class="fourfifths nospace">
								
%					if ($judge_settings{"tab_room"}) {
						<div class="padvert purpletext semibold full centeralign">
							Tab room staff may not fulfill obligations in Policy or PF
						</div>
%					}
			
%				foreach my $jpool (@jpools) { 

					<label for="<% $jpool->id %>">
						<span 
							class = "third hover bordertop marno"
							title = "<% $jpool->name %>"
						>
							<span class="threequarters nowrap">
								<% $jpool->name %>
							</span>
							<span class="fifth marno padless centeralign">
							<input 
								type     = "checkbox"
								class    = "jpools"
								name     = "<% $jpool->id %>"
								id       = "<% $jpool->id %>"
								value    = 1
								<% $closed ? "disabled" : "" %>
								<% $judge_settings{"tab_room"} 
									&! $jpool->setting("hire") 
									? "disabled"
									: ""
								%>
								onChange = "revealOptions();"
								<% $in_jpools{$jpool->id} ? 'checked="checked"' : "" %>
							>
							</span>
						</span>
					</label>
%				}

				</span>

			</div>

			<div class="martopmore nospace hidden full options <% $options{"parli"} %> <% $options{"prefer"} %>">

				<h6>Congress options:</h6>

				<div class="row full marno">

					<label for="parli">
						<span class="options half nospace <% $options{"parli"} %> hover">
							<span class="fourfifths">
								Qualified parliamentarian: 
							</span>
							<span class="fifth">
								<input 
									type  = "checkbox"
									name  = "parli"
									value = "1"
									id    = "parli"
									<% $judge->setting("parli") 
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</span>
					</label>

					<label for="prefers_congress">
						<span class="options half nospace <% $options{"prefer"} %> hover">
							<span class="fourfifths">
								Would prefer to judge Congress:
							</span>
							<span class="fifth">
								<input 
									type  = "checkbox"
									name  = "prefers_congress"
									value = "1"
									id    = "prefers_congress"
									<% $judge->setting("prefers_congress") 
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</span>
					</label>
				</div>
			</div>

			<div class="martopmore nospace full">

				<h6>Finals/semifinals self nominations</h6>

				<p class="semibold">
					New this year: we will be accepting self-nominations from
					coaches/judges to judge semifinals and final rounds.
					Please understand this will not guarantee you are pooled
					for a semi/final round.  Please be certain you will be at
					the tournament on Wednesday, Thursday &amp; Friday; if you
					self-nominate, are pooled for a semi or final, and do not
					appear, that will constitute a bond forfeiture. 
				</p>

%				if ($nomination{"chair_nominated"}) {
					<div class="full centeralign semibold redtext">
						You were nominated to judge semis or finals by your District Chair.  Please
						contact your chair if this is in error. 
					</div>
%				} 

				<label for="self_nominated">

					<div class="full row marno martopmore hover">

						<span class="threefifths semibold bluetext bigger">
							I would like to be considered to judge a semi or final:
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								name  = "self_nominated"
								id    = "self_nominated"
								value = "1"
								<% $closed ? "disabled" : "" %>
								<% $nomination{"self_nominated"} 
									? 'checked="checked"'
									: ""
								%>
							>
						</span>
					</div>
				</label>

				<div class="full row marno">

					<span class="half semibold">
						Phonetic pronuncation guide to your name:
					</span>

					<span class="half">
						<input 
							type  = "text"
							name  = "phonetic"
							size  = "48"
							<% $closed ? "disabled" : "" %>
							value = "<% $nomination{"phonetic"} %>"
						>
					</span>

				</div>

				<div class="full row marno">

					<span class="twofifths semibold">
						Brief bio for introductions:
					</span>

					<span class="threefifths">
						<input 
							type  = "text"
							name  = "bio"
							size  = "64"
							<% $closed ? "disabled" : "" %>
							value = "<% $nomination{"bio"} %>"
						>
					</span>

				</div>
<%perl>

#				I should make this dynamic but right now I give zero fucks

				my @types = (
					"Policy",
					"LD",
					"PF",
					"Congress",
					"Address IEs",
					"Interp IEs",
					"Big Questions",
					"Worlds Debate"
				);

</%perl>

				<div class="full row marno">

					<span class="semibold third">
						Which events would you be best suited to judge?
					</span>

					<span class="twothirds nospace">
%						foreach my $type (@types) { 
							<label for="<% $type %>">
								<span class="third hover nospace padleft">

									<span class="fourfifths">
										<% $type %>
									</span>
	
									<span class="fifth">
										<input 
											type  = "checkbox"
											name  = "<% $type %>"
											id    = "<% $type %>"
											value = 1
											<% $closed ? "disabled" : "" %>
											<% $nomination{"type"}{$type} ? 'checked="checked"' : "" %>
										>
									</span>

								</span>
							</label>

%						}
					</span>

				</div>

				<div class="full row marno">

					<& "/funclib/editor.mas" &> 

					<div class="semibold full nospace martopmore marbottom">
						Please list supporting information/details for us to
						consider in pooling you for semis and finals.
					</div>

					<div class="semibold full nospace centeralign">

%						if ($closed) { 
							<% $nomination{"text"} %>
%						} else { 
							<textarea
								name    = "text"
								rows    = 5
								columns = 70
							><% $nomination{"text"} %></textarea>
%						} 

					</div>

				</div>
						
			</div>

%		}

%		unless ($closed) { 
			<div class="full libl rightalign marvertno marno">
				<input 
					type="submit"
					value="<% $judge ? "Save Judge" : "Add Judge" %>"
				>
			</div>
%		}


	</div>

	<script> 

		function revealOptions() { 

			$(".options").addClass("hidden");

			$(".jpools:checked").each(function(jpoolbox) { 

				console.log("One is checked: "+this.id);

				$("."+this.id).removeClass('hidden');
			});

		}

		$(document).ready(function() {
			revealOptions();
		});

	</script>
