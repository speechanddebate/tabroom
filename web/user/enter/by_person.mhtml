<%args> 
	$school
	$person
	$event_id => undef
</%args>
<%init>

	my $tourn = $school->tourn;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
    my $now = DateTime->now;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("

		select entry_student.id, entry.id, entry.code, entry.name, entry.waitlist, entry.dropped, entry.school,
				student.id, student.chapter, student.first, student.last, student.ualt_id, chapter.name,
				event.name, event.abbr, event.id, hybrid.name, partner.first, partner.last

		from (entry_student, entry, student, event, school)

		left join chapter on chapter.id = student.chapter

		left join school hybrid on entry.school = hybrid.id

		left join entry_student pes 
			on pes.entry = entry.id 
			and pes.student != student.id

		left join student partner on partner.id  = pes.student

		where school.id = ? 
			and school.chapter = student.chapter
			and entry.tourn = school.tourn
			and entry.id = entry_student.entry
			and entry_student.student = student.id
			and entry.event = event.id
			and entry.unconfirmed = 0

			group by entry_student.id
			order by student.last, student.first

	");

	$sth->execute($school->id);

	my %students = ();
	my %entries = ();

	while (my (
		$entry_student_id, 
			$entry_id, $entry_code, $entry_name, $entry_waitlist, $entry_dropped, $entry_school,
			$student_id, $student_chapter, $student_first, $student_last, $student_nsda, $student_chapter_name,
			$event_name, $event_abbr, $event_id, $hybrid_name, $partner_first, $partner_last
		)  = $sth->fetchrow_array() 
	) {

		unless ($students{$student_id}{"name"}) { 
			$students{$student_id}{"name"} = $student_first." ".$student_last;
			$students{$student_id}{"last"} = $student_last;
			$students{$student_id}{"nsda"} = $student_nsda;
			$students{$student_id}{"chapter"} = $student_chapter;

			$students{$student_id}{"hybrid"} = $student_chapter_name 
				if $student_chapter != $school->chapter;

		}

		unless ($entries{$entry_id}{"code"}) { 

			$entries{$entry_id}{"code"} = $entry_code;
			$entries{$entry_id}{"name"} = $entry_name;
			$entries{$entry_id}{"dropped"} = $entry_dropped;
			$entries{$entry_id}{"waitlist"} = $entry_waitlist;

			$entries{$entry_id}{"event_id"} = $event_id;
			$entries{$entry_id}{"event_name"} = $event_name;
			$entries{$entry_id}{"event_abbr"} = $event_abbr;

			if ($entry_school != $school->id) { 
				$students{$student_id}{"hybrid_name"} = $hybrid_name." ";
				$students{$student_id}{"hybrid_name"} .= $partner_first." ".$partner_last;
			}

		}

		push @{$entries{$entry_id}{"students"}}, $student_id;
		push @{$students{$student_id}{"entries"}}, $entry_id;

	}

	my @unregistered_students = 
		sort {$a->last cmp $b->last} 
			$school->chapter->students( retired => 0 );

	my $school_year  = Tab::school_year();
	my $add_deadline = $tourn->reg_end;
	$add_deadline->set_time_zone($tz);

	my $drop_deadline = $tourn->setting("drop_deadline");
	$drop_deadline    = $add_deadline unless $drop_deadline;
	$drop_deadline->set_time_zone($tz);

	my $freeze_deadline = $tourn->setting("freeze_deadline");
	$freeze_deadline    = $add_deadline unless $freeze_deadline;
	$freeze_deadline->set_time_zone($tz);


</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Deadlines</h4>

			<div class="lightrow">

				<span class="quarter">
					Adds
				</span>

				<span class="twofifths">
					<% Tab::niceshortdayte($add_deadline) %>
				</span>

				<span class="fifth rightalign">
					<% Tab::shorttime($add_deadline) %>
				</span>

				<span class="sixth">
					<% Tab::tzname($tz) %>
				</span>
			</div>

			<div class="lightrow">

				<span class="quarter">
					Drops
				</span>

				<span class="twofifths">
					<% Tab::niceshortdayte($drop_deadline) %>
				</span>

				<span class="fifth rightalign">
					<% Tab::shorttime($drop_deadline) %>
				</span>

				<span class="sixth">
					<% Tab::tzname($tz) %>
				</span>
			</div>

			<div class="lightrow">

				<span class="quarter">
					Changes
				</span>

				<span class="twofifths">
					<% Tab::niceshortdayte($drop_deadline) %>
				</span>

				<span class="fifth rightalign">
					<% Tab::shorttime($drop_deadline) %>
				</span>

				<span class="sixth">
					<% Tab::tzname($tz) %>
				</span>

			</div>

			<div class="lightrow">

				<span class="quarter smaller">
					Fees
					Freeze
				</span>

				<span class="twofifths">
					<% Tab::niceshortdayte($freeze_deadline) %>
				</span>

				<span class="fifth rightalign">
					<% Tab::shorttime($freeze_deadline) %>
				</span>

				<span class="sixth">
					<% Tab::tzname($tz) %>
				</span>

			</div>


		</div>

		<div class="sidenote">

			<h4>Entry Totals</h4>

<%perl>
			foreach my $event ($tourn->events) { 

				my @entries = $school->entries( 
					event       => $event->id,
					tba         => 0,
					unconfirmed => 0
				);

				my @tba = $school->entries( 
					event       => $event->id,
					tba         => 1,
					unconfirmed => 0
				);

</%perl>

				<div class="row full marno">

					<span class="third">
						<% $event->abbr %>
					</span>

					<span class="quarter">
						<% scalar @entries %>
					</span>

					<span class="third">
						<% @tba 
							?  "(".scalar @tba." TBA)" :""  %>
					</span>

				</div>

%			}


		</div>

	</div>

	<div class="main">
	
		
		<& tabbar.mas, 
			school => $school,
			whoami => "by_person"
		&>

		<div class="full">

			<span class="quarter">
				<h4>Competitors</h4>
			</span>

%			unless ($now > $add_deadline) { 

				<span class="quarter nospace rightalign">
					New competitor:
				</span>

				<span class="third nospace centeralign">

					<form 
						action="by_person_edit.mhtml" 
						method="post"
					>

						<input 
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<select 
							name        = "student_id"
							class       = "fixedmed"
							onChange    = "this.form.submit();"
						>

							<option value=""></option>

<%perl>

							foreach my $student (@unregistered_students) {

								next if $student->grad_year < $school_year->year;
								next if $students{$student->id};

</%perl>
								<option value="<% $student->id %>"
									><% $student->first." ".$student->last %></option>
%							}

						</select>

					</form>
				</span>
%			}

			<span class="eighth right padtopmore">
				<a 
					href="by_person_print.mhtml?&school_id=<% $school->id %>"
					class="fa-sm fa fa-file-pdf-o button buttonwhite bluetext"
				></a>
				<a 
					href="by_person_csv.mhtml?&school_id=<% $school->id %>"
					class="fa fa-file-excel-o button buttonwhite greentext fa-sm marleftmore"
				></a>
			</span>

		</div>

<%perl>

		foreach my $student_id (
			sort {$students{$a}{"last"} cmp $students{$b}{"last"} } 
			keys %students
		) { 

</%perl>

			<div class="full lightrow padless marno hover">

%				my $url= "by_person_edit.mhtml?student_id=".$student_id."&school_id=".$school->id;

				<span 
					class   = "third padless"
					onClick = "window.location.replace('<% $url %>');"
				>

					<span class="fifth">

						<a 
							href="by_person_edit.mhtml?student_id=<% $student_id %>&school_id=<% $school->id %>"
							class="fa fa-sm button buttonwhite bluetext fa-edit"
						></a>

					</span>

					<span class="fourfifths">
						<% $students{$student_id}{"name"} %>
					</span>

				</span>

				<span 
					onClick = "window.location.replace('<% $url %>');"
					class   = "threefifths"
				>

%					foreach my $entry_id (@{$students{$student_id}{"entries"}}) { 

						<div class="">

							<span class="eighth semibold">
								<% $entries{$entry_id}{"event_abbr"} %>
							</span>

%							if ($entries{$entry_id}{"dropped"}) { 
								<span class="third redtext semibold">
									Dropped
								</span>
%							} elsif ($entries{$entry_id}{"waitlist"}) { 
								<span class="third orangetext semibold">
									Waitlisted
								</span>
%							} else { 
								<span class="third">
									<% $entries{$entry_id}{"code"} %>
								</span>
%							}

							<span class="half">

%								my $notfirst;

%								foreach my $other_id (@{$entries{$entry_id}{"students"}}) { 

%									next if $other_id == $student_id;

									<div class="full padno padleft">
										<% $students{$other_id}{"name"}  %>
										<% $students{$other_id}{"hybrid"} 
											? '<p class="smaller nospace">hybrid: '.$students{$other_id}{"hybrid"}.'</span>' 
											: ""
										%>
									</div>

%								}

								
%								if ($students{$student_id}{"hybrid_name"}) { 
									<span class="smallish inline semibold bluetext">
										Hybrid w/
									</span>
									<span class="smallish inline">
										<% $students{$student_id}{"hybrid_name"} %>
									</span>
%								}
							</span>

						</div>

%					}

				</span>

				<span class="padleft">

<%perl>
					unless ($now > $drop_deadline) { 

						my $warn = "This will drop ".$students{$student_id}{"name"}." from ALL ";
						$warn .= scalar @{$students{$student_id}{"entries"}};
						$warn .= " entries.  Continue only if you are certain!";

</%perl>
						<a 
							href="by_person_drop.mhtml?student_id=<% $student_id %>&school_id=<% $school->id %>"
							class="fa fa-sm buttonwhite redtext fa-trash"
							<& "/funclib/confirm.mas", warn => $warn &>
						></a>

%					}

				</span>

			</div>

%		}

	</div>

