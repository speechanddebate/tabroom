<%args>
	$person
	$person_settings
	$now
</%args>
<%init>

	foreach my $tag ("paradigm_guidelines", "paradigm_word_limit_guidelines") {

		my $text = $m->comp("/funclib/save_editor.mas", text => $ARGS{$tag});

		my $object = Tab::TabroomSetting->search(
			tag   => $tag
		)->first;

		if ($text) {
			if ($object) {
				$object->value_text($text);
				$object->update();
			} else {
				Tab::TabroomSetting->create({
					tag        => $tag,
					value      => "text",
					value_text => $text
				});
			}
		} elsif ($object) {
			$object->delete();
		}
	}

	my $err;

	foreach my $tag ('paradigm_word_limit') {

		my $object = Tab::TabroomSetting->search(
			tag => $tag
		)->first;

		if ($ARGS{$tag}) {
			if ($object) {
				$object->value($ARGS{$tag});
				$object->update();
			} else {
				Tab::TabroomSetting->create({
					tag   => $tag,
					value => $ARGS{$tag}
				});
			}
		} elsif ($object) {
			$object->delete();
		}
	}

	foreach my $tag ("paradigm_review_start", "paradigm_review_cutoff", "paradigm_word_limit_deadline") {

		my $dtinfo = $m->comp("/funclib/dtme.mas",
			date  => $ARGS{$tag},
			input => 1,
			tz    => "America/Chicago"
		);

		if ($tag eq "paradigm_review_start" && $dtinfo->{dt} > $now) {
			$m->comp("/funclib/abort.mas",
				message => "You must set the review start in the past or else people will be trapped in a loop forever until that date"
			);
		}

		my $object = Tab::TabroomSetting->search(
			tag => $tag
		)->first;


		if ($dtinfo && $dtinfo->{dt}) {
			if ($object) {
				$object->value_date($dtinfo->{dt});
				$object->update();
			} else {
				Tab::TabroomSetting->create({
					tag        => $tag,
					value      => "date",
					value_date => $dtinfo->{dt}
				});
			}
		} elsif ($object) {
			$object->delete();
		}
	}

	my $msg = "Settings for Paradigm reviews saved";
	$m->redirect("paradigm.mhtml?err=$err&msg=$msg");

</%init>
