<%args>
	$person
	$person_settings
	$district_id
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id);

	my @committee = $district->permissions;

	my $school_year = &Tab::school_year;

	my $start = DateTime::Format::MySQL->parse_datetime(
		$school_year->year."-10-01 23:59:59"
	);

	my $end = DateTime::Format::MySQL->parse_datetime(
		$school_year->year."-12-01 23:59:59"
	);
	
	my $now = DateTime->now();

</%init>

	<& 
		"../menu.mas",
		whoami          => "districts",
		person          => $person,
		person_settings => $person_settings
	&>

	<div class="main">

		<div class="full nospace">

			<span class="twothirds nospace">
				<h2><% $district->name %> District</h2>
			</span>

			<span class="third rightalign nospace">
				<span class="quarter marno">
					<h5>
						<% $district->location %>
					</h5>
				</span>
				<span class="half marno">
					<h5>
						Level <% $district->level %>
					</h5>
				</span>
				<span class="quarter marno">
					<h5>
						<% $district->code %>
					</h5>
				</span>
			</span>

		</div>

		<h4>District Committee</h4>

%			my %committee = $m->comp(
%				"/funclib/district_committee.mas", 
%				district => $district
%			);

			<div class="row ltyellow semibold padvert">

				<span class="sixth">
					Role
				</span>

				<span class="third">
					Name
				</span>

				<span class="third">
					Email
				</span>

			</div>

%			foreach my $role ("chair", "member") { 

%				next unless $committee{$role};

%				foreach my $person (@{$committee{$role}}) { 

					<div class="row">

						<span class="sixth semibold centeralign">
							<% $role eq "chair" ? ucfirst($role) : "" %>
						</span>

						<span class="third">
							<% $person->first." ".$person->last %>
						</span>

						<span class="half">
							<a 
								href="mailto:<% $person->email %>" 
								class="plain hover"
							>
								<% $person->email %>
							</a>
						</span>

					</div>

%				}

%			}

		<h4 class="martopmore">
			<% $school_year->year %>-<% $school_year->year + 1 %> District Tournaments
		</h4>
%		my $setting_tourn = undef;
%		my @tourns = $m->comp("/funclib/district_tourns.mas", district => $district);

%		if (@tourns) { 
%			foreach my $tourn (@tourns) { 

%				my $tz = $tourn->tz;
%				if (!$setting_tourn) {$setting_tourn = $tourn;}
				<div class="row">

					<span class="quarter">
						<% $tourn->name %>
					</span>

					<span class="fiveeighths">
%						foreach my $weekend ($tourn->weekends) { 
							<div class="full marno padless">
								<span class="third">
									<% $weekend->name %>
								</span>
								<span class="third">
									<% $weekend->site ? $weekend->site->name : "" %>
									<% $weekend->city.", ".$weekend->state %>
								</span>
								<span class="third">
									<% 
										Tab::shortdate($weekend->start->set_time_zone($tz)) 
									%>-<% 
										Tab::shortdate($weekend->end->set_time_zone($tz))
									%>
								</span>
							</div>
%						}
					</span>

					<span class="tenth centeralign">
						<a 
							class="fa fa-edit bluetext buttonwhite"
							href="/user/nsda/district_tournament_create.mhtml?district_id=<% $district->id %>"
						></a>
					</span>

				</div>

<%perl>

			} 

		} elsif (
			$person->site_admin 
			|| ($now->epoch > $start->epoch && $now->epoch < $end->epoch)
		) {

</%perl>

			<div class="padvert row centeralign">
				<a 
					class="buttonblue semibold"
					href="/user/nsda/district_tournament_create.mhtml?district_id=<% $district->id %>"
				>
					Create District Tournament
				</a>
			</div>

%		} else { 

			<p class="semibold centeralign padvertmuchmore">
				District tournament information can be entered only between 
					<& "/funclib/showdate.mas", dt => $start, length => "murica" &>
					and 
					<& "/funclib/showdate.mas", dt => $end, length => "murica" &>
			</p>

%		}

%	if ($person->site_admin || $person_settings->{"nsda_admin"}) {
%		if ($setting_tourn){
			<script>
				function notePost(dest,vals){
					$.post(dest,vals).done(function(res,r){
						if(!res.error){
							alertify.message(res.message);
						} else{
							alertify.error(res.message);
						}
					});
				}
			</script>

			<div 
				id		= "nsda_notes"
				class	= "full nospace martop">
				<h4>
					District Tournament Notes (admin only)
				</h4>

					<input type="hidden" id="district_notes_id" name="tourn_id" value="<% $setting_tourn->id %>" />
					<textarea 
						id		= "district_notes_textarea" 
						class 	= "full martop padmore"
						style	= "width:80%;min-height:180px;max-height:480px;"
						name	= "notes"><% $setting_tourn->setting('nsda_notes') %></textarea>
				
					<br>
				
					<input 
						type	= "submit" 
						value	= "save"
						class 	= "thin notfirst"
						onClick= "notePost('district_notes_save.mhtml',{
									tourn_id: $('#district_notes_id').val(),
									notes  	: $('#district_notes_textarea').val()
									});" />
						</span>


			</div>
%		}
%	}



		<div class="full nospace martop">

			<span class="twothirds nospace">
				<h4>
					District Members in Tabroom
				</h4>
			</span>

			<span class="fifth centeralign nospace">
				<a 
					class="buttonwhite bluetext"
					href="district_update.mhtml?district_id=<% $district->id %>"
				>Update District
				</a>
			</span>

			<span 
				id    = "districtroster_buttonarea"
				class = "eighth centeralign nospace topalign">
			</span>
		</div>

		<& "/funclib/tablesorter.mas", table => "districtroster" &>

		<table id="districtroster">

			<thead>
				<tr class="yellowrow">

					<th>
						School
					</th>

					<th>
						Degrees
					</th>

					<th>
						Paid
					</th>

					<th>
						Type
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $chapter ($district->chapters) { 

				<tr>

					<td>
						<% $chapter->name %>
					</td>

					<td>
						<% $chapter->setting("nsda_degrees") %>
					</td>

					<td>
						<% $chapter->setting("nsda_paid") ? "Y" : "N"  %>
					</td>

					<td>
						<% $chapter->setting("nsda_degrees") %>
					</td>

				</tr>

%			}

			</tbody>

		</table>


	</div>

