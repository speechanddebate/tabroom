<%args>
	$person
	$person_settings
	$dbh
	$start => 0
</%args>
<%init>

	my $current_paradigms_sth = $dbh->prepare("
		select
			person.id, person.email, person.first, person.last,
			CONVERT_TZ(person.created_at, '+00:00', 'America/Chicago'),
			CONVERT_TZ(paradigm.timestamp, '+00:00', 'America/Chicago') paradigm_timestamp,
			paradigm.id paradigm,
			paradigm.value_text text,
			email_unconfirmed.value unconfirmed,
			count(distinct judge.id) as judges

		from (person, person_setting paradigm)

			left join judge on judge.person = person.id

			left join person_setting email_unconfirmed
				on email_unconfirmed.person = person.id
				and email_unconfirmed.tag = 'email_unconfirmed'

		where 1=1

			and person.id = paradigm.person
			and paradigm.tag = 'paradigm'
		group by person.id
		order by paradigm.timestamp DESC, person.last, person.first
		LIMIT 500
		OFFSET $start
	");

	my $change_log_sth = $dbh->prepare("
		select
			person.id, person.email, person.first, person.last,
			CONVERT_TZ(log.created_at, '+00:00', 'America/Chicago') created_at,
			log.description

		from (person, change_log log)

		where 1=1
			and log.tag = 'paradigm'
			and person.id = log.person

		order by log.created_at DESC, person.last, person.first
	");

	$current_paradigms_sth->execute();
	$change_log_sth->execute();

	my $currents = $current_paradigms_sth->fetchall_hash();
	my $changes = $change_log_sth->fetchall_hash();

	my @tabs = ("current", "changelog");
	my $default = "current";

	sub count_while {
		my $text = shift;
	    my $num;
   		$num++ while $text =~ /\S+/g;
		return $num;
	}

</%init>

	<div class="main">

		<h4>Paradigm Logs</h4>

		<&
			"/funclib/tabs.mas",
				tabs    => \@tabs,
				default => $default
		&>

		<& "/funclib/tablesorter.mas",
			table => "current_timestamps"
		&>

		<div class="screens current">

			<div class="flexrow">
				<span class="twofifths">
					<h5>Current Paradigms</h5>
				</span>

				<span class = "tenth rightalign padright">
%					if ($start > 0) {
%						my $next_start = $start - 500;
%						$next_start = 0 if $start < 0;
						<a
							class = "buttonwhite fa fa-arrow-left fa-lg greentext"
							href  = "paradigm_log.mhtml?start=<% $next_start %>"
						></a>
%					} else {
						<a
							class = "fa fa-arrow-left graytext"
						></a>

%					}
				</span>

				<span class = "fifth centeralign">
					Showing <% $start + 1 %> to <% $start + 501 %>
				</span>

				<span class = "tenth leftalign padleft">
%					my $next_start = $start + 500;
%					$next_start = 0 if $start < 0;
					<a
						class = "fa fa-arrow-right greentext buttonwhite"
						href  = "paradigm_log.mhtml?start=<% $next_start %>"
					></a>
				</span>

				<span
					class = "fifth rightalign"
					id    = "current_timestamps_buttonarea"
				>
				</span>
			</div>

			<table id="current_timestamps">

				<thead>
					<tr class="yellowrow">
						<th>
							Email
						</th>
						<th>
							First
						</th>
						<th>
							Last
						</th>
						<th title="Approval and review counts as an edit">
							Last Edit (CDT)
						</th>
						<th title="When was their Tabroom email account confirmed?">
							Created
						</th>
						<th title="Is their Tabroom email account confirmed?">
							Confirm
						</th>
						<th title="Number of Times Person has Judged">
							Judged
						</th>
						<th title="Number of Times Person has Judged">
							Words
						</th>
					</tr>
				</thead>

				<tbody>

%					foreach my $ref (@{$currents}) {

%						my $datestring = substr($ref->{created_at}, 0, 10);
%						my $sort_string = $datestring;
%						$sort_string =~ s/-//g;

						<tr id="current_<% $ref->{id} %>">
							<td class="nospace">
								<a
									href   = "/index/paradigm.mhtml?judge_person_id=<% $ref->{id} %>"
									class  = "plain link-underline hover"
									target = "_blank"
								><% $ref->{email} %></a>
							</td>

							<td>
								<% $ref->{first} %>
							</td>

							<td>
								<% $ref->{last} %>
							</td>

							<td
								class = "rightalign padright"
								title = "Approval and review counts as an edit"
							>
								<% substr($ref->{paradigm_timestamp}, 0, 16) %>
							</td>

							<td
								class = "rightalign padright"
								title = "Only recorded after 9/28/25"
							>
								<% $sort_string > '20250928' ? $datestring : "" %>
							</td>

							<td
								class     = "centeralign"
								title     = "Is this Tabroom email account unconfirmed?"
								data-text = "<% $ref->{unconfirmed} || 2 %>"
							>
								<% $ref->{unconfirmed} ? "NO" : "" %>
							</td>
							<td class='rightalign padright'>
								<% $ref->{judges} %>
							</td>

							<td class='rightalign padright'>
								<% count_while($ref->{text}) %>
							</td>
						</tr>
%					}

				</tbody>
			</table>
		</div>

		<& "/funclib/tablesorter.mas",
			table => "change_log"
		&>

		<div class="screens changelog">

			<div class="flexrow">
				<span class="fourfifths">
					<h5>Change Log</h5>
				</span>
				<span
					class="fifth rightalign"
					id="change_log_buttonarea"
				>
				</span>
			</div>

			<table id="change_log">
				<thead>
					<tr class="yellowrow">
						<th>
							Email
						</th>
						<th>
							First
						</th>
						<th>
							Last
						</th>
						<th>
							Date (CDT)
						</th>
						<th>
							Description
						</th>
					</tr>
				</thead>

				<tbody>

%					foreach my $ref (@{$changes}) {

						<tr id="current_<% $ref->{id} %>">
							<td>
								<a
									href   = "/index/paradigm.mhtml?judge_person_id=<% $ref->{id} %>"
									class  = "plain link-underline"
									target = "_blank"
								><% $ref->{email} %></a>
							</td>

							<td>
								<% $ref->{first} %>
							</td>

							<td>
								<% $ref->{last} %>
							</td>

							<td
								class = "rightalign padright"
							>
								<% substr($ref->{created_at}, 0, 16) %>
							</td>

							<td>
								<% $ref->{description} %>
							</td>
						</tr>
%					}

				</tbody>

			</table>
		</div>
	</div>
