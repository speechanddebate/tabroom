<%args>
	$person
	$person_settings
	$target_id    => undef
	$search_last  => undef
	$search_first  => undef
	$search_email => undef
</%args>
<%init>

	my $target = Tab::Person->retrieve($target_id) if $target_id;

	if ($target && (not defined $search_last && not defined $search_email)) {
		$search_last = $target->last;
	}

	my @candidates;

	if ($search_last) {

		if ($search_first) {

			@candidates = Tab::Person->search_where(
				first => { "like", "%".$search_first."%"},
				last => { "like", "%".$search_last."%"}
			);

		} else {

			@candidates = Tab::Person->search_where(
				last => { "like", "%".$search_last."%"}
			);

		}

	}

	if ($search_email) {

		push @candidates, Tab::Person->search_where(
			email => { "like", "%".$search_email."%"}
		);

		my @logins = Tab::Login->search_where(
			username => { "like", "%".$search_email."%"}
		);

		my %already = map {$_->id => 1} @candidates;

		foreach my $login (@logins) {
			push @candidates, $login->person
				unless $already{$login->person->id};
		}


	}

	unshift @candidates, $target if $target;

</%init>

	<script type="text/javascript">

		$(document).ready(function(){
			$("input:checkbox.merge").change(function() {
				var divstring = '#div_' + $(this).attr("id");

				if($(this).is(":checked")) {
					$(divstring).removeClass('green').addClass('dkgreen');
				} else {
					$(divstring).removeClass('dkgreen').addClass('green');
				}

			});

			$("input:radio.merge").change(function() {

				$(".radiomerge").removeClass('dkgreen');
				$(".radiomerge").addClass('green');

				var divstring = '#div_' + $(this).attr("id");
				$(divstring).removeClass('green').addClass('dkgreen');
			});

		});
	</script>

	<div class="main">

%		if ($search_last || $search_email) {

		<h4>Merge Account<% $target ? " with ".$target->email : "s"%></h4>

		<form action="person_merge_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "search_last"
			value = "<% $search_last %>"
		>
		<input
			type  = "hidden"
			name  = "search_first"
			value = "<% $search_first %>"
		>

		<input
			type  = "hidden"
			name  = "search_email"
			value = "<% $search_email %>"
		>

		<input
			type  = "hidden"
			name  = "target_id"
			value = "<% $target_id %>"
		>

%		my %done;

%		@candidates = sort {$a->id cmp $b->id} @candidates;
%		@candidates = sort {uc($a->first) cmp uc($b->first)} @candidates;

%		foreach my $candidate (@candidates) {

%			next if $done{$candidate->id}++;

			<div class="pagefull marno row">

				<span class="twothirds nospace top">

					<span class="half nospace">

						<h6 class=" semibold">
							<% $candidate->first." ".$candidate->last %>
						</h6>

						<p class=" wordwrap semibold bluetext bigger">
							<% $candidate->email %>
						</p>

						<div class="full nospace">
							<span class="quarter top">
								ID <% $candidate->id %>
							</span>

							<span class="quarter top">
								<% $candidate->state %>/<% $candidate->country %>
							</span>

							<span class="half top">
								<% $candidate->nsda ? " NSDA ID: ".$candidate->nsda : "" %>
							</span>

						</div>

%						my $notfirst;

%						foreach my $login ($candidate->logins) {
%							next if $login->username eq $candidate->email;

%							unless ($notfirst++) {
								<h6>Alternate Logins:</h6>
%							}

							<div class="full marno padless smallish padleft">
								<% $login->username %>
							</div>

%						}

					</span>

					<span class="half nospace top">

%						my @chapters = $m->comp("/funclib/person_chapters.mas", person => $candidate) ;

%						if (@chapters) {

							<p class="semibold bigger bluetext">
								School admin for
							</p>

%							foreach my $chapter (@chapters) {
								<div class="full padno marleftmore padleft smallish">
									<% $chapter->name %>
								</div>
%							}
%						}

<%perl>
						my @tourns =
							$m->comp("/funclib/person_tourns.mas",
								person => $candidate,
								limit  => 5,
								all    => 1
							);
</%perl>

%						if (@tourns) {

							<p class="semibold bigger bluetext">
								Tournament Admin for
							</p>

%							foreach my $tourn (@tourns) {

								<div class="full padno marleftmore padleft smallish">
									<span class="quarter">
										<% $tourn->start->year %>
									</span>
									<span class="threequarters">
										<% $tourn->name %>
									</span>
								</div>
%							}

%						}

%						my @students = Tab::Student->search( person => $candidate->id );

%						if (@students) {

							<p class="semibold bigger redtext">Competitors linked</p>

%							foreach my $student (@students) {
%								next unless $student > 0;
								<div class="full padno marleftmore padleft smallish">
									<% $student->first." ".$student->last %>  <% $student->chapter ? "/".$student->chapter->name : ""%>
								</div>
%							}

%						}

%						my @chapter_judges = Tab::ChapterJudge->search( person => $candidate->id );

%						if (@chapter_judges) {

							<p class="semibold bluetext bigger">
								School Judges linked
							</p>

%							foreach my $chapter_judge (@chapter_judges) {

								<div class="full padno marleftmore padleft smallish">
									<% $chapter_judge->first." ".$chapter_judge->last %>
									at <% $chapter_judge->chapter->name %>
								</div>
%							}

%						}

%						my @judges = $m->comp("/funclib/person_judges.mas", person => $candidate, all => 1);

%						if (@judges) {

							<p class="semibold bluetext bigger">
								Last 5 tournaments judged
							</p>

%							my $count;

%							foreach my $judge (@judges) {

%								last if $count++ >= 5;

								<div class="full padno marleftmore padleft smallish">
									<span class="fifth nospace">
										<% $judge->category->abbr %>
									</span>
									<span class="fourfifths nospace">
										<% substr($judge->category->tourn->name, 0, 32) %>
									</span>
								</div>

%							}

%						}




					</span>

				</span>

				<span class="third nospace leftalign">

					<label for="prefer_<% $candidate->id %>">

						<div
							class="full <% $target_id == $candidate->id ? "dk" : ""%>green radiomerge hover padless"
							id="div_prefer_<% $candidate->id %>"
						>

							<span class="threequarter leftalign nospace">
								Target Account
							</span>

							<span class="quarter nospace leftalign">

								<input
									type  = "radio"
									class = "merge"
									name  = "prefer"
									id    = "prefer_<% $candidate->id %>"
									value = "<% $candidate->id %>"
									<% $target_id == $candidate->id ? 'checked="checked"' : ""%>
								>
							</span>
						</div>
					</label>

					<label for="<% $candidate->id %>">

						<div
							class = "full green hover padless martop"
							id    = "div_<% $candidate->id %>"
						>

							<span class="threequarter leftalign nospace">
								Merge into Target
							</span>

							<span class="quarter nospace leftalign">

								<input
									type  = "checkbox"
									class = "merge"
									name  = "merge"
									value = "<% $candidate->id %>"
									id    = "<% $candidate->id %>"
								>
							</span>
						</div>

					</label>

			</div>

%		}

		<div class="libl pagefull rightalign padvert">

			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Merge Accounts"
				>
			</span>
		</div>

		</form>

%		} else {

			<h2>Search accounts to merge at right</h2>

%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Search accounts</h4>

			<form action="person_merge.mhtml">

			<input
				type  = "hidden"
				name  = "target_id"
				value = "<% $target_id %>"
			>

			<div class="row full centeralign">

				<span class="quarter">
					Last:
				</span>

				<span class="threequarters">

					<input
						type  = "text"
						name  = "search_last"
						value = "<% $search_last %>"
						size  = "24"
					>

				</span>

			</div>

			<div class="row full centeralign">

				<span class="quarter">
					First:
				</span>

				<span class="threequarters">

					<input
						type  = "text"
						name  = "search_first"
						value = "<% $search_first %>"
						size  = "24"
					>

				</span>

			</div>

			<div class="row full centeralign">

				<span class="quarter">
					Email:
				</span>

				<span class="threequarters">

					<input
						type  = "text"
						name  = "search_email"
						value = "<% $search_email %>"
						size  = "24"
					>

				</span>

			</div>

			<div class="full rightalign libl">
				<input
					type  = "submit"
					value = "Go"
					class = "thinner"
				>
			</div>

			</form>

		</div>

		<& "menu.mas",
			nodiv           => 1,
			person          => $person,
			person_settings => $person_settings,
			whoami          => "person_merger"
		&>

	</div>
