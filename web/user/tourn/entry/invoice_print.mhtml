<%args>
	$session
	$school
	$debug => undef
</%args>
<%init>

	my $tourn  = $school->tournament;
	my $league = $tourn->league;

	my $filename = $Tab::file_root."/tmp/invoice-".$school->id."-".$session->id;
	
	my $garbage = `rm -f $filename.*`;
	
	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";
\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}
\\small
EOF

close TEXOUT;

	$m->comp("/funclib/fees_print.mas", 
		school_id => $school->id, 
		filename => $filename, 
		league => $league, 
		name => "INVOICE");

	if ($school->purchases) { 

		print TEXOUT "\\newpage\n";
		close TEXOUT;

		$m->comp("/funclib/concessions_print.mas", 
			school_id => $school->id, 
			filename => $filename, 
			second => 1,
			league => $league);

	}

	open (TEXOUT, ">>$filename.tex");
	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

	`cd $Tab::file_root/tmp; rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;

	$m->redirect("$Tab::url_prefix/tmp/invoice-".$school->id."-".$session->id.".pdf");

</%init>


<p><% $filename %></p>
