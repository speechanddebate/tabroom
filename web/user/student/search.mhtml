<%args>
	$person
	$session
	$first => undef
	$last  => undef
	$dbh
	$now
	$person_settings => undef
</%args>
<%init>

	unless ($first && $last) {
		$first = $person->first;
		$last = $person->last;

	} elsif (not defined $person->site_admin) {

		my $description = "Searched for student records $first $last";
		if ($session->su > 0) {
			$description .= " while logged in as ".$session->su->email;
		}

		$description .= " from session ID ".$session->id;

		Tab::ChangeLog->create({
			person      => $session->su || $person,
			tag         => "student_search",
			description => $description
		});

		my $then = $now->clone;
		$then->subtract( hours => 24 );

		if (
			$person_settings->{last_student_search} > $then
			&& $person_settings->{student_search_count} > 9
		) {

			# Limit the potential for creeps
			$m->comp("/funclib/abort.mas",
				message => " Due to privacy concerns, you may only search for student records a few times every 24 hours."
			);

		} elsif ($person_settings->{student_search_count}) {

			# After 24 hours you can zero back the count.
			$person->setting("student_search_count", 1);

		} else {

			$person->setting("student_search_count", (int($person_settings->{student_search_count}) + 1));
		}

		$person->setting("last_student_search", "date", $now);
	}

	my $student_sth = $dbh->prepare("
		select
			student.id, student.first, student.middle, student.last, student.grad_year,
			chapter.id chapter_id, chapter.name chapter_name, chapter.state chapter_state, chapter.level chapter_level,
			COUNT(distinct tourn.id) AS tourn_count

		from (student, chapter)

			left join entry_student es on es.student = student.id
			left join entry on es.entry = entry.id
			left join event on entry.event = event.id
			left join tourn on event.tourn = tourn.id

		where 1=1
			and student.first like ?
			and student.last like ?
			and (student.person = 0  OR student.person IS NULL)
			and (student.person_request = 0  OR student.person_request IS NULL)
			and student.chapter = chapter.id
			and student.grad_year > ?

		group by student.id

	");

	$student_sth->execute($first."%", $last."%", &Tab::school_year->year);

	my $students = $student_sth->fetchall_hash();
	my $found;

</%init>

	<div class="main">

		<h4>Students named <% $first." ".$last %></h4>

%		if ($students && (scalar @{$students} > 0)) {

			<p>
				Link these students to your persons for updates &amp; ballot
				assignments.  Note: the adminstrators of your team/school will
				have to approve requests to claim a student record before you
				can access them.  Team admins will be notified of requests by
				email.
			</p>

			<p class="semibold bluetext">
				Link only if you are the actual student.
			</p>

			<p>
				Parents/coaches should not link to student records; that will
				interfere with the student's ability to see their ballots,
				enter prefs, or get updates. Parents or coaches should instead
				click "Live Updates" on tournaments to follow along.
			</p>

			<table>

				<tr class="yellowrow">

					<th>
						Name
					</th>

					<th>
						Year
					</th>

					<th>
						School/Team
					</th>

					<th>
						State
					</th>

					<th>
						# Tournaments
					</th>

					<th>
					</th>

				</tr>

%			} else {

				<table>
%			}

%			foreach my $student (@{$students}) {

				<tr class="row" id="<% $student->{id} %>">

					<td>
						<% $student->{first}." ".$student->{middle}." ".$student->{last} %>
					</td>

					<td>
						<% $student->{grad_year} %>
					</td>

					<td>
						<% $student->{chapter_name} %>
					</td>

					<td>
						<% $student->{chapter_state} %>
					</td>

					<td class="centeralign">
						<% $student->{tourn_count} %>
					</td>

					<td class="centeralign">
						<a
							class = "buttonwhite bluetext invert smallish"
							href  = "claim.mhtml?student_id=<% $student->{id} %>"
						>
							Request Link
						</a>
					</td>
				</tr>
%			}

		</table>

%		unless (scalar @{$students} > 0) {

			<p>
				There are no unlinked students named <% $first." ".$last %> who
				are not connected to an Tabroom account already. If this is in
				error, as your team administrator or the tournament director to
				link your email to your student record.  Or, search for a
				different name.
			</p>

			<p>
				Note. Please only link to your OWN person.  Do not link to a
				teammate or partner's person; you can sign up for updates on a
				per-tournament basis for other entrants.
			</p>

%		}

		<form action="search.mhtml" method="post">

		<div class="libl flexrow martopmuchmore">

			<span class="quarter semibold">
				Search another name
			</span>

			<span class="threetenths">
				<input
					type        = "text"
					name        = "first"
					placeholder = "First name"
				>
			</span>

			<span class="threetenths marleftmore padleftmore">
				<input
					type        = "text"
					name        = "last"
					placeholder = "Last name"
				>
			</span>

			<span class="tenth rightalign">
				<input
					type  = "submit"
					value = "Search"
					class = "thin"
				>
			</span>

		</div>

		</form>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Your teams</h4>

%			foreach my $acc_student ($person->students) {
				<a class="yellow block" href="history.mhtml?student_id=<% $acc_student->id %>">
					<% $acc_student->chapter ? $acc_student->chapter->name : "" %>
				</a>
%			}

		</div>

		<div class="sidenote">

			<h4>Recent entries</h4>
<%perl>
			Tab::Entry->set_sql( by_person => "
				select entry.*,
					student.id as studentid,
					chapter.name as chaptername,
					chapter.state as chapterstate
				from (entry, entry_student, student, event, tourn)
					left join school on school.id = entry.school
					left join chapter on school.chapter = chapter.id

				where student.person = ?
					and student.id = entry_student.student
					and entry_student.entry = entry.id
					and entry.event = event.id
					and event.tourn = tourn.id
					and tourn.hidden = 0
				order by tourn.start desc
				limit 10
			");

			my @entries = Tab::Entry->search_by_person($person->id);

			my $count;
</%perl>

%			foreach my $entry (@entries) {
				<a class="nowrap blue block" href="entry.mhtml?entry_id=<% $entry->id %>">
					<% $entry->event->abbr %> at <% $entry->event->tourn->name %>
				</a>
%			}

			<a class="yellow block" href="index.mhtml?person_id=<% $person->id %>" style="margin-top: 10px;">
				Full Entry History
			</a>

		</div>

	</div>

