<%args>
	$person
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();
	my $now = DateTime->now();

	my @students;
	my @panels;
	my @done_panels;

	@students = Tab::Student->search(
		person  => $person->id,
		retired => 0
	);

	my @current_entries = $m->comp(
		"/funclib/person_entries.mas",
		person => $person,
		present => 1
	);

	my %current = map {$_->id => 1} @current_entries;

	my $prefs;

	my $upcoming_sth = $dbh->prepare("
		select
			student.id,
			tourn.id, tourn.name, tourn.city, tourn.state, tourn.country,
			CONVERT_TZ(tourn.start, '+00:00', tourn.tz),
			CONVERT_TZ(tourn.end, '+00:00', tourn.tz),
			event.id, event.abbr, event.name,
			entry.id,
			entry.unconfirmed, entry.waitlist, entry.dropped, entry.active,
			category.id, prefs.value,
			signup_active.value,
			CONVERT_TZ(strike_start.value_date, '+00:00', person.tz),
			CONVERT_TZ(strike_end.value_date, '+00:00', person.tz),
			CONVERT_TZ(signup_deadline.value_date, '+00:00', person.tz),
			memo.filename,
			person.tz

		from (student, entry_student es, entry, event, school, tourn, category, person)

			left join school_setting signup_active
				on signup_active.school = school.id
				and signup_active.tag = 'signup_active'

			left join school_setting signup_deadline
				on signup_deadline.school = school.id
				and signup_deadline.tag = 'signup_deadline'

			left join category_setting prefs
				on prefs.category = category.id
				and prefs.tag = 'prefs'

			left join category_setting strike_start
				on strike_start.category = category.id
				and strike_start.tag = 'strike_start'

			left join category_setting strike_end
				on strike_end.category = category.id
				and strike_end.tag = 'strike_end'

			left join file memo
				on memo.type = 'signup'
				and memo.school = school.id

		where person.id = ?
			and student.person = person.id
			and student.id     = es.student
			and es.entry       = entry.id
			and entry.school   = school.id
			and school.tourn   = tourn.id
			and entry.event    = event.id
			and event.category = category.id
			and tourn.end  > NOW()
	");

	$upcoming_sth->execute($person->id);

	my %upcoming;

	while (
		my (
			$student_id,
			$tourn_id, $tourn_name, $tourn_city, $tourn_state, $tourn_country,
			$tourn_start, $tourn_end,
			$event_id, $event_abbr, $event_name,
			$entry_id,
			$entry_unconfirmed, $entry_waitlist, $entry_dropped, $entry_active,
			$category_id, $prefs_value,
			$signup_active_value,
			$strike_start, $strike_end,
			$signup_deadline,
			$memo_filename,
			$person_tz
		) = $upcoming_sth->fetchrow_array()
	) {

		$upcoming{$student_id}{$entry_id}{"event_abbr"} = $event_abbr;
		$upcoming{$student_id}{$entry_id}{"event_id"} = $event_id;
		$upcoming{$student_id}{$entry_id}{"tourn_name"} = $tourn_name;
		$upcoming{$student_id}{$entry_id}{"tourn_id"} = $tourn_id;
		$upcoming{$student_id}{$entry_id}{"tourn_city"} = $tourn_city;
		$upcoming{$student_id}{$entry_id}{"tourn_state"} = $tourn_state;
		$upcoming{$student_id}{$entry_id}{"tourn_country"} = $tourn_country;
		$upcoming{$student_id}{$entry_id}{"tourn_start"} = $tourn_start;
		$upcoming{$student_id}{$entry_id}{"tourn_end"} = $tourn_end;
		$upcoming{$student_id}{$entry_id}{"entry_unconfirmed"} = $entry_unconfirmed;
		$upcoming{$student_id}{$entry_id}{"entry_waitlist"} = $entry_waitlist;
		$upcoming{$student_id}{$entry_id}{"entry_dropped"} = $entry_dropped;
		$upcoming{$student_id}{$entry_id}{"entry_active"} = $entry_active;
		$upcoming{$student_id}{$entry_id}{"category_id"} = $category_id;

		if ($prefs_value) {

			if ($prefs_value eq "tiered_round") {
				$prefs_value = "tiered";
			}

			$upcoming{$student_id}{$entry_id}{"prefs"} = $prefs_value,
			$prefs++;
		}
		$upcoming{$student_id}{$entry_id}{"signup_active"} = $signup_active_value,
		$upcoming{$student_id}{$entry_id}{"memo_filename"} = $memo_filename;

		$upcoming{$student_id}{$entry_id}{"strike_start"} = eval {
			my $dt = DateTime::Format::MySQL->parse_datetime($strike_start);
			$dt->set_time_zone($person_tz);
			return $dt;
		};
		$upcoming{$student_id}{$entry_id}{"strike_end"} = eval {
			my $dt = DateTime::Format::MySQL->parse_datetime($strike_end);
			$dt->set_time_zone($person_tz);
			return $dt;
		};
		$upcoming{$student_id}{$entry_id}{"signup_deadline"} = eval {
			my $dt = DateTime::Format::MySQL->parse_datetime($signup_deadline);
			$dt->set_time_zone($person_tz);
			return $dt;
		};
	}

	my $signup_sth = $dbh->prepare("
		select
			student.id, student.first, student.last,
			chapter.id, chapter.name,
			school.id, school.name, school.code,
			tourn.id, tourn.name, tourn.city, tourn.state, tourn.country,
			CONVERT_TZ(tourn.start, '+00:00', tourn.tz),
			CONVERT_TZ(tourn.end, '+00:00', tourn.tz),
			GROUP_CONCAT(distinct(event.abbr) ORDER BY event.abbr SEPARATOR ', '),
			CONVERT_TZ(signup_deadline.value_date, '+00:00', person.tz),
			memo.filename

		from (student, chapter, school, tourn, school_setting signup_active, person)

			left join event on tourn.id = event.tourn

			left join school_setting signup_deadline
				on signup_deadline.school = school.id
				and signup_deadline.tag = 'signup_deadline'

			left join file memo
				on memo.type = 'signup'
				and memo.school = school.id

		where tourn.id = school.tourn
			and student.chapter = school.chapter
			and student.chapter = chapter.id
			and student.person = ?
			and student.person = person.id
			and school.id = signup_active.school
			and signup_active.tag = 'signup_active'
			and tourn.start > NOW()
		group by school.id
	");

	$signup_sth->execute($person->id);

	my %signups;

	while (
		my (
			$student_id, $student_first, $student_last,
			$chapter_id, $chapter_name,
			$school_id, $school_name, $school_code,
			$tourn_id, $tourn_name, $tourn_city, $tourn_state, $tourn_country,
			$tourn_start, $tourn_end,
			$events,
			$signup_deadline,
			$memo_file
		) = $signup_sth->fetchrow_array()
	) {

		$signups{$student_id}{$tourn_id}{"name"}            = $tourn_name;
		$signups{$student_id}{$tourn_id}{"start"}           = $tourn_start;
		$signups{$student_id}{$tourn_id}{"end"}             = $tourn_end;
		$signups{$student_id}{$tourn_id}{"city"}            = $tourn_city;
		$signups{$student_id}{$tourn_id}{"state"}           = $tourn_state;
		$signups{$student_id}{$tourn_id}{"country"}         = $tourn_country;
		$signups{$student_id}{$tourn_id}{"school"}          = $school_id;
		$signups{$student_id}{$tourn_id}{"signup_deadline"} = $signup_deadline;
		$signups{$student_id}{$tourn_id}{"memo"}            = $memo_file;
		$signups{$student_id}{$tourn_id}{"events"}          = $events;
	}

	my @tabs = ("current", "future", "results");
	my $default = "current";

	my %nsda;
	my %student_by_id;

	foreach my $student (sort {$b->grad_year <=> $a->grad_year} @students) {

		$student_by_id{$student->id} = $student;

		if ($student->nsda) {
			$nsda{$student->nsda}++;
		}
	}

	if (keys %signups) {
		@tabs = ("current", "future", "signups", "results");
	}

	my %links;

	if (keys %nsda) {
		$links{"NSDA"} = "nsda.mhtml";
	}

	unless (@current_entries) {

		if (keys %upcoming) {
			$default = "future";
		} elsif (keys %signups) {
			$default = "signups";
		} else {
			$default = "results";
		}
	}

	$default = $ARGS{"default"} if $ARGS{'default'};

</%init>

	<& "/user/menu.mas",
		whoami => "competitor",
		person => $person,
	&>

	<div class="main">

		<span class="threefifths nospace">
			<h3>
				<% $person->first %> <% $person->last %>
			</h3>
		</span>

		<span class="twofifths rightalign nospace">
			<h4>
				Competitor Records
			</h4>
		</span>

		<& "/funclib/tabs.mas",
			tabs    => \@tabs,
			links   => \%links,
			default => $default
		&>

		<div class="screens current">

			<h4 class="bluetext martopmore">
				Current Entries
			</h4>

%			if (@current_entries) {
%				foreach my $entry (@current_entries) {
					<& "show_entry.mas",
						entry      => $entry,
						student_id => $entry->studentid,
						person     => $person
					&>
%				}
%			}
		</div>

		<div class="screens future">

			<h4 class="martopmore">
				Future Tournaments
			</h4>

%			if (keys %upcoming) {


				<&
					"/funclib/tablesorter.mas",
					table => "upcoming",
					nobuttons => 1
				&>

				<table id="upcoming">

					<thead>

						<tr class="smallish semibold yellowrow">

							<th class="smallish">
								Tournament
							</th>

							<th class="smallish">
								Dates
							</th>

							<th class="smallish">
								Event
							</th>

							<th class="smallish">
								Info
							</th>

							<th class="smallish">
								Status
							</th>

%							if ($prefs) {
								<th class="smallish">
									Prefs
								</th>
%							}

							<th class="smallish">
							</th>

						</tr>

					</thead>

					<tbody>
<%perl>

					foreach my $student_id (sort keys %upcoming) {

						foreach my $entry_id (
							sort {
								$upcoming{$student_id}{$a}{"start_date"} <=>  $upcoming{$student_id}{$b}{"start_date"}
								|| $upcoming{$student_id}{$a}{"event_abbr"} cmp  $upcoming{$student_id}{$b}{"event_abbr"}
							} keys %{$upcoming{$student_id}}
						) {

							my $prefs = $upcoming{$student_id}{$entry_id}{"prefs"};
							my $tourn_id = $upcoming{$student_id}{$entry_id}{"tourn_id"};
							my $school_id = $upcoming{$student_id}{$entry_id}{"school_id"};
</%perl>
							<tr class="smallish" id="<% $entry_id %>">

								<td class="nospace">
									<div class="nowrap full marvertno semibold padvertless">
										<% $upcoming{$student_id}{$entry_id}{"tourn_name"}  %>
									</div>
									<div class="nowrap full nospace padbottom">
										<span class='halfspacer'></span>
										<% $upcoming{$student_id}{$entry_id}{"tourn_city"}  %>
										<% $upcoming{$student_id}{$entry_id}{"tourn_state"}
											? $upcoming{$student_id}{$entry_id}{"tourn_state"}
											: $upcoming{$student_id}{$entry_id}{"tourn_country"}
										%>
									</div>
								</td>

								<td class="nowrap">

									<& "/funclib/showdate.mas",
										string => $upcoming{$student_id}{$entry_id}{"tourn_start"},
										length => "medium"
									&>

%									if (substr($upcoming{$student_id}{$entry_id}{"tourn_start"}, 6, 2)
%										ne substr($upcoming{$student_id}{$entry_id}{"tourn_end"}, 6, 2)
%									) {
										<&
											"/funclib/showdate.mas",
											string => $upcoming{$student_id}{$entry_id}{"tourn_end"},
											length => "medium"
										&>
%									}
								</td>

								<td class="nospace centeralign">
									<a
										class  = "plain full marno padmore hover"
										target = "_blank"
										href   = "/index/tourn/events.mhtml?event_id=<% $upcoming{$student_id}{$entry_id}{"event_id"} %>"
									><%  $upcoming{$student_id}{$entry_id}{"event_abbr"} %></a>
								</td>

								<td class="centeralign">
%									if ($signups{$student_id}{$tourn_id}{"memo"}) {
										<a class="fa fa-sm ltbuttonwhite redtext fa-file-o"
											href="<% $Tab::s3_url."/".$tourn_id."/signups/".$school_id."/".$signups{$student_id}{$tourn_id}{"memo"} %>"
										></a>
%									}
								</td>

								<td class="nospace centeralign">
%									if ($upcoming{$student_id}{$entry_id}{"entry_unconfirmed"}) {
										<span class="full marno redtext semibold">
											No Coach Approval
										</span>
%									} elsif ($upcoming{$student_id}{$entry_id}{"entry_waitlist"}) {
										<span class="full marno orangetext semibold">
											Waitlisted
										</span>
%									} elsif ($upcoming{$student_id}{$entry_id}{"entry_dropped"}) {
										<span class="full marno orangetext semibold">
											Dropped
										</span>
%									} elsif ($upcoming{$student_id}{$entry_id}{"entry_active"}) {
										<span class="full marno greentext semibold">
											Confirmed
										</span>
%									}
								</td>
<%perl>
								if ($prefs) {

									if (
										($upcoming{$student_id}{$entry_id}{"strike_start"} < $now)
										&& ($upcoming{$student_id}{$entry_id}{"strike_end"} > $now)
									) {
</%perl>
										<td class="nospace centeralign">
											<span class="fourfifths marno semibold orangetext">
												Prefs Due
												<& "/funclib/showdt.mas",
													dt => $upcoming{$student_id}{$entry_id}{"strike_end"}
												&>
											</span>
											<span class="fifth centeralign marno">
												<a class="buttonwhite bluetext fa fa-lg fa-file-text"
													title="Pref Sheet"
													href="/user/enter/ratings/<% $prefs %>_prefs.mhtml?entry_id=<% $entry_id %>&school_id=<% $school_id %>"
												></a>
											</span>
										</td>

%									} elsif ($upcoming{$student_id}{$entry_id}{"strike_start"} > $now) {

										<td class="nospace centeralign bluetext">
											Open
											<& "/funclib/showdt.mas",
												dt => $upcoming{$student_id}{$entry_id}{"strike_end"}
											&>
										</td>

%									} elsif ($upcoming{$student_id}{$entry_id}{"strike_end"} < $now) {

										<td class="nospace centeralign redtext">
											Closed
										</td>
%									}
%								}

								<td class="centeralign padsetting">
<%perl>
									if ($upcoming{$student_id}{$entry_id}{"signup_active"}
										&& $upcoming{$student_id}{$entry_id}{"entry_unconfirmed"}
										&& $upcoming{$student_id}{$entry_id}{"signup_deadline"} > $now
									) {

										my $warn = "This will drop your signup for this tournament.  Your partner(s)";
										$warn .= ", if any, will be notified as well.  You sure?";
</%perl>
										<a
											id            = "<% $entry_id %>"
											target_id     = "<% $entry_id %>"
											on_success    = "destroy"
											property_name = "<% $upcoming{$student_id}{$entry_id}{"student_id"} %>"
											onClick       = "postConfirm('<% $warn %>', this, 'drop_entry.mhtml');"
											class         = "buttonwhite fa-sm fa fa-arrow-down redtext hover"
											title         = "Drop This Entry"
										></a>
%									}
								</td>
							</tr>
%						}
%					}
					</tbody>
				</table>
%			}
		</div>

%		if (keys %signups) {

			<div class="screens signups">

				<h4 class="martopmore">
					Tournaments Open for Signups
				</h4>

				<&
					"/funclib/tablesorter.mas",
					table     => "signups",
					nobuttons => 1
				&>

				<table id="signups">

					<thead>

						<tr class="smallish semibold yellowrow">

							<th class="smallish">
								Tournament
							</th>

							<th class="smallish">
								Dates
							</th>

							<th class="smallish nowrap">
								Signup Deadline
							</th>

							<th class="smallish">
								Events Offered
							</th>

							<th class="smallish">
								Info
							</th>

							<th class="smallish">
								Signup
							</th>
						</tr>
					</thead>

					<tbody>
<%perl>
						foreach my $student_id (sort keys %signups) {
							foreach my $tourn_id (
								sort {
									$signups{$student_id}{$a}{"start"} <=> $signups{$student_id}{$b}{"start"}
									|| $signups{$student_id}{$a}{"end"} <=> $signups{$student_id}{$b}{"end"}
									|| $signups{$student_id}{$a}{"name"} cmp $signups{$student_id}{$b}{"name"}
								} keys %{$signups{$student_id}}
							) {

								my $school_id = $signups{$student_id}{$tourn_id}{"school"};
								next unless $school_id;
</%perl>
								<tr>

									<td class="nospace">

										<a 	class  = "plain hover"
											target = "_blank"
											href   = "/index/tourn/index.mhtml?tourn_id=<% $tourn_id %>"
										>
											<div class="nowrap full nospace padvertless">
												<% $signups{$student_id}{$tourn_id}{"name"} %>
											</div>
											<div class="nowrap full nospace padvertless">
												<% $signups{$student_id}{$tourn_id}{"city"} %>
												<%
													$signups{$student_id}{$tourn_id}{"state"}
													? $signups{$student_id}{$tourn_id}{"state"}
													: $signups{$student_id}{$tourn_id}{"country"}
												%>
											</div>
										</a>
									</td>

									<td>
										<& "/funclib/showdate.mas",
											string => $signups{$student_id}{$tourn_id}{"start"},
											length => "medium"
										&>
%										if (substr($signups{$student_id}{$tourn_id}{"start"}, 6, 2)
%											ne substr($signups{$student_id}{$tourn_id}{"end"}, 6, 2)
%										) {
											<&
												"/funclib/showdate.mas",
												string => $signups{$student_id}{$tourn_id}{"end"},
												length => "medium"
											&>
%										}
									</td>

									<td>
%										if ($signups{$student_id}{$tourn_id}{"signup_deadline"}) {
											<& "/funclib/showdt.mas",
												string => $signups{$student_id}{$tourn_id}{"signup_deadline"}
											&>
											<% Tab::tzname($person->tz) %>
%										}
									</td>

									<td class="nospace centeralign nospace smallish">
										<% $signups{$student_id}{$tourn_id}{"events"} %>
									</td>


									<td class="centeralign">
%										if ($signups{$student_id}{$tourn_id}{"memo"}) {
											<a class="fa-sm fa buttonwhite redtext fa-file-o"
												href="<% $Tab::s3_url."/".$tourn_id."/signups/".$school_id."/".$signups{$student_id}{$tourn_id}{"memo"} %>"
											></a>
%										}
									</td>

									<td class="centeralign nospace">
										<a class = "fa-sm fa buttonwhite bluetext fa-user-plus"
											href = "signup.mhtml?school_id=<% $school_id %>&student_id=<% $student_id %>"
										></a>
									</td>
								</tr>
%							}
%						}
					</tbody>
				</table>
			</div>
%		}

		<div class="results screens">
<%perl>
			my $result_sth = $dbh->prepare("
				select
					student.id, student.first, student.last, student.nsda, student.grad_year, student.retired,
					chapter.id, chapter.name, chapter.state, chapter.nsda,
					ndt.id,
					entry.id, entry.code, entry.name,
					event.id, event.abbr, event.name,
					tourn.id, tourn.name,
					CONVERT_TZ(tourn.start, '+00:00', tourn.tz),
					CONVERT_TZ(tourn.end, '+00:00', tourn.tz)

				from (student, entry_student es, entry, event, tourn, chapter)

					left join chapter_circuit ndt
						on ndt.chapter = chapter.id
						and ndt.circuit = '43'

				where student.person = ?
					and student.id = es.student
					and es.entry = entry.id
					and entry.event = event.id
					and event.tourn = tourn.id
					and student.chapter = chapter.id
					and tourn.end < NOW()
				order by tourn.start DESC
			");

			my %students;

			$result_sth->execute($person->id);

			while (
				my (
					$student_id, $student_first, $student_last, $student_nsda, $student_grad, $retired,
					$chapter_id, $chapter_name, $chapter_state, $chapter_nsda,
					$ndt_id,
					$entry_id, $entry_code, $entry_name,
					$event_id, $event_abbr, $event_name,
					$tourn_id, $tourn_name, $tourn_start, $tourn_end
				) = $result_sth->fetchrow_array()
			) {

				unless ($students{$student_id}{"name"}) {
					$students{$student_id}{"name"} = $student_first." ".$student_last;
					$students{$student_id}{"nsda"} = $student_nsda;
					$students{$student_id}{"grad"} = $student_grad;
					$students{$student_id}{"ndt"}  = $ndt_id;
					$students{$student_id}{"retired"}  = $retired;

					$students{$student_id}{"chapter_nsda"}  = $chapter_nsda;
					$students{$student_id}{"chapter_id"}    = $chapter_id;
					$students{$student_id}{"chapter_name"}  = $chapter_name;
					$students{$student_id}{"chapter_state"} = $chapter_state;
				}

				$students{$student_id}{"entries"}{$entry_id}{"code"}        = $entry_code;
				$students{$student_id}{"entries"}{$entry_id}{"name"}        = $entry_name;
				$students{$student_id}{"entries"}{$entry_id}{"event_abbr"}  = $event_abbr;
				$students{$student_id}{"entries"}{$entry_id}{"event_name"}  = $event_name;
				$students{$student_id}{"entries"}{$entry_id}{"tourn_name"}  = $tourn_name;
				$students{$student_id}{"entries"}{$entry_id}{"tourn_start"} = $tourn_start;
				$students{$student_id}{"entries"}{$entry_id}{"tourn_end"}   = $tourn_end;
				$students{$student_id}{"entries"}{$entry_id}{"tourn_id"}    = $tourn_id;
			}

			$result_sth->finish();

			foreach my $student_id (
				sort {
					$students{$b}{"grad"} <=> $students{$a}{"grad"}
				} keys %students
			) {
</%perl>
				<div class="martopmore full nospace">
					<span class="fourfifths martopless">
						<h4 class="nospace">
							History at <% $students{$student_id}{"chapter_name"} %>
						</h4>
					</span>

					<span
						id    = "<% $student_id %>_buttonarea"
						class = "fifth rightalign nospace"
					>
					</span>
				</div>

				<& "/funclib/tablesorter.mas", table => $student_id &>

					<table id="<% $student_id %>">

						<thead>

							<tr class="yellowrow">

								<th class="smaller">
									Tourn
								</th>

								<th class="smaller">
									Date
								</th>

								<th class="smaller">
									Code
								</th>

								<th class="smaller">
									Division
								</th>

								<th class="smaller">
									Results
								</th>

							</tr>
						</thead>

						<tbody>
<%perl>

							foreach my $entry_id (
								sort {
									$students{$student_id}{"entries"}{$b}{"tourn_start"}
									cmp
									$students{$student_id}{"entries"}{$a}{"tourn_start"}
								} keys %{$students{$student_id}{"entries"}}
							) {

								my $tourn_id = $students{$student_id}{"entries"}{$entry_id}{"tourn_id"};
</%perl>

								<tr class="smallish">

									<td class="nospace">
										<a
											class  = "white full padvert"
											target = "_blank"
											href   = "history.mhtml?tourn_id=<% $tourn_id %>&student_id=<% $student_id %>">
											<% $students{$student_id}{"entries"}{$entry_id}{"tourn_name"} %>
										</a>
									</td>

									<td class="rightalign">
										<span class="hidden">
											<& "/funclib/showdate.mas",
												string => $students{$student_id}{"entries"}{$entry_id}{"tourn_start"},
												length => "sortable"
											&>
										</span>
										<& "/funclib/showdate.mas",
											string => $students{$student_id}{"entries"}{$entry_id}{"tourn_start"},
											length => "medium"
										&>
										<span class="halfspacer"></span>
									</td>

									<td class=" nowrap">
										<% $students{$student_id}{"entries"}{$entry_id}{"code"} %>
									</td>

									<td class="">
										<% $students{$student_id}{"entries"}{$entry_id}{"event_name"} %>
									</td>

									<td class="smallish centeralign nospace">
										<a
											class  = "buttonwhite smallish bluetext marvert padvertless fa fa-sm fa-file-text"
											target = "_blank"
											href   = "history.mhtml?tourn_id=<% $tourn_id %>&student_id=<% $student_id %>">
										</a>
									</td>

								</tr>

%							}

						</tbody>
					</table>
<%perl>
					if ($students{$student_id}{"ndt"} && (not defined $students{$student_id}{"retired"})) {

						my $year = $now->year;
						$year-- if $now->month < 8;
						my $limit = $year."-07-01 00:00:00";

						Tab::Student->set_sql( partners => "
							select distinct student.*
							from student, entry_student es1, entry_student es2
							where es1.entry = es2.entry
							and es1.student = ?
							and es2.student = student.id
							and student.id != es1.student
							and es1.timestamp > ?
						");

						my @partners = Tab::Student->search_partners( $student_id, $limit );
						my %partner_results = ();
						my @used_partners;

						next unless @partners;

						my $chapter_id = $students{$student_id}{"chapter_id"};

</%perl>
						<h5><% $year + 1 %> NDT Records</h5>

						<div class="row">

							<span class="twothird biggish semibold bluetext">
								Bid Sheet Honors
							</span>

							<span class="third rightalign">
								<a class="ltbuttonwhite bluetext centeralign full"
									href="/user/chapter/ndt_bid_honors.mhtml?student_id=<% $student_id %>&chapter_id=<% $chapter_id %>">
									NDT Honors
								</a>
							</span>
						</div>
<%perl>

						foreach my $partner (@partners) {

							Tab::Result->set_sql( honors => "
								select distinct result.*
								from result
								where honor is not null
								and student = ?
								and timestamp > ?
							");

							my @p_results = Tab::Result->search_honors( $partner->id, $limit );

							if (@p_results) {
								push (@used_partners, $partner);
								@{$partner_results{$partner->id}} = @p_results;
							}
						}

						foreach my $other (@partners) {
</%perl>
							<div class="row">
								<span class="twothird biggish semibold bluetext">
									Record with <% $other->first." ".$other->last %>
								</span>

								<span class="third rightalign">
									<a
										class="ltbuttonwhite bluetext full"
										href="/index/results/team_results.mhtml?id1=<% $other->id %>&id2=<% $student_id %>"
									>
										NDT Bid Sheet w/<% $other->last %>
									</a>
								</span>
							</div>
%						}
%					}
%				}
		</div>
	</div>
