<%args>
	$person
	$chapter_id => undef
	$name => undef
</%args>
<%init>

	my $now = DateTime->now;

	$m->redirect("/user/home.mhtml") unless $chapter_id;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my @published;

	if ($name) { 

		Tab::Tourn->set_sql(name_by_chapter_published => "
			select distinct tourn.*, school.id as schoolid
			from tourn, school
			where tourn.id = school.tourn
			and school.chapter = ? 
			and tourn.name like  ? 
			and tourn.hidden != 1
			and (
				exists (
					select round.id
					from round, event
					where event.tourn = tourn.id
					and round.event = event.id
					and round.post_results > 1
				) or exists (
					select result_set.id
					from result_set
					where result_set.tourn = tourn.id
					and (published = 1  or coach = 1)
				) or exists (
					select round.id
					from round, round_setting, event
					where event.tourn = tourn.id
					and round.event = event.id
					and round.id = round_setting.round
					and (round_setting.tag = 'coach_feedback'
						or round_setting.tag = 'coach_points'
						or round_setting.tag = 'coach_wins'
						or round_setting.tag = 'post_feedback'
						or round_setting.tag = 'post_points'
						or round_setting.tag = 'post_wins'
					)
					and round_setting.value = 1
				)
			)
			order by tourn.start DESC
			limit 25
		");

		@published = Tab::Tourn->search_name_by_chapter_published($chapter_id, "%".$name."%");

	} else { 

		Tab::Tourn->set_sql(by_chapter_published => "
			select distinct tourn.*, school.id as schoolid
			from tourn, school
			where tourn.id = school.tourn
			and school.chapter = ? 
			and (
				exists (
					select round.id
					from round, event
					where event.tourn = tourn.id
					and round.event = event.id
					and round.post_results > 1
				) or exists (
					select result_set.id
					from result_set
					where result_set.tourn = tourn.id
					and (published = 1  or coach = 1)
				) or exists (
					select round.id
					from round, round_setting, event
					where event.tourn = tourn.id
					and round.event = event.id
					and round.id = round_setting.round
					and (round_setting.tag = 'coach_feedback'
						or round_setting.tag = 'coach_points'
						or round_setting.tag = 'coach_wins'
						or round_setting.tag = 'post_feedback'
						or round_setting.tag = 'post_points'
						or round_setting.tag = 'post_wins'
					)
					and round_setting.value = 1
				)
			)
			and tourn.hidden != 1
			order by tourn.start DESC
			limit 25
		");

		@published = Tab::Tourn->search_by_chapter_published($chapter_id);

	}

</%init>

	<div class="main">
	
		<h2><% $chapter->name %>: Results</h2>

		<& "/user/chapter/tabbar.mas", 
			chapter => $chapter, 
			person  => $person,
			whoami => "results" 
		&>

		<& "/funclib/tablesorter.mas", 
			table     => "results",
			nobuttons => 1
		&>

		<table id="results">

			<thead>

				<tr class="yellow smallish">
				
					<th>
						Dates
					</th>

					<th>
						Locale
					</th>

					<th>
						Circuit(s)
					</th>

					<th>
						Tournament
					</th>

					<th>
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			my %nodupes;

			foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @published) { 

				next if $nodupes{$tourn->schoolid}++;

				next if $tourn->start > $now;

				unless ($tourn->schoolid) { 

					my $school = Tab::School->search( 
						chapter => $chapter->id,
						tourn   => $tourn->id
					)->first;

					next unless $school;

					$tourn->schoolid($school->id);

				}
</%perl>
				
				<tr class="smallish">
			
					<td>
						<% Tab::pickerdate($tourn->start) %>
					</td>

					<td class="centeralign">
						<% $tourn->location %> 
					</td>

					<td class="padmore">
%						foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
							<% $circuit->abbr %>
%						}
					</td>

					<td class="nowrap">
						<a 
							class="white" 
							href="/index/tourn/results/index.mhtml?tourn_id=<% $tourn->id %>"
						>
							<% $tourn->name %>
						</a>
					</td>

					<td class="centeralign nospace">
						<a 
							class="buttonwhite smallish bluetext invert"
							href="tourn.mhtml?school_id=<% $tourn->schoolid %>"
						>
							Results
						</a>
					</td>
			
				</tr>

%			}
			</tbody>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Search tournaments</h4>

			<form 
				action = "index.mhtml"
				method = "post"
			=>

			<input 
				type  = "hidden"
				name  = "chapter_id"
				value = "<% $chapter->id %>"
			>

			<div class="even">
				<span class="threequarters padleft">
					<input 
						type        = "text"
						name        = "name"
						placeholder = "Search by name"
						size        = "24"
						class       = "thin"
					>
				</span>

				<span class="quarter centeralign">
					<input 
						type  = "submit"
						value = " Go "
						class = "thin"
					>
					</form>
				</span>
			</div>


			<h4>Stats</h4>

			<a href="competed_against.mhtml?chapter_id=<% $chapter_id %>" class="blue full">
				Schools Competed Against
			</a>

		</div>

	</div>

