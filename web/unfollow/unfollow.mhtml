<%args>
	$email => undef
	$tel   => undef
</%args>
<%init>


	my $person = Tab::Person->search(email => $email) if $email;

	if ($person) {

		my $err = "You cannot manage a Tabroom.com account with this page, it's only for people getting live updates without having a Tabroom.com account.  Log into your Tabroom account above and click Profile to stop following entries";

		$m->redirect("/unfollow/index.mhtml?err=$err");

	}

	my @all_followers = Tab::Follower->search(
		email => $email
	);

	push @all_followers, Tab::Follower->search(
		cell => $tel
	) if $tel;


	my @followers;
	my $deleted;

	foreach my $follower (@all_followers) {

		if ($ARGS{$follower->id}) {

			$follower->delete();
			$deleted++;

		} else {
			push @followers, $follower;
		}
	}


	$tel =~ s/[\D_]//g;

	my @people = Tab::Person->search( phone => $tel) if $tel;

</%init>

%	if ($deleted) {
		<script>
			$(document).ready(function() {
				alertify.set('notifier', "delay", "24244");
				alertify.success("<% $deleted %> follower records deleted");
			});
		</script>
%	}

	<div class="menu">

		<div class="sidenote">

			<h4>Search again:</h4>

			<form
				action = "unfollow.mhtml"
				method = "post"
			>

				<h6>
					Email address:
				</h6>

				<div class="row centeralign full">
					<input
						type        = "email"
						name        = "email"
						size        = "32"
						placeholder = "Search for your email address"
						value 		= "<% $email %>"
					>
				</div>

				<h6>
					Phone number:
				</h6>

				<div class="row centeralign full marno">
					<input
						type        = "tel"
						name        = "tel"
						size        = "32"
						value       = "<% $tel %>"
						placeholder = "Search for your phone number"
					>
				</div>

				<div class="row libl full rightalign marno" >
					<input
						type  = "submit"
						class = "thin"
						value = "Search"
					>
				</div>

			</form>

		</div>

	</div>

	<div class="main">

		<span class="fivesixths">
			<h2>Follower records found:</h2>
		</span>

%		if (@people) {

			<h5>Permanent texting</h5>

			<p>
				Your phone number is set to receive all texts for the following
				records.  To remove it, though, we have to confirm it is yours.
			</p>

			<p>
				The "Remove" button will text you a code to confirm your
				number.  Enter the code below to confirm removal of your phone
				number from this record.
			</p>

%			foreach my $jamoke (@people) {

				<div
					id    = "<% $jamoke->id %>"
					class = "row"
				>

					<span class="quarter">
						<% $jamoke->first." ".$jamoke->last %>
					</span>
					<span class="quarter">
						<% $jamoke->email %>
					</span>

					<span class="eighth">
						<a
							class         = "buttonwhite bluetext invert smallish"
							target_id     = <% $jamoke->id %>
							property_name = "send_code"
							onClick       = "postSwitch(this, 'unfollow_switch.mhtml');"
						>
							Send Code
						</a>
					</span>

					<span class="quarter centeralign">
						<input
							type        = "text"
							size        = "16"
							id          = "code_<% $jamoke->id %>"
							name        = "code_<% $jamoke->id %>"
							placeholder = "Confirmation code"
						>
					</span>

					<span class="eighth">
						<a
							class         = "buttonwhite bluetext invert smallish"
							type          = "button"
							target_id     = "<% $jamoke->id %>"
							property_name = "confirm"
							other_value   = "code_<% $jamoke->id %>"
							on_success    = "destroy"
							onClick       = "postSwitch(this, 'unfollow_switch.mhtml');"
						>Remove</a>

					</span>

				</div>

%			}

%		}

%		if (@followers) {

			<form
				action = "unfollow.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				name  = "email"
				value = "<% $email %>"
			>

			<input
				type  = "hidden"
				name  = "tel"
				value = "<% $tel %>"
			>

			<div class="padno full martopmore">

				<span class="fourfifths nospace">
					<h5>Per-tournament following:</h5>
				</span>

				<label for="confirmswitch">

					<span class="fifth hover centeralign semibold redtext nospace">

						<h5 class="semibold inline">
							Delete all:
						</h5>

						<input
							type     = "checkbox"
							value    = 1
							class    = "marno marbottom"
							name     = "confirmswitch"
							id       = "confirmswitch"
							onchange = "confirmAll(this, 'follower');"
						>
						</h5>
					</span>
				</label>

			</div>

%		}

%		foreach my $follower (@followers) {

			<label for="<% $follower->id %>">
			<div class="row hover">

				<span class="threetenths">

%					if ($follower->judge) {

						<% $follower->judge->first." ".$follower->judge->last %>

%					} elsif ($follower->entry) {

						<% $follower->entry->code %>

%					} elsif ($follower->school) {

						<% $follower->school->name %>

%					} elsif ($follower->person) {

						All records for
						<% $follower->person->first." ".$follower->person->last %>

%					} elsif ($follower->student) {
						<% $follower->student->first." ".$follower->student->last %>
%					}

				</span>

				<span class="tenth">
%					if ($follower->judge) {
						<% $follower->judge->category ? $follower->judge->category->abbr : "" %>
%					} elsif ($follower->entry) {
						<% $follower->entry->event->abbr %>
%					}
				</span>

				<span class="twofifths">

%					if ($follower->judge) {

						<% $follower->judge->category
							?   $follower->judge->category->tourn->start->year." ".
								$follower->judge->category->tourn->name
							: ""
						%>

%					} elsif ($follower->entry) {

						<% $follower->entry->event->tourn->name %>

%					} elsif ($follower->school) {

						<% $follower->school->tourn->name %>

%					} elsif ($follower->student) {
						Parent Memos
%					}
				</span>

					<span class="fifth centeralign">
						Delete:
						<input
							type  = "checkbox"
							name  = "<% $follower->id %>"
							id    = "<% $follower->id %>"
							value = "1"
							class = "follower notfirst"
						>
					</span>

			</div>
			</label>
%		}

%		if (@followers) {

			<div class="full libl marno rightalign">
				<input
					type  = "submit"
					value = "Unfollow"
				>

				</form>
			</div>

%		}


	</div>

