<%args>
	$circuit
	$tourn
	$label => "Posting"
	$posting => undef
</%args>
<%init>

	my $msg;

	my $now = DateTime->now;

	if ($posting) {

		my $file = Tab::File->create({
			tourn => $tourn->id,
			posting => 1,
			uploaded => $now,
			label => $label
		});

       	my $req = Apache2::Request->new($r);
       	my $upload = $req->upload("posting");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
       	$filename =~ s/\'//g;  # '  stupid vim

       	my $filepath = "$Tab::file_root/files/tourns/".$tourn->id."/postings/".$file->id;
	
       	my $garbage = `rm -f $filepath`;
       	$garbage = `mkdir -p $filepath`;
       	my $filetemp = $upload->tempname;
       	$garbage = `cp $filetemp $filepath/$filename`;

		system $Tab::s3_cmd." put $filepath/$filename ".$Tab::s3_bucket."/tourns/".$tourn->id."/postings/".$file->id."/";

       	$file->name($filename);
       	$file->update;

		$msg = "Posting ".$label." has been uploaded and made public";
   	}

	$m->redirect("/setup/web/postings.mhtml?msg=$msg");
		
</%init>
