<%args>
	$account
	$circuit
	$tourn_id
	$invite => undef
</%args>
<%init>

	my $tourn = Tab::Tournament->retrieve($tourn_id);

	my @is_admin = Tab::CircuitAdmin->search( account => $account->id, circuit => $circuit->id );

	# Allow tournament directors to edit their tournaments and upload invites. 
	# This is an ugly hack.  I like it!  Smooches to Janjan.
	push (@is_admin, 1) if $tourn->director->id == $account->id;

	unless ($account->site_admin || @is_admin) { 
		$m->print("
			<h4>Error:</h4><p><b>Only site admins or circuit 
				officials may edit the website. </b></p>");
		$m->abort;
	}

    if ($invite) {
        my $req = Apache2::Request->new($r);
        my $upload = $req->upload("invite");
        my $filename  = $upload->filename;
        $filename =~ s/.*[\/\\](.*)/$1/;
        $filename =~ s/\ //g;
        $filename =~ s/\'//g;  # '  stupid vim
        my $filepath = "$Tab::file_root/files/".$circuit->id."/tournaments/".$tourn->id."/";
        my $garbage = `rm -f $filepath`;
        $garbage = `mkdir -p $filepath`;
        my $filetemp = $upload->tempname;
        $garbage = `cp $filetemp $filepath/$filename`;
        $tourn->invitename($filename);
        $tourn->update;
	}

	my $msg = "Invite uploaded";

	$m->redirect("edit.mhtml?msg=$msg");

</%init>

