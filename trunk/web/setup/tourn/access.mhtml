<%args>
	$account
	$tourn
	$perms
</%args>
<%init>

	my %seen = (); 
	my @admins = grep { ! $seen{$_->id} ++ } $tourn->admins;

	my @all_perms = Tab::Permission->search( tourn => $tourn->id );
	my %admin_perms = ();

	foreach my $perm (@all_perms) { 
		$admin_perms{$perm->account->id}{$perm->tag} = $perm;
	}

</%init>

	<script type="text/javascript">
        function showLimits (it, radio) { 
			if (radio.checked) { 
				$("#"+it).show("fold");
			} else { 
				$("#"+it).hide("fold");
			}
        } 
        function hideLimits (it, radio) { 
			if (radio.checked) { 
				$("#"+it).hide("fold");
			}
        } 
    </script>

	<div class="main">
	
		<h2><% $tourn->name %></h2>

		<& tabbar.mas, tourn => $tourn, whoami => "access" &>

		<h4>Administrator Access</h4>

		<& "/funclib/tablesorter.mas", table => "tableme" &>

		<form action="access_save.mhtml" method="post">

		<table id="tableme">

%			if (@admins) { 
	
				<thead>

				<tr class="yellowrow">
				
					<th class="smallish">	
						Person
					</th>

					<th class="smallish">
						Contact	
					</th>

					<th class="smallish">
						Access Level
					</th>

					<th class="smaller">
					</th>
				
				</tr>

				</thead>

				<tbody>

% 				foreach my $admin (@admins) { 

					<tr>
	
						<td title="<% $admin->email %>">
							<% $admin->first." ".$admin->last %>
						</td>

						<td class="centeralign">
							<input type="checkbox" name="<% $admin->id %>_contact" value="1" 
								<% $account->site_admin || $admin_perms{$account->id}{"owner"} || $admin_perms{$account->id}{"contact"} ? "" : 'disabled' %>
								<% $admin_perms{$admin->id}{"contact"} ? 'checked="checked"' : "" %>>
						</td>

						<td class="centeralign padno">
%							if ($admin_perms{$account->id}{"owner"} || $account->site_admin) { 
								<label for="<% $admin->id %>_owner">
								<span class="quarter padless marno hover">
									Owner <input type="radio" id="<% $admin->id %>_owner" name="<% $admin->id %>_level" value="owner" <% $admin_perms{$admin->id}{"owner"} ? 'checked="checked"' : "" %>
									onclick="hideLimits(<% $admin->id %>, this)" <% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %> >
								</span>
								</label>
%							} elsif ($admin_perms{$admin->id}{"owner"}) {
								Tournament Owner
%							} 

%							unless ($admin_perms{$admin->id}{"owner"} &! ($admin_perms{$account->id}{"owner"} || $account->site_admin)) { 

								<label for="<% $admin->id %>_full_admin">
									<span class="quarter padless marno hover">
										Admin <input type="radio" id="<% $admin->id %>_full_admin" name="<% $admin->id %>_level" value="full_admin" <% $admin_perms{$admin->id}{"full_admin"} ? 'checked="checked"' : "" %>
										onclick="hideLimits(<% $admin->id %>, this)" <% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %> >
									</span>
								</label>

								<label for="<% $admin->id %>_limited">
									<span class="quarter padless marno hover">
										Limited <input type="radio" id="<% $admin->id %>_limited" name="<% $admin->id %>_level" value="limited" 
											onclick="showLimits(<% $admin->id %>, this)" <% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %> >
									</span>
								</label>

								<label for="<% $admin->id %>_entry_only">
									<span class="quarter padless marno hover nowrap">
										Entry Only <input type="radio" id="<% $admin->id %>_entry_only" name="<% $admin->id %>_level" value="entry_only" <% $admin_perms{$admin->id}{"entry_only"} ? 'checked="checked"' : "" %>
										onclick="hideLimits(<% $admin->id %>, this)" <% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %> >
									</span>
								</label>
%							} 

							<div class="bordertop nospace" id="<% $admin->id %>" style="<% $admin_perms{$admin->id}{"limited"} ? "" : 'display: none;' %>">

								<span class="sixth padless marno hover nowrap">
									Limit To:
								</span>

								<label for="<% $admin->id %>_registration">
									<span class="threetenths padless marno hover nowrap">
										Registration <input type="checkbox" name="<% $admin->id %>_registration" value=1" id="<% $admin->id %>_registration">
									</span>
								</label>

								<label for="<% $admin->id %>_tabbing">
									<span class="quarter padless marno hover nowrap">
										Tabbing <input type="checkbox" name="<% $admin->id %>_tabbing" value=1" id="<% $admin->id %>_tabbing">
									</span>
								</label>

								<label for="<% $admin->id %>_group_tabbing">
									<span class="threetenths padless marno hover nowrap">
										Some Events <input type="checkbox" name="<% $admin->id %>_group_tabbing" value=1" id="<% $admin->id %>_group_tabbing"
											onclick="showLimits('<% $admin->id."_groups" %>', this)" <% $admin_perms{$admin->id}{"group_tabbing"} ? 'checked="checked"' : "" %> >
									</span>
								</label>

							</div>

							<div id="<% $admin->id %>_groups" class="bordertop nospace" style="<% $admin_perms{$admin->id}{"group_tabbing"} ? "" : 'display: none;' %>">

								<span class="half">
									Judge Group:
								</span>

								<span class="half centeralign">
									<select name="<% $admin->id %>_judge_group" class="fixedmed plain">
										<option value=""></option>
%										foreach my $judge_group ($tourn->judge_groups) { 
											<option value="<% $judge_group->id %>" <% $judge_group->id == $admin_perms{$admin->id}{"group_tabbing"} ? 'selected="selected"': "" %>>
												<% $judge_group->name %>
											</option>
%										}
									</select>
								</span>

							</div>

						</td>

						<td class="centeralign padno">
%							unless ($admin_perms{$admin->id}{"owner"} &! ($admin_perms{$account->id}{"owner"} || $account->site_admin)) { 
								<a class="dkred button" href="access_rm.mhtml?admin_id=<% $admin->id %>">Remove</a>
%							}
						</td>

					</tr>
%				}

				<tr class="libl">
					<td class="rightalign" colspan="10">
						<input type="submit" value="Save Permissions">
						</form>
					</td>
				</tr>

				<tbody>

%			}

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Add New Staff:</h4>

			<form action="access_add.mhtml" method="post">
			<input type="hidden" name="tourn_id" value="<% $tourn %>">

			<div class="row centeralign padmuchmore">
				<input type="text" name="email" size="28" placeholder="Email address">
			</div>

			<div class="libl marno padmore rightalign">
				<input  type="submit" value="  Grant Access  ">
				</form>
			</div>

		</div>

	</div>

