<%args>
	$tourn
	$event_id        => undef
	$round_highlight => undef
</%args> 
<%init> 

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my @sites = $m->comp("/funclib/tourn_sites.mas", tourn => $tourn);

	my $default_site = $sites[0]->id if @sites && scalar @sites < 2;

	my $event = Tab::Event->retrieve($event_id);
	$m->abort unless $event;
	$m->abort unless $event->judge_group;

	my @jpools = $event->judge_group->jpools if $event;
	my $default_jpool = $jpools[0]->id if @jpools && scalar @jpools < 2;

	my $switch;

	my $debate++ if $event->type ne "congress" && $event->type ne "speech";

</%init>

	<script type="text/javascript"> 
		function showMe (it, box) { 
			var vis = (box.checked) ? "block" : "none"; 
			document.getElementById(it).style.display = vis;
		} 
	</script>

	<& menu.mas, tourn => $tourn, event => $event, days => \@days &>

%	my $current_day;

	<div class="main">
	
		<h2>Round Schedule for <% $event->name %></h2>

		<table class="narrow">

			<form action="event_save.mhtml" method="post">
			<input type="hidden" name="event_id" value="<% $event->id %>">

%			foreach my $timeslot (sort {$a->start->epoch <=> $b->start->epoch } $tourn->timeslots ) { 

%				my $onclick = "showMe('label_".$timeslot->id."', this)";
%				$onclick .= ",showMe('type_".$timeslot->id."', this)";
%				$onclick .= ",showMe('tiebreaks_".$timeslot->id."', this)";
%				$onclick .= ",showMe('flights_".$timeslot->id."', this)";
%				$onclick .= ",showMe('site_".$timeslot->id."', this)" if scalar @sites > 1;
%				$onclick .= ",showMe('pool_".$timeslot->id."', this)" if scalar @jpools > 1;
%				$onclick .= ",showMe('flights_".$timeslot->id."', this)" if scalar @jpools > 1;

%				if (not defined $current_day or $current_day->day != $timeslot->start->set_time_zone($tz)->day) { 

%					$current_day = $timeslot->start;

					<tr class="yellowrow">

						<th class="smaller">
							<% $current_day->day_abbr %>
							<% Tab::niceshortdate($current_day) %>
						</th>

						<th class="smaller">
							Y/N
						</th>

						<th colspan="2" class="smaller">
							Label
						</th>

						<th class="smaller">
							Type
						</th>

						<th class="smaller">
							Tiebreaks
						</th>

%						if (scalar @sites > 1) { 
							<th class="smaller">
								Site
							</th>
%						}

%						if (@jpools) { 
							<th class="smaller">
								Pool
							</th>
%						}

%						if ($debate)  {
							<th class="smaller">
								Flts
							</th>
%						}

						</th>

					</tr>

%				}

%				my @rounds = Tab::Round->search(timeslot => $timeslot->id, event => $event->id);
%				my $round = shift @rounds if @rounds;

				<tr class="<% $round && $round_highlight == $round->id ? "lirdrow" : $switch++ % 2 ? "oddrow" : "evenrow" %>">

					<td class="smaller nowrap">

						<div class="nospace">

%						if (scalar @sites > 1 && scalar @jpools > 1) {
							<% substr($timeslot->name,0,9) %>
%						} else { 
							<% $timeslot->name %> 
%						}

						</div>

						<div class="padno martophalf">
							<% Tab::shorttime($timeslot->start->set_time_zone($tz)) %>
						</div>

					</td>

					<td class="centeralign">
						<label for="<% $timeslot->id %>">
						<div class="hover">
						<input type="checkbox" id="<% $timeslot->id %>" name="<% $timeslot->id %>" value="1" onclick="<% $onclick %>"
							<% ($round) ? "checked" : "" %>/> 
						</div>
						</label>
					</td>

					<td class="smallish">
						<% ($round) ? $round->name : "" %>
					</td>

					<td class="smallish">
						<div class="nospace" id="label_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">
							<input type="text" size="4" name="<% $timeslot->id %>_label" placeholder="Label" 
								value="<% ($round && $round->label) ? $round->label : "" %>">
						</div>
					</td>

					<td>
						<div id="type_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">
							<select name="<% $timeslot->id %>_type" class="smallish plain">  
							
								<option value="prelim" <% ($round && $round->type eq "prelim") ? "selected" : "" %> >
									Prelim/Preset
								</option>

								<option value="highlow" <% ($round && $round->type eq "highlow") ? "selected" : "" %> >
									Hi/Lo
								</option>	

								<option value="highhigh" <% ($round && $round->type eq "highhigh") ? "selected" : "" %> >
									Hi/Hi
								</option>	

								<option value="elim" <% ($round && $round->type eq "elim") ? "selected" : "" %> >
									Elim
								</option>

								<option value="final" <% ($round && $round->type eq "final") ? "selected" : "" %> >
									Final
								</option>

							</select>

						</div>

					</td>

					<td class="smallish <% $round && $round->id == $round_highlight ? "dkred" : "" %> ">
						<div id="tiebreaks_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">

						<select name="<% $timeslot->id %>_tb_set" class="fixedsmaller plain"> 

							<option value=""></option>

%							foreach my $tb_set ($tourn->tiebreak_sets( type => "Team")) { 
								<option value="<% $tb_set->id %>"  <% $round && $round->tb_set && $round->tb_set->id == $tb_set->id ? "selected" : "" %> >
									<% ucfirst($tb_set->name) %>
								</option>
%							}

						</select>
						</div>

					</td>

%					if (scalar @sites > 1) { 

						<td class="smallish">
						
							<div id="site_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">

								<select name="<% $timeslot->id %>_site" class="fixedsmaller plain">

%									foreach my $site (@sites) { 

										<option value="<% $site->id %>" <% ($round && $site->id == $round->site->id) ? 'selected' : "" %>>
											<% $site->name %>
										</option>
%									}
								</select>

							</div>

						</td>

%					} else { 

						<input type="hidden" name="<% $timeslot->id %>_site" value="<% $default_site %>">

%					}

%					if (@jpools) { 

						<td>
						
							<div id="pool_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">

								<select name="<% $timeslot->id %>_jpool" class="fixedsmaller plain">

									<option value="">All Judges</option>

%									foreach my $jpool (@jpools) { 
										<option value="<% $jpool->id %>" <% $round && $round->jpool && $round->jpool->id == $jpool->id ? "selected" : "" %>>
											<% $jpool->name %>
										</option>
%									}

								</select>

							</div>

						</td>

%					} else { 

						<input type="hidden" name="<% $timeslot->id %>_jpool" value="<% $default_jpool %>">

%					}

%					if ($debate) { 

						<td>
							<div id="flights_<% $timeslot->id %>" style="<% ($round) ? "display: block;" : "display: none;" %>">
								<select name="<% $timeslot->id %>_flight" class="plain">
									<option value="1" <% $round && $round->flighted == 1 ? "selected" : ""%>>1</option>
									<option value="2" <% $round && $round->flighted == 2 ? "selected" : ""%>>2</option>
									<option value="3" <% $round && $round->flighted == 3 ? "selected" : ""%>>3</option>
								</select>
							</div>
						</td>
%					}

				</tr>

%			}

			<tr class="liblrow">

				<td colspan="10" class="rightalign">
					<input type="submit" value="  Save Rounds  " class="thin">
					</form>
				</td>

			</tr>

		</table>


	</div>

