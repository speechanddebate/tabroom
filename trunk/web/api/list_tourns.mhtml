<%args>
	$username => undef
	$password => undef
	$all => undef
	$debug => 0
</%args>
<%init>

	use Crypt::PasswdMD5;
	use XML::Simple;
	use Data::Dumper;

	my ($account) = Tab::Account->search( email => lc($username) );

	unless ($account) { 
		$m->print("<error>No account with the email ".$username." was found.</error>");
		$m->abort;
	} 

	$password =~ s/\s+$//g;
	my $db_password = $account->passhash;
   	my $verify_password = unix_md5_crypt($password,$db_password);
   
   	unless ($verify_password eq $db_password) { 
		$m->print("<error>Password incorrect for ".$username.".</error>");
		$m->abort;
	}

	my $tourns = [];
	my $events = [];
	
	foreach my $tourn ($m->comp('/funclib/account_tourns.mas', account => $account, all => $all)) {

		my $tourn = {
			TOURNNAME => $tourn->name,
			STARTDATE => Tab::xmldt($tourn->start),
			ENDDATE => Tab::xmldt($tourn->end),
			DOWNLOADSITE => "idebate.org"
		};

		push (@{$tourns}, $tourn);
	
		my $events = [];

		foreach my $event ($tourn->events) { 

			my $xml_event = {
				EVENTNAME => $event->name,
				EVENTID => $event->id,
				TOURN => $tourn->id
			};
		}
	}


	my $xml_hash = {
		TOURN => $tourns
		EVENT => $events
	};

	my $filename = "TournList-$account";
	my $filepath = $Tab::file_root."tmp/".$filename;
	`rm -f $filepath.*`; 

	my $xs = new XML::Simple();
	my $xml = $xs->XMLout($xml_hash, RootName => 'TOURNLIST', NoAttr => 1, XMLDecl => 1, OutputFile => "$filepath.xml");

	$m->redirect("$Tab::url_prefix/tmp/$filename.xml");
	
</%init>
