<%args>
	$session
	$account	
	$league_id => undef
	$tz
</%args>
<%init>

	my @approvals;
	my @deapprovals;

	my $now = DateTime->now;

	if ($league_id) { 

		@approvals = Tab::Tournament->search_where(  
			league => $league_id, 
			approved => 0, 
			start => { '>', DateTime::Format::MySQL->format_datetime($now) } );

		@deapprovals = Tab::Tournament->search_where(  
			league => $league_id, 
			approved => 1, 
			start => { '>', DateTime::Format::MySQL->format_datetime($now) } );

		my $league = Tab::League->retrieve($league_id);
		$session->league($league);
		$session->update;

	} elsif ($account->site_admin) { 
		
		@approvals = Tab::Tournament->search_where(  
			approved => 0, 
			start => { '>', DateTime::Format::MySQL->format_datetime($now) } );

		@deapprovals = Tab::Tournament->search_where(  
			approved => 1, 
			start => { '>', DateTime::Format::MySQL->format_datetime($now) } );

	}

	my $switch ;

	my $school_year = Tab->school_year;

</%init>

%	if (@approvals) { 

		<h3>Tournaments Pending Approval</h3>

%	}

		<table cellpadding="6" cellspacing="1" width="100%">

%			foreach my $tourn (sort {$a->start->epoch <=> $b->start->epoch} @approvals) { 

%				next unless $tourn->start->epoch > $school_year->epoch;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th class="smaller">
						<a href="tourn_edit.mhtml?tourn_id=<% $tourn->id %>" class="whiteblock">
							<% $tourn->name %>
						</a>
					</th>

%					if ($account->site_admin && not defined $league_id) { 
						<td class="smaller">
							<a href="/admin/league_edit.mhtml?league_id=<% $tourn->league->id %>" class="whiteblock">
								<% $tourn->league->short_name %>
							</a>
						</td>

%					}

					<td class="smaller">
						<% Tab::niceshortdate($tourn->start->set_time_zone($tz)) %>
						<% ($tourn->start->mdy('') == $tourn->end->mdy('')) ? "" : "-".Tab::niceshortdate($tourn->end->set_time_zone($tz)) %>
					</td>

					<td class="smaller">
						<% $tourn->director->first." ".$tourn->director->last %>
					</td>

					<td class="smaller">
						<a href="approve.mhtml?tourn_id=<% $tourn->id %>&league_id=<% $league_id %>" class="whiteblock">
							Approve
						</a>
					</td>

					<td class="smaller">
						<a href="delete_tournament.mhtml?tourn_id=<% $tourn->id %>" class="whiteblock"
							onClick="if(confirm('Are you sure you want to delete <% $tourn->name %>?'))
								return true;	
								else return false;"
						>
							Delete
						</a>
					</td>

				</tr>

%			}

		</table>

%	if (@deapprovals) { 
		<h3>Approved Tournaments</h3>
%	}

		<table cellpadding="6" cellspacing="1" width="100%">

%			foreach my $tourn (sort {$a->start->epoch <=> $b->start->epoch} @deapprovals) { 

%				next unless $tourn->start->epoch > $school_year->epoch;

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th class="smaller">
						<a href="tourn_edit.mhtml?tourn_id=<% $tourn->id %>" class="whiteblock">
						<% $tourn->name %>
						</a>
					</th>

%					if ($account->site_admin && not defined $league_id) { 
						<td class="smaller">
							<a href="/admin/league_edit.mhtml?league_id=<% $tourn->league->id %>" class="whiteblock">
								<% $tourn->league->short_name %>
							</a>
						</td>

%					}

					<td class="smaller">
						<% Tab::niceshortdate($tourn->start->set_time_zone($tz)) %>
						<% ($tourn->start->mdy('') == $tourn->end->mdy('')) ? "" : "-".Tab::niceshortdate($tourn->end->set_time_zone($tz)) %>
					</td>

					<td class="smaller">
						<% $tourn->director->first." ".$tourn->director->last %>
					</td>

					<td class="smaller">
						<a href="deapprove.mhtml?tourn_id=<% $tourn->id %>&league_id=<% $league_id %>" class="whiteblock">
							Refudiate!
						</a>
					</td>

				</tr>

%			}

	</table>
