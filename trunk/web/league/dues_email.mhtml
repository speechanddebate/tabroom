<%args>
	$circuit
	$account
	$chapter_id
</%args>
<%init>

	use Text::Wrap;
	use Mail::Mailer;
	$Text::Wrap::columns = 72;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my @cls = Tab::ChapterCircuit->search( chapter => $chapter->id, circuit => $circuit->id);
	my $cl = shift @cls if @cls;
	$m->abort unless $cl;
	$m->abort unless $cl->membership;
	$m->abort unless $cl->membership->dues;

    my $school_year_begins = Tab::school_year;

    my @payments = Tab::Dues->search_where(
                    chapter => $chapter->id,
                    paid_on => {">=", DateTime::Format::MySQL->format_date($school_year_begins) } );

    my $paid;

    foreach my $payment (@payments) {
        $paid += $payment->amount;
    }

    my $name;

    if ($cl->paid) { $name = "Receipt"; } else { $name = "Invoice"; }

    my $owed = $cl->membership->dues;
    $owed = $paid if $cl->paid;
	my $membership_name = $cl->membership->name;

	my $left = $owed - $paid;

	my $treasurer = $circuit->dues_to;

	my $treasurer_address = $treasurer->first." ".$treasurer->last."\n".$treasurer->street."\n".$treasurer->city.", ".$treasurer->state." ".sprintf("%05d", $treasurer->zip)."\n";

	my $chapter_name = $chapter->name;
	my $circuit_name = $circuit->name;

	my $subject = "Dues invoice for ".$chapter->name;

	my $text = " 

$name

Annual $circuit_name dues.


------------------------------------------------

$chapter_name  $membership_name 

Dues:    		\$ $owed
Paid:			\$ $paid
Amount due: 		\$ $left


Please send payments to:

$treasurer_address 

This invoice is being sent to every coach listed in the database for
your chapter school.  You need only pay it once per school.

You may download a printable copy of this invoice from your account on
Tabroom.com.  Click \"Manage\" next to the circuit's name on your home
screen.

	";

	$text = $text."\n\n".wrap('','',$circuit->invoice_message);
	$text = $text."\n\n\n";

	my @accounts = $chapter->coaches;

	foreach my $sendto (@accounts) { 

		my $mail = new Mail::Mailer 'smtp', Server => $Tab::smtp_server;
		my $from = $account->first." ".$account->last." <".$account->email.">";
		my $to = $sendto->first." ".$sendto->last." <".$sendto->email.">";

		$mail->open({ 
			From => $from,
       	    To => $to,
			Subject => $subject,
     	});

		print $mail $text."\n\n";
		$mail->close();

	}

	my $err = "Invoice has been sent";

	$m->redirect("$Tab::url_prefix/circuit/dues.mhtml?err=$err");

</%init>
