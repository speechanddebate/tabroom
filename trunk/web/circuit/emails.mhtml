<%args>
	$circuit
	$account
	$year => undef
</%args>
<%init>

	my @email_items = Tab::Email->search( circuit => $circuit );

	my @this_years_email;

	my @is_admin = Tab::CircuitAdmin->search( circuit => $circuit->id, account => $account->id );

	unless ($year) { 
		my $now = DateTime->now; 
		$year = $now->year; 
		$year-- if $now->month < 7;
	};

	my %year_keys = ();

	foreach my $email (@email_items) { 
	
		my $senton = $email->senton;
		my $senton_year = $senton->year;
		$senton_year-- if $senton->month < 7;
		$year_keys{$senton_year}++;
		if ($senton_year == $year) {
			push (@this_years_email, $email);
		}
	}

	@this_years_email = sort {$b->senton->epoch <=> $a->senton->epoch} @this_years_email;

	my @years = keys %year_keys;
	@years = sort {$b <=> $a} @years;

	my $switch;

</%init>
	
	<table cellpadding="4" cellspacing="1" width="100%">

		<tr>
			<td width="100%">
				<h2><% $circuit->short_name %> Emails</h2>
			</td>

			<td>
				<form action="email_compose.mhtml" method="post">
				<input type="submit" class="grey" value="Compose Email">
				</form>
			</td>

		</tr>

	</table>

	<table cellpadding="4" cellspacing="1" width="100%">

		<tr class="evenrow">

			<td>
				School year:
			</td>

			<td class="center">
				<form action="emails.mhtml" method="post"> 

				<select name="year"> 
%					foreach my $menu_year (@years) { 
						<option value="<% $menu_year %>" 
							<% ($year == $menu_year) ? "selected" : "" %> ><% $menu_year."-".($menu_year + 1) %>
						</option>
% 					}
				</select>

			</td>

			<td class="right">

				<input class="grey" type="submit" value="Search">
				</form>

			</td>

		</tr>

	</table>

% 	if ($year) { 

	<table cellpadding="4" cellspacing="1" width="100%">

		<tr>
			<td colspan="5">
				<h4>Emails sent in <% $year."-".($year + 1) %> school year</h4>
			</td>
		</tr>

% 		foreach my $email (@this_years_email) { 

%			my $senton = $email->senton;

%			$senton->set_time_zone($circuit->timezone);

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
			
				<td class="smaller" width="30%">
					<% $email->subject %>
				</td>

				<td class="smaller">
					<% substr($email->sender->first,0,1)." ".$email->sender->last %>
				</td>

				<td class="smaller">
					<% $senton->month."/".$senton->day %>
				</td>

				<td class="smaller" width="30%">
					<% $email->sent_to %>
				</td>

				<td>
					<form action="email_view.mhtml" method="post">
					<input type="hidden" name="email_id" value="<% $email->id %>">
					<input type="submit" class="skinny" value="View">
					</form>
				</td>

			</tr>

% 		} 

%	} 

	</table>
