<%args>
	$circuit
	$event_id => undef
	$method
	$name
 	$type
	$abbr
	$team
	$text => undef
	$ballot => undef
</%args>

<%init>

	my $err;
	my $msg;
	my $event;

	$text =~ s/\r/\n/g;
	$text =~ s/\n\n/\n/g;

	if ($event_id) { 
	
		$event = Tab::Event->retrieve($event_id);
	
		$event->name($name);
 		$event->type($type);
		$event->abbr($abbr);
		$event->text($text);
		$event->team($team);
		$event->method($method);
		$event->update;		
		$msg = "Event changes saved";
	
	} else { 

		$event = Tab::Event->create({
			name => $name,
			type => $type,
			abbr => $abbr,
			text => $text,
			team => $team,
			method => $method
		});
	}

	if ($ballot) {
       	my $req = Apache2::Request->new($r);
       	my $upload = $req->upload("ballot");
       	my $filename  = $upload->filename;
       	$filename =~ s/.*[\/\\](.*)/$1/;
       	$filename =~ s/\ //g;
       	$filename =~ s/\'//g;  # '  stupid vim
      	my $filepath = "$Tab::file_root/files/methods/".$method."/events/".$event->id;
       	my $garbage = `rm -f $filepath`;
       	$garbage = `mkdir -p $filepath`;
       	my $filetemp = $upload->tempname;
       	$garbage = `cp $filetemp $filepath/$filename`;
       	$event->ballot($filename);
       	$event->update;
    }

	$m->redirect("$Tab::url_prefix/circuit/event_edit.mhtml?event_id=".$event->id."&msg=$msg");
		
</%init>
