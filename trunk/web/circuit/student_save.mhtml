<%args>
	$circuit
	$account
	$chapter_id
	$student_id => undef
	$first =>  undef
	$last => undef
	$grad_year => undef
	$novice => '0'
	$retired => '0'
	$gender => undef 
	$from => undef
</%args>
<%init> 

	my $err;
	my $student;
	my $now = DateTime->now;
	$now->set_time_zone($tourn->tz);

	unless ($first) { 
		$err = "WARNING: You have not supplied a first name ";
	}

	unless ($last) { 
		$err = "WARNING: You have not supplied a last name " unless $err;
		$err = $err ." or last name " if $err;
	}

	if ($grad_year) { 

		my $now_year = $now->year;
		$now_year++ if $now->month > 6;
		
		if ($grad_year > ($now_year + 14)) {
			$err = "WARNING:  You have entered a graduation year far in the future";
		}

	} else { 
		$err = "WARNING: You have not supplied a year of graduation" unless $err;
		$err = $err ." or year of graduation " if $err;
	}

	if ($err) { 

		$err = $err. ". Student not saved.";

		$m->redirect("$Tab::url_prefix/circuit/student_edit.mhtml?student_id=$student_id&err=$err") if ($student_id);
		$m->redirect("$Tab::url_prefix/circuit/students_view.mhtml?chapter_id=$chapter_id&err=$err");
	}		

	if ($student_id) { 

		$student = Tab::Student->retrieve($student_id);
		my $student_chapter = $student->chapter;
		my $student_chapter_id = $student_chapter->id;

		$student->first($first);
		$student->last($last);
		$student->grad_year($grad_year);
		$student->novice($novice);
		$student->retired($retired);
		$student->gender($gender);
		$student->chapter($chapter_id);
		$student->update;
		$err = $err ." Changes have been saved to ". $first." ".$last;

	} else { 

		$student = Tab::Student->create({ 	
			first => $first,
			last => $last,
			grad_year => $grad_year,
			novice => $novice,
			retired => $retired,
			gender => $gender,
			chapter => $chapter_id
		});

		$err = $err." ".$first." ".$last." has been added to this school.";
	}

	$m->redirect("$Tab::url_prefix/circuit/student_edit.mhtml?err=$err&student_id=$student_id") if $from eq "edit";
	$m->redirect("$Tab::url_prefix/circuit/students_view.mhtml?err=$err&chapter_id=$chapter_id");

</%init> 


