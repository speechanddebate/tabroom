<%args> 
	$circuit
	$account
	$year => undef
</%args>
<%init>

	my $err;
	
	my @is_admin = Tab::CircuitAdmin->search( circuit => $circuit->id, account => $account->id );

	unless ($account->site_admin || @is_admin) { 

		$err = "Only site admins may access that page";
		$m->redirect("$Tab::url_prefix/accounts/index.mhtml?err=$err");

	} 

	my $now = DateTime->now(time_zone => $circuit->timezone);
		
	my $foo++ unless $year;

	$year = $now->year unless $year;

	if ($now->month > 6 && $foo)  {
		$year++;
	}

	my $begin = DateTime->new( 
		year => $year - 1,
		month => 7,
		day  => 01 );

	my $stop = DateTime->new(
		year => $year,
		month => 6,
		day => 30 );

	my @all_tournaments = Tab::Tourn->search( circuit => $circuit->id );

	my @tournaments;

	foreach my $at (@all_tournaments) { 
		push (@tournaments, $at) if ($at->start > $begin && $at->end < $stop);
	}

	@tournaments = sort {$a->start <=> $b->start } @tournaments;

</%init>


	<table cellpadding="2" cellspacing="1" border="0" width="100%">

		<tr>
			<td width="100%"class="right" colspan="4"> 
				<h2>The <% $circuit->short_name." ".$year." season "%></h2>
			</td>

			<td>
				<form action="tourn_edit.mhtml" method="post">
				<input  type="submit" value="Add Tournament">
				</form>
			</td>
		</tr>

	</table>

	<table cellpadding="3" cellspacing="1" border="0" width="100%">

		<tr class="lirdrow">

			<th>Name</th>

			<th>Main Contact</th>

			<th>Date(s)</th>

			<th></th>

		</tr>

% 		my $switch;

%		foreach my $tourn (@tournaments) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

% 				my $start = $tourn->start;
% 				my $end = $tourn->end;
%				$start->set_time_zone($circuit->timezone);
%				$end->set_time_zone($circuit->timezone);

				<td class="smaller">
					<a href="tourn_edit.mhtml?tourn_id=<% $tourn->id %>" class="whiteblock">
					<% $tourn->name %>
					</a>
				</td>
	
				<td class="smaller">
					<% $tourn->director->first." ".$tourn->director->last %>
				</td>
	
				<td class="smaller">
					<% Tab::niceshortdate($start) %>
					<% ($start->day != $end->day) ? " - ".Tab::niceshortdate($end) : "" %>
				</td>
	
				<td class="smaller">
					<a class="whiteblock" href="tourn_rm.mhtml?tourn_id=<% $tourn->id %>">Delete</a>
				</td>
	
			</tr>
	
%		}

	</table>

	<hr />

	<table cellpadding="5" cellspacing="1" width="100%">
		<tr class="evenrow">

			<td colspan="2">
				<form action="tournaments.mhtml" method="post">
				View School Year ending:
			</td>
			
			<td colspan="2" class="center">
				<input type="text" name="year" size="5" value="<% $year %>"> 
			</td>

			<td class="center">
				<input  type="submit" value=" Show Schedule ">
				</form>
			</td>

		</tr>
	
	</table>
	

