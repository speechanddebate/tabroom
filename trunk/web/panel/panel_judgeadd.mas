<%args>
	$panel_id
	$judge_id => undef
	$judge_code => undef
	$tourn
	$shut_up => undef
	$from => undef
	$debug => undef
</%args>
<%init> 

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	unless ($judge) { 
		
		# This searches a judge by code for the "Damn the Torpedoes" function.
		# which force-adds a judge despite all strikes and reason.

		my @judges = Tab::Judge->search( 
				tournament => $tourn->id, 
				code => $judge_code) 
				if $judge_code;

		$judge = shift @judges if @judges;

	}

	unless ($judge) { 

		$m->print("<p>That judge does not exist.  No</p>");
		$m->abort;

	}

	system "$Tab::logger  Creating ballot for judge ".$judge->code if $debug;
	
	my $panel = Tab::Panel->retrieve($panel_id); 

	unless ($panel) { 
		$m->print("That panel does not exist.  Hit back and try again");
		$m->abort;
	}

	my @ballots = $panel->ballots;

	foreach ($panel->judges) {

		if ($_->id == $judge_id) {

			my $err = "Judge already assigned to this panel";
			system "$Tab::logger  $err " if $debug;

			return if $shut_up;

			if ($from eq "round_edit") {
				$m->redirect("$Tab::url_prefix/setup/round_edit.mhtml?round_id=".$panel->round->id);
			} 

			if ($from eq "pre") {	
				$m->redirect("$Tab::url_prefix/panel/prepanel_judges.mhtml?panel_id=".$panel->id);
			} 

			$m->redirect("$Tab::url_prefix/panel/panel_view.mhtml?panel_id=$panel_id");

		}	

	}

	if (@ballots && $ballots[0]->comp) { 

		# Are these ballots without judges? 
		my $alldone;

		BALLOT:
		foreach my $ballot (@ballots) { 
		    if ($ballot->judge) { next BALLOT if $ballot->judge->id != 0; }
			$ballot->judge($judge->id);
			$ballot->update;
			$alldone++;
		}

		unless ($alldone) { 

		# Create a ballot for that judge for every comp in the round
		my @entries = $panel->entries;
		foreach my $comp (@entries) { 
			my $ballot = Tab::Ballot->create({ 
				comp => $comp->id,
				judge => $judge->id,
				speechnumber => 1,
				speakerorder => 0,
				panel => $panel->id
			});

			$ballot->seed($comp->seed($panel)) 	if $panel->type ne "prelim";

			if ($comp->speakerorder($panel)) { 
				$ballot->speakerorder($comp->speakerorder($panel));
			} 

			$ballot->update;

			}
		
		}

	} else {

		# If there are no ballots, or only ballots without any kids in them,
		# we must be pre paneling a round.   Therefore, we create a single ballot
		# with a judge but no kid. 

		my $ballot = Tab::Ballot->create({
			judge => $judge->id,
			speechnumber => 1,
			panel => $panel->id,
			speakerorder => 0
		});

	}	#end of if @ballots 

	return if $shut_up;

	my $err = "Judge assigned to this panel";

	if ($from eq "round_edit") {
		$m->redirect("$Tab::url_prefix/setup/round_edit.mhtml?round_id=".$panel->round->id);
	} 

	if ($from eq "pre") {
		$m->redirect("$Tab::url_prefix/panel/prepanel_judges.mhtml?panel_id=".$panel->id);
	} 

    my @changes = Tab::Change->search( type => "judge", moved_from => $panel->id, judge => $judge->id);

	if (@changes) { 

		foreach (@changes) { $_->delete; }

	} else { 

	    my $change = Tab::Change->create({
	        tournament => $tourn->id,
	        type => "judge",
	        judge => $judge->id,
	        panel => $panel->id
	    });

	}

	$m->redirect("$Tab::url_prefix/panel/panel_view.mhtml?panel_id=$panel_id&from=$from");

</%init> 


