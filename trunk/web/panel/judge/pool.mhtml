<%args>
	$pool_id => undef
	$tourn
	$account
	$judge_group_id => undef
</%args>
<%init>

	my $pool = Tab::Pool->retrieve($pool_id);


	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);
	my @timeslots = sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots;

	my $switch = 1;

	my $ncfl++ if $tourn->setting("ncfl");

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<div class="right small">

		<div class="sidenote">

			<h4>Judge Pools</h4>

%			my @pools = $m->comp("/funclib/tourn_pools.mas", tourn => $tourn);

%			foreach my $opool (@pools) { 
				<a class="<% $pool && $opool->id == $pool->id? "dk" : ""%>blue nowrap block" href="pool.mhtml?pool_id=<% $opool->id %>">
					<% $opool->name %>
				</a>
%			}

		</div>

	</div>
	<div class="left huge">

%		unless ($pool) { 

			<h2>Choose a pool at right to continue</h2>
	
%		} else { 

<%perl>

			$judge_group_id = $pool->judge_group->id unless $judge_group_id;
			my @pool_judges = $m->comp("/funclib/pool_judges.mas", pool => $pool);
			my $group = Tab::JudgeGroup->retrieve($judge_group_id) if $judge_group_id;

			unless ($group) { 
				my @groups = $tourn->groups;
				$group = shift @groups;
			}

			my $no_codes = $group->setting("no_codes");
			my @judges = $m->comp("/funclib/group_judges.mas", group => $group);

</%perl>

			<div class="block padno">

				<span class="bitbiggerspan ">
					<h2>Judges for <% $pool->name %></h2>
				</span>

				<span class="medbiggerspan rightalign ">

					<form action="pool.mhtml#judges" method="post">
					<input type="hidden" name="pool_id" value="<% $pool->id %>">

					<span class="smallish" style="margin-right: 15px;">
						Pull from
					</span>

					<select name="judge_group_id" onchange='this.form.submit()' class="fixedsmall">
%						foreach my $group ($tourn->groups) { 
							<option value="<% $group->id %>" <% $group->id == $judge_group_id ? "selected" : "" %> >
								<% $group->name %>
							</option>
%						} 
					</select>
				</span>

			</div>

			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.judge").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"1", pool_id:"<% $pool_id %>" },
								success: function(data) { 
									$(spanstring).removeClass('greynohover').addClass('bluenohover');
								}

							});
						} else {
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"0", pool_id:"<% $pool_id %>" },
								success: function(data){ 
									$(spanstring).removeClass('bluenohover').addClass('greynohover');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

			<div class="halfpage">

				<h4><% scalar @pool_judges %> in pool:</h4>

%				foreach my $judge (@pool_judges) { 

%					$used{$judge->id}++;
%					my $rating = $judge->avg;
%					$rating =~ s/[0-9]//g;

					<label for="<% $judge->id %>">
					<span class="biggishblock bluenohover" id="span_<% $judge->id %>" style="height: 36px;">

						<span class="medspan medish nowrap padno">
							<% $judge->first." ".$judge->last %>
							<br />
%							unless ($no_codes) { 
								<span class="microspan smallish">
									<% $judge->code %> 
								</span>
%							}
							<span class="leftalign smallish nowrap" style="clear: both;">
								<% $judge->judge_group->abbr %> <% $rating ? " - $rating " : "" %> 
							</span>
						</span>

						<span class="huntwofive medish nowrap padno">
							<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
								<% $judge->school ? $judge->school->short_name : "Hired" %>
							</span>
%							if ($ncfl) { 
								<br />
								<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
									<% $judge->school->region->code." - ".$judge->school->region->name%>
								</span>
%							}
						</span>

						<span class="check" style="padding: 2px; vertical-align: middle;">
							<input type="checkbox" class="judge" style="margin: 0; margin-top: 2px;" id="<% $judge->id %>" name="<% $judge->id %>" value="1" checked="checked">
						</span>
					</span>
					</label>

%				}

			</div>

%			if ($group) { 

				<div class="halfpage rightfloat">

					<h4><% scalar @judges %> <% $group->abbr %> judges:</h4>

%					foreach my $judge (@judges) { 

%						next if $used{$judge->id};
%						my $rating = $judge->avg;
%						$rating =~ s/\d//g;

						<label for="<% $judge->id %>">
						<span class="biggishblock greynohover" id="span_<% $judge->id %>" style="height: 37px;">

							<span class="medspan medish nowrap padno ">
								<% $judge->first." ".$judge->last %>
								<br />
%								unless ($no_codes) { 
									<span class="microspan smallish">
										<% $judge->code %> 
									</span>
%								}
								<span class="leftalign smallish nowrap" style="clear: both;">
									<% $judge->judge_group->abbr %> <% $rating ? " - $rating " : "" %> 
								</span>
							</span>

							<span class="huntwofive medish nowrap padno ">
								<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
									<% $judge->school ? $judge->school->short_name : "Hired" %>
								</span>
%								if ($ncfl) { 
									<br />
									<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
										<% $judge->school->region->code." - ".$judge->school->region->name%>
									</span>
%								}
							</span>

							<span class="check" style="padding: 2px; vertical-align: middle;">
								<input type="checkbox" class="judge" style="margin: 0; margin-top: 2px;" id="<% $judge->id %>" name="<% $judge->id %>" value="1">
							</span>

						</span>
						</label>
%					}

				</div>
%			}
%		}

	</div>

