<%args>
	$tourn
	$account
	$pool_id       => undef
	$group_id      => undef
	$pull_group_id => undef
</%args>
<%init>

	my $pool = Tab::Pool->retrieve($pool_id);
	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);
	my @timeslots = sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots;

	my $switch = 1;
	my $ncfl++ if $tourn->setting("ncfl");

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<div class="right small">

		<div class="sidenote">

			<h4>Judge Group</h4>

			<form action="pool.mhtml" method="post">

			<div class="evenrow block">
				<select name="group_id" class="fixedmed" onchange='this.form.submit()' data-placeholder="Choose group..">
					<option value=""></option>
%					foreach my $group ($tourn->groups) { 
						<option <% $group->id == $group_id ? "selected" : "" %> value="<% $group->id %>"><% $group->name %></option>
%					}
				</select>
			</div>

			</form>

%			if ($group) { 

				<h4>Judge Pools</h4>

%				my @pools = $group->pools;

%				foreach my $opool (@pools) { 
					<a class="<% $pool && $opool->id == $pool->id? "dk" : ""%>yellow nowrap block" href="pool.mhtml?pool_id=<% $opool->id %>&group_id=<% $group->id %>">
						<span class="huntwofive padno">
							<% $opool->name %>
						</span>
						<% $opool->standby ? "Standby" : "" %>
					</a>
%				}

				<a href="/setup/judges/pools.mhtml?group_id=<% $group->id %>" class="martop yellow block">Create/Edit Judge Pools</a>

%			}

		</div>

%			if ($pool) { 

				<div class="sidenote">

%					my @rounds = $pool->rounds;
%					my %used_round;

%					if (@rounds) { 
					
						<h4>Rounds Using Pool</h4>

%						foreach my $round ($pool->rounds) { 
%							$used_round{$round->id}++;
							<a class="yellow block" href="pool_round_rm.mhtml?round_id=<% $round->id %>&pool_id=<% $pool->id %>">
								<% $round->realname %>
							</a>
%						}

%					}

					<h4>Use for round</h4>

					<form action="pool_round_add.mhtml" method="post">
					<input type="hidden" name="pool_id" value="<% $pool->id %>">

					<div class="evenrow block">

						<select name="round_id" class="fixedmed" onchange='this.form.submit()'>
							<option value=""></option>
%							foreach my $round ($m->comp("/funclib/group_rounds.mas", group => $group)) { 
%								next if $used_round{$round->id};
								<option value="<% $round->id %>"><% $round->event->name %> <% $round->realname %></option> 
%							}
						</select>

					</div>

					</form>

					<h4>Auto-populate</h4>

					<form action="pool_autopopulate.mhtml" method="post">
					<input type="hidden" name="pool_id" value="<% $pool->id %>">

					<div class="evenrow block">

						<select name="round_id" class="fixedmed" onchange='this.form.submit()'>
							<option value=""></option>
%							foreach my $round ($m->comp("/funclib/group_rounds.mas", group => $group)) { 
								<option value="<% $round->id %>"><% $round->event->name %> <% $round->realname %></option> 
%							}
						</select>

					</div>

					</form>
					
				</div>
%			}

	</div>

	<div class="left huge">

%		unless ($group) { 

			<h2>Choose a judge group at right</h2>
	
%		} elsif (not defined $pool)  { 
			
			<h2>Choose a pool at right</h2>

%		} else {

<%perl>
			my @pool_judges = $m->comp("/funclib/pool_judges.mas", pool => $pool);
			my $no_codes = $group->setting("no_codes");

			my $pull_group = Tab::JudgeGroup->retrieve($pull_group_id) if $pull_group_id;
			$pull_group = $group unless $pull_group;

			my @judges = $m->comp("/funclib/group_judges.mas", group => $pull_group);

			my %struck_judges;

			if ($pool->standby && $pool->standby_timeslot) { 

				Tab::Judge->set_sql( struck => "
					select distinct judge.id
					from judge, strike, timeslot
					where judge.id = strike.judge
					and strike.start < timeslot.end
					and strike.end > timeslot.start
					and timeslot.id = ? 
				");

				my @struck_out = Tab::Judge->search_struck($pool->standby_timeslot->id);
				%struck_judges = map {$_->id => 1} @struck_out;
			}

</%perl>

			<div class="block padno">

				<span class="bitbiggerspan ">
					<h2>Judges for <% $pool->name %></h2>
				</span>

				<span class="medbiggerspan rightalign ">

					<form action="pool.mhtml#judges" method="post">
					<input type="hidden" name="pool_id" value="<% $pool->id %>">
					<input type="hidden" name="group_id" value="<% $group->id %>">

					<span class="smallish" style="margin-right: 15px;">
						Pull from
					</span>

					<select name="pull_group_id" onchange='this.form.submit()' class="fixedsmall">
%						foreach my $group ($tourn->groups) { 
							<option value="<% $group->id %>" <% $group->id == $pull_group_id ? "selected" : "" %> >
								<% $group->name %>
							</option>
%						} 
					</select>
				</span>

				</form>

			</div>

			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.judge").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"1", pool_id:"<% $pool_id %>" },
								success: function(data) { 
									$(spanstring).removeClass('greynohover').addClass('bluenohover');
								}

							});
						} else {
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"0", pool_id:"<% $pool_id %>" },
								success: function(data){ 
									$(spanstring).removeClass('bluenohover').addClass('greynohover');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

			<div class="halfpage">

				<h4><% scalar @pool_judges %> in pool:</h4>

%				foreach my $judge (@pool_judges) { 

%					next if $struck_judges{$judge};

%					$used{$judge->id}++;
%					my $rating = $judge->avg;
%					$rating =~ s/[0-9]//g;

					<label for="<% $judge->id %>">
					<span class="biggishblock bluenohover" id="span_<% $judge->id %>" style="height: 36px;">

						<span class="medspan medish nowrap padno">
							<% $judge->first." ".$judge->last %>
							<br />
%							unless ($no_codes) { 
								<span class="microspan smallish">
									<% $judge->code %> 
								</span>
%							}
						</span>

						<span class="huntwofive medish nowrap padno">

							<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
								<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
							</span>
							<br />
							<span class="smallerspan smallish">
								<% $judge->judge_group->abbr %> 
								<% $rating ? " - $rating " : "" %> 
								<% $judge->tab_rating ? $judge->tab_rating : "" %> 
							</span>

%							if ($ncfl) { 
								<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
									<% $judge->school->region->code." - ".$judge->school->region->name%>
								</span>
%							}

						</span>

						<span class="check" style="padding: 2px; vertical-align: middle;">
							<input type="checkbox" class="judge" style="margin: 0; margin-top: 2px;" id="<% $judge->id %>" name="<% $judge->id %>" value="1" checked="checked">
						</span>
					</span>
					</label>

%				}

			</div>

%			if ($pull_group) { 

				<div class="halfpage rightfloat">

					<h4><% scalar @judges %> <% $pull_group->abbr %> judges:</h4>

%					foreach my $judge (@judges) { 

%						next if $struck_judges{$judge};

%						next if $used{$judge->id};
%						my $rating = $judge->avg;
%						$rating =~ s/\d//g;

						<label for="<% $judge->id %>">
						<span class="biggishblock greynohover" id="span_<% $judge->id %>" style="height: 37px;">

							<span class="medspan medish nowrap padno ">
								<% $judge->first." ".$judge->last %>
								<br />
%								unless ($no_codes) { 
									<span class="microspan smallish">
										<% $judge->code %> 
									</span>
%								}
							</span>

							<span class="huntwofive medish nowrap padless ">
								<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
									<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
								</span>
								<br />
								<span class="smallerspan smallish">
									<% $judge->judge_group->abbr %> 
									<% $rating ? " - $rating " : "" %> 
									<% $judge->tab_rating ? $judge->tab_rating : "" %> 
								</span>
%								if ($ncfl) { 
									<span class="editspan smallish padno nowrap" style="margin-left: 4px;">
										<% $judge->school->region->code." - ".$judge->school->region->name%>
									</span>
%								}
							</span>

							<span class="check" style="padding: 2px; vertical-align: middle;">
								<input type="checkbox" class="judge" style="margin: 0; margin-top: 2px;" id="<% $judge->id %>" name="<% $judge->id %>" value="1">
							</span>

						</span>
						</label>
%					}

				</div>
%			}
%		}

	</div>

