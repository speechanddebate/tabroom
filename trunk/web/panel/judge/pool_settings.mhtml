<%args>
	$pool_id => undef
	$tourn
	$account
	$judge_group_id => undef
</%args>
<%init>

	my $pool = Tab::Pool->retrieve($pool_id);

	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);
	my @timeslots = sort {$a->start->epoch <=> $b->start->epoch} $tourn->timeslots;

	my $switch = 1;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Pools</h4>

			<a class="ltyellow block" href="pool.mhtml" style="margin-bottom: 5px;">
				Create New Judge Pool
			</a>

%			my @pools = $m->comp("/funclib/tourn_pools.mas", tourn => $tourn);

%			foreach my $opool (@pools) { 
				<a class="<% $pool && $opool->id == $pool->id? "dk" : ""%>blue nowrap block" href="pool.mhtml?pool_id=<% $opool->id %>">
					<% $opool->name %>
				</a>
%			}

		</div>

	</div>

	<div class="main">

		<h2><% $pool ? "Edit Pool ".$pool->name : "Create Judge Pool" %></h2>

		<table cellpadding="4" cellspacing="1">

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					<form action="pool_settings_save.mhtml" method="post">
					<input type="hidden" name="pool_id" value="<% $pool_id %>">
					Pool Name
				</td>

				<td>
					<input type="text" name="name" size="23" value="<% $pool ? $pool->name : "" %>">
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>	
					<label for="publish">
					Publish pool on website
					</label>
				</td>

				<td class="padmore">
					<input type="checkbox" id="publish" name="publish" value="1" <% $pool && $pool->publish ? "checked=\"checked\"" : "" %>>
				</td>
			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>	
					<label for="standby">
					Standby pool<br  />
					<span class="smallish">(Judges in pools are only subbed and will not be auto-paired)</span>
					</label>
				</td>

				<td class="padmore">
					<input type="checkbox" id="standby" name="standby" value="1" <% $pool && $pool->standby ? "checked=\"checked\"" : "" %>>
				</td>

			</tr>

%			if ( $pool && $pool->standby &! $pool->standby_timeslot ) { 

				<tr class="yellowrow">

					<td colspan="2">

						<span class="warning">
							Warning:  You have chosen this as a standby pool,
							but have not chosen a timeslot.  
						</span>
					
						<span class="explain">
							That means this pool will never be used.  Please
							select a timeslot or this pool will drift and
							wallow, forever useless, forever unloved, forever
							alone.  You don't want that, do you?
						</span>

					</td>
				</tr>

				<tr class="lirdrow">

%			} else { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

%			}


				<td>	
					Standby for rounds in timeslot
				</td>

				<td>
					<select name="standby_timeslot" class="fixedmed">
						<option value="">
							------
						</option>

%						foreach my $timeslot (@timeslots) { 
							<option value="<% $timeslot->id %>" <% $pool && $pool->standby_timeslot && $timeslot->id == $pool->standby_timeslot->id ? "selected" : "" %>>
								<% $timeslot->name %>
								(<% Tab::nicetime($timeslot->start->set_time_zone($tz)) %>)
							</option>
%						} 

					</select>

				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>	
					<label for="registrant">
						Registrants enter judges into pool
					</label>
				</td>

				<td class="padmore">
					<input type="checkbox" id="registrant" name="registrant" value="1" <% $pool && $pool->registrant ? "checked=\"checked\"" : "" %>>
				</td>
			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>	
					<label for="event_based">
						Registrant burden based on events <br />
						<span class="smallish">
							Judge pool burden is based on the school's entry size at the pool's site
						</span>
					</label>
				</td>

				<td class="padmore">
					<input type="checkbox" id="event_based" name="event_based" value="1" <% $pool && $pool->event_based ? "checked=\"checked\"" : "" %>>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>	
					Registrant burden  <br />
					<span class="smallish">
					Requires schools to put a percent of their total group burden into pool
					</span>
				</td>

				<td>
					<input type="number" name="burden" size="5" min="0" max="100" value="<% $pool && $pool->burden ? $pool->burden : "" %>"> %
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					Registrants pull from judge group
				</td>

				<td>
					<select name="judge_group" class="fixedmed">
						<option value="">
							All judge groups
						</option>

%						foreach my $judge_group (sort {$a->name cmp $b->name} $tourn->groups) { 
							<option value="<% $judge_group->id %>" <% $pool && $pool->judge_group && $pool->judge_group->id == $judge_group->id ? "selected" : "" %> >
								<% $judge_group->name %>
							</option>
%						} 
					</select>

				</td>

			</tr>


%			if (scalar @sites > 1) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>	
						Limit to rounds at site:
					</td>

					<td>
						<select name="site_id" class="fixedmed">
							<option value="">
								No site limit 
							</option>

%							foreach my $site (@sites) { 
								<option value="<% $site->id %>">
									<% $site->name %>
								</option>
%							} 

						</select>
					</td>

				</tr>


%			} elsif (@sites) { 
				<input type="hidden" name="site_id" value="<% $sites[0]->id %>">
%			}


			<tr class="liblrow">

				<td colspan="2" class="rightalign">
					<input type="submit" value=" Save Pool ">
					</form>
				</td>

			</tr>

		</table>

%		if ($pool) { 

<%perl>
			my @judges;

			my @pool_judges = $pool->judges;

			if ($judge_group_id) { 
				my $pooljg = Tab::JudgeGroup->retrieve($judge_group_id) if $judge_group_id > 0;
				@judges = sort {$a->last cmp $b->last} $pooljg->judges;
			}

</%perl>

			<a name="judges"></a>

			<h4>Judges in pool</h4>

			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.judge").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"1", pool_id:"<% $pool_id %>" },
								success: function(data) { 
									$(spanstring).removeClass('evenrow').addClass('blue');
								}

							});
						} else {
							$.ajax({
								url: 'pool_judge_switch.mhtml',
								type: 'POST',
								data: { judge_id:$(this).attr("id"), value:"0", pool_id:"<% $pool_id %>" },
								success: function(data){ 
									$(spanstring).removeClass('blue').addClass('evenrow');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

%			foreach my $judge (@pool_judges) { 

%				$used{$judge->id}++;

				<label for="<% $judge->id %>">
				<span class="inline third smallish blue" id="span_<% $judge->id %>">

					<span class="tiny nowrap leftfloat" style="padding: 2px;">
						<% $judge->first." ".$judge->last %>
						<br />
						<span class="smallish nowrap" style="clear: both;">
							<% $m->comp("/funclib/judge_rating.mas", judge => $judge, print => "nospace") %> -
							<% $judge->school ? $judge->school->short_name : "Hired" %>
						</span>
					</span>

					<span class="check rightfloat" style="padding: 4px;">
						<input type="checkbox" class="judge" id="<% $judge->id %>" name="<% $judge->id %>" value="1" checked="checked">
					</span>


				</span>
				</label>

%			}

			<br style="clear: both;">

			<div class="block yellowrow rightalign">
				<form action="pool.mhtml#judges" method="post">
				<input type="hidden" name="pool_id" value="<% $pool->id %>">

				<span class="smallish" style="margin-right: 15px;">
				Add judges from group:
				</span>

				<select name="judge_group_id" onchange='this.form.submit()'>
%					foreach my $group ($tourn->groups) { 
						<option value="<% $group->id %>" <% $group->id == $judge_group_id ? "selected" : "" %> >
							<% $group->name %>
						</option>
%					} 
				</select>
			</div>

%			foreach my $judge (@judges) { 

%				next if $used{$judge->id};

				<label for="<% $judge->id %>">
				<span class="inline third smallish evenrow" id="span_<% $judge->id %>">

					<span class="tiny nowrap leftfloat" style="padding: 2px;">
						<% $judge->first." ".$judge->last %>
						<br />
						<span class="smallish nowrap" style="clear: both;">
							<% $m->comp("/funclib/judge_rating.mas", judge => $judge, print => "nospace") %> -
							<% $judge->school && $judge->school->id ? $judge->school->short_name : "Hired" %>
						</span>
					</span>

					<span class="check rightfloat" style="padding: 4px;">
						<input type="checkbox" class="judge" id="<% $judge->id %>" name="<% $judge->id %>" value="1">
					</span>

				</span>
				</label>

%			}

%		}

	</div>

