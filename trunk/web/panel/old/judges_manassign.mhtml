<%args>
	$session
	$circuit
	$tourn
	$timeslot_id => undef
	$num_judges => undef
	$event_id => undef
	$err => undef
</%args>
<%init>
	
	my @timeslots = Tab::Timeslot->search( 
			tournament => $tourn->id, {order_by => "start"});

	my $timeslot;
	my @panels;

	if ($timeslot_id) {
		$timeslot = Tab::Timeslot->retrieve($timeslot_id);
		@panels = $timeslot->panels($event_id);
	}

	@panels = sort {$a->letter <=> $b->letter } @panels;
	@panels = sort {$a->event->abbr <=> $b->event->abbr } @panels;

	my @chapter_rels = $circuit->chapter_circuits;
	my @schools = $tourn->schools;
	my %school_chapter = ();

	foreach my $school (@schools) { 
		$school_chapter{$school->chapter->id} = $school->id;	
	}

	my %school_codes = ();

	foreach my $cr (@chapter_rels) { 
		$school_codes{$school_chapter{$cr->chapter->id}} =  $cr->code;
	}
	

</%init>

<center>
<table cellpadding="5" >

<tr>
<td colspan="6">
<h3>Manual judge assignment</h3>
</td>
</tr>

<form action="judges_manassign.mhtml" method="post">

<tr>
	<td>For timeslot:</td>
	<td>
	<select name="timeslot_id">
% 	foreach my $ts (@timeslots) {
		<option value="<% $ts->id %>" <% ($ts->id == $timeslot_id) ? "selected" : "" %> >
		<% $ts->name %>
		</option>
% 	}	
	</td>

	<td>Event:</td>
		<td>
		<select name="event_id">
		<option value="">All Events</option>
%		foreach my $event (sort {$a->name cmp $b->name} $m->comp("/funclib/tourn_events.mas", tourn => $tourn)(type => "speech") ) {
			<option value="<% $event->id %>" <% ($event->id == $event_id) ? "selected" : "" %> >
			<% $event->name %></option>
% 		}
		</select></td>

	<td>Number of judges: <input type="text" name="num_judges" size="4" value="<% ($num_judges) ? $num_judges : "3" %>">
	</td>
	<td><input  type="submit" value="Show"></td>
	</tr>
	

</form>
<tr><td colspan="6"><h4></h4></td></tr>
</table>
<table cellpadding="5" >
<form action="judges_save.mhtml" method="post">
<input type="hidden" name="timeslot_id" value="<% $timeslot_id %>">
<input type="hidden" name="event_id" value="<% $event_id %>">
<input type="hidden" name="num_judges" value="<% $num_judges %>">

% my $switch;

% foreach my $panel (@panels) { 

% 	my $group = $panel->round->event->judge_group;
% 	my @judges = $panel->judges;

%	# And zees, boys and girls, eez vy zees takes forevar... 
% 	my @clean_judges = $m->comp("/funclib/clean_judges.mas", 
%								panel_id => $panel->id,
%								session => $session );
%	@clean_judges = sort {$a->qual cmp $b->qual} @clean_judges;

<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
	<td><% $panel->event->abbr %></td>
	<td><% $panel->round->label %> <% $panel->letter %></td>

%	foreach my $num (1 .. $num_judges) { 
%		$num--;
	<td>	<select name="judge_id_<%$panel->id%>_<%$num%>">

		<option value="">----None Selected----</option>

%  	if ($judges[$num]) {
		<option value="<% $judges[$num]->id %>" selected>	
		<% $judges[$num]->qual %>
		<% $judges[$num]->code %>
		<% $judges[$num]->last." ".$judges[$num]->school->code %>
		<% ($judges[$num]->neutral) ? "- N" : "" %>
		</option>
%  }

% 	foreach my $cj (@clean_judges) { 
		<option value="<% $cj->id %>" >
		<% $cj->qual %>
		<% $cj->code %>
		<% $cj->last." ".$cj->school->code %>
		<% ($cj->neutral) ? "- N" : "" %>
		</option>
% }

	</select></td>

% }
</tr>
%  }  

% if (@panels) { 
<tr>
<td colspan="6" align="center">
<input  type="submit" value="Save Assignments">
</td>
</tr>
% }

</table>
</form>
</center>
