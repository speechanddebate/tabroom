<%args>
	$tourn
	$event_id => undef
	$round_id => undef
	$all => undef
</%args>
<%init>

	my @events;
	my @rounds;

	my %num_panels_by_event = ();
	my %num_panels_by_round = ();
	
	$m->print('<div class="left huge">');
	$m->print('<h2>Creating rounds:</h2>');

	if ($round_id) { 

		my $round = Tab::Round->retrieve($round_id);
		$num_panels_by_round{$round->id} = scalar $round->panels;
		push (@rounds, $round);
		push (@events, $round->event);

	} elsif ($all) { 

		foreach my $event ($tourn->events) { 
			next unless $ARGS{"do_".$event->id};
			push (@events, $event);
			$num_panels_by_event{$event->id} = $ARGS{"num_panels_".$event->id};
			$num_panels_by_event{$event->id} = $ARGS{"force_num_panels_".$event->id} if $ARGS{"force_num_panels_".$event->id};
		}

	} else { 

		my $event = Tab::Event->retrieve($event_id);

		push (@events, $event);

		foreach my $round ($event->rounds) { 
			next unless $ARGS{"do_".$round->id};
			push (@rounds, $round);
			$num_panels_by_round{$round->id} = $ARGS{"num_panels_".$round->id};
			$num_panels_by_round{$round->id} = $ARGS{"force_num_panels_".$round->id} if $ARGS{"force_num_panels_".$round->id};
		}

	}

	my @groups;

	my $event_count;
	my $round_count;

	foreach my $event (@events) { 

		$event_count++;

		my $num_panels = $num_panels_by_event{$event->id};

		if ($event->type eq "speech") { 

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "prelim") unless @event_rounds;

			foreach my $round (@event_rounds) { 

				$round_count++;

				$m->flush_buffer unless $round_id;

				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};

				$m->print("Paneling ".$round->realname." of ".$event->name." into ".$num_panels." sections") unless $round_id;
				$m->comp("pair_speech.mas", round => $round, num_panels => $num_panels) if $round && $num_panels;

				if ($ARGS{"room_".$event->id}) {
				
					$m->print("...and assigning rooms");

					my @panels = sort {$a->letter cmp $b->letter} $round->panels;

					foreach my $panel (@panels) { 
						my @rooms = $m->comp("/funclib/clean_rooms.mas", panel => $panel);
						my $room = shift @rooms;
						$panel->room($room->id) if $room;
						$panel->update;
					}

				}

				$m->print("....Done.</p>");

			}

		} elsif ($event->type eq "congress") { 

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "prelim") unless @event_rounds;

			foreach my $round (@event_rounds) { 
				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};
				$m->comp("pair_congress.mas", round => $round, num_panels => $num_panels);
			}

		} elsif ($event->type eq "wudc") { 

			my @event_rounds = @rounds if @rounds;

			foreach my $round (@event_rounds) { 
				$m->comp("pair_wudc.mas", round => $round);
			}

		} else { 

			my @event_rounds = @rounds if @rounds;
			@event_rounds = $event->rounds(type => "preset") unless @event_rounds;

			foreach my $round (@event_rounds) { 
				$num_panels = $num_panels_by_round{$round->id} if $num_panels_by_round{$round->id};
				$m->comp("pair_debate.mas", round => $round, flighting => $num_panels);
			}

		}


	}


	$m->redirect("/panel/schemat/show.mhtml?round_id=".$round_id) if $round_id;

</%init>

	<h4>Entry assignment done</h4>

	<a class="third padmore inline dkgreen" href="/panel/report/disasters.mhtml">
		Check for Disasters
	</a>

	<a class="third padmore inline dkgreen" href="/panel/judge/index.mhtml">
		Panel Judges
	</a>

	</div>

	<& menu.mas, tourn => $tourn, whoami => "mass" &>
