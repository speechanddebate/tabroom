<%args>
	$round_id
	$account
	$tourn
</%args>
<%init>

	use List::Util qw(shuffle);

	my $ncfl++ if $tourn->setting("ncfl");

	my $round = Tab::Round->retrieve($round_id);
	my @panels = sort {$a->letter <=> $b->letter} $round->panels;
	@panels = sort {$b->bracket <=> $a->bracket} @panels;

	my $group = $round->event->judge_group;

	my $same_school++ if $round->event->judge_group->setting("allow_school_panels");

	my $num_judges = $round->setting("num_judges");
	$num_judges = 1 unless $num_judges;

	my $num_flights = $round->flighted;
	$num_flights = 1 unless $num_flights;
	$num_flights = 1 if $round->event->setting("flight_rooms_only");

	$m->comp("/funclib/round_clear_judges.mas", round => $round);

	my $text = "Reassigned the judges in round ".$round->realname." of ".$round->event->abbr;

	Tab::TournChange->create({ 
		type    => 'tabbing',
		event   => $round->event->id,
		tourn   => $round->event->tourn->id,
		account => $account->id,
		text    => $text
	});

	if ($round->event->type eq "wudc" || $round->event->type eq "parli") { 

		my %panel_judges;
		my %panel_already_judges;
		my %used_judges;

		foreach my $panel (@panels) { 
			next if $panel->bye;
			@{$panel_judges{$panel->id}} = $m->comp("/funclib/clean_judges.mas", panel => $panel, wudc => "true");
			@{$panel_already_judges{$panel->id}} = $m->comp("/funclib/panel_judges.mas", panel => $panel);
		}

		my $order_string = $round->setting("tab_rating_priority");

		my @orders = split(/\,/, $order_string);

		if (@orders) { 

			my %used_schools;

			foreach my $order (@orders) { 

				foreach my $panel (@panels) {

					next if $panel->bye;

					next unless $panel->bracket == $order;
					my @cans = @{$panel_judges{$panel->id}};

					my $judge;
					my $empty;

					while (@cans && not defined $judge && not defined $empty) { 

						$empty++ if scalar @cans == 0;
						$judge = shift @cans;
						$empty++ unless $judge;
						next unless $judge;

						undef $judge if $used_judges{$judge->id};

						unless ($same_school) { 
							undef $judge if $judge && $judge->school && $used_schools{$panel->id."-".$judge->school->id};
						}
					}

					$m->comp("/funclib/panel_judgeadd.mas", panel => $panel, judge => $judge) if $judge;
					$used_judges{$judge->id}++ if $judge;
					$used_schools{$panel->id."-".$judge->school->id}++ if $judge && $judge->school;

				}

				@panels = reverse(@panels);

			}

		} else { 

			$num_judges = 3 unless $num_judges;

			my %used_schools;

			foreach (1 .. $num_judges ) { 

				foreach my $panel (@panels) {
					
					next if $panel->bye;

					my @cans = @{$panel_judges{$panel->id}};

					my $judge;
					my $empty;

					while (@cans && not defined $judge && not defined $empty) { 

						$empty++ if scalar @cans == 0;

						$judge = shift @cans;
						$empty++ unless $judge;
						next unless $judge;

						undef $judge if $used_judges{$judge->id};

						unless ($same_school) { 
							undef $judge if $judge && $judge->school && $used_schools{$panel->id."-".$judge->school->id};
						}

					}

					$m->comp("/funclib/panel_judgeadd.mas", panel => $panel, judge => $judge) if $judge;
					$used_judges{$judge->id}++ if $judge;
					$used_schools{$panel->id."-".$judge->school->id}++ if $judge && $judge->school;

				}

				@panels = reverse(@panels);
			
			}

		}

	} else { 
		
		my %rating_by_judge_event = ();

		if ($group->setting("coach_ratings") && $round->type ne "prelim") {
		
			my %tier_names = map {$_->id => $_->name} $group->rating_tiers;

			foreach my $event ($group->events) { 
				my $event_id = $event->id;
				my @ratings = $m->comp("/funclib/group_ratings.mas", event => $event);
				foreach my $rating (@ratings) { 
					$rating_by_judge_event{$rating->judge->id."-".$event_id} = $tier_names{$rating->rating_tier->id} 
						if $rating && $rating->rating_tier;
				}
			}
		}

		my %can_judge = ();
		my %panel_judges = ();

		foreach my $panel (@panels) { 

			next if $panel->bye;
			my @judges = $m->comp("/funclib/clean_judges.mas", panel => $panel, mass => "yes");

			@{$panel_judges{$panel->id}} = @judges;

			foreach my $judge (@judges) { 
				push @{$can_judge{$judge->id}}, $panel;
			}

		}

		my %done = ();

		foreach my $panel (@panels) { 

			next if $done{$panel->id};

			my @judges = shuffle(@{$panel_judges{$panel->id}});

			if ($panel->round->type ne "prelim") {
				@judges = sort {$rating_by_judge_event{$a->id."-".$round->event->id} 
					cmp $rating_by_judge_event{$b->id."-".$round->event->id}} @judges;

				@judges = sort {length($rating_by_judge_event{$b->id."-".$round->event->id}) 
					<=> length($rating_by_judge_event{$a->id."-".$round->event->id})} @judges;
			}

			my %school_already;
			my %region_already if $ncfl;

			my @judge_panel;

			foreach (1 .. $num_judges) { 

				my $judge = shift @judges if @judges;

				next unless $judge;
				next if $done{"J-".$judge->id};

				while (@judges && $judge->school && $school_already{$judge->school}) { 
					$judge = shift @judges;
				}

				if ($ncfl) { 
					while (@judges && $region_already{$judge->school->region->id}) { 
						$judge = shift @judges;
					}
				}

				$school_already{$judge->school->id}++ if $judge->school;
				$region_already{$judge->school->region->id}++ if $ncfl &&  $judge->school->region;

				push @judge_panel, $judge if $judge;

			}

			my @flights;

			foreach my $flight_number (1 .. $num_flights) { 

				if ($flight_number == 1) { 

					$panel->flight($flight_number);
					$panel->update;
					push @flights, $panel if $panel;

				} else { 

					my %ok_panels = {};
					my $other_flight;

					JUDGE:
					foreach my $judge (@judge_panel) { 

						next if $other_flight;

						foreach my $other_panel (@{$can_judge{$judge->id}}) { 
							next if $done{$other_panel->id};
							next if $other_panel->id == $panel->id;

							$ok_panels{$other_panel->id}++;

							if ($ok_panels{$other_panel->id} == scalar (@judge_panel)) { 
								$other_flight = $other_panel;
								$other_flight->flight($flight_number);
								$other_flight->update;
							}

						}

					}

					push @flights, $other_flight if $other_flight;
				}
			}

			Tab::debuglog("Judge panel @judge_panel is judging flights @flights");

			foreach my $flight (@flights) { 
				$done{$flight->id}++;
				foreach my $judge (@judge_panel) { 
					$m->comp("/funclib/panel_judgeadd.mas", panel => $flight, judge => $judge) if $judge;
					$done{"J-".$judge->id}++;
				}
			}
		}
	}

	my $msg = "Judges have been assigned";

	$m->redirect("/panel/schemat/show.mhtml?round_id=$round_id&disp=1&msg=$msg");

</%init>
