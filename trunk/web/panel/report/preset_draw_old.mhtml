<%args>
	$event_id
	$tourn
</%args>

<%init>

	#load entries and put in hash
	my @entries = Tab::Entry->search( event => $event_id, dropped => 0, waitlist => 0, unconfirmed => 0);
	my @rounds = Tab::Round->search( event => $event_id, type=>"prelim" );
	my %entries;
	foreach my $entry (@entries) {
		$entries{$entry->id}{'code'} = $entry->code;
		$entries{$entry->id}{'seed'} = $entry->pair_seed;
	}

	#load all pairings
	Tab::Ballot->columns(TEMP => qw/round/);
	Tab::Ballot->set_sql(pull_ballots => "
		select ballot.entry, ballot.panel, ballot.side, round.id as round
		from ballot, panel, round, entry
		where ballot.panel=panel.id
		and panel.round=round.id
		and round.event = $event_id
		and ballot.entry = entry.id
		order by round.name, entry.code
	");

	my @pairings = Tab::Ballot->search_pull_ballots;

	#loop the pairings and store opponents and their seed
	my $panel; my $temp_round; my $team1; my $team2;
	foreach my $pairing (@pairings) {				
		if ( $panel != $pairing->panel and $panel > 0 ) {
			$entries{$team1}{$temp_round}{'opponent'} = $team2;
			$entries{$team2}{$temp_round}{'opponent'} = $team1;

			$team1 = 0; $team2 = 0;	
	
		}
		
		if ($team1 == 0 and $team2 == 0) { 
			$team1 = $pairing->entry; 
		} elsif ( $team1 > 0 and $team2 == 0 ) {
			$team2 = $pairing->entry;
		}

		$panel = $pairing->panel;
		$temp_round = $pairing->round;
	}
	
	#add the last pairing too
	$entries{$team1}{$temp_round}{'opponent'} = $team2;
	$entries{$team2}{$temp_round}{'opponent'} = $team1;

	# if there's some data detritus for teams paired against dropped opponents
	# it adds them to the %entries hash so this thing cleans it up

	foreach my $key ( keys %entries ) {
		if (not $entries{$key}{'code'} ) { 
			delete $entries{$key}; 
		}
	}
	
</%init>

<& menu.mas, tourn => $tourn, whoami => "events" &>
	
<div class="main" display="table" >

	<h4>Avg Opponent Draw in preset rounds</h4> 

	<& /funclib/tablesorter.mas, table => "draw" &> 
	
	<table cellpadding="3" id="draw" class="tablesorter">
	
		<thead>
			<tr class="yellowrow">
				<th class="smaller">Team</th>
%			foreach my $round (@rounds)	{	
				<th class="smaller"><% $round->label %></th>
%			}		
				<th class="smaller">Total</th>
		</tr>
		</thead>
			
		<tbody class="smallish">
		
%		my $total		;
%		foreach my $key (sort {$entries{$a}->{'SOP'} <=> $entries{$b}->{'SOP'}} keys(%entries)) {
%		$total = 0;

			<tr>	
				<td>
					<% $entries{$key}{'code'} %>
				</td>

%				foreach my $round (@rounds)	{	
%					my $oppon = $entries{$key}{$round->id}{'opponent'};			
%					$total += $entries{$oppon}{'seed'};		
					<td>
						<% $entries{$oppon}{'seed'} %> <% $entries{$oppon}{'code'} %>
					</td>		
%				}
				<td class="centeralign">
					<% $total %>
				</td>	
			</tr>
%		}
		
		</tbody>
		
	</table>
	
</div>
