<%args>
	$session
	$tourn
	$timeslot_id
	$event_id
	$seats => 30
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my $timeslot = Tab::Timeslot->retrieve($timeslot_id);

	my $round = Tab::Round->search( timeslot => $timeslot_id, event => $event_id )->first;
	$m->abort unless $round;

	unless ($seats > 0 ) {
		$m->print("You must enter some seats.  Hit back and try again.");
		$m->abort;
	}

	# Set up the filename and the needed trace files
	my $name = $event->name;
	$name =~ s/[\W_]//g;

	my $filename = "SeatingChart-$name-".$session->id;
	my $filepath = $Tab::file_root."tmp/".$filename;
	`rm -f $filepath.*`;

	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1, landscape => 1 );

	open (TEXOUT, ">>$filepath.tex");

	foreach my $panel ($round->panels) { 

		my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

		my %entry_seed = ();

		foreach my $entry (@entries) { 
			my $random_seed = $entry->id * $round->id;
			$entry_seed{$entry->id} = substr($random_seed, 6, 8);
		}

		@entries = sort {$entry_seed{$a->id} <=> $entry_seed{$b->id}} @entries;

		print TEXOUT "\\Large {\\bf ". Tab::texify(uc($event->name)) ." CHAMBER ". Tab::texify($panel->letter)."}\n";
		print TEXOUT "\\hfill \\large ". Tab::texify($round->realname)." ";
		print TEXOUT "Room ". Tab::texify($panel->room->name)." \n" if $panel->room;
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\begin{center}\n";

		my $counter;
		my $width = 9/$seats;

		foreach my $entry (@entries) { 

			if ($counter == $seats) {
				undef $counter;
				print TEXOUT "\\medskip\n";
				print TEXOUT "\\newline\n";
			}

			print TEXOUT "\\noindent \\framebox[".$width."in][c]{\\minibox[c]{".$entry->code." \\\\ ".$entry->school->congress_code." \\\\}}\n";
			$counter++;
		}

		print TEXOUT "\\newpage \n";

		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\Large {\\bf ". Tab::texify(uc($event->name)) ." CHAMBER ". Tab::texify($panel->letter)."}\n";
		print TEXOUT "\\hfill \\large ". Tab::texify($round->realname)." ";
		print TEXOUT "Room ". Tab::texify($panel->room->name)." \n" if $panel->room;
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\begin{center}\n";

		my $remainder = scalar @entries % $seats; 

		undef $counter;

		foreach my $entry (reverse @entries) { 

			if ($remainder && $counter == $remainder) { 
				undef $remainder;
				undef $counter;
				print TEXOUT "\\medskip\n";
				print TEXOUT "\\newline\n";
			} elsif ($counter == $seats) { 
				undef $counter;
				print TEXOUT "\\medskip\n";
				print TEXOUT "\\newline\n";
			}

			print TEXOUT "\\noindent \\framebox[".$width."in][c]{\\minibox[c]{".$entry->code." \\\\ ".$entry->school->congress_code." \\\\}}\n";
			$counter++;


		}

		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\newpage \n";

	} 

	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>
