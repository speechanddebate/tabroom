<%args>
	$round_id
	$filename
	$schools => undef
	$record => undef
</%args>
<%init>
	
	my $round = Tab::Round->retrieve($round_id);
	my $tourn = $round->event->tourn;

	my $event = $round->event;
	my $round_robin++ if $event->setting("round_robin");

	Tab::Panel->columns(TEMP => "roomname");

	Tab::Panel->set_sql( schemat => "
		select panel.*, room.name as roomname
		from panel, room
		where panel.round = ? 
		and panel.room = room.id
		order by panel.letter");

	Tab::Panel->set_sql( schemat_roomless => "
		select panel.*, \"Ask Tab\" as roomname
		from panel
		where panel.round = ? 
		and panel.room = 0
		order by panel.letter");

	my @panels = Tab::Panel->search_schemat($round->id);
	push (@panels, Tab::Panel->search_schemat_roomless($round->id));

	my %wins_by_entry = (); 
	my %loss_by_entry = (); 

	if ($record) { 

		my @entries = sort {$a->school->name cmp $b->school->name} $event->entries ( waitlist => 0, unconfirmed => 0); 
		my @ballot_values = $m->comp("/funclib/event_values.mas", event => $event, public => 1, prelim => 1); 

		my %ballots_by_entry = (); 
		my %ballots_by_panel = (); 
		my %ballots_by_entry_panel = (); 

		my %panels_by_entry = (); 

		foreach my $value (@ballot_values) {
			$ballots_by_entry{$value->entryid}++ if $value->value == 1 and $value->tag eq "ballot";
			$ballots_by_panel{$value->panelid}++ if $value->value == 1 and $value->tag eq "ballot";
			$ballots_by_entry_panel{$value->entryid."-".$value->panelid}++ if $value->value == 1 and $value->tag eq "ballot";
			push @{$panels_by_entry{$value->entryid}}, $value->panelid;
		}   

		my $different;

		foreach my $entry (@entries) { 

			$wins_by_entry{$entry->id} = 0;
			$loss_by_entry{$entry->id} = 0;

			my %done = (); 
			foreach my $panel (@{$panels_by_entry{$entry->id}}) { 
				next if $done{$panel};
				if ($ballots_by_entry_panel{$entry->id."-".$panel} > ( $ballots_by_panel{$panel} / 2 )) { 
					$wins_by_entry{$entry->id}++ 
				} else { 
					$loss_by_entry{$entry->id}++ 
				}
				$done{$panel}++;
			}
			$different++ if $wins_by_entry{$entry->id} != $ballots_by_entry{$entry->id};
		}

	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;
	$start->set_time_zone($tz);

	my $flighted++ if $round->flighted > 1;

	my $filepath = $Tab::file_root."tmp/".$filename;

	open (TEXOUT, ">>$filepath.tex");

	my $tabular;

	$tabular = "\\begin{tabular}{p{1.5in}p{1.5in}p{2in}p{1.5in}}\n";
	$tabular = "\\begin{tabular}{p{.075in}p{1.15in}p{1.15in}p{1in}p{.75in}}\n" if $flighted;

	print TEXOUT "\\pagebreak[1]\n";
	print TEXOUT "\\begin{tabular}{p{2in}p{3in}p{1.5in}}\n" unless $flighted;
	print TEXOUT "\\begin{tabular}{p{4in}p{4in}p{1.5in}}\n" if $flighted;
	print TEXOUT "{\\bf \\Large ". Tab::texify($round->realname);
	print TEXOUT "} & {\\bf \\Large ". Tab::texify($event->name);
	print TEXOUT "} & {\\bf \\Large Start: ".$start->hour_12.":".$start->strftime("%M")." ".$start->strftime("%p");
	print TEXOUT "} \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\small\n";

	print TEXOUT $tabular;
	print TEXOUT "\\rowcolor[rgb]{1.0,.94,.65}\[6pt\]\[6pt\]\n";

	if ($round->event->type eq "pf" || $round->type eq "elim" ) { 
		print TEXOUT "Fl & Teams &  & Room & Judge \\\\ \n" if $flighted;
		print TEXOUT "Teams & & Room  & Judge \\\\ \n" unless $flighted;
	} else { 
		print TEXOUT "Fl & Aff & Neg & Room & Judge \\\\ \n" if $flighted;
		print TEXOUT "Aff & Neg & Room & Judge \\\\ \n" unless $flighted;
	}

	print TEXOUT "\\end{tabular}\n";

	if ($flighted) { 
		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{1.0,.95,.94}\[6pt\]\[6pt\]\n";
		if ($round->event->type eq "pf" || $round->type eq "elim" ) { 
			print TEXOUT "Fl & Teams &  & Room & Judge \\\\ \n";
		} else { 
			print TEXOUT "Fl & Aff & Neg & Room & Judge \\\\ \n";
		}

		print TEXOUT "\\end{tabular}\n";
	}

	print TEXOUT "\\newline\n";
	print TEXOUT "\\footnotesize\n";
	print TEXOUT "\\scriptsize\n" if scalar @panels > 48 && not defined $flighted;

	my $codes = $tourn->setting("schemat_display");

	my @entries = $m->comp("/funclib/round_entries.mas", round => $round);
	my @judges = $m->comp("/funclib/round_judges.mas", round => $round);
	my @ballots = $m->comp("/funclib/round_ballots.mas", round => $round);

	my %pod_name;

    if ($round_robin) { 
        foreach my $entry (@entries) { 
            next if $pod_name{$entry->pair_seed};
            $pod_name{$entry->pair_seed} = $event->setting("pod_".$entry->pair_seed);
            $pod_name{$entry->pair_seed} = "Pod ".$entry->pair_seed unless $pod_name{$entry->pair_seed};
        }   
    }   

	my %judge_by_id = ();
	foreach my $judge (@judges) { 
		$judge_by_id{$judge->id} = $judge;
	}

	my %entries_by_panel = ();

	foreach my $entry (@entries) { 
		next if $entry->dropped;
		next if $entry->dq;
		push (@{$entries_by_panel{$entry->panelid}}, $entry);
	}

	my %ballots_by_entry = ();
	my %panel_undone = ();
	my %judges_by_panel = ();

	foreach my $ballot (@ballots) { 
		push @{$ballots_by_entry{$ballot->entry->id}}, $ballot if $ballot->entry;
		$panel_undone{$ballot->panel->id}++ unless $ballot->audit;
		push @{$judges_by_panel{$ballot->panel->id}}, $judge_by_id{$ballot->judge->id} if  $judge_by_id{$ballot->judge->id};
	}

	@panels = sort {$a->flight <=> $b->flight} @panels if $flighted;
	@panels = sort {$a->roomname cmp $b->roomname} @panels;
	@panels = sort {$a->bye <=> $b->bye} @panels;

	my $switch = 1;
	my $last_room;
	my $last_pod;
	my $last_flight;

	foreach my $panel (@panels) { 

		my $aff;
		my $neg;
		my $bye;

		foreach my $pc (@{$entries_by_panel{$panel->id}}) { 

			if ($ballots_by_entry{$pc->id}) { 
				$bye = $pc if $panel->bye;
				$aff = $pc if ${$ballots_by_entry{$pc->id}}[0]->side == "1";
				$neg = $pc if ${$ballots_by_entry{$pc->id}}[0]->side == "2";
			}

		}

		if ($round_robin && ($aff && $last_pod != $aff->pair_seed) || ($bye && $last_pod != $bye->pair_seed)) { 
			print TEXOUT "\\vspace{.02in}\\newline\n" unless $last_pod;
			print TEXOUT "\\smallskip\n\\newline\n" if $last_pod;
			print TEXOUT "{\\large \\bf ".Tab::texify($pod_name{$aff->pair_seed})."}\n\\medskip \n\\newline\n" if $aff;
			print TEXOUT "{\\large \\bf ".Tab::texify($pod_name{$bye->pair_seed})."}\n\\medskip \n\\newline\n" if $bye;
			$last_pod = $aff->pair_seed if $aff;
			$last_pod = $bye->pair_seed if $bye;

			print TEXOUT "\\normalsize\n";
		}
	
		unless ($last_room == $panel->room->id) { 
			print TEXOUT "\\newline\n";
			$switch++;

			if ($flighted && $panel->flight == 2) { 
				print TEXOUT $tabular."\n";
				print TEXOUT "\\rowcolor[rgb]{.91,.91,.91}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;
				print TEXOUT "& & & & \\\\ \n \\end{tabular}\n" if $panel->flight == 2;
			}
			$last_room = $panel->room->id;
		}

		next unless $entries_by_panel{$panel->id};
	
		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{.91,.91,.91}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;

		print TEXOUT $panel->flight." & " if $flighted;


		if ($panel->bye) { 
			print TEXOUT "\\scriptsize " if $flighted;
			print TEXOUT Tab::texify($wins_by_entry{$bye->id}."-".$loss_by_entry{$bye->id}." ") if $record;
			print TEXOUT Tab::texify($bye->code)." & ";  
		} elsif ($aff) { 
			print TEXOUT "\\scriptsize " if $flighted;
			print TEXOUT Tab::texify($wins_by_entry{$aff->id}."-".$loss_by_entry{$aff->id}." ") if $record;
			print TEXOUT Tab::texify($aff->code)." & ";  
		} 

		if ($panel->bye) { 
			print TEXOUT "BYE & & ";  
		} elsif ($neg) { 
			print TEXOUT "\\scriptsize " if $flighted;
			print TEXOUT Tab::texify($wins_by_entry{$neg->id}."-".$loss_by_entry{$neg->id}." ") if $record;
			print TEXOUT Tab::texify($neg->code);  
		}

		print TEXOUT " & ";
		print TEXOUT "\\scriptsize " unless $round_robin;
		print TEXOUT "\\truncate[]{.72in}{".Tab::texify($panel->roomname)."} & " if $flighted && $panel->bye < 1;
		print TEXOUT "\\truncate[]{1.9in}{".Tab::texify($panel->roomname)."} & " unless $flighted || $panel->bye;

		my $notfirst;
		my %used = ();
		foreach my $judge (@{$judges_by_panel{$panel->id}}) {

			next if $used{$judge->id};
			$used{$judge->id}++;

			if ($notfirst) { 
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\rowcolor[rgb]{.91,.91,.91}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;
				print TEXOUT "& & & " unless $flighted;
				print TEXOUT "& & & & " if $flighted;
			}

			print TEXOUT "\\scriptsize " if $flighted;
			print TEXOUT " *" if $judge->chair;
			print TEXOUT "\\truncate[]{.78in}{".Tab::texify($judge->last.", ".$judge->first)." }" if $flighted;
			print TEXOUT "\\truncate[]{1.90in}{".Tab::texify($judge->last.", ".$judge->first)." }" unless $flighted;
			$notfirst++;
		} 

		$switch++;

		print TEXOUT "\n\\end{tabular}\n";


	} 

</%init>


