<%args>
	$event_id
</%args>
<%init>

	use Time::HiRes qw( time );
	my $start_processing = time(); 

	my %prefs;
	my $event = Tab::Event->retrieve($event_id);
	my @rounds = Tab::Round->search( event=> $event_id, { order_by=>'name' });
	my @entries = Tab::Entry->search( event=> $event_id );
	
	foreach my $round (@rounds) {
		my @panels = Tab::Panel->search( round => $round->id, bye=> 0 );
		foreach my $panel (@panels) {
			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel); 
			my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);
			foreach my $entry (@entries) {
				foreach my $judge (@judges) {
				
					my @prefs = Tab::Rating->search( judge => $judge->id, entry=> $entry->id );			
	
					foreach my $pref (@prefs) {
						$prefs{$entry->id}{$panel->round} = $pref->percentile; 
					}
				}
			}	
		}
	}

</%init>

<h4>Pref experience by team for <% $event->name %></h4>

<div class="main">

	<& /funclib/tablesorter.mas, table => "sortme" &>

	<table cellpadding="0" cellspacing="1" width="100%" id="sortme"> 

		<thead>
		
		<tr class="yellowrow">
			<td>
				Entry
			</td>
				
%		foreach my $round (@rounds) {
		<th class="yellowrow">
			<% $round->name %>
		</th>
%		}		

		<th>
			Avg
		</th>
			
		</tr>

		</thead>

		<tbody>
%		foreach my $entry (@entries) {
%		my $rds; my $tot_pref;

			<tr>
				<td>
					<a class="white" href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
						<% $entry->code %>
					</a>
				</td>
%			foreach my $round (@rounds) {
				<td>
%				if ($prefs{$entry->id}{$round->id}) {
%					$rds++; $tot_pref += $prefs{$entry->id}{$round->id};
					<% sprintf("%.1f\n", $prefs{$entry->id}{$round->id}) %>
%				}
				</td>	
%			}	
			<td>
%				if ($rds) {			
				<% sprintf("%.1f\n", $tot_pref/$rds) %>
%				}
			</td>
							
			</tr>
%		}
		
		</tbody>
		
	</table>

<%perl>
	my $end = time();
	print "<br>processing time: ";
	printf("%.2f\n", $end - $start_processing);
</%perl>

</div>

