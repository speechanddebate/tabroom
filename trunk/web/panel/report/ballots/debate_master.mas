<%args>
	$panel_id => undef
	$judge_id => undef
	$event_id => undef
	$chair => undef
	$filename
</%args>
<%perl>

	my $filepath = $Tab::file_root."/tmp/".$filename;

	use List::Util 'shuffle';

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	my $round = $panel->round if $panel;
	my $event = $round->event if $round;

	my $elim++ if $round && $round->type eq "elim";
	$elim++ if $round && $round->type eq "final";
	my $ld++ if $event && $event->type eq "ld";

	$event = Tab::Event->retrieve($event_id) unless $event;
	my $tourn = $event->tourn;
	
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel) if $panel;

	my $start;
	
	if ($round) { 
		$start = $round->start_time;
		$start = $round->timeslot->start unless $start;
		$start->set_time_zone($tz);
	}

	my $flight_offset = $event->setting("flight_offset");

	if ($flight_offset && $panel && $panel->flight > 1) { 
		my $flight = $panel->flight - 1;
		$start->add( minutes => $flight_offset * $flight);
	}

	my $points;
	my $ranks;

	if ($panel && $panel->round->tb_set) { 
		foreach my $tb ($panel->round->tb_set->tiebreaks) {
			$points++ if $tb->name eq "points";
			$ranks++ if $tb->name eq "ranks";
		}
	} else { 
		my @round = sort {$a->name <=> $b->name} $event->rounds;
		my $sample = shift @round;
		if ($sample->tb_set) { 
			foreach my $tb ($sample->tb_set->tiebreaks) {
				$points++ if $tb->name eq "points";
				$ranks++ if $tb->name eq "ranks";
			}
		} else { 
			$points++;
			$ranks++;
		}
	}

	my $lpw++ unless $event->setting("no_lpw");
	my $max_points = $event->setting("max_points");
	my $min_points = $event->setting("min_points");

	my $max_entry = $event->setting("max_entry");
	my $min_entry = $event->setting("min_entry");

	$min_points = 0 unless $min_points;
	$max_points = 30 unless $max_points;

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\renewcommand{\\arraystretch}{1.8}\n";

	print TEXOUT "\\noindent";

	if ($panel) { 
		print TEXOUT "\\parbox[l][][t]{2.5in}{";
		print TEXOUT "\\normalsize \n";
		print TEXOUT "{\\bf Room: ".&Tab::texify($panel->room->name)." } \n\n " if $panel->room;
		print TEXOUT "{\\bf Room: ASK TAB } \n\n " unless $panel->room;
		print TEXOUT "{\\bf Flight ".$panel->flight." Start: ".Tab::nicetime($start)." } \n\n " if $round->flighted > 1;
		print TEXOUT "{\\bf Start: ".Tab::nicetime($start)." } \n\n " if $round->flighted < 2;
		print TEXOUT "{\\bf ".&Tab::texify($event->name)." }";
		print TEXOUT "}";
		print TEXOUT "\\parbox[c][][t]{2.1in}{";
		print TEXOUT "\\begin{center} ";
		print TEXOUT "{\\huge \\bf ".$round->name."} " unless $round->label;
		print TEXOUT "{\\LARGE \\bf ".$round->realname."}" if $round->label;
		print TEXOUT "\\end{center} ";
		print TEXOUT "} ";
		print TEXOUT "\\hfill\n";
		print TEXOUT "\\parbox[r][.5in][t]{2.5in}{";
		print TEXOUT "\\vspace{.15in}\n\n \\hfill ";
		print TEXOUT "{\\LARGE \\bf *}" if $judge && $judge->chair;
		print TEXOUT "{\\LARGE \\bf ".&Tab::texify(substr($judge->last.", ".$judge->first, 0, 18))."}" if $judge;
		print TEXOUT "{\\Large \\bf Judge: \\makebox[1.75in]{\\hrulefill}}" unless $judge;
		print TEXOUT "} \\\\ \n";
	} else { 
		print TEXOUT "{\\bf Room: \\makebox[1.5in]{\\hrulefill} \\hfill Round: \\makebox[.5in]{\\hrulefill} \\hfill Judge: \\makebox[1.5in]{\\hrulefill}}\n\\medskip\\newline\n";
	}

	print TEXOUT "\\begin{center}\n";

	if ($tourn->setting("logo")) { 

		print TEXOUT "\\vspace{-20pt}\n";
		print TEXOUT "\\begin{figure}[h!]\n";
		print TEXOUT "\\centerline{\\includegraphics[width=3in]{".$Tab::file_root."/files/tourns/".$tourn->id."/".$tourn->setting("logo")."}}\n";
		print TEXOUT "\\end{figure}\n";
		print TEXOUT "\\vspace{-20pt}\n";
	} else { 

		my $t_start = $tourn->start->set_time_zone($tz);
		my $t_end = $tourn->end->set_time_zone($tz);
		
		my $date_string = $t_start->month_abbr." ".$t_start->day." - ".$t_end->day.", ".$t_end->year  if $t_start->month == $t_end->month;
		$date_string = $t_start->month_abbr." ".$t_start->day." - ".$t_end->month_abbr." ".$t_end->day.", ".$t_end->year  unless $t_start->month == $t_end->month;

		print TEXOUT "{\\huge \\bf ".&Tab::texify(uc($tourn->name))." } \\\\ \n";
		print TEXOUT "\\smallskip \n ";
		print TEXOUT "{\\large \\bf ".&Tab::texify($date_string)." } \\\\ \n";
	}

	print TEXOUT "\\end{center} \n";

	if ($chair && scalar @judges > 1) { 
		print TEXOUT "\\small {\\bf *Please chair this round.}\n";
		print TEXOUT "\\medskip \n ";
		print TEXOUT "\\newline\n ";
	}

	my $message = $event->setting("ballot_rules");

	if ($message) { 
		my $strip = HTML::Strip->new();
		$message = $strip->parse( $message );
		print TEXOUT "\\small \n ";
		print TEXOUT &Tab::texify($message);
		print TEXOUT "\\bigskip \\newline \n ";
	}

	if ($elim) { 

		my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

		@entries = shuffle @entries;

		my $first = shift @entries;
		my $second = shift @entries if @entries;
		next unless $first && $second;

		print TEXOUT "\\begin{minipage}[c][][r]{7in}\n";
		print TEXOUT "\\begin{center}\n";
		print TEXOUT "\\vspace{.2in}\n";
		print TEXOUT "\\large\n";
		print TEXOUT "\\makebox[3in]{".Tab::texify($first->code." (".$first->name.")")."} \\hspace{.15in} vs \\hspace{.15in} \\makebox[3in]{".Tab::texify($second->code." (".$second->name.")")."}\n\n";

		print TEXOUT "\\vspace{.25in}\n";

		print TEXOUT "\\makebox[2.75in]{\\hrulefill} \\hspace{.5in} \\makebox[2.75in]{\\hrulefill}\n\n";

		print TEXOUT "\\footnotesize\n";

		if ($event->type eq "pf") { 
			print TEXOUT "{\\bf FIRST TEAM \\hspace{.5in} PRO / CON } \\hspace{1.5in} {\\bf SECOND TEAM \\hspace{.5in}  PRO / CON } " if $event->type eq "pf";

		} elsif ($event->type eq "parli") { 
			print TEXOUT "{\\bf GOVERNMENT } \\hspace{2.5in} {\\bf OPPOSITION } " 
		} else { 

			print TEXOUT "{\\bf AFFIRMATIVE } \\hspace{2.5in} {\\bf NEGATIVE } " 
		}
		print TEXOUT "\\end{center}\n";
		print TEXOUT "\\end{minipage}\n";
		print TEXOUT "\\newline\n";

	} else { 

		my $aff;
		my $neg;

		if ($panel) { 
			foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {
				$aff = $entry if $entry->side == 1;
				$neg = $entry if $entry->side == 2;
			}
		}

		my @affs = $aff->students if $aff;
		my @negs = $neg->students if $neg;

		print TEXOUT "{\\begin{minipage}[c]{3.5in}";
		print TEXOUT "\n \\normalsize\n";

		if ($event->type eq "pf") { 
			print TEXOUT "{\\small {\\bf  PRO \\hspace{.1in} CON } \\hspace{.1in} {\\footnotesize (Circle One) } }\n\\medskip\n\\newline\n";
			print TEXOUT "\\begin{tabular}{"
		} else { 
			print TEXOUT "{\\small \\bf AFFIRMATIVE}\n\\newline\n";
			print TEXOUT "\\begin{tabular}{"
		} 

		my $first_row;
		my $size = "1.75in" if $ranks;
		$size = "2.25in" unless $ranks;

		if ($max_entry > 1) { 
			print TEXOUT "|p{.25in}|p{$size}";
			$first_row = " {\\bf \\scriptsize Spkr} & {\\bf \\truncate{$size}{".Tab::texify($aff->code)."} }" if $aff;
			$first_row = " {\\bf \\scriptsize Spkr} & {\\bf Team: } " unless $aff;
		} else { 
			print TEXOUT "|" unless $event->type eq "ld";
			print TEXOUT "p{$size}";
			$first_row = " {\\bf \\truncate{$size}{".Tab::texify($aff->code)."} }" if $aff;
			$first_row = " {\\bf \\truncate{$size}{ Debater: } }" unless $aff;
		}

		if ($points) { 
			print TEXOUT "|" unless $ld;
			print TEXOUT "p{.4in}";
			$first_row .= " & \\begin{minipage}[c]{.4in}\n";
			$first_row .= "\\vspace{.05in}\n";
			$first_row .= "{\\bf \\scriptsize POINTS}\n\n";
			$first_row .= "{\\scriptsize ( $min_points - $max_points )}\n";
			$first_row .= "\\vspace{.02in}\n";
			$first_row .= "\\end{minipage}\n";
		}

		if ($ranks) { 
			print TEXOUT "|" unless $ld;
			print TEXOUT "p{.4in}";
			$first_row .= " & \\begin{minipage}[c][][t]{.4in}\n";
			$first_row .= "\\vspace{.05in}\n";
			$first_row .= "{\\bf \\scriptsize RANK}\n\n";
			$first_row .= "\\vspace{.22in}\n\n";
			$first_row .= "\\end{minipage}\n ";
		}

		print TEXOUT "|" unless $ld;
		print TEXOUT "}\n";
		print TEXOUT "\\hline\n" unless $ld;
		print TEXOUT $first_row."\\\\ \n";
		print TEXOUT "\\hline\n" unless $ld;

		my $order = 1;

		if (@affs) { 
			foreach my $speaker (@affs) { 
				print TEXOUT " & " if scalar @affs > 1;
				print TEXOUT Tab::texify($speaker->first." ".$speaker->last." ");
				print TEXOUT " & " if $points;
				print TEXOUT "\\makebox[.5in]{\\hrulefill}" if $ld;
				print TEXOUT " & " if $ranks;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\hline\n" unless $ld;
			}
		} else { 

			my $order = 1;
			foreach (1 .. $max_entry) { 

				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT "{\\footnotesize Name: }";
				print TEXOUT " & " if $points;
				print TEXOUT "\\makebox[.5in]{\\hrulefill}" if $ld;
				print TEXOUT " & " if $ranks;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\hline\n" unless $ld;
			}
		}

		print TEXOUT "\\end{tabular}\n";

		print TEXOUT "\\end{minipage}\n";

		if ($ranks) { 
			print TEXOUT "\\hspace{.15in}\n"
		} else { 
			print TEXOUT "\\hspace{.25in}\n"
		}

		print TEXOUT "\\begin{minipage}[c]{3.5in}";
		print TEXOUT "\n \\normalsize\n";

		if ($event->type eq "pf") { 
			print TEXOUT "\\hfill {\\footnotesize (Circle One) } \\hspace{.1in} {\\small {\\bf  PRO \\hspace{.1in} CON } }\n\n\\medskip\n";
			print TEXOUT "\\begin{tabular}{"
		} else { 
			print TEXOUT "{\\small \\bf NEGATIVE}\n\\newline\n";
			print TEXOUT "\\begin{tabular}{"
		} 

		undef $first_row;
		$size = "1.75in" if $ranks;
		$size = "2.25in" unless $ranks;

		if ($max_entry > 1) { 
			print TEXOUT "|p{.25in}|p{$size}";
			$first_row = " {\\bf \\scriptsize Spkr} & {\\bf \\truncate{$size}{".Tab::texify($neg->code)."} }" if $neg;
			$first_row = " {\\bf \\scriptsize Spkr} & {\\bf Team: } " unless $neg;
		} else { 
			print TEXOUT "|" unless $event->type eq "ld";
			print TEXOUT "p{$size}";
			$first_row = " {\\bf \\truncate{$size}{".Tab::texify($neg->code)."} }" if $neg;
			$first_row = " {\\bf \\truncate{$size}{ Debater: } }" unless $neg;
		}

		if ($points) { 
			print TEXOUT "|" unless $ld;
			print TEXOUT "p{.4in}";
			$first_row .= " & \\begin{minipage}[c]{.4in}\n";
			$first_row .= "\\vspace{.05in}\n";
			$first_row .= "{\\bf \\scriptsize POINTS}\n\n";
			$first_row .= "{\\scriptsize ( $min_points - $max_points )}\n";
			$first_row .= "\\vspace{.02in}\n";
			$first_row .= "\\end{minipage}\n";
		}

		if ($ranks) { 
			print TEXOUT "|" unless $ld;
			print TEXOUT "p{.4in}";
			$first_row .= " & \\begin{minipage}[c][][t]{.4in}\n";
			$first_row .= "\\vspace{.05in}\n";
			$first_row .= "{\\bf \\scriptsize RANK}\n\n";
			$first_row .= "\\vspace{.22in}\n\n";
			$first_row .= "\\end{minipage}\n ";
		}

		print TEXOUT "|" unless $ld;
		print TEXOUT "}\n";
		print TEXOUT "\\hline\n" unless $ld;
		print TEXOUT $first_row."\\\\ \n";
		print TEXOUT "\\hline\n" unless $ld;

		$order = 1;

		if (@negs) { 
			foreach my $speaker (@negs) { 
				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT Tab::texify($speaker->first." ".$speaker->last." ");
				print TEXOUT " & " if $points;
				print TEXOUT "\\makebox[.5in]{\\hrulefill}" if $ld;
				print TEXOUT " & " if $ranks;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\hline\n" unless $ld;
			}
		} else { 

			foreach (1 .. $max_entry) { 

				print TEXOUT " & " if $max_entry > 1;
				print TEXOUT "{\\footnotesize Name: }";
				print TEXOUT " & " if $points;
				print TEXOUT "\\makebox[.5in]{\\hrulefill}" if $ld;
				print TEXOUT " & " if $ranks;
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\hline\n" unless $ld;
			}
		}

		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\end{minipage}\n";
		print TEXOUT "\\medskip\n";
		print TEXOUT "\\newline\n";
	}

	print TEXOUT "\\begin{minipage}[c][][r]{7in}\n";
	print TEXOUT "\\begin{center}\n";
	print TEXOUT "\\vspace{.3in}\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "Winner: \\makebox[2.5in]{\\hrulefill} debating on the \\makebox[1in]{\\hrulefill}\n";
	print TEXOUT "\\hspace{.15in} \\footnotesize Low point win? \\makebox[.5in]{\\hrulefill} \n" if $lpw &! $elim;
	print TEXOUT "\n";

	print TEXOUT "\\scriptsize\n";
	if ($elim) { 
		print TEXOUT "\\makebox[1.65in]{}School/Team\\makebox[2.3in]{} Side (Aff or Neg)" unless $event->type eq "pf";
		print TEXOUT "\\makebox[1.25in]{}School/Team\\makebox[2in]{} Side (Pro or Con)" if $event->type eq "pf"; 
	} else { 
		print TEXOUT "\\makebox[.65in]{}School/Team\\makebox[2.3in]{} Side (Aff or Neg)" unless $event->type eq "pf";
		print TEXOUT "\\makebox[.85in]{}School/Team\\makebox[2.3in]{} Side (Pro or Con)" if $event->type eq "pf"; 
		print TEXOUT "\\makebox[1.25in]{}" if $lpw;
	}
	print TEXOUT "\n\n";
	print TEXOUT "\\vspace{.25in}\n";
	print TEXOUT "Signature:  \\makebox[3.25in]{\\hrulefill} ";
	print TEXOUT "School: \\makebox[2in]{\\hrulefill}" if $event->type eq "pf";
	print TEXOUT "\n\n";
	print TEXOUT "\\end{center}\n";
	print TEXOUT "\\end{minipage}\n\n";
	print TEXOUT "\\vspace{.15in}\n";
	print TEXOUT "\\noindent";
	print TEXOUT "\\makebox[7in]{\\hrulefill}\n\n";
	print TEXOUT "\\noindent\n";
	print TEXOUT "Comments \\\& Reason for Decision:\n" unless $elim;
	print TEXOUT "\\vspace{2in}\n";
	print TEXOUT "\\newline\n";

	close (TEXOUT);

	return;

</%perl>
