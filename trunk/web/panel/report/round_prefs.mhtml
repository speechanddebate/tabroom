<%args>
	$session
	$round_id => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);

	my %judge_ratings = $m->comp("/funclib/event_judgeprefs.mas", event => $round->event, ndt_type => "elim");

	my @entries = $m->comp("/funclib/round_entries.mas", round => $round);

	my @judges = $m->comp("/funclib/judge_avail_by_rd.mas", round => $round); 

	my $roundname = $round->realname;

	$roudname =~ $name =~ s/[\W_]//g;

    my $filename = "JudgePrefs-".$roundname.".csv";
    $m->clear_buffer;
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print('"Judge",');

	foreach my $entry (@entries) { 
		$m->print('"'.$entry->code.'",');
	}

	$m->print('"Total 1",');
	$m->print('"Total S"'."\n");

	my %tier_by_id = map {$_->id => $_->name} $round->event->judge_group->rating_tiers;

	foreach my $judge (@judges) { 

		$m->print('"'.$judge->last.", ".$judge->first.'",');

		my $judge_id;
		my $total_ones;
		my $total_strikes;

		foreach my $entry (@entries) { 
			my $rating = $tier_by_id{$judge_rating{$entry->id."-".$judge_id}}; 
			$m->print('"'.$rating.'",');
			$total_ones++ if $rating == 1;
			$total_strikes++ if $rating == 3;
		}

		$m->print('"'.$total_ones.'",');
		$m->print('"'.$total_strikes.'"'."\n");

	}

	$m->flush_buffer;
	$m->abort;

</%init>




