<%args>
	$tourn
	$panel_id => undef
	$confirm  => undef
	$message  => undef
	$motion   => undef
	$only     => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now( time_zone => $tz);

	my $panel = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $round = $panel->round;
	my $event = $round->event;

	if ($confirm) { 

		unless ($panel) { 
			my $msg = "Pick a section plz";
			$m->redirect("/panel/schemat/show.mhtml?event_id=".$event->id."&msg=$msg");
		}

		if ( $event->type eq "speech" ) { 
			$m->comp("blast_speech.mas", panel => $panel, message => $message, only => $only);
		} elsif ( $event->type eq "congress" ) { 
			$m->comp("blast_congress.mas", panel => $panel, only => $only);
		} elsif ( $event->type eq "wudc" ) { 
			$m->comp("blast_wudc.mas", panel => $panel, message => $message, incl_motion => $motion, only => $only);
		} else { 
			$m->comp("blast_debate.mas", panel => $panel, message => $message, only => $only, incl_motion => $motion);
		}

		my $msg = "Email and text message sent to folks in this section";
		$m->redirect("panel_view.mhtml?panel_id=".$panel->id."&msg=$msg");

	}

</%init>

	<div class="main">

		<h2>Blast Pairing</h2>

		<p>This will send individual email and text assignments to the judges and entries in:</p>

		<br />
		
		<h5 class="centeralign">Section <% $panel->letter %> room <% $panel->room ? $panel->room->name : "NONE" %> of <% $round->realname %> of <% $round->event->name %></h5>

		<br />

		<form action="panel_blast.mhtml">
		<input type="hidden" name="panel_id" value="<% $panel->id %>">

		<div class="evenrow">
			<span class="half smallish">
				Include a message to recipients (50 characters max)
			</span>
			<span class="half">
				<input type="text" name="message" maxlength="50" size="40">
			</span>
		</div>

		<span class="oddrow">
			<span class="quarter">
				To:
			</span>
			<label for="everyone">
				<span class="quarter hover">
					<input type="radio" name="only" id="everyone" value=""> Everyone
				</span>
			</label>
			<label for="judges">
				<span class="hover quarter">
					<input type="radio" id="judges" name="only" value="judges"> Judges Only
				</span>
			</label>
			<label for="entries">
				<span class="hover quarter">
					<input type="radio" id="entries" name="only" value="entries"> Entries Only
				</span>
			</label>
		</span>
			
%		if ($round->event->type eq "wudc" || $round->event->type eq "wsdc") { 
			<div class="whitenohover padmuchmore centeralign">

				<span class="quarter">
					<label for "include">
						Include Motion:
					</label>
				</span>

				<span class="quarter">
					<input type="checkbox" class="largecheck" name="motion" id="include" value="1">
				</span>

				<span class="half">
					<% $round->setting("motion") %>
				</span>

			</div>
%		}

		<span class="liblrow block rightalign">
			<input type="submit" name="confirm" value="Send email/text blast" placeholder="Max 50 characters">
			</form>
		</span>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a class="blue block" href="show.mhtml?round_id=<% $round->id %>">
				<% $event->abbr %> Round <% $round->name %> Pairing
			</a>

			<a class="blue block" href="/panel/report/master_single.mhtml?panel_id=<% $panel->id %>">
				Print Master Ballots
			</a>

			<a class="blue block" href="/panel/report/posting.mhtml?panel_id=<% $panel->id %>">
				Print Round Posting
			</a>

			<a class="dkblue block" href="/panel/schemat/panel_blast.mhtml?panel_id=<% $panel->id %>">
				Text/email blast this section
			</a>

		</div>

		<div class="sidenote">

%			if ($round->flighted > 1) { 
				<h4>Flight</h4>

				<span class="evenrow block centeralign">
					<form action="panel_flight_save.mhtml" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					<select name="flight" onchange='this.form.submit()' class="fixedsmall">  
						<option value="">None</option>
%					foreach my $flight ( 1 .. $round->flighted ) { 	
						<option value="<% $flight %>" <% $flight == $panel->flight ? "selected" : "" %>>
							<% $flight %>
						</option>
%					}
				</select>
				</form>
			</span>

%			}

			<h4>Room</h4>

			<span class="evenrow block centeralign">
				<form action="panel_room_save.mhtml" method="post">
				<input type="hidden" name="panel_id" value="<% $panel_id %>">
				<select name="room_id" onchange='this.form.submit()' class="fixedsmall">  

%					if ($panel->room) { 
						<option value="<% $panel->room->id %>" "selected"><% $panel->room->name %></option>
%					}

%					foreach my $room ($m->comp("/funclib/clean_rooms.mas", panel => $panel)) { 
						<option value="<% $room->id %>"><% $room->name %></option>
%					}

				</select>
				</form>
			</span>

			<h4>Time</h4>

%			my $switch;
%			my $start = $round->timeslot->start->set_time_zone($tz);
%			my $end = $round->timeslot->end->set_time_zone($tz);

			<table cellpadding="4" cellspacing="1" width="100%">
		
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						Starts: 
					</td>

					<td class="centeralign smallish">
						<% &Tab::niceshortdt($start) %> 
					</td>
				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
	
					<td class="smallish">
						Ends
					</td>	

					<td class="centeralign smallish">
						<% &Tab::niceshortdt($end) %> 
					</td>

				</tr>

			</table>

		</div>

		<div class="sidenote">

			<h4>Make Changes</h4>

			<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				Change Speaker Order
			</a>

			<a href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				View/Edit Ranks
			</a>


			<form action="judge_add.mhtml" method="post">
			<input type="hidden" name="panel_id" value="<% $panel->id %>">
			<span class="evenrownohover block">
				Force add judge
				<input type="text" size="5" class="thin" name="code" placeholder="Code">
				<input type="submit" value="Go" class="thin padno">
			</span>
			</form>
	
		</div>

	</div>

