<%args>
	$round_id
	$type
	$timeslot
	$flighted 
	$tb_set              => undef
	$label               => undef
	$wipe_rooms          => undef
	$flight_rooms_only   => 0
	$motion              => undef
	$note                => undef
	$judges              => undef
	$pool                => undef
	$ballot_rules        => 0
	$tab_rating_priority => undef
	$offset              => 0
	$start_time          => undef
</%args>
<%init>

	$m->abort unless $tb_set && $round_id;

	my $round = Tab::Round->retrieve($round_id);
	my $event = $round->event;
	my $tz = $event->tourn->tz;

	$tz = "UTC" unless $tz;

	$round->type($type);
	$round->timeslot($timeslot);
	$round->flighted($flighted);
	$round->tb_set($tb_set);
	$round->label($label);
	$round->wipe_rooms($wipe_rooms);
	$round->motion($motion);
	$round->note($note);
	$round->judges($judges);
	$round->pool($pool);

	$round->update();

	my $start_date = $round->timeslot->start->set_time_zone($tz);

	my $start = Tab::dtme( $start_date->mdy('/'), $start_time, $tz);

	undef $start unless $start->year;
	$round->start_time($start);


	$tab_rating_priority =~ s/\./,/g;
	$tab_rating_priority =~ s/\ /,/g;
	$tab_rating_priority =~ s/\:/,/g;

	$event->setting("tab_rating_priority", $round->id, $tab_rating_priority) if $tab_rating_priority;
	$event->setting("tab_rating_priority", 0) unless $tab_rating_priority;
	$event->setting("ballot_rules", $ballot_rules);
	$event->setting("flight_offset", $offset);
	$event->setting("flight_rooms_only", $flight_rooms_only);

	my $msg = "Round ".$round->realname." settings saved  $start_time";

	my $err = $label ." is a manifestly ridiculous name for an elimination round. It's not even proper Latin.  <br/></br/>If you are going to use weird round names like that, consider using Joy of Tournaments instead in the future." if $label eq "Sextodecimals";

	$m->redirect("show.mhtml?round_id=".$round->id."&settings=1&msg=$msg&err=$err");

</%init>
