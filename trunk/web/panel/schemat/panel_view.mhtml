<%args>
	$session
	$tourn
	$account
	$panel_id
	$from => undef
	$judge_id => undef
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id);

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;

	my $timeslot = $panel->round->timeslot;
	my $start = $timeslot->start;
	my $end = $timeslot->end;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	$start->set_time_zone($tz);
	$end->set_time_zone($tz);

	my $event = $panel->round->event;
	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);
	my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

	my $coach_ratings++ if $event->judge_group->setting("coach_ratings");
	my $no_judge_codes++ if $event->judge_group->setting("no_codes");

	my $room = $panel->room;
	my @good_judges = $m->comp("/funclib/clean_judges.mas", 
		panel_id => $panel_id, 
		session => $session );

	my $judge_indicator;

	@good_judges = sort {$a->code cmp $b->code} @good_judges;	
	@good_judges = sort {$b->score cmp $a->score} @good_judges;	
	@good_judges = sort {$a->rating cmp $b->rating} @good_judges if $coach_ratings;	

	my %is_standby = ();

	foreach my $judge ($m->comp("/funclib/pool_judges.mas", pool => $round->pool)) { 
		$is_standby{$judge->id} = 1;
		$judge->score("S");
	}

	@good_judges = sort {$is_standby{$b->id} <=> $is_standby{$a->id}} @good_judges;	

</%init>

	<div class="left huge">

		<h2>Round <% $round->name %> Panel <% $panel->letter %> of <% $event->abbr %></h2>

%			if ($from eq "entry") { 

				<td align="right">
					<form action="<% $Tab::url_prefix %>/tabbing/rank.mhtml" method="post">
					<input type="hidden" value="<% $panel->round->timeslot->id %>" name="timeslot_id">

%					if (@judges && scalar @judges == 1) { 
						<input type="hidden" value="<% $judges[0]->id %>" name="judge_id">
%					}

 					<input  type="submit" value="Return to Rank Entry">
					</form>
				</td>

%			}


		<div class="block yellowrow padless" style="padding-left: 0;">

			<span class="medspan" style="padding-left: 0;">
				<h4>Room</h4>
			</span>

			<span class="biggishspan rightalign" style="float: right;">
				<form action="panel_room_save.mhtml" method="post">
				<input type="hidden" name="panel_id" value="<% $panel_id %>">
				<select name="room_id" onchange='this.form.submit()'> 

%					if ($panel->room) { 
						<option value="<% $panel->room->id %>"><% $room->name %></option>
%					}

%					foreach my $room ($m->comp("/funclib/clean_rooms.mas", panel => $panel)) { 
						<option value="<% $room->id %>"><% $room->name %></option>
%					}

				</select>
				</form>
			</span>
			<br style="clear: both;">

		</div>

		<h4>Judges</h4>
		
		<table cellspacing="1" cellpadding="5" width="100%">

			<tr class="yellowrow">

				<th class="smaller">
					Judge
				</th>

% 				if ($coach_ratings) { 
					<th class="smaller">
						Qual
					</th>
%				}

%				if ($tourn->setting("ncfl")) { 
					<th class="smaller">
						Dio
					</th>
%				}

				<th class="smaller">
					School
				</th>

				<th class="smaller" colspan="2">
					Remove
				</th>

%				if (scalar @judges > 1) { 
					<th class="smaller">
						Chair?
					</th>
%				}

			</tr>

% 			my $switch;

% 			foreach my $judge (@judges) { 

%				my $rating;

%				if ($coach_ratings) { 
%					$rating = $judge->rating(rating_subset => $event->rating_subset->id) if $event->rating_subset;
%					$rating = $judge->rating unless $rating;
%				}

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smaller" align="left">
						<a class="white block" href="/register/judge_edit.mhtml?judge_id=<% $judge->id %>"> 
							<% ($no_judge_codes) ? "" : $judge->code  %>
							<% $judge->first." ".$judge->last %>
						</a>
					</td>

% 					if ($coach_ratings) { 
						<td class="smaller" align="center">
							<% $rating->rating_tier->name %>
						</td>
% 					}

%					if ($tourn->setting("ncfl")) { 

						<td class="smaller" align="center">
							<% $judge->school->region->code %>
						</td>

%					}

					<td class="smaller">
						<% ($judge->school) ? $judge->school->short_name : "HIRE" %>
					</td>

					<td class="centeralign">
						<a class="dkgreen block" href="/panel/judge_rm.mas?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>">Remove</a>
					</td>
					
					<td class="centeralign">
						<a class="dkred block" href="/panel/judge_rm.mas?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes">Remove & Fine</a>
					</td>


%					if (scalar @judges > 1) { 

						<td class="smaller" align="center">
							<% $judge->is_chair($panel) 
								? "<b>Yup</b>" 
								: "<a class=\"white block\" href=\"make_chair.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">No</a>" %>
						</th>

%					}

				</tr>

% 		}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<th class="smaller rightalign" style="padding-top: 13px;">
					Add judge:
				</th>

				<td colspan="4" class="rightalign" style="padding-top: 13px;">
					<form action="panel_judgeadd.mas" method="post">
					<input type="hidden" name="panel_id" value="<% $panel_id %>">
					<input type="hidden" name="from" value="<% $from %>">
					<select name="judge_id" onchange='this.form.submit()'> 

						<option value="">Rds  Own  <% ($coach_ratings) ? "Rtng" : "" %> <% ($tourn->setting("ncfl")) ? "Dio" : "" %> &nbsp;&nbsp;&nbsp;Judge</option>
						<option value="">------------------------------------<% $no_judge_codes ? "------------------" : "" %></option>

%	 					foreach my $judge (@good_judges) { 

<%perl>

							my $rating;

							if ($coach_ratings) { 
								my $rj = $judge->rating(rating_subset => $event->rating_subset->id) if $event->rating_subset;
								$rj = $judge->rating unless $rating;
								$rating = $rj->rating_tier->name;
							}


							my $school;
							my $code;

							if ($no_judge_codes) { 
								$school = substr($judge->school->short_name, 0, 20) if $judge->school;
								$school = "HIRED" unless $school;

								foreach ( length($school) .. 20) {
									$school .= "&nbsp;";
								}

							} else { 
								$school = $judge->school->code if $judge->school;
								$school = "HIRE" unless $school;
								$code = $judge->code;
								foreach ( length($school) .. 4) {
									$school .= "&nbsp;";
								}
							}

							my $score = $judge->score;
   	        				my $tmp = $judge->tmp;

</%perl>


							<option value="<%$judge->id %>">
 
								&nbsp;<% $tmp %>
								&nbsp;

								<% $score %>
								&nbsp;&nbsp;

								<% $rating %>&nbsp;

								<% $school %> 
								<% $code %>&nbsp;
	
								<% $judge->first." ".$judge->last %>

								<% ($is_standby{$judge->id}) ? "STANDBY" : "" %>

							</option>
	
% 						} 

					</select> 
					<noscript>
					<input  type="submit" value="Add">
					</noscript>
					</form>

				</td>

			</tr>

		</table>

		<h4> Entries </h4>

		<table cellspacing="1" cellpadding="4" width="100%">

			<tr class="yellowrow">

				<th class="smaller">
					Spks
				</th>

				<th class="smaller">
					Entry
				</th>

				<th class="smaller">
					School
				</th>

%				if ($tourn->setting("ncfl")) {
					<th class="smaller">
						Dio
					</th>
%				}

				<th colspan="2">
				</th>


			</tr>

% 		$switch = 1;

% 		foreach my $entry (@entries) { 

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td class="smallish">
					<% Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks) %>
				</td>

				<td class="smallish">
					<a class="white block" href="/register/entry_edit.mhtml?entry_id=<% $entry->id %>">
						<% ($entry->dq) ? "DQ" : $entry->code %>
						<% $m->comp('/funclib/entry_name.mas', entry => $entry) %>
					</a>
				</td>
					
				<td class="smallish">
					<% $entry->school->short_name %> 
				</td>

				<% ($entry->school->code) ? "<td class=\"smallish\">".$entry->school->code."</td>" : "" %>

%				if ($tourn->setting("regions") || $tourn->setting("ncfl")) {

					<td class="smallish centeralign">
						<% ($entry->school->region) ? $entry->school->region->code : "" %>
					</td>

%				}

				<td class="smallish centeralign">
					<a class="white block" href="/panel/entry_edit.mhtml?entry_id=<%$entry->id%>&round_id=<% $round->id %>">Move</a>
				</td>

			</tr>

% 		}

		</table>


%		if ($account->site_admin) { 

			<br />

			<p style="text-align: center;" >
				Round <% $round->id %> Panel <% $panel->id %> Event <% $event->id %>
			</p>
%		}

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a class="blue block" href="show.mhtml?round_id=<% $round->id %>">
				<% $event->abbr %> Round <% $round->name %> Pairing
			</a>

			<a class="blue block" href="<% $Tab::url_prefix %>/panel/print_one_master.mhtml?panel_id=<% $panel->id %>">
				Print Master Ballots
			</a>

			<a class="blue block" href="<% $Tab::url_prefix %>/panel/print_posting.mhtml?panel_id=<% $panel->id %>">
				Print Round Posting
			</a>

		</div>

		<div class="sidenote">

			<h4>Info</h4>

			<table cellpadding="4" cellspacing="1" width="100%">
		
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Starts: 
					</td>

					<td class="centeralign">
						<% &Tab::niceshortdt($start) %> 
					</td>
				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
	
					<td>
						Ends
					</td>	

					<td class="centeralign">
						<% &Tab::niceshortdt($end) %> 
					</td>

				</tr>

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Room
					</td>

					<td class="centeralign">
						<% ($panel->room) ? $panel->room->name : "" %>
					</td>
					
				</tr>

			</table>

		</div>

		<div class="sidenote">

			<h4>Make Changes</h4>

			<a class="yellow block" href="force_judge.mhtml?panel_id=<% $panel->id %>">
				Force-add an unclean judge
			</a>

			<a href="manual_assign.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				Alter Speakers in Section
			</a>

			<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				Change Speaker Order
			</a>

			<a href="/tabbing/panel_card.mhtml?panel_id=<% $panel->id %>" class="yellow block">
				View/Edit Ranks
			</a>

% 			unless (@judges || @entries) { 
				<a href="panel_rm.mas?panel_id=<% $panel_id %>" class="dkred block">Delete Panel</a>
% 			}
	
		</div>

	</div>

	<div style="clear: both;">
