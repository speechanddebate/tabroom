<%args>
	$tourn
	$account
	$panel_id
	$from => undef
	$judge_id => undef
	$max_mut => undef
	$max_pref => undef
</%args>
<%init>

	use Data::Dumper;
	use Math::Round;
	use Time::HiRes qw( time );
	my $start_processing = time(); 

	unless ($max_mut) { $max_mut = 30; }
	unless ($max_pref) { $max_pref = 50; }
	
	my $panel = Tab::Panel->retrieve($panel_id);
	my $switch;

	my $ncfl++ if $tourn->setting("ncfl");

	my $tourn_access = Tab::TournAdmin->search( account => $account->id, tourn => $tourn->id)->first;
	my $entry_only++ if $tourn_access && $tourn_access->entry_only;
	undef $entry_only if $account->site_admin;

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;
	my @values = $m->comp("/funclib/panel_ballot_values.mas", panel => $panel);

	my $timeslot = $panel->round->timeslot;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $start = $timeslot->start->set_time_zone($tz);
	my $end = $timeslot->end->set_time_zone($tz);

	my $event = $panel->round->event;
	my $group = $event->judge_group;

	#all judges
	my @judges_in_group = Tab::Judge->search( judge_group => $group);
#	print Dumper(@judges_in_group);
		
	#judges currently assigned in the round
	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel); 

	my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

	my @good_judges = $m->comp("/funclib/clean_judges.mas", panel => $panel);
#	print Dumper(@good_judges);

	my @busy_judges = $m->comp("/funclib/timeslot_judges.mas", timeslot => $timeslot); 
#	foreach my $busyjudge (@busy_judges) {
#		print $busyjudge->last."<br>";
#	}

	my $judge_hash = $m->comp("/funclib/judge_use.mas", round_id => $round->id);			
	my %used_by_judgeid = %{$judge_hash};

	my $affref; my $affref_temp;
	my $negref; my $negref_temp;
	my $diffref; my $diffref_temp;

	($affref, $negref, $diffref) = $m->comp("/funclib/panel_ratings.mas", panel => $panel, type => $group->setting("prefs"));

	my %all_judges;
	my $oblig; my $used; my $future;
	
	foreach my $judge (@judges_in_group) {

		$all_judges{$judge}{'name'} = $judge->first." ".$judge->last;

		$all_judges{$judge}{'school'} = $judge->school;
		$all_judges{$judge}{'schoolname'} = $judge->school->name;

		$oblig=0; $used=0; $future=0;
		if ($judge->obligation) { $oblig = $judge->obligation; }
		if ($used_by_judgeid{$judge->id}{'judged_already'}) { $used = $used_by_judgeid{$judge->id}{'judged_already'}; }
		if ($used_by_judgeid{$judge->id}{'will_judge'}) { $used = $used_by_judgeid{$judge->id}{'will_judge'}; }
		
		$all_judges{$judge}{'obligation'} = $oblig."/".$used."/".$future;

		$all_judges{$judge}{'owed'} = $oblig - $used - $future; 
		$all_judges{$judge}{'any_left'} = 0;
		if ( $all_judges{$judge}{'owed'} > 0 ) { $all_judges{$judge}{'any_left'} = 1; }

		$all_judges{$judge}{'affpref'} = ${$affref}{$judge->id};

		$all_judges{$judge}{'negpref'} = ${$negref}{$judge->id};

		$all_judges{$judge}{'mut'} = abs(${$affref}{$judge->id} - ${$negref}{$judge->id} );

		if ( ${$negref}{$judge->id} > ${$affref}{$judge->id} ) {
			$all_judges{$judge}{'pref'} = ${$negref}{$judge->id};
		} else { 
			$all_judges{$judge}{'pref'} = ${$affref}{$judge->id};
		}
		
		$all_judges{$judge}{'avg'} = $m->comp("/funclib/judge_avg_rating.mas", judge => $judge);
		
		$all_judges{$judge}{'avail'} = 3;
	}

	foreach my $judge2 (@good_judges) {
		$all_judges{$judge2}{'avail'} = 1;
		$all_judges{$judge2}{'schoolname'} = $judge2->school->name;
	}

	foreach my $judge3 (@busy_judges) {
		if ($all_judges{$judge3}{'avail'} == 1) {
			$all_judges{$judge3}{'avail'} = 2;
		}	
		$all_judges{$judge3}{'schoolname'} = $judge3->school->name;
	}

#Load pairing stuff

	my @rd_entries = $m->comp("/funclib/round_entries.mas", round => $round);
	my $last_round_name = $round->name - 1;
	my $last_round = Tab::Round->search( event => $round->event->id, name => $last_round_name)->first;
	my %entry_wins = $m->comp("/funclib/entry_wins.mas", event => $round->event, round => $last_round);
	my %entry_losses = $m->comp("/funclib/entry_losses.mas", event => $round->event, round => $last_round);
	my %entry_info;
	my @panels = Tab::Panel->search( round => $round->id);
		
	my %matchup;

	foreach my $panel (@panels) { 
		foreach my $entry (@rd_entries) {
			if ($entry->panelid == $panel->id ) {
				$matchup{$panel}{'display_string'} .= $entry->code;
				$matchup{$panel}{'display_string'} .= " (".$entry_wins{$entry}."-";
				$matchup{$panel}{'display_string'} .= $entry_losses{$entry}.") ";
				if  ( $matchup{$panel}{'aff'} == 0 ) { $matchup{$panel}{'aff'} = $entry->id; 
				} else { $matchup{$panel}{'neg'} = $entry->id; }
			}
		}
	}


	sub calc_panel_balance {
	
		my ($judge_in, $judge_out, $judges_ref, $all_judges) = @_;
		my @judges = @{$judges_ref};
		
		my $total; my $aff; my $neg; my $bal;
		
		foreach my $judge (@judges) {
			if ($judge->id != $judge_out) {
				$aff += ${$all_judges}{$judge->id}{'affpref'};
				$neg += ${$all_judges}{$judge->id}{'negpref'};
			}
		}
		
		$aff += ${$all_judges}{$judge_in}{'affpref'};
		$neg += ${$all_judges}{$judge_in}{'negpref'};
		
		my $string = sprintf( "%.0f", (abs($aff-$neg)) )."-".sprintf( "%.0f", $aff+$neg );
		
		return $string;
	}
				
</%init>

	<div class="left huge">

		<h2>Judge switch for
%		$switch=0;
%		foreach my $entry (@entries) {
%			$switch++;
%			if ( $switch > 1) { $m->print(" vs "); }
			<% $entry->code %>
%		}
		</h2>
		Round <% $round->realname %> of <% $event->abbr %>
		<h4>Judge(s) currently on panel</h4>
		
		<table cellspacing="1" cellpadding="5" width="100%" >

			<tr class="yellowrow">

				<th class="smaller">
%					if ($event->type eq "congress") { 
						Parli
%					} else { 
						Chair
%					} 
				</th>

				<th class="smaller">
					Judge
				</th>

				<th class="smaller">
					Owed (oblig/used/future)
				</th>

				<th class="smaller">
					School
				</th>

				<th class="smaller" colspan="2">
					Remove
				</th>

				<th class="smaller" colspan="2">
					Avg Pref%
				</th>

			</tr>

%			my $afftot; my $negtot;
% 			foreach my $judge (@judges) { 
%			$afftot += ${$affref}{$judge->id};
%			$negtot += ${$negref}{$judge->id};

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smaller centeralign" width="15px;">
						<% $judge->chair
							? "<a class=\"dkgreen fullblock\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">Y</a>"
							: "<a class=\"dkred fullblock\" href=\"chair_switch.mhtml?judge_id=".$judge->id."&panel_id=".$panel->id."\">N</a>" %>
					</td>

					<td class="smallish" align="left">
						<% $all_judges{$judge->id}{'name'} %>
					</td>

					<td>
						<% $all_judges{$judge->id}{'owed'} %> (<% $all_judges{$judge->id}{'obligation'} %>)
					</td>

					<td class="smallish">
						<% ($judge->school) ? $judge->school->short_name : "HIRE" %>
					</td>

%					if (@values) { 

%						my $warn = "These ballots have scores entered.  If you remove the judge you will also delete those scores.  Continue?";

						<td class="centeralign smaller">
							<a class="dkred fullblock" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&pre=mjp">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred fullblock" <& "/funclib/confirm.mas", warn => $warn &>
							href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes&pre=mjp">RM & Fine</a>
						</td>

%					} else { 

						<td class="centeralign smaller">
							<a class="dkred fullblock" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&pre=mjp">Remove</a>
						</td>
					
						<td class="centeralign smaller">
							<a class="dkred fullblock" href="judge_rm.mhtml?from=<% $from %>&judge_id=<%$judge->id %>&panel_id=<% $panel->id %>&fine=yes&pre=mjp">RM & Fine</a>
						</td>

%					} 

					<td class="smallish">
						<% $all_judges{$judge->id}{'avg'} %>
					</td>

				</tr>

% 		}

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					<td></td>
					<td>Panel Balance: <% sprintf( "%.1f", abs($afftot-$negtot)) %></td>
					<td>Panel Total: <% sprintf( "%.1f", ($afftot+$negtot)) %></td>
					<td>Aff Total: <% sprintf( "%.1f", $afftot) %></td>
					<td>Neg Total: <% sprintf( "%.1f", $negtot) %></td>										
				</tr>
				
		</table>

		<hr>
		
%		my $ctr = 1;

%		until ($ctr >= 4) {

%			if ( $ctr == 1 ) {
				<h4>Unused and available Judges</h4>
%			} elsif ( $ctr == 2 ) {
				<h4>In Other Debates</h4>
%			} elsif ( $ctr == 3) {
				<h4>Unavailable</h4>
%			}	

			<table cellspacing="1" cellpadding="5" width="100%" class="tablesorter">

				<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Name
					</th>
						
					<th class="smaller">
						Owed (oblig/used/future)
					</th>

					<th class="smaller">
						School
					</th>

					<th class="smaller">
						Aff
					</th>

					<th class="smaller">
						Neg
					</th>												

					<th class="smaller">
						Pref
					</th>												

					<th class="smaller">
						Mut
					</th>																

					<th class="smaller">
						Avg
					</th>				

%					if ( $ctr != 3 ) {				
						<th class="smaller">
							Add
						</th>				

						<th class="smaller">
							Replace (mut-tot)
						</th>
%					}				

%					if ( $ctr == 2 ) {
						<th class="smaller">
							Double Switch
						</th>

						<th class="smaller">
							in debate
						</th>
%					}

				</tr>

				</thead>

				<tbody>

%				foreach my $key (sort {$all_judges{$b}->{'any_left'} <=> $all_judges{$a}->{'any_left'} || $all_judges{$a}->{'pref'} <=> $all_judges{$b}->{'pref'} } keys(%all_judges)) {

%					if ( $all_judges{$key}{'avail'} == $ctr ) {

						<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

							<td>
								<% $all_judges{$key}{'name'} %>
							</td>

							<td>
								<% $all_judges{$key}{'owed'} %> (<% $all_judges{$key}{'obligation'} %>)
							</td>

							<td>
								<% $all_judges{$key}{'schoolname'} %>
							</td>

							<td>
								<% sprintf( "%.1f", $all_judges{$key}{'affpref'} ) %>
							</td>

							<td>
								<% sprintf( "%.1f", $all_judges{$key}{'negpref'} ) %>
							</td>

							<td>
								<% sprintf( "%.1f", $all_judges{$key}{'pref'} ) %>
							</td>

							<td>
								<% sprintf( "%.1f", $all_judges{$key}{'mut'} ) %>
							</td>

							<td>
								<% sprintf( "%.1f", $all_judges{$key}{'avg'} ) %>
							</td>


%							if ( $ctr != 3 ) {				
								<td>
									<a class="dkgreen fullblock" href="judge_add.mhtml?panel_id=<% $panel_id %>&judge_id=<% $key %>&return=manual_mjp">Add</a>
								</td>
%							}

%							foreach my $judge (@judges) { 				

%								if ( $ctr != 3) {
									<td>
										<a class="dkgreen fullblock" href="judge_replace.mhtml?judge1_id=<% $judge->id %>&judge2_id=<% $key %>&round_id=<%  $panel->round %>">
											Replace <% $judge->last %> (<% calc_panel_balance($key, $judge->id, \@judges, \%all_judges) %>)
										</a>
									</td>
%								}

%								if ( $ctr == 2) {

									<td>
										<a class="dkgreen fullblock" href="judge_replace.mhtml?judge1_id=<% $judge->id %>&judge2_id=<% $key %>&round_id=<% $panel->round %>&doubswitch=GoMets">
											2x Switch <% $judge->last %>
										</a>
									</td>

<%perl>

									my $judge_temp = Tab::Judge->retrieve($key);

									my @judge_panel = $m->comp("/funclib/judge_panels.mas", judge => $judge_temp, panel => $panel, round => $round);

									my $temp_affpref; 
									my $temp_negpref;

									my @affpref = Tab::Rating->search( judge=> $judge->id, entry => $matchup{$judge_panel[0]}{'aff'} );
									foreach my $pref (@affpref) {
										$temp_affpref = sprintf( "%.1f", $pref->percentile)."-";
									}

									my @negpref = Tab::Rating->search( judge=> $judge->id, entry => $matchup{$judge_panel[0]}{'neg'} );
									foreach my $pref (@negpref) {
										$temp_negpref = sprintf( "%.1f", $pref->percentile);
									}

									my $mut = sprintf( "%.1f", abs($temp_affpref - $temp_negpref) ); 						

</%perl>
									<td>
										<% $judge->last %> in <% $matchup{$judge_panel[0]}{'display_string'} %> <% $mut %> (<% $temp_affpref %><% $temp_negpref %>)
									</td>	
%								}	
%							}

						</tr>

%					}
%				}		

				</tbody>
		
			</table>

%			$ctr++;	
%		}
		
%		if ($account->site_admin) { 

			<br />

			<p style="text-align: center;" >
				<% $round->realname %> Section <% $panel->id %> Event <% $event->id %>
			</p>

%			$end = time();
%			print "<br>processing time: ";
%			printf("%.2f\n", $end - $start_processing);

%		}

	</div>

	<div class="right small">

		<h4>Adjustments</h4>
		<a href="show.mhtml?round_id=<% $round->id %>" class="yellow block">
			Back to Pairings
		</a>
		<form action="manual_mpj_switch.mhtml" method="post">
		<input type="hidden" name="panel_id" value="<% $panel_id %>">
		<span class="greynohover block">
			Max Mut:
			<input type="text" size="5" class="thin" name="max_mut" value=<% $max_mut %>><br>
			Max Pref:
			<input type="text" size="5" class="thin" name="max_pref" value=<% $max_pref %> ><br>
			<input type="submit" value="Go" class="thin padno">
		</span>
		</form>

	</div>

