<%args> 
	$session
	$circuit
	$group_id
	$tourn
	$sort_by => "code"
</%args>
<%init>
	
	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @judges = $group->judges( active => 1 );
	
	@judges = sort {$a->code <=> $b->code} @judges;

	@judges = sort {$a->last cmp $b->last} @judges if $sort_by eq "last";

#	@judges = sort {$a->school->code cmp $b->school->code} @judges;

	my @events = $group->events;

	my %timeslot_keys = ();

	foreach my $event (@events) { 
		my @rounds = $event->rounds;
		foreach my $round (@rounds) { 
			$timeslot_keys{$round->timeslot->id}++ if $round->type eq "prelim";
		} 	
	}

	my @timeslot_ids = keys %timeslot_keys;
	my $tourn_id = $tourn->id;
	my @timeslots;

	foreach my $ts_id (@timeslot_ids) { 
		push (@timeslots, Tab::Timeslot->retrieve($ts_id));
	}	

	@timeslots = sort {$a->start <=> $b->start} @timeslots;

	my $filename = $Tab::file_root."/tmp/judgesheet-".$tourn->id."-".$session->id;
	my $garbage = `rm -f $filename.*`;
	open (TEXOUT, ">$filename.tex");

    print TEXOUT <<'EOF';
\documentclass[landscape,10pt]{article}
\usepackage {helvet}
\usepackage {fullpage}
\usepackage {colortbl}
\usepackage[hmargin=.75in,vmargin=.75in]{geometry}
\renewcommand{\familydefault}{\sfdefault}
\renewcommand{\arraystretch}{1.4}

\setlength{\oddsidemargin}{-.4in}     
\setlength{\textwidth}{9.0in}        
\setlength{\textheight}{7.5in}       
\setlength{\topmargin}{-.25in}      
\setlength{\headsep}{0in}         

\setlength{\parskip}{1.4ex}
\setlength{\parindent}{0mm}

\begin{document}
\begin{center}
\small
EOF

my $size_of_timeslot = 5.5 / scalar @timeslots if @timeslots;

	my $tabular = "\\begin{tabular}{p{.3in}p{.3in}p{1.4in}";
	my $special_tabular = "\\begin{tabular}{p{.3in}p{.3in}p{1.4in}p{6.85in}}\n";
	foreach my $ts (@timeslots) { $tabular .= "p{".$size_of_timeslot."in}";  }
	$tabular .= "}\n";

	print TEXOUT "\\begin{tabular}{p{8.0in}}\n";
	print TEXOUT "{\\large Prelim Judge Chart: ". &Tab::texify($group->name) ." ". $sort_by ." } \\\\\n";
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT $tabular;
	print TEXOUT "\\rowcolor[rgb]{1.0,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT "Code & ";
	print TEXOUT "Dio " if $circuit->diocese_based;
	print TEXOUT "Sch " unless $circuit->diocese_based;
	print TEXOUT " & Name ";

	foreach my $ts (@timeslots) { 
		my $ts_start = $ts->start;
		$ts_start->set_time_zone($circuit->timezone);
		print TEXOUT " & ". $ts_start->hour_12.":".$ts_start->strftime("%M") ;  
	}

	print TEXOUT "\\\\ \n";
	print TEXOUT "\\end{tabular}\n";

	my $switch;

	foreach my $judge (@judges) { 

		my @panels = $judge->panels;
		my %panels_by_ts = ();
		my %pools_by_ts = ();

		foreach my $panel (@panels) { 
			push (@{$panels_by_ts{$panel->round->timeslot->id}}, $panel);
		}

		my @pools = $judge->pools;

		foreach my $pool (@pools) { 
			next unless $pool->timeslot;
			push (@{$pools_by_ts{$pool->timeslot->id}}, $pool);
		}

		print TEXOUT $tabular if (@panels || @pools);
		print TEXOUT $special_tabular unless (@panels || @pools);

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify($judge->code)." & ";


	    if ($circuit->diocese_based) {
			print TEXOUT $judge->school->region->code;
		} else {
			print TEXOUT $judge->school->code if $judge->school;
			print TEXOUT "HIRE " unless $judge->school->id;
		}

		print TEXOUT " & ".&Tab::texify($judge->first." ".$judge->last);

	if (@panels || @pools) { 

		foreach my $timeslot (@timeslots) { 
			my $used;
			print TEXOUT " & ";

			foreach my $panel (@{$panels_by_ts{$timeslot->id}}) {
				print TEXOUT $panel->event->abbr." ".$panel->round->name." ".$panel->letter;
				$used++;
			}

			unless ($used) { 
				foreach my $pool (@{$pools_by_ts{$timeslot->id}}) {
					print TEXOUT "STBY"
				}
			}
		}
	} else { 

		print TEXOUT "& Other: ".&Tab::texify($judge->special);

	}
	
	print TEXOUT " \\\\ \n";	
	print TEXOUT "\\end{tabular}\n";
}

print TEXOUT "\\end{center}\n";
print TEXOUT "\\end{document}\n";
close TEXOUT;

$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
`rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
$m->redirect("$Tab::url_prefix/tmp/judgesheet-$tourn_id-".$session->id.".pdf");

</%init>
