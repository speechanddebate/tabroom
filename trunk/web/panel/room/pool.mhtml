<%args>
	$tourn
	$account
	$pool_id => undef
</%args>
<%init>

	my $tourn_access = Tab::TournAdmin->search( account => $account->id, tourn => $tourn->id )->first;
	my $no_setup++ if $tourn_access && $tourn_access->no_setup;
	undef $no_setup if $account->site_admin;

	my $pool = Tab::RoomGroup->retrieve($pool_id);

	my @pools = $tourn->room_groups;

	my @rooms = $m->comp("/funclib/tourn_rooms.mas", tourn => $tourn, inactive => 0);

	@rooms = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->name=~/(\d+)/] } @rooms;
	@rooms = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->name=~/(\D+)/] } @rooms;

	@rooms = sort { $a->site->name cmp $b->site->name} @rooms;

	my @sites = $tourn->sites;
	my $multi_sites++ if scalar @sites > 0;
	my %use_sites;
	my $yah;

	if ($multi_sites && $pool) { 
		foreach my $round ($pool->rounds) { 
			$use_sites{$round->site->id}++ if $round->site;
			$yah++;
		}
	}

</%init>

	<& menu.mas, tourn => $tourn, pool_id => $pool_id, whoami => "pool", no_setup => $no_setup  &>

	<div class="main">

%		unless ($pool) { 

			<h2>Choose a pool at right</h2>

			<& tabbar.mas, tourn => $tourn, whoami => "pool" &>

%		} else {

%			my @pool_rooms = $m->comp("/funclib/pool_rooms.mas", pool => $pool);
%			@pool_rooms = map  { $_->[0] } sort { $a->[1] <=> $b->[1] } map  { [$_, $_->name=~/(\d+)/] } @pool_rooms;
%			@pool_rooms = map  { $_->[0] } sort { $a->[1] cmp $b->[1] } map  { [$_, $_->name=~/(\D+)/] } @pool_rooms;

			<h2>Rooms for <% $pool->name %></h2>
		
			<& tabbar.mas, tourn => $tourn, whoami => "pool", pool_id => $pool->id  &>

			<script type="text/javascript">
				$(document).ready(function(){
					$("input:checkbox.room").change(function() { 

						var spanstring = '#span_' + $(this).attr("id");

						if($(this).is(":checked")) { 
							$.ajax({
								url: 'pool_room_switch.mhtml',
								type: 'POST',
								data: { room_id:$(this).attr("id"), value:"1", pool_id:"<% $pool_id %>" },
								success: function(data) { 
									$(spanstring).removeClass('evenrow').addClass('liblrow');
								}

							});
						} else {
							$.ajax({
								url: 'pool_room_switch.mhtml',
								type: 'POST',
								data: { room_id:$(this).attr("id"), value:"0", pool_id:"<% $pool_id %>" },
								success: function(data){ 
									$(spanstring).removeClass('liblrow').addClass('evenrow');
								}
							});
						}
					}); 
				});
			</script>

%			my %used = ();

			<div class="half smallish">

				<h4><% scalar @pool_rooms %> in pool:</h4>

%				foreach my $room (sort {$a->site->name cmp $b->site->name} @pool_rooms) { 

<%perl>

					next if $room->inactive;
					next if $used{$room->id}++;
					next if $yah && not defined $use_sites{$room->site->id};

					my $pool_string;
					my $not_first;

					foreach my $other ($room->pools) { 
						next if $other->id == $pool_id;
						next unless $other->tourn == $tourn->id;
						$pool_string .= ", " if $not_first++;
						$pool_string .= $other->name;
					}

</%perl>

					<label for="<% $room->id %>">
					<div class="optionblock liblrow martop-half" id="span_<% $room->id %>">

						<span class="twofifth padno martop nowrap" title="<% $room->name %>">
							<% $room->name %>
							<% $multi_sites ? '<div class="seveneighth tiny nowrap nospace martop">'.$room->site->name."</div>" : ""%>
						</span>

						<span class="padleft twofifth nospace smaller limitheight nooverflow" title="<% $pool_string %>">
							<% $pool_string %>
						</span>

						<span class="eighth centeralign smallish">
							<span class="padno marless full">
								<% $room->quality %>
							</span>
							<span class="nospace">
								<% $room->capacity > 0 ? $room->capacity : ""%>
							</span>
						</span>

						<span class="tenth centeralign">
							<input type="checkbox" class="room" id="<% $room->id %>" name="<% $room->id %>" value="1" checked="checked">
						</span>

					</div>
					</label>

%				}

			</div>

%			if ($pool) { 

				<div class="half smallish">

					<h4><% scalar @rooms %> rooms:</h4>

%					foreach my $room (sort {$a->site->name cmp $b->site->name} @rooms) { 

<%perl>
						next if $room->inactive;
						next if $used{$room->id}++;
						next if $yah && not defined $use_sites{$room->site->id};
						my $pool_string;
						my $not_first;

						foreach my $other ($room->pools) { 
							next if $other->id == $pool_id;
							next unless $other->tourn == $tourn->id;
							$pool_string .= ", " if $not_first++;
							$pool_string .= $other->name;
						}

</%perl>

						<label for="<% $room->id %>">
						<div class="optionblock evenrow martop-half" id="span_<% $room->id %>">

							<span class="twofifth padno martop nowrap">
								<% $room->name %>
								<% $multi_sites ? '<div class="seveneighth tiny nowrap nospace martop">'.$room->site->name."</div>" : ""%>
							</span>

							<span class="padleft twofifth nospace smaller limitheight nooverflow" title="<% $pool_string %>">
								<% $pool_string %>
							</span>

							<span class="eighth centeralign smallish">
								<span class="padno marless full">
									<% $room->quality %>
								</span>
								<span class="nospace">
									<% $room->capacity > 0 ? $room->capacity : ""%>
								</span>
							</span>

							<span class="tenth centeralign">
								<input type="checkbox" class="room" id="<% $room->id %>" name="<% $room->id %>" value="1">
							</span>

						</div>
						</label>
%					}

				</div>
%			}
%		}

	</div>

