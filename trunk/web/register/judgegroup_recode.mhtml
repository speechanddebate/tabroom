<%args>
	$circuit
	$group_id
	$codestart
	$sort_by
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @judges = $group->judges;

	@judges = sort {$a->last cmp $b->last} @judges;

	@judges = sort {$a->school->name cmp $b->school->name} @judges 
		if $sort_by eq "School" || $sort_by eq "Diocese" || $sort_by eq "Region";

	@judges = sort {$a->school->region->code cmp $b->school->region->code} @judges 
		if $sort_by eq "Diocese";

	@judges = sort {length($a->school->region->code) <=> length($b->school->region->code)} @judges 
		if $sort_by eq "Diocese";

	@judges = sort {$a->school->region->code cmp $b->school->region->code} @judges 
		if $sort_by eq "Region";

	@judges = sort {length($a->school->region->code) <=> length($b->school->region->code)} @judges 
		if $sort_by eq "Region";

	if ($sort_by eq "Randomly") { 

	    my $i = scalar(@judges);
	    my $j;
	    foreach my $item (@judges)
	    {	 --$i;
	        $j = int rand ($i+1);
	        next if $i == $j;
	        @judges [$i,$j] = @judges[$j,$i];
 	   }
	}

	if ($judges[0]->prelim_pool) { 
		@judges = sort {$a->prelim_pool->name cmp $b->prelim_pool->name} @judges; 
	}

	my $pool = $judges[0]->prelim_pool;

	foreach my $judge (@judges) { 

		if ($judge->prelim_pool && $pool && $judge->prelim_pool->id != $pool->id) {	
			$pool = $judge->prelim_pool;
			$codestart = 8001 if $pool->name eq "Ex, OO, Dec";
			$codestart = 9501 if $pool->name eq "Sunday Only";
		}

		#Let's attempt for SOME maturity here
		$codestart++ if $codestart == 69;
		$codestart++ if $codestart == 666;

		$judge->code($codestart);
		$codestart++;
		$judge->update;
	}

	my $err = "Codes for ".$group->name." reshuffled by $sort_by";

	$m->redirect("$Tab::url_prefix/register/recode_judges.mhtml?err=$err");

</%init>
