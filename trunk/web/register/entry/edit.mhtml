<%args>
	$tourn
	$entry_id => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$m->abort unless $entry;

	my $event = $entry->event;
	my @students = $entry->students;

	my $no_codes++ if $event->setting("code_style") eq "names";
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	
</%init>

	<& /funclib/editable.mas, class => "code", dest => "code_change.mhtml" &>
	<& /funclib/editable.mas, class => "name", dest => "name_change.mhtml" &>
	
	<& /register/menubar.mas, school => $entry->school, whoami => "students", tourn => $tourn &>

	<h3>Entry in <% $event->name %></h3>

	<table cellpadding="3" width="100%" cellspacing="1">

%		my $switch;
%		my $code_setting = $event->setting("code_style");

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th class="rightalign">
				Entry Name
			</th>

			<td>
				<span class="normal block edit name white" style="display: inline-block;" id="<% $entry->id %>"><% $entry->name %></span>
			</td>

		</tr>

%		unless ($event->setting("no_codes") || $no_codes) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th class="rightalign">
					Entry Code
				</th>

				<td>
					<span class="normal block white edit code" style="display: inline-block;" id="<% $entry->id %>"><% $entry->code %></span>
				</td>

			</tr>

%		}

%		my %entry_students = ();

%		my $tick = 1;

% 		foreach my $student (@students) { 

%			my $hybrid_school;

%			if ($student->chapter && $student->chapter->id != $entry->school->chapter->id) { 
%				$hybrid_school = Tab::School->search( tourn => $tourn->id, chapter => $student->chapter->id)->first;
%			}

%			$entry_students{$student->id}++;

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th class="rightalign">
					Student <% $tick++ %>
				</th>

				<td>

					<span class="medbigspan padno">
						<a class="normal white inline" href="student_edit.mhtml?student_id=<%$student->id%>&entry_id=<% $entry->id %>">
							<% $student->first." ".$student->last %>
						</a>
					</span>

					<% $student->novice ? '<span class="hundo rightalign smallish">(Novice)</span>' : "" %>

%					if ($hybrid_school) { 
						<a class="right white inline medbigspan smaller" href="/register/school/entries.mhtml?school_id=<%$hybrid_school->id%>&event_id=<% $event->id %>">
						(Hybrid from: <% $hybrid_school->name %>)
						</a>
%					}

				</td>

			</tr>

%		}


%		if ($event->setting("ask_for_titles")) {

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th class="rightalign">
					Piece Title
				</th>
	
				<td class="padmore">
					<% $entry->title %>
				</td>

			</tr>

%		}


% 	if ($tourn->setting("ncfl")) { 

		<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

			<th>
				Diocese:
			</th>

			<td colspan="2">
				<a class="white normal block" href="/register/diocese/entry.mhtml?diocese_id=<% $entry->school->region->id %>">
					<% $entry->school->region->name ." (".$entry->school->region->code .")" %>
				</a>
			</td>

		</tr>

% 	}


% 		if ($entry->ada) { 
			<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\"" %>>
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%		}

			<th class="rightalign">
				ADA Accomodations
			</th>

			<td>
				<a class="white normal block" href="ada_switch.mhtml?entry_id=<% $entry->id %>"><% ($entry->ada) ? "Yes" : "No" %></a>
			</td>
	
		</tr>

% 		if ($event->setting("apda")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th class="rightalign">
					<form action="seed_save.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry->id %>">
					APDA Seed
				</th>

				<td class="padmore">	
					<select name="seed" onchange='this.form.submit()' class="fixedsmall"> 
						<option value="">None</option>
						<option value="half" <% $entry->seed eq "half" ? "selected" : "" %>>Half</option>
						<option value="full" <% $entry->seed eq "full" ? "selected" : "" %>>Full</option>
						<option value="free" <% $entry->seed eq "free" ? "selected" : "" %>>Free</option>
					</select>

					<noscript>
						<input type="submit" class="thin" value="Save">
					</noscript>
					</form>
				</td>
			</tr>

% 		} elsif ($event->setting("pair_seeds")) { 

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th class="rightalign">
					<form action="seed_save.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry->id %>">
					Prelim Seed
				</th>

				<td class="padmore">	
					<span class="hundo">
						<input type="text" name="seed" size="10" value="<% $entry->pair_seed %>">
					</span>

					<span class="medbigspan rightalign">
						<input type="submit" class="thin" value="Save Seed">
						</form>
					</span>

				</td>

			</tr>

% 		} 

	</table>

% 	if ($entry && $tourn->setting("ask_quals")) {

		<h4 style="margin-top: 10px;">Qualifying Information:</h4>

		<table cellpadding="5" width="100%" cellspacing="1">

			<tr class="yellowrow">

				<th class="smaller">
					<form action="qual_save.mhtml" method="post">
					<input type="hidden" name="entry_id" value="<% $entry->id %>">
				</th>

				<th class="smaller">
					Tournament
				</th>

				<th class="smaller">
					Placement/Points
				</th>

			</tr>

%			my $tick = 1;

%			foreach my $qual ($entry->qualifiers) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th>
						Qual <% $tick++ %>.
					</th>

					<td>
						<input type="text" size="20" name="qual_<% $qual->id %>_name" value="<% $qual->name %>">
					</td>

					<td>
						<input type="text" size="20" name="qual_<% $qual->id %>_result" value="<% $qual->result %>">
					</td>

				</tr>

% 			}

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<th>
					Add Qual:
				</th>

				<td>
					<input type="text" size="20" name="qual_new_name">
				</td>

				<td>
					<input type="text" size="20" name="qual_new_result">
				</td>

			</tr>

% 			if ($entry && $tourn->setting("ask_quals")) {

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<th>	
						<label for="atlarge">
							At-Large
						</label>
					</th>

					<td colspan="2" class="leftalign">
						<input id="atlarge" type="checkbox" name="atlarge" value="1"  <% $entry->seed eq "atlarge" ? 'checked="checked"' : "" %>>
					</td>

				</tr>
% 			}

			<tr class="liblrow">

				<td colspan="3" class="rightalign">
					<input type="submit" value="Save Qualifiers">
					</form>
				</td>

			</tr>
	
		</table>

% 	}

%   if ($tourn->setting("housing")) {

<%perl>

		my $start = $tourn->start;
		my $end = $tourn->end;

		$start->set_time_zone($tz);
		$end->set_time_zone($tz);
		$end->truncate(to   => 'day');
		$start->truncate(to => 'day');

		my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
		my $day_before = $days[0]->clone;
		$day_before->subtract( days => 1);
		push (@days, $day_before);

</%perl>

		<h4>Housing</h4>

		<form action="housing_save.mhtml" method="post">
		<input type="hidden" name="entry_id" value="<% $entry->id %>">

%		foreach my $student (@students) { 

			<div class="half left" style="margin-left: 5px;">
		
			<table width="100%" cellpadding="3" cellspacing="1">

				<tr class="yellowrow">

					<td class="nowrap smallish">
						<% $student->first." ".$student->last %>
					</td> 
					
					<td colspan="2" class="centeralign">
						Gender

						M <input type="radio" class="padno" name="gender_<%$student->id%>" value="M" <% ($student->gender eq "M") ? "checked" : "" %> >
						F <input type="radio" class="padno" name="gender_<%$student->id%>" value="F" <% ($student->gender eq "F") ? "checked" : "" %> >
					</td> 
					
				</tr>

%				undef ($switch);

%				foreach my $day (@days) { 

%					next unless Tab::HousingSlots->search( night => $day );
%					my $housing = $m->comp("/funclib/student_housing.mas", student => $student, tourn => $tourn, day=> $day);

					<tr <% ($switch++ % 2) ? "class=\"lteven\"" : "class=\"ltodd\"" %>>	

						<td class="rightalign">
							<% Tab::niceshortdayte($day) %>
						</td>

						<td class="centeralign smallish padless">

							<span class="tinyspan" style="min-height: 24px; font-size: 100%; padding-top: 5px;">
								<label for="request_<% $student->id."_".$day->ymd %>">
									Req:
								</label>
							</span>

							<span class="padno tinyspan" style="vertical-align: middle;">
								<input 	type="checkbox" name="request_<% $student->id."_".$day->ymd %>" value="1" <% ($housing) ? "checked" : "" %> 
									id="request_<% $student->id."_".$day->ymd %>" >
							</span>

						</td>	

						<td class="centeralign padless">
							<span class="smallerspan" style="min-height: 20px; font-size: 90%; padding-top: 6px; float: left;">
								<label for="waitlist_<% $student->id."_".$day->ymd %>">	
									Waitlist:
								</label>
							</span>
							<span class="padno tinyspan" style="vertical-align: middle;">
								<input 	type="checkbox" name="waitlist_<% $student->id."_".$day->ymd %>" 
									id="waitlist_<% $student->id."_".$day->ymd %>" value="1" <% ($housing && $housing->waitlist) ? "checked" : "" %> >
							</span>
						</td>
					</tr>

%   			}
	
			</table>

			</div>

%		} 

		<br style="clear: both;">

		<span class="blue block rightalign">
    	   	<input class="thin" type="submit" value="Save Housing Details">
   			</form>
		</span>

%	} # end of if housing.



%	my @rounds = sort { $a->name <=> $b->name } $event->rounds;

%	if (@rounds) { 

		<h4>Rounds:</h4>

		<table cellpadding="5" width="100%" cellspacing="1"> 

			<tr class="yellowrow">
	
				<th class="smaller">
					Rnd
				</td>
		
				<th class="smaller">
					Start
				</th>

%				if ($event->type eq "wudc" || $event->type eq "speech") { 
					<th class="smaller">
						Speaks
					</th>
%				}

%				if ($event->type eq "debate" || $event->type eq "policy"  || $event->type eq "ld"  || $event->type eq "pf") { 
				
					<th class="smaller">
						Vs.
					</th>

					<th class="smaller">
						S
					</th>
%				}
		
				<th class="smaller">
					Room
				</th>
		
				<th class="smaller">
					Judging
				</th>
		
				<th class="smaller">
					Result
				</th>
		
				<th class="smaller">
				</th>
		
			</tr>
		
% 			foreach my $round (@rounds) { 

%				my @panels = $m->comp("/funclib/entry_panels.mas", round => $round, entry => $entry);
%				my $panel = shift @panels;

%				if ($panel) {
		
%					my @all_ballots = Tab::Ballot->search( panel => $panel->id ); 
%					my @ballots;

%					my $opp;
%					my $side;

%					foreach my $ballot (@all_ballots) {
%						if ($ballot->entry->id == $entry->id) { 
%							push @ballots, $ballot;
%							$side = $ballot->side 
%						} else { 
%							$opp = $ballot->entry;
%						} 
%					}

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td class="smallish centeralign">
							<% $round->name %>
						</td>

						<td class="smallish">
							<% &Tab::nicetime($panel->round->timeslot->start->set_time_zone($tz)) %>
						</td>

%						if ($event->type eq "wudc" || $event->type eq "speech") { 
							<td class="smallish centeralign">
								<% Lingua::EN::Numbers::Ordinate::ordinate($m->comp("/funclib/entry_speakerorder.mas", entry => $entry, panel => $panel)) %> 
							</td>
%						}

%						if ($event->type eq "debate" || $event->type eq "policy"  || $event->type eq "ld"  || $event->type eq "pf") { 

							<td class="smallish">
								<a class="plain block" href="edit.mhtml?entry_id=<% $opp->id %>">
									<% $opp->code %>
								</a>
							</td>

							<td class="smallish centeralign">
%								if ($panel->bye) { 
									B
%								} elsif ($event->type ne "pf") { 
									<% $side == 1 ? "A" : "N" %>
%								} else { 
									<% $side == 1 ? "P" : "C" %>
%								}
	
							</td>
%						}

						<td class="smallish">
							<a class="white block" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
								<% ($panel->room->id) ? $panel->room->name : "No Room" %>
							</a>
						</td>

						<td class="smallish">

%		 					if ($panel->bye) { 
								<a class="hundo white block nowrap" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
									BYE
								</a>
%							} else {
%			 					foreach my $judge (sort {$a->ballotid <=> $b->ballotid} $m->comp("/funclib/panel_judges.mas", panel => $panel)) { 	
									<a class="<% $judge->chair ? "bold" : "" %> hundo white padless fullblock nowrap" href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>">
										<% $judge->judge_group->setting('no_codes') ? $judge->last : $judge->code." ".$judge->last %><% $judge->chair ? "*" : "" %>
										<% $judge->ballotid %>
									</a>
% 								}	
% 							}	

						</td>

						<td class="smallish" align="center">

%							if ($event->type eq "speech") { 

% 								foreach my $ballot (sort {$a->judge->last cmp $b->judge->last} @ballots) { 

									<div class="block padless">

%									my @values = $ballot->values;

%									foreach my $value (@values) { 
%										if ($value->tag eq "rank") { 
											<% $value->value %>
%										} 
%									} 

%									foreach my $value (@values) { 
%										if ($value->tag eq "points") { 
											<% $value->value %>
%	 									} 
% 									} 

									</div>

% 								} 

% 							} else { 

% 								foreach my $ballot (@ballots) { 

									<div class="block padno oneeighty">

%									my @values = $ballot->values;

%									if ($event->type eq "wudc") { 
%										foreach my $value (@values) { 
%											if ($value->tag eq "rank") { 
												<span class="microspan padless">
													<% Lingua::EN::Numbers::Ordinate::ordinate($value->value) %>
												</span>
%											}
%										}

%									} else { 

%										foreach my $value (@values) { 
%											if ( $value->tag eq "ballot") { 
												<span class="microspan padless">
													<% $value->value ? "W" : "L" %>
												</span>
%											}
%										}
%									}

%									foreach my $student (@students) { 

%										my $yo;
										<span class="schemat nowrap padless">


%										foreach my $value (@values) { 
%											next unless $value->student && $value->student->id == $student->id;
%											if ($value->tag eq "points") { 
												<% $value->value %>
%												$yo++;
%											} 
%										} 

%										foreach my $value (@values) { 
%											next unless $value->student && $value->student->id == $student->id;
%											if ($value->tag eq "rank") { 
												- <% $value->value %>
%												$yo++;
%											} 
%										} 
										
										<% $yo ? substr($student->first,0,1).substr($student->last,0,1) : "" %>

										</span>
% 									} 

									</div>

% 								} 
% 							} 

						</td> 
						
						<td class="smallish" align="center">
							<a class="dkgreen fullblock" href="/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">
								Move
							</a>
						</td>

					</tr>
	
% 				} else { 
							
					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

						<td class="smallish centeralign">
							<% $round->name %>
						</td>
						
						<td colspan="5" class="smallish">
							Not scheduled in <% ($round->label) ? $round->label : "Round ".$round->name %>
						</td>

						<td class="smallish centeralign" colspan="2">
							<a class="dkgreen fullblock" href="/panel/manipulate/entry_edit.mhtml?entry_id=<% $entry->id %>&round_id=<% $round->id %>">
								Add
							</a>
						</td>
					</tr>
% 				}

% 			} 

		</table>
%	} 

%		$switch = 1;

	</div>

	<div class="right small">

		<div class="sidenote" style="padding-top: 30px;">

% 			if ($entry->dq == 1) { 

				<a class="dkred block">
					DISQUALIFIED 
				</a>
				<br />
						
%			} 

% 			if ($entry->dropped) { 

				<a class="dkred block">
					DROPPED 

%					if ($entry->drop_time) { 
						on <% &Tab::niceshortdt($entry->drop_time->set_time_zone($tz)) %>
%					}
				</a>
				<br />

%			} 


			<a class="blue block" href="/register/school/entries.mhtml?school_id=<% $entry->school->id %>&event_id=<% $event->id %>">
				School entry in <% $event->abbr %>
			</a>

			<a class="blue block" href="/register/event/roster.mhtml?event_id=<% $event->id %>&sort=school">
				<% $event->abbr %> full roster
			</a>

%			if ($event->judge_group->setting("prefs")) { 
				<a class="martop blue block" href="/register/entry/prefs.mhtml?entry_id=<% $entry->id %>&sort=school">
					<% $entry->code %> Pref Sheet
				</a>
%			}

		<h4>Print</h4>

			<a class="blue block nowrap" href="print.mhtml?entry_id=<% $entry->id %>">
				Print <% $entry->code %> Info Sheet
			</a>

%		if ($tourn->setting("ncfl")) { 
			<a class="blue block" href="card_print.mhtml?entry_id=<% $entry->id %>">
				Print <% $entry->code %> Card
			</a>
%		}

%		foreach my $student (@students) { 

			<a class="blue block nowrap" href="student_print.mhtml?student_id=<% $student->id %>">
				Student <% $student->first." ".$student->last %> Info Sheet
			</a>
%		}


% 		if ( $event->setting("waitlist") || $event->setting("waitlist_all") ) { 
		
			<h4>Entry Status</h4>

%			if ($entry->waitlist) { 

				<a class="dkred block">
					Waitlisted
				</a>

%				my $warnno = "This will admit the entry off the waitlist.  It will NOT notify the coaches.";
%				my $warnyep = "This will admit the entry off the waitlist.  It will notify coaches by email.";

				<a class="blue block" <& "/funclib/confirm.mas", warn => $warnno &> href="unwaitlist.mhtml?entry_id=<% $entry->id %>">Admit off waitlist</a>
				<a class="blue block" <& "/funclib/confirm.mas", warn => $warnyep &> href="unwaitlist.mhtml?notify=yessir&entry_id=<% $entry->id %>">Admit & notify coaches</a>

%			} else { 
				<a class="yellow block" href="waitlist.mhtml?entry_id=<% $entry->id %>">Place on waitlist</a>
%			}

%		}

		<h4>Wreak Havoc</h4>

%		if ($entry->dropped) { 

			<a class="dkgreen block" href="undrop.mhtml?entry_id=<% $entry->id %>">
				Un-Drop
			</a>

			<a class="dkred block" href="delete.mhtml?entry_id=<% $entry->id %>">
				Completely Delete
			</a>

%		} else { 

			<a class="yellow block" href="drop.mhtml?entry_id=<% $entry->id %>">Drop</a>
%		}

%		if ($entry->dq) { 

			<a class="dkred block" href="undq.mhtml?entry_id=<% $entry->id %>">Un-Disqualify</a>
			
%		} else { 

%			my $warn = "You are about to disqualify this entry.  In IEs, other entries in the same section as this one will be promoted one rank if they scored below this entry in all rounds.  In debate no results changes will be made.  You can undo this if you change your mind.";

			<a class="yellow block" <& "/funclib/confirm.mas", warn => $warn &>  href="dq.mhtml?entry_id=<% $entry->id %>">Disqualify</a>
%		}

			<a class="yellow block" href="/tabbing/entry/card.mhtml?entry_id=<% $entry->id %>">View/Change Results</a>

		</div>

		<div class="sidenote">

			<h4>Swap Students</h4>

			<form action="change.mhtml" method="post">
			<input type="hidden" name="entry_id" value="<% $entry_id %>">
			<input type="hidden" name="school_id" value="<% $entry->school->id %>">

<%perl>
			 my @clean_students = $m->comp("/funclib/students_evententer.mas",
				tourn => $tourn,
				event => $event,
				school => $entry->school
			);

			my $count = 1;

</%perl>

%			foreach my $student (@students) { 

				<div class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block">
		
					<span class="onespan">
						<% $count++ %>
					</span>
			
					<span class="onesixty padno">
						<select name="<% $student->id %>" onchange='this.form.submit()'>

	    					<option value="<%	$student->id %>">
								<% substr($student->last.", ".$student->first,0,15) %>
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @clean_students) {

% 			  					next if $entry_students{$other_student->id};
	
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,15) %>
								</option>
	
%							}

						</select> 
					</span> 

				</div>

%			} 

%			if ( scalar @students < $event->setting("max_entry") ) { 

				<div class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> block">

					<span class="microspan">
						<% $count++ %>:
					</span>
			
					<span class="medspan">
						<select name="new" onchange='this.form.submit()'>
							<option value="">
								Add student
							</option>

%							foreach my $other_student (sort { ucfirst($a->last) cmp ucfirst($b->last)} @clean_students) {
% 		  						next if $entry_students{$other_student->id};
    							<option value="<% $other_student->id %>">
									<% substr($other_student->last.", ".$other_student->first,0,15) %>
								</option>

%							}
						</select> 
					</span> 
				</div>

%			}

			<noscript>
				<div class="liblrow rightalign">
					<input type="submit" class="thin" value="  Save Changes  ">
				</div>
			</noscript>

			</form>

%			if ($tourn->setting("ncfl")) { 

				<h4>School</h4>

				<form action="school.mhtml" method="post">
				<input type="hidden" name="entry_id" value="<% $entry->id %>">

				<div class="block <% ($switch++ % 2) ? "oddrow" : "evenrow" %> rightalign">
					<select name="school_id" class="fixedsmall" onchange='this.form.submit()'>
%						foreach my $school (sort {$a->name cmp $b->name} Tab::School->search( region => $entry->school->region, tourn => $tourn->id)) { 
							<option value="<% $school->id %>" <% $school->id == $entry->school->id ? "selected" : "" %>>
								<% substr($school->name,0,32) %>
							</option>
%						}

					</select>
				</div>

				<noscript>
					<div class="liblrow rightalign">
						<input type="submit" class="thin" value="  Save Changes  ">
					</div>
				</noscript>

%			}

		</div>

	</div>

	<br style="clear: both;" />
