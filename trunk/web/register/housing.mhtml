<%args>
	$tourn
	$circuit
	$debug => undef
	$sort_by => undef
</%args>
<%init>

</%init>

<table>

<tr>
	<td width="100%">
	<h3>Housing requests for <% $tourn->name %></h3>
	</td>
	
	<td>
		<form action="housing_print.mhtml" method="post">
		<input type="submit" value="Printout">
		</form>
	</td>

	<td>
		<form action="housing_csv.mhtml" method="post">
		<input type="submit" value="Export to Excel">
		</form>
	</td>

</tr>
</table>

<table>
	<tr>
		<td width="25%">Sort By:</td>
		<td>
			<form action="housing.mhtml" method="post">
				<select name="sort_by">
				<option value="date">Date Requested</option>
				<option value="name" <% ($sort_by eq "name") ? "selected" : "" %>>Last Name</option>
				<option value="school" <% ($sort_by eq "school") ? "selected" : "" %>>School Name</option>
				<option value="waitlist" <% ($sort_by eq "waitlist") ? "selected" : "" %>>Waitlist Status</option>
		</td>

		<td>
			<input type="submit" value="Sort">
			</form>
		</td>
	</tr
</table>

<%perl> 

	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $day_before = $days[0]->clone;
	$day_before->subtract( days => 1);
	push (@days, $day_before);

	my @schools = $tourn->schools;
	my %schools_by_chapter = ();

	foreach my $sch (@schools) {
		$schools_by_chapter{$sch->chapter->id} = $sch;
	}

	foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

	my @housing = Tab::HousingSlots->search( night => $day->ymd, tournament => $tourn->id );
	next unless @housing;

	my $total_granted = 0;
	my $total_waitlisted = 0;

	my @reqs = Tab::Housing->search( night => $day->ymd, tournament => $tourn->id );

	foreach my $req (@reqs) { 

		$total_granted++ unless $req->waitlist;
		$total_waitlisted++ if $req->waitlist;

		$req->name($req->student->last) if $req->type eq "student";
		$req->name($req->judge->last) if $req->type eq "judge";

		$req->school($schools_by_chapter{$req->student->chapter->id}) if $req->type eq "student" && $req->student && $req->student->chapter;
		$req->school($req->judge->school) if $req->type eq "judge";
	}


</%perl>

	<h4 style="padding-top: 7px;"><% $day->day_abbr." ".$day->month_name." ".$day->day %></h4>

		<table cellpadding="5" cellspacing="1" border="0" width="100%">

			<tr>
				<td colspan="2" align="center">
					<% $housing[0]->slots %> slots available 
				</td>

				<td colspan="2" align="center">
					<% $total_granted %> Housed
				</td>

				<td colspan="2" align="center">
					<% $total_waitlisted %> Waitlisted
				</td>

			</tr>

			<tr class="liblrow">
%				if ($debug) { 
					<th>
						ID
					</th>
%				}

				<th>
					Name
				</th>
					
				<th>
					Type
				</th>
					
				<th>
					Event
				</th>
						
				<th>
					School
				</th>
					
				<th>
					Requested On
				</th>
					
				<th>
					G
				</th>
					
				<th>
					WL
				</th>
					
				<th colspan="2">
					Actions
				</td>

			</tr>
					
<%perl>

	@reqs = sort {$a->requested->epoch <=> $b->requested->epoch} @reqs;

	@reqs = sort {$a->name cmp $b->name} @reqs if $sort_by eq "name";

	@reqs = sort {$a->school->name cmp $b->school->name} @reqs if $sort_by eq "school";

	@reqs = sort {$b->waitlist <=> $a->waitlist} @reqs if $sort_by eq "waitlist";

	my $switch; 

	REQ:
	foreach my $request (@reqs) { 

	my @entries; 

		if ($request->type eq "student") { 
			@entries = $request->student->entries($tourn);
			unless ($request->student->chapter && @entries) { 
				$request->delete;
				next REQ;
			}
		}

</%perl>

		<a name="<% $request->id %>">

%		if ($request->waitlist) { 
			<tr class="redrow">
%		} else { 
			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\""%> >
%		}

%		if ($debug) { 
			<td><% $request->id %></td>
%		}

%		if ($request->type eq "student") { 

			<th>
				<a href="<% $Tab::url_prefix %>/register/student_edit.mhtml?student_id=<% $request->student->id %>">
				<% $request->student->last.", ".$request->student->first %></a>
			</th>

			<td class="smaller">
				Entry
			</td>

			<td class="smaller" align="center">
%				foreach my $entry (@entries) { 
					<a href="<% $Tab::url_prefix %>/register/entry/edit.mhtml?entry_id=<% $entry->id%>"><% $entry->event->abbr %><% ($entry->waitlist) ? "-WL" : "" %></a>
%				}
			</td>

			<td class="smaller">
				<a href="/register/registration.mhtml?school_id=<% $request->school->id %>">
				<% $request->school->name %>
				</a>
			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($circuit->timezone)) %>
			</td>

			<td align="center"><% $request->student->gender %></td>

			<td align="center">

%			if ($request->waitlist) { 
				Y </td><td class="smaller" align="center"> 
				(<a href="<% $Tab::url_prefix %>/register/housing-unwl.mhtml?req_id=<% $request->id %>">Un-waitlist</a>)
%			} else { 
			   	N </td><td align="center">
				(<a href="<% $Tab::url_prefix %>/register/housing-wl.mhtml?req_id=<% $request->id %>">Waitlist</a>)
%			}	

			</td>

			<td>
				(<a href="<% $Tab::url_prefix %>/register/housing-rm.mhtml?sort_by=<% $sort_by %>&req_id=<% $request->id %>">Remove</a>)
			</td>

%		} 

%		if ($request->judge) { 

%			unless ($request->judge->judge_group) { 
%				$request->delete;
%				next REQ;
%			}

			<th>
				<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $request->judge->id %>">
				<% $request->judge->last.", ".$request->judge->first %>
				</a>
			</th>

			<td class="smaller">
				Judge
			</td>

			<td align="center" class="smaller">
				<a href="<% $Tab::url_prefix %>/register/judge_edit.mhtml?judge_id=<% $request->judge->id %>"><% $request->judge->judge_group->abbr %></a>
			</td>

			<td class="smaller">
				<a href="/register/registration.mhtml?school_id=<% $request->school->id %>">
					<% $request->school->name %>
				</a>
			</td>

			<td class="smaller">
				<% &Tab::niceshortdt($request->requested->set_time_zone($circuit->timezone)) %>
			</td>

			<td align="center">
				<% $request->judge->gender %>
			</td>

			<td align="center">
%				if ($request->waitlist) { 

					Y </td>

					<td class="smaller" align="center"> 
						(<a href="<% $Tab::url_prefix %>/register/housing-unwl.mhtml?req_id=<% $request->id %>">Un-waitlist</a>)

%				} else { 
					N </td>
					<td align="center">
						(<a href="<% $Tab::url_prefix %>/register/housing-wl.mhtml?req_id=<% $request->id %>">Waitlist</a>)
%				}	

				</td>

			<td>
				(<a href="<% $Tab::url_prefix %>/register/housing-rm.mhtml?sort_by=<% $sort_by %>&req_id=<% $request->id %>">Remove</a>)
			</td>

%			}

		</tr>
		
%	}

</table>

%	} #end of foreach my $day

