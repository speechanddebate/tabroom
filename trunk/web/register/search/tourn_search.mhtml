<%args>
	$tourn
	$search
	$caller => undef
</%args>
<%init>

	unless ($search) { 
		my $msg = "You didn't type in a value to search for.  That might be a good idea.";
		$m->redirect($caller."?msg=$msg");
	}

	my @entries;

	my @judges;
	
	my ($first, $last) = split (/\ /, $search);

	if ($first && $last) { 
	
		# Student school name plus space
		my @schools = Tab::School->search_where(
			name => { 'like', "%".$first."%" }
		);

		foreach my $school (@schools) { 
			push (@entries, Tab::Entry->search(	code => $last, school => $school->id ));
		}

		# Entry by two names
		Tab::Entry->set_sql( by_two_names_and_tourn => "
			select distinct entry.*
			from entry,school,entry_student,student
			where entry.id = entry_student.entry
			and entry_student.student = student.id
			and student.first like ?
			and student.last like ?
			and entry.school = school.id
			and school.tourn = ?
			order by student.last
		");

		push (@entries, Tab::Entry->search_by_two_names_and_tourn($first."%", $last."%", $tourn->id));
	
		# Judge by two names
		Tab::Judge->set_sql( by_two_names_and_tourn => "
			select distinct judge.*
			from judge, school
			where judge.first like ?
			and judge.last like ?
			and judge.school = school.id
			and school.tourn = ? 
			order by judge.last
		");

		push (@judges, Tab::Judge->search_by_two_names_and_tourn($first."%", $last."%", $tourn->id));

	} else { 

		#Student last name only
		Tab::Entry->set_sql( by_name_and_tourn => "
			select distinct entry.*
			from entry,school,entry_student,student
			where entry.id = entry_student.entry
			and entry_student.student = student.id
			and student.last like ?
			and entry.school = school.id
			and school.tourn = ?
			order by student.last
		");

		push (@entries, Tab::Entry->search_by_name_and_tourn($search."%", $tourn->id));
	
		#Judge last name only
		Tab::Judge->set_sql( by_name_and_tourn => "
			select distinct judge.*
			from judge, school
			where judge.last like ?
			and judge.school = school.id
			and school.tourn = ? 
			order by judge.last
		");

		push (@judges, Tab::Judge->search_by_name_and_tourn($search."%", $tourn->id));

	}

	Tab::Judge->set_sql( by_code_and_tourn => "
		select distinct judge.*
		from judge, school
		where judge.code = ?
		and judge.school = school.id
		and school.tourn = ?
		order by judge.code
	");

	push (@judges, Tab::Judge->search_by_code_and_tourn($search, $tourn->id));

	Tab::Entry->set_sql( by_code_and_tourn => "
		select distinct entry.*
		from entry, school
		where entry.code = ?
		and entry.school = school.id
		and school.tourn = ?
		order by entry.code
	");

	push (@entries, Tab::Entry->search_by_code_and_tourn($search, $tourn->id));

	unless (@entries || @judges) { 
		my $msg = "No values found for $search.  Please try again";
		$m->redirect($caller."?msg=$msg");
	}

	if (@entries &! @judges) { 
		if (scalar @entries == 1) { 
			$m->redirect("/register/entry/edit.mhtml?entry_id=".$entries[0]->id);
		}
	}
	
	if (@judges &! @entries) { 
		if (scalar @judges == 1) { 
			$m->redirect("/register/judge/edit.mhtml?judge_id=".$judges[0]->id);
		}
	}

</%init>

	<h2>Search results:</h2>

