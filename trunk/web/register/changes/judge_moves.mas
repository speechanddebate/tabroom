<%args>
	$tourn
	$what => undef
</%args>
<%init>

	my @moved_judges = Tab::TournChange->search( tourn => $tourn->id, type => "judge", {order_by => 'timestamp'}); 

	my %sortpanels = ();
	
	foreach my $mj (@moved_judges) { 
		$sortpanels{$mj->id} = $mj->old_panel if $mj->old_panel;
		$sortpanels{$mj->id} = $mj->new_panel if $mj->new_panel;
	}


	@moved_judges = sort {eval{$a->new_panel->id} <=> eval{$b->new_panel->id}} @moved_judges;

#	@moved_judges = sort {$sortpanels{$a->id}->event->abbr cmp $sortpanels{$b->id}->event->abbr} @moved_judges;

	@moved_judges = sort {$sortpanels{$a->id}->letter cmp $sortpanels{$b->id}->letter} @moved_judges;

#	@moved_judges = sort {$sortpanels{$a->id}->round->name cmp $sortpanels{$b->id}->round->name} @moved_judges;

	@moved_judges = sort {$b->timestamp->epoch <=> $a->timestamp->epoch} @moved_judges;

	my $switch;

</%init>

	<h2>Judges Moved</h2>

	<table cellpadding="4" cellspacing="1" width="99%"> 
		
		<tr class="yellowrow"> 

			<th class="smaller">
				Judge
			</th>
					
			<th class="smaller">
				Name
			</th>
					
			<th>
			</th>
					
			<th class="smaller">
				Event
			</th>
				
			<th class="smaller">
				Round
			</th>
					
			<th class="smaller">
				Room
			</th>
					
			<th class="smaller">
				Fine
			</th>
					
			<th colspan="2" class="smaller">
				When
			</th>
					
			<th>
			</th>
					
		</tr>

%			foreach my $move (@moved_judges) { 

%				next unless $move->judge->id;
%				my $timestamp = $move->timestamp;
%  				$timestamp->set_time_zone($tourn->tz); 
				

%				if ($move->new_panel) { 

					<tr class="<% ($switch++ % 2) ? "evenrow" : "oddrow" %>">

						<th style="text-align: center;" class="smaller">

%							if ($move->judge) { 
								<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $move->judge->id %>">
									<% $move->judge->code %>
								</a>
%							} 

						</th>

						<td class="smaller">
%							if ($move->judge) { 
								<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $move->judge->id %>">
									<% $move->judge->first." <br /> ".$move->judge->last %>
								</a>
%							}
						</td>

						<th class="smaller">
							Add:
						</th> 
						
						<td align="center" class="smaller">
							<% ($move->new_panel->round) ? $move->new_panel->round->event->abbr : "" %>
						</td>

						<td align="center" class="smaller">
							<% ($move->new_panel->round) ? $move->new_panel->round->name : "" %>
						</td>


						<td align="center" class="smaller">
							<% ($move->new_panel->room) ? $move->new_panel->room->name : "" %>
						</td> 
						
						<td> 
						</td>

%				} elsif ($move->old_panel) { 

					<tr class="<% ($switch++ % 2) ? "evenrow" : "oddrow" %>">

%						if ($move->judge->id) { 

							<th style="text-align: center;" class="smaller">
								<a class="white block" href="/register/judge_edit.mhtml?judge_id=<% $move->judge->id %>"><% $move->judge->code %></a>
							</th>

							<td class="smaller">
								<a class="white block" href="/register/judge/edit.mhtml?judge_id=<% $move->judge->id %>">
									<% $move->judge->first." <br /> ".$move->judge->last %>
								</a>
							</td>

							<th class="smaller">
								Remove
							</th> 

%						} else { 
						
							<th class="smaller">
								Del:	
							</th> 
							
							<td colspan="2" class="smaller">
								<% $move->text %>
							</td> 

%						}
							
						<td align="center" class="smaller">
							<% ($move->old_panel->round) ? $move->old_panel->round->event->abbr : "" %>
						</td> 
							
						<td align="center" class="smaller">
							<% ($move->old_panel->round) ?  $move->old_panel->round->name : "" %>
						</td> 
							
						<td align="center" class="smaller">
							<% ($move->old_panel->room) ? $move->old_panel->room->name : "" %>
						</td> 
							
						<td align="center" class="smaller">
							<% ($move->fine) ? $move->fine->amount : "" %>
						</td>
%					}

   					 <td colspan="2" class="smaller">
%   					if ($timestamp) {
							<% &Tab::niceshortdt($timestamp->set_time_zone($tourn->tz)) %>
%   					}
					</td> 
						
					<th class="smaller">
						<a class="dkred block" href="change_rm.mhtml?change_id=<% $move->id %>&what=<% $what %>">Delete</a>
					</td>
					
				</tr>

%			}

			</table>

