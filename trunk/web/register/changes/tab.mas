<%args>
	$tourn
	$account
	$start
	$end
	$what => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	Tab::TournChange->set_sql( moves_by_date => "
		select distinct tourn_change.*
		from tourn_change
		where tourn = ?
		and type = \"tabbing\"
		and timestamp > ?
		and timestamp < ? 
		order by timestamp DESC");

	my $search_end = $end->clone->set_time_zone($tz);
	my $search_start = $start->clone->set_time_zone($tz);

	my @tabs = Tab::TournChange->search_moves_by_date($tourn->id, DateTime::Format::MySQL->format_datetime($search_start), DateTime::Format::MySQL->format_datetime($search_end));

	my $switch; 

</%init>

	<h2>WHO MESSED WITH MY TOURNAMENT?</h2>

	<& /funclib/tablesorter.mas, table => "sortme" &>
	
	<table cellpadding="5" cellspacing="1" width="100%" id="sortme">  

		<thead>
	
		<tr class="yellowrow">
			
			<th class="smaller">
				Who
			</th>

			<th class="smaller">
				What
			</th>
				
			<th class="smaller">
				When
			</th>

			<th class="smaller">
				Detail
			</th>

%			if ($account->site_admin) { 
				<th>
				</th>
%			}

		</tr>
		</thead>

		<tbody>

% 		foreach my $tab (@tabs) { 

%			my $tz_obj = DateTime::TimeZone->new( name => $tz );
%			my $happened = $tab->timestamp->set_time_zone($tz_obj);

			<tr>

				<td>
					<% $tab->id %>
				</td>

				<td class="smallish">
					<% $tab->account->first." ".$tab->account->last %> <br />
					<% $tab->account->email %>
				</td>

				<td class="smallish centeralign">
					<% $tab->event ? $tab->event->abbr : "Tourn-wide" %>
				</th>
				
				<td class="smallish centeralign">
					<% &Tab::niceshortdt($happened) %>
					<% $happened->time_zone->name %>
				</td> 

				<td class="smallish" style="width: 300px;">
					<% $tab->text %>
				</td> 
			
%				if ($account->site_admin) { 
					<th style="text-align: center" class="smaller">
						<a class="dkred block" href="change_rm.mhtml?what=<% $what %>&change_id=<% $tab->id %>">Del</a>
					</td> 
%				}
				
			</tr>

%		}

		</tbody>

	</table>
