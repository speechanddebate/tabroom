<%args>
	$event_id
	$tourn
	$sort => undef
	$drops => undef
	$waitlist => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);

	$m->abort unless $event;

	my @clear = Tab::Entry->search( event => $event->id, unconfirmed => 0, dropped => 0, waitlist => 0 );
	my @dropped = Tab::Entry->search( event => $event->id, unconfirmed => 0, dropped => 1 );
	my @waitlisted = Tab::Entry->search( event => $event->id, unconfirmed => 0, dropped => 0, waitlist => 1 );

	my $total = (scalar @clear) + (scalar @dropped) + (scalar @waitlisted);

	my @entries = @clear;
	@entries = @dropped if $drops;
	@entries = @waitlisted if $waitlist;

	my $namestring = "Entries";
	$namestring = "Drops" if $drops;
	$namestring = "Waitlist" if $waitlist;

	@entries = sort {$a->reg_time cmp $b->reg_time} @entries;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $no_codes++ if $event->setting("code_style") eq "names";

</%init>

	<& event_menu.mas, tourn => $tourn, event => $event, drops => $drops, waitlist => $waitlist &>

	<div class="block bigger">
		<span class="bigspan">
			<h4><% $event->name." ".$namestring %></h4>
		</span>
		<span class="biggishspan smaller rightalign" style="padding-top: 9px;">
			<span class="smallerspan">
				In: <% scalar @clear %>
			</span>
			<span class="smallishspan">
				Drops: <% scalar @dropped %>
			</span>
			<span class="evensmallerspan">
				WL: <% scalar @waitlisted %>
			</span>
			<span class="smallerspan">
				All: <% $total %>
			</span>
		</span>
	</div>

	<& /funclib/tablesorter.mas, table => "sortme" &>

	<div class="left huge">

		<table cellpadding="1" cellspacing="1" width="100%" id="sortme">

			<thead>

			<tr class="yellowrow">

%				unless ($no_codes) { 
					<th class="smaller">
						Code
					</th>
%				}

				<th class="smaller">
					Entry Name
				</th>

				<th class="smaller">
					School
				</th>

				<th class="smaller">
					Registered
				</th>

%				if ($drops) {

					<th class="smaller">
						Dropped
					</th>

%				} else { 

					<th>
					</th>
%				}

			</tr>
			</thead>
			<tbody>

%			foreach my $entry (@entries) { 

%				next if $entry->dropped && $waitlist;

				<tr class="<% ($entry->dropped && not defined $drops) ? "strike" : "" %>" >

%					unless ($no_codes) { 
						<td class="smallish">
							<a class="plain block" href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
								<% $entry->code %>
							</a>
						</td>
%					}

					<td class="smallish">
						<a class="plain block" href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
							<% $entry->name %>
						</a>
					</td>

					<td class="smallish">
						<span class="<% $no_codes ? "medbigspan" : "medspan" %>">
							<a class="plain block" href="/register/school/entries.mhtml?event_id=<% $entry->event->id %>&school_id=<% $entry->school->id %>">
							<% $entry->school->short_name %> 
							</a>
						</span>
%						if ($waitlist) { 
							<% scalar Tab::Entry->search( event => $entry->event->id, school => $entry->school->id, waitlist => 0, dropped => 0, unconfirmed => 0) %>
%						}
					</td>

					<td class="smallish">
						<% ($entry->reg_time) ? &Tab::niceshortdt($entry->reg_time->set_time_zone($tz)) : "" %>
					</td>

					<td class="smallish centeralign">

%						if ($waitlist) { 

%							my $warn = "This will remove the entry from the waitlist.  The coaches will be notified by email.";
							<a class="dkgreen block" href="waitlist_admit.mhtml?entry_id=<% $entry->id %>"  <& "/funclib/confirm.mas", warn => $warn &> >
								Admit
							</a>

%						} elsif ($drops) { 
							
							<% ($entry->drop_time) ? &Tab::niceshortdt($entry->drop_time->set_time_zone($tz)) : "" %>
							<% ($entry->drop_by) ? $entry->drop_by->first." ".$entry->drop_by->last : "" %>

%						} else { 

							<% ($entry->dropped) ? "DROP" : "" %>
							<% ($entry->waitlist) ? "WL" : "" %>
							<% ($entry->dq) ? "DQ" : "" %>

%						}

					</td>

				</tr>
%			}

			</tbody>

		</table>

	</div>

