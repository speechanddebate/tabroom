<%args>
	$tourn
</%args>
<%init>	

	use POSIX;

	my $switch;

	my $entry_fees;
	my $hire_fees;
	my $concession_fees;

	my $student_fees;

	if ($tourn->setting("per_student_fee")) {
		my @students = $m->comp("/funclib/tourn_students.mas", tourn => $tourn);
		$student_fees = scalar @students * $tourn->setting("per_student_fee");
	}

	my $fine_fees;

	foreach my $fine ($m->comp("/funclib/tourn_school_fines.mas", tourn => $tourn)) {
		$fine_fees += $fine->amount;
	}

	Tab::School->set_sql( individuals => "
		select sum(individuals) 
		from school
		where tourn = ? 
	");

	my $body_count = Tab::School->sql_individuals->select_val($tourn->id) if $tourn->setting("per_person_fee");
	my $bodies = $body_count * $tourn->setting("per_person_fee");

</%init>
	
	<& "menu.mas", tourn => $tourn, whoami => "finance_report" &>

	<div class="main">

		<h2>Financials for <% $tourn->name %></h2>

		<div class="half">

			<h4>Itemized</h4>

			<table>

%				my $conc;

%				foreach my $concession (sort {$a->name cmp $b->name} $tourn->concessions) { 

<%perl>
					my @orders = Tab::ConcessionPurchase->search( concession => $concession->id );
					my $concession_total;
					foreach my $order (@orders) { 
						$concession_total += $order->quantity;
						$conc++;
					}

					$concession_fees += $concession_total * $concession->price;
</%perl>
					
					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">
						
						<td>
							<span class="fivesixth nospace nowrap">
								<% $concession->name %>
							</span>
							
							<span class="sixth nospace rightalign">
								<% $concession_total %>
							</span>
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $concession->price * $concession_total) %>
						</td>

					</tr>

%				}

%				if ($concession_fees) { 

					<tr class="libl">

						<th>
							<span class="block">
								Total <% ($tourn->setting("concession_name")) ?  $tourn->setting("concession_name") : "Concessions" %>
							</span>
						</th>

						<td class="rightalign code">
							<% sprintf("%.2f", $concession_fees) %> 
						</td>

					</tr>

					<tr>
						<td>
							<span class='block'> </span>
						</td>
					</tr>
%				}

%				my $hire;

%				foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) { 

<%perl>
					my @hires = Tab::JudgeHire->search( judge_group => $group->id);
					next unless @hires;

					my $hire_total;

					my $rounds_hired;
					my $judges_hired;
					my $entries_hired;

					foreach my $hire (@hires) { 

						next unless $hire->accepted > 0;

						if ($group->setting("judge_per")) {

							if ($group->setting("hired_fee")) { 
								my $covers = ceil($hire->accepted / $group->setting("judge_per"));
								$hire_total += $covers * $group->setting("hired_fee");
								$judges_hired += $covers;
							} 

							if ($group->setting("uncovered_entry_fee")) { 
								$hire_total += $hire->accepted * $group->setting("uncovered_entry_fee");
								$entries_hired += $hire->accepted;
							}
	
						} elsif ($group->setting("rounds_per")) {

							$hire_total += $hire->accepted * $group->setting("round_hire_fee");
							$rounds_hired += $hire->accepted;

						}
					}

					$hire_fees += $hire_total;
</%perl>

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							<span class="fivesixth nospace">
								<% $group->abbr %> hired 
								<% $rounds_hired ? "rounds of judging" : "" %>
								<% $judges_hired ? "judges" : "" %>
								<% $entries_hired ? "entries of judging" : "" %>
							</span>
							<span class="sixth nospace rightalign">
								<% $rounds_hired ? $rounds_hired : "" %>
								<% $judges_hired ? $judges_hired : "" %>
								<% $entries_hired ? $entries_hired : "" %>
							</span>
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $hire_total) %>
						</td>

					</tr>

%				}

%				if ($hire) { 
					<tr>
						<td>
							<span class='block'> </span>
						</td>
					</tr>
%				}

%				if ($bodies) { 

%					$entry_fees += $bodies;

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							<span class="fivesixth nospace">
								Per-person fees
							</span>
							
							<span class="sixth nospace rightalign">
								<% $body_count %>
							</span>
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $bodies) %>
						</td>

					</tr>

%				}

%				foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 

%					my @entries = Tab::Entry->search( event => $event->id, dropped => 0, waitlist => 0, unconfirmed => 0);
%					$entry_fees += ($event->fee * scalar @entries);

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							<span class="fivesixth nospace">
								<% $event->abbr %> entry fees
							</span>
							
							<span class="sixth nospace rightalign">
								<% scalar @entries %>
							</span>
						</td>
			
						<td class="rightalign code">
							<% sprintf("%.2f", $event->fee * scalar @entries) %>
						</td>
				
					</tr>

%				}

				<tr class="libl">
					<th>
						<span class="block">
							Total Entry Fees
						</span>
					</th>

					<td class="rightalign code">
						<% sprintf("%.2f", $entry_fees) %>
					</td>

				</tr>

			</table>

		</div>

		<div class="half">

%			undef $switch;

			<h4>Totals</h4>

			<table>

%				my $total;

%				if ($student_fees) { 

%					$total += $student_fees;

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							Per-Student Fees
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $student_fees) %>
						</td>

					</tr>

%				}

%				if ($hire_fees) { 

%					$total += $hire_fees;

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							Judge Hire Fees
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $hire_fees) %>
						</td>

					</tr>

%				}

%				if ($concession_fees) { 

%					$total += $concession_fees;

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							<span class="block">
							<% $tourn->setting("concession_name") ?  $tourn->setting("concession_name") : "Concession" %>
							</span>
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $concession_fees) %>
						</td>

					</tr>

%				}

%				if ($fine_fees) { 

%					$total += $fine_fees;

					<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

						<td>
							Fines
						</td>

						<td class="rightalign code">
							<% sprintf("%.2f", $fine_fees) %>
						</td>

					</tr>

%				}

				<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">

					<td>
						Entry Fees
					</td>

					<td class="rightalign code">
						<% sprintf("%.2f", $entry_fees) %>
					</td>

				</tr>

%				$total += $entry_fees;

				<tr class="green">

					<th>
						Grand Total
					</th>

					<td class="rightalign code">
						<% sprintf("%.2f", $total) %>
					</td>

				</tr>

			</table>

		</div>
	
	</div>
