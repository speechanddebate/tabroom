<%args>
	$circuit
	$tourn
	$account
	$session
	$debug => undef
</%args>
<%init>

	use POSIX;

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = "Finances-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1 );

	my $total;
	my $switch = 1;
	my $entry_fees;
	my $hire_fees;
	my $concession_fees;
	my $fine_fees;
	my $student_fees;

	if ($tourn->setting("per_student_fee")) {
		my @students = $m->comp("/funclib/tourn_students.mas", tourn => $tourn);
		$student_fees = scalar @students * $tourn->setting("per_student_fee");
	}

	foreach my $fine ($m->comp("/funclib/tourn_school_fines.mas", tourn => $tourn)) {
		$fine_fees += $fine->amount;
	}

    open (TEXOUT, ">>$filepath.tex");
	
	print TEXOUT "\\bigskip\n";
	print TEXOUT "{\\huge ". Tab::texify($tourn->name) ." Financial Report } \\\\ \n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{minipage}[t]{0.5\\linewidth}\\centering\n";
	print TEXOUT "\\vspace{0pt}\n";
	print TEXOUT "\\renewcommand{\\arraystretch}{1.8}\n";
	print TEXOUT "\\begin{tabular}{p{2.25in}p{.5in}}\n";
	print TEXOUT "\\multicolumn{2}{>{\\columncolor[rgb]{1,.95,.66}}l}{\\large Itemized}\\\\ \n";

	my $conc;

	foreach my $concession (sort {$a->name cmp $b->name} $tourn->concessions) { 

		my @orders = Tab::ConcessionPurchase->search( concession => $concession->id );
		my $concession_total;
		foreach my $order (@orders) { 
			$concession_total += $order->quantity;
			$conc++;
		}

		$concession_fees += $concession_total * $concession->price;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify($concession->name." ".$concession_total);
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".($concession->price * $concession_total));
		print TEXOUT " \\\\ \n";

	}


	my $hire;

	foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) { 

		my @hires = Tab::JudgeHire->search( judge_group => $group->id);
		next unless @hires;
		my $hire_total; 
		
		foreach my $hire (@hires) { 

			next unless $hire->accepted > 0 || $hire->rounds_accepted > 0;

			if ($group->setting("judge_per")) { 

				if ($group->setting("hired_fee")) { 
					my $covers = ceil($hire->accepted / $group->setting("judge_per"));
					$hire_total += $covers * $group->setting("hired_fee");
				} elsif ($group->setting("uncovered_entry_fee")) { 
					$hire_total += $hire->accepted * $group->setting("uncovered_entry_fee");
				} 

			} elsif ($group->setting("rounds_per")) { 
				$hire_total += $hire->rounds_accepted * $group->setting("round_hire_fee");
			}
		}

		$hire_fees += $hire_total;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify($group->name." hired judging:");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".($hire_total));
		print TEXOUT " \\\\ \n";
	}


	foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 

		my @entries = Tab::Entry->search( event => $event->id, dropped => 0, waitlist => 0 ); 
		$entry_fees += ($event->fee * scalar @entries);

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify($event->name);
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".($event->fee * scalar @entries));
		print TEXOUT " \\\\ \n";

	}

	Tab::School->set_sql( individuals => "
		select sum(individuals) 
		from school
		where tourn = ? 
	");

	my $bodies = Tab::School->sql_individuals->select_val($tourn->id) if $tourn->setting("per_person_fee");
	$bodies = $bodies * $tourn->setting("per_person_fee");

	if ($bodies) { 
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify("Per-person fees");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".($bodies));
		print TEXOUT " \\\\ \n";
		$entry_fees += ($bodies);
	}

	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\end{minipage}\n";
	print TEXOUT "\\hspace{0.4cm}\n";

	$switch = 1;

	print TEXOUT "\\begin{minipage}[t]{0.5\\linewidth}\\centering";
	print TEXOUT "\\vspace{0pt}\n";
	print TEXOUT "\\renewcommand{\\arraystretch}{1.8}\n";
	print TEXOUT "\\begin{tabular}{p{2.25in}p{.5in}}\n";
	print TEXOUT "\\multicolumn{2}{>{\\columncolor[rgb]{1,.95,.66}}l}{\\large Totals}\\\\ \n";

	if ($student_fees) { 

		$total += $student_fees;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify("Per Student Fees");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".$student_fees);
		print TEXOUT " \\\\ \n";

	}

	if ($hire_fees) { 
		
		$total += $hire_fees;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify("Judge Hire Fees");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".$hire_fees);
		print TEXOUT " \\\\ \n";

	}

	if ($concession_fees) { 
	
		$total += $concession_fees;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify($tourn->setting("concession_name")) if $tourn->setting("concession_name");
		print TEXOUT &Tab::texify("Concessions") unless $tourn->setting("concession_name");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".$concession_fees);
		print TEXOUT " \\\\ \n";

	}

	if ($fine_fees) { 

		$total += $fine_fees;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify("Fines");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".$fine_fees);
		print TEXOUT " \\\\ \n";

	}

	if ($entry_fees) { 

		$total += $entry_fees;

		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT &Tab::texify("Entry Fees");
		print TEXOUT " & ";
		print TEXOUT &Tab::texify("\$".$entry_fees);
		print TEXOUT " \\\\ \n";

	}

	print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT &Tab::texify("Total");
	print TEXOUT " & ";
	print TEXOUT &Tab::texify("\$".$total);
	print TEXOUT " \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "Printed on ". Tab::nicedt($now) ."\\\\ \n";
	print TEXOUT "\\end{minipage}\n";

	close TEXOUT;

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>

<div id="content">

<p><% $filename %></p>
