<%args>
	$tourn
	$session
</%args>
<%init>

	Tab::Student->set_sql( wsdc_students => "
		select distinct student.*, event.abbr as event, entry.school as school, entry.code as code
		from student, entry_student, entry, event
		where event.tourn = ?
		and entry.event = event.id
		and entry_student.entry = entry.id
		and student.id = entry_student.student
		order by student.last
	");

	my @districts = sort {$a->name cmp $b->name} $tourn->schools;
	my %districts_by_id = map {$_->id => $_} @districts;

	my @students = Tab::Student->search_wsdc_students($tourn->id);

	my %students = ();

	foreach my $student (@students) {
		push @{$students{$student->school}{"schools"}}, $student->school_sid;
		push @{$students{$student->school}{"students"}}, $student;
		push @{$students{$student->school}{$student->school_sid}}, $student;
	}

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);
    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = "WSDC-Competitors-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1, array => 1.4 );

    open (TEXOUT, ">>$filepath.tex");

    my $logo = $tourn->setting("logo");
    system "cd $Tab::file_root/tmp; $Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo if $logo;

	foreach my $district (@districts) { 

		my @judges = $district->judges; 
		my $judge_string = "Judge";
		$judge_string.= "s" if scalar @judges > 1;

		my %used_school;

		foreach my $school_name (@{$students{$district->id}{"schools"}}) { 

			next if $used_school{$school_name}++;

			print TEXOUT "\\begin{figure}[h!]\n";
			print TEXOUT "\\begin{minipage}{.4\\textwidth}";

			if ($logo && -e "$Tab::file_root/tmp/$logo") { 
				print TEXOUT "{\\includegraphics[height=1in]{".$logo."}}\n";
			}
	
			print TEXOUT "\\end{minipage}%\n";
			print TEXOUT "\\begin{minipage}{.6\\textwidth}";
			print TEXOUT "\\hfill {\\LARGE ".Tab::texify($school_name).", ".$district->chapter->state."} \n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\strut \\hfill {\\Large District: ".$district->code." ".Tab::texify($district->name)." }  \n";
			print TEXOUT "\\end{minipage}%\n";
			print TEXOUT "\\end{figure}\n";


			print TEXOUT " \\strut \\hfill {\\huge \\bf USA WSDC Invitational} \\hfill\n";
			print TEXOUT "\\vspace{.25in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "{\\large \\bf Your students registered to compete in the WSDC Invitational: } \\\\ \n";
			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\normalsize\n";
		
			my $tabular = "\\begin{tabular}{p{.25in}p{2in}p{2in}p{2in}}\n";

			my %used= ();
			my $notfirst;

			foreach my $student (@{$students{$district->id}{$school_name}}) { 
				next if $used{$student->id}++;
				print TEXOUT "\\newline\n" if $notfirst++;
				print TEXOUT $tabular;
				print TEXOUT " & ".Tab::texify($student->first)." ".Tab::texify($student->last)." & ";
				print TEXOUT " Team Code: ".Tab::texify($student->code)." & \n";
				print TEXOUT "\\end{tabular}\n";
			}

			print TEXOUT "\\vspace{.15in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "{\\large \\bf Other students from the ".Tab::texify($district->name)." district: } \n";
			print TEXOUT "\\vspace{.1in}\n";
			print TEXOUT "\\newline\n";
			
			undef $notfirst;

			foreach my $student (sort {$a->code cmp $b->code} @{$students{$district->id}{"students"}}) { 
				next if $used{$student->id}++;
				print TEXOUT "\\newline\n" if $notfirst++;
				print TEXOUT $tabular;
				print TEXOUT " & ".Tab::texify($student->first)." ".Tab::texify($student->last)." & ";
				print TEXOUT " Team Code: ".Tab::texify($student->code)." & ";
				print TEXOUT " \\truncate{2in}{ ".Tab::texify($student->school_sid)." } \n ";
				print TEXOUT "\\end{tabular}\n";
			}

			print TEXOUT "\\vspace{.15in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "{\\large \\bf ".Tab::texify($district->name)."'s district coach: } \\\\ \n";
			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\normalsize\n";

			print TEXOUT $tabular;
			print TEXOUT " & ".Tab::texify($district->contact_name)." & ";
			print TEXOUT Tab::texify($district->contact_email)." & ";
			print TEXOUT " \\truncate{2in}{ ".Tab::texify($district->contact_number)." } \\\\ \n ";
			print TEXOUT "\\end{tabular}\n";

			print TEXOUT "\\vspace{.15in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "{\\large \\bf ".Tab::texify($district->name)."'s district judges : } \\\\ \n";
			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\normalsize\n";

			print TEXOUT $tabular;
			foreach my $judge (@judges) { 
				print TEXOUT " & ".Tab::texify($judge->first)." ".Tab::texify($judge->last)." ";
			}
			print TEXOUT "\\end{tabular}\n";

			print TEXOUT "\\vspace{.15in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "{\\bf If you find any of this in error, please go to the problem table in the registration area immediately.}";

			print TEXOUT "\\vspace{.25in}\n";
			print TEXOUT "\\newline\n";

			print TEXOUT " \\strut \\hfill {\\Large \\bf Meetings and Notes} \\hfill\n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT " All coaches and students are encouraged to attend the judge and student training session being held today at 2pm in Dallas Ballrooms B/C of the Sheraton Dallas Hotel. ";

			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT " {\\bf All judges must attend this session or the make up session }.  
				The make up session is at 8am Monday in the Dealey room of the
				Crowne Plaza Hotel. ";

			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";
				
			print TEXOUT "{\\bf ALL JUDGE ASSIGNMENTS FOR WORLD SCHOOLS JUDGES WILL BE DISTRIBUTED ON MONDAY FROM THE DEALEY ROOM.}";

			print TEXOUT "\\newpage\n";

		}

	}

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>

