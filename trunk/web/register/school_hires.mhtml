<%args>
	$tourn
	$school_id
</%args>
<%perl>

	my $school = Tab::School->retrieve($school_id);

	my $switch;

	my %accepted_by_group = ();
	my %requested_by_group = ();
	my %uncovered_by_group = ();

	my @groups = sort {$a->name cmp $b->name} $tourn->groups;

	foreach my $group (@groups) {

	    my $judge_obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas",
            group => $group,
            school => $school);

	    my @entries = $school->group_entries($group);

	    my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_useful_by_group.mas",
            group => $group,
            school => $school);

    	my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas",
            group => $group,
            school => $school);

		my $request = $school->requests_by_group($group);
		my $accepted = $request->accepted if $request;
		my $requested = $request->covers if $request; 
		
		$accepted_by_group{$group->id} = $accepted;
		$requested_by_group{$group->id} = $requested;
		$uncovered_by_group{$group->id} = $uncovered;

	}

</%perl>

    <& menubar.mas, school => $school, whoami => "judges", tourn => $tourn &>

	<div class="left huge">

	<h3>Hired Judges</h3>

	<table cellpadding="6" cellspacing="0" width="100%" border="0">

		<tr class="liblrow">

			<th>
				Group
			</th>

			<th>
				Requested
			</th>

			<th>
				Accepted
			</th>

			<th colspan="4">
			</th>

		</tr>

<%perl>

	foreach my $group (@groups) {

    	next unless $group->track_judge_hires;

    	my $accepted = $accepted_by_group{$group->id};
    	my $requested = $requested_by_group{$group->id};

    	if ($group->judge_per && $group->hired_fee) {
    	    $accepted = ceil($accepted / $group->judge_per);
    	    $requested = ceil($requested / $group->judge_per);
    	}

</%perl>

        <tr 
%       	if ($uncovered_by_group{$group->id} > 0) {
        	    <% ($switch++ % 2) ? "class=\"redrow\"" : "class=\"lirdrow\"" %>>
%			} else {
            	<% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%       	}

	        <th>
    	        <form action="hire_save.mhtml" method="post">
        	    <input type="hidden" name="school_id" value="<% $school->id %>">
        	    <input type="hidden" name="group_id" value="<% $group->id %>">
        	    <% $group->abbr %>
			</th>

			<td>
				<input type="text" name="hired_number" size="2" value="<% $requested %>">
				<% ($group->hired_fee) ? "judges." : "entries." %>
			</td> 
				
			<td>
				<input type="text" name="accepted" size="2" value="<% ($accepted) ? $accepted : "" %>">
			</td> 
				
			<td align="left">
				<input class="skinny" type="submit" value=" Save ">
				</form>
			</td>

%			if ($group->hired_fee && $group->judge_per) {
				<td align="right" class="smaller">
					Still needs <% ceil($uncovered_by_group{$group->id} / $group->judge_per) %> hires.
				</td>
%			} else {
				<td align="right" class="smaller">
					<% $uncovered_by_group{$group->id} %> students still uncovered
				</td>
%			}


			</tr>

%		}

		</table>

	</div>

	<div class="right small">

		<a class="whiteblock">Categories in red are below obligation:</a>

%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%			my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", 
%				school => $school, group => $group); 
					
%			my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_useful_by_group.mas", 
%				school => $school, group => $group);

%			my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", 
%				school => $school, group => $group);

				<a href="judge_add.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" 
					class="<% ($uncovered < 1) ? "blue block" : "red block" %>">
						<span style="float: left;  width: 160px;">Add <% substr($group->name,0,15) %> judge </span>
					<% scalar @useful_judges %>/<% $obligation %>
					<% ($uncovered < 1) ? " " : "Unmet" %> 
					<% ($uncovered < 1 && (scalar @useful_judges < $obligation) ) ? "+ Hires " : "" %> 
				</a>


%			if ($group->deadline) {
				<a href="/user/tourn/entry/judge_add.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="whiteblockind">
					**<% $group->abbr %> Judges due: <% &Tab::niceshortdt($group->deadline->set_time_zone($tourn->circuit->timezone)) %>
				</a>

%			}

%		}

		<hr />

		<a class="chosenblock" href="school_hires.mhtml?school_id=<% $school->id %>">Judge Hires</a>

	</div>

