<%args>
	$tourn
	$account
	$text
	$subject
	$everybody => undef
	$judge_short => undef
	$debug => undef
</%args>
<%init>
	
	my $now = DateTime->now(time_zone => $tourn->circuit->timezone);
	my @account_ids;
	my @sendto_accounts;

    use Text::Wrap
    $Text::Wrap::columns = 72;

	$subject = "[".$tourn->circuit->short_name."] ".$subject;

	my $email = Tab::Email->create({ 	
		circuit => $tourn->circuit,
		subject => $subject,
		senton => $now,
		tournament => $tourn->id,
		sender => $account->id });

	my $email_id = $email->id;

	my $sent_to;

	my @recipients;

	if ($everybody) { 

		$sent_to .= "All Registrants of ".$tourn->name;

    	my %school_account_ids = ();

   		foreach my $school ($tourn->schools) {

			my $chapter = $school->chapter;

   	    	foreach my $coach ($chapter->coaches) {
      	      	push (@recipients, $coach);
      		}
		}
	} 

	if ($judge_short) { 

		my @groups = $tourn->groups;
		$sent_to .= " Schools short on judges at ".$tourn->name;
    	my %school_account_ids = ();

   		foreach my $school ($tourn->schools) {

			my $short;

			foreach my $group (@groups) { 

				my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas",
					group => $group,
					school => $school);

				$short++ if $uncovered;
				last if $short;
			}

			next unless $short;

			my $chapter = $school->chapter if $short;

   	    	foreach my $coach ($chapter->coaches) {
      	      	push (@recipients, $coach);
      		}

		}
	} 

	unless ($everybody || $judge_short) {
 
		my %send_keys = ();
		
		$sent_to .= " Schools registered for ".$tourn->name." with entries in:";

		foreach my $event ($tourn->events) { 

			my $event_key = "event_".$event->id;
			next unless $ARGS{$event_key};
			
			$sent_to .= $event->name."\n";

			my @schools = $event->schools;

			foreach my $school (@schools) {

				my @coaches = $school->chapter->coaches if $school->chapter;
      	      	push (@recipients, @coaches);

			}
		}
	}

	foreach my $director ($tourn->tabbers) { 
		push (@recipients, $director);
	}

	$text =  wrap('', '', $text);
	$text = $text."\n-----------------------------\n";
	$text = $text."$sent_to\n\n";

	$email->sent_to($sent_to);
	$email->text($text);
	$email->update;

	#uniq
    my %seen = ();
	@recipients = grep { ! $seen{$_->id} ++ } @recipients;

	foreach my $recipient (@recipients) { 
		$m->comp( "/funclib/send_email.mas", from => $account, to => $recipient, subject => $subject, body => $text );
	}

	my $msg = "This message has been sent.";

	$m->redirect("/register/email_view.mhtml?email_id=$email_id&msg=$msg");

</%init>

