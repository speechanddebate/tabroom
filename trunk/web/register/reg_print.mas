<%args> $session
	$print => undef
	$league
	$school_id
	$tourn
	$account
	$no => undef
	$debug => undef
</%args>

<%init>
	my $school = Tab::School->retrieve($school_id);
	my $filename = $Tab::file_root."/tmp/registration-norooms-".$school_id."-".$session->id if $no;
	   $filename = $Tab::file_root."/tmp/registration-withrooms-".$school_id."-".$session->id unless $no;

	my $now = DateTime->now;	
	$now->set_time_zone($league->timezone);
	my $garbage = `rm -f $filename.*`;
	
	open (TEXOUT, ">$filename.tex");

	my $texheader = "
\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=1in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}
\\small
";


	print TEXOUT $texheader;

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{.75in}p{2.25in}p{.75in}p{2.25in}} \n  ";
	print TEXOUT "{\\bf League:} & ".&Tab::texify($league->name)." & ";
	print TEXOUT "{\\bf Tournament:} & ".&Tab::texify(substr($tourn->name,0,30))." \\\\ \n ";
	print TEXOUT "{\\bf School:} & ".&Tab::texify(substr($school->code,0,2))." ". &Tab::texify($school->name);
	print TEXOUT " (".&Tab::texify($school->chapter->state).")" if $school->chapter && $school->chapter->state;
	print TEXOUT " & ";
	print TEXOUT "{\\bf Printed:} & ". $now->mdy('/')." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p');
	print TEXOUT " \\\\* \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";
	close TEXOUT;

	$m->comp("/funclib/registration_print.mas", 
		school_id => $school->id, 
		filename => $filename, 
		league => $league) unless ($no || $print eq "Judges");

	$m->comp("/funclib/registration_print_noassigns.mas", 
		school_id => $school->id, 
		filename => $filename) if ($no && $print ne "Judges");

	$m->comp("/funclib/judges_print.mas", 
		school_id => $school->id, 
		filename => $filename, 
		league => $league) unless ($no || $print eq "Students");

	$m->comp("/funclib/judges_print.mas", 
		school_id => $school->id, 
		filename => $filename, 
		league => $league, 
		noassigns => "YooHoo") if ($no && $print ne "Students");

    if ($tourn->method->housing) {
	    $m->comp("/funclib/housing_print.mas",
        school_id => $school->id,
        filename => $filename,
        league => $league, );
    }

	open (TEXOUT, ">>$filename.tex");
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

`rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug; 

$m->redirect("$Tab::url_prefix/tmp/registration-withrooms-$school_id-".$session->id.".pdf") unless $no;
$m->redirect("$Tab::url_prefix/tmp/registration-norooms-$school_id-".$session->id.".pdf") if $no;

</%init>
