<%args> 
	$req_id
	$circuit
	$account
	$tourn
	$covers => undef
	$accepted => undef
</%args>
<%init>

	use Mail::Mailer;

	my $hire = Tab::JudgeHire->retrieve($req_id);

	my $msg;

	if ($hire->judge_group->uncovered_entry_fee) { 

		$msg .= "The number of students covered by hires has been reduced to $covers. " 	
				if $hire->covers > $covers;

		$msg .= "The number of students covered by hires has been increased to $covers. " 	
				if $hire->covers < $covers;

		$msg .= "The number of accepted requests to cover students with hired judging
		has been increased to $accepted. " if $hire->accepted < $accepted;
		
		$msg .= "The number of accepted requests to cover students with hired judging
		has been reduced to $accepted. " if $hire->accepted > $accepted;

	} else { 

		my $whole_judges_covers = $covers;
		my $whole_judges_accepted = $accepted;

		$covers = $covers * $hire->judge_group->judge_per if $hire->judge_group->judge_per;
		$accepted = $accepted * $hire->judge_group->judge_per if $hire->judge_group->judge_per;

		$msg .= "The number of judge hires you requested has been reduced to
				$whole_judges_covers."		if $hire->covers > $covers;

		$msg .= "The number of judge hires you requested has been increased to
				$whole_judges_covers." 	if $hire->covers < $covers;
	
		$msg .= "The number of accepted judge hire requests has been increased
				to $whole_judges_accepted." if $hire->accepted < $accepted;
		
		$msg .= "The number of accepted judge hire requests has been reduced to
				$whole_judges_accepted. " if $hire->accepted > $accepted;

	}

	$hire->accepted($accepted);
	$hire->covers($covers);
	$hire->update;

	#Send the email

	my $subject = "Hired Judging Changes: ". $tourn->name;
	my $message = " The ".$tourn->name." would like to notify you\r\n";
	$message .= " of changes made by the tournament to your requests to hire judging\r\n";
	$message .= " to cover entries in ".$hire->judge_group->name.".\r\n\r\n";

	$message .= "The following changes have been made by the tournament directors:\r\n";

	$message .= $msg."\r\n \r\n";

	$message .= " You do not have to take further action; the changes are\r\n";
	$message .= " now fully entered and your online invoice changed to reflect them\r\n";

	$message .= "\r\n \r\n";
	$message .= " Cheers,\r\n ";
	$message .= " ".$account->first." ".$account->last."\r\n";
	$message .= " ".$tourn->name."\r\n ";

    $message .= " \r\n \r\n --- \r\n ";
    $message .= " This message auto-generated by the Tabroom.com software\r\n";
	$message .= "Tabroom.com: http://www.tabroom.com.  ";

	$message .= "Tournament information is at ".$Tab::url_prefix."/index/tournament.mhtml?tourn_id=".$tourn->id." \n";

	my @accounts = $hire->school->chapter->coaches;

    foreach my $sendto (@accounts) {

		next if $r->hostname =~ /tabdev/;

        my $mail = new Mail::Mailer 'smtp', Server => $Tab::smtp_server;
        my $from = $account->first." ".$account->last." <".$account->email.">";
        my $to = $sendto->first." ".$sendto->last." <".$sendto->email.">";

        $mail->open({   From => $from,
            To => $to,
			Bcc => $account->email,
            Subject => $subject,
        });

        print $mail $message."\r\n \r\n";
        $mail->close();
    }

	$m->redirect("$Tab::url_prefix/register/hire_requests.mhtml?group_id=".$hire->judge_group->id);

</%init>
