<%args> 
	$tourn
	$judge_id => undef
</%args>
<%init>

	my $switch;

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	my $school = $judge->school;

	my $diocese = $m->comp("/school_region.mas", school => $school) if $tourn->setting("ncfl");

	my $group = $judge->judge_group;

	my @schools = sort {$a->name cmp $b->name} $tourn->schools;
	my @dioschools;
	if ($diocese) { 
		@dioschools = sort {$a->name cmp $b->name} $diocese->schools(tournament => $tourn->id);
	}

 	my @panels = $m->comp('/funclib/judge_panels.mas', judge => $judge);

	my $hired++ unless $judge->school && $judge->school->id;
	
</%init>

%	if ($hired) { 
		<div class="left huge">
%	} else {
    	<& "/register/menubar.mas", school => $school, whoami => "judges", tourn => $tourn &>
%	}

		<h4><% ($hired) ? "Hired" : "" %> Judge <% $judge->first." ".$judge->last %></h4>

		<table cellpadding="5" cellspacing="1" width="100%" border="0">

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					Name
					<form action="save.mhtml" method="post">
					<input type="hidden" name="judge_id" value="<% ($judge) ? $judge->id : "" %>">
				</td>

				<td>
%					if ($judge->account && $judge->account->id) { 
						<% $judge->first." ".$judge->last %>
%					} else { 
						<input type="text" name="first" size="10" value="<% $judge->first %>" placeholder="First">
						<input type="text" name="last" size="18" value="<% $judge->last %>" placeholder="Last">
%					} 

				</td>

			</tr>

%			unless ($group->setting("no_codes")) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						Code
					</td>

					<td>
						<input type="text" name="code" size="10" value="<% $judge->code %>" style="margin-right: 35px;">
					</td>
	
				</tr>

%			}

%			if ($group->setting("rounds_per")) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						Round Obligation
					</td>

					<td>
						<input type="text" name="obligation" size="10" value="<% $judge->obligation %>" style="margin-right: 35px;">
					</td>
	
				</tr>

%			}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
	
				<td>
					Phone
				</td>	
				
				<td>
					<input type="text" name="phone" size="33" value="<% ($judge->account) ? $judge->account->phone : "" %>">
				</td>

			</tr>

%			if ($tourn->setting("ncfl")) { 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
					<td>
						Diocese
					</td> 
				
					<td>
						<% $judge->region->name %> (<% $judge->region->code %>)
					</td> 

				</tr>

%			}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					School
				</td>
				
				<td>
					<select name="school" style="width: 275px;">

						<option value="">Hired</option> 

%							my %school_already;

% 							if ($diocese) { 

% 								foreach my $school (@dioschools) { 

%									$school_already{$school->id}++;
										<option value="<% $school->id %>" <% ($school->id eq $judge->school->id) ? 'selected' : '' %> >
											<% substr($school->name,0,28) %> 
										</option>
%								} 
					
								<option value="">
									---Other Dioceses:---
								</option>

%							}

% 							foreach my $school (@schools) { 

%								next if $school_already{$school->id}++;

								<option value="<% $school->id %>" <% ($school->id eq $judge->school->id) ? 'selected' : '' %> >
									<% substr($school->name,0,28) %> 
								</option> 

%							} 
	
					</select>

				</td>

			</tr> 

%			if (scalar $tourn->groups == 1) { 
				
				<input type="hidden" name="judge_group" value="<% $group->id %>">
%			} else { 
			
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
					<td>
						Judge group
					</td> 
				
					<td>
						<select name="judge_group" style="width: 275px;">
						
% 						foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) { 

							<option value="<% $tgroup->id %>" 
								<% ($group && $group->id == $tgroup->id) ? 'selected' : '' %> >
								<% $tgroup->name %> 
							</option>
%						} 

						<option>-----------------------------</option>

						</select> 
					</td> 

				</tr> 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
					<td>
						Covers entries in
					</td> 
					
					<td>
						<select name="covers" style="width: 275px;">

							<option value="">
								None Selected
							</option> 

%	 						foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) {
    							<option value="<% $tgroup->id %>"
   	 								<% ($judge->covers && $tgroup->id == $judge->covers->id) ? 'selected' : '' %> 
									<% ( ($group && $group->id == $tgroup->id) &! $judge->covers) ? 'selected' : '' %> >
   									<% $tgroup->name %> 
								</option>
%							}  

							<option>-----------------------------</option>
						</select>
					</td>

				</tr>

% 				if ($group->setting("ask_alts")) {

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							Also judges group
						</td>
					
						<td>
							<select name="alt_group">

								<option value="">
									None Selected
								</option>

% 								foreach my $tgroup (sort {$a->name cmp $b->name} $tourn->groups) {

%									next if $tgroup->id == $group->id;
%									next if $tgroup->tab_room;
	
									<option value="<% $tgroup->id %>" <% ($judge->alt_group && $tgroup->id == $judge->alt_group->id) ? 'selected' : '' %> >
										<% $tgroup->name %> 
									</option>
%								}  

							</select>

						</td>

					</tr>

%				}
%			}


% 			if ($tourn->setting("track_first_year")) { 
				
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td>
						First year out
					</td>
					
					<td>
						<input type="radio" name="first_year" value="1" <% ($judge->first_year == 1) ? 'checked' : '' %> >
						Yes
						<input type="radio" name="first_year" value="0" <% ($judge->first_year != 1) ? 'checked' : '' %> >
						No
					</td>

				</tr>
% 			} 

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					Active
				</td> 
				
				<td>
					<input type="radio" name="active" id="Y" value="1" <% ($judge->active == 1) ? 'checked' : '' %> > 
						<label for="Y">
							Yes
						</label>
					<input type="radio" name="active" id="N" value="0" <% ($judge->active != 1) ? 'checked' : '' %> >
						<label for="N">
							No
						</label>
				</td>

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					Neutral to own school
				</td> 
				
				<td> 
					<input type="radio" name="neutral" id="Y" value="1" <% ($judge->setting("neutral") == 1) ? 'checked' : '' %> > 
						<label for="Y">
							Yes
						</label>
					<input type="radio" name="neutral" id="N" value="0" <% ($judge->setting("neutral") != 1) ? 'checked' : '' %> >
						<label for="N">
							No
						</label>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					Tab/Special Job
				</td>
				
				<td>
					<input type="text" name="special" size="33" value="<% $judge->special %>">
				</td>

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

				<td>
					Coach's Notes
				</td>

				<td>
					<input type="text" name="notes" size="33" value="<% $judge->notes %>">
				</td>

			</tr>

% 			if ($group->setting("ask_paradigm")) { 
			
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
					
					<td colspan="2">
						Paradigm
					</td>

				</tr>
					
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
					<td colspan="2">
						<textarea rows="5" name="paradigm" cols="42"><% $judge->paradigm %></textarea>
					</td>

				</tr>

% 			}


			<tr class="liblrow">

				<td colspan="2" align="right">
					<input  type="submit" value="Save Judge Information">
					</form>
				</td>

			</tr>

		</table>


% 		if ($group->pools && $judge) { 
		
%			my $switch;

			<h4>Pools:</h4> 
			
				<table cellpadding="4" cellspacing="1" width="100%">

					<form action="judge_save_pools.mhtml" method="post">
					<input type="hidden" value="<% $judge->id %>" name="judge_id">

% 					foreach my $pool (sort {$a->id <=> $b->id} $group->pools) { 

						<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

							<th>
								<% $pool->name %>
							</th>
							
							<td>
								<input type="checkbox" class="largecheck" name="<% $pool->id %>" value="1" <% ($judge->in_pool($pool)) ? "checked" : "" %>>
							</td>
							
						</tr>

%					} 

					<tr class="liblrow">
						<td colspan="2" align="right">
							<input  type="submit" value="Save Pool Changes">
							</form>
						</td>
					</tr> 
					
				</table>

% 			}

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>Information</h4>

%			if ($hired) { 

				<a class="blue block" href="/register/judges/hires.mhtml?judge_group=<% $group->id %>">
					Hired Judges
				</a>

%			} elsif ($judge->school && $group) { 

				<a class="blue block" href="/register/school/judges.mhtml?school_id=<% $judge->school->id %>&judge_group=<% $group->id %>">
					<% $judge->school->short_name %> Judges
				</a>

%			}

%			if ($group) { 
				<a class="blue block" href="/register/judge/roster.mhtml?group_id=<% $group->id %>">
					<% $group->name %> judges roster
				</a>
%			}
			
			<a href="print.mhtml?judge_id=<% $judge->id %>" class="blue block" style="margin-top: 8px; margin-bottom: 8px;">
				Print <% $judge->first %>'s info sheet
			</a> 
		
%			if ($tourn->setting("ncfl")) { 
				<a href="print_card.mhtml?judge_id=<% $judge->id %>" class="blue block">
					Print Judge's Info Card 
				</a>
%			}

			<h4>Wreak Havoc</h4>

				<a href="drop.mhtml?judge_id=<% $judge->id %>&school_id=<% ($judge->school) ? $judge->school->id : "" %>" class="yellow block">
					Drop Judge
				</a>

		</div>

		<div class="sidenote">

			<h4>Strikes & Prefs</h4>

			<a class="yellow block" href="judge_strikes.mhtml?judge_id=<% $judge->id %>">
				Add Strike
			</a>

%			if ($judge->strikes) { 
				<p class="smaller">Click to delete</p>
%			}

%  			foreach my $strike (sort {$a->type cmp $b->type} $judge->strikes) {
				<a class="blue block" href="strike_rm.mhtml?from=edit&strike_id=<% $strike->id %>">
					<% $strike->name %>
				</a>
%			}

			<a class="blue block" href="prefs.mhtml?judge_id=<% $judge->id %>">
				Pref Sheets
			</a>

		</div> 

% 		if ($group->setting("coach_ratings")) { 

			<div class="sidenote">

% 			my $switch;

			<h4>Ratings</h4>
			
			<table cellpadding="4" width="100%" cellspacing="1">  

			<form action="rating_save.mhtml" method="post">
			<input type="hidden" value="<%$judge->id%>" name="judge_id">

%			if ($group->rating_subsets) { 

% 				foreach my $subset ($group->rating_subsets) { 

%					my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge, subset => $subset);

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td class="smaller">
							<% $subset->name %>
						</td>
						
						<td class="centeralign">

							<select name="<% $subset->id %>_rating" onchange='this.form.submit()'>

								<option value="">Unrated Judge</option>

%								foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) { 

									<option value="<% $tier->id %>"
										<% ($rating && ($tier->id == $rating->rating_tier->id)) ? "selected" : "" %>>
										<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}

							</select>
						</td>

					</tr>

%				} 

%			}  else { 

%				my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge);

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smaller">
						<% $group->abbr %>
					</td>
						
					<td align="center">

						<select name="rating" onchange='this.form.submit()'>

							<option value="">
								Unrated
							</option>

%							foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) { 
								<option value="<% $tier->id %>" 
									<% ($rating && ($tier->id == $rating->rating_tier->id)) ? "selected" : "" %>>
									<% $tier->name %> - <% substr($tier->description,0,15) %>
								</option>
%							}

						</select>
					</td>

				</tr>

%			}

			<noscript>
			<tr class="liblrow"> 
				<td colspan="2" align="right">
					<input class="skinny" type="submit" value="Save Ratings">
				</td> 
			</tr>
			</noscript>

			</form>
			</table>

			</div>

% 		} 

% 		if (@panels) { 

			<div class="sidenote">

%			my $switch;

			<h4>Assignments:</h4> 
				
%			foreach my $panel (sort {$a->round->timeslot->start <=> $b->round->timeslot->start} $m->comp("/funclib/judge_panels.mas", judge => $judge)) { 

%				my $panel_start = $panel->round->timeslot->start;
%				$panel_start->set_time_zone($tourn->tz);

				<a class="green block" href="/panel/panel_view.mhtml?panel_id=<% $panel->id %>" style="padding-right: 0px;">
					<span style="width: 35px; display: inline-block; white-space: nowrap;">
						<% ($panel->round->label) ? $panel->round->label : "Rnd ". $panel->round->name %>
					</span>
					<span style="width: 30px; display: inline-block; white-space: nowrap;">
						<% $panel_start->hour_12.':'.$panel_start->strftime('%M') %>
					</span>
					<span style="width: 20px; display: inline-block; white-space: nowrap;">
						<% $panel->round->event->abbr %>
					</span>

					<span style="width: 88px; display: inline-block; white-space: nowrap; padding-left: 2px; margin-right: 0;" >
						<% ($panel->room) ?  substr($panel->room->name,0,15) : "" %>
					</span>
				</a>
				
% 			} 

			</div>

% 		} 

	</div> 
	
	<br style="clear:both"/>
