<%args>
	$session
	$group_id
	$tourn
</%args>
<%init>

	use POSIX;

	my $judge_group = Tab::JudgeGroup->retrieve($group_id);

	my @entries;

	foreach my $event ($judge_group->events) { 
		push @entries, sort {$a->name cmp $b->name} $event->entries( dropped => 0, waitlist => 0); 
	}

	my $name = $judge_group->name;
	$name =~ s/[\W_]//g;

	my $filename = "ConflictSheets-".$name."-".$session->id;
	my $filepath = $Tab::file_root."/tmp/$filename";
	my $garbage = `rm -f $filename.*`;

	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1, array => '1.3', taller => 1);

	my @firsts = @entries;
	my @seconds = splice @firsts, scalar(@entries)/2;

	open (TEXOUT, ">>$filepath.tex");

	my @judges = $judge_group->judges;
	my %school_name = map {$_->id => $_->name} $tourn->schools;

	foreach my $judge (sort {$school_name{$a->school} cmp $school_name{$b->school}} $judge_group->judges) { 

		my %entry_strike = map {$_->entry => 1} $judge->strikes;
	
		print TEXOUT "\\parbox[][][c]{6in}{\\centering \\bf Conflict Sheet for ";
		print TEXOUT Tab::texify($judge->first." ".$judge->last);
		print TEXOUT Tab::texify(" (".$judge->school->name.") ") if $judge->school;
		print TEXOUT Tab::texify(" (HIRE) ") unless $judge->school;
		print TEXOUT "}\n";
		print TEXOUT "\\smallskip \\newline \n";

		print TEXOUT "\\small\n";

		print TEXOUT "INSTRUCTIONS: Please draw a line through any team for which you have a conflict, sign this page, and return it to the tab room. In addition to marking unidentified conflicts, notify the tab room if any conflict shown below should not exist.";
		print TEXOUT "\\smallskip \\newline \n";

		my $tabular = "\\begin{tabular}{|p{3.25in}|p{3.25in}|}\n";
		my %done;
		my $count = 0;

		foreach my $first (@firsts) { 

			print TEXOUT $tabular;
			print TEXOUT "\\hline\n";
			print TEXOUT "\\sout{ " if $entry_strike{$first} || $judge->school == $first->school;
			print TEXOUT Tab::texify($first->name);
			print TEXOUT "} " if $entry_strike{$first} || $judge->school == $first->school;

			print TEXOUT " & ";

			my $second = $seconds[$count] if $seconds[$count];
			print TEXOUT "\\sout{ " if $entry_strike{$second} || $judge->school == $second->school;
			print TEXOUT Tab::texify($second->name) if $second;
			print TEXOUT "} " if $entry_strike{$second} || $judge->school == $second->school;

			print TEXOUT "\\\\  \\hline";
			print TEXOUT "\\end{tabular} \n \\newline \n";

			$count++;

		}

		print TEXOUT "\\pagebreak\n";
		print TEXOUT "\\newline\n";

	}

	close TEXOUT;

	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1);

</%init>


