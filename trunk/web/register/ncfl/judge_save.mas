<%args>
	$circuit
	$tourn
	$school_id => undef
	$chapter_id => undef
	$diocese_id
	$first
	$last
	$notes => undef
	$err => undef
	$judge_id => undef
	$pool_id => undef
	$group_id
	$cfl_tab_first => undef
	$cfl_tab_second => undef
	$cfl_tab_third => undef
	$alt_group => 0
	$spare_pool => 0
</%args>
<%init>

	my $group = Tab::JudgeGroup->retrieve($group_id);
    my @classes = $group->classes;

	my $school = Tab::School->retrieve($school_id) if $school_id;

	if ($chapter_id) { 	
	
		my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	    my @schools = Tab::School->search( tournament => $tourn->id, chapter => $chapter->id );
	    $school = $schools[0] if @schools;

    	unless (@schools) {
    	    $school = Tab::School->create({
      	      tournament => $tourn->id,
      	      chapter => $chapter_id,
      	      name => $chapter->name,
      	      code => $chapter->code($circuit),
      	      region => $chapter->region($circuit)->id
			});
    	}
	}

	if ($judge_id) { 

		my $judge = Tab::Judge->retrieve($judge_id);
		$judge->school($school->id);
		$judge->prelim_pool($pool_id);
		$judge->first($first);
		$judge->last($last);
		$judge->notes($notes);
		$judge->spare_pool($spare_pool);
		$judge->alt_group($alt_group);
		$judge->cfl_tab_first($cfl_tab_first);
		$judge->cfl_tab_second($cfl_tab_second);
		$judge->cfl_tab_third($cfl_tab_third);
		$judge->update;

		foreach my $class (@classes) {
			my @existing_jc = Tab::JudgeClass->search( judge => $judge_id, class => $class->id);
			if (@existing_jc) {
				my $argkey = "class_qual_".$class->id;
				$existing_jc[0]->qual($ARGS{$argkey});
				$existing_jc[0]->update;
			}
		}

		$err = "Changes to Judge $last saved ";

	} else { 

		my $judge = Tab::Judge->create({
			tournament => $tourn->id,
			judge_group => $group_id,
			first => $first,
			last => $last,
			notes => $notes,
			spare_pool => $spare_pool,
			alt_group => $alt_group,
			active => 1,
			cfl_tab_first => $cfl_tab_first,
			cfl_tab_third => $cfl_tab_third,
			cfl_tab_second => $cfl_tab_second,
			school => $school->id,
			prelim_pool => $pool_id
		});


		foreach my $class (@classes) {
			my $argkey = "class_qual_".$class->id;
			my $qual = $ARGS{$argkey};

			my $judge_class = Tab::JudgeClass->create({
				tournament => $tourn->id,
				judge => $judge->id,
				class => $class->id,
				qual => $qual
			});
		}

		$judge_id = $judge->id;
	} 

	$m->redirect("$Tab::url_prefix/register/judge_edit.mhtml?id=$diocese_id&err=$err&judge_id=$judge_id");

</%init> 

