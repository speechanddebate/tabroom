<%args>
	$tourn
	$session
	$circuit
	$sort_by => "code"
</%args>
<%perl>

	my @events = sort {$a->abbr cmp $b->abbr} $m->comp("/funclib/tourn_events.mas", tourn => $tourn);
	my @groups = sort {$a->abbr cmp $b->abbr} $tourn->groups;

    my @dioceses = sort {$a->name cmp $b->name} $tourn->regions;

    if ($sort_by eq "code") {
        @dioceses = sort {$a->code cmp $b->code} @dioceses;
        @dioceses = sort {length($a->code) <=> length($b->code)} @dioceses;
    }

    if ($sort_by eq "quota") {
        @dioceses = sort {$b->quota cmp $a->quota} @dioceses;
    }

	my $entrytotal;
	my $judgetotal;
	my $ubertotal;

	my $filename = "dio-packetcount-".$circuit->short_name."-tourn-".$tourn->id."-".$session->id;
	my $filepath = $Tab::file_root."/tmp/".$filename;

	my $now = DateTime->now;	
	$now->set_time_zone($circuit->timezone);
	
	my $garbage = `rm -f $filepath.*`;
	open (TEXOUT, ">$filepath.tex");

	my $texheader = "
			\\documentclass[10pt]{letter}
			\\usepackage{fullpage}
			\\usepackage{colortbl}
			\\usepackage[hmargin=1in,vmargin=1.25in]{geometry}
			\\usepackage{helvet}
			\\renewcommand{\\familydefault}{\\sfdefault}
			\\renewcommand{\\arraystretch}{1.3}

			\\setlength{\\oddsidemargin}{-.2in}     % default=0in
			\\setlength{\\textwidth}{9.5in}       % default=9.5in

			\\setlength{\\textheight}{6.0in}      % default=5.15in
			\\setlength{\\topmargin}{-0.15in}     % default=0.20in
			\\setlength{\\headsep}{0.15in}        % default=0.35in
	
			\\setlength{\\parskip}{1.2ex}
			\\setlength{\\parindent}{0mm}
			\\begin{document}
			\\begin{center}
";



	print TEXOUT $texheader;

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{cccc}\n";
	print TEXOUT "\\multicolumn{4}{c}{\\Large Packet Stuffing Counts }\\\\ \n";
	print TEXOUT "\\small {\\bf Tournament}: & \\small ".&Tab::texify($tourn->name)." & ";
	print TEXOUT "\\small {\\bf Printed}: & \\small ". $now->day_abbr." ".$now->month_name." ".$now->day.", ".$now->year." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $tabular_string = "\\begin{tabular}{|p{.3in}p{1.5in}|p{.3in}";

	foreach my $event (@events) { 
		$tabular_string .= "p{.2in}";
	}

	$tabular_string .= "|p{.3in}";

	foreach my $group (@groups) { 
		$tabular_string .= "p{.2in}";
	}

	$tabular_string .= "|p{.4in}|}\n";

	print TEXOUT $tabular_string;	

	my $index = "\\rowcolor[rgb]{1,.95,.95}\[5.5pt\]\[5.5pt\]\n";
	$index .= " Dio & Diocese Name & Kids & ";

	foreach my $event (@events) { 
		$index .= $event->abbr." & ";
	}

	$index .= " Judge & ";

	foreach my $group (@groups) { 
		$index .= $group->abbr." & ";
	}

	$index  .= " Total \\\\ \n";

	print TEXOUT "\\hline \n";
	print TEXOUT $index;
	print TEXOUT "\\hline \n";

	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $switch; 

	foreach my $diocese (@dioceses) { 

		if ($switch == 24) { 

			print TEXOUT $tabular_string;
			print TEXOUT "\\hline \n";
			print TEXOUT $index;
			print TEXOUT "\\hline \n";
			print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\newline\n";
	
			$switch = -1; 

		}

		print TEXOUT $tabular_string;
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		my @entries = $diocese->active_entries($tourn);
		my @judges = $diocese->judges($tourn);

		my %count_c_by_event = ();
		my %count_j_by_group = ();	

		my $entry_count = scalar @entries;

		foreach (@entries) {    
		
			$count_c_by_event{$_->event->id}++;

			if ($_->event->team == 2) {
				$count_c_by_event{$_->event->id}++;
				$entry_count++;
			}
		}

		foreach (@judges) {    $count_j_by_group{$_->judge_group->id}++; }

		print TEXOUT  $diocese->code." & ";
		print TEXOUT  $diocese->name." & ";

		print TEXOUT  $entry_count." & ";

		foreach my $event (@events) { 
			print TEXOUT $count_c_by_event{$event->id}." & ";
		}

		print TEXOUT  scalar @judges." & ";

		foreach my $group (@groups) { 
			print TEXOUT $count_j_by_group{$group->id}." & ";
		}

		print TEXOUT ($entry_count + scalar @judges)." \\\\ \n";

		print TEXOUT "\n \\hline \n" if $switch == 24;
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";

		$entrytotal += $entry_count;	
		$judgetotal += scalar @judges;	

		$ubertotal += $entry_count;
		$ubertotal += scalar @judges;

	}


	print TEXOUT $tabular_string;

	print TEXOUT "\\hline \n";

	print TEXOUT "\\rowcolor[rgb]{1,.95,.95}\[5.5pt\]\[5.5pt\]\n";

	print TEXOUT " &  TOTALS: & ";

	print TEXOUT $entrytotal." & ";

	foreach my $event (@events) { 
		print TEXOUT $event->count_active_entries." & ";
	}

	print TEXOUT $judgetotal." & ";

	foreach my $group (@groups) { 
		print TEXOUT $group->count_judges." & ";
	}

	print TEXOUT $ubertotal." \\\\ \n";
	print TEXOUT "\\hline \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\end{center}\n";
	print TEXOUT "\\end{document}\n";


	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path -l $filename.dvi`;

#	`rm -f $filepath.tex $filepath.log $filepath.dvi $filepath.aux`;

	$m->redirect("$Tab::url_prefix/tmp/".$filename.".pdf");


</%perl>
