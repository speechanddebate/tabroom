<%args>
$tourn
$league
$session
$sort_by
</%args>
<%init>

my @dioceses = sort {$a->name cmp $b->name} $tourn->regions;

if ($sort_by eq "code") {
	@dioceses = sort {$a->code cmp $b->code} @dioceses;
	@dioceses = sort {length($a->code) <=> length($b->code)} @dioceses;
}

if ($sort_by eq "quota") {
	@dioceses = sort {$b->quota cmp $a->quota} @dioceses;
}


my $filename = "dioceses-".$league->short_name."-tourn".$tourn->id."-".$session->id;
    if ($sort_by eq "quota") {
        @dioceses = sort {$b->quota cmp $a->quota} @dioceses;
    }
my $filepath = $Tab::file_root."/tmp/".$filename;

my $now = DateTime->now;	
$now->set_time_zone($league->timezone);

my $garbage = `rm -f $filepath.*`;
open (TEXOUT, ">$filepath.tex");

my $texheader = "
\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{multirow}
\\usepackage{colortbl}
\\usepackage[hmargin=1in,vmargin=1.25in]{geometry}
\\usepackage{helvet}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}
\\begin{document}
\\addtolength{\\textwidth}{1in}
\\addtolength{\\voffset}{-.5in}";

	print TEXOUT $texheader;
	
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\begin{tabular}{p{1.0in}p{2.0in}p{1.0in}p{2.0in}}\n";
	print TEXOUT "\\multicolumn{4}{c}{\\Large Dioceses in Attendance }\\\\ \n";
	print TEXOUT "\\small {\\bf Tournament}: & \\small ".&Tab::texify($tourn->name)." & ";
	print TEXOUT "\\small {\\bf Printed}: & \\small ". $now->day_abbr." ".$now->month_name." ".$now->day.", ".$now->year." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \\hline \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\begin{center}\n";
	print TEXOUT "\\begin{tabular}{p{.75in}p{3in}p{1in}}\n";
	print TEXOUT "Code & Name & \\# Schools\\\\ \n";
	print TEXOUT "\\hline \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $switch; 

	foreach my $diocese (@dioceses) { 

		print TEXOUT "\\begin{tabular}{p{.75in}p{3in}p{1in}}\n";
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		print TEXOUT &Tab::texify($diocese->code)." & ";

		if ($diocese->arch) { 
			print TEXOUT "The Archdiocese of "
		} else { 
			print TEXOUT "The Diocese of "
		}			
	
		print TEXOUT &Tab::texify($diocese->name)." & ";
		print TEXOUT scalar $diocese->schools( tournament => $tourn->id)." \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";
	}

	print TEXOUT "\\end{center} \n";
	print TEXOUT "\\end{document} \n";
	close TEXOUT;

	$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

#	`rm -f $filepath.tex $filepath.log $filepath.dvi $filepath.aux`;

	$m->redirect("$Tab::url_prefix/tmp/".$filename.".pdf");

</%init>
