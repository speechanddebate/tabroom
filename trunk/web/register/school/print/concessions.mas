<%args>
	$school
	$filename
	$second => undef
</%args>
<%init>
		
	my @all_orders = Tab::ConcessionPurchase->search( school => $school->id);
	return unless @all_orders;

	my $tourn = $school->tourn;

	use POSIX;

	my $filepath = $Tab::file_root."tmp/".$filename; 
	
	my $now = DateTime->now;	
	$now->set_time_zone($tourn->tz);

	my $label = $tourn->setting("concessions_label");
	$label = "Concessions" unless $label;

	my $total; 

	print TEXOUT "\\newpage\n" if $second;

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\smallskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "{\\LARGE\\bf ". $label." }\\\\ \n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{1in}p{2.75in}p{1in}p{2in}}\n";

	print TEXOUT "{\\bf School:} & ". &Tab::texify($school->name) ." & ";
	print TEXOUT "{\\bf Entry Number:} & ".sprintf('%05d', $school->id) ."\\\\ \n";

	print TEXOUT "{\\bf Tournament:} & ". &Tab::texify($tourn->name) ." & ";
	print TEXOUT "{\\bf Circuit(s):} & ". &Tab::texify($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn, print_abbr => 1)) ." \\\\ \n";

	my @contacts = $m->comp("/funclib/tourn_admins.mas", tourn => $tourn, contact => 1);
	my $contact_string;

	foreach my $contact (@contacts) {
		$contact_string .= " & " if $contact_string;
		$contact_string .= $contact->first." ".$contact->last;
	}
	
	print TEXOUT "{\\bf Contact(s):} & ". &Tab::texify($contact_string)." & ";

	print TEXOUT "{\\bf Printed:} & ";
	print TEXOUT $now->month."/".$now->day."/".$now->year." ";
	print TEXOUT $now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \n";

	print TEXOUT "\\end{tabular} \n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "{\\Large\\bf  }\\\\ \n";
	print TEXOUT "\\newline\n";


print TEXOUT <<'EOF';
\tt
\begin{tabular}{p{.5in}p{4.5in}p{1.35in}}
\rowcolor[rgb]{1,.95,.95} Qty & Item & Total \\
\end{tabular}
\newline
EOF

	my $count;

	foreach my $concession (sort {$a->name cmp $b->name} $tourn->concessions) {

		my @orders = Tab::ConcessionPurchase->search( school => $school->id, concession => $concession->id );

		my $quantity;

		foreach my $order (@orders) { 
			$quantity += $order->quantity;
		}
		
		next unless $quantity;

		print TEXOUT "\\begin{tabular}{p{.5in}p{4.5in}p{1.35in}}\n";
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($count++ % 2);

		print TEXOUT $quantity." & ";
	   	print TEXOUT &Tab::texify($concession->name)." & ";
		my $cost = $concession->price * $quantity;
		$total += $cost;
		print TEXOUT "\\\$".&Tab::texify(sprintf ("%.2f", $cost));
		print TEXOUT " \\\\ \n\\end{tabular}\n";
		print TEXOUT "\\newline\n";

	}

	print TEXOUT "\\begin{tabular}{p{.5in}p{4.5in}p{1.35in}}\n";
	print TEXOUT "\\multicolumn{3}{c}{ }\\\\ \n";

	print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\] ";
	print TEXOUT ' & {\\bf CONCESSIONS TOTAL: } & \\$'. sprintf ("%.2f", $total)."\\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	close TEXOUT;

	return;

</%init>
