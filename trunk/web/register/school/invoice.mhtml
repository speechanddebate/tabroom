<%args>
	$tourn
	$school_id => undef
	$show_deleted => undef
</%args>
<%init>

	unless ($school_id) { 
		$m->print("No school id sent. Go back and try again");
		$m->abort;
	}

	my $school = Tab::School->retrieve($school_id);
	my ($total, $feline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school_id, show_deleted => $show_deleted);
	my @felines = @{$feline_ref};

	my ($paid, $payline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school_id, payments =>"whyyespleasethankyou");
	my @paylines = @{$payline_ref};
	my $switch; 

	my $concessions = $tourn->setting("concession_invoice");
	my $label = $tourn->setting("concession_name");

	my ($con_total, $conline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school_id, concessions_only =>"Yes");
	my @conlines = @{$conline_ref};
	my $symbol = $tourn->setting("currency");

</%init>

 <& /register/menubar.mas, school => $school, whoami =>"money", tourn => $tourn &>

		<br />

		<h4>Fees for <% $school->name %></h4>

%		foreach my $line (@felines) { 

			<div class="<% ($switch++ % 2) ? "odd" : "even" %> <% $line->{'deleted'} ? "strike" : "" %> padmuchmore">

%				if ($line->{'fee'}) { 

					<span class="threefifths">
						<%$line->{'name'} %>
					</span>
			
					<span class="quarter">
						<% $symbol %> <% sprintf ("%.2f", $line->{'fee'}) %>
					</span>

					<span class="eighth">
%						if ($line->{'fine_id'}) {
							<a href="fine_forgive.mhtml?fine_id=<% sprintf ("%.2f", $line->{'fine_id'}) %>"class="dkblue block">
								Forgive & Forget
							</a>
%						}
					</span>

%				} else { 

					<span class="full">
						<%$line->{'name'} %>
					</span>
%				}

			</div>

%		} 


%		if (@conlines) { 

%			unless ($concessions eq"combined") { 

				<h4>
					<% $label ? $label :"Concession"%> Fees for <% $school->name %>
				</h4>

%				foreach my $line (@conlines) { 

					<div class="<% ($switch++ % 2) ? "odd" : "even" %> <% $line->{'deleted'} ? "strike" : "" %> padmuchmore">

						<span class="threefifths">
							<%$line->{'name'} %>
						</span>
				
						<span class="quarter">
							$<% sprintf ("%.2f", $line->{'fee'}) %>
						</span>

					</div>
%				}
%			}
%		}

		<div class="ltyellow bordertop strong padmuchmore">
				
			<span class="threefifths rightalign">
				Entry Fee Total
			</span>

			<span class="quarter">
				<% $symbol %> <% sprintf ("%.2f", $total) %>
			</span>

		</div> 

%		if ($tourn->concessions && $concessions ne"combined") { 

%			$total += $con_total;

			<div class="libl padmuchmore">
				
				<span class="threefifths rightalign">
					<% $label ? $label :"Concessions"%> Total
				</span>
				
				<span class="quarter">
					<% $symbol %> <% sprintf ("%.2f", $con_total) %>
				</span>

			</div>
				
			<div class="ltyellow padmuchmore">
				
				<span class="threefifths rightalign">
					Overall Total
				</span>

				<span class="quarter">
					<% $symbol %> <% sprintf ("%.2f", $total) %>
				</span>

			</div>
				
%		}

		<h4>Payments</h4> 
	
%			foreach my $line (@paylines) { 

				<div class="<% ($switch++ % 2) ? "odd" : "even" %> <% $line->{'deleted'} ? "strike" : "" %> padmuchmore">

%					if ($line->{'fee'}) { 

						<span class="threefifths">
							<%$line->{'name'} %>
						</span>
			
						<span class="quarter">
							<% $symbol %> <% sprintf ("%.2f", $line->{'fee'}) %>
						</span>

						<span class="eighth rightalign">
%							if ($line->{'fine_id'}) {
								<a href="fine_forgive.mhtml?fine_id=<% sprintf ("%.2f", $line->{'fine_id'}) %>"class="dkblue block">
									Remove
								</a>
%							}
						</span>

%					} else { 
						
						<span class="full rightalign">
							<%$line->{'name'} %>
						</span>
%					}

				</div>

%			} 

		<div class="ltyellow bordertop strong padmuchmore">
				
			<span class="threefifths rightalign">
				Total Still Due
			</span>

			<span class="quarter">
				<% $symbol %> <% sprintf ("%.2f", $total - $paid) %>
			</span>

		</div> 

	</div>

	<div class="menu"> 

		<div class="sidenote">

			<h4>Money printouts</h4>

			<a href="invoice_print.mhtml?school_id=<% $school->id %>"class="green block">
				Print Entry Fee Invoice
			</a>

			<a href="concessions_print.mhtml?school_id=<% $school->id %>"class="green block">
				Print Concessions Invoice
			</a>

			<a href="combined_print.mhtml?school_id=<% $school->id %>"class="green block">
				Print Combined Invoice
			</a>

		</div>


		<div class="sidenote">
	
			<h4>Add charges</h4>

			<div class="smaller centeralign">
				(Use negative values for credits)
			</div>

			<div class="even">
				<span class="third">
					Reason
				</span>
				<span class="twothird rightalign">
					<form action="fine_add.mhtml"method="post">
					<input type="hidden"name="school_id"value="<% $school_id %>">
					<input type="text"name="reason"size="16">
				</span>
			</div>

			<div class="odd">
				<span class="third">
					Amount
				</span>
				<span class="twothird rightalign">
					<% $symbol %> <input type="text"name="amount"size="10">
				</span>
			</div> 
				
			<div class="libl rightalign">
				<input type="submit"class="thin"value="Add Fine">
				</form>
			</div>

		</div>

		<div class="sidenote">

			<h4>Record payments</h4>

			<div class="even">
				<span class="third">
					Memo
				</span>
					
				<span class="twothirds rightalign">
					<form action="payment_save.mhtml"method="post">
					<input type="hidden"name="school_id"value="<% $school_id %>">
					<input type="text"name="reason"size="16"placeholder="Check #, etc">
				</span>
			</div>

			<div class="odd">

				<span class="third">
					Amount
				</span>

				<span class="twothirds rightalign">
					<% $symbol %> <input type="text"name="amount"size="10">
				</span>

			</div>
				
			<div class="libl rightalign">
				<input type="submit"class="thin"value="Record Payment">
				</form>
			</div>

		</div>

	</div>

	<br style="clear: both;">


