<%args>
	$tourn
	$circuit
	$chapter_id => undef
	$school_id => undef
	$account
</%args>
<%init>

	use POSIX;

	my $chapter;
	my $school;

	unless ($school_id || $chapter_id) { 
		my $err = "You have accessed the registration page incorrectly.  Please try again.";
		$m->redirect("$Tab::url_prefix/register/registration.mhtml?err=$err");
	}

	if ($chapter_id) { 
		$chapter = Tab::Chapter->retrieve($chapter_id);
	}

	if ($school_id) {
		$school = Tab::School->retrieve($school_id);
		$chapter = $school->chapter;
	}

	my $switch;

</%init>

	<& /register/menubar.mas, school => $school, whoami => "judges", tourn => $tourn &>


		<table cellpadding="5" cellspacing="1" width="100%">

%			foreach my $group ($tourn->groups) { 

%				my @judges = $school->judges( judge_group =>  $group->id );
%				push (@judges, $school->judges( alt_group => $group->id));

%				next unless @judges;

				<tr>
					<td colspan="5">
						<h4><% $group->name %></h4>
					</td>
				</tr>

% 				foreach my $judge (@judges) { 

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

						<td>
							<a class="normal white block" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
								<% $judge->code %>
							</a>
						</td>

						<td>
							<a class="normal white block" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
								<% $judge->first." ".$judge->last%>
							</a>
						</td>

						<td class="centeralign">
							<% ($judge->covers && $judge->covers->id > 0 && $judge->covers->id != $judge->judge_group->id) ? "Counts as ".$judge->covers->abbr : "" %>
						</td>

%						if ($group->setting('coach_ratings')) { 

							<td class="centeralign">
								<% $m->comp("/funclib/judge_rating.mas", judge => $judge, print => 1) %>
							</td> 

%						} else { 
	
							<td></td>

%						}

						<td class="centeralign">
							<a class="dkgreen block" href="/register/judge/drop.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>">
								Drop
							</a>
						</td>
	
					</tr>

% 				} 

%			} 

		</table>

	</div>

	<div class="right small">

		<div class="sidenote">
		
		<h4>Judge Groups</h4>

		<a class="white block">Red means below obligation:</a>

%		my $hires;

%		foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%			$hires++ if $group->setting("track_judge_hires");

%			my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group); 
%			my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_useful_by_group.mas", school => $school, group => $group);
%			my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", school => $school, group => $group);

				<a href="/register/judge/add.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" 
					class="<% ($uncovered < 1) ? "blue block" : "dkred block" %>">
						<span style="float: left;  width: 160px;">Add in <% substr($group->abbr,0,15) %></span>
					<% scalar @useful_judges %>/<% $obligation %>
					<% ($uncovered < 1) ? " " : "Unmet" %> 
					<% ($uncovered < 1 && (scalar @useful_judges < $obligation) ) ? "+ Hires " : "" %> 
				</a>


%			if ($group->setting("deadline")) {

%				my $deadline = $group->setting("deadline");
%				$deadline->set_time_zone($tourn->tz);

				<a href="/user/tourn/entry/judge_add.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="yellow block">
					**<% $group->abbr %> due: <% &Tab::niceshortdt($deadline) %>
				</a>

%			}

%		}

		<br />

%		if ($hires) { 
			<a class="blue block" href="school_hires.mhtml?school_id=<% $school->id %>">Judge Hires</a>
			<br />
%		}

		</div>

	</div>

