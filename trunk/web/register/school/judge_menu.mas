<%args>
	$tourn
	$school
	$group => undef
</%args>
<%init>

	my $switch;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<div class="right small">

%		if ($group) { 

			<div class="sidenote">

			<h4>Add Judges:</h4>

%			my @chapter_judges = $m->comp("/funclib/chapter_judges_free.mas", school => $school);
%			my $now = DateTime->now;

%			if (@chapter_judges) { 

				<table cellpadding="3" cellspacing="1" width="100%">

					<tr>
						<td class="centeralign">

							<form action="judge_save.mhtml" method="post">
							<input type="hidden" name="group_id" value="<% $group->id %>">
							<input type="hidden" name="school_id" value="<% $school->id %>">
	
							<select name="chapter_judge_id" size="7" class="fixedmedsmall">
%								foreach my $chapter_judge (sort {$a->last cmp $b->last} @chapter_judges) { 
									<option value="<% $chapter_judge->id %>"><% $chapter_judge->last.", ".$chapter_judge->first %></option>
%								}
							</select>
						</td>
					</tr>

					<tr class="liblrow">

						<td class="rightalign">
							<input type="submit" class="thin" value=" Enter Judge">
							</form>
						</td>
		
					</tr>

				</table>

%			}

			<a class="yellow block" href="add.mhtml?from=<% $group->id %>&chapter_id=<% $school->chapter->id %>">
				Add Judge Not On Roster
			</a>

			<hr />
	
			<h4>Judge groups</h4>

%			foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%				my $group_deadline = $group->setting("deadline");
%				$group_deadline->set_time_zone($tz) if $group_deadline;

%				my $unc = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group); 
%				my @group_judges = $m->comp("/funclib/judgemath/judges_by_group.mas", school => $school, group => $group);
%				my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", school => $school, group => $group);

%				my $rounds;
%				if ($group->setting("rounds_per")) { 
%					foreach my $judge (@group_judges) { 
%						$rounds += $judge->obligation;
%					}
%				}

				<a href="judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="<% ($unc < 1) ? "blue" : "dkred" %>  block nowrap">

					<span style="float: left; width: 100px; margin-right: 15px;" class="nowrap">
						<% substr($group->name,0,22) %>
					</span>

					<% $rounds ? $rounds : scalar @group_judges %>/<% $obligation %>
					<% ($unc < 1) ? " " : " Under" %> 
					<% ($rounds) ? ($unc < 1 && ($rounds && $rounds < $obligation) ) ? "+ Hires" : "" : ($unc < 1 && scalar @group_judges < $obligation) ? "+ Hires " : "" %> 
				</a>
	

%				if ($group_deadline) {
					<a href="judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" class="white block">
						**<% $group->abbr %> Judges due: <% &Tab::niceshortdt($group_deadline->set_time_zone($tz)) %>
					</a>

%				}

%			}

			</div>

%		}

	<div class="sidenote">
		
		<h4>Judge Groups</h4>

		<a class="white block">Red means below obligation:</a>

%		my $hires;

%			foreach my $group (sort {$a->name cmp $b->name} $tourn->groups) {

%				$hires++ if $group->setting("track_judge_hires");
	
%				my $uncovered = $m->comp("/funclib/judgemath/uncovered_burden_by_group.mas", school => $school, group => $group); 
%				my (@useful_judges, @dontcount) = $m->comp("/funclib/judgemath/judges_by_group.mas", school => $school, group => $group);
%				my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_group.mas", school => $school, group => $group);

				<a href="judges.mhtml?school_id=<% $school->id %>&group_id=<% $group->id %>" 
					class="<% ($uncovered < 1) ? "blue" : "dkred" %> block nowrap">
						<span class="nowrap" style="float: left;  width: 110px;"><% $group->name %></span>
					<% scalar @useful_judges %>/<% $obligation %>
					<% ($uncovered < 1) ? " " : "Unmet" %> 
					<% ($uncovered < 1 && (scalar @useful_judges < $obligation) ) ? "+ Hires " : "" %> 
				</a>

%			}

		</div>

	</div>

