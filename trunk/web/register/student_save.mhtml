<%args>
	$account
	$chapter_id => undef
	$event_id => undef
	$first
	$last
	$phonetic => undef
	$grad_year
	$tourn
	$student_id => undef
	$novice => 0
	$retired => 0
	$gender => undef
</%args>
<%init>
#/

	unless ($student_id) { 
	
		my $chapter = Tab::Chapter->retrieve($chapter_id);
		my @schools = Tab::School->search( tournament => $tourn->id, chapter => $chapter_id);
		my $school = shift @schools;

		unless ($school) { 
			my $err = "That school is not entered in your tournament";
			$m->redirect("$Tab::url_prefix/register/registration.mhtml?err=$err");
		}

		my $student = Tab::Student->create({ 
			first => $first,
			last => $last,
			phonetic => $phonetic,
			grad_year => $grad_year,
			chapter => $chapter,
			novice => $novice,
			retired => $retired,
			gender => $gender
		});

		my $err = "Student $first $last saved in ". $school->name;

		if ($event_id) { 
			$m->redirect("$Tab::url_prefix/register/comp_enter.mhtml?err=$err&school_id=".$school->id."&event_id=$event_id");
		} else {
			$m->redirect("$Tab::url_prefix/register/school_editentry.mhtml?err=$err&school_id=".$school->id);
		}
		
	}  else  {

		my $student = Tab::Student->retrieve($student_id); 
		my $chapter = $student->chapter;
		my @schools = Tab::School->search( tournament => $tourn->id, chapter => $chapter->id);
		my $school = shift @schools;

		if ($student->first ne $first || $student->last ne $last) { 

			my $regline = $account->first." ".$account->last.": ".$student->first." 
				".$student->last." becomes $first $last. Entries: ";
			
			foreach my $entry ($student->entries($tourn)) { 
				system "$Tab::logger Adding entry ".$entry->code;
				$regline .= "<a href=\"/register/comp_edit.mhtml?comp_id=".$entry->id."\">".$entry->code."</a> ";
			}

			system "$Tab::logger $regline";

    	    my $change = Tab::Change->create({ 
    	        tournament => $tourn->id,
				school => $school->id,
	            type => "registration",
	            regline => $regline,
	        });

		}
		
		$student->first($first);
		$student->last($last);
		$student->phonetic($phonetic);
		$student->grad_year($grad_year); 
		$student->novice($novice);
		$student->retired($retired);
		$student->gender($gender);
		$student->update;
	

		my $msg = "Changes saved to student $first $last";
		$m->redirect("$Tab::url_prefix/register/student_edit.mhtml?msg=$msg&student_id=$student_id");
	
	}

</%init>

