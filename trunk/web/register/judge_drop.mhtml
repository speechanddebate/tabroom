<%args>
	$tourn
	$account
	$session
	$judge_id
	$certain => undef
	$autoassign => undef
	$school_id => undef
</%args>
<%init>

	my $err;

	my $judge = Tab::Judge->retrieve($judge_id);

	unless ($judge) { 

		$m->print("That judge does not exist.  Perhaps you tried to drop the same judge twice?");
		$m->abort;
	}

	if ($autoassign == 1) {

		my @panels = $judge->panels;
		foreach my $panel (@panels) { 

			my @clean_judges = $m->comp("/funclib/clean_judges.mas", 
									panel_id => $panel->id,
									session => $session );

			$m->comp("/panel/judges_trade.mas", 
						panel_id => $panel->id, 
						old_judge_id => $judge_id,
						new_judge_id => $clean_judges[0]->id) if @clean_judges;

			unless (@clean_judges) { 

				my @ballots = Tab::Ballot->search( panel => $panel->id, judge => $judge_id);
				foreach my $ballot (@ballots) { $ballot->judge(""); 
												$ballot->update; }
				$err = $err. " Panel ".$panel->letter." of ". $panel->event->name ." in round ". $panel->round->name ." had no replacement judge "; 

			}
		}
	}
	
	my $group_id = $judge->judge_group->id;

	if ($certain eq "I am certain") { 

		my @panels = $judge->panels;
		foreach my $panel (@panels) { 

			my @tot_judges = $panel->judges;
			my $num_judges = scalar @tot_judges;
			next if ($num_judges > 1);

			my @ballots = Tab::Ballot->search( panel => $panel->id, judge => $judge_id);
			foreach my $ballot (@ballots) { $ballot->judge(""); 
											$ballot->update; }
		}

		my $regline = $account->first." ".$account->last." dropped judge ".$judge->code;

		my $ch_school_id = $judge->school->id if $judge->school;

        my $change = Tab::Change->create({
            tournament => $tourn->id,
            school => $ch_school_id,
            type => "registration",
            regline => $regline
        }); 

		system "$Tab::eventlogger $regline";

		$judge->delete;

		$m->redirect("$Tab::url_prefix/register/school_judges.mhtml?school_id=$school_id&err=$err") if $school_id;
		$m->redirect("$Tab::url_prefix/register/search.mhtml?group_id=$group_id");
		$m->redirect("$Tab::url_prefix/register/judge/hires.mhtml?group_id=$group_id");
	}

</%init>

<&  "/funclib/warning.mas", account => $account &>

<h3></h3>
<p></p>
<br><br>
<br><br>
<center>
<P><B>You are about to permanently drop Judge <% $judge->first." ".$judge->last %>'s entry.
</b></p> 

<p>This cannot be undone.  You can only get it back by re-entering it again.
If the judge has current active assignments, they will be deleted, along with
scores given to competitors.  If you merely want to not us a judge anymore,
mark them as inactive on their judge info screen.</p>

<p>Don't say I didn't warn you.</p>

% if ($certain) {

<p><font color="red">You did not type "I am certain", exactly like that.  Try
again</font></p>

% }

<br><br>
<p>To proceed, type "I am certain" in the box below:</p>
<br><br>
<form action="judge_drop.mhtml" method="post">
<input type="hidden" value="<% $judge_id %>" name="judge_id">
<input type="hidden" value="<% $school_id %>" name="school_id">
<p align="center">
<input type="text" name="certain" size="20"></p>
<p align="center">
Auto re-assign panels: <input type="checkbox" name="autoassign" value="1" checked>
</p>
<p align="center">
<input  type="submit" value="Drop Judge"></p>
</center>
</form>
