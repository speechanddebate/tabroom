<%args>
	$judge_id
	$school_id
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $school = Tab::School->retrieve($school_id);

	unless ($judge && $school ) { 
		$m->print("I have no judge or school.  Hit back and try again");
		$m->abort();
	}

	my $group = $judge->judge_group;
	my $tourn = $group->tourn;

	my $rounds_per = $group->setting("rounds_per") if $group;

	my $switch;

</%init>

	<div class="main"> 

		<h2>Additional details needed</h2> 

		<form action="judge_details_save.mhtml" method="post">
		<input type="hidden" name="judge_id" value="<% $judge->id %>">
		<input type="hidden" name="school_id" value="<% $school->id %>">

%		if ($group->setting("judge_quals")) { 

			<div class="<% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="twofifth">
					<h4>Qualification History</h4>

					<p class="padless marless">
						Please provide a summary of tournaments and number of rounds judged
						at this level (High school, college, etc) in the past year.
					</p>
				</span>

				<span class="threefifth">
					<textarea name="qual_history" rows="5" cols="60"><% $judge ? $judge->setting("qual_history") : "" %></textarea>
				</span>

			</div>

%		}


%		if ($group->setting("coach_ratings")) { 

			<h4>Rate this judge</h4>

%			if ($group->rating_subsets) { 

%				foreach my $subset ($group->rating_subsets) { 

%					my $rating = $judge->ratings( rating_subset => $subset->id )->first;
%					my $tier = $rating->rating_tier if $rating;
	
					<div class="yellow">
	
						<span class="third">
							<h4>
								<% $subset->name %> 
							</h4>
						</span>

						<span class="twothird">
							<h5>
%								my $notfirst;
%								foreach my $event ($subset->events) { 
									<% ($notfirst) ? ", " : "" %>
									<% $event->name %>
%									$notfirst++;
%								}
							</h5>
						</span>

					<div>

%					foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) {

						<label for="<% $subset->id."-".$tier->id %>">
						<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> hover"> 

							<span class="quarter padtop">
								<input type="radio" name="<% $subset %>" value="<% $tier->id %>" id="<% $subset->id."-".$tier->id %>" 
									<% ($rating && $rating->rating_tier && $rating->rating_tier->id == $tier->id) ? "checked" : "" %>>
							</span>

							<span class="quarter">
								<% $tier->name %>
							</span>

							<span class="half">
								<% $tier->description %>
							</span>

						</div>
						</label>

%					} 

%				}

%			} else { 

%				my $rating = $judge->ratings->first;
%				my $judge_tier = $rating->rating_tier if $rating;

%				foreach my $tier (sort {$a->name cmp $b->name} $group->rating_tiers(type => "coach")) {

					<label for="<% $tier->id %>">
						<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> hover"> 

							<span class="quarter padtop">
								<input type="radio" name="rating_id" value="<% $tier->id %>" id="<% $tier->id %>"
									<% ($judge_tier && $tier->id == $judge_tier->id) ? "checked" : "" %>>
							</span>

							<span class="quarter padtop">
								<% $tier->name %>
							</span>

							<span class="half">
								<% $tier->description %>
							</span>

						</div>
					</label>

%				} 

%			}


		<br style="clear: both;">

%	}

%	if ($group->setting("ask_alts")) { 

			<div <% ($switch++ % 2) ? "class=\"odd\"" : "class=\"even\"" %>> 
				
				<span class="half">
					Also judges group:
				</span> 
				
				<span class="half">
					<select name="alt_id">
					
						<option value="">
							None Selected
						</option>

%						foreach my $ogroup (sort {$a->name cmp $b->name} $tourn->groups) { 

%						   next if $group->id == $ogroup->id;
%						   next if $group->setting("tab_room");

							<option value="<% $ogroup->id %>" <% ($ogroup->id eq $judge->alt_group->id) ? 'selected' : '' %> >
								<% $ogroup->name %>
							</option>
%					   }

					</select>

				</span>

			</div>

		
		<br style="clear: both;" />

%	}

%	if ($group->setting("diversity_selfie")) { 

		<h4>Judge Diversity</h4>

		<div class='block explain'>
			<% $group->setting("diversity_notice") %>
		</div>
	

			<div <% ($switch++ % 2) ? "class=\"odd\"" : "class=\"even\"" %>> 
				
				<span class="half">
					Diversity-enhancing judge
				</span> 
				
				<span class="half">
					<input type="checkbox" name="diverse" value="1" <% $judge->diverse ? 'checked="checked"' : "" %>>
				</span>

			</div>

		
		<br style="clear: both;" />
		
%	}

	
	<h4>
		Other Details
	</h4>

%		if ($rounds_per) { 
			
			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="half">
					<input type="number" name="rounds" size="5" min="1" max="<% $group->setting("max_rounds") %>" value="<% $judge->obligation %>">
				</span>
			
				<span class="half">
					Prelim round judging obligation
				</span>

			</div>
%		}

		<label for="ada">
			<div class="<% ($switch++ % 2) ? "odd" : "even" %> hover optionblock">
		
				<span class="half">
					ADA/Accessible Rooms Needed
				</span>

				<span class="half">
					<input type="checkbox" id="ada" name="ada" value="1" <% $judge->ada ? "checked" : "" %>> 
				</span>

			</div>
		</label>

%		if ($group->setting("first_year_outs")) { 

			<label for="fyo">
			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> hover">

				<span class="half">
					Judge is a first-year graduate <% $group->setting("fyo_free_strikes") ? "(automatic free strike)" : "" %>
				</span>

				<span class="half">
					<input type="checkbox" id="fyo" name="fyo" value="1" <% $judge->setting("first_year") ? "checked" : "" %>> 
				</span>

			</div>
			</label>

%		}

%		if ($group->setting("free_strikes_dont_count")) { 

			<label for="free_strike">
			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> hover">

				<span class="half">
					Judge is a free strike <% $group->setting("free_strikes_dont_count") > 0 ? "(rounds will not count towards obligation)" : "" %>
				</span>

				<span class="half">
					<input type="checkbox" id="free_strike" name="free_strike" value="1" <% $judge->setting("free_strike") ? "checked" : "" %>> 
				</span>

			</div>
			</label>
%		}

%		if ($group->setting("judge_cells")) { 

			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="half">
					Judge Cell Phone Number
				</span>

				<span class="half">
					<input type="tel" name="phone" size="50" value="<% $judge ? $judge->setting("phone") : "" %>">
				</span>

			</div>

%		}


		<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> <% $judge->notes && $judge->notes eq $judge->chapter_judge->notes ? "lirdrow" : "" %> ">

			<span class="half">
				Notes.  Are these still accurate?
			</span>

			<span class="half">
				<input type="text" name="notes" size="50" value="<% $judge ? $judge->notes : "" %>">
			</span>

		</div>

%		my %strike_by_event = ();
%		foreach my $strike (Tab::Strike->search( type => "event", judge => $judge->id, registrant => 1 )) { 
%			$strike_by_event{$strike->event->id} = $strike;
%		}

%		foreach my $event ($m->comp("/funclib/event_selfstrike.mas", group => $group)) { 

			<label for="<% $event->id %>">
			<div class="optionblock <% ($switch++ % 2) ? "odd" : "even" %> hover">

				<span class="half">
					<input type="checkbox" id="<% $event->id %>" name="<% $event->id %>" value="1" 
						<% $strike_by_event{$event->id} ? "checked" : "" %>> 
				</span>

				<span class="half">
					Judge should not judge <% $event->name %>
				</span>

			</div>
			</label>

%		}


	<div class="optionblock libl rightalign">
		<input type="submit" value="  Save Details   ">
		</form>
	</div>


			
</div>

<div class="menu">

	<div class="sidenote">
		
		<h4>Judge</h4>

		<p class="even full">
			<% $judge->first." ".$judge->last %>
		</p>

		<p class="full odd">
			<% $judge->judge_group->name %>
		</p>

		<p class="full even">
			<% $judge->school ? $judge->school->short_name : "Hired Judge" %>
		</p>

%		if ($judge->account) { 
			<p class="full odd">
				Linked to: <% $judge->account->email %>
			</p>
%		}

	</div>

</div>

