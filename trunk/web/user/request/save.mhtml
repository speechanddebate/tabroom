<%args>
	$tz
	$account
	$name
	$webname
	$start
	$end
	$reg_start
	$reg_end
	$frozen
	$judge
	$drops
	$fines
	$circuit_string
	$site_id => undef
	$site_name => undef
	$state => undef
	$country => undef
</%args>
<%init>

	unless ($site_name || $site_id) { 
		my $return = "You must select an existing site, or give your site a name";
		$m->redirect("location.mhtml?name=$name&start=$start&end=$end&reg_start=$reg_start&reg_end=$reg_end&drops=$drops&judge=$judge&frozen=$frozen&fines=$fines&circuit_string=$circuit_string&state=$state&country=$country&error=$return");
	}

	my @circuits;

	foreach my $circuit_id (split(/-/, $circuit_string)) { 
		 push(@circuits, Tab::Circuit->retrieve($circuit_id));
	}

	my $default_circuit = $circuits[0];

	my $startdt = DateTime::Format::MySQL->parse_datetime($start);
	my $enddt = DateTime::Format::MySQL->parse_datetime($end);
	my $reg_startdt = DateTime::Format::MySQL->parse_datetime($reg_start);
	my $reg_enddt = DateTime::Format::MySQL->parse_datetime($reg_end);
	my $frozendt = DateTime::Format::MySQL->parse_datetime($frozen);
	my $finesdt = DateTime::Format::MySQL->parse_datetime($fines);
	my $judgedt = DateTime::Format::MySQL->parse_datetime($judge);
	my $dropsdt = DateTime::Format::MySQL->parse_datetime($drops);

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	unless ($site) { 

		$site = Tab::Site->create({
			circuit => $default_circuit->id,
			host => $account->id,
			name => $site_name
		});

		$site_id = $site->id;

	}

	my $tourn = Tab::Tourn->create( { 
		name => $name,
		webname => $webname,
		start => $startdt,
		end => $enddt,
		reg_start => $reg_startdt,
		reg_end => $reg_enddt
		hidden => 0
	});

	$tourn->setting(freeze_deadline, "date", $frozendt);
	$tourn->setting(fine_deadline, "date", $finesdt);
	$tourn->setting(judge_deadline, "date", $judgedt);
	$tourn->setting(drops_deadline, "date", $dropsdt);

	my $join = Tab::TournSite->create ({
		tournament => $tourn->id,
		site => $site_id
	});

	$join = Tab::TournAdmin->create ({
		tournament => $tourn->id,
		account => $account->id
	});

	foreach my $circuit (@circuits) { 

		my $join = Tab::TournCircuit->create ({
			tournament => $tourn->id,
			circuit => $circuit->id
		});
	}

	$m->redirect("$Tab::url_prefix/user/request/confirm.mhtml?tourn_id=".$tourn->id);

</%init>

