<%args>
	$account
	$other_id => undef
	$chapter_id => undef
	$search_email => undef
	$search_chapter => undef
	$search_last => undef
	$judge_id => undef
</%args>
<%init>

	if ($other_id) { 

		my $other = Tab::Account->retrieve($other_id);

		if ($other) { 

			my @already = Tab::AccountConflict->search( account => $account->id, conflict => $other_id );

			unless (@already) { 

				Tab::AccountConflict->create({
					account => $account->id,
					conflict => $other_id,
					added_by => $account->id,
				});

			}
			
		} 

	} 

	if ($chapter_id) { 

		my $chapter = Tab::Chapter->retrieve($chapter_id);

		if ($chapter) { 

			my @already = Tab::AccountConflict->search( account => $account->id, chapter => $chapter_id );

			unless (@already) { 

				Tab::AccountConflict->create({
					account => $account->id,
					chapter => $chapter_id,
					added_by => $account->id,
				});

			}
			
		} 

	}
	
	my @chapters;
	my @accounts;

	if ($search_email && $search_last) { 

		@accounts = Tab::Account->search_where( last => { "like", $search_last."%" }, email => { "like", $search_email."%" } );

	} elsif ($search_email) { 

		@accounts = Tab::Account->search_where( email => { "like", $search_email."%" } );

	} elsif ($search_last) { 

		@accounts = Tab::Account->search_where( last => { "like", $search_last."%" } );

	}

	if ($search_chapter) { 

		@chapters = Tab::Chapter->search_where( name => { "like", $search_chapter."%" } );

	}

	my @existings = Tab::AccountConflict->search( account => $account->id );

</%init>

	<& menu.mas, account => $account, whoami => "conflicts" &>

	<div class="left huge">

		<h2>Standing Conflicts</h2>

		<p>These conflicts are meant to reflect a personal or professional
		relationship which means it is unfair for you to judge the other
		person; such as a relative, or a former student.  Do NOT use conflicts
		against debaters you simply do not like, or the tournament directors of
		tournaments you attend will likely get very angry.</p>

		<p>The conflict must have a Tabroom.com account linked to their
		entries for a standing conflict to work automatically.</p>

		<div class="left half">

			<h4>Add Personal Conflict</h4>

			<form action="conflicts.mhtml" method="post">

			<div class="block" style="margin-bottom: 20px;">

				<span class="biggishspan evenrow">
					<input type="text" name="search_last" size="25" placeholder="Search by last name">
				</span>

				<span class="biggishspan">
					<input type="text" name="search_email" size="25" placeholder="Search by email">
				</span>

				<span class="biggishspan rightalign liblrow">
					<input type="submit" value="Search for Conflicts">
					</form>
				</span>
					
			</div>

			<h4>Add School Conflict</h4>

			<form action="conflicts.mhtml" method="post">

			<div class="block">

				<span class="biggishspan">
					<input type="text" name="search_chapter" size="25" placeholder="Search by school name">
				</span>

				<span class="biggishspan rightalign liblrow">
					<input type="submit" value="Search for Schools">
					</form>
				</span>
					
			</div>


		</div>

		<div class="right half">

%			if (@accounts || @chapters) { 

				<h4>Search Results:</h4>

%				my $switch;

%				foreach my $other (@accounts) { 

%					my @chapters;
%					my @students = Tab::Student->search( account => $other->id );
%					my @chapter_judges = Tab::ChapterJudge->search( account => $other->id );

%					foreach my $person (@chapter_judges, @students) { 
%						push @chapters, $person->chapter if $person->chapter;
%					}

					<div class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> smallish padmore">

						<span class="smallspan nowrap">
							<% $other->first %>
						</span>

						<span class="schemat nowrap">
							<% $other->last %>
						</span>

						<div style="width: 85px; vertical-align: top;" class="inline padno ">
%							foreach my $chapter (@chapters) { 
								<span class="eighty block nowrap padno ">
									<% $chapter->name %> 
								</span>
								<br />
%							}
						</div>

						<span class="smallishspan rightalign  padno">
							<a class="dkgreen block smaller centeralign" href="conflicts.mhtml?other_id=<% $other->id %>">
								Conflict
							</a>
						</span>

					</div>

%				}

%				foreach my $chapter (@chapters) { 

					<div class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> smallish">

						<span class="judgechart" style="padding-left: 4px;">
							<% $chapter->name %>
						</span>

						<span class="smallspan">
							<% $chapter->state %>
						</span>

						<span class="smallishspan rightalign">
							<a class="dkgreen block smaller centeralign" href="conflicts.mhtml?chapter_id=<% $chapter->id %>">
								Conflict
							</a>
						</span>

					</div>

%				}

%			}

			<h4>Existing Conflicts</h4>

%				my $switch;

%				foreach my $existing (@existings) { 

					<div class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %> smallish">
						
						<span class="medbigspan nowrap">
							<% $existing->conflict->id ? "Personal: ".$existing->conflict->first." ".$existing->conflict->last : "" %>
							<% $existing->chapter->id ? "Team: ".$existing->chapter->name : "" %>
						</span>

						<span class="smallishspan rightalign">
							<a class="dkred block smaller centeralign" href="conflict_rm.mhtml?conflict_id=<% $existing->id %>">
								Remove
							</a>
						</span>

					</div>

%				}

		</div>

%		my @nowjudges = $m->comp("/funclib/account_judges.mas", account => $account, future => 1);

%		if (@nowjudges) { 

			<br class="clear">
			<br class="clear">

			<h2>Tournament Specific Conflicts</h2>

			<div class="left half">

%				foreach my $judge (@nowjudges) { 
					<a class="<% $judge->id == $judge_id ? "dk" : "" %>blue muted block" href="conflicts.mhtml?judge_id=<% $judge->id %>">
						<% $judge->judge_group->abbr." at ".$judge->judge_group->tourn->name %>
					</a>
%				}

			</div>

			<div class="right half evenrow">

%				if ($judge_id) { 

%					my $judge = Tab::Judge->retrieve($judge_id);

%					unless ($judge->judge_group->setting("conflicts")) { 
						
						<p>This tournament is not set to permit online entry of conflicts</p>
						<p>Please contact the tournament staff if you believe this is an error</p>

%					} elsif ($judge && $judge->account->id == $account->id) { 

%						foreach my $conflict (Tab::Strike->search( judge => $judge_id, registrant => 1 )) { 

							<span class="smallish medbigspan maryup">
								<% $conflict->type eq "conflict" ? "Entry: ".$conflict->entry->name : "" %>
								<% $conflict->type eq "entry" ? "Entry: ".$conflict->entry->name : "" %>
								<% $conflict->type eq "school" ? "School: ".$conflict->school->short_name : ""%>
							</span>

							<span class="schemat centeralign smallish maryup">
								<a class="dkred block" href="conflict_tourn_rm.mhtml?conflict_id=<% $conflict->id %>">
									Remove
								</a>
							</span>

%						}

						<div class="oddrow">
							&nbsp;
						</div>

%						foreach my $event ($judge->judge_group->events) { 

							<h5>
								Add <% $event->name %> Conflict:
							</h5>

							<form action="conflict_entry.mhtml">
							<input type="hidden" name="judge_id" value="<% $judge->id %>">

							<div style="padding-bottom: 8px;">

								<select name="entry_id" class="fixedmed marleft">

%									foreach my $entry (sort {$a->school->name cmp $b->school->name} $event->entries) {
	
%										my $schname = substr($entry->school->short_name,0,8);
%										foreach ( length($schname) .. 8) {
%											$schname .= "&nbsp;";
%										}

	
										<option value="<% $entry->id %>">	
											<code>
												<% $schname."- ".$entry->name %>
											</code>
										</option>
%									}
								</select>

								<span class="hundo rightalign padno">
									<input class="thin smallish" type="submit" value="Conflict">
									</form>
								</span>

							</div>

%						}

						<h5>
							Add School Conflict:
						</h5>

						<form action="conflict_school.mhtml">
						<input type="hidden" name="judge_id" value="<% $judge->id %>">

						<div style="padding-bottom: 8px;">

							<select name="school_id" class="fixedmed marleft">
%								foreach my $school (sort {$a->name cmp $b->name} $judge->judge_group->tourn->schools) { 
									<option value="<% $school->id %>">	
										<code>
											<% $school->name %>
										</code>
									</option>
%								}
							</select>

							<span class="hundo rightalign padno">
								<input class="thin smallish" type="submit" value="Conflict">
								</form>
							</span>

						</div>

%					}

%				}

			</div>

%		}

	</div>



