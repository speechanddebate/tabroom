<%args>
	$account
	$panel_id => undef 
	$judge_id => undef
	$errs => undef
</%args>
<%init>

	unless ($panel_id && $judge_id) { 
		my $err = "I didn't get both a judge and a ballot record";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	unless ($panel && $judge) { 
		my $err = "No ballots found for that judge and that panel.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($judge->account->id == $account->id) { 
		my $err = "You are not authorized to enter ballots for that judge.";
		$m->redirect("/user/home.mhtml?err=$err")
	}

	my @ballots = Tab::Ballot->search(  judge => $judge->id, panel => $panel->id );

	unless (@ballots) { 
		my $err = "That judge does not judge in that room.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $tourn = $judge->judge_group->tourn;
	my $type = $panel->round->event->type;

	unless ($panel->started) { 
		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;
		my $now = DateTime->now(time_zone => $tz);
		$panel->started($now);
		$panel->update;
	}

	my $wins;
	my $points;
	my $ranks;

	foreach my $tb ($panel->round->tb_set->tiebreaks) { 
		$ranks++ if ($tb->name eq "ranks" || $tb->name eq "reciprocals");
		$wins++ if ($tb->name eq "opp_wins" || $tb->name eq "winloss");
		$points++ if ($tb->name eq "points" || $tb->name eq "competition" || $tb->name eq "opp_points");
	}

	undef $ranks if $panel->round->event->type eq "wudc";

	my @panel_students = $m->comp('/funclib/panel_students.mas', panel => $panel);
	my $tv++ if $type eq "speech" && $tourn->setting("mfl_time_violation");
	my $noshow++ if $type eq "speech" && $tourn->setting("noshows_never_break");
	my $max_points = $panel->round->event->setting("max_points");
	my $min_points = $panel->round->event->setting("min_points");

	$min_points = 0 unless $min_points;
	$max_points = 30 unless $max_points;

</%init>

	<& /funclib/editor.mas &>

	<div class="left huge">
		
		<span class="hugespan nowrap" style="width: 450px;">
			<h3><% $panel->round->event->abbr %> <% $panel->round->realname %> <% $panel->round->flighted > 1 ? "Flt ".$panel->flight : "" %> Ballot for <% $judge->last %></h3>
		</span>

		<span class="medbigspan nowrap">
			<h4 style="text-align: right;">
				In <% $panel->room ? $panel->room->name : "NONE ASSIGNED" %>
			</h4>
		</span>	

		<br style="clear: both;">

%		if ($errs) { 
			
			<h4>Your ballot had the following errors:</h4>

			<div style="color: #CC0000; font-size: 14pt; font-weight: bold; margin-left: 15px; text-align: center;">
				<% $errs %>
			</div>
%		}

		<table width="100%" cellpadding="4" cellspacing="1">

			<tr class="yellowrow">

%				unless ($type eq "speech" || $type eq "congress") { 
					<th>
						Side
					</th>
%				}

				<th>
					<form action="<% $panel->round->event->type eq "wudc" ? "wudc_save.mhtml" : "ballot_save.mhtml" %>" method="post">
					<input type="hidden" name="panel_id" value="<% $panel->id %>">
					<input type="hidden" name="judge_id" value="<% $judge->id %>">
					Entry
				</th>

%				if  ($ranks || $points) { 
					<th>
					</th>
%				}

%				if  ($points) { 
					<th>
						Points (<% $min_points." - ".$max_points %>)
					</th>
%				}

%				if  ($ranks) { 
					<th>
						Rank
					</th>
%				}

%				unless ($points || $ranks ) { 
					<td></td>
%				}

%				if ($tv) { 
			
					<th>
						Overtime
					</th>
%				}

%				if ($noshow) { 
			
					<th>
						No show
					</th>
%				}

			</tr>

%			my $index = 1;
%			my $switch;

%			foreach my $ballot (@ballots) { 

%				my @students = $ballot->entry->students;

				<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">

%					unless ($type eq "speech" || $type eq "congress") { 

						<td rowspan="<% ($points || $ranks) ? scalar @students : "1" %>" class="centeralign">

%							if ($type eq "pf") { 

								<select name="<% $ballot->id %>_side">
									<option value="">Pick</option>
									<option value="1" <% $ballot->side == 1 ? "selected" : ""%>>Pro</option>
									<option value="2" <% $ballot->side == 2 ? "selected" : ""%>>Con</option>
								</select>

%							} elsif ($panel->round->type eq "elim" && $panel->round->event->type ne "wudc") { 

								<select name="<% $ballot->id %>_side">
									<option value="">Pick</option>
									<option value="1" <% $ballot->side == 1 ? "selected" : ""%>>Aff</option>
									<option value="2" <% $ballot->side == 2 ? "selected" : ""%>>Neg</option>
								</select>

%							} elsif ($panel->round->event->type eq "wudc") { 
								
								<% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
								<% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
								<% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
								<% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>

%							} else { 
								<% ($ballot->side == 1) ? "Aff" : "Neg" %>
%							}
						</td>

%					}

					<td rowspan="<% ($points || $ranks) ? scalar @students : "1" %>">
						<% $ballot->entry->code %>
					</td>

%					if  ($points || $ranks) { 

%						my $notfirst;

%						foreach my $student (@students) { 

%							if ($notfirst++) { 
				
								<tr class="<% ($switch % 2) ? "oddrow" : "evenrow" %>">

%							}

							<td class='rightalign'>
								<% (scalar @students > 1) ? substr($student->first." ".$student->last.":", 0, 30) : "" %>
							</td>

%							if ($points) { 

								<td>
									<input tabindex=<% $index++ %> type="number" step=".1" name="<% $student->id %>_points" 
									size="5" min="<% $min_points %> " max="<% $max_points %>" value="<% $ARGS{$student->id."_points"} %>" 
									<% ($max_points <= "100") ? 'onKeyUp="return autoTab(this, 2, event);"' : "" %> ">
								</td>
%							}

%							if  ($ranks) { 
								<td>
									<input tabindex=<% $index++  %> type="number" step="1" size="5" name="<% $student->id %>_ranks" min="1" max="<% scalar @panel_students %>" 
										value="<% $ARGS{$student->id."_ranks"} %>">
								</td>
%							}


%							if ($tv) { 
								<td>
									<input type="checkbox" name="<% $ballot->id %>_tv" value="1"> 
								</td>
%							}

%							if ($noshow) { 
								<td>
									<input type="checkbox" name="<% $ballot->id %>_noshow" value="1"> 
								</td>
%							}

%						}
						
%					} else { 
	
						<td></td>

%					}

					</tr>

%					$switch++;

%				}


%			if ($wins) { 

				<tr class="yellowrow">


					<th>
						Win:
					</th>

					<th>
						<select name="winner">
							<option value="">Choose Team</option>

%							foreach my $ballot (@ballots) { 
								<option value="<% $ballot->id %>" <% $ARGS{"winner"} == $ballot->id ? "selected" : "" %>>
									<% $ballot->entry->code %>
								</option>
%							}
						</select>
					</th>


					<th class="centeralign"> 
						On:

%						if ($type eq "pf") { 
							<input type="radio" name="winner_side" value="1" id="1" <% $ARGS{"winner_side"} == 1 ? "checked" : "" %>>
								<label for="1">Pro</label>
							<input type="radio" name="winner_side" value="2" id="2" <% $ARGS{"winner_side"} == 2 ? "checked" : "" %>>
								<label for="2">Con</label>
%						} else { 
							<input type="radio" name="winner_side" value="1" id="1" <% $ARGS{"winner_side"} == 1 ? "checked" : "" %>>
								<label for="1">Aff</label>
							<input type="radio" name="winner_side" value="2" id="2" <% $ARGS{"winner_side"} == 2 ? "checked" : "" %>>
								<label for="2">Neg</label>
%						}

					</th>

%					if ($wins && $points && $panel->round->event->setting("no_lpw") < 1) { 
							<td colspan="2" class="rightalign">

							<span style="float: right; padding-left: 10px;">
								<input type="checkbox" id="lpw" value="1" name="lpw" <% $ARGS{"lpw"} ? "checked" : "" %>>
							</span>
							<span style="float: right; padding-left: 10px; padding-top: 6px; font-size: 105%;">
								<label for="lpw">Low-Point Win?</label>
							</span>
							</td>
%					} 
				
				</tr>

%			}

			<tr class="liblrow">

				<td colspan="6" class="rightalign">
					<input type="submit" value=" Submit Ballot ">
				</td>
			</tr>


			<tr>
				<td colspan="6" style="padding-top: 10px;">
					<h4>Reason for Decision:</h4>
				</td>
			</tr>

%			my $rfd = Tab::BallotValue->search( tag => "rfd", ballot => $ballots[0]->id )->first if @ballots;

			<tr>
				<td colspan="6" style="padding-top: 10px; padding-left: 20px;">
					<textarea name="rfd" rows="8" cols="60"><% $rfd ? $rfd->content : "" %></textarea>
				</td>
			</tr>

			<tr class="liblrow">
				<td colspan="6" class="rightalign">
					<input type="submit" value="Save RFD" name="skipme" class="med">
					</form>
				</td>
			</tr>

		</table>

	</div>

	<div class="right small">

		<div class="sidenote">

			<h4>This round:</h4>

			<div class="greynohover block padless smallish">

				<span class="smallspan">
					Round:
				</span>

				<span class="namespan">
					<% $panel->round->realname %>
				</span>

			</div>

			<div class="greynohover block padless smallish">

				<span class="smallspan">
					Room:
				</span>
				<span class="namespan">
					<% $panel->room ? $panel->room->name : "" %>
				</span>

			</div>

%			if ($panel->round->flighted > 1) { 
				<div class="whitenohover block padless smallish">
	
					<span class="smallspan">	
						Flight
					</span>

					<span class="namespan">
						<% $panel->flight %>
					</span>

				</div>
%			}

%			if ($panel->round->judges > 1) { 
				
				<div class="plainnohover block padless smallish" style="margin-top: 8px; margin-bottom: 8px;">

%				foreach my $other_judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%					next if $other_judge->id == $judge->id;
	
					<span class="smallspan ">
						<% $other_judge->chair ? "Chair:" : "Panelist:" %>
					</span>

					<span class="namespan nowrap ">
						<% $other_judge->code." ".$other_judge->first." ".$other_judge->last %>
					</span>

					<br style="clear: both;" />
%				}

				</div>

%			}

			<a href="/index/tourn/postings/round.mhtml?tourn_id=<% $panel->round->event->tourn->id %>&round_id=<% $panel->round->id %>" class="blue block">
				Full Pairing/Schematic
			</a>

		</div>

		<div class="sidenote">

			<h4>Comments</h4>
			
%			foreach my $ballot (@ballots) { 
				<a class="yellow block" href="ballot_comments.mhtml?judge_id=<% $judge->id %>&ballot_id=<% $ballot->id %>">
					For <% $ballot->entry->code %>
				</a>
%			}

			<p class="explain">RFDs are sent to everyone in the round; comments only to the entry & coaches</p>

		</div>

		<div class="sidenote">

			<h4>Other ballots</h4>

%			foreach my $opanel ($m->comp("/funclib/account_panels.mas", account => $account)) { 
%				next unless $opanel->round->published;
%				next if $opanel->id == $panel->id;

				<a class="yellow block" href="ballot.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">
					<% $opanel->round->event->abbr %> <% $opanel->round->realname %> <% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %> Pending
				</a>
%			}

%			foreach my $opanel ($m->comp("/funclib/account_panels.mas", account => $account, done => 1)) { 

%				next if $opanel->id == $panel->id;

				<a class="blue block" href="ballot_view.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">
					<% $opanel->round->event->abbr %> <% $opanel->round->realname %> <% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>  Done
				</a>
%			}

		</div>

	</div>
