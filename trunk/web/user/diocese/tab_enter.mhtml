
<%args> 
	$group_id
	$diocese_id
	$account
</%args>
<%init>

	my $diocese = Tab::Region->retrieve($diocese_id);

	my $group = Tab::JudgeGroup->retrieve($group_id);

	my @classes = sort {$a->name cmp $b->name} $group->classes;

	my $tourn = $group->tournament;

	my @judges = $diocese->judges_by_group($group);

	my @chapters = sort {$a->name cmp $b->name} $diocese->chapters;

	my @quals = $tourn->quals;

	my @pools = $group->elim_pools;

	my $judge_burden = $m->comp("/funclib/ncfl/judge_obligation.mas", diocese => $diocese, group => $group);

	unless ($diocese->director->id eq $account->id || $account->site_admin) { 

		$m->redirect("$Tab::url_prefix/account/access_denied.mhtml");
	}

	my @events = sort {$a->name cmp $b->name} $tourn->events;

	my $switch;

</%init>

	<div class="left huge">
		
		<table cellpadding="0" width="100%">

			<tr>
				<td width="100%"> 
					<h2>
						Judges for <% $group->abbr %> prelims
					</h2>
				</td>

			</tr>

		<table cellpadding="4" cellspacing="1" width="98%" border="0" style="margin-left: 10px;">

%			foreach my $judge (@judges) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $switch %>.
					</td>

					<td class="smaller">
						<% $judge->first %>
					</td>

					<td class="smaller">
						<% $judge->last %>
					</td>

					<td class="smaller">
						<% $judge->school->name %>
					</td>

					<td class="smaller" align="center">
%						foreach my $qual ($judge->quals) { 
							<% $qual->name %>
%						}
					</td>


					<td class="smaller" align="center">
						<form action="<% ($group->tab_room) ? "tab_edit.mhtml" ? "judge_edit.mhtml" %>" method="post">
						<input type="hidden" name="judge_id" value="<% $judge->id %>">
						<input type="submit" value=" Edit " class="blue">
						</form>
					</td>

					<td class="smaller" align="center">
						<form action="judge_drop.mhtml" method="post">
						<input type="hidden" name="judge_id" value="<% $judge->id %>">
						<input type="submit" value=" Drop " class="red">
						</form>
					</td>

				</tr>

%			}

			<tr class="<% ($judge_burden > scalar (@judges)) ? "lirdrow" : "liblrow"%>">

				<th colspan="2" style="text-align: right;" class="smaller">
					Owed:
				</th>

				<th colspan="2" style="text-align: left;" class="smaller">
					<% ($judge_burden - scalar (@judges) > 0) ? ($judge_burden - scalar (@judges))." more" : "Prelim burden met" %>
				</td>

				<td class="smaller" align="center" colspan="3">
					<form action="<% ($group->tab_room) ? "tab_edit.mhtml" : "judge_edit.mhtml" %>" method="post">
					<input type="hidden" name="group_id" value="<% $group->id %>">
					<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					<input type="submit" value=" Add a new <% ($group->tab_room) ? "Tab staffer" : "judge" %>" >
					</form>
				</td>

			</tr>


		</table>

%		if (@pools) { 

			<h3>Judges for <% $group->abbr %> Elims:</h3>

			<p class="smaller">Note: "D" judges may not judge elim rounds and
			will not appear below.  Judges can only judge in one division
			during elims, but may judge a different division than they judged
			in prelims.</p>

			<table cellpadding="4" cellspacing="1" width="98%" border="0" style="margin-left: 5px;">

				<tr class="liblrow">

					<td style="background-color: #fafafa;">
						<form action="judge_elims_save.mhtml" method="post">
						<input type="hidden" name="group_id" value="<% $group->id %>">
						<input type="hidden" name="diocese_id" value="<% $diocese->id %>">
					</td>

%					foreach my $pool (@pools) { 

						<td align="center" class="smaller">
							<% $pool->name %>
						</td>

%					}
					

				</tr>

%			foreach my $judge ($diocese->judges($tourn)) { 

%				next if $judge->elim_group && $judge->elim_group != $group->id;
%				next if $judge->judge_group->tab_room;
%				my @quals = $judge->quals;
%				next unless @quals;
%				next if $quals[0]->name eq "D";

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td class="smaller">
						<% $judge->first." ".$judge->last %>
						(<% $judge->judge_group->abbr %>)
					</td>

%					foreach my $pool (@pools) { 
						<td align="center">
							<input type="checkbox" name="<% $judge->id %>_<% $pool->id %>" value="1"
								<% ($judge->in_pool($pool)) ? "checked" : "" %>
							>
						</td>
%					}

				</tr>
%			}

<%perl>

# Calculate the total owed if the diocese is small enough to qualify for the
# Alternative Maximum Tax.

			my ($total_owed, $style) = $m->comp("/funclib/ncfl/pool_obligation.mas", diocese => $diocese, group => $group);

</%perl>

			<tr class="<% ($total_owed) ? "lirdrow" : "ligrnrow" %>">
				
				<td class="smaller">
					Elims Owed:
				</td>

%				if ($style eq "overall") { 
					<td colspan="6" align="right">
						<% ($total_owed) ? $total_owed." more elim round(s)" : "Elim burden met" %>
					</td>
%				} else { 

%					foreach my $pool (@pools) { 

%						my ($owed, $ditch) = $m->comp("/funclib/ncfl/pool_obligation.mas", diocese => $diocese, pool => $pool);

						<td align="center" class="smaller">
							<% ($owed) ? $owed." more " : "OK" %>
						</td>
%					}

%				}

			</tr>

			<tr class="liblrow">
				
				<td colspan="6" align="right">
					<input type="submit" value="  Save Elim Assignments ">
					</form>
				</td>

			</tr>

			</table>


%		}

%	unless ($group->tab_room) { 

		<p class="smaller">
			For elim rounds, you owe EITHER a percentage of your judges for
			each elim round, OR a total of elim rounds equal to 2x the number
			of judges you owe in that judge group, whichever is smaller.  This
			rule affects smaller dioceses, keeping them from having to place
			their judges in every elim round to fill quotas. 
		</p>
		
		<p class="smaller">

			A diocese owing 2 judges in a category thus only owes 4 elim rounds
			total.  You may, of course, always register to judge MORE elims
			than your obligation, if desired.

		</p>
%	}

	</div>

	<& sidebar.mas, group => $group, tourn => $tourn, diocese => $diocese &>
