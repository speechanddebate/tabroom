<%args>
	$chapter_id
	$email
	$account
</%args>
<%init>

	$email =~tr/[A-Z]/[a-z]/;
	my $chapter = Tab::Chapter->retrieve($chapter_id);

    my @acc = Tab::ChapterAdmin->search( account => $account->id, chapter => $chapter_id );

    unless (@acc) {
        my $err = "You are not authorized to edit ". $chapter->name ;
        $m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?err=$err");
    }

	my @accs = Tab::Account->search( email => $email);

	my $err;

	unless (@accs) { 

		$err = "The email $email has no account on this system.  ";
		$err .= "The coach must sign up for an account first before access to this chapter can be granted.";
		$m->redirect("$Tab::url_prefix/user/chapter/settings.mhtml?err=$err&chapter_id=$chapter_id");

	}

	my $coach = Tab::ChapterAdmin->search( chapter => $chapter_id, account => $accs[0]->id )->first;

	if ($coach) { 
		$coach->prefs(0);
		$coach->update;
	} else { 
		$coach = Tab::ChapterAdmin->create({
			chapter => $chapter_id,
			account => $accs[0]->id,
			prefs => 0
		});
	}

	my $msg = "Coach ".$accs[0]->first." ".$accs[0]->last." has been given access to ". $chapter->name;	

	$m->redirect("/user/chapter/settings.mhtml?chapter_id=$chapter_id&msg=$msg");

</%init>
