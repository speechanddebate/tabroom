<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->comp("auth.mas", chapter => $chapter, account => $account, session => $session);

	my %circuit_member = ();

	my @ljs = sort {$a->circuit->name cmp $b->circuit->name} $chapter->chapter_circuits;

	my $switch;

</%init>

	<& /user/menu.mas, chapter => $chapter, account => $account &> 

	<div class="left huge"> 
		
		<h2><% $chapter->name %>: Circuits</h2>
	
		<& tabbar.mas, chapter => $chapter, whoami => "circuit" &>

%		if (@ljs) { 

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">

					<th>
						Circuit
					</th>

					<th>
						Location
					</th>

					<th>
						Membership
					</th>

					<th>
					</th>

				</tr>

%				foreach my $lj (@ljs) { 

%					next unless $lj->active;
%					my $circuit = $lj->circuit;
%					$circuit_member{$circuit->id}++;

%					next if ($circuit->active < 1 );

					<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

						<td>
							<a class="white block" href="/index/circuit.mhtml?circuit_id=<% $circuit->id %>">
								<% $circuit->name %>
							</a>
						</td>
						
						<td class="centeralign">
							<% ($circuit->state) ? $circuit->state."/" : "" %><% $circuit->country %>
						</td>

						<td class="centeralign smaller">

							<% ($lj->full_member) ? "" : "Tournaments Only" %>

%							if ($lj->membership) { 
								<% $lj->membership->name %>		
								<% ($lj->membership->dues > 0) ? "(\$".$lj->membership->dues.")" : "" %>		
%							}

%							if ($circuit->regions && $lj->region) { 
								<% $lj->region->name %> region
%							}

						</td>

						<td class="centeralign">
							<a href="circuit_leave.mhtml?lj_id=<% $lj->id %>" class="dkred block">
								Leave Circuit
							</a>

						</td>

					</tr>

%				}

			</table>

%		} else { 

			<h2>Joining Circuits</h2>

			<p class="smallish">
				All tournaments on tabroom.com are part of a circuit.  The
				circuits on tabroom.com are listed below.
			</p>
			
			<p class="smallish">
				Click "Join Circuit" to fully join.  You will be able to
				register for tournaments, and will recieve emails about the
				circuit.  You may also be billed for membership dues.  This is
				best for joining a state or local circuit.
			</p>

			<p class="smallish">
				Click "Tournaments Only" if you want to register for
				tournaments, but don't want Circuit emails or to be a dues
				paying member.  Some circuits are run entirely on a 
				tournament-only basis.
			</p>

			<p class="smallish">
				High school tournaments in the US that are not part of a
				specific region or circuit are listed under "US National
				Circuit".
			</p>

			<p class="smallish">
				If you don't know what circuit your tournament is in,
				search for the tournament in the box at the top right.
			</p>

%		}

		<br />

		<h4>Circuits You Can Join</h4>

		<table cellpadding="5" cellspacing="1" width="100%">

			<tr class="liblrow">

				<th>
					Circuit
				</th>

				<th>
					Location
				</th>

				<th colspan="2">
					Join:
				</td>

			</tr>

%		foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search( active => 1 )) {  

%			next if $circuit->setting("ncfl");

%			next if $circuit_member{$circuit->id};

			<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>			

				<td>
					<a class="white block" href="/index/circuit.mhtml?circuit_id=<% $circuit->id %>">
					<% $circuit->name %>
					</a>
				</td>

				<td class="centeralign">
					<% ($circuit->state) ? $circuit->state."/" : "" %><% $circuit->country %>
				</td>

				<td class="centeralign">
%					if ($circuit->setting("tourn_only")) { 
						<a class="dkgreen block" href="circuit_join.mhtml?type=to&circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							Tournaments 
						</a>
%					}
				</td>

				<td class="centeralign">
%					if ($circuit->setting("full_members")) { 
						<a class="dkgreen block" href="circuit_join.mhtml?type=full&circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							Join Fully
						</a>
%					} 
				</td>

			</tr>

%		}

		</table>

	</div>

