<%args>
	$account
	$newbie     => undef
	$student_id => undef
	$chapter_id => undef;
	$from       => undef;
</%args>
<%init>

	my $student = Tab::Student->retrieve($student_id) if $student_id;
	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($student || $chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	$chapter = $student->chapter unless $chapter;

	unless ($chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $demo;
	foreach my $circuit ($chapter->circuits) { 
		next if $demo;
		$demo++ if $circuit->setting("demographics");
	}

	my $tz = $account->tz if $account;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);
	$now->subtract( days => 1 );

	my $then = $now->clone;
	$then->subtract( years => 15 );

	my @students = Tab::Student->search_where({
		chapter => $chapter->id, 
		timestamp => {">=", DateTime::Format::MySQL->format_date($now)}},
		{order_by => "timestamp"}
		);

	my $switch;

</%init>

	<div class="left huge">

		<h2><% $chapter->name %> Student Roster</h2>

        <& tabbar.mas, chapter => $chapter, whoami => "students" &>

%		if ($student) {
			<h4><% $student->first." ".$student->last %></h4>
% 		} else { 
			<h4>Add a student:</h4>
% 		}

%		if ($newbie) { 

			<p>
				You now should add the student names for your team into your
				roster by adding their information below.  Consider adding in
				your entire team to save work later.
			</p>
			
			<p>
				You only have to add each student once for their entire career;
				you can then look up an entire student record for all the
				tournaments on Tabroom that a given student attends.
			</p>

			<p>
				Begin by adding the first student below.
			</p>

			<hr />

%		}

%		unless ($student && $student->account && $student->account->id) { 	

			<table cellpadding="5" cellspacing="1" width="100%" >
			
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

					<td>
						<form action="student_search.mhtml" method="post">
						<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
						<input type="hidden" name="student_id" value="<% $student_id %>">
						<% ($student) ? "Link ".$student->first." ".$student->last." to "  : "Find student w/" %> an tabroom.com account
					</td>

					<td>
						<input type="email" name="email" placeholder="Search by email address" size="25">
					</td>

					<td>
						<input type="submit" class="thin" value="Search">
						</form>
					</td>
				</tr>

			</table>
		
			<h4><% ($student) ? "Edit Details" : "Or, Create a new student (without tabroom.com account)" %></h4>

%		}


		<table cellpadding="5" cellspacing="1" width="100%" >

%			if ($student && $student->account && $student->account->id) { 

				<tr class="yellowrow">

					<td class="rightalign">
						Linked to idebate account 
					</td>

					<td>
						<span class="medspan">
							<a class="white block" href="mailto:<% $student->account->email %>">
								<% $student->account->email %>
							</a>
						</span>

						<span class="medspan" style="text-align: center; float: right;">
							<a class=" dkred block "  href="student_unlink.mhtml?student_id=<% $student->id %>">
								Unlink account
							</a>
						</span>
					</td>

				</tr>
%			}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
				<td class="rightalign">
					<form action="student_save.mhtml" method="post">
					<input type="hidden" name="student_id" value="<% ($student) ? $student->id : "" %>">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="hidden" name="from" value="<% $from %>">
					First Name
				</td>
				
				<td>
					<input type="text" name="first" size="20" value="<% ($student) ? $student->first : "" %>">
				</td>

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
				<td class="rightalign">
					Last Name
				</td>
				
				<td>
					<input type="text" name="last" size="20" value="<% ($student) ? $student->last : ""%>">
				</td>

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
				<td class="rightalign">
					Phonetic Pronunciation
				</td>
				
				<td>
					<input type="text" name="phonetic" size="20" value="<% ($student) ? $student->phonetic : ""%>">
				</td> 

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
				<td class="rightalign">
					Grad Year
				</td>
				
				<td>
					<input type="text" name="grad_year" size="6" value="<% ($student) ?   $student->grad_year : ""%>">
				</td>

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
				<td class="rightalign">
					Novice
				</td>
				
				<td>
					<input type="checkbox" name="novice" value="1" <% ($student) ?  ($student->novice) ? 'checked' : '': "" %> >
				</td> 

			</tr> 
			
			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
				<td class="rightalign">
					Gender
				</td>
				
				<td>
					<input type="radio" name="gender" value="M" <% ($student) ? ($student->gender eq "M") ? "checked" : "" : "" %>> M
					<input type="radio" name="gender" value="F" <% ($student) ? ($student->gender eq "F" ) ? "checked" : "" : "" %>> F
					<input type="radio" name="gender" value="O" <% ($student) ? ($student->gender eq "O" ) ? "checked" : "" : "" %>> Other
				</td>
			</tr> 
			
%			if ($demo) { 
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
					<td class="rightalign">
						Student ID
					</td>
					
					<td>
						<input type="text" name="school_sid" size="30" value="<% $student ? $student->school_sid : "" %>">
					</td>
				</tr> 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
				
					<td class="rightalign">
						Date of Birth
					</td>

					<& /funclib/datepicker.mas, id => "birthdate" &>

					<td>
						<input type="text" name="birthdate" id="birthdate" size="10" 
						value="<% $student && $student->birthdate ? Tab::pickerdate($student->birthdate) : Tab::pickerdate($then) %>">
					</td>
				</tr> 

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

%					my $race = $student->race if $student;
				
					<td class="rightalign">
						Ethnic Background
					</td>

					<td>
						<select name="race" class="fixedmed">
							<option value="">Choose one</option>
							<option value="white" <% $race eq "white" ? "selected" : "" %> >White, non-Hispanic/Latino</option>
							<option value="black" <% $race eq "black" ? "selected" : "" %> >Black, non-Hispanic/Latino</option>
							<option value="latino" <% $race eq "latino" ? "selected" : "" %> >Hispanic/Latino</option>
							<option value="amerindian" <% $race eq "amerindian" ? "selected" : "" %> >American Indian/Native Alaskan</option>
							<option value="asian" <% $race eq "asian" ? "selected" : "" %> >Asian</option>
							<option value="pacific" <% $race eq "pacific" ? "selected" : "" %> >Native Hawaiian/Pacific Islander</option>
							<option value="dual" <% $race eq "dual" ? "selected" : "" %> >Two or more races</option>
							<option value="other" <% $race eq "other" ? "selected" : "" %> >Other</option>
						</select>
					</td>
				</tr> 
%			}

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">
			
				<td class="rightalign">
					Diet Notes
				</td>
				
				<td>
					<input type="text" name="diet" size="30" value="<% $student ? $student->diet : "" %>">
				</td>
			</tr> 
			
			<tr class="liblrow">

				<td colspan="2" class="rightalign">
					<input  type="submit" name="twitch" value="  Save Student <% ($student) ? "" : "& Add Another" %>  ">
					</form>
				</td>
				
			</tr>

		</table>

	</div>

	<div class="right small">
	
		<div class="sidenote">
	
			<br />
			<a class="yellow block" href="student_edit.mhtml?chapter_id=<% $chapter->id %>">
				Add another student
			</a>

			<a class="yellow block" href="students.mhtml?chapter_id=<% $chapter->id %>">
				Return to student roster
			</a>

			<h4>Recent Changes:</h4>

%			foreach my $student (@students) { 
			
				<a class="nowrap blue block" href="student_edit.mhtml?student_id=<% $student->id %>">
					<span class="namespan left">
						<% $student->first." ".$student->last %>
					</span>
					<span class="tinyspan" style="text-align: right; float: right;">
						<% $student->grad_year %>
					</span>
				<a>

%			}

		</div>

	</div>

