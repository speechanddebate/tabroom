<%args>
	$coach_id
	$chapter_id
	$account
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	my $coach = Tab::Account->retrieve($coach_id); 

    my @acc = Tab::Permission->search( account => $account->id, chapter => $chapter_id);

    unless (@acc || $account->site_admin) {
        my $err = "You are not authorized to edit ". $chapter->name ;
        $m->redirect("/user/chapter/settings.mhtml?chapter_id=$chapter_id&err=$err");
    }

	# Can't be the only one left 

	my @all_coaches = Tab::Permission->search( chapter => $chapter_id, tag => "chapter" );

	unless ((scalar @all_coaches) > 1 || $acc[0]->tag eq "prefs") { 
		my $err = "You may not delete the last coach to have access to that chapter";
		$m->redirect("/user/chapter/settings.mhtml?err=$err&chapter_id=$chapter_id");
	}

	my @ca = Tab::Permission->search( account => $coach_id, chapter => $chapter->id);

	foreach (@ca) {  $_->delete; } 

	my $msg = $coach->first." ".$coach->last." has been removed from ". $chapter->name;	

	$m->redirect("/user/chapter/settings.mhtml?chapter_id=$chapter_id&msg=$msg");

</%init>
