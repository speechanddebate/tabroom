<%args>
	$account
	$tourn_id => undef
</%args>
<%init>

	my $now = DateTime->now();

	use Tab::NSDA::EventCategories;


	my @categories = sort {$a->name cmp $b->name} Tab::NSDA::EventCategories->retrieve_all;

	my $switch;

</%init>

	<div class="main">

%	if ($tourn_id) { 

%		my $tourn = Tab::Tourn->retrieve($tourn_id);
%		my $tz = $tourn->tz;
%		$tz = "UTC" unless $tz;

		<h2><% $tourn->name %> autopoint</h2>

		<p><% $tourn->start->set_time_zone($tz) %> - <% $tourn->start->set_time_zone($tz) %> <% Tab::tzname($tz) %> </p>

		<form action="autopoint_post.mhtml" method="post">
		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">

%		foreach my $event ($tourn->events) { 

%			my $nsda_category = $event->setting("nsda_event_category");

			<div class="<% ($switch++ % 2) ? "odd" : "even" %>">

				<span class="twofifth">
					<% $event->name %>
				</span>

				<span class="twofifth">
%					unless ($event->type eq "congress") { 
						<select name="<% $event->id %>" class="fixedmed">
							<option value=""></option>
%							foreach my $category (@categories) { 
								<option value="<% $category->id %>" <% $category->id == $nsda_category ? 'selected="selected"' : "" %>><% $category->name %></option>
%							}
							<option value="">None</option>
						</select>
%					}
				</span>

				<label for="<% $event->id %>">
					<span class="fifth nowrap redhover centeralign padtop padbottom">
						Exclude: <input type="checkbox" name="exclude_<% $event->id %>" value="1" id="<% $event->id %>">
					</span>
				</label>

			</div>

%		}

		<div class="rightalign liblrow">
			<input type="submit" value=" Post NSDA Points ">
		</div>

		</form>

%	}

	</div>

<%perl>

	Tab::Tourn->set_sql( recent_over => "
		select tourn.* 
		from tourn
		where tourn.end < ? 
		and tourn.start > ? 
		and not exists ( 
			select tourn_setting.id
			from tourn_setting
			where tourn_setting.tag = \"nsda_points_posted\"
			and tourn_setting.tourn = tourn.id
		)
		order by tourn.end DESC
		limit 40
	");

	my $start = $now->subtract(days => 30);
	my @tourns = Tab::Tourn->search_recent_over( $now, $start);

</%perl>

	<div.class="menu">

		<div class="sidenote">

			<h4>Recent Tournaments</h4>

%			foreach my $tourn (@tourns) { 
				<a class="blue block" href="autopoint.mhtml?tourn_id=<% $tourn->id %>">
					<span class="twothirds nowrap">
						<% $tourn->name %>
					</span>
					<span class="third nowrap">
						<% Tab::shortdt($tourn->end) %>
					</span>
				</a>
%			}

		</div>

	</div>

