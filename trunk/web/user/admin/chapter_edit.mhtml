<%args>
	$chapter_id
	$account
	$session
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	$m->abort unless $chapter;
	my $switch;

</%init>

	<& /user/menu.mas, whoami => "chapter_admin", chapter => $chapter, account => $account &>

	<div class="main">

		<h2><% $chapter->name %></h2>

		<table cellpadding="10" cellspacing="1">

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >
	
				<th class="rightalign">
					School/Team Name
				</th>

				<td>
					<form action="chapter_save.mhtml" method="post"> 
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="text" name="name" size="42" value="<% $chapter->name %>">
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					Country
				</th>

				<td>
					<select name="country" class="fixed">
						<& /funclib/country_select.mas, country => $chapter->country &>
					</select>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					State/Province (if applicable)
				</th>

				<td>
					<select name="state" class="fixed">
						<& /funclib/state_select.mas, state => $chapter->state &>
					</select>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					Coach names (for credits)
				</th>

				<td>
					<input type="text" name="coaches" size="42" value="<% $chapter->coaches %>">
				</td>

			</tr>
	
			<tr class="liblrow">

				<td colspan="2" class="rightalign">
					<input type="submit" value=" Save Chapter Details ">
					</form>
				</td>
			</tr>

		</table>

		<h4>Accounts with access to school</h4>

		<form action="chapter_admins.mhtml" method="post">
		<input type="hidden" name="chapter_id" value="<% $chapter->id %>">

%		foreach my $coach ($m->comp("/funclib/chapter_admins.mas", chapter => $chapter)) {

			<div class="<% ($switch++ % 2) ? "odd" : "even" %>">	

    	        <span class="quarter">
					<% $coach->first." ".$coach->last %>
				</span>

    	        <span class="quarter">
					<a class="white" href="mailto:<% $coach->email %>">
               			<% $coach->email %>
					</a>
				</span>

				<span class="quarter"> 
					<select name="<% $coach->id %>_access_level" class="fixedsmall">
						<option value="chapter" <% $coach->prefs eq "chapter" ? 'selected="selected"' : "" %>> Full Access </option>
						<option value="prefs" <% $coach->prefs eq "prefs" ? 'selected="selected"' : "" %>> Pref Sheets Only </option>
					</select>
				</span>

    	        <span class="quarter nospace centeralign">
					<a class="dkred block" href="chapter_admin_rm.mhtml?coach_id=<% $coach->id%>&chapter_id=<% $chapter->id%>">	
						REMOVE
					</a>
				</span>

			</div>

%		}

		<div class="liblrow">

			<span class="quarter">
				Add:
			</span>
	
			<span class="quarter">
				<input type="text" name="email" size="16" placeholder="Coach's email address">
			</span>

			<span class="quarter"> 
				<select name="access_level" class="fixedsmall">
					<option value="chapter"> Full Access </option>
					<option value="prefs"> Pref Sheets Only </option>
				</select>
			</span>
	
       		<span class="quarter centeralign">
				<input type="submit"  value=" Save Changes ">
				</form>
			</span>

		</div>

		<h4>Circuit Memberships</h4>
		
		<table cellpadding="5" cellspacing="1">

%			my %circuit_mem = ();

%			foreach my $circuit ($chapter->circuits) { 

%				$circuit_mem{$circuit->id}++;

%				my $mem = Tab::ChapterCircuit->search( chapter => $chapter->id, circuit => $circuit->id )->first;
			
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

					<td>
						<% $circuit->name %>
					</td>

					<td>
						<% $mem->full_member ? "Full Member" : "Tournaments Only" %>
					</td>

					<td class="centeralign smallish">
						<a class="dkred block" href="chapter_circuit_rm.mhtml?circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							REMOVE
						</a>
					</td>

				</tr>

%			}

			<tr class="liblrow">

				<td>
					<form action="chapter_circuit_add.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					Join:

					&nbsp;

					<select name="circuit_id" class="fixedmed">
%						foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search( active => 1 )) {  
%							next if $circuit->setting("ncfl");
%							next if $circuit_mem{$circuit->id};
							<option value="<% $circuit->id %>"> <% $circuit->name %> </option>
%						}
					</select>

				</td>

				<td class="centeralign">
					<input type="submit" class="thin" name="full" value="Full Membership">
				</td>

				<td class="centeralign">
					<input type="submit" class="thin" name="tournaments" value="Tournaments Only">
					</form>
				</td>

			</tr>

		</table>

	</div>



