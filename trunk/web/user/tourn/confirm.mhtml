<%args>
	$tourn_id
	$account
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	my @sites = $tourn->sites;

	my $i_got_this++ if Tab::TournAdmin->search( tourn => $tourn_id, account => $account->id );

	unless ($i_got_this) { 

		# Send email to the circuit administrators
		foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) {

			foreach my $admin ($circuit->admins) { 

				my $subject =  $circuit->abbr." Tournament Requested";

				my $body = "\n";

				$body .=$account->first." ".$account->last." <".$account->email."> has requested approval to list a tournament ";
				$body .= "on tabroom.com in your circuit:\n\n".$circuit->name."\n\n";

				$body .= "Tournament information:\n\n";

				$body .= "\tName: ".$tourn->name."\n";
				$body .= "\tStart Date: ".Tab::nicedate($tourn->start)."\n";
				$body .= "\tEnd Date: ".Tab::nicedate($tourn->end)."\n";
				$body .= "\tLocation: " if scalar @sites == 1;
				$body .= "\tLocations: " if scalar @sites > 1;

				my $notfirst;
				foreach my $site (@sites) { 
					$body .="," if $notfirst;
					$body .= " ".$site->name;
					$notfirst++;
				}

				$body .= "\tOnline Registration opens ".Tab::nicedt($tourn->reg_start->set_time_zone($tourn->tz))." (".$tourn->tz.")\n\n";

				$body .="A circuit administrator (such as yourself) must approve this tournament before it can ";
				$body .="open for online registration. To do so, go to:\n\n";
				$body .="\t".$Tab::url_prefix."/user/circuit/approvals.mhtml?circuit_id=".$circuit->id."\n\n";
				$body .="Or, you can log into Tabroom.com and click on the Tournaments Pending Approval button on the right.\n\n";

				$m->comp( "/funclib/send_email.mas", from => $account, to => $admin, subject => $subject, body => $body );

			}
		}
	}

</%init>

	<div class="main">

		<h2>Tournament request confirmed</h2>

		<p>
			Your requested tabroom.com tournament, <% $tourn->name %> has been saved. 
			You can access it on the right hand toolbar on your <a href="/user/home.mhtml">Home Screen</a>.
		</p>

		<p>
			The circuit administrators for the circuits you have requested have
			been notified for listing.  You will be emailed when the circuit
			administrators approve your tournament. 
		</p>

	</div>

	<div class="menu">

		<div class="sidenote">
		
			<h4>Request Complete</h4>

			<br />

			<a href="/user/home.mhtml" class="blue block">Return to Home Screen</a>
			<a href="/user/tourn/request.mhtml" class="yellow block">Request Another Tournament</a>
		
			<br />
		
		</div>

	</div>
