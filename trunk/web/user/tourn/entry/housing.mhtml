<%args>
	$session
	$school
	$err => undef
	$histu => undef
</%args>
<%init>

	my $tourn = $school->tournament;
	my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn);
	my $now = DateTime->now;
	my $reg_end = $tourn->reg_end;

</%init> 

	<h2><% $school->name %> at the <% $tourn->name %></h2> 
	
	<& menubar.mas, school => $school, whoami => "housing" &>

	<div class="left huge">

		<h3>Entryetitor Housing</h3>

		<table cellpadding="3" cellspacing="1" width="100%">

			<tr class="redrow">

				<th colspan="2">
					Name/Gender
				</th>

				<th>
					Night
				</th>

				<th>
					Status
				</th>

				<th colspan="2">
				
				</th>

			</tr>

<%perl> 

			my $switch;
			my @students = $school->students;
			my @judges = $school->judges;
			my %students_sans_housing = ();
			my %judges_sans_housing = ();

			foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

				foreach my $stu (@students) { 
					my $housing = $stu->housing($tourn, $day);
	
					if ($housing) { 
						next unless $housing->waitlist;
					}

					push (@{$students_sans_housing{$day->ymd}}, $stu);
				}

				foreach my $jud (@judges) { 

					my $housing = $jud->housing($day);

					if ($housing) { 
						next unless $housing->waitlist;
					}
				
					push (@{$judges_sans_housing{$day->ymd}}, $jud);
				}
	
			}

</%perl>

%			foreach my $student (sort {$a->last cmp $b->last} $school->students) {

%				if ($histu == $student->id) { 

					<tr class="redrow">
	
%				} else { 

					<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

%				}

				<td>
					<a class="whiteblock" href="/user/chapter/student_edit.mhtml?student_id=<% $student->id %>">
						<% $student->first." ".$student->last %>
						(<% $student->print_events($tourn) %>)
					</a>
				</td>

				<td align="center">
					<% ($student->gender) ? $student->gender : "" %>
				</td>

%				unless ($student->gender) { 

					<td class="smaller">
						Set student gender:
					</td>

					<td colspan="2">
						<form action="sex_change.mhtml" method="post">
						<input type="hidden" name="student_id" value="<% $student->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">
						M
						<input type="radio" name="gender" value="M" <% ($student->gender eq "M") ? "checked" : "" %> >

						F
						<input type="radio" name="gender" value="F" <% ($student->gender eq "F") ? "checked" : "" %> >
					</td>

					<td align="center">
						<input type="submit" class="smaller" value="Set Gender">
						</form>
					</td>

					</tr>

%				} else { 

%					my $notfirst;

%					foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%						next unless Tab::HousingSlots->search( night => $day->ymd, tournament => $tourn->id );

%						if ($notfirst) { 
							<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
							<td colspan="2">
							</td>
%						}

%						$notfirst++;
			
						<td align="center">
							<% $day->day_abbr %>
						</td>
	
%						my $housing = $student->housing($tourn, $day); 

%						if ($housing) { 

							<td align="center">
								<% ($housing->waitlist) ? "<i>Waitlist</i>" : "Yes" %>
							</th>

							<td align="center">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="whiteblock" href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
										Cancel
									</a>
%								}

							</td>

%							if ($judges_sans_housing{$day->ymd} || $students_sans_housing{$day->ymd}) { 

								<td align="center">
	
%									if ($now->epoch < $reg_end->epoch) {
										<a class="whiteblock" href="housing_transfer.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
											Transfer
										</a>
%									}

								</td>

%							} else { 

								<td></td>
		
%							}

%						} else { 

							<td align="center">
								No
							</td>

							<td align="center">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="whiteblock" href="housing_plz.mhtml?student_id=<% $student->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
										Request
									</a>
%								}
	
							</td>

							<td>
	
							</td>
	
%						}


%					}  

					</tr>

%				}	

%				$switch++;

%			}

		</table>

%		undef $switch;

	<h3>Judges</h3>

	<table cellpadding="3" cellspacing="1" width="100%">

		<tr class="lirdrow">

			<td colspan="100" style="line-height: 20px; border: 1px solid red;">
				NOTE: Most tournaments only offer housing to judges still in
				high school; i.e. students who are judging novice divisions.
				Please check the tournament invite before requesting housing
				for adult judges.
			</td>

		</tr>

		<tr>
			<td></td>
		</tr>

%		foreach my $judge ($school->judges) {

			<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>

				<td>
					<a class="whiteblock" href="/user/chapter/uber_edit.mhtml?uber_id=<% $judge->uber->id %>">
					<% $judge->first." ".$judge->last %>
					(<% $judge->judge_group->abbr %>)
					</a>
				</td>

			</td>

%			unless ($judge->gender) { 

				<td class="explain">
					Set judge gender:
				</td>

				<td colspan="2">
					<form action="judge_sex_change.mhtml" method="post">
					<input type="hidden" name="judge_id" value="<% $judge->id %>">
					<input type="hidden" name="school_id" value="<% $school->id %>">
					M
					<input type="radio" name="gender" value="M" <% ($judge->gender eq "M") ? "checked" : "" %> >
					F
					<input type="radio" name="gender" value="F" <% ($judge->gender eq "F") ? "checked" : "" %> >
				</td>
	
				<td align="center" class="smaller">
					<input type="submit" class="smaller" value="Set Gender">
					</form>
				</td>

%			} else {
				
				<td align="center">
					<% $judge->gender %>
				</td>

%				my $notfirst;

%				foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%					next unless Tab::HousingSlots->search( night => $day->ymd, tournament => $tourn->id );

%					if ($notfirst) { 
						<tr <% ($switch % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
						<td colspan="2">
						</td>
%					}

%					$notfirst++;

					<td align="center">
						<% $day->day_abbr %>
					</td>

%					my $housing = $judge->housing($day);

%					if ($housing) { 

						<th>
							<% ($housing->waitlist) ? "<i>Waitlist</i>" : "Yes" %>
						</th>

						<td align="center">
%							if ($now->epoch < $reg_end->epoch) {
								<a class="whiteblock" href="housing_revoke.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
									Cancel
								</a>
%							}
						</td>

%						if ($judges_sans_housing{$day->ymd} || $students_sans_housing{$day->ymd}) { 

							<td align="center">

%								if ($now->epoch < $reg_end->epoch) {
									<a class="whiteblock" href="housing_transfer.mhtml?housing_id=<% $housing->id %>&school_id=<% $school->id %>">
											Transfer
									</a>
									<form action="housing_transfer.mhtml" method="post">
%								}
							</td>

%						} else { 
	
							<td>
							</td>
%						}

%					} else { 

						<td>
							None
						</td>

						<td align="center">

%							if ($now->epoch < $reg_end->epoch) {

								<a class="whiteblock" href="judge_housing_plz.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>">
								Request Housing
								</a>
%							}

						</td>

						<td>
						</td>

%					}

%				}  

%			}

%			$switch++;

%		}

	</table>


	</div>

	<div class="right small">

%		if ($tourn->method->housing_message) { 

			<h3>Housing Policy/Messages:</h3>

				<p>
					<% $tourn->method->housing_message %>
				</p>

%		}

	</div>
