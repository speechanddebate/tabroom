<%args>
	$tourn
	$school
	$session
	$debug => undef
</%args>
<%init>

	system "$Tab::logger BEGIN THE REPORT" if $debug;

	system "$Tab::logger Getting the schools" if $debug;

	system "$Tab::logger Prep the ballots" if $debug;
	$m->comp("/results/prep_ballots.mas", tourn => $tourn);
	system "$Tab::logger Done prepping the ballots" if $debug;

	system "$Tab::logger Sweeping the students" if $debug;
    $m->comp("/results/sweep_entries.mas", tourn => $tourn, no_prep => 1);

	my %finalists_by_event;
		
	foreach my $event ($m->comp("/funclib/tourn_events.mas", tourn => $tourn)( type => "speech")) { 

		system "$Tab::logger Getting final placements" if $debug;

		my @finalists = $m->comp(
       		"/results/order_entries.mas",
       		tourn => $tourn,
			basis => "final",
			event => $event,
			no_prep => 1,
			finals_only => "1");

		push (@{$finalists_by_event{$event->id}}, @finalists);

	}


	system "$Tab::logger Preparing the document" if $debug;

	my $basename = "/tmp/school-reports-school-".$school->id."-".$session->id;

    my $filename = $Tab::file_root."".$basename;
    my $garbage = `rm -f $filename.*`;

    open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage{helvet}
\\usepackage{colortbl}
\\usepackage{fancyhdr,lastpage}
\\usepackage[hmargin=.8in,vmargin=.7in]{geometry}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot[R]{\\footnotesize Page \\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[L]{\\footnotesize Printed by the Tabroom.com free online tournament management system}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.4}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

\\begin{document}
\\small

EOF

my $tabular_row = "\\begin{tabular}{p{.35in}p{.35in}p{1.5in}p{.35in}p{3.25in}p{.5in}}\n";

	system "$Tab::logger Figuring out who counts" if $debug;

	my %entries_counted = $m->comp("/results/school_count.mas", school => $school, tourn => $tourn);
	my $school_points;

	system "$Tab::logger Adding up total sweepstakes points" if $debug;

	foreach my $entry ($school->entries) {
	   	$school_points = $school_points + $entry->sweeps_points if $entries_counted{$entry->id};
    }

	system "$Tab::logger Printing header " if $debug;

	print TEXOUT "\\begin{tabular}{lr}\n";
	print TEXOUT "{\\Large ".&Tab::texify($school->chapter->name) ."'s results at ".&Tab::texify($tourn->name)."} & ";
	print TEXOUT "{\\large    Total Points: $school_points }\\\\ \n" if $school_points;
	print TEXOUT "\\end{tabular} \n\\newline \n";

	print TEXOUT $tabular_row;
	print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
    print TEXOUT "Code & Event & Name & Pts & Results & Place \\\\ \n";
	print TEXOUT "\\end{tabular} \n\\newline \n";
	print TEXOUT "\\small\n";

	my $switch; 

	system "$Tab::logger Printing results begin:" if $debug;

	COMP:
	foreach my $entry (sort {$a->code <=> $b->code} $school->entries) {

		next if $entry->waitlist == 1|| $entry->dropped == 1;

		my @ballots = Tab::Ballot->search_ordered_by_round($entry->id); 
		next COMP unless @ballots;

		print TEXOUT $tabular_row;
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		print TEXOUT $entry->code." & ";
		print TEXOUT $entry->event->abbr." & ";
		print TEXOUT ($entry->event->team == 1) ? substr($entry->student->last.", ".$entry->student->first,0,20) : "";
		print TEXOUT ($entry->event->team == 2) ? substr($entry->student->last." \\& ".$entry->partner->last,0,20) : "";
		my $c_name = $entry->name if $entry->event->team;
		$c_name =~ s/\&/\\\&/g;
	
		print TEXOUT ($entry->event->team == 3) ? substr($c_name,0,20) : "";

		print TEXOUT  "*" if $entry->event->team == 1 && $entry->student->novice;
		print TEXOUT  "*" if $entry->event->team == 2 && ($entry->student->novice || $entry->partner->novice);

		print TEXOUT " & ";
		print TEXOUT ($entries_counted{$entry->id}) ? "{\\bf".$entry->sweeps_points."}" : $entry->sweeps_points unless $entry->dropped;
		print TEXOUT "DROP" if $entry->dropped;
		print TEXOUT " & ";

		if ($entry->event->type eq "speech") {
			foreach my $ballot (@ballots) { 
				print TEXOUT $ballot->rank."/".$ballot->points;
				print TEXOUT " \\emph{(".$ballot->real_rank."/".$ballot->real_points.") }" 
					if $ballot->real_rank != $ballot->rank;
				print TEXOUT " ";
			}
		}

		print TEXOUT " & ";

		my $entry_rank;
		my $rank;

		foreach my $finalist (@{$finalists_by_event{$entry->event->id}}) {
			$rank++;
			next if $finalist->id != $entry->id;
			$entry_rank = $rank;
		}	

		print TEXOUT "{\\bf ".$entry_rank if $entry_rank;

		print TEXOUT "st }" if $entry_rank == 1;
		print TEXOUT "nd }" if $entry_rank == 2;
		print TEXOUT "rd }" if $entry_rank == 3;
		print TEXOUT "th }" if $entry_rank != 3 && $entry_rank != 2 && $entry_rank != 1 && $entry_rank > 0;

		print TEXOUT "\\end{tabular} \n\\newline \n";

	}

	system "$Tab::logger Printing results end." if $debug;

	print TEXOUT "\\end{document}\n";
	close TEXOUT;

	`cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

	`rm -f $filename.tex $filename.log $filename.dvi $filename.aux` unless $debug;

	$m->redirect($Tab::url_prefix."".$basename.".pdf");

</%init>

