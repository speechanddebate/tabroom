<%args>
	$account
	$school
	$session
</%args>
<%init>

	my $tourn = $school->tourn;

	my @results = $m->comp('/funclib/school_results.mas', school => $school);

	my @result_values = $m->comp('/funclib/school_result_values.mas', school => $school);

	my %values_by_result = ();

	foreach my $value (@result_values) { 
		push @{$values_by_result{$value->result->id}}, $value;
	}

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);

    my $name = $tourn->name."-".$school->short_name;
    $name =~ s/[\W_]//g;

    my $filename = "Results-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 
    
    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1, array => 1.6 );

    open (TEXOUT, ">>$filepath.tex");
    
    print TEXOUT "\\bigskip\n";
    print TEXOUT "{\\Large \\bf ". Tab::texify($tourn->name) ." \\hfill ".Tab::texify($school->short_name)." } \\\\ \n";
    print TEXOUT "\\newline\n";
	print TEXOUT "\\footnotesize\n";

	my $tabular = "\\begin{tabular}{p{.25in}p{1.25in}p{.35in}p{.5in}p{2.25in}p{1.75in}}\n";

	print TEXOUT $tabular;
	print TEXOUT "\\rowcolor[rgb]{1,.95,.66}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT "\\bf Place & \\bf Entry & \\bf Event & \\bf Results & \\bf Tiebreaks & \\bf Ballots \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $switch;

	foreach my $result (@results) { 

		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{.95,.95,.95}\[5.5pt\]\[5.5pt\]\n" if $switch++ % 2;

		my @values = @{$values_by_result{$result->id}};
		my $seed;

		my $label = $result->result_set->label;
		$label =~ s/Places//g;

		foreach my $value (@values) {
			next if $value->value eq "Prelim";
			$seed = $value if $value->tag eq "seed";
			$seed = $value if $value->tag eq "Place";
		}

		print TEXOUT Tab::texify($seed->value) if $seed;

		print TEXOUT " & ".Tab::texify($result->entry->name);

		print TEXOUT " & ".Tab::texify($result->entry->event->abbr);
		print TEXOUT "\\truncate{.5in}{ ".Tab::texify($result->entry->event->name)." } " unless $result->entry->event->abbr;

		print TEXOUT " & ".Tab::texify($label);

		print TEXOUT " &\n \t\\raisebox{.1in}{\\begin{minipage}[t]{2.2in}\%";

		foreach my $value (@values) { 
			next if $value->tag eq "Ballots";
			next if $value->tag eq "Place";
			print TEXOUT "\n \t\t \\parbox[t][][c]{.32in}{\\centering \\tiny{ \\vspace{.64mm} ";
			print TEXOUT Tab::texify($value->tag)."}  \\\\ \\centering \\scriptsize{  ";
			print TEXOUT Tab::texify($value->value)."}\n \\vspace{1mm} } ";
		}

		print TEXOUT "\n\t\\end{minipage}}\n &";
		print TEXOUT "\n \t \\raisebox{.1in}{\\begin{minipage}[t]{1.7in}\%";

		foreach my $value (@values) { 
			next unless $value->tag eq "Ballots";
			my $ballots = $value->value;
			$ballots = Tab::texify($ballots);
			$ballots =~ s/-/\\\\/g;
			$ballots =~ s/^\s+//g;
			$ballots =~ s/^\\&nbsp; //;
			$ballots =~ s/\\&nbsp; /}}\n\t\\parbox[t][][c]{.24in}{\t\\tiny{/g;
			$ballots =~ s/  / /g;
			$ballots =~ s/ /\\newline /g;
			$ballots =~ s/\t/ /g;
			$ballots =~ s/{.newline /{/g;
			$ballots =~ s/.newline }/\n}/g;
			$ballots =~ s/^\\newline//g;
			print TEXOUT "\n \t \\parbox[t][][c]{.24in}{ \\tiny{".$ballots." \n }} ";
		} 
		
		print TEXOUT "\\newline \n\t\\end{minipage} } \\\\ ";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";

	} 
	
	close TEXOUT; 
	
	$m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );


</%init>


