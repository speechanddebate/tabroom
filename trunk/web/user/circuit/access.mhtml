<%args>
	$account
	$tourn_id   => undef
	$circuit_id => undef
</%args>
<%init>

	$m->abort unless $tourn_id;
	$m->abort unless $circuit_id;

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	my $circuit = Tab::Circuit->retrieve($circuit_id);

	my %tourn_circuits = map {$_->id => 1} $tourn->circuits;
	$m->abort unless $tourn_circuits{$circuit_id};

	my @admins = $tourn->admins;

	my %admin_perms = ();

	foreach my $admin (@admins) { 
		my @perms = Tab::Permission->search( tourn => $tourn->id );
		foreach my $perm (@perms) { 
			$admin_perms{$admin}{$perm->tag}++
			if ($perm->tag eq "event_tabbing") { 
				push @{$admin_perms{$admin}{"events"}}, $perm->event 
				$admin_perms{$admin}{$perm->event}++;
			}
		}
	}

</%init>

	<script type="text/javascript">
        function showLimits (it, radio) { 
            var vis = (radio.checked) ? "block" : "none"; 
            document.getElementById(it).style.display = vis;
        } 
    </script>

	<div class="main">
	
		<h2><% $tourn->name %></h2>

		<& tabbar.mas, tourn => $tourn, whoami => "access" &>

		<h4>Administrator Access</h4>

		<& "/funclib/tablesorter.mas", table => "tableme" &>

		<form action="access_save.mhtml" method="post">

		<table id="tableme">

%			if (@admins) { 
	
				<thead>

				<tr class="yellowrow">
				
					<th>	
						Person
					</th>

					<th>
						Public Contact
					</th>

					<th>
						Access Level
					</th>

					<th>
						Access Limits
					</th>

					<th class="smaller">
					</th>
				
				</tr>

				</thead>

				<tbody>

%				my $switch;

% 				foreach my $admin (@admins) { 

					<tr id="<% $admin->id %>" class="<% ($switch++ % 2) ? "odd" : "even" %>" >
	
						<td title="<% $admin->email %>">
							<% $admin->first." ".$admin->last %>< br />
							<% $admin->email %> 
						</td>

						<td title="<% $admin->email %>">
							<input type="checkbox" name="<% $admin->id %>_contact" value="1">
								<% $admin_perms{$admin->id}{"contact"} ? 'checked="checked"' : "" %>>
						</td>

						<td class="centeralign">
							<span class="quarter">
								Owner <input type="radio" name="<% $admin->id %>_level" value="owner" <% $admin_perms{$admin->id}{"owner"} ? 'checked="checked"' : "" %>>
							</span>

							<span class="quarter">
								Admin <input type="radio" name="<% $admin->id %>_level" value="full_admin" <% $admin_perms{$admin->id}{"full_admin"} ? 'checked="checked"' : "" %>>
							</span>

							<span class="quarter">
								Limited <input type="radio" name="<% $admin->id %>_level" value="limited" 
									onclick="showLimits(<% $admin->id %>, this)"> <% $admin_perms{$admin->id}{"limited"} ? 'checked="checked"' : "" %> >
							</span>

							<span class="quarter">
								Entry Only <input type="radio" name="<% $admin->id %>_level" value="entry_only" <% $admin_perms{$admin->id}{"entry_only"} ? 'checked="checked"' : "" %>>
							</span>

						</td>

						<td class="centeralign">

							<div class="nospace" id="<% $admin->id %>" style="<% $admin_perms{$admin->id}{"limited"} ? '"display: none;"' : "" %>">

								<span class="quarter">
									Registration <input type="checkbox" name="<% $admin->id %>_registration" value=1">
								</span>

								<span class="quarter">
									Tabbing <input type="checkbox" name="<% $admin->id %>_tabbing" value=1">
								</span>

								<span class="quarter">
									Tab One Group <input type="checkbox" name="<% $admin->id %>_group_tabbing" value=1">
								</span>

								<span class="quarter" id="<% $admin->id %>_events">
									<select name="<% $admin->id %>_judge_group" class="fixedsmall">
%										foreach my $judge_group ($tourn->judge_groups) { 
											<option value="<% $judge_group->id %>" <% $judge_group->id == $admin_perms{$admin->id}{"judge_group"} ? 'selected="selected"': "" %>>
												<% $judge_group->name %>
											</option>
%										}
									</select>
								</span>

							</div>

						</td>

						<td class="centeralign">
							<a class="dkred padmuchmore" href="access_rm.mhtml?admin_id=<% $admin->id %>">
						</td>

					</tr>
%				}

				<tr class="libl">
					<td class="rightalign" colspan="10">
						<input type="submit" value="Save Permissions">
						</form>
					</td>
				</tr>

				<tbody>

%			}

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Add New Staff:</h4>

			<form action="access_add.mhtml" method="post">
			<input type="hidden" name="tourn_id" value="<% $tourn %>">

			<div class="even">
				<input type="text" name="email" size="20" placeholder="Email address">
			</div>

			<div class="libl rightalign">
				<input  type="submit" class="thin" value="  Grant Access  ">
				</form>
			</div>

		</div>

	</div>


