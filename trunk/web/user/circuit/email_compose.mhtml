<%args>
	$circuit
	$account
	$email_id => undef;
</%args>
<%init>

	my $email = Tab::Email->retrieve($email_id) if $email_id;

	my $now = DateTime->now;

	my @tourns = $m->comp("/funclib/circuit_tourns.mas", circuit => $circuit, approved => "yes");

	my $switch;

	my $year = $now->year;
	$year-- if $now->month < 8;
	my $limit_date = $year."-07-01";
	my $limit = DateTime::Format::MySQL->parse_date($limit_date);

</%init>

	<& menu.mas, circuit => $circuit, whoami => "compose", year => $year &>

	<& /funclib/editor.mas &>

	<div class="main">

		<h2>Send email</h2>

		<div class="evenrow block">

			<span class="third">
				Subject:
			</span>

			<span class="twothird">
				<form action="email_send.mhtml" method="post"> 
				<input type="hidden" name="circuit_id" value="<% $circuit->id %>">
				<input type="text" name="subject" size="48" value="<% ($email) ? $email->subject : "" %>" >
			</span>

		</div>

		<div class="oddrow block">

			<span class="third">
				<label for="all">
					Send to all <% $circuit->abbr %> members:
				</label>
			</span>

			<span class="twothird">
				<input id="all" type="checkbox" name="members" value="1">
			</span>

		</div>

		<table width="100%" cellpadding="3" cellspacing"1">

%		my $tick;
	
%		foreach my $tourn (sort {$b->start <=> $a->start} @tourns) { 
	
%			next unless $tourn->name;
%			next if $tourn->end && $tourn->end->epoch < $limit->epoch;
% 			next if $tourn->reg_start && $tourn->reg_start->epoch > $now->epoch;
	
% 			my $tourn_key = "tourn_".$tourn->id;

%			unless ($tick) { 
				</tr>	
				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>
%				$tick++;
%			} else { 
%				undef $tick;
%			} 
	
				<td class="smallish centeralign">
					<span class="half inline leftalign">
						<label for="<% $tourn->id %>">
							Send to <% $tourn->name %> entrants
						</label>
					</span>
				</td>
	
				<td>
					<input id="<% $tourn->id %>" type="checkbox" name="<% $tourn_key %>" value="1">
				</td>
% 		}

	</table>
	
	<h4>Email text:</h4>

	<div class="centeralign">
		<textarea name="content" cols="55" rows="20"><% ($email) ? $email->content : "" %></textarea>
	</div>

	<div class="rightalign liblrow">
		<input type="submit" value="   Send Email   ">
		</form>
	</div>

	</div>
