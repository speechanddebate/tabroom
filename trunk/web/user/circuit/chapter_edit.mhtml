<%args>
	$chapter_id
	$account
	$session
	$circuit
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);
	my $switch;

	unless (Tab::ChapterCircuit->search( chapter => $chapter, circuit => $circuit->id )) { 
		my $msg = "That school is not in your circuit";
		$m->redirect("chapters.mhtml?circuit_id=".$circuit->id."&msg=$msg&all=yep");
	}

</%init>

	<& menu.mas, whoami => "chapters", chapter => $chapter, circuit => $circuit &>

	<div class="main">

		<h2><% $chapter->name %></h2>

		<table cellpadding="10" cellspacing="1">

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >
	
				<th class="rightalign">
					School/Team Name
				</th>

				<td>
					<form action="chapter_save.mhtml" method="post"> 
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="hidden" name="circuit_id" value="<% $circuit->id %>">
					<input type="text" name="name" size="47" value="<% $chapter->name %>">
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					Country
				</th>

				<td>
					<select name="country" class="fixed">
						<& /funclib/country_select.mas, country => $chapter->country &>
					</select>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					State/Province (if applicable)
				</th>

				<td>
					<select name="state" class="fixed">
						<& /funclib/state_select.mas, state => $chapter->state &>
					</select>
				</td>

			</tr>

			<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

				<th class="rightalign">
					Coach names (for credits)
				</th>

				<td>
					<input type="text" name="coaches" size="47" value="<% $chapter->coaches %>">
				</td>

			</tr>
	
			<tr class="liblrow">

				<td colspan="2" class="rightalign">
					<input type="submit" value=" Save Chapter Details ">
					</form>
				</td>
			</tr>

		</table>

		<h4>Accounts with access to this tabroom.com chapter</h4>

		<table cellpadding="5" cellspacing="1">

%			foreach my $coach ($m->comp("/funclib/chapter_admins.mas", chapter => $chapter)) { 

				<tr <% ($switch++ % 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	

    	    	    <td>
       		    	    <% $coach->first." ".$coach->last %>
					</td>

           			<td>
						<a class="white" href="mailto:<% $coach->email %>">
               			<% $coach->email %>
						</a>
           			</td>

           			<td class="centeralign">
						<a class="dkred block" href="chapter_admin_rm.mhtml?coach_id=<% $coach->id%>&chapter_id=<% $chapter->id%>&circuit_id=<% $circuit->id %>">
							Remove
						</a>
		            </td>

	       		</tr>

%			}

			<tr class="liblrow">

				<th>
					Add:
				</th>
	
	       		<td>
					<form action="chapter_admin_add.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					<input type="hidden" name="circuit_id" value="<% $circuit->id %>">
					<input type="text" name="email" size="47" value="Enter coach's email address" onfocus="value=''">
				</td>
	
       			<td class="rightalign">
					<input type="submit"  value="   Grant    ">
					</form>
				</td>

			</tr>

		</table>

		<h4>Circuit Memberships</h4>
		
		<table cellpadding="5" cellspacing="1">

%			my %circuit_mem = ();

%			foreach my $circuit ($circuit) { 

%				$circuit_mem{$circuit->id}++;

%				my $mem = Tab::ChapterCircuit->search( chapter => $chapter->id, circuit => $circuit->id )->first;
			
				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow"%>" >

					<td>
						<% $circuit->name %>
					</td>

					<td>
						<% $mem->full_member ? "Full Member" : "Tournaments Only" %>
					</td>

					<td class="centeralign smallish">
						<a class="dkred block" href="chapter_circuit_rm.mhtml?circuit_id=<% $circuit->id %>&chapter_id=<% $chapter->id %>">
							REMOVE
						</a>
					</td>

				</tr>

%			}

			<tr class="liblrow">

				<td>
					<form action="chapter_circuit_add.mhtml" method="post">
					<input type="hidden" name="chapter_id" value="<% $chapter->id %>">
					Join:

					&nbsp;

					<select name="circuit_id" class="fixedsmall"
%						foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search( active => 1 )) {  
%							next if $circuit->setting("ncfl");
%							next if $circuit_mem{$circuit->id};
							<option value="<% $circuit->id %>">
								<% $circuit->name %>
							</option>
%						}
					</select>

				</td>

				<td class="centeralign">
					<input type="submit" class="thin" name="full" value="Full Membership">
				</td>

				<td class="centeralign">
					<input type="submit" class="thin" name="tournaments" value="Tournaments Only">
					</form>
				</td>

			</tr>

		</table>

	</div>

