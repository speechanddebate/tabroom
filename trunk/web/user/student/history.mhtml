<%args>
	$account
	$tourn_id => undef
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	my @panels = $m->comp("/funclib/account_student_panels.mas", account => $account, tourn => $tourn);
	my @done_panels = $m->comp("/funclib/account_student_panels.mas", account => $account, done => 1, tourn => $tourn);

</%init>

	<& /user/menu.mas, whoami => "student", account => $account &>

	<div class="left huge">

		<h2>Your <% $tourn->name %> Results</h2>

%		if (@panels) { 

			<h3>Unpublished Rounds</h3>

			<table cellpadding="4" cellspacing="1">

				<tr class="yellowrow">

					<th class="smallish">
						Round
					</th>

					<th class="smallish">
						Start
					</th>

					<th class="smallish">
						Room
					</th>

					<th class="smallish">
						Pos
					</th>
						
					<th class="smallish">
						Judging
					</th>

				</tr>

%				my $switch;

%				foreach my $panel (@panels) { 

%					my $tz = $panel->round->event->tourn->tz;
%					$tz = "UTC" unless $tz;
%					my $tzname = Tab::tzname($tz);

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							<% $panel->round->realname %>
						</td>

						<td>
							<% Tab::niceshortdt($panel->round->timeslot->start) %> <% $tzname %>
						</td>

						<td>
							<% $panel->room ? $panel->room->name : "No Room" %>
						</td>

						<td>
%							if ($panel->round->event->type eq "debate" 
%									|| $panel->round->event->type eq "policy" 
%									|| $panel->round->event->type eq "ld") { 

								<% $panel->bye ? "Bye" : $panel->side == 1 ? "Aff" : "Neg" %>

%							} elsif ($panel->round->event->type eq "pf") { 

								<% $panel->bye ? "Bye" : $panel->side == 1 ? "Pro" : "Con" %>

%							} elsif ($panel->round->event->type eq "wudc") { 

								<% $panel->pos == 1 ? "1st Gov" : "" %>
								<% $panel->pos == 2 ? "1st Opp" : "" %>
								<% $panel->pos == 3 ? "2nd Gov" : "" %>
								<% $panel->pos == 4 ? "2nd Opp" : "" %>

%							} elsif ($panel->round->event->type eq "speech") { 
								<% Lingua::EN::Numbers::Ordinate::ordinate($panel->pos) %>
%							} 

						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<div class="block padless smallish">
%									if ($judge->account && $judge->account > 0) {
										<a href="/jbruschke/JudgeRecord.php?judgeid=<% $judge->account->id %>" class="white block">
%									} else { 
										<a class="plain block">
%									}
									<% $judge->first." ".$judge->last %> 
									(<% $judge->school ? $judge->school->short_name : "Hire" %>)
									</a>
								</div>
%							}
						</td>

					</tr>

%				}

			</table>
			
			<br />

%		}

%		if (@done_panels) { 

			<h3>Published Results</h3>

			<table cellpadding="4" cellspacing="1">

				<tr class="yellowrow">

					<th class="smallish">
						Round
					</th>

					<th class="smallish">
						Pos
					</th>
						
					<th class="smallish">
						Judging
					</th>

					<th class="smallish">
						Result
					</th>

				</tr>

%				my $switch;

%				foreach my $panel (@done_panels) { 

%					my $entry = Tab::Entry->retrieve($panel->entryid);
%					my %student_by_id = ();
%					foreach my $student ($entry->students) { 
%						$student_by_id{$student->id} = $student;
%					}

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							<% $panel->round->realname %>
						</td>

						<td>
%							if ($panel->round->event->type eq "debate" 
%									|| $panel->round->event->type eq "policy" 
%									|| $panel->round->event->type eq "ld") { 

								<% $panel->bye ? "Bye" : $panel->side == 1 ? "Aff" : "Neg" %>

%							} elsif ($panel->round->event->type eq "pf") { 

								<% $panel->bye ? "Bye" : $panel->side == 1 ? "Pro" : "Con" %>

%							} elsif ($panel->round->event->type eq "wudc") { 

								<% $panel->pos == 1 ? "1st Gov" : "" %>
								<% $panel->pos == 2 ? "1st Opp" : "" %>
								<% $panel->pos == 3 ? "2nd Gov" : "" %>
								<% $panel->pos == 4 ? "2nd Opp" : "" %>

%							} elsif ($panel->round->event->type eq "speech") { 
								<% Lingua::EN::Numbers::Ordinate::ordinate($panel->pos) %>
%							} 

						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<div class="block padless smallish nowrap medspan">
%									if ($judge->account && $judge->account > 0) {
										<a href="/jbruschke/JudgeRecord.php?judgeid=<% $judge->account->id %>" class="white block marno" target="_blank">
%									} else { 
										<a class="plain block">
%									}
									<% $judge->first." ".$judge->last %> 
									(<% $judge->school ? $judge->school->short_name : "Hire" %>)
									</a>
								</div>
								<br />
%							}
						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%								my @scores = $m->comp("/funclib/panel_scores.mas", panel => $panel, judge => $judge, entry_id => $panel->entryid);
								<div class="block padless smallish">

%									if ($panel->round->post_results > 0) {
										<span class="microspan" style="padding-top: 3px; padding-bottom: 4px;">
%											foreach my $score (@scores) { 
												<% $score->tag eq "ballot" ? $score->value == 1 ? "W" : "L" : ""%>
%											}
										</span>
%									}

%									if ($panel->round->post_results == 2) {
%										foreach my $student ($entry->students) { 
											<span class="medspan nowrap">
%											foreach my $score (@scores) { 
%												next if $score->tag eq "ballot";
%												next unless $score->studentid != $student->id;
												<% $score->tag eq "points" ? $score->value : "" %>
												<% $score->tag eq "rank" ? Lingua::EN::Numbers::Ordinate::ordinate($score->value) : "" %>
%											}
											- <% $student->last %>
											</span>
%										}
%									}

%									my @values = $m->comp("/funclib/panel_ballot_values.mas", panel => $panel, judge => $judge, rfd => "rfd", entry => $entry);

%									if (@values) { 

										<span class="evensmallerspan smallish">
											<a target="_blank" class="dkgreen block" href="rfd_view.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
												RFD
											</a>
										</span>
%									}

								</div>
%							}

						</td>

					</tr>

%				}

			</table>
			
			<br />
%		}

	</div>

