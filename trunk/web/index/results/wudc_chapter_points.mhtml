<%args>
	$account => undef
	$chapter_id => undef
</%args>
<%init>
	
	use Time::HiRes qw( time );
	use Data::Dumper;
	use POSIX qw(strftime);

	my $tz = $account->tz if $account;
	$tz = "UTC" unless $tz;

	my $start=time();
	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($chapter) { 
		$m->print("No chapter with id $chapter_id found");
		$m->abort;
	}
				
	Tab::Entry->columns(TEMP => qw/school_name/);
	Tab::Entry->columns(TEMP => qw/tourn_name/);
	Tab::Entry->columns(TEMP => qw/tourn_start/);
	Tab::Entry->columns(TEMP => qw/tourn_end/);
	Tab::Entry->columns(TEMP => qw/tourn_id/);
	Tab::Entry->columns(TEMP => qw/tourn_weight/);
	Tab::Entry->columns(TEMP => qw/result_id/);
	Tab::Entry->columns(TEMP => qw/rank/);
	Tab::Entry->columns(TEMP => qw/event_id/);
	Tab::Entry->columns(TEMP => qw/points/);
	Tab::Entry->set_sql(pull_points => "
			select entry.*, school.name as school_name, tourn.name as tourn_name, tourn.id as tourn_id, tourn.start as tourn_start, tourn.end as tourn_end, tourn_setting.value as tourn_weight, result.id as result_id, entry.event as event_id, result.rank as rank, result_value.value as points
			from school, entry, tourn, result, tourn_setting, result_value
			where school.chapter = $chapter_id
			and entry.school=school.id
			and tourn.id=school.tourn
			and result.entry=entry.id
			and result_value.result=result.id
			and result_value.tag='WUDC Points'
			and tourn_setting.tourn=school.tourn
			and tourn_setting.tag='weight'
			order by tourn.start, entry.event
			");

	my @entries = Tab::Entry->search_pull_points;
	#print "Row 1=".Dumper($entries[0]);
	
	my $totalpoints;
	
</%init>

	<& menu.mas &>

	<div class="main">

	<h4>WUDC points breakdown for <% $chapter->name %></h4>

		<& /funclib/tablesorter.mas, table => "WUDC" &>

		<table cellpadding="3" width="100%" id="WUDC" class="tablesorter">
		<thead>
			<tr class="dkgreen">
				<th class="smaller">Tournament</th>
				<th class="smaller">Date</th>
				<th class="smaller">Entry</th>
				<th class="smaller">Tourney Weight</th>
				<th class="smaller">Entries</th>
				<th class="smaller">Place</th>
				<th class="smaller">Points</th>
			</tr>
		</thead>
		<tbody>

%			foreach my $entry (@entries) {
				<tr>
					<td> <% $entry->tourn_name %> </td>
%					if (substr($entry->tourn_start, 0 , 4) ne "0000") {					
%					my $date = DateTime::Format::MySQL->parse_datetime($entry->tourn_start);					
					<td> <% Tab::pickerdate($date) %> </td>
%					} else {
					<td>Not Entered</td>
%					}					
%					my $entryname = $entry->name; if ($entryname eq "") {$entryname = $entry->code;}					
					<td> <% $entryname %> </td>
					<td> <% $entry->tourn_weight %> </td>
%					my @nentries = Tab::Entry->search(event=> $entry->event_id);									
					<td> <% scalar(@nentries) %> </td>
					<td> <% $entry->rank %> </td>
					<td> <% $entry->points %> </td>
%						$totalpoints = $totalpoints + $entry->points;					
				</tr>

%			}

			</tbody>

			<tr>
				<td colspan="6" class="rightalign">
					Total:
				</td>
				<td>
					<% $totalpoints %>
				</td>
			</tr>

		</table>
		
% 	my $end = time();
% 	#printf("%.2f\n", $end - $start);

	</div>
