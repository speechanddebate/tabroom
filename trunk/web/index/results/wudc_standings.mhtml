<%args>
	$account => undef
	$circuit => undef
</%args>
<%init>
	
	use Time::HiRes qw( time );
	use Data::Dumper;
		
	my $start = time(); 
	
	Tab::Chapter->columns(TEMP => qw/points/);
	Tab::Chapter->columns(TEMP => qw/avgpts/);
	Tab::Chapter->columns(TEMP => qw/toteams/);
	Tab::Chapter->columns(TEMP => qw/tourneys/);
	Tab::Chapter->columns(TEMP => qw/nentries/);
	Tab::Chapter->set_sql(pull_competitors => "
		select chapter.id, sum(result_value.value) as points, chapter.name, count(entry.id) as nentries, avg(result_value.value) as avgpts, count(distinct entry.tourn) as tourneys
		from entry, result, result_value, chapter, school
		where school.chapter=chapter.id
		and school.id=entry.school
		and result.entry=entry.id
		and result_value.result=result.id
		and result_value.tag='WUDC Points'
		group by chapter.id
		order by points desc
	");
	my @chpt = Tab::Chapter->search_pull_competitors;
	
	sub commify {
		local($_)=shift;
		1 while s/^(-?\d+)(\d{3})/$1,$2/;
		return $_;
	}
	
</%init>

	<& menu.mas &>

	<div class="main">
	
	<h2>WUDC format point standings</h2>
	Click the name of any school to see a detailed breakdown.  See the links in the right-hand bar for more information.

	<& /funclib/tablesorter.mas, table => "WUDC" &>

		<table cellpadding="3" width="100%" id="WUDC" class="tablesorter">
		<thead>
			<tr class="dkgreen">
				<th class="smaller">chapter</th>
				<th class="smaller">Tourneys attended</th>
				<th class="smaller">Total Entries</th>
				<th class="smaller">Avg per entry</th>
				<th class="smaller">Points</th>
			</tr>
		</thead>
%			foreach my $chpt (@chpt) {
				<tr>
					<td> <a href="wudc_chapter_points.mhtml?chapter_id=<% $chpt->id %>"> <% $chpt->name %> </a></td>
					<td> <% commify($chpt->tourneys) %> </td>
					<td> <% commify($chpt->nentries) %> </td>
					<td> <% sprintf("%.1f", $chpt->avgpts) %> </td>
					<td> <% commify($chpt->points) %> </td>
				</tr>
%			}

		</table>
		
% my $end = time();
% printf("%.2f\n", $end - $start);

	</div>
