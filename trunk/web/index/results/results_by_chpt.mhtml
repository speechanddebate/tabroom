<%args>
	$account    => undef
	$chapter    => undef
	$chapter_id
	$year       => undef
	$circuit_id => undef	
</%args>
<%init>

	use Time::HiRes qw( time );
	use POSIX qw(strftime);
	my $code_start = time(); 
	Tab::debuglog("CODE STARTS");
		
	$chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($year) { 
		my $this_year = Tab::school_year;
		$year = $this_year->year;
	}

	my $start_string = "07/01/$year";
	my $end_string = "06/30/".($year + 1);

	my $start_dt = Tab::dtme($start_string);	
	my $end_dt = Tab::dtme($end_string);	

	my $code_end = time(); Tab::debuglog("Time before first pull ".sprintf("%.2f", $code_end-$code_start) );

	#Load results for debate teams; can't link to entries in 1 pull because so many tourneys
	#don't publish final results

	Tab::ResultValue->columns(TEMP => qw/event_name/);	
	Tab::ResultValue->columns(TEMP => qw/tourn_name/);	
	Tab::ResultValue->columns(TEMP => qw/entry_id/);		
	Tab::ResultValue->columns(TEMP => qw/rank/);		
	Tab::ResultValue->set_sql(pull_results => "
		select result_value.*, event.name as event_name, entry.id as entry_id, tourn.name as tourn_name, result.rank as rank
		from entry, school, event, tourn, result_set, result_value, result
		where entry.school=school.id
		and school.chapter = $chapter_id
		and result.entry=entry.id
		and event.id=entry.event
		and tourn.id=entry.tourn
		and result_set.tourn=tourn.id
		and result.result_set=result_set.id
		and result_value.result=result.id
		and tourn.start >= '$start_dt'
		and tourn.end <=  '$end_dt'
		and result_set.label='Final Places'
		and result_value.tag='Place'
		and event.type !='speech'
		and event.type !='congress'
		order by rank asc
	");
	
	my @chpt_result = Tab::ResultValue->search_pull_results;
	my %debate_results;	
	foreach my $result (@chpt_result) {
		$debate_results{$result->entry_id}{'place'} = $result->value;
		$debate_results{$result->entry_id}{'rank'} = $result->rank;
		$debate_results{$result->entry_id}{'percentile'} = $result->result->percentile;
	}
	
	$code_end = time(); Tab::debuglog("Time AFTER first pull ".sprintf("%.2f", $code_end-$code_start) );
	
	#now pull debate entries and link them back to the result_set values
	Tab::Entry->set_sql(pull_entry => "
		SELECT entry.*, tourn.start as tourn_start
		FROM entry, school, event, tourn
		WHERE school.chapter = $chapter_id
		and entry.school=school.id
		and tourn.id=event.tourn
		and event.id=entry.event
		and tourn.start >= '$start_dt'
		and tourn.end <=  '$end_dt'
		and event.type != 'speech'
		and event.type != 'congress'
	");
	
	my @debate_entries = Tab::Entry->search_pull_entry;
	$code_end = time(); Tab::debuglog("Time AFTER first pull ".sprintf("%.2f", $code_end-$code_start) );	
	
	foreach my $entry (@debate_entries) {
		$debate_results{$entry->id}{'name'} = $entry->name;
		$debate_results{$entry->id}{'tourn'} = $entry->event->tourn->name;
		$debate_results{$entry->id}{'tourn_start'} = Tab::pickerdate($entry->event->tourn->start);
		$debate_results{$entry->id}{'event'} = $entry->event->name;	
		my %win = $m->comp("/funclib/entry_wins.mas", event => $entry->event );
		$debate_results{$entry->id}{'wins'} = $win{$entry->id};
		$debate_results{$entry->id}{'wins'} = 0 unless $debate_results{$entry->id}{'wins'};
		my %loss = $m->comp("/funclib/entry_losses.mas", event => $entry->event );
		$debate_results{$entry->id}{'losses'} = $loss{$entry->id};
		$debate_results{$entry->id}{'losses'} = 0 unless $debate_results{$entry->id}{'losses'};
		$debate_results{$entry->id}{'rank'} = "999" unless $debate_results{$entry->id}{'rank'};
	}
	
	#speaker awards
	Tab::EntryStudent->columns(TEMP => qw/place/);		
	Tab::EntryStudent->set_sql(pull_speakers => "
		select entry_student.*, result_value.value as place
		from entry_student, school, entry, student, result, event, tourn, result_set, result_value
		where entry.id=entry_student.entry
		and entry.school=school.id
		and school.chapter = $chapter_id
		and student.id=entry_student.student
		and result.student=entry_student.student
		and event.id=entry.event
		and tourn.id=entry.tourn
		and tourn.start >= '$start_dt'
		and tourn.end <=  '$end_dt'
		and result_set.tourn=tourn.id
		and result_set.id=result.result_set
		and result_set.label='Speaker Awards'
		and result_value.result=result.id
		and result_value.tag='Order'
		and event.type !='speech'
		and event.type !='congress'
		order by result_value.value+0
	");
	my @speakers = Tab::EntryStudent->search_pull_speakers;
	$code_end = time(); Tab::debuglog("Time AFTER speaker pull ".sprintf("%.2f", $code_end-$code_start) );	
	
</%init>

	<& menu.mas, circuit_id => $circuit_id, year => $year &>
	
	<div class="left huge">
	
		<h2>Seasonal Results for <% $chapter->short_name %></h2>

		<& /funclib/tablesorter.mas, table => "sortme" &>

		<h4>Debate Results</h4>

		<p class="explain"> 
			Final places will only be available if published by the tournament.
		</p>
				
		<table cellpadding="4" id="sortme">

			<thead>
				<tr class="yellowrow">
					<th class="smallish">
						Tourney
					</th>
					<th class="smallish">
						Dates
					</th>
					<th class="smallish">
						Event
					</th>
					<th class="smallish">
						Entry
					</th>
					<th class="smallish">
						Prelim Record
					</th>
					<th class="smallish">
						Finish
					</th>
					<th class="smallish">
						Rank-Percentile
					</th>
				</tr>
				</tr>
			</thead>

			<tbody>

%				foreach my $key (sort {$debate_results{$a}->{'rank'} <=> $debate_results{$b}->{'rank'}} keys(%debate_results)) {			
				<tr>
					<td> <% $debate_results{$key}{'tourn'}  %> </td>
					<td> <% $debate_results{$key}{'tourn_start'} %> </td>					
					<td> <% $debate_results{$key}{'event'}  %> </td>
					<td> <% $debate_results{$key}{'name'}  %> </td>
					<td> <% $debate_results{$key}{'wins'} %>-<% $debate_results{$key}{'losses'} %> </td>						
					<td> <% $debate_results{$key}{'place'} %> </td>											
					<td> <% $debate_results{$key}{'rank'} %>-<% sprintf("%.1f", $debate_results{$key}{'percentile'}/100) %>% </td>							
				</tr>
%				}					
			</tbody>

		</table>

		<h4>Debate Speaker Awards</h4>

		Speakers will only be availble if published by the tournament.
				
		<table cellpadding="4" id="sortme">
		
			<thead>
				<tr class="yellowrow">
					<th class="smallish">
						Tourney
					</th>
					<th class="smallish">
						Event
					</th>
					<th class="smallish">
						Speaker
					</th>
					<th class="smallish">
						Finish
					</th>
				</tr>
				</tr>
			</thead>

			<tbody>

%				foreach my $spkr (@speakers) {			
				<tr>
					<td> <% $spkr->entry->tourn->name %> </td>				
					<td> <% $spkr->entry->event->name %> </td>									
					<td> <% $spkr->student->first %> <% $spkr->student->last %> </td>
					<td> <% $spkr->place %> </td>					
				</tr>
%				}					
			</tbody>

		</table>


	</div>
