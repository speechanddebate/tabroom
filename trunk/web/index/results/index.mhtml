<%args>
	$tourn_id 	=> undef
	$country  	=> undef
	$state    	=> undef
	$circuit_id => undef
</%args>
<%init>

	my $now = DateTime->now;

	if ($circuit_id) { 

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn, tourn_circuit
			where exists (
				select result_set.id from result_set
				where result_set.tourn = tourn.id
			)
			and tourn.id = tourn_circuit.tourn
			and tourn_circuit.circuit = $circuit_id
			order by tourn.start DESC
			limit 50
		");

		Tab::Tourn->set_sql(by_round_results_published => "
			select distinct tourn.*
			from tourn, event, round, tourn_circuit
			where tourn.id = event.tourn
			and tourn.id = tourn_circuit.tourn
			and tourn_circuit.circuit = $circuit_id
			and event.id = round.event
			and round.post_results > 0
			order by tourn.start DESC
			limit 50 
		");


	} else { 

		Tab::Tourn->set_sql(by_results_published => "
			select distinct tourn.*
			from tourn
			where exists (
				select result_set.id from result_set
				where result_set.tourn = tourn.id
			)
			order by tourn.start DESC
			limit 50
		");

		Tab::Tourn->set_sql(by_round_results_published => "
			select distinct tourn.*
			from tourn, event, round
			where tourn.id = event.tourn
			and event.id = round.event
			and round.post_results > 0
			order by tourn.start DESC
			limit 50 
		");

	}

	my @published = (Tab::Tourn->search_by_round_results_published, Tab::Tourn->search_by_results_published);

	my %seen = (); 
	@published = grep { ! $seen{$_} ++ } @published;

	my $switch;

</%init>

	<& menu.mas &>
	
	<div class="main">

		<h2>Recent Tournament Results</h2>

		<p class="explain padless">
			To view your league results and stats select a circuit from the
			right, or to see results for an individual tournament
			click a name below.
		</p>

		<& /funclib/tablesorter.mas, table => "results" &>

		<table id="results">

			<thead>

			<tr class="yellowrow">
			
				<th class="smaller">
					Dates
				</th>

				<th class="smaller">
					Locale
				</th>

				<th class="smaller">
					Circuit(s)
				</th>

				<th class="smaller">
					Tournament
				</th>

				<th class="smaller nosort">
					
				</th>

			</tr>

			</thead>

			<tbody>

%			foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @published) { 

%				next if $tourn->start > $now;
				
				<tr class="<% ($switch++ % 2) ? "odd" : "even" %>">
			
					<td class="smallish">
						<% Tab::pickerdate($tourn->start) %>
					</td>

					<td class="smallish">
						<% $tourn->location %> 
					</td>

					<td class="smallish">
%						foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
							<a class="white padless marno smallish" href="index.mhtml?circuit_id=<% $circuit->id %>">
								<% $circuit->abbr %>
							</a>
%						}
					</td>

					<td class="nospace">
						<a class="white padmore marno" href="/index/tourn/index.mhtml?tourn_id=<% $tourn->id %>">
							<% $tourn->name %>
						</a>
					</td>

					<td class="nospace smallish nowrap">
						<a class="dkgreen padmore marno" href="/index/tourn/results/index.mhtml?tourn_id=<% $tourn->id %>">
							Results
						</a>
					</td>
			
				</tr>

%			}

			</tbody>

		</table>

	</div>
