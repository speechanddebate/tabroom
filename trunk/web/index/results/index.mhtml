<%args>
	$tourn_id => undef
	$country => undef
	$state => undef
</%args>
<%init>

	my $now = DateTime->now;

	Tab::Tourn->set_sql(by_results_published => "
		select distinct tourn.*
		from tourn,tourn_setting
		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = \"results\"
		and tourn_setting.value = 1
		and tourn.hidden != 1
		and tourn.approved = 1
		order by tourn.start DESC
		limit 25
	");

	Tab::Tourn->set_sql(by_new_results_published => "
		select distinct tourn.*
		from tourn, event, event_setting
		where tourn.id = event.tourn
		and event.id = event_setting.event
		and event_setting.tag = \"results_published\"
		and event_setting.value = 1
		order by tourn.start DESC
		limit 25
	");

	my @new_published = Tab::Tourn->search_by_new_results_published;
	my @published = Tab::Tourn->search_by_results_published;

	my $switch;

</%init>

	<& menu.mas &>
	
	<div class="main">

		<h2>Recent Tournament Results</h2>

		<p class="explain padless">
			To view your league results and stats select a circuit from the
			right-hand column, or to see results for an individual tournament
			click a name below.
		</p>

		<table cellpadding="3" width="100%">

			<tr class="yellowrow">
			
				<th class="smaller">
					Dates
				</th>

				<th class="smaller">
					Locale
				</th>

				<th class="smaller">
					Circuit(s)
				</th>

				<th class="smaller">
					Tournament
				</th>

			</tr>

%			foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @new_published) { 

%				next if $tourn->start > $now;
				
				<tr class="<% ($switch++ %2) ? "oddrow" : "evenrow" %>">
			
					<td>
						<% Tab::pickerdate($tourn->start) %>
					</td>

					<td class="centeralign">
						<a class="white white" href="/index/tourn/results/index.mhtml?tourn_id=<% $tourn->id %>">
							<% $tourn->location %> 
						</a>
					</td>

					<td class="centeralign">
%						foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
							<% $circuit->abbr %>
%						}
					</td>

					<td class="nowrap bigspan">
						<a class="white white" href="/index/tourn/results/index.mhtml?tourn_id=<% $tourn->id %>">
							<% $tourn->name %>
						</a>
					</td>
			
				</tr>

%			}

%			foreach my $tourn (sort {$b->start->epoch <=> $a->start->epoch} @published) { 

%				next if $tourn->start > $now;
%				next if $switch > 25;
				
				<tr class="<% ($switch++ %2) ? "oddrow" : "evenrow" %>">
			
					<td>
						<% Tab::pickerdate($tourn->start) %>
					</td>

					<td class="centeralign">
						<a class="white white" href="<% $Tab::s3_url %>/results/<% $tourn->id %>/index.mhtml?tourn_id=<% $tourn->id %>">
						<% $tourn->location %> 
						</a>
					</td>

					<td class="centeralign">
%						foreach my $circuit ($m->comp("/funclib/tourn_circuits.mas", tourn => $tourn)) { 
							<% $circuit->abbr %>
%						}
					</td>

					<td class="nowrap bigspan">
						<a class="white white" href="<% $Tab::s3_url %>/results/<% $tourn->id %>/index.mhtml?tourn_id=<% $tourn->id %>">
						<% $tourn->name %>
						</a>
					</td>

			
				</tr>

%			}

		</table>

	</div>
