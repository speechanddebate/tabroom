<%args>
	$round
	$debug => undef
	$sort_by => "letter"
</%args>
<%init>

	my $event = $round->event;
	my $tourn = $event->tourn;

	my $codes = $tourn->setting("schemat_display");
	
	Tab::Panel->columns(TEMP => "roomname");

	Tab::Panel->set_sql( schemat => "
		select panel.*, room.name as roomname
		from panel, room
		where panel.round = ? 
		and panel.room = room.id
		order by panel.letter");

	Tab::Panel->set_sql( schemat_roomless => "
        select panel.*, \"None\" as roomname
        from panel
        where panel.round = ? 
        and panel.room = 0
        order by panel.letter");


	my @panels = Tab::Panel->search_schemat($round->id);
	push (@panels, Tab::Panel->search_schemat_roomless($round->id));

	my @entries = $m->comp("/funclib/round_entries.mas", round => $round);
	my @judges = $m->comp("/funclib/round_judges.mas", round => $round);
	my @ballots = $m->comp("/funclib/round_ballots.mas", round => $round);

    my %judge_by_id = (); 
    foreach my $judge (@judges) { 
        $judge_by_id{$judge->id} = $judge;
    }   

	my %entries_by_panel = ();

	foreach my $entry (@entries) { 
		next if $entry->dq;
		push (@{$entries_by_panel{$entry->panelid}}, $entry);
	}

	my %ballots_by_entry = ();
	my %panel_undone = ();
    my %judges_by_panel = ();

	foreach my $ballot (@ballots) { 
		push (@{$ballots_by_entry{$ballot->entry->id}}, $ballot) if $ballot->entry;
		$panel_undone{$ballot->panel->id}++ unless $ballot->audit;
		push (@{$judges_by_panel{$ballot->panel->id}}, $judge_by_id{$ballot->judge->id});
	}

	@panels = sort {$a->roomname cmp $b->roomname} @panels;

</%init>

	<& /funclib/tablesorter.mas, table => "sort" &> 

	<table cellpadding="1" cellspacing="1" width="100%" id="sort"> 

		<thead>
		
		<tr class="yellowrow">

			<td class="small centeralign smallcell">
			</td>

%			if ($round->flighted > 1) { 
				<th>
					Flight
				</th>
%			}
			
			<th class="centeralign">
				<span class="block">
				Room
			</th>

			<th class="centeralign">
				<span class="block">
				<% $round->type eq "elim" ? "Flip Rounds " : "Aff" %>
			</th>

			<th class="centeralign">
				<span class="block">
				<% $round->type eq "elim" ? "Flip Rounds " : "Neg" %>
			</th>

			<th class="centeralign">
				<span class="block">
				Judge<% $round->judges > 1 ? "s" : "" %>
			</th>

		</tr>

		</thead>

		<tbody>

%		my $switch;

% 		foreach my $panel (@panels) { 

			<tr>

				<td class="small centeralign smallcell">
					<% $switch %>
				</td>
			
%				if ($round->flighted > 1) { 
					<td class="centeralign">
						<% $panel->flight %>
					</td>	
%				}

				<td class="smallish">
%					if ($panel->bye) { 
						BYE
%					}  else { 
						<% ($panel->roomname) ? $panel->roomname : " None " %>
%					}  
				</td>

<%perl>
				my $aff;
				my $neg;
				my $bye;

				foreach my $pc (@{$entries_by_panel{$panel->id}}) { 
					if ($ballots_by_entry{$pc->id}) { 

						$aff = $pc if $panel->bye && not defined $aff;
						$neg = $pc if $panel->bye && $aff;

						$aff = $pc if ${$ballots_by_entry{$pc->id}}[0]->side == "1";
						$neg = $pc if ${$ballots_by_entry{$pc->id}}[0]->side == "2";
					}
				}
</%perl>

				<td class="leftalign">


%					if ($aff) { 
						<a class="white block" href="entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $aff->id %>">
							<% ($codes eq "full_names") ? $aff->name : $aff->code %>
						</a>
%					} 
				</td>

				<td class="leftalign">
%					if ($neg) { 
						<a class="white block" href="entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $neg->id %>">
							<% ($codes eq "full_names") ? $neg->name : $neg->code %>
						</a>
%					}
				</td>

				<td>

%					my $notfirst;
%                   my %used;

%					foreach my $judge (@{$judges_by_panel{$panel->id}}) {
%						next unless $judge;
%						next if $used{$judge->id};
%       	            $used{$judge->id}++;

						<% $notfirst++ ? "<br />" : "" %> 
						<span class="medspan nowrap leftfloat" style="width: 150px;">
							<a class="white block" href="judge.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn->id %>">
								<% ($judge->chair) ? "*" : "" %><% $judge->last.", ".$judge->first %>
							</a>
						</span>
% 					} 
				</td>

			</tr>
			
%		}
		
		</tbody>

	</table>


