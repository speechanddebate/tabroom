<%args>
	$judge_id
	$tourn
	$account => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	unless ($judge) { 
		my $err = "Judge not found";
		$m->redirect("judge_list.mhtml?tourn_id=".$tourn->id."&err=$err");
	}

	my $group = $judge->judge_group;
	$tourn = $group->tourn;
	my $switch; 

</%init>

	<& sidebar.mas, tourn_id => $tourn->id &>

	<div class="left huge">

        <h2>
			<% $judge->first." ".$judge->last %> Record
        </h2>

        <& ../tourn_header.mas, tourn => $tourn, account => $account &>

%		my @panels = $m->comp('/funclib/judge_panels.mas', judge => $judge, published => 1);
%		my %seen = (); 
%		@panels = grep { ! $seen{$_->id} ++ } @panels;

%		if (@panels) { 

			<h4>Pairings</h4>

			<table cellpadding="4" cellspacing="1">

				<tr class="yellowrow">

					<th>
						Round
					</th>

					<th>
						Room
					</th>

					<th>
						Aff
					</th>

					<th>
						Neg
					</th>

				</tr>

%			}

%			foreach my $panel (@panels) {

%				my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

%				my $aff;
%				my $neg;

%				foreach my $entry (@entries) { 
%					$aff = $entry if Tab::Ballot->search( panel => $panel->id, entry => $entry->id, side => 1);
%					$neg = $entry if Tab::Ballot->search( panel => $panel->id, entry => $entry->id, side => 2);
%				}

%				my $bye++ if $panel->bye;

				<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

					<td class="smallish">
						<% $panel->round->realname %>
					</td>
				
					<td class="smallish">
						<% $bye ? "Bye" : $panel->room ? $panel->room->name : "" %>
					</td>

					<td class="smallish">
						<% $aff ? $aff->code : "" %>
					</td>

					<td class="smallish">
						<% $neg ? $neg->code : ""  %>
					</td>

				</tr>

%			}

		</table>

%		my @results = $m->comp('/funclib/judge_panels.mas', judge => $judge, post_results => 1);
%		my %rseen = (); 
%		@results = grep { ! $rseen{$_->id} ++ } @results;

%		if (@results) { 
			<h4>Decisions</h4>
%		}

		<table cellpadding="4" cellspacing="1">

%			foreach my $panel (@results) { 

%				my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

%				my %done = ();

%				foreach my $entry (@entries) { 

%					next if $done{$entry->id};
%					$done{$entry->id}++;

%					my $aff++ if Tab::Ballot->search( panel => $panel->id, entry => $entry->id, side => 1);
%					my $neg++ if Tab::Ballot->search( panel => $panel->id, entry => $entry->id, side => 2);

%					my $bye++ if $panel->bye;

					<tr class="<% ($switch++ % 2) ? "oddrow" : "evenrow" %>">

						<td>
							<% $panel->round->realname %>
						</td>

						<td>
							<% $aff ? "Aff" : $neg ? "Neg" : "Bye" %>
						</td>

%						my @scores = $m->comp('/funclib/panel_scores.mas', panel => $panel, entry => $entry, judge => $judge);
%       	    		my %scores_by_recipient =();

% 		          		foreach my $score (@scores) {   
%							push @{$scores_by_recipient{$score->student->id}}, $score if $score->student && $score->student->id; 
%       	    		}

						<td class="fixed nowrap">
							<% $entry->code %>
						</td>

						<td>
%							foreach my $score (@scores) { 
								<% $score->tag eq "ballot" ? $score->value ? "W" : "L" : "" %>
%							}
						</td>

%						foreach my $student ($entry->students) { 

%							if ($bye || $panel->round->post_results == 2) {
								<td colspan="<% 2 * scalar $entry->students %>"></td>
%							} else {
	
								<td>
									<% $student->last %>
								</td>

%								foreach my $score (@{$scores_by_recipient{$student->id}}) { 
	
									<td>	
										<% $score->value %>
									</td>	
%								}

%							}

%						}

					</tr>
%				}

				<tr>
					<td>
					</td>
				</tr>

%			}

		</table>

		<h4>Live Updates</h4>

		<div class="liblrow rightalign padmore">
			<form action="/index/tourn/updates/judge_follow.mhtml" method="post">
			<input type="hidden" name="judge_id" value="<% $judge->id %>">
			<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
				<input type="submit" class="thin" value="Subscribe to Live Updates">
			</form>
		</div>


	</div>

