<%args>
	$search_phone => undef
	$search_email => undef
	$account      => undef
	$tourn_id
</%args>
<%init>

	use POSIX;

	my $tourn =  Tab::Tourn->retrieve($tourn_id);
	$m->abort unless $tourn;

	$search_phone =~ s/\D//g;

	Tab::Follower->set_sql( email => "
		select distinct follower.*
		from follower, entry, event
		where follower.email = ? 
		and event.id = entry.event
		and entry.id = follower.entry
		and event.tourn = ? 
	");

	Tab::Follower->set_sql( phone => "
		select distinct follower.*
		from follower, entry, event
		where follower.cell = ? 
		and event.id = entry.event
		and entry.id = follower.entry
		and event.tourn = ? 
	");

	Tab::Follower->set_sql( account => "
		select distinct follower.*
		from follower, entry, event
		where follower.follower = ? 
		and event.id = entry.event
		and entry.id = follower.entry
		and event.tourn = ? 
	");

	my @followers = Tab::Follower->search_email( $search_email, $tourn->id );
	push @followers, Tab::Follower->search_phone( $search_phone, $tourn->id );
	push @followers, Tab::Follower->search_account( $account->id, $tourn->id ) if $account;

	my %seen = (); 
	@followers = grep { ! $seen{$_->id} ++ } @followers;

	my $switch;

</%init>

	<& sidebar.mas, tourn_id => $tourn->id, whoami => "stop"  &>


	<div class="main">
			
		<& /index/tourn/title.mas, tourn => $tourn &>

		<& /index/tourn/tabbar.mas, tourn => $tourn, account => $account &>

		<div class="evenrow">

			<form action="undo.mhtml" method="post">
			<span class="quarter">
				<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
				Phone:
			</span>

			<span class="half">
				<input type="number" name="search_phone" min="0" max="10000000000" class="larger" size="24" value="<% $search_phone %>">
			</span>

			<span class="quarter">
				<input type="submit" value="Search">
			</span>
			</form>

		</div>

		<div class="oddrow">

			<form action="undo.mhtml" method="post">
			<span class="quarter">
				<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
				Email
			</span>

			<span class="half">
				<input type="email" name="search_email" size="20" value="<% $search_email %>">
			</span>

			<span class="quarter">
				<input type="submit" value="Search">
			</span>
			</form>

		</div>

		<div>
			<span class="half">
				<h4>Who you are following:</h4>
			</span>

			<span class="half rightalign">
				<p>Tap to remove</p>
			</span>
		</div>

		<div class="centeralign">
			<span class="third"> 
				Email: <% $search_email %>
			</span>
			<span class="third"> 
				Phone: <% $search_phone %>
			</span>
			<span class="third"> 
				Account: <% $account ? $account->email : "" %>
			</span>
		</div>

%		if (@followers) { 

			<h4>Turn Off Notices</h4>

%			foreach my $follower (@followers) { 

				<span class="half">
					<a class="blue full" href="update_remove.mhtml?tourn_id=<% $tourn_id %>&follower_id=<% $follower->id %>&email=<% $search_email %>&cell=<% $search_phone %>">
%						if ($follower->type eq "entry") { 
							<% $follower->entry->code %>
%#							at <% $follower->tourn->name %>
%						} elsif ($follower->type eq "judge") { 
							<% $follower->judge->code." ".$follower->judge->first." ".$follower->judge->last %> at <% $follower->tourn->name %>
%						} elsif ($follower->type eq "school") { 
							<% $follower->judge->code." ".$follower->judge->first." ".$follower->judge->last %> at <% $follower->tourn->name %>
%						} elsif ($follower->type eq "tourn") { 
							<% $follower->tourn->start->year %> <% $follower->tourn->name %>
%						} 
					</a>
				</span>
%			}
%		}

	</div>


