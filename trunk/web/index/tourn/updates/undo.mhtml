<%args>
	$search_phone => undef
	$search_email => undef
	$account => undef
	$tourn_id
</%args>
<%init>

	use POSIX;

	my $tourn =  Tab::Tourn->retrieve($tourn_id);

	my ($entref, $judgeref, $schref) = $m->comp("/funclib/account_follows.mas", tourn => $tourn, account => $account)  if $account;

	$search_phone =~ s/\D//g;

	Tab::FollowEntry->set_sql( email => "
		select distinct follow_entry.*
		from follow_entry, entry, event
		where follow_entry.email = ? 
		and event.id = entry.event
		and entry.id = follow_entry.entry
		and event.tourn = ? 
	");

	Tab::FollowEntry->set_sql( cell => "
		select distinct follow_entry.*
		from follow_entry, entry, event
		where follow_entry.cell = ? 
		and event.id = entry.event
		and entry.id = follow_entry.entry
		and event.tourn = ? 
	");

	Tab::FollowJudge->set_sql( email => "
		select distinct follow_judge.*
		from follow_judge, judge, judge_group
		where follow_judge.email = ? 
		and judge_group.id = judge.judge_group
		and judge.id = follow_judge.judge
		and judge_group.tourn = ? 
	");

	Tab::FollowJudge->set_sql( cell => "
		select distinct follow_judge.*
		from follow_judge, judge, judge_group
		where follow_judge.cell = ? 
		and judge_group.id = judge.judge_group
		and judge.id = follow_judge.judge
		and judge_group.tourn = ? 
	");

	my @entries = Tab::FollowEntry->search_email(  $search_email, $tourn_id );
	push (@entries, Tab::FollowEntry->search_cell(  $search_phone, $tourn_id ));

	my %seen = (); 
	@entries = grep { ! $seen{$_->id} ++ } @entries;

	my @judges = Tab::FollowJudge->search_email( $search_email, $tourn_id );
	push (@judges, Tab::FollowJudge->search_cell($search_phone, $tourn_id ));

	my %jseen = (); 
	@judges = grep { ! $jseen{$_->id} ++ } @judges;

	my $switch;

</%init>

	<& sidebar.mas, tourn_id => $tourn_id, whoami => "stop"  &>


	<div class="main">

		<span class="threequarter">

			<h2>
				<% $tourn->name %> 
			</h2>

		</span>

		<span class="quarter">
			<h4 style="text-align: right;">
				<% $tourn->location %>  
			</h4>
		</span>

		<br style="clear: both;">

		<& /index/tourn/tourn_header.mas, tourn => $tourn, account => $account &>

		<div class="evenrow">

			<form action="undo.mhtml" method="post">
			<span class="quarter">
				<input type="hidden" name="tourn_id" value="<% $tourn_id %>">
				Phone:
			</span>

			<span class="half">
				<input type="number" name="search_phone" min="0" max="10000000000" size="20" value="<% $search_phone %>">
			</span>

			<span class="quarter">
				<input type="submit" value="Search">
			</span>
			</form>

		</div>

		<div class="oddrow">

			<form action="undo.mhtml" method="post">
			<span class="quarter">
				<input type="hidden" name="tourn_id" value="<% $tourn_id %>">
				Email
			</span>

			<span class="half">
				<input type="email" name="search_email" size="20" value="<% $search_email %>">
			</span>

			<span class="quarter">
				<input type="submit" value="Search">
			</span>
			</form>

		</div>

		<div>
			<span class="half">
				<h4>Who you are following:</h4>
			</span>

			<span class="half rightalign">
				<p>Tap to remove</p>
			</span>
		</div>

%		foreach my $entry (@{$entref}) { 
			<a class="half padmore padmore yellow smallish" href="update_remove.mhtml?entry_id=<% $entry->id %>&tourn_id=<% $tourn_id %>">
				Entry: <% $entry->code.": ".$entry->name %>
			</a>
%		}

%		foreach my $entry (@entries) { 
			<a class="half padmore yellow smallish" href="update_remove.mhtml?follow_id=<% $entry->id %>&tourn_id=<% $tourn_id %>">
				Entry: <% $entry->entry->code.": ".$entry->entry->name %>
			</a>
%		}

%		foreach my $judge (@judges) { 
			<a class="half padmore yellow smallish" href="update_remove.mhtml?jfollow_id=<% $judge->id %>&tourn_id=<% $tourn_id %>">
				Judge: <% $judge->judge->first." ".$judge->judge->last %>
			</a>
%		}


%		foreach my $judge (@{$judgeref}) { 
			<a class="half padmore yellow smallish" href="update_remove.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn_id %>">
				Judge: <% $judge->code.": ".$judge->first." ".$judge->last %>
			</a>
%		}

%		foreach my $school (@{$schref}) { 
			<a class="half padmore yellow smallish" href="update_remove.mhtml?school_id=<% $school->id %>&tourn_id=<% $tourn_id %>">
				School: <% $school->code.": ".$school->name %>
			</a>
%		}

	</div>


