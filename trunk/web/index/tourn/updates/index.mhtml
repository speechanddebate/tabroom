<%args>
	$tourn_id
	$account  => undef
	$event_id => undef
	$group_id => undef
</%args>
<%init>

	use POSIX;

	my $tourn =  Tab::Tourn->retrieve($tourn_id);
	my $event = Tab::Event->retrieve($event_id) if $event_id;  
	my $group = Tab::JudgeGroup->retrieve($group_id) if $group_id;

	my @followers = Tab::Follower->search( follower => $account->id, tourn => $tourn->id) if $account;

	my $switch;

</%init>

	<& sidebar.mas, tourn_id => $tourn_id, event_id => $event_id, group_id => $group_id &>

	<div class="main">

		<div>
			<span class="twothirds nospace">
				<h2>
					<% $tourn->name %> 
				</h2>
			</span>

			<span class="third rightalign nospace">
				<span class="twofifth nospace">
					<h4 class="nospace">
						<% $tourn->start->year %>
					</h4>
				</span>
				<span class="half nospace">
					<h4 class="nospace">
						<% $tourn->location %>  
					</h4>
				</span>
			</span>
		</div>

		<& /index/tourn/tourn_header.mas, tourn => $tourn, account => $account &>

%		my %already;

%		if ($account && @followers) { 

			<div>
				<span class="pagehalf">
					<h4>Who you are following:</h4>
				</span>

				<span class="pagehalf rightalign">
					<p>Tap to remove</p>
				</span>
			</div>


%			foreach my $follower (@followers) { 

				<span class="pagehalf">
					<a class="full marless border liblrow plain hover smallish padleft" href="update_remove.mhtml?tourn_id=<% $tourn_id %>&follower_id=<% $follower->id %>&email=<% $follower->email %>&cell=<% $follower->cell %>&indexme=1&event_id=<% $event_id %>&group_id=<% $group_id %>">
%						if ($follower->type eq "entry") { 
%							$already{$follower->entry}++;
							<span class="third nowrap">
								<% $follower->entry->code %>
							</span>
							<span class="twothird">
								<% $follower->entry->name %>
							</span>

%						} elsif ($follower->type eq "judge" && $follower->judge) { 
%							$already{$follower->judge}++;
							<span class="twothird">
								<% $follower->judge->code." ".$follower->judge->first." ".$follower->judge->last %> 
							</span>
							<span class="third">
								<% $follower->judge && $follower->judge->judge_group ? $follower->judge->judge_group->name : "" %>
							</span>
%						} elsif ($follower->type eq "school") { 
							<span class="quarter">
								All from 
							</span>
							<span class="threequarters">
								<% $follower->school->code." ".$follower->school->name %>
							</span>

%						} elsif ($follower->type eq "tourn") { 
							<span class="twothird">
								<% $follower->tourn->start->year %> <% $follower->tourn->name %>
							</span>
%						} 
					</a>
				</span>
%			}
%		}

%		if ($event) { 

			<div>
				<span class="pagehalf">
					<h4><% $event->name %> entries:</h4>
				</span>

				<span class="pagehalf rightalign">
					<p>Click on an entry to follow their live updates</p>
				</span>
			</div>

%			my @entries = sort {$a->school->name cmp $b->school->name} $event->entries( dropped => 0, waitlist => 0, tba => 0);
%			my $total = scalar @entries;
%			my $count;

			<span class="pagehalf">

%			foreach my $entry (@entries) {

%				next if $already{$entry};

%				if ($count == ceil($total /2)) {
					</span>
					<span class="pagehalf">
%				}

%				$count++;

				<a class="smallish row hover plain full marno" title="<% $entry->code %>" href="entry.mhtml?entry_id=<% $entry->id %>&tourn_id=<% $tourn_id %>">
					<span class="twofifth nowrap">
					</span>
					<span class="half nowrap padmore">
						<% $entry->name %>
					</span>
				</a>

%			}

			</span>
%		}

%		if ($group) { 

			<div>
				<span class="pagehalf">
					<h4><% $group->name %> judges</h4>
				</span>
 
				<span class="pagehalf rightalign">
					<p>Click on a judge to follow their live updates</p>
				</span>
			</div>

%				my @judges = sort {$a->last cmp $b->last} $group->judges( active => 1);
%				@judges = sort {$a->school->short_name cmp $b->school->short_name} @judges;
%				my $total = scalar @judges;
%				my $count;

				<span class="pagehalf">

%				foreach my $judge (@judges) {

%					if ($count == ceil($total /2)) {
						</span>
						<span class="pagehalf">
%					}

%					$count++;

					<a class="smallish hover row plain full marno" href="judge.mhtml?judge_id=<% $judge->id %>&tourn_id=<% $tourn_id %>">
						<span class="twofifth nowrap">
						<% $judge->first." ".$judge->last %>
						</span>
						<span class="half nowrap">
							<% ($judge->school && $judge->school->id) ? $judge->school->short_name : "Hired"  %>
						</span>
					</a>

%				}

				</span>


%		}

	</div>


