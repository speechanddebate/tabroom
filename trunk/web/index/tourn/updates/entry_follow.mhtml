<%args>
	$comp_id
	$phone => 0
	$domain => undef
	$email => 0
	$allschool => undef
	$tourn_id
</%args>
<%init>

	my $msg;
	my $err;

	my $comp = Tab::Entry->retrieve($comp_id);
	my @comps;

	if ($allschool == 1) { 
		@comps = $comp->school->comps( event => $comp->event->id);
	} else { 
		push (@comps, $comp); 
	}

	$phone =~ s/\D//g;

	my $phone_bad = 0;
	my $email_bad = 0;

	my $emailok = Email::Valid->address( -address => $email, -mxcheck => 0 ) ? 'yes' : 'no' if $email;

	if ($email && $emailok eq "no") { 
		$err .= "Email address $email is invalid.  Try again <br />" if $emailok eq "no";
		$email_bad++;
	}

	if ($phone && length($phone) != 10) { 
		$err .= "That phone number had ".length($phone)." digits.  10 digits required <br/>";
		$phone_bad++;
	}

	if ($phone && not defined $domain) { 
		$err .= "Please choose a phone provider <br />";
		$phone_bad++;
	}

	foreach my $comp (@comps) { 

		my $follower;

		if (($email && $phone) && ($email_bad == 0 && $phone_bad == 0))  { 

			my @existing = Tab::FollowEntry->search( comp => $comp->id, email => $email );
			push (@existing, Tab::FollowEntry->search( comp => $comp->id, cell => $phone ));

		    my %seen = ();
		    @existing = grep { ! $seen{$_->id} ++ } @existing;

			foreach (@existing) { $_->delete; }

			$follower = Tab::FollowEntry->create({
				comp => $comp->id,
				cell => $phone,
				email => $email,
				domain => $domain
			});

			$msg .= "$email and $phone are now following ".$comp->team_name." <br /> <br />";

		} elsif ($email && $email_bad == 0 && $phone == 0) { 

			my @existing = Tab::FollowEntry->search( comp => $comp->id, email => $email );

			unless (@existing) { 
				
	            $follower = Tab::FollowEntry->create({
	                comp => $comp->id,
	                email => $email,
	            });
				
				$msg .= "$email is now following ".$comp->team_name." <br /> <br />";

			}
			

		} elsif ($phone && $email == 0 && $phone_bad == 0) { 

			my @existing = Tab::FollowEntry->search( comp => $comp_id, cell => $phone );
            
            unless (@existing) {

                $follower = Tab::FollowEntry->create({
                    comp => $comp->id,
					cell => $phone,
					domain => $domain
                });

            }

			$msg .= "Phone $phone is now following ".$comp->team_name." <br /> <br />";

		} 
		
		if ($follower) { 
			$m->comp("send_confirmation.mas", follower => $follower);
		}

	}

	$m->redirect("entry.mhtml?comp_id=".$comp->id."&tourn_id=$tourn_id&msg=$msg&err=$err");

</%init>
