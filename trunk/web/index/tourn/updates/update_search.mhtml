<%args>
	$tourn_id => undef
	$cell => undef
	$email => undef
</%args>
<%init>

	$cell =~ s/\D//g if $cell;

	unless ($cell || $email) { 
		my $err = "Please enter a cell phone number or an email address, or both, to continue";
		$m->redirect("index.mhtml?tourn_id=$tourn_id&err=$err");
	}

	my $now = DateTime->now;

	my @follow_entries = Tab::FollowComp->search( email => $email) if $email;
	push (@follow_entries, Tab::FollowComp->search( cell => $cell)) if $cell;

	my @follow_judges = Tab::FollowJudge->search( email => $email) if $email;
	push (@follow_judges, Tab::FollowJudge->search( cell => $cell)) if $cell;

	unless (@follow_entries || @follow_judges) { 
		my $err = "There is no record of the cell number ".$cell." in the database. <br />" if $cell;
		$err .= "There is no record of the email address ".$email." in the database. <br />" if $email;
		$err .= "Please try again";
		$m->redirect("index.mhtml?tourn_id=$tourn_id&err=$err");
	}

	my %seen = ();
	@follow_entries = grep { ! $seen{$_->id} ++ } @follow_entries;

	%seen = ();
	@follow_judges = grep { ! $seen{$_->id} ++ } @follow_judges;

	@follow_entries = sort {$b->entry->event->tourn->start->epoch <=> $a->entry->event->tourn->start->epoch} @follow_entries;

</%init>

	<div class="menu">

		<div id="sidenote">

%			if ($email) {
				<a href="stop.mhtml?email=<% $email %>&tourn_id=<% $tourn_id %>&type=email" class="yellow block">
					Stop all emails to <% $email %>
				</a>
%			}

%			if ($cell) {
				<a href="stop.mhtml?cell=<% $cell %>&tourn_id=<% $tourn_id %>&type=cell" class="yellow block">
					Stop all texts to <% $cell %>
				</a>
%			}

%			if ($cell && $email) {
				<a href="stop.mhtml?cell=<% $cell %>&email=<% $email %>&tourn_id=<% $tourn_id %>&type=both" class="yellow block">
					Stop all texts and emails
				</a>
%			}

		<br />

%		if ($tourn_id) { 

%			my $tourn = Tab::Tourn->retrieve($tourn_id);

			<a class="dkgreen block nowrap" href="index.mhtml?tourn_id=<% $tourn_id %>">
				Return to <% $tourn->name %>
			</a>
%		}

	</div>

	<div class="main">

		<h2>You are following:</h2>
		
		<p>Click on each to stop getting updates:</p>

		<div style="width: 275px; float: left">
			
			<h4>Entries:</h4>

%			foreach my $follow (@follow_entries) { 
				<a class="blue block" href="update_remove.mhtml?follow_id=<% $follow->id %>&type=entry&tourn_id=<% $tourn_id %>&email=<% $email %>&cell=<% $cell %>">
					<% $follow->entry->event->abbr %>:
					<span style="width: 100px; display: inline-block;">
					<% substr($follow->entry->team_name, 0, 20) %>
					</span>
					<% substr($follow->entry->event->tourn->name,0,22) %>
				</a>
%			}

		</div>

		<div style="width: 275px; float: right">

			<h4>Judges</h4>

%			foreach my $follow (@follow_judges) { 
				<a class="blue block" href="update_remove.mhtml?follow_id=<% $follow->id %>&type=judge&tourn_id=<% $tourn_id %>&email=<% $email %>&cell=<% $cell %>">
					<% $follow->judge->judge_group->abbr %>:
					<span style="width: 100px; display: inline-block;">
					<% substr($follow->judge->name, 0, 20) %>
					</span>
					<% substr($follow->judge->judge_group->tourn->name,0,22) %>
				</a>
%			}

		</div>

	</div>

</div>

