
<%args>
	$tourn_id
</%args>
<%init>


	my $tourn = Tab::Tourn->retrieve($tourn_id);

    unless ($tourn->method->publish_paradigms == 1) {
        $m->print("<p class=\"err\">The paradigms for this tournament have not been published.  Stop trying to mess around.</p>");
        $m->abort;
	}

	my $circuit = $tourn->circuit;
	my $now = DateTime->now;	
	$now->set_time_zone($circuit->timezone);

	my $filename = $Tab::file_root."/tmp/paradigms-".$tourn_id."-".$now->epoch;

	my $garbage = `rm -f $filename.*`;
	
	open (TEXOUT, ">$filename.tex");

	print TEXOUT <<"EOF";

\\documentclass[10pt]{letter}
\\usepackage{fullpage}
\\usepackage[hmargin=1in,vmargin=1in]{geometry}
\\usepackage{times}
\\usepackage{multirow}
\\renewcommand{\\arraystretch}{1.3}
\\begin{document}

\\addtolength{\\textwidth}{1in}
\\addtolength{\\hoffset}{-.1in}

EOF

my $tourn_name = $tourn->name;
$tourn_name =~ s/&/\\&/g;
$tourn_name =~ s/#/\\#/g;

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\begin{center}\n";
	print TEXOUT "{\\LARGE Judge Paradigm List}";
	print TEXOUT "\\end{center}\n";


	print TEXOUT "\\begin{tabular}{p{.75in}p{2.25in}p{.75in}p{2.25in}} \n  ";
	print TEXOUT "{\\bf Tournament:} & ".$tourn_name."  (".$tourn->id.") & ";
	print TEXOUT "{\\bf Printed:} & ". $now->mdy('/')." ".$now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p') ." \\\\ \n";
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\n\\bigskip\n\n";

    my @groups = $tourn->groups(ask_paradigm => 1);

	foreach my $group (sort {$a->name cmp $b->name} @groups) { 

		print TEXOUT "{\\large ".$group->name." Judges: }\\\\ \n";
		print TEXOUT "\\bigskip\n";

		foreach my $judge (sort {$a->last cmp $b->last} $group->judges) { 

			next unless $judge->paradigm;

			print TEXOUT "\\begin{tabular}{|p{1.5in}|p{4.5in}|}\n";
			print TEXOUT "\\hline \n";

			print TEXOUT $judge->last.", ".$judge->first." \\newline (";

			if ($judge->school->id) { 
				print TEXOUT $judge->school->name;
			} else { 
				print TEXOUT "Hired";
			}


			print TEXOUT ") & ".$judge->paradigm." \n";

			print TEXOUT "\\\\ \\hline \n";
			print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\newline\n";
		}

	}

	print TEXOUT "\\end{document}\n";

	close TEXOUT;


$garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;

`rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;

$m->redirect("$Tab::url_prefix/tmp/paradigms-$tourn_id-".$now->epoch.".pdf");

</%init>
