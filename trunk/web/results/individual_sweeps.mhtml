<%args>
	$tourn
	$session
	$debug => undef
</%args>
<%init>

    $m->comp("sweep_entries.mas", tourn => $tourn);

	my $basename = "/tmp/individual-sweeps-tourn-".$tourn->id."-".$session->id;
    my $filename = $Tab::file_root."".$basename;
    my $garbage = `rm -f $filename.*`;

    open (TEXOUT, ">$filename.tex");


	print TEXOUT <<"EOF";

\\documentclass[10pt]{report}
\\usepackage{fullpage}
\\renewcommand{\\familydefault}{\\sfdefault}
\\renewcommand{\\arraystretch}{1.2}
\\begin{document}

\\begin{center}
\\normalsize

EOF

	print TEXOUT "\\begin{tabular}{|l|l|l|l|l|l|l}\n";
	print TEXOUT "\\multicolumn{6}{c}{\\Large ".$tourn->name ." Individual Points }\\\\ \n";
	print TEXOUT "\\hline \n";
	print TEXOUT "School & First & Last & Pts & Cume & Entries & Breakdown\\\\ \n";
	print TEXOUT "\\hline \n";

	my $count = 2;

	my @students = Tab::Student->search_sweeps_points($tourn);

	my %sweep_strings = ();

	foreach my $student (sort {$b->total_sweeps <=> $a->total_sweeps} @students ) { 

		my @teams = $student->teams($tourn);


		foreach my $team (@teams) { 
			$student->num_entries($student->num_entries + 1);
			$student->total_sweeps($student->total_sweeps + $team->sweeps_points);
			&Tab::log("Adding a team to ".$student->first." ".$student->last." for comp ".$team->code) if $debug;
			&Tab::log("Kid now has ".$student->total_sweeps) if $debug;

			$sweep_strings{$student->id} .= $team->event->abbr." ".$team->sweeps_points." ";
		}

	}

	foreach my $student (sort {$b->total_sweeps <=> $a->total_sweeps} @students ) { 


		$count++;
		
		my $cume;

		my @entries = $student->entries($tourn);
		my $num_entries = scalar @entries;
		
		foreach my $comp ($student->entries($tourn)) { 
			$cume = $cume + $comp->prelim_cume if eval{$comp->prelim_cume};

			$sweep_strings{$student->id} .= " ".$comp->event->abbr." ".$comp->sweeps_points;
		}

       	if ($count == 40)  {
            print TEXOUT "\\multicolumn{6}{l}{\\large}\\\\\n";
            print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\newpage \n";
            print TEXOUT "\\begin{tabular}{|l|l|l|l|l|l|l|}\n";
			print TEXOUT "\\multicolumn{6}{c}{\\Large ".$tourn->name ." Individual Points cont'd }\\\\ \n";
            print TEXOUT "\\hline\n";
    		print TEXOUT "School & First & Last & Pts & Cume & Entries & Breakdown \\\\ \n";
            print TEXOUT "\\hline \n";
            $count = 0;
        }

		print TEXOUT substr($student->chapter->name,0,25)." & ";
		print TEXOUT substr($student->first,0,20);
		print TEXOUT " & ";
		print TEXOUT substr($student->last,0,20);
		print TEXOUT " & ";
		print TEXOUT $student->total_sweeps;
		print TEXOUT " & ";
		print TEXOUT $cume;
		print TEXOUT " & ";
		print TEXOUT scalar $student->num_entries;
		print TEXOUT " & ";
		print TEXOUT $sweep_strings{$student->id};
		print TEXOUT " \\\\ \n \\hline \n";


	}

	print TEXOUT "\\multicolumn{6}{l}{\\large}\\\\\n";
    print TEXOUT "\\end{tabular}\n";
    print TEXOUT "\\end{center}\n";
    print TEXOUT "\\end{document}\n";
    close TEXOUT;

    $garbage = `cd $Tab::file_root/tmp; $Tab::latex_path $filename.tex; $Tab::dvipdfm_path $filename.dvi`;
    $garbage = `rm -f $filename.tex $filename.log $filename.dvi $filename.aux`;
    $m->redirect($Tab::url_prefix."".$basename.".pdf");

</%init>

