<%args>
	$tourn
	$debug => undef
</%args>
<%perl>

	$m->comp("/results/prep_ballots.mas", tourn => $tourn);

	my @schools = $tourn->speech_schools;
	system "$Tab::logger I have ".scalar @schools." schools" if $debug;

	my @comps = $tourn->speech_comps;
	system "$Tab::logger I have ".scalar @comps." kiddies" if $debug;

	my @ballots = $tourn->speech_ballots;
	system "$Tab::logger I have ".scalar @ballots." ballots" if $debug;

	my %sweeps_by_comp;
	my %comps_by_school;
	my %sweeps_by_school;

	foreach my $ballot (@ballots) { 

		next if $ballot->noshow;
		next if $ballot->countmenot;

		my $sweeps = (6 - $ballot->rank) if $ballot->rank > 0;
		$sweeps = 1 if $sweeps < 1 && $ballot->rank > 0;

		$sweeps_by_comp{$ballot->comp->id} += $sweeps;

	}

	foreach my $comp (@comps) {
		push (@{$comps_by_school{$comp->school->id}}, $comp);
	}

	foreach my $school (@schools) { 

		next unless $comps_by_school{$school->id};
		
		my @comps = @{$comps_by_school{$school->id}};

		@comps = sort {$sweeps_by_comp{$b->id} <=> $sweeps_by_comp{$a->id}} @comps;

		foreach (1 .. 3) { 
			my $counted_comp = shift @comps;
			next unless $counted_comp;
			$sweeps_by_school{$school->id} += $sweeps_by_comp{$counted_comp->id};
		}

		$school->sweeps_points($sweeps_by_school{$school->id});

	}

	@schools = sort {$sweeps_by_school{$b->id} <=> $sweeps_by_school{$a->id}} @schools;

	return\%sweeps_by_school, @schools;

</%perl>
