<%args>
	$circuit
	$event
	$filename
	$round => undef
</%args>
<%init>

	my $tourn = $event->tournament;

	my @elims = Tab::Panel->search( event => $event->id, type => "elim");
	my @finals = Tab::Panel->search( event => $event->id, type => "final");

	@elims = sort {$a->round->name cmp $b->round->name} @elims;

	my $first_elim = $elims[0]->round->name if @elims;
	$first_elim = $finals[0]->round->name if @finals;

	my @comps = $m->comp("order_comps.mas", 
							basis => "final", 
							tourn => $event->tournament, 
							breaks_only => 1,
							event => $event) if (@elims || @finals);

	my @non_advancers = $m->comp("order_comps.mas", 
							basis => "prelim", 
							tourn => $event->tournament, 
							event => $event) if (@elims || @finals);

	my $prelims;

	unless (@comps) { 

		$prelims++;
	
		#If there are no elimination round competitors, take the top 6 from prelims.

		my @prelim_comps = $m->comp(  "order_comps.mas", 
							basis => "prelim", 
							tourn => $event->tournament,
							event => $event);

		foreach my $i (0..5) { 
			push (@comps, $prelim_comps[$i]) if $prelim_comps[$i];
		}

	}

	return unless @comps;

	my $rank;

	my @honmen = $event->honorable_mentions if (@elims || @finals) && $tourn->method->honorable_mentions;
	my %honmens = ();
	
	foreach my $hm (@honmen) { 
		$honmens{$hm->id}++;
	}

	my $tablen = 4;
	$tablen++ if $circuit->diocese_based || $circuit->region_based;

	open (TEXOUT, ">>$filename.tex");

	my $tabular; 

	if ($circuit->diocese_based || $circuit->region_based) { 
		$tabular =  "\\begin{tabular}{|p{.5in}|p{2.5in}|p{.5in}|p{1.75in}|p{1.25in}|}\n";
	} else {
		$tabular =  "\\begin{tabular}{|p{.5in}|p{2.0in}|p{1.75in}|p{2.25in}|}\n";
	}

	print TEXOUT $tabular;

	print TEXOUT "\\hline \n";
	print TEXOUT "\\multicolumn{$tablen}{|c|}{\\Large ". $event->name ."}\\\\ \n";
	print TEXOUT "\\hline\n";
	print TEXOUT "\\rowcolor[rgb]{1.0,.95,.94}[5.5pt\]\[5.5pt\]\n";

	if ($circuit->diocese_based || $circuit->region_based) { 
   	    print TEXOUT " Place & Name & Guide & School & ";
		print TEXOUT " Region \\\\ \n" if $circuit->region_based;
		print TEXOUT " Diocese \\\\ \n" if $circuit->diocese_based;
	} else { 
   	    print TEXOUT " Place & Name & Guide & School \\\\ \n";
	}

	my $count;
	my $top_novice;
	my $current_label;

	my %already_comp;

	COMP:
	foreach my $comp (@comps, @non_advancers) { 

		next if $already_comp{$comp->id};
		$already_comp{$comp->id}++;

		my $last_round = Tab::Round->retrieve($comp->last_round) if $comp && $comp->last_round;

		if ($last_round) { 
			unless ($current_label eq $last_round->label) { 
				$current_label = $last_round->label;
				print TEXOUT "\\hline\n";
			}
		} 

		my $tn_is_me;

		my $is_novice;
		foreach my $student ($comp->members) { 
			$is_novice++ if $student->novice;
		}
			
		if ($is_novice 
			&& $event->tournament->method->novices eq "noelim" 
			&! ($last_round && $last_round->type ne "prelim")) { 

			$tn_is_me++ unless $top_novice;
			$top_novice++;
		}

		if ($is_novice && $event->tournament->method->novices eq "top") { 
			$tn_is_me++ unless $top_novice;
			$top_novice++;
		}

		next COMP unless ($comp && $honmens{$comp->id}) || (@finals || @elims) 
				&& ($last_round && $last_round->type ne "prelim") || $tn_is_me || $prelims; 

		$count++;
		$rank++;
	
		if ($count == 25)  { 

			print TEXOUT "\\hline\n";
        	print TEXOUT "\\end{tabular}\n";
			print TEXOUT "\\\\ \n";

			print TEXOUT $tabular;

    		print TEXOUT "\\hline \n";
    		print TEXOUT "\\multicolumn{$tablen}{|c|}{\\Large ". $event->name ." continued}\\\\ \n";
    		print TEXOUT "\\hline\n";
	
			print TEXOUT "\\rowcolor[rgb]{1.0,.95,.94}\[5.5pt\]\[5.5pt\]\n";

			if ($circuit->diocese_based || $circuit->region_based) { 
    		    print TEXOUT " Place & Name & Guide & School & Region \\\\ \n";
			} else { 
    		    print TEXOUT " Place & Name & Guide  & School \\\\ \n";
			}

    	    print TEXOUT "\\hline \n";
    	    $count = 0;
		}

    	print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($count % 2);

		print TEXOUT "\\footnotesize TopNov " if $tn_is_me;

		print TEXOUT ($last_round && $last_round->type eq "final") ? "\\bf ".$rank : "";
		print TEXOUT ($prelims) ? $rank : "";
    	print TEXOUT ($last_round && $last_round->type eq "elim") ? &Tab::texify(substr($last_round->label,0,5)) : "";
    	print TEXOUT ($last_round && $last_round->type eq "prelim" &! (@finals)) ? $rank : "";
		print TEXOUT ($honmens{$comp->id}) ? "\\footnotesize HonMen " : "" if (not defined $last_round || $last_round && $last_round->type eq "prelim");

		print TEXOUT " & \\small ".&Tab::texify($comp->team_name);
		print TEXOUT " & ";

		foreach my $student ($comp->members) { 
			print TEXOUT $student->phonetic." ";
		}
	
		print TEXOUT " & \\small ".&Tab::texify($comp->school->name);

		print TEXOUT " & \\small ".&Tab::texify($comp->school->region->name) 
			if ($circuit->diocese_based || $circuit->region_based) && $comp->school->region;	

		print TEXOUT "\\\\ \n";

	}

	print TEXOUT "\\hline\n";
    print TEXOUT "\\end{tabular}\n";
    print TEXOUT "\\\\ \n";

	close TEXOUT;
	
	return;

</%init>

