<%args>
	$event
	$filepath
	$filename
</%args>
<%init>

	my $tourn = $event->tournament;
	my $circuit = $tourn->circuit;

	my $points++ if ($tourn->method->tiebreaks(tiebreaker => "points"));
	my $now = DateTime->now;

    open (TEXOUT, ">>$filepath"."$filename.tex");

	my @comps = $m->comp("/results/order_comps.mas", 
			tourn => $tourn, 
			event => $event, 
			basis => "prelim");

	@comps = sort {$a->code <=> $b->code} @comps;

	my @ballots = $event->prelim_ballots;

	my %ballots_by_comp;

	foreach my $ballot (@ballots) { 
		push (@{$ballots_by_comp{$ballot->comp->id}}, $ballot);
	}

	my $tabular = "\\begin{tabular}{p{.55in}p{2.25in}p{1.85in}p{1.15in}p{.25in}}\n";

   	print TEXOUT "{\\large Prelim Round Scores (Code Order) }";
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\footnotesize\n";

	print TEXOUT $tabular;
	print TEXOUT "\\rowcolor[rgb]{1.0,.94,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT "Code & Name & School & Prelim Scores & Cume \\\\ \n";
   	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	my $rank = 1;
	my $switch;
	my %advanced;

	foreach my $comp (@comps) { 

		next if $comp->dropped;
		
		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		print TEXOUT " \\footnotesize "; 
		print TEXOUT $comp->school->region->code if $circuit->diocese_based;
		print TEXOUT " ".$comp->code;

   		print TEXOUT " & \\footnotesize ".Tab::texify($comp->full_team_name);
   		print TEXOUT " & \\footnotesize ".Tab::texify(substr($comp->school->truncate_name,0,35));

		print TEXOUT " & \\footnotesize "; 

		foreach my $ballot (@{$ballots_by_comp{$comp->id}}) { 
			
			print TEXOUT $ballot->rank; 
			print TEXOUT "/".sprintf("%02d",$ballot->points) if $points;
			print TEXOUT " "; 
			
		} 

		print TEXOUT " & \\footnotesize ".$comp->prelim_cume; 

		print TEXOUT "\\\\ \n";
		print TEXOUT "\\end{tabular}\n ";
		print TEXOUT "\\newline\n";

	}

    close TEXOUT;

	return;

</%init>
