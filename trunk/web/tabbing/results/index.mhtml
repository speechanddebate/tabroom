<%args>
	$tourn
	$event_id => undef
	$round_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	my @rounds = $m->comp("/funclib/event_rounds.mas", event => $event, done => "yes")  if $event;

	if ($event &! $round) { 
		$round = pop @rounds if @rounds;
	}

</%init>

	<div class="right small">

%		if ($event && @rounds) { 

			<div class="sidenote">
				<h4>As of round</h4>

				<span class="block padless bluenohover">
					<form action="index.mhtml" method="post">
					<input type="hidden" name="event_id" value="<% $event->id %>">
					<select name="round_id" onchange='this.form.submit()' class="fixedsmall">
%						foreach my $oround (sort {$a->name cmp $b->name} @rounds) {
							<option value="<% $oround->id %>" <% $round && $oround->id == $round_id ? "selected" : "" %>>
								<% $oround->realname %>
							</option>
%						}
					</select>

				</span>
			</div>
%		}

		<div class="sidenote">
			<h4>Events:</h4>
%			my $last_type;
%			my @events = sort {$a->name cmp $b->name} $tourn->events;
%			foreach my $oevent (sort {$a->type cmp $b->type} @events) { 
%				$last_type = $oevent->type unless $last_type;
%				my $class = "padtop" if $oevent->type ne $last_type;
%				$last_type = $oevent->type;

				<a class="<% $event && $oevent->id == $event->id? "dk" : ""%>blue nowrap <% $class %> block" href="index.mhtml?event_id=<% $oevent->id %>">
					<% $oevent->name %>
				</a>
%			}
		</div>

	</div>

	<div class="left huge">

		<& /funclib/tablesorter.mas, table => "sortme" &>

%		if ($round) { 

%			my ($entries_ref, $tbs_ref, $desc_ref, $noshow_ref) = $m->comp("speech/order_entries.mas", round => $round);

			<h2>Results as of <% $round->realname %> of <% $event->abbr %></h2>

			<table cellpadding="4" cellspacing="1" id="sortme">

				<thead>
					<tr class="yellowrow">

						<th class="smallish">
							#
						</th>

						<th class="smallish">
							Code
						</th>

						<th class="smallish">
							Name
						</th>

						<th class="smallish">
							School
						</th>

%						foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) { 
							<th class="smallish">
								<% ${$desc_ref}{$key} %>
							</th>
%						}

						<th>
						</th>

					</tr>

				</thead>

				<tbody>

%					my $count = 1;

%					foreach my $key (sort {$a <=> $b} keys %{$entries_ref}) { 

%						my $tie++ if scalar @{${$entries_ref}{$key}} > 1;

%						foreach my $entry (@{${$entries_ref}{$key}}) { 

							<tr <% $tie ? 'class="lirdrow"' : "" %>>

								<td class="centeralign smallish nowrap" style="width: 25px;">
									<% $key %><% $tie ? "-T" : "" %>
								</td>

								<td class="centeralign smallish nowrap" style="width: 50px;">
									<% $entry->code %>
								</td>

								<td class="smallish nowrap" style="width: 100px;">
									<% $entry->name %>
								</td>

								<td class="smallish nowrap" style="width: 100px;">
									<% $entry->school->short_name %>
								</td>

%								foreach my $key (sort {$a <=> $b} keys %{$desc_ref}) { 
									<td class="smallish nowrap">
										<% ${$tbs_ref}{$entry->id."-".$key} %>
									</td>
%								}

								<td class="centeralign smallish nowrap" style="width: 25px;">
									<% ${$noshow_ref}{$entry->id} ? "NS" : $count++ %>
								</td>

							</tr>

%						}

%					}

				</tbody>

			</table>

%		}
	
	</div>


