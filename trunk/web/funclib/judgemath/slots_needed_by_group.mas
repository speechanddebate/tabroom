<%args>	
	$group
	$school => undef
	$region => undef
	$debug => undef
</%args>
<%init>

	use POSIX;

	my $slots;
	my @entries;

	if ($region) { 

		Tab::Entry->set_sql(entry_groups => "select distinct entry.id 
							from entry,class,event,judge_group,chapter
							where entry.event = event.id 
							and event.class = class.id
							and event.no_judge_burden = 0
							and class.judge_group = judge_group.id 
							and entry.school = chapter.school  
							and entry.waitlist != 1
							and chapter.region =". $region->id." 
							and judge_group.id = ".$group->id);

		@entries = Tab::Entry->search_entry_groups;
		$slots -= $group->dio_min * $group->judge_per if $group->dio_min;

	} else { 

		Tab::Entry->set_sql(by_group_school=> "select distinct entry.* 
                                from entry,event
                                where entry.event = event.id
                                and entry.school = ?
                                and entry.waitlist != 1
                                and entry.dropped != 1
                                and event.judge_group = ?
								and not exists (
									select id from event_setting
									where tag = \"no_judge_burden\"
									and value = 1 )
								order by entry.code
							");

		@entries = Tab::Entry->search_by_group_school( $school->id, $group->id);
		$slots = scalar @entries;
	}

	system "$Tab::logger Slots owed is $slots at first step" if $debug;

	if ($group->setting("min_burden") && @entries) { 
		$slots = $group->min_burden * $group->judge_per if ($group->min_burden * $group->judge_per) > $slots;
	}

	if ($group->setting("max_burden") && @entries) { 
		$slots = $group->max_burden * $group->judge_per if ($group->max_burden * $group->judge_per) < $slots;
	}

	$slots -= $group->setting("free") * $group->judge_per;

	$slots = 0 if $slots < 0;

	system "$Tab::logger Slots owed is $slots at second step for group ".$group->abbr if $debug;

	return $slots;


</%init>
