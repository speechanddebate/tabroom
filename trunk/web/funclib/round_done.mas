<%args>
	$round
</%args>
<%init>

	#this is driving me UP THE GODDAMNED WALL.

	my @ranks = Tab::BallotValue->search( tag => "", tiebreak => 1);
	my @ballots = Tab::BallotValue->search( tag => "", tiebreak => 2);
	my @points = Tab::BallotValue->search( tag => "", tiebreak => 3);

	foreach my $rank (@ranks) { 
		$rank->tag("rank");
		eval{ $rank->update; };
	}

	foreach my $ballot (@ballots) { 
		$ballot->tag("ballot");
		eval{ $ballot->update; };
	}

	foreach my $point (@points) { 
		$point->tag("point");
		eval{ $point->update; };
	}

	my @left = $m->comp("/funclib/round_judges.mas", round => $round, not_in => "1");

	my $judges_left = scalar @left;
	return if $judges_left > 0;

	my $event = $round->event;

	my $notified = $event->setting("round_notified");

	if ($notified < $round->name) { 

		my $follower_ids = $event->setting("followers");
		my $subject = $event->name;
		my $body = "\n\n".$round->realname." of ".$event->name." last ballot entered.\n";

		foreach my $id (split(/,/, $follower_ids)) {

			next unless $id;

			my $account = Tab::Account->retrieve($id);

			my $to;

			if ($account->phone && $account->provider) { 
				$to = $account->phone.'@'.$account->provider;
			} else { 
				$to = $account->email;
			}

			$m->comp( "/funclib/send_notify.mas", 
				from    => 'Tab Central <live@tabroom.com>',
				to      => $to,
				subject => $subject,
				body    => $body
			);

		}

		$event->setting("round_notified") = $round->name;

	}

	return;

</%init>
