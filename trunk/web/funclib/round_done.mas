<%args>
	$round
</%args>
<%init>

	#this is driving me UP THE GODDAMNED WALL.

	Tab::BallotValue->set_sql( fix_the_fucking_blank_ranks => 'update ballot_value set tag="rank" where tag="" and tiebreak=1');
	Tab::BallotValue->set_sql( fix_the_fucking_blank_ballots => 'update ballot_value set tag="ballot" where tag="" and tiebreak=2');
	Tab::BallotValue->set_sql( fix_the_fucking_blank_points => 'update ballot_value set tag="points" where tag="" and tiebreak=3');

	eval { 
		Tab::BallotValue->sql_fix_the_fucking_blank_ranks->execute;
		Tab::BallotValue->sql_fix_the_fucking_blank_ballots->execute;
		Tab::BallotValue->sql_fix_the_fucking_blank_points->execute;
	};

	my @left = $m->comp("/funclib/round_judges.mas", round => $round, not_in => "1");
	my $judges_left = scalar @left;

	return if $judges_left > 0;

	my $event = $round->event;

	my $follower_ids = $event->setting("followers");

	my $subject = $event->name;
	my $body = "\n\n".$round->realname." of ".$event->name." last ballot entered.\n";

	foreach my $id (split(/,/, $follower_ids)) {

		next unless $id;

		my $account = Tab::Account->retrieve($id);

		my $to;

		if ($account->phone && $account->provider) { 
			$to = $account->phone.'@'.$account->provider;
		} else { 
			$to = $account->email;
		}

		$m->comp( "/funclib/send_notify.mas", 
			from    => 'Tab Central <live@tabroom.com>',
			to      => $to,
			subject => $subject,
			body    => $body
		);

	}

	return;

</%init>
