<%args>
	$round
	$no_byes => undef
	$by_code => undef
</%args>
<%init>

	my $order = "order by ballot.audit, ballot.speakerorder, ballot.side, entry.code";
	$order = "order by entry.code, entry.name" if $by_code;

	Tab::debuglog("Order is $order   ");

	if ($no_byes) { 

		Tab::Entry->set_sql(by_round => "
			select distinct entry.*, panel.id as panelid, ballot.speakerorder as speaks, sum(ballot.audit) as ballot, ballot.seed as bracketseed, ballot.pullup as pullup, ballot.side as side
				from panel,ballot,entry
				where panel.round = ? 
				and panel.id = ballot.panel
				and panel.bye != 1
				and ballot.entry = entry.id
				group by entry.id
				". $order ."
		");

		my @entries = Tab::Entry->search_by_round($round);

		my %seen = (); 
		@entries = grep { ! $seen{$_->id} ++ } @entries;
		return @entries;

	} else { 

		Tab::Entry->set_sql(by_round => "
			select distinct entry.*, panel.id as panelid, ballot.speakerorder as speaks, sum(ballot.audit) as ballot, ballot.seed as bracketseed, ballot.pullup as pullup, ballot.side as side
				from panel,ballot,entry
				where panel.round = ? 
				and panel.id = ballot.panel
				and ballot.entry = entry.id
				group by entry.id
				". $order ."
		");

		my @entries = Tab::Entry->search_by_round($round);

		my %seen = (); 
		@entries = grep { ! $seen{$_->id} ++ } @entries;
		return @entries;
	}


</%init>
