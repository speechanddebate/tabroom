<%args>
	$circuit
	$school_id
	$filename
</%args>
<%init>

	use POSIX;

	my $school = Tab::School->retrieve($school_id);
	my $tourn  = $school->tournament;

    my $now = DateTime->now;
    $now->set_time_zone($circuit->timezone);

	my ($total, $feline_ref) = $m->comp("/funclib/school_fees.mas", school_id => $school_id);

	my @felines = @{$feline_ref};

	my $owed = $total - $school->paid_amount;

	my $name;


	if ($owed > 0) { $name = "Invoice"; } else { $name = "Receipt"; }

	open (TEXOUT, ">>$filename.tex");

	print TEXOUT "{\\Large\\bf Tournament ". $name." }\\\\ \n";

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT " \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\small\n";

	print TEXOUT <<'EOF';
		\begin{tabular}{p{1.25in}p{1.85in}p{1.25in}p{1.85in}}
EOF

	print TEXOUT "{\\bf School:} & ". &Tab::texify($school->name) ." & ";
	print TEXOUT "{\\bf Entry Number:} & ".sprintf('%05d', $school->id) ."\\\\ \n";

	print TEXOUT "{\\bf Tournament:} & ". &Tab::texify($tourn->name) ." & ";
	print TEXOUT "{\\bf Circuit:} & ". &Tab::texify($circuit->name) ." \\\\ \n";

	print TEXOUT "{\\bf Tournament Contact:} & ". &Tab::texify($tourn->director->first." ".$tourn->director->last) ." & ";
	print TEXOUT "{\\bf $name Printed:} & ";
	print TEXOUT $now->month."/".$now->day."/".$now->year." ";
	print TEXOUT $now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p')." \\\\ \n";

	print TEXOUT "\\end{tabular} \n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT " \\\\ \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";


	print TEXOUT <<'EOF';
\tt
\begin{tabular}{p{4.75in}p{1.75in}}
\rowcolor[rgb]{1,.95,.95} Category or Item & Fee \\
\end{tabular}
\newline
EOF

my $warn;
my $count = 1;

foreach my $line (sort { $a->{"warn"} <=> $b->{"warn"} } @felines) {

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";

	if ($line->{"warn"}) { 

		print TEXOUT "\\\\ \n" unless $warn;
		$warn++;
		print TEXOUT "\\rowcolor[rgb]{1,.75,.75}\[5.5pt\]\[5.5pt\]\n" if $line->{"warn"};

	} else { 
	    print TEXOUT "\\rowcolor[rgb]{.84,.89,.94}\[5.5pt\]\[5.5pt\]\n" if ($count++ % 2);
	}

	print TEXOUT &Tab::texify($line->{'name'})." & ";
	print TEXOUT "\\\$".sprintf ("%.2f", $line->{'fee'}) if $line->{'fee'};
	print TEXOUT "\\\\ \n \\end{tabular}\n";
	print TEXOUT "\\newline\n";
}

if ($warn) { 

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT "{\\bf       Please clear up the warnings and problems above to get an accurate invoice total.\n }";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

} else { 

	print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
    print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT '{\\bf TOTAL: } & \\$'. sprintf ("%.2f", $total)." \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
	print TEXOUT '{\\bf PAID: } & \\$'. sprintf ("%.2f", $school->paid_amount)." \n";
	print TEXOUT "\\end{tabular}\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\begin{tabular}{p{4.75in}p{1.75in}}\n";
    print TEXOUT "\\rowcolor[rgb]{1,.95,.94}\[5.5pt\]\[5.5pt\]\n";
	print TEXOUT '{\\bf AMOUNT DUE: } & \\$'. sprintf ("%.2f", $owed)." \n " if $owed > 0;
	print TEXOUT '{\\bf PAID IN FULL, THANK YOU! } & \\$0.00 '."\n" unless $owed > 0;
	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\newline\n";

}

	print TEXOUT "\\sf\n";

	my $message = $tourn->invoice_message;

	if ($message) { 

		print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
		print TEXOUT " \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\begin{tabular}{p{6.9in}}\n";
		chomp $message;
		print TEXOUT &Tab::texify($message) if $message;
		print TEXOUT " \\\\ \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";

	}

close TEXOUT;

</%init>
